{
  "name": "xbytechat-api",
  "part": 33,
  "of": 33,
  "generatedAt": "2026-02-11 19:15:17 +00:00",
  "files": [
    {
      "path": "xbytechat-api/PayloadBuilders/IWhatsAppPayloadBuilder.cs",
      "sha256": "2a2ff0592129a93fea8aa20df5fe1e8454dbfbe1640d5a1e15963af93dcd7922",
      "language": "csharp",
      "size": 190,
      "content": "namespace xbytechat.api.PayloadBuilders\n{\n    using xbytechat.api.DTOs.Messages;\n\n    public interface IWhatsAppPayloadBuilder\n    {\n        object BuildPayload(BaseMessageDto dto);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/PayloadBuilders/TemplateMessagePayloadBuilder.cs",
      "sha256": "70f39daad2789c61f03ade184abdf96a43221189b751178dfa1955c123b5f884",
      "language": "csharp",
      "size": 2013,
      "content": "using xbytechat.api.DTOs.Messages;\n\nnamespace xbytechat.api.PayloadBuilders\n{\n    public class TemplateMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(BaseMessageDto dto)\n        {\n            var templateDto = dto as TemplateMessageDto;\n            if (templateDto == null)\n                throw new InvalidCastException(\"DTO is not of type TemplateMessageDto.\");\n\n            var components = new List<object>();\n\n            // üß† Body parameters\n            if (templateDto.TemplateParameters != null && templateDto.TemplateParameters.Any())\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateDto.TemplateParameters.Select(p => new\n                    {\n                        type = \"text\",\n                        text = p\n                    }).ToList()\n                });\n            }\n\n            // ‚úÖ Add button placeholders (Meta requires them for static buttons too)\n            components.Add(new\n            {\n                type = \"button\",\n                sub_type = \"url\",\n                index = \"0\",\n                parameters = new object[] { }  // üëà no parameters if static URL\n            });\n\n            components.Add(new\n            {\n                type = \"button\",\n                sub_type = \"phone_number\",\n                index = \"1\",\n                parameters = new object[] { }  // üëà no parameters if static phone\n            });\n\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = templateDto.RecipientNumber,\n                type = \"template\",\n                template = new\n                {\n                    name = templateDto.TemplateName,\n                    language = new\n                    {\n                        code = templateDto.LanguageCode ?? \"en_US\"\n                    },\n                    components\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/PayloadBuilders/TextMessagePayloadBuilder.cs",
      "sha256": "ce8e2e75c7865d9b08bebb267ceb84f7cdd0e77bd971c609576979b02726a590",
      "language": "csharp",
      "size": 750,
      "content": "// File: PayloadBuilders/TextMessagePayloadBuilder.cs\nusing xbytechat.api.DTOs.Messages;\n\nnamespace xbytechat.api.PayloadBuilders\n{\n    public class TextMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(BaseMessageDto dto)\n        {\n            var textDto = dto as TextMessageDto;\n\n            if (textDto == null)\n                throw new InvalidCastException(\"DTO is not of type TextMessageDto.\");\n\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = textDto.RecipientNumber,\n                type = \"text\",\n                text = new\n                {\n                    body = textDto.MessageContent\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Program.cs",
      "sha256": "e01c8336a2d282406f4aac6a31a9cd548deea990f955f93cc8538cbc93336a92",
      "language": "csharp",
      "size": 37875,
      "content": "using FluentValidation;\nusing Microsoft.AspNetCore.Authentication.JwtBearer;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.IdentityModel.Tokens;\nusing Serilog;\nusing Serilog.Exceptions;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.Json.Serialization;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Services;\nusing xbytechat.api.Features.AccessControl.Services;\nusing xbytechat.api.Features.AuditTrail.Services;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Features.CampaignTracking.Services;\nusing xbytechat.api.Features.Catalog.Services;\nusing xbytechat.api.Features.MessageManagement.Services;\nusing xbytechat.api.Features.MessagesEngine.PayloadBuilders;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Features.PlanManagement.Services;\nusing xbytechat.api.Features.TemplateModule.Services;\nusing xbytechat.api.Features.Webhooks.Services;\nusing xbytechat.api.Features.Webhooks.Services.Processors;\nusing xbytechat.api.Features.Webhooks.Services.Resolvers;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Middlewares;\nusing xbytechat.api.PayloadBuilders;\nusing xbytechat.api.Repositories.Implementations;\nusing xbytechat.api.Repositories.Interfaces;\nusing xbytechat.api.Services;\nusing xbytechat.api.Services.Messages.Implementations;\nusing xbytechat.api.Services.Messages.Interfaces;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Validators;\nusing EnginePayloadBuilders = xbytechat.api.Features.MessagesEngine.PayloadBuilders;\nusing xbytechat.api.Features.CTAManagement.Services;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Features.Webhooks.BackgroundWorkers;\nusing xbytechat.api.Features.CTAFlowBuilder.Services;\nusing xbytechat.api.Features.FlowAnalytics.Services;\nusing xbytechat.api.Features.Inbox.Repositories;\nusing xbytechat.api.Features.Inbox.Services;\nusing xbytechat.api.Features.Inbox.Hubs;\nusing Microsoft.AspNetCore.SignalR;\nusing xbytechat.api.SignalR;\nusing xbytechat.api.Features.AutoReplyBuilder.Repositories;\nusing xbytechat.api.Features.AutoReplyBuilder.Services;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Repositories;\nusing xbytechat.api.Features.BusinessModule.Services;\nusing xbytechat.api.Features.ReportingModule.Services;\nusing xbytechat.api.Features.Automation.Repositories;\nusing xbytechat.api.Features.Automation.Services;\nusing Npgsql;\nusing System.Net;\nusing xbytechat.api.WhatsAppSettings.Providers;\nusing xbytechat.api.Features.CampaignTracking.Config;\nusing xbytechat.api.Features.CampaignTracking.Worker;\nusing xbytechat.api.Infrastructure.Flows;\nusing xbytechat.api.Features.Webhooks.Pinnacle.Services.Adapters;\nusing xbytechat.api.Features.Webhooks.Directory;\nusing xbytechat.api.Features.Webhooks.Status;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.Features.Billing.Services;\nusing xbytechat.api.Features.Audiences.Services;\nusing xbytechat.api.Features.CampaignModule.Helpers;\nusing Microsoft.AspNetCore.HttpOverrides;\nusing xbytechat.api.Features.CustomeApi.Services;\nusing Microsoft.AspNetCore.Authentication;\nusing xbytechat.api.Features.CustomeApi.Auth;\nusing Microsoft.OpenApi.Models;\nusing xbytechat.api.Infrastructure.Schema;\nusing xbytechat.api.Features.CampaignModule.Workers;\nusing xbytechat.api.Infrastructure.Observability;\nusing xbytechat.api.Features.CampaignTracking.Logging;\nusing xbytechat.api.Infrastructure.RateLimiting;\nusing xbytechat.api.Features.CampaignModule.SendEngine;\nusing xbytechat.api.Features.MessageLogging.Services;\nusing DocumentFormat.OpenXml.Office2016.Drawing.ChartDrawing;\nusing xbytechat.api.Features.CampaignModule.CountryCodes;\nusing xbytechat.api.Features.CampaignModule.Import;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.Config;\nusing xbytechat.api.Features.ESU.Shared;\nusing xbytechat.api.Features.ESU.Facebook.Services;\nusing xbytechat.api.Features.ESU.Facebook.Options;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.ESU.Facebook.Abstractions;\nusing xbytechat.api.Features.ESU.Facebook.Clients;\nusing xbytechat.api.Features.ESU.Shared.Infrastructure;\nusing Microsoft.AspNetCore.RateLimiting;\nusing xbytechat.api.Features.Billing.Security;\nusing Microsoft.AspNetCore.Identity;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccountInsights.Services;\nusing xbytechat.api.Features.Payment.Services;\nusing xbytechat.api.Features.Payment.Options;\nusing xbytechat.api.Features.Entitlements.Services;\nusing xbytechat.api.Features.Auditing.FlowExecutions.Services;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Services;\nusing xbytechat.api.Features.CRM.Timelines.Services;\nusing xbytechat.api.Features.ChatInbox.Services;\nusing xbytechat.api.Features.TeamStaff.Services;\nusing xbytechat.api.Features.AccessControl.BusinessRoles.Services;\nusing xbytechat.api.Features.AccessControl.BusinessRolePermissions.Services;\nusing xbytechat.api.Infrastructure.Security;\nusing xbytechat.api.Features.CustomFields.Services;\nusing xbytechat.api.Infrastructure.Swagger;\n\n\nvar builder = WebApplication.CreateBuilder(args);\n\n#region Local overrides configuration\n// Load optional local secrets overrides (never committed) before env variables\nbuilder.Configuration\n    .AddJsonFile(\"appsettings.Local.json\", optional: true, reloadOnChange: true)\n    .AddEnvironmentVariables();\n#endregion\n\n#region üî∑ Serilog Configuration\nLog.Logger = new LoggerConfiguration()\n    .Enrich.WithExceptionDetails()\n    .Enrich.FromLogContext()\n    .MinimumLevel.Information()\n    .WriteTo.Console()\n    .WriteTo.File(\"logs/log-.txt\", rollingInterval: RollingInterval.Day)\n    .CreateLogger();\nbuilder.Host.UseSerilog();\n#endregion\n\n#region üî∑ Database Setup (PostgreSQL)\n//var connStr = builder.Configuration.GetConnectionString(\"DefaultConnection\");\n//builder.Services.AddDbContext<AppDbContext>(options =>\n//    options.UseNpgsql(connStr).EnableSensitiveDataLogging()\n//);\n\n// üî∑ Database Setup (PostgreSQL + UpdatedAtUtc interceptor)\nbuilder.Services.AddSingleton<UpdatedAtUtcInterceptor>();\n\nbuilder.Services.AddDbContext<AppDbContext>((sp, options) =>\n{\n    var env = sp.GetRequiredService<IHostEnvironment>();\n    var connection = builder.Configuration.GetConnectionString(\"DefaultConnection\");\n    if (string.IsNullOrWhiteSpace(connection) || connection.Contains(\"<set-via-env\", StringComparison.OrdinalIgnoreCase))\n    {\n        throw new InvalidOperationException(\"ConnectionStrings:DefaultConnection is not configured. Set it via environment variable (ConnectionStrings__DefaultConnection) or appsettings.Local.json.\");\n    }\n\n    options.UseNpgsql(connection);\n\n    // register UpdatedAt interceptor\n    options.AddInterceptors(sp.GetRequiredService<UpdatedAtUtcInterceptor>());\n\n    if (!env.IsDevelopment())\n    {\n        options.EnableSensitiveDataLogging(false);\n        options.EnableDetailedErrors(false);\n    }\n});\n\n\n//Console.WriteLine($\"[DEBUG] Using Connection String: {connStr}\");\n#endregion\n\n#region üî∑ Generic Repository Pattern\nbuilder.Services.AddScoped(typeof(IGenericRepository<>), typeof(GenericRepository<>));\n#endregion\n\n#region üî∑ Core Modules (Business/Auth)\nbuilder.Services.AddScoped<IBusinessService, BusinessService>();\nbuilder.Services.AddScoped<IAuthService, AuthService>();\nbuilder.Services.AddScoped<IJwtTokenService, JwtTokenService>();\n#endregion\n\n\n// Policy not implemented yet\n#region üî∑ Policies\nbuilder.Services.AddAuthorization(options =>\n{\n    options.AddPolicy(Policies.AdminOrOwner, policy =>\n    {\n        policy.RequireAuthenticatedUser();\n        policy.RequireAssertion(ctx =>\n        {\n            var user = ctx.User;\n            return user.IsAdminLike() || user.IsBusinessOwnerLike();\n        });\n    });\n});\n#endregion\n#region üî∑ Messaging Services & WhatsApp\n\nbuilder.Services.AddHttpClient<IMessageService, MessageService>();\nbuilder.Services.AddScoped<WhatsAppService>();\nbuilder.Services.AddScoped<IMessageStatusService, MessageStatusService>();\nbuilder.Services.AddScoped<ITemplateMessageSender, TemplateMessageSender>();\n#endregion\nbuilder.Services.AddHttpClient();\n\n\n#region üî∑ Payload Builders\nbuilder.Services.AddScoped<xbytechat.api.PayloadBuilders.IWhatsAppPayloadBuilder, xbytechat.api.PayloadBuilders.TextMessagePayloadBuilder>();\nbuilder.Services.AddScoped<xbytechat.api.PayloadBuilders.IWhatsAppPayloadBuilder, xbytechat.api.PayloadBuilders.ImageMessagePayloadBuilder>();\nbuilder.Services.AddScoped<xbytechat.api.PayloadBuilders.IWhatsAppPayloadBuilder, xbytechat.api.PayloadBuilders.TemplateMessagePayloadBuilder>();\n#endregion\n\n#region üî∑ Catalog & CRM Modules\nbuilder.Services.AddScoped<IContactSummaryService, ContactSummaryService>();\nbuilder.Services.AddScoped<IProductService, ProductService>();\nbuilder.Services.AddScoped<ICatalogTrackingService, CatalogTrackingService>();\nbuilder.Services.AddScoped<ICatalogDashboardService, CatalogDashboardService>();\nbuilder.Services.AddScoped<IContactService, ContactService>();\nbuilder.Services.AddScoped<ITagService, TagService>();\nbuilder.Services.AddScoped<IReminderService, ReminderService>();\nbuilder.Services.AddScoped<INoteService, NoteService>();\nbuilder.Services.AddScoped<ITimelineService, TimelineService>();\nbuilder.Services.AddScoped<IContactTagService, ContactTagService>();\nbuilder.Services.AddScoped<ICustomFieldsService, CustomFieldsService>();\n#endregion\n\n#region üî∑ Billing \nbuilder.Services.AddScoped<IBillingIngestService, BillingIngestService>();\nbuilder.Services.AddScoped<IBillingReadService, BillingReadService>();\nbuilder.Services.AddSingleton<IMetaSignatureValidator, MetaSignatureValidator>();\n#endregion\n\n#region üî∑ Campaign Management\nbuilder.Services.AddScoped<ICampaignService, CampaignService>();\nbuilder.Services.AddScoped<ICampaignSendLogService, CampaignSendLogService>();\nbuilder.Services.AddScoped<ICampaignSendLogEnricher, CampaignSendLogEnricher>();\nbuilder.Services.AddScoped<ICampaignAnalyticsService, CampaignAnalyticsService>();\nbuilder.Services.AddScoped<ICampaignRetryService, CampaignRetryService>();\nbuilder.Services.AddScoped<ICampaignTrackingRetryService, CampaignTrackingRetryService>();\nbuilder.Services.AddHttpClient<IWhatsAppTemplateService, WhatsAppTemplateService>();\nbuilder.Services.AddScoped<ICampaignRecipientService, CampaignRecipientService>();\nbuilder.Services.AddScoped<IPlanService, PlanService>();\nbuilder.Services.AddScoped<ITemplatePreviewService, TemplatePreviewService>();\nbuilder.Services.AddScoped<IOutboundCampaignQueueService, OutboundCampaignQueueService>();\nbuilder.Services.AddScoped<ICampaignPreviewService, CampaignPreviewService>();\nbuilder.Services.AddScoped<IAudienceService, AudienceService>();\nbuilder.Services.AddScoped<ICampaignVariableMapService, CampaignVariableMapService>();\nbuilder.Services.AddScoped<IAudienceImportService, AudienceImportService>();\nbuilder.Services.AddScoped<ICampaignMaterializationService, CampaignMaterializationService>();\nbuilder.Services.AddScoped<ICampaignDispatchPlannerService, CampaignDispatchPlannerService>();\nbuilder.Services.AddScoped<ICsvExportService, CsvExportService>();\n\nbuilder.Services.AddScoped<ICampaignDryRunService, CampaignDryRunService>();\nbuilder.Services.AddScoped<ICampaignRetargetService, CampaignRetargetService>();\n\n// API\nbuilder.Services.AddScoped<ICustomApiService, CustomApiService>();\n// CSV ingest\nbuilder.Services.AddScoped<CampaignCsvSchemaBuilder>();\nbuilder.Services.AddScoped<ICsvBatchService, CsvBatchService>();\nbuilder.Services.AddScoped<IVariableResolver, VariableResolver>();\nbuilder.Services.AddScoped<ICampaignMaterializer, CampaignMaterializer>();\nbuilder.Services.AddScoped<ICampaignAudienceAttachmentService, CampaignAudienceAttachmentService>();\nbuilder.Services.AddScoped<ICampaignDispatcher, CampaignDispatcher>();\nbuilder.Services.AddScoped<IVariableMappingService, NoopVariableMappingService>();\n//builder.Services.AddScoped<IOutboundCampaignQueueService, NoopOutboundCampaignQueueService>();\nbuilder.Services.AddScoped<IMappingSuggestionService, MappingSuggestionService>();\n\nbuilder.Services.AddHostedService<OutboundSenderWorker>();\n//Refactoring\nbuilder.Services.Configure<xbytechat.api.Features.CampaignTracking.Logging.BatchingOptions>(\n    builder.Configuration.GetSection(\"Batching\"));\n\nbuilder.Services.AddSingleton<ICampaignLogSink, CampaignLogSink>();\nbuilder.Services.AddHostedService<CampaignLogFlushWorker>();\nMetricsRegistry.Configure(builder.Configuration);\nbuilder.Services.AddSingleton<IPhoneNumberRateLimiter, PhoneNumberRateLimiter>();\nbuilder.Services.AddSingleton<ITemplatePayloadBuilder, TemplatePayloadBuilder>();\n\n\n// Provider payload mappers\nbuilder.Services.AddSingleton<MetaCloudPayloadMapper>();\nbuilder.Services.AddSingleton<PinnaclePayloadMapper>();\n\nbuilder.Services.Configure<MessageLogSinkOptions>(\n    builder.Configuration.GetSection(\"MessageLogSink\"));\n\nbuilder.Services.AddSingleton<PostgresCopyMessageLogSink>();\nbuilder.Services.AddSingleton<IMessageLogSink>(sp => sp.GetRequiredService<PostgresCopyMessageLogSink>());\nbuilder.Services.AddHostedService(sp => sp.GetRequiredService<PostgresCopyMessageLogSink>());\n\nbuilder.Services.AddScoped<ICampaignSendValidator, CampaignSendValidator>();\n\nbuilder.Services.AddScoped<IJourneyExportService, JourneyExportService>();\n\n#endregion\n\n#region üî∑ Webhook Management\nbuilder.Services.AddHostedService<OutboxReaperWorker>();\n\nbuilder.Services.AddScoped<IWhatsAppWebhookService, WhatsAppWebhookService>();\nbuilder.Services.AddScoped<IWhatsAppWebhookDispatcher, WhatsAppWebhookDispatcher>();\n\nbuilder.Services.AddScoped<ITemplateWebhookProcessor, TemplateWebhookProcessor>();\nbuilder.Services.AddScoped<IMessageIdResolver, MessageIdResolver>();\nbuilder.Services.AddScoped<IClickWebhookProcessor, ClickWebhookProcessor>();\nbuilder.Services.AddScoped<ILeadTimelineService, LeadTimelineService>();\nbuilder.Services.AddScoped<IFailedWebhookLogService, FailedWebhookLogService>();\nbuilder.Services.AddSingleton<IWebhookQueueService, WebhookQueueService>();\nbuilder.Services.AddHostedService<WebhookQueueWorker>();\nbuilder.Services.AddHostedService<FailedWebhookLogCleanupService>();\nbuilder.Services.AddScoped<IMaintenanceService, MaintenanceService>();\nbuilder.Services.AddHostedService<WebhookAutoCleanupWorker>();\nbuilder.Services.AddScoped<IProviderDirectory, ProviderDirectory>();\nbuilder.Services.AddScoped<IMessageStatusUpdater, MessageStatusUpdater>();\nbuilder.Services.AddScoped<IPinnacleToMetaAdapter, PinnacleToMetaAdapter>();\n\n\n#endregion\n\n#region üî∑ Access Control & Permission\nbuilder.Services.AddScoped<IPasswordHasher<User>, PasswordHasher<User>>();\nbuilder.Services.AddScoped<IAccessControlService, AccessControlService>();\nbuilder.Services.AddScoped<ITeamStaffService,TeamStaffService>();\n// BusinessesRole\nbuilder.Services.AddScoped<IBusinessRoleService, BusinessRoleService>();\n// BusinessesRolePermissions\nbuilder.Services.AddScoped<IBusinessRolePermissionsService, BusinessRolePermissionsService>();\n\n\n#endregion\n\n#region üî∑ Tracking\nbuilder.Services.AddScoped<ITrackingService, TrackingService>();\nbuilder.Services.AddScoped<IMessageAnalyticsService, MessageAnalyticsService>();\nbuilder.Services.AddScoped<IUrlBuilderService, UrlBuilderService>();\nbuilder.Services.AddScoped<IContactJourneyService, ContactJourneyService>();\n\nbuilder.Services.Configure<TrackingOptions>(builder.Configuration.GetSection(\"Tracking\"));\nbuilder.Services.AddSingleton<IClickTokenService, ClickTokenService>();\nbuilder.Services.AddSingleton<IClickEventQueue, InProcessClickEventQueue>();\nbuilder.Services.AddHostedService<ClickLogWorker>();\n\nbuilder.Services.AddScoped<IMessageLogsReportService, MessageLogsReportService>();\n\n#endregion\n\n#region Template Creation\nbuilder.Services.AddScoped<ITemplateDraftService, TemplateDraftService>();\nbuilder.Services.AddScoped<ITemplateSubmissionService, TemplateSubmissionService>();\nbuilder.Services.AddScoped<ITemplateLibraryService, TemplateLibraryService>();\nbuilder.Services.AddScoped<IMetaTemplateClient, MetaTemplateClient>();\nbuilder.Services.AddScoped<IWhatsAppTemplatesSyncBridge, WhatsAppTemplatesSyncBridge>();\nbuilder.Services.AddScoped<IMetaCredentialsResolver, MetaCredentialsResolver>();\nbuilder.Services.AddScoped<IMetaTemplateClient, MetaTemplateClient>();\nbuilder.Services.AddScoped<ITemplateStatusService, TemplateStatusService>();\nbuilder.Services.Configure<UploadLimitsOptions>(\n    builder.Configuration.GetSection(\"TemplateBuilder:UploadLimits\"));\n\nbuilder.Services.AddScoped<IMetaUploadService, MetaUploadService>();\nbuilder.Services.AddScoped<ITemplateNameCheckService, TemplateNameCheckService>();\nbuilder.Services.AddScoped<ITemplateDraftLifecycleService, TemplateDraftLifecycleService>();\n\n#endregion\n#region üî∑ Flow Builder\nbuilder.Services.AddScoped<ICTAFlowService, CTAFlowService>();\n\n//builder.Services.Configure<FlowClickTokenOptions>(\n//    builder.Configuration.GetSection(\"FlowClickTokens\"));\n\nbuilder.Services.AddOptions<FlowClickTokenOptions>()\n    .BindConfiguration(\"FlowClickTokens\")\n    .Validate(o => !string.IsNullOrWhiteSpace(o.Secret) && o.Secret.Length >= 32,\n              \"Secret required (‚â•32 chars).\")\n    .Validate(o => Uri.TryCreate(o.BaseUrl, UriKind.Absolute, out var u) && u.Scheme == Uri.UriSchemeHttps,\n              \"BaseUrl must be an absolute https URL.\")\n    .Validate(o => o.TtlHours > 0, \"TtlHours must be positive.\")\n    .ValidateOnStart();\n\nbuilder.Services.AddSingleton<IFlowClickTokenService, FlowClickTokenService>();\nbuilder.Services.AddScoped<IFlowRuntimeService, FlowRuntimeService>();  //\nbuilder.Services.AddScoped<ICtaFlowRuntimeService, CtaFlowRuntimeService>();\n\n#endregion\n\n#region üî∑ Audit Trail Logging\nbuilder.Services.AddHttpContextAccessor();\nbuilder.Services.AddScoped<IAuditLogService, AuditLogService>();\n#endregion\nbuilder.Services.AddScoped<IContactProfileService, ContactProfileService>();\nbuilder.Services.AddScoped<IFlowExecutionQueryService, FlowExecutionQueryService>();\n#region üî∑ WhatsApp settings\nbuilder.Services.AddScoped<IWhatsAppSettingsService, WhatsAppSettingsService>();\nbuilder.Services.AddValidatorsFromAssemblyContaining<SaveWhatsAppSettingValidator>();\nbuilder.Services.AddHttpClient<IMessageEngineService, MessageEngineService>();\nbuilder.Services.AddScoped<IWhatsAppTemplateFetcherService, WhatsAppTemplateFetcherService>();\nbuilder.Services.AddScoped<EnginePayloadBuilders.TextMessagePayloadBuilder>();\nbuilder.Services.AddScoped<EnginePayloadBuilders.ImageMessagePayloadBuilder>();\nbuilder.Services.AddScoped<EnginePayloadBuilders.TemplateMessagePayloadBuilder>();\nbuilder.Services.AddScoped<EnginePayloadBuilders.CtaMessagePayloadBuilder>();\nbuilder.Services.AddScoped<IPlanManager, PlanManager>();\nbuilder.Services.AddScoped<ICTAManagementService, CTAManagementService>();\nbuilder.Services.AddScoped<IWabaSubscriptionClient, WabaSubscriptionClient>();\n//builder.Services.AddScoped<IWhatsAppProviderFactory, WhatsAppProviderFactory>();\nbuilder.Services.AddScoped<xbytechat.api.Features.MessagesEngine.Factory.IWhatsAppProviderFactory,\n                           xbytechat.api.Features.MessagesEngine.Factory.WhatsAppProviderFactory>();\nbuilder.Services.AddScoped<IWhatsAppSenderService, WhatsAppSenderService>();\n\nbuilder.Services.AddHttpClient(\"wa:pincale\", c =>\n{\n    c.Timeout = TimeSpan.FromSeconds(20);\n});\n\nbuilder.Services.AddHttpClient(\"wa:meta_cloud\", c =>\n{\n    c.Timeout = TimeSpan.FromSeconds(20);\n});\n\nbuilder.Services.AddHttpClient(\"meta-graph\", c =>\n{\n    c.Timeout = TimeSpan.FromMinutes(5);\n});\nbuilder.Services.AddScoped<MetaTemplateCatalogProvider>();\nbuilder.Services.AddScoped<PinnacleTemplateCatalogProvider>();\nbuilder.Services.AddScoped<ITemplateSyncService, TemplateSyncService>();\n\n// WhatsApp phone number management\nbuilder.Services.AddScoped<IWhatsAppPhoneNumberService, WhatsAppPhoneNumberService>();\n\n#endregion\n\n#region Worker\nbuilder.Services.AddHostedService<TemplateSyncWorker>();\n//builder.Services.AddHostedService<OutboundCampaignSendWorker>();\n\n#endregion\n#region üî∑ Inbox\nbuilder.Services.AddScoped<IUnreadCountService, UnreadCountService>();\n\nbuilder.Services.AddScoped<IFlowAnalyticsService, FlowAnalyticsService>();\nbuilder.Services.AddScoped<IInboxService, InboxService>();\nbuilder.Services.AddScoped<IInboundMessageProcessor, InboundMessageProcessor>();\nbuilder.Services.AddScoped<IInboxRepository, InboxRepository>();\nbuilder.Services.AddScoped<IQuickReplyService, QuickReplyService>();\n// ChatInbox\nbuilder.Services.AddScoped<IChatInboxQueryService, ChatInboxQueryService>();\nbuilder.Services.AddScoped<IChatInboxCommandService, ChatInboxCommandService>();\nbuilder.Services.AddScoped<IChatInboxAssignmentService, ChatInboxAssignmentService>();\nbuilder.Services.AddScoped<IChatInboxMediaUploadService, ChatInboxMediaUploadService>();\nbuilder.Services.AddScoped<IChatInboxMediaContentService, ChatInboxMediaContentService>();\n\n#endregion\n\n#region üî∑ Access Control\nbuilder.Services.AddScoped<IPermissionService, PermissionService>();\nbuilder.Services.AddMemoryCache();\nbuilder.Services.AddScoped<IPermissionCacheService, PermissionCacheService>();\nbuilder.Services.AddScoped<IBusinessPermissionOverrideService, BusinessPermissionOverrideService>();\n\n#endregion\n\n#region üî∑ AutoReplyBuilder Module\n//builder.Services.AddScoped<IAutoReplyRepository, AutoReplyRepository>();\n//builder.Services.AddScoped<IAutoReplyService, AutoReplyService>();\nbuilder.Services.AddScoped<IAutoReplyFlowRepository, AutoReplyFlowRepository>();\nbuilder.Services.AddScoped<IAutoReplyFlowService, AutoReplyFlowService>();\nbuilder.Services.AddScoped<IAutoReplyRuntimeService, AutoReplyRuntimeService>();\nbuilder.Services.AddScoped<IChatSessionStateService, ChatSessionStateService>();\nbuilder.Services.AddScoped<IAgentAssignmentService, AgentAssignmentService>();\nbuilder.Services.AddScoped<IAutoReplyLogService, AutoReplyLogService>();\nbuilder.Services.AddScoped<IFlowExecutionLogger, FlowExecutionLogger>();\n#endregion\n\n#region üî∑ Automation Module\nbuilder.Services.AddScoped<IAutomationFlowRepository, AutomationFlowRepository>();\nbuilder.Services.AddScoped<IAutomationRunner, AutomationRunner>();\nbuilder.Services.AddScoped<IAutomationService, AutomationService>();\n#endregion\n\n\n#region üîê JWT Authentication (Bearer token only, no cookies)\n\nbuilder.Services\n    .AddAuthentication(JwtBearerDefaults.AuthenticationScheme)\n    .AddJwtBearer(options =>\n    {\n        var jwtSettings = builder.Configuration.GetSection(\"JwtSettings\");\n\n        options.TokenValidationParameters = new TokenValidationParameters\n        {\n            ValidateIssuer = true,\n            ValidateAudience = true,\n            ValidateLifetime = true,\n            ValidateIssuerSigningKey = true,\n            ValidIssuer = jwtSettings[\"Issuer\"],\n            ValidAudience = jwtSettings[\"Audience\"],\n            IssuerSigningKey = new SymmetricSecurityKey(\n                Encoding.UTF8.GetBytes(jwtSettings[\"SecretKey\"] ?? string.Empty)\n            ),\n            ClockSkew = TimeSpan.Zero\n        };\n\n        options.Events = new JwtBearerEvents\n        {\n            OnAuthenticationFailed = context =>\n            {\n                if (context.Exception is SecurityTokenExpiredException)\n                {\n                    // ‚úÖ Tell the pipeline we are handling this\n                    context.NoResult();\n\n                    context.Response.StatusCode = StatusCodes.Status401Unauthorized;\n                    context.Response.ContentType = \"application/json\";\n                    context.Response.Headers[\"x-token-expired\"] = \"true\";\n\n                    var payload =\n                        \"{\\\"success\\\":false,\\\"code\\\":\\\"TOKEN_EXPIRED\\\",\\\"message\\\":\\\"Token expired. Please login again.\\\"}\";\n\n                    return context.Response.WriteAsync(payload);\n                }\n\n                return Task.CompletedTask;\n            },\n            OnMessageReceived = context =>\n            {\n                var accessToken = context.Request.Query[\"access_token\"];\n                var path = context.HttpContext.Request.Path;\n\n                if (!string.IsNullOrEmpty(accessToken) &&\n                    path.StartsWithSegments(\"/api/hubs/inbox\"))\n                {\n                    context.Token = accessToken;\n                }\n\n                return Task.CompletedTask;\n            }\n        };\n    });\n\nbuilder.Services.AddAuthorization();\n\n\nbuilder.Services.AddAuthorization();\n#endregion\nbuilder.Services.Configure<StaticApiKeyOptions>(\n    builder.Configuration.GetSection(\"ApiKeys:Static\"));\n\n#region üåê CORS Setup (Bearer mode, no credentials)\n\nvar allowedOrigins = builder.Configuration.GetSection(\"Cors:AllowedOrigins\").Get<string[]>();\nif (allowedOrigins == null || allowedOrigins.Length == 0)\n{\n    var raw = builder.Configuration[\"Cors:AllowedOrigins\"];\n    if (!string.IsNullOrWhiteSpace(raw))\n        allowedOrigins = raw.Split(new[] { ',', ';', ' ' }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);\n}\nConsole.WriteLine(\"[CORS] Allowed origins => \" + string.Join(\", \", allowedOrigins ?? Array.Empty<string>()));\n\n\n\nbuilder.Services.AddCors(options =>\n{\n    options.AddPolicy(\"AllowFrontend\", policy =>\n    {\n        policy\n            .WithOrigins(allowedOrigins ?? Array.Empty<string>())\n            .AllowAnyHeader()\n            .AllowAnyMethod()\n            .AllowCredentials();\n    });\n});\n#endregion\n\n#region ‚úÖ MVC + Swagger + Middleware\nbuilder.Services.AddControllers()\n    .AddJsonOptions(opts =>\n    {\n        opts.JsonSerializerOptions.Converters.Add(new JsonStringEnumConverter(JsonNamingPolicy.CamelCase));\n    });\n\nbuilder.Services.AddEndpointsApiExplorer();\n\n//builder.Services.AddSwaggerGen(options =>\n//{\n//    options.SwaggerDoc(\"v1\", new Microsoft.OpenApi.Models.OpenApiInfo\n//    {\n//        Title = \"xByteChat API\",\n//        Version = \"v1\",\n//        Description = \"API documentation for xByteChat project\"\n//    });\n//});\nbuilder.Services.AddSwaggerGen(options =>\n{\n    options.SwaggerDoc(\"v1\", new Microsoft.OpenApi.Models.OpenApiInfo\n    {\n        Title = \"xByteChat API\",\n        Version = \"v1\",\n        Description = \"API documentation for xByteChat project\"\n    });\n    \n    options.OperationFilter<FileUploadOperationFilter>();\n    options.AddSecurityDefinition(\"Bearer\", new Microsoft.OpenApi.Models.OpenApiSecurityScheme\n    {\n        Description = \"JWT Authorization header. Example: Bearer {token}\",\n        Name = \"Authorization\",\n        In = Microsoft.OpenApi.Models.ParameterLocation.Header,\n        Type = Microsoft.OpenApi.Models.SecuritySchemeType.Http,\n        Scheme = \"bearer\",\n        BearerFormat = \"JWT\"\n    });\n\n    options.AddSecurityDefinition(\"ApiKey\", new OpenApiSecurityScheme\n    {\n        Description = \"Paste your static key (no quotes). Example: api_live_DEV_xxx\",\n        In = ParameterLocation.Header,\n        Name = \"X-Auth-Key\",\n        Type = SecuritySchemeType.ApiKey\n    });\n\n    options.AddSecurityRequirement(new Microsoft.OpenApi.Models.OpenApiSecurityRequirement\n    {\n        {\n            new Microsoft.OpenApi.Models.OpenApiSecurityScheme\n            {\n                Reference = new Microsoft.OpenApi.Models.OpenApiReference\n                { Type = Microsoft.OpenApi.Models.ReferenceType.SecurityScheme, Id = \"Bearer\" }\n            },\n            Array.Empty<string>()\n        },\n        {\n            new Microsoft.OpenApi.Models.OpenApiSecurityScheme\n            {\n                Reference = new Microsoft.OpenApi.Models.OpenApiReference\n                { Type = Microsoft.OpenApi.Models.ReferenceType.SecurityScheme, Id = \"ApiKey\" }\n            },\n            Array.Empty<string>()\n        }\n    });\n});\n\n#endregion\n\n#region ‚úÖ Embedded Signup\n\n// 1) Options binding (use consistent path/casing)\nbuilder.Services.Configure<EsuOptions>(builder.Configuration.GetSection(\"EmbeddedSignup\"));\n\n// 2) Infra\nbuilder.Services.AddHttpClient(); // harmless global client registration\n\n// 3) ESU core services\nbuilder.Services.AddScoped<IEsuStateStore, MemoryEsuStateStore>();\nbuilder.Services.AddScoped<IEsuFlagStore, EsuFlagStore>();\nbuilder.Services.AddScoped<IFacebookEsuService, FacebookEsuService>();\nbuilder.Services.AddScoped<IEsuTokenStore, EsuTokenStore>();\n// Environment-aware validation\nvar isDev = builder.Environment.IsDevelopment();\n\nbuilder.Services\n    .AddOptions<xbytechat.api.Features.ESU.Facebook.Options.FacebookOauthOptions>()\n    .Bind(builder.Configuration.GetSection(\"EmbeddedSignup:Facebook\"))\n    .PostConfigure(o =>\n    {\n        o.GraphBaseUrl = string.IsNullOrWhiteSpace(o.GraphBaseUrl)\n            ? \"https://graph.facebook.com\"\n            : o.GraphBaseUrl.TrimEnd('/');\n        o.GraphApiVersion = string.IsNullOrWhiteSpace(o.GraphApiVersion)\n            ? \"v20.0\"\n            : o.GraphApiVersion.Trim('/');\n    })\n    // ‚úÖ AppId must always exist\n    .Validate(o => !string.IsNullOrWhiteSpace(o.AppId),\n        \"EmbeddedSignup:Facebook:AppId is required.\")\n    // ‚úÖ AppSecret required only in non-Development\n    .Validate(o => isDev || !string.IsNullOrWhiteSpace(o.AppSecret),\n        \"EmbeddedSignup:Facebook:AppSecret is required in non-Development.\")\n    // ‚úÖ RedirectUri must be absolute (https required outside dev)\n    .Validate(o =>\n    {\n        if (string.IsNullOrWhiteSpace(o.RedirectUri)) return false;\n        if (!Uri.TryCreate(o.RedirectUri, UriKind.Absolute, out var uri)) return false;\n        return isDev || uri.Scheme == Uri.UriSchemeHttps;\n    }, \"EmbeddedSignup:Facebook:RedirectUri must be an absolute HTTPS URL.\")\n    .ValidateOnStart();\n\n// 4) Typed HttpClient for OAuth token exchange\nbuilder.Services.AddHttpClient<IFacebookOauthClient,FacebookOauthClient>(client =>\n{\n    client.Timeout = TimeSpan.FromSeconds(15);\n});\n\n// 5) ESU flag cache configuration\nbuilder.Services.AddOptions<EsuFlagCacheOptions>()\n    .Bind(builder.Configuration.GetSection(\"EmbeddedSignup:FlagCache\"))\n    .PostConfigure(o =>\n    {\n        if (o.TtlSeconds <= 0) o.TtlSeconds = 30;\n        if (o.MissTtlSeconds <= 0) o.MissTtlSeconds = 5;\n    });\n\n// 6) Token retrieval service\nbuilder.Services.AddScoped<IFacebookTokenService, FacebookTokenService>();\n\n\nbuilder.Services.AddHttpClient<IFacebookGraphClient, FacebookGraphClient>(client =>\n {\n     client.Timeout = TimeSpan.FromSeconds(15);\n });\n\nbuilder.Services.AddScoped<IEsuStatusService, EsuStatusService>();\n\n\n\nbuilder.Services.Configure<FacebookOptions>(builder.Configuration.GetSection(\"EmbeddedSignup:Facebook\"));\n\nbuilder.Services.Configure<UiOptions>(builder.Configuration.GetSection(\"Ui\"));\n#endregion\n\n#region Rate Limiter\nbuilder.Services.AddRateLimiter(o =>\n{\n    o.AddFixedWindowLimiter(\"GlobalLimiter\", opt =>\n    {\n        opt.PermitLimit = 100;\n        opt.Window = TimeSpan.FromMinutes(1);\n        opt.QueueLimit = 0;\n    });\n    o.AddFixedWindowLimiter(\"AuthLimiter\", opt =>\n    {\n        opt.PermitLimit = 10;   // login/signup attempts per minute\n        opt.Window = TimeSpan.FromMinutes(1);\n        opt.QueueLimit = 0;\n    });\n});\n\n#endregion\n\n#region Account Insignts\nbuilder.Services.AddScoped<IAccountInsightsService, AccountInsightsService>();\nbuilder.Services.AddScoped<IAccountInsightsAlertService, AccountInsightsAlertService>();\n\n#endregion\n\n#region payment module\nbuilder.Services.AddScoped<ISubscriptionService, SubscriptionService>();\nbuilder.Services.AddScoped<IInvoiceService, InvoiceService>();\nbuilder.Services.AddScoped<ICouponService, CouponService>();\nbuilder.Services.AddScoped<IAccessGuard, AccessGuard>();\nbuilder.Services.AddHttpClient<IPaymentGatewayService, RazorpayPaymentGatewayService>();\nbuilder.Services.AddScoped<ISubscriptionCheckoutService, SubscriptionCheckoutService>();\nbuilder.Services.AddScoped<PaymentOverviewService>();\nbuilder.Services.AddScoped<IAccessGuard, AccessGuard>();\nbuilder.Services.AddScoped<SubscriptionLifecycleService>();\nbuilder.Services.Configure<SubscriptionLifecycleOptions>(\n    builder.Configuration.GetSection(\"SubscriptionLifecycle\"));\n\n#endregion\n\n#region Quota Module (Entitlement)\nbuilder.Services.AddScoped<IQuotaService, QuotaService>();\n#endregion\nbuilder.Services.Configure<HostOptions>(o =>\n    o.BackgroundServiceExceptionBehavior = BackgroundServiceExceptionBehavior.Ignore);\n\nbuilder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());\n\n#region SignalR\nbuilder.Services.AddSignalR();\nbuilder.Services.AddSingleton<IUserIdProvider, NameUserIdProvider>();\n#endregion\n\nbuilder.Services.AddHttpClient(\"customapi-webhooks\", c =>\n{\n    c.Timeout = TimeSpan.FromSeconds(10);\n});\nbuilder.Services.AddScoped<ICtaJourneyPublisher, CtaJourneyPublisher>();\nbuilder.Services.AddScoped<CtaJourneyPublisher>();\n\nAppDomain.CurrentDomain.UnhandledException += (_, e) =>\n    Log.Error(e.ExceptionObject as Exception, \"Unhandled exception (AppDomain)\");\n\n\nTaskScheduler.UnobservedTaskException += (_, e) =>\n{\n    Log.Error(e.Exception, \"Unobserved task exception\");\n    e.SetObserved();\n};\nvar app = builder.Build();\n\n\n\napp.MapGet(\"/api/debug/cors\", () => Results.Ok(new\n{\n    Allowed = app.Services.GetRequiredService<IConfiguration>()\n              .GetSection(\"Cors:AllowedOrigins\").Get<string[]>()\n}));\napp.MapGet(\"/api/debug/db\", async (AppDbContext db) =>\n{\n    try\n    {\n        await db.Database.OpenConnectionAsync();\n        await db.Database.CloseConnectionAsync();\n        return Results.Ok(\"ok\");\n    }\n    catch (Exception ex) { return Results.Problem(ex.Message); }\n});\napp.MapGet(\"/api/debug/_dbping\", async (IConfiguration cfg) =>\n{\n    try\n    {\n        var cs = cfg.GetConnectionString(\"DefaultConnection\");\n        await using var conn = new Npgsql.NpgsqlConnection(cs);\n        await conn.OpenAsync();\n        await using var cmd = new Npgsql.NpgsqlCommand(\"select version()\", conn);\n        var ver = (string?)await cmd.ExecuteScalarAsync();\n        return Results.Ok(new { ok = true, version = ver });\n    }\n    catch (Exception ex)\n    {\n        return Results.Problem(title: \"DB ping failed\", detail: ex.ToString(), statusCode: 500);\n    }\n});\napp.MapGet(\"/api/debug/conn\", (IConfiguration cfg) =>\n{\n    var cs = cfg.GetConnectionString(\"DefaultConnection\") ?? \"\";\n    var b = new NpgsqlConnectionStringBuilder(cs);\n    return Results.Ok(new\n    {\n        host = b.Host,\n        port = b.Port,\n        database = b.Database,\n        username = b.Username,\n        sslmode = b.SslMode.ToString(),\n        hasPassword = !string.IsNullOrEmpty(b.Password)\n    });\n});\n// Try DNS resolution of the DB host that /api/debug/conn reports\napp.MapGet(\"/api/debug/dns\", (IConfiguration cfg) =>\n{\n    var cs = cfg.GetConnectionString(\"DefaultConnection\") ?? \"\";\n    var b = new NpgsqlConnectionStringBuilder(cs);\n    try\n    {\n        var ips = Dns.GetHostAddresses(b.Host);\n        return Results.Ok(new { host = b.Host, addresses = ips.Select(i => i.ToString()).ToArray() });\n    }\n    catch (Exception ex)\n    {\n        return Results.Problem($\"DNS failed for host '{b.Host}': {ex.Message}\");\n    }\n});\n\n\n#region üåê Middleware Pipeline Setup \n\n#region CSP SEcurity\n\napp.Use(async (ctx, next) =>\n{\n    if (ctx.Request.Path.StartsWithSegments(\"/swagger\"))\n    {\n        // Swagger UI needs inline script & style\n        ctx.Response.Headers[\"Content-Security-Policy\"] =\n            \"default-src 'self'; \" +\n            \"script-src 'self' 'unsafe-inline'; \" +   // relaxed only for /swagger\n            \"style-src 'self' 'unsafe-inline'; \" +\n            \"img-src 'self' data: blob:; \" +\n            \"font-src 'self' data:; \" +\n            \"connect-src 'self'; \" +\n            \"frame-ancestors 'none'; \" +\n            \"base-uri 'self';\";\n    }\n    else\n    {\n        // Keep stricter policy for the rest of the app\n        ctx.Response.Headers[\"Content-Security-Policy\"] =\n            \"default-src 'self'; \" +\n            \"script-src 'self'; \" +                    // no inline scripts outside Swagger\n            \"style-src 'self' 'unsafe-inline'; \" +\n            \"img-src 'self' data: blob:; \" +\n            \"font-src 'self' data:; \" +\n            \"connect-src 'self'; \" +\n            \"frame-ancestors 'none'; \" +\n            \"base-uri 'self';\";\n    }\n\n    ctx.Response.Headers[\"X-Content-Type-Options\"] = \"nosniff\";\n    ctx.Response.Headers[\"X-Frame-Options\"] = \"DENY\";\n    ctx.Response.Headers[\"Referrer-Policy\"] = \"strict-origin-when-cross-origin\";\n    ctx.Response.Headers[\"Permissions-Policy\"] = \"camera=(), microphone=(), geolocation=()\";\n    await next();\n});\n\n\n\n#endregion\nAuditLoggingHelper.Configure(app.Services);\n\napp.UseMiddleware<GlobalExceptionMiddleware>();\n\nif (app.Environment.IsDevelopment())\n{\n    // Dev-specific configs\n}\n\napp.UseSwagger();\n\n//app.UseSwaggerUI();\napp.UseSwaggerUI(c =>\n{\n    c.SwaggerEndpoint(\"/swagger/v1/swagger.json\", \"xbytechat.api v1\");\n    c.RoutePrefix = \"swagger\";\n});\nif (!app.Environment.IsDevelopment())\n{\n\n    app.UseHttpsRedirection();\n    app.UseHsts();\n}\n\n// Security headers\n//app.Use(async (context, next) =>\n//{\n//    context.Response.Headers[\"X-Content-Type-Options\"] = \"nosniff\";\n//    context.Response.Headers[\"X-Frame-Options\"] = \"DENY\";\n//    context.Response.Headers[\"X-XSS-Protection\"] = \"1; mode=block\";\n//    context.Response.Headers[\"Referrer-Policy\"] = \"strict-origin-when-cross-origin\";\n//    context.Response.Headers[\"Permissions-Policy\"] = \"geolocation=(), microphone=(), camera=()\";\n//    await next();\n//});\n\napp.UseRouting();\napp.UseCors(\"AllowFrontend\");\n\napp.UseAuthentication();\napp.UseAuthorization();\napp.UseRateLimiter();\napp.MapControllers()\n     .RequireRateLimiting(\"GlobalLimiter\");\n\n\n//app.MapHub<InboxHub>(\"/hubs/inbox\");\napp.MapHub<InboxHub>(\"/api/hubs/inbox\");\n// Seed global template library\nawait TemplateLibrarySeeder.SeedAsync(app.Services);\n\napp.Run();\n#endregion\n\n\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Properties/launchSettings.json",
      "sha256": "3374c65b7338b8a459db1242f356b2dd07d3dfd4cded988482a8f34fbe64e62e",
      "language": "json",
      "size": 1102,
      "content": "{\n  \"$schema\": \"http://json.schemastore.org/launchsettings.json\",\n  \"iisSettings\": {\n    \"windowsAuthentication\": false,\n    \"anonymousAuthentication\": true,\n    \"iisExpress\": {\n      \"applicationUrl\": \"http://localhost:18939\",\n      \"sslPort\": 44375\n    }\n  },\n  \"profiles\": {\n    \"http\": {\n      \"commandName\": \"Project\",\n      \"dotnetRunMessages\": true,\n      \"launchBrowser\": true,\n      \"launchUrl\": \"swagger\",\n      \"applicationUrl\": \"http://localhost:5295;http://localhost:7113\",\n      \"environmentVariables\": {\n        \"ASPNETCORE_ENVIRONMENT\": \"Development\"\n      }\n    },\n    \"https\": {\n      \"commandName\": \"Project\",\n      \"dotnetRunMessages\": true,\n      \"launchBrowser\": true,\n      \"launchUrl\": \"swagger\",\n      \"applicationUrl\": \"http://localhost:7113;http://localhost:5295\",\n      \"environmentVariables\": {\n        \"ASPNETCORE_ENVIRONMENT\": \"Development\"\n      }\n    },\n    \"IIS Express\": {\n      \"commandName\": \"IISExpress\",\n      \"launchBrowser\": true,\n      \"launchUrl\": \"swagger\",\n      \"environmentVariables\": {\n        \"ASPNETCORE_ENVIRONMENT\": \"Development\"\n      }\n    }\n  }\n}\n"
    },
    {
      "path": "xbytechat-api/RepositoriesGen/Implementations/GenericRepository.cs",
      "sha256": "68fdbced75094ad69adcf2073501cec37b1745f7b4d6206826d6aedc33fe0a46",
      "language": "csharp",
      "size": 2091,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Linq.Expressions;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Repositories.Interfaces;\n\nnamespace xbytechat.api.Repositories.Implementations\n{\n    public class GenericRepository<T> : IGenericRepository<T> where T : class\n    {\n        private readonly AppDbContext _context;\n        private readonly DbSet<T> _dbSet;\n\n        public GenericRepository(AppDbContext context)\n        {\n            _context = context;\n            _dbSet = _context.Set<T>();\n        }\n\n        public async Task<IEnumerable<T>> GetAllAsync()\n        {\n            return await _dbSet.ToListAsync();\n        }\n\n        public async Task<T?> FindByIdAsync(Guid id)\n        {\n            return await _dbSet.FindAsync(id);\n        }\n\n        public async Task AddAsync(T entity)\n        {\n            await _dbSet.AddAsync(entity);\n        }\n\n        public void Update(T entity)\n        {\n            _dbSet.Update(entity);\n        }\n\n        public void Delete(T entity)\n        {\n            _dbSet.Remove(entity);\n        }\n\n        public async Task<T?> FirstOrDefaultAsync(Expression<Func<T, bool>> predicate)\n        {\n            return await _dbSet.FirstOrDefaultAsync(predicate);\n        }\n\n        public async Task<IEnumerable<T>> FindAllAsync(Expression<Func<T, bool>> predicate)\n        {\n            return await _dbSet.Where(predicate).ToListAsync();\n        }\n\n        public async Task<bool> ExistsAsync(Expression<Func<T, bool>> predicate)\n        {\n            return await _dbSet.AnyAsync(predicate);\n        }\n\n        public async Task SaveAsync()\n        {\n            await _context.SaveChangesAsync();\n        }\n\n        public async Task<List<T>> WhereAsync(Expression<Func<T, bool>> predicate)\n        {\n            return await _context.Set<T>().Where(predicate).ToListAsync();\n        }\n\n        // ‚úÖ NEW: Enables .Include(), .ThenInclude(), etc.\n        public IQueryable<T> AsQueryable()\n        {\n            return _dbSet.AsQueryable();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/RepositoriesGen/Interfaces/IGenericRepository.cs",
      "sha256": "dce9a4518c5e6db0da8996246969bbc864c23c5ec0eeb93ac053cc16a33bc920",
      "language": "csharp",
      "size": 941,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Linq.Expressions;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Repositories.Interfaces\n{\n    public interface IGenericRepository<T> where T : class\n    {\n        // üîç Basic Reads\n        Task<IEnumerable<T>> GetAllAsync();\n        Task<T?> FindByIdAsync(Guid id);\n        Task<T?> FirstOrDefaultAsync(Expression<Func<T, bool>> predicate);\n        Task<IEnumerable<T>> FindAllAsync(Expression<Func<T, bool>> predicate);\n\n        // üîê Checks\n        Task<bool> ExistsAsync(Expression<Func<T, bool>> predicate);\n\n        // ‚úçÔ∏è Commands\n        Task AddAsync(T entity);\n        void Update(T entity);\n        void Delete(T entity);\n        Task SaveAsync();\n\n        Task<List<T>> WhereAsync(Expression<Func<T, bool>> predicate);\n\n        // ‚úÖ New: Supports advanced LINQ operations like Include()\n        IQueryable<T> AsQueryable();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Services/MessageModule/Implementations/MessageService.cs",
      "sha256": "df4904957a9ef900be4c3b85e61e948b37984a54ff581b7767929c80b6d69ebe",
      "language": "csharp",
      "size": 9801,
      "content": "using System.Text;\nusing System.Net.Http.Headers;\nusing Newtonsoft.Json;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models;\nusing xbytechat.api.PayloadBuilders;\nusing xbytechat.api.Repositories.Interfaces;\nusing xbytechat.api.Services.Messages.Interfaces;\nusing Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.EntityFrameworkCore;\n\nnamespace xbytechat.api.Services.Messages.Implementations\n{\n    public class MessageService : IMessageService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly HttpClient _httpClient;\n        private readonly IConfiguration _config;\n        private readonly IGenericRepository<MessageLog> _messageLogRepo;\n        private readonly Dictionary<string, IWhatsAppPayloadBuilder> _payloadBuilders;\n        private readonly ILogger<MessageService> _logger;\n\n        public MessageService(\n            AppDbContext dbContext,\n            HttpClient httpClient,\n            IConfiguration config,\n            IGenericRepository<MessageLog> messageLogRepo,\n            IEnumerable<IWhatsAppPayloadBuilder> builders,\n            ILogger<MessageService> logger)\n        {\n            _dbContext = dbContext;\n            _httpClient = httpClient;\n            _config = config;\n            _messageLogRepo = messageLogRepo;\n            _logger = logger;\n\n            _payloadBuilders = builders.ToDictionary(\n                b => b.GetType().Name.Replace(\"MessagePayloadBuilder\", \"\").ToLower(),\n                b => b\n            );\n        }\n\n        public async Task SendFollowUpAsync(string recipientNumber, string messageContent)\n        {\n            var dto = new TextMessageDto\n            {\n                RecipientNumber = recipientNumber,\n                MessageContent = messageContent,\n                BusinessId = Guid.Empty // Optional: Set dynamically if needed\n            };\n\n            await SendMessageAsync(dto); // ‚úÖ You already have this method\n        }\n\n\n        public async Task<SendResultExtended> SendMessageAsync(BaseMessageDto dto)\n        {\n            var messageType = dto.GetType().Name.Replace(\"MessageDto\", \"\").ToLower();\n\n            // üß† Get the right builder (e.g., for text, image)\n            if (!_payloadBuilders.TryGetValue(messageType, out var builder))\n            {\n                return new SendResultExtended\n                {\n                    Success = false,\n                    Message = \"‚ùå Unsupported message type: \" + messageType\n                };\n            }\n\n            var apiUrl = _config[\"WhatsApp:ApiUrl\"];\n            var apiToken = _config[\"WhatsApp:apiToken\"];\n            _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", apiToken);\n\n            var payload = builder.BuildPayload(dto);\n            var json = JsonConvert.SerializeObject(payload);\n            var content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            _logger.LogInformation(\"üì¶ Sending Payload: {Payload}\", json);\n\n            try\n\n\n            {\n                // üõ†Ô∏è Log the payload for debugging\n                _logger.LogInformation(\"üì§ Final WhatsApp Payload:\\n\" + JsonConvert.SerializeObject(payload, Formatting.Indented));\n\n                var response = await _httpClient.PostAsync(apiUrl, content);\n                var rawResponse = await response.Content.ReadAsStringAsync();\n\n                string? messageId = null;\n\n                // üßæ Try extracting messageId (WAMID) from response\n                if (response.IsSuccessStatusCode)\n                {\n                    try\n                    {\n                        var jsonObj = JsonConvert.DeserializeObject<dynamic>(rawResponse);\n                        messageId = jsonObj?.messages?[0]?.id;\n                    }\n                    catch (Exception ex)\n                    {\n                        _logger.LogWarning(\"‚úÖ Message sent but failed to parse WAMID: \" + ex.Message);\n                    }\n                }\n\n                // üìù Log message for tracking\n                var log = new MessageLog\n                {\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto is TextMessageDto textDto && !string.IsNullOrEmpty(textDto.MessageContent)\n                        ? textDto.MessageContent\n                        : \"[Empty or Non-Text]\",\n                    MediaUrl = (dto as ImageMessageDto)?.MediaUrl,\n                    Status = response.IsSuccessStatusCode ? \"Sent\" : \"Failed\",\n                    ErrorMessage = response.IsSuccessStatusCode ? null : response.ReasonPhrase,\n                    RawResponse = rawResponse,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId\n                };\n\n                await _messageLogRepo.AddAsync(log);\n                await _messageLogRepo.SaveAsync();\n\n                return new SendResultExtended\n                {\n                    Success = response.IsSuccessStatusCode,\n                    Message = response.IsSuccessStatusCode ? \"‚úÖ Message sent successfully\" : \"‚ùå Failed to send message\",\n                    MessageId = messageId,\n                    RawResponse = rawResponse,\n                    MessageLogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå Exception during message send\");\n\n                return new SendResultExtended\n                {\n                    Success = false,\n                    Message = \"‚ùå Exception while sending\",\n                    ErrorMessage = ex.Message\n                };\n            }\n        }\n        public async Task<SendResultExtended> SendInteractiveMessageAsync(string recipientPhone, string bodyText, List<string> buttons)\n        {\n            var apiUrl = _config[\"WhatsApp:ApiUrl\"];\n            var apiToken = _config[\"WhatsApp:apiToken\"];\n\n            _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", apiToken);\n\n            var payload = new\n            {\n                messaging_product = \"whatsapp\",\n                to = recipientPhone,\n                type = \"interactive\",\n                interactive = new\n                {\n                    type = \"button\",\n                    body = new { text = bodyText },\n                    action = new\n                    {\n                        buttons = buttons.Select((text, index) => new\n                        {\n                            type = \"reply\",\n                            reply = new\n                            {\n                                id = $\"cta_{index + 1}\",\n                                title = text\n                            }\n                        }).ToList()\n                    }\n                }\n            };\n\n            var json = JsonConvert.SerializeObject(payload);\n            var content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            _logger.LogInformation(\"üöÄ Sending CTA Message: \" + json);\n\n            try\n            {\n                var response = await _httpClient.PostAsync(apiUrl, content);\n                var rawResponse = await response.Content.ReadAsStringAsync();\n                // Message send here successfully \n                string? messageId = null;\n                if (response.IsSuccessStatusCode)\n                {\n                    try\n                    {\n                        dynamic jsonObj = JsonConvert.DeserializeObject<dynamic>(rawResponse);\n                        messageId = jsonObj?.messages?[0]?.id;\n                    }\n                    catch (Exception ex)\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Sent, but failed to parse messageId: \" + ex.Message);\n                    }\n                }\n\n                // Log to MessageLogs table (optional: use a dummy entry)\n\n                var log = new MessageLog\n                {\n\n                    //BusinessId = Guid.Parse(\"put-a-valid-business-guid-here\"), //Guid.Empty, // set properly if you want to track\n                    BusinessId = Guid.TryParse(\"45262049-0127-4658-93e1-b3ffea645f4f\", out var parsedId)\n    ? parsedId\n    : throw new FormatException(\"‚ùå Invalid GUID format used for BusinessId.\"),\n                    RecipientNumber = recipientPhone,\n                    MessageContent = bodyText,\n                    Status = response.IsSuccessStatusCode ? \"Sent\" : \"Failed\",\n                    ErrorMessage = response.IsSuccessStatusCode ? null : response.ReasonPhrase,\n                    RawResponse = rawResponse,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId\n                };\n\n                await _messageLogRepo.AddAsync(log);\n                await _messageLogRepo.SaveAsync();\n\n                return new SendResultExtended\n                {\n                    Success = response.IsSuccessStatusCode,\n                    Message = response.IsSuccessStatusCode ? \"‚úÖ CTA message sent\" : \"‚ùå Failed to send CTA\",\n                    MessageId = messageId,\n                    RawResponse = rawResponse,\n                    MessageLogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå Exception while sending CTA\");\n\n                return new SendResultExtended\n                {\n                    Success = false,\n                    Message = \"‚ùå Exception while sending CTA\",\n                    ErrorMessage = ex.InnerException?.Message ?? ex.Message // ‚úÖ this is critical\n                };\n            }\n\n        }\n\n    }\n}\n\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Services/MessageModule/Interfaces/IMessageService.cs",
      "sha256": "7592cb1c94c37bab95a7c1a34fbc22e00b2fa0428bc1a23a4c2626a437314c30",
      "language": "csharp",
      "size": 846,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Services.Messages.Interfaces\n{\n    public interface IMessageService\n    {\n        /// <summary>\n        /// Sends a message of any supported type (Text, Image, Template).\n        /// </summary>\n        /// <param name=\"dto\">Base DTO representing message details.</param>\n        /// <returns>Standardized result with status, error info, and raw response.</returns>\n        Task<SendResultExtended> SendMessageAsync(BaseMessageDto dto);\n        //Task<SendResultExtended> SendBulkMessagesAsync(BulkMessageDto dto);\n        Task SendFollowUpAsync(string recipientNumber, string messageContent);\n        Task<SendResultExtended> SendInteractiveMessageAsync(string recipientPhone, string bodyText, List<string> buttons);\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Services/WhatsAppService.cs",
      "sha256": "239db95488943944c9836125a53c4ede14522f2bc4914748e07350d86cc0051f",
      "language": "csharp",
      "size": 2917,
      "content": "using System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing Microsoft.Extensions.Configuration;\nusing xbytechat.api.Models;\n\nnamespace xbytechat.api.Services\n{\n    public class WhatsAppService\n    {\n        private readonly HttpClient _httpClient;\n        private readonly string _whatsAppToken;\n        private readonly string _whatsAppPhoneId;\n\n        public WhatsAppService(IConfiguration configuration)\n        {\n            _httpClient = new HttpClient();\n\n            _whatsAppToken = configuration[\"WhatsApp:apiToken\"];\n            _whatsAppPhoneId = configuration[\"WhatsApp:PhoneNumberId\"];\n\n            if (string.IsNullOrEmpty(_whatsAppToken))\n                Console.WriteLine(\"‚ùå Token is NULL or EMPTY from config!\");\n\n            if (string.IsNullOrEmpty(_whatsAppPhoneId))\n                Console.WriteLine(\"‚ùå Phone ID is NULL or EMPTY from config!\");\n        }\n\n        public async Task<WhatsAppResult> SendMessageAsync(string recipientPhone, string messageText)\n        {\n            try\n            {\n                Console.WriteLine(\"üëâ Preparing to send WhatsApp message...\");\n                var url = $\"https://graph.facebook.com/v22.0/{_whatsAppPhoneId}/messages\";\n\n                var payload = new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = recipientPhone,\n                    type = \"text\",\n                    text = new { body = messageText }\n                };\n\n                var json = JsonSerializer.Serialize(payload);\n                var content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n                _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", _whatsAppToken);\n\n                var response = await _httpClient.PostAsync(url, content);\n                var responseBody = await response.Content.ReadAsStringAsync();\n\n                Console.WriteLine($\"‚úÖ Status: {response.StatusCode}\");\n                Console.WriteLine($\"üì• Response: {responseBody}\");\n\n                if (response.IsSuccessStatusCode)\n                {\n                    return new WhatsAppResult { Success = true, RawResponse = responseBody };\n                }\n                else\n                {\n                    return new WhatsAppResult\n                    {\n                        Success = false,\n                        ErrorMessage = $\"Meta API Error: {response.StatusCode}\",\n                        RawResponse = responseBody\n                    };\n                }\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Exception while sending:\");\n                Console.WriteLine(ex.Message);\n\n                return new WhatsAppResult\n                {\n                    Success = false,\n                    ErrorMessage = ex.Message\n                };\n            }\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/AutoMapperProfile.cs",
      "sha256": "0ba07b894bf8d3f5c191c050ba75cebe9b18dd77aa56b6a61dfb332f2ef09283",
      "language": "csharp",
      "size": 726,
      "content": "using AutoMapper;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Features.Tracking.DTOs;\nusing xbytechat.api.Features.Tracking.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Shared\n{\n    public class AutoMapperProfile : Profile\n    {\n        public AutoMapperProfile()\n        {\n            CreateMap<Contact, ContactDto>();\n            CreateMap<Campaign, CampaignDto>();\n            CreateMap<MessageLog, MessageLogDto>();\n            CreateMap<TrackingLog, TrackingLogDto>();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/BusinessControllerBase.cs",
      "sha256": "ae04266e74cbbdfb58a81d85d24db83b9151ebef9e42b000430e8853ac2aa32f",
      "language": "csharp",
      "size": 343,
      "content": "using System;\nusing Microsoft.AspNetCore.Mvc;\n\nnamespace xbytechat.api.Shared\n{\n    // Do NOT add [ApiController] here; keep it on concrete controllers.\n    public abstract class BusinessControllerBase : ControllerBase\n    {\n        protected Guid BusinessId => User.GetBusinessId();\n        protected Guid UserId => User.GetUserId();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/ClaimsBusinessDetails.cs",
      "sha256": "ca82819f1adccbb4aba7e1c45695088e409ce25f46c74c9ea05acf50800da63c",
      "language": "csharp",
      "size": 4379,
      "content": "using System;\nusing System.Linq;\nusing System.Security.Claims;\nusing Microsoft.AspNetCore.Http;\n\nnamespace xbytechat.api.Shared\n{\n    public static class ClaimsBusinessDetails\n    {\n        // ----- Existing behavior (strict) -----\n        public static Guid GetBusinessId(this ClaimsPrincipal user)\n        {\n            var businessIdClaim =\n                user.FindFirst(\"businessId\")?.Value ??\n                user.FindFirst(\"BusinessId\")?.Value;\n\n            if (string.IsNullOrEmpty(businessIdClaim) || !Guid.TryParse(businessIdClaim, out var businessId))\n                throw new UnauthorizedAccessException(\"Invalid or missing businessId in token.\");\n\n            return businessId;\n        }\n\n        // ‚úÖ NEW: Non-throwing claim read\n        public static Guid? TryGetBusinessIdFromClaims(this ClaimsPrincipal user)\n        {\n            var businessIdClaim =\n                user.FindFirst(\"businessId\")?.Value ??\n                user.FindFirst(\"BusinessId\")?.Value;\n\n            if (string.IsNullOrWhiteSpace(businessIdClaim)) return null;\n            if (!Guid.TryParse(businessIdClaim, out var businessId)) return null;\n            return businessId;\n        }\n\n        public static Guid GetUserId(this ClaimsPrincipal user)\n        {\n            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;\n            if (string.IsNullOrEmpty(userIdClaim) || !Guid.TryParse(userIdClaim, out var userId))\n                throw new UnauthorizedAccessException(\"Invalid or missing userId in token.\");\n            return userId;\n        }\n\n        // ‚úÖ NEW: Determine if caller is platform-role\n        public static bool IsPlatformRole(this ClaimsPrincipal user)\n        {\n            var role =\n                user.FindFirst(ClaimTypes.Role)?.Value ??\n                user.FindFirst(\"role\")?.Value ??\n                user.FindFirst(\"roles\")?.Value ??\n                \"\";\n\n            role = role.Trim().ToLowerInvariant();\n            return role is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n        }\n\n        // ‚úÖ NEW: Claim-first, fallback ONLY for platform roles\n        // Fallback sources:\n        // - Query: ?bizId=...\n        // - Header: X-Business-Id: ...\n        public static Guid ResolveBusinessId(this ClaimsPrincipal user, HttpContext http)\n        {\n            // 1) Prefer claim always\n            var claimBiz = user.TryGetBusinessIdFromClaims();\n            if (claimBiz.HasValue && claimBiz.Value != Guid.Empty)\n                return claimBiz.Value;\n\n            // 2) Only platform roles can fallback\n            if (!user.IsPlatformRole())\n                throw new UnauthorizedAccessException(\"Invalid or missing businessId in token.\");\n\n            // 3) Try query string (SignalR)\n            var qs = http?.Request?.Query[\"bizId\"].FirstOrDefault();\n            if (!string.IsNullOrWhiteSpace(qs) && Guid.TryParse(qs, out var qBiz) && qBiz != Guid.Empty)\n                return qBiz;\n\n            // 4) Try header (APIs)\n            var hdr = http?.Request?.Headers[\"X-Business-Id\"].FirstOrDefault();\n            if (!string.IsNullOrWhiteSpace(hdr) && Guid.TryParse(hdr, out var hBiz) && hBiz != Guid.Empty)\n                return hBiz;\n\n            // 5) Still missing => tell UI to select business\n            throw new UnauthorizedAccessException(\"Business context required. Please select a business.\");\n        }\n    }\n}\n\n\n//using System;\n//using System.Security.Claims;\n\n//namespace xbytechat.api.Shared\n//{\n//    public static class ClaimsBusinessDetails\n//    {\n//        public static Guid GetBusinessId(this ClaimsPrincipal user)\n//        {\n//            var businessIdClaim = user.FindFirst(\"businessId\")?.Value; // lowercase only!\n//            if (string.IsNullOrEmpty(businessIdClaim) || !Guid.TryParse(businessIdClaim, out var businessId))\n//                throw new UnauthorizedAccessException(\"Invalid or missing businessId in token.\");\n//            return businessId;\n//        }\n\n//        public static Guid GetUserId(this ClaimsPrincipal user)\n//        {\n//            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;\n//            if (string.IsNullOrEmpty(userIdClaim) || !Guid.TryParse(userIdClaim, out var userId))\n//                throw new UnauthorizedAccessException(\"Invalid or missing userId in token.\");\n//            return userId;\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Shared/ClaimsPrincipalExtensions.cs",
      "sha256": "aceea513e3338cb16f3558e4dea2d6cafd833f7786da41a6c718b9b2c7294670",
      "language": "csharp",
      "size": 90,
      "content": "namespace xbytechat.api.Shared\n{\n    public class ClaimsPrincipalExtensions\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/PaginatedRequest.cs",
      "sha256": "af6fceb743c7fcb6bbb984e08b2bb8e696a447e38e61b6fc85a7b9dd48a0fb04",
      "language": "csharp",
      "size": 363,
      "content": "namespace xbytechat.api.Shared\n{\n    public class PaginatedRequest\n    {\n        public int Page { get; set; } = 1;       // Page number (1-based)\n        public int PageSize { get; set; } = 10;  // Items per page\n\n        // Optional filter (can be extended later)\n        public string? Status { get; set; }\n        public string? Search { get; set; }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Shared/PaginatedResponse.cs",
      "sha256": "d59aca9b4129006df5c4ec39b4e6793672e9493f4581e7963b6c215465d1b113",
      "language": "csharp",
      "size": 296,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.Shared\n{\n    public class PaginatedResponse<T>\n    {\n        public List<T> Items { get; set; } = new();\n        public int TotalCount { get; set; }\n        public int Page { get; set; }\n        public int PageSize { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/TrackingUtils/DeviceHelper.cs",
      "sha256": "70ad5b3deb3b07358a3ce61a514b3a9c3f4bb78007752bd0f4106ef8a3f27b32",
      "language": "csharp",
      "size": 748,
      "content": "// File: Features/CTATracking/Utils/DeviceHelper.cs\n\nnamespace xbytechat.api.Shared.TrackingUtils\n{\n    public static class DeviceHelper\n    {\n        public static string GetDeviceType(string userAgent)\n        {\n            if (string.IsNullOrEmpty(userAgent)) return \"Unknown\";\n\n            userAgent = userAgent.ToLower();\n\n            if (userAgent.Contains(\"mobile\") || userAgent.Contains(\"android\") || userAgent.Contains(\"iphone\"))\n                return \"Mobile\";\n\n            if (userAgent.Contains(\"ipad\") || userAgent.Contains(\"tablet\"))\n                return \"Tablet\";\n\n            if (userAgent.Contains(\"windows\") || userAgent.Contains(\"macintosh\"))\n                return \"Desktop\";\n\n            return \"Unknown\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/TrackingUtils/GeoHelper.cs",
      "sha256": "359da4b5f8939751d00d9137b41774e466af302ccaf60e203c1b0f0827a9eafd",
      "language": "csharp",
      "size": 952,
      "content": "// File: Features/CTATracking/Utils/GeoHelper.cs\n\nusing System.Net.Http;\nusing System.Text.Json;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Shared.TrackingUtils\n{\n    public static class GeoHelper\n    {\n        public static async Task<string> GetCountryFromIP(string ipAddress)\n        {\n            try\n            {\n                if (string.IsNullOrWhiteSpace(ipAddress) || ipAddress == \"::1\")\n                    return \"Localhost\";\n\n                using var client = new HttpClient();\n                var response = await client.GetStringAsync($\"https://ipapi.co/{ipAddress}/json/\");\n\n                var doc = JsonDocument.Parse(response);\n                if (doc.RootElement.TryGetProperty(\"country_name\", out var countryProp))\n                    return countryProp.GetString() ?? \"Unknown\";\n            }\n            catch\n            {\n                // fallback\n            }\n\n            return \"Unknown\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/TrackingUtils/TrackingUrlBuilder.cs",
      "sha256": "d944abb54aa2863bcad184f9d8bbd42d683f5d0b0b07474ea3f26903e7cc13d5",
      "language": "csharp",
      "size": 1370,
      "content": "using System;\nusing System.Web;\n\nnamespace xbytechat.api.Shared.TrackingUtils\n{\n    public static class TrackingUrlBuilder\n    {\n        public static string BuildTrackingUrl(\n            Guid businessId,\n            string sourceType,\n            Guid sourceId,\n            string buttonText,\n            string redirectUrl,\n            Guid? messageId = null,\n            Guid? contactId = null,\n            string contactPhone = null,\n            string sessionId = null,\n            string threadId = null)\n        {\n            var query = HttpUtility.ParseQueryString(string.Empty);\n            query[\"src\"] = sourceType;\n            query[\"id\"] = sourceId.ToString();\n            query[\"btn\"] = buttonText;\n            query[\"to\"] = redirectUrl;\n            query[\"type\"] = buttonText;\n            if (messageId != null) query[\"msg\"] = messageId.ToString();\n            if (contactId != null) query[\"contact\"] = contactId.ToString();\n            if (!string.IsNullOrEmpty(contactPhone)) query[\"phone\"] = contactPhone;\n            if (!string.IsNullOrEmpty(sessionId)) query[\"session\"] = sessionId;\n            if (!string.IsNullOrEmpty(threadId)) query[\"thread\"] = threadId;\n\n            var baseUrl = Environment.GetEnvironmentVariable(\"API_BASE_URL\") ?? \"https://yourdomain.com\";\n            return $\"{baseUrl}/api/tracking/redirect?{query}\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Shared/utility/TemplateParameterHelper.cs",
      "sha256": "51753bdf8ce7b9964913d5a501bee92803cf58d23cc315def80b8c69561dfbe1",
      "language": "csharp",
      "size": 1252,
      "content": "using Newtonsoft.Json;\nusing System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Shared.utility\n{\n    public static class TemplateParameterHelper\n    {\n        // ‚úÖ Used when parsing stored JSON parameters\n        public static List<string> ParseTemplateParams(string? jsonString)\n        {\n            if (string.IsNullOrWhiteSpace(jsonString)) return new List<string>();\n            try\n            {\n                return JsonConvert.DeserializeObject<List<string>>(jsonString) ?? new List<string>();\n            }\n            catch\n            {\n                return new List<string>();\n            }\n        }\n\n        // ‚úÖ NEW: Fills {{1}}, {{2}} with parameter values\n        public static string FillPlaceholders(string template, List<string> parameters)\n        {\n            if (string.IsNullOrWhiteSpace(template) || parameters == null || parameters.Count == 0)\n                return template;\n\n            // Replace {{1}}, {{2}} ... with values\n            return Regex.Replace(template, @\"\\{\\{(\\d+)\\}\\}\", match =>\n            {\n                var index = int.Parse(match.Groups[1].Value) - 1;\n                return index >= 0 && index < parameters.Count ? parameters[index] : match.Value;\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Validators/MessageTypeValidator.cs",
      "sha256": "a9accea936700f5fa40d270dffc11079bdce7a4ede1f30f968b41436460b80b2",
      "language": "csharp",
      "size": 871,
      "content": "namespace xbytechat.api.Validators\n{\n    /// <summary>\n    /// Centralized validator for supported message types (text, image, template, etc.)\n    /// </summary>\n    public static class MessageTypeValidator\n    {\n        private static readonly HashSet<string> SupportedTypes = new()\n        {\n            \"text\", \"image\", \"template\"\n        };\n\n        /// <summary>\n        /// Checks whether a messageType is supported.\n        /// </summary>\n        public static bool IsValid(string? messageType)\n        {\n            return !string.IsNullOrWhiteSpace(messageType) &&\n                   SupportedTypes.Contains(messageType.ToLower());\n        }\n\n        /// <summary>\n        /// Returns all supported message types.\n        /// </summary>\n        public static IEnumerable<string> GetSupportedTypes()\n        {\n            return SupportedTypes;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/IMetaTemplateCatalogProvider.cs",
      "sha256": "86349422826b2dc4082100f836645a12e3ceea4ff94f60ce89ca253f1083e818",
      "language": "csharp",
      "size": 626,
      "content": "using System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public interface IMetaTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListMetaAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNameMetaAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/IPinnacleTemplateCatalogProvider.cs",
      "sha256": "2b217b52f24e7214b9794295352839f4472418921d0d17a57bf4f5e8ce9aaeff",
      "language": "csharp",
      "size": 638,
      "content": "using System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public interface IPinnacleTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListPinnacleAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNamePinnacleAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/ITemplateCatalogProvider.cs",
      "sha256": "c20ebfc19a7f6f0a37a9d5d1f0458ac22c9ea6c66f3a0b08d6f4132c0f90b513",
      "language": "csharp",
      "size": 670,
      "content": "using System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;      // TemplateCatalogItem\nusing xbytechat_api.WhatsAppSettings.Models;    // WhatsAppSettingEntity\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public interface ITemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNameAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/TemplateCatalogItem.cs",
      "sha256": "66c3b015d5dea2cf216f9b23fbcb1e7074d22d7850a79401cfbae44bf9a3677c",
      "language": "csharp",
      "size": 450,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public record TemplateCatalogItem(\n       string Name,\n       string Language,\n       string Body,\n       int PlaceholderCount,\n       bool HasImageHeader,\n       IReadOnlyList<ButtonMetadataDto> Buttons,\n       string Status,\n       string? Category,\n       string? ExternalId,\n       string RawJson,\n        string? SubCategory = null\n   );\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Common/Providers.cs",
      "sha256": "f28418126b45e299564664005d25a4c33d566f9deeb455d10358c28c54ccc6bc",
      "language": "csharp",
      "size": 801,
      "content": "namespace xbytechat.api.WhatsAppSettings.Common\n{\n    public static class Providers\n    {\n        public const string PINNACLE = \"PINNACLE\";\n        public const string META_CLOUD = \"META_CLOUD\";\n\n        public static string NormalizeToUpper(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return PINNACLE;\n            var s = raw.Trim().ToUpperInvariant();\n            return s switch\n            {\n                \"META\" => META_CLOUD,\n                \"META_CLOUD\" => META_CLOUD,\n                \"PINNACLE\" => PINNACLE,\n                _ => s // future providers just uppercase\n            };\n        }\n        public static bool IsValid(string? raw)\n        {\n            var s = NormalizeToUpper(raw);\n            return s == PINNACLE || s == META_CLOUD;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/TemplateMetaController.cs",
      "sha256": "989605668ac2858b4f7cd8064a8c8eeeafa800c2561df9484854f7c8f6923846",
      "language": "csharp",
      "size": 1630,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates/meta\")]\n    [Authorize]\n    public sealed class TemplateMetaController : ControllerBase\n    {\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n\n        public TemplateMetaController(IWhatsAppTemplateFetcherService fetcher)\n        {\n            _fetcher = fetcher;\n        }\n\n        \n        [HttpGet(\"list/{businessId:guid}\")]\n        public async Task<IActionResult> List(Guid businessId, [FromQuery] string? provider = null)\n        {\n            if (businessId == Guid.Empty) return BadRequest(new { message = \"Invalid businessId\" });\n            var list = await _fetcher.GetTemplatesMetaAsync(businessId, provider);\n            return Ok(list);\n        }\n\n        // GET /api/templates/meta/{businessId}/{templateName}?language=en_US&provider=META_CLOUD\n        [HttpGet(\"{businessId:guid}/{templateName}\")]\n        public async Task<IActionResult> One(Guid businessId, string templateName, [FromQuery] string? language = null, [FromQuery] string? provider = null)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(templateName))\n                return BadRequest(new { message = \"Invalid parameters\" });\n\n            var meta = await _fetcher.GetTemplateMetaAsync(businessId, templateName, language, provider);\n            if (meta is null) return NotFound();\n            return Ok(meta);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/TemplatePreviewController.cs",
      "sha256": "d8b530f953ecd1e5448fa763ad12dc25bbcf061b8cb7d599d4cad9a5da7f060f",
      "language": "csharp",
      "size": 1212,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates/preview\")]\n    [Authorize]\n    public sealed class TemplatePreviewController : ControllerBase\n    {\n        private readonly ITemplatePreviewService _svc;\n\n        public TemplatePreviewController(ITemplatePreviewService svc)\n        {\n            _svc = svc;\n        }\n\n        // POST /api/templates/preview/{businessId}\n        [HttpPost(\"{businessId:guid}\")]\n        public async Task<IActionResult> TemplatePreview([FromRoute] Guid businessId, [FromBody] TemplatePreviewRequestDto request)\n        {\n            if (businessId == Guid.Empty) return BadRequest(new { message = \"Invalid businessId\" });\n            if (request == null || string.IsNullOrWhiteSpace(request.TemplateName))\n                return BadRequest(new { message = \"TemplateName is required.\" });\n\n            var result = await _svc.PreviewAsync(businessId, request);\n            return Ok(result);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/TemplatesController.cs",
      "sha256": "326113017ff4cc48ce4edb976840560b5f3ef9d62cfafed7cdedfbe11964e2d7",
      "language": "csharp",
      "size": 19022,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.FileSystemGlobbing;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat_api.WhatsAppSettings.Services;\nnamespace xbytechat.api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates\")]\n    public class TemplatesController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly ITemplateSyncService _sync;\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n\n        public TemplatesController(AppDbContext db, ITemplateSyncService sync, IWhatsAppTemplateFetcherService fetcher)\n        { _db = db; _sync = sync; _fetcher = fetcher; }\n\n        [HttpGet(\"summary/{businessId:guid}\")]\n        [Authorize]\n        public async Task<IActionResult> Summary(Guid businessId)\n        {\n            var stats = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive)\n                .GroupBy(x => x.Status)\n                .Select(g => new { Status = g.Key, Count = g.Count() })\n                .ToListAsync();\n\n            var submittedTemplateNames = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId)\n                .Select(x => x.Name.ToLower())\n                .Distinct()\n                .ToListAsync();\n\n            var draftCount = await (\n                from d in _db.TemplateDrafts.AsNoTracking()\n                join v in _db.TemplateDraftVariants.AsNoTracking() \n                  on new { Did = d.Id, Lang = d.DefaultLanguage } equals new { Did = v.TemplateDraftId, Lang = v.Language } into g\n                from v in g.DefaultIfEmpty()\n                where d.BusinessId == businessId \n                   && d.SubmittedAt == null\n                   && !submittedTemplateNames.Contains(d.Key)\n                   // üóëÔ∏è Filter out \"empty\" drafts (Untitled + No Content)\n                   && (!d.Key.StartsWith(\"untitled_\") || (v != null && (!string.IsNullOrWhiteSpace(v.BodyText) || v.HeaderType != \"NONE\")))\n                select d.Id\n            ).CountAsync();\n\n            var libraryCount = await _db.TemplateLibraryItems\n                .AsNoTracking()\n                .CountAsync();\n\n            return Ok(new\n            {\n                success = true,\n                approved = stats.FirstOrDefault(s => s.Status == \"APPROVED\")?.Count ?? 0,\n                pending = stats.Where(s => s.Status == \"PENDING\" || s.Status == \"PENDING_APPROVAL\" || s.Status == \"PENDING_REVIEW\" || s.Status == \"IN_REVIEW\").Sum(s => s.Count),\n                rejected = stats.FirstOrDefault(s => s.Status == \"REJECTED\")?.Count ?? 0,\n                drafts = draftCount,\n                library = libraryCount\n            });\n        }\n\n        // Sync Templates\n        [HttpPost(\"sync/{businessId:guid}\")]\n        [Authorize]\n        public async Task<IActionResult> Sync(Guid businessId)\n        {\n            if (businessId == Guid.Empty)\n                return BadRequest(new { success = false, message = \"Invalid businessId\" });\n\n            // Button = always fetch and upsert (ignore TTL; do not deactivate)\n            var result = await _sync.SyncBusinessTemplatesAsync(\n                businessId,\n                force: true,onlyUpsert: true);\n\n            return Ok(new { success = true, result });\n        }\n\n        [HttpGet(\"{businessId:guid}\")]\n        [Authorize]\n        public async Task<IActionResult> List(\n            Guid businessId,\n            [FromQuery] string? q = null,\n            [FromQuery] string? status = \"APPROVED\",\n            [FromQuery] string? language = null,\n            [FromQuery] string? provider = null,\n            [FromQuery] string? category = null,\n            [FromQuery] string? media = null,\n            [FromQuery] int page = 1,\n            [FromQuery] int pageSize = 10,\n            [FromQuery] string sortKey = \"updatedAt\",\n            [FromQuery] string sortDir = \"desc\")\n        {\n            var query = _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(status) && !status.Equals(\"ALL\", StringComparison.OrdinalIgnoreCase))\n            {\n                var s = status.Trim().ToUpperInvariant();\n                if (s == \"PENDING\")\n                {\n                    query = query.Where(x => x.Status == \"PENDING\" || x.Status == \"PENDING_APPROVAL\" || x.Status == \"PENDING_REVIEW\" || x.Status == \"IN_REVIEW\");\n                }\n                else\n                {\n                    query = query.Where(x => x.Status == s);\n                }\n            }\n\n            if (!string.IsNullOrWhiteSpace(language))\n            {\n                var lang = language.Trim();\n                query = query.Where(x => x.LanguageCode == lang);\n            }\n\n            if (!string.IsNullOrWhiteSpace(provider))\n            {\n                var prov = provider.Trim().ToUpperInvariant();\n                query = query.Where(x => x.Provider == prov);\n            }\n\n            if (!string.IsNullOrWhiteSpace(category))\n            {\n                var cat = category.Trim().ToUpperInvariant();\n                query = query.Where(x => x.Category == cat);\n            }\n\n            // Media filter (header kind)\n            // Supported values: all|text|image|video|document|pdf\n            // Note: WhatsAppTemplate.HeaderKind is stored canonical lowercase (none/text/image/video/document/location).\n            if (!string.IsNullOrWhiteSpace(media) && !media.Equals(\"ALL\", StringComparison.OrdinalIgnoreCase))\n            {\n                var m = media.Trim().ToLowerInvariant();\n                if (m == \"pdf\") m = \"document\";\n\n                query = m switch\n                {\n                    \"image\" => query.Where(x => x.HeaderKind == \"image\"),\n                    \"video\" => query.Where(x => x.HeaderKind == \"video\"),\n                    \"document\" => query.Where(x => x.HeaderKind == \"document\"),\n                    \"text\" => query.Where(x => !x.RequiresMediaHeader && (x.HeaderKind == \"none\" || x.HeaderKind == \"text\")),\n                    _ => query\n                };\n            }\n\n            if (!string.IsNullOrWhiteSpace(q))\n            {\n                var term = q.Trim();\n                query = query.Where(x =>\n                    x.Name.Contains(term) ||\n                    (x.Body != null && x.Body.Contains(term)));\n            }\n\n            // Sorting\n            bool isAsc = sortDir?.ToLowerInvariant() == \"asc\";\n            var sortKeyLower = sortKey?.ToLowerInvariant();\n\n            query = sortKeyLower switch\n            {\n                \"name\" => isAsc ? query.OrderBy(x => x.Name) : query.OrderByDescending(x => x.Name),\n                \"category\" => isAsc ? query.OrderBy(x => x.Category) : query.OrderByDescending(x => x.Category),\n                \"language\" => isAsc ? query.OrderBy(x => x.LanguageCode) : query.OrderByDescending(x => x.LanguageCode),\n                \"status\" => isAsc ? query.OrderBy(x => x.Status) : query.OrderByDescending(x => x.Status),\n                \"createdat\" => isAsc ? query.OrderBy(x => x.CreatedAt) : query.OrderByDescending(x => x.CreatedAt),\n                \"updatedat\" => isAsc ? query.OrderBy(x => x.UpdatedAt) : query.OrderByDescending(x => x.UpdatedAt),\n                _ => query.OrderByDescending(x => x.UpdatedAt)\n            };\n\n            var totalCount = await query.CountAsync();\n            var items = await query\n                .Skip((page - 1) * pageSize)\n                .Take(pageSize)\n                .Select(x => new\n                {\n                    x.Name,\n                    x.LanguageCode,\n                    x.Status,\n                    x.Category,\n                    x.BodyPreview,\n                    BodyVarCount = x.BodyVarCount,\n                    x.HeaderKind,\n                    x.RequiresMediaHeader,\n                    x.CreatedAt,\n                    x.UrlButtons,\n                    x.UpdatedAt,\n                    x.LastSyncedAt\n                })\n                .ToListAsync();\n\n            return Ok(new\n            {\n                success = true,\n                templates = items,\n                totalCount,\n                page,\n                pageSize,\n                totalPages = (int)Math.Ceiling((double)totalCount / pageSize)\n            });\n        }\n\n\n        //[HttpGet(\"{businessId:guid}/{name}\")]\n        //[Authorize]\n\n\n        //public async Task<IActionResult> GetOne(Guid businessId, string name, [FromQuery] string? language = null)\n        //{\n        //    var tpl = await _db.WhatsAppTemplates\n        //        .AsNoTracking()\n        //        .FirstOrDefaultAsync(x =>\n        //            x.BusinessId == businessId\n        //            && x.Name == name\n        //            && (language == null || x.LanguageCode == language));\n\n        //    if (tpl == null) return NotFound();\n\n        //    // Prefer stored values; optionally refine via meta fetcher\n        //    string headerKind = (tpl.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n        //    bool requiresHeaderMediaUrl = tpl.RequiresMediaHeader\n        //                                  || headerKind is \"image\" or \"video\" or \"document\";\n\n        //    try\n        //    {\n        //        // If you still want live verification, keep this; otherwise you can remove the try/catch block\n        //        var meta = await _fetcher.GetTemplateMetaAsync(\n        //            businessId: businessId,\n        //            templateName: tpl.Name,\n        //            language: tpl.LanguageCode,\n        //            provider: null);\n\n        //        var ht = meta?.HeaderType?.Trim().ToUpperInvariant();\n        //        if (!string.IsNullOrEmpty(ht))\n        //        {\n        //            headerKind = ht switch\n        //            {\n        //                \"IMAGE\" => \"image\",\n        //                \"VIDEO\" => \"video\",\n        //                \"DOCUMENT\" => \"document\",\n        //                \"TEXT\" => \"text\",\n        //                _ => headerKind\n        //            };\n        //            requiresHeaderMediaUrl = headerKind is \"image\" or \"video\" or \"document\";\n        //        }\n        //    }\n        //    catch\n        //    {\n        //        // fall back to stored fields (already set above)\n        //    }\n\n        //    return Ok(new\n        //    {\n        //        tpl.Name,\n        //        tpl.LanguageCode,\n        //        tpl.Status,\n        //        tpl.Category,\n        //        tpl.Body,\n        //        BodyVarCount = tpl.BodyVarCount,   // <- replaces old PlaceholderCount\n        //        tpl.UrlButtons,\n        //        headerKind,\n        //        requiresHeaderMediaUrl\n        //    });\n        //}\n        [HttpGet(\"{businessId:guid}/{name}\")]\n        [Authorize]\n        public async Task<IActionResult> GetOne(Guid businessId, string name, [FromQuery] string? language = null)\n        {\n            var tpl = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Name == name &&\n                    (language == null || x.LanguageCode == language));\n\n            if (tpl == null) return NotFound();\n\n            // ‚Äî‚Äî‚Äî‚Äî‚Äî header info (keep your current behavior)\n            string headerKind = (tpl.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n            bool requiresHeaderMediaUrl = tpl.RequiresMediaHeader\n                                          || headerKind is \"image\" or \"video\" or \"document\";\n            try\n            {\n                var meta = await _fetcher.GetTemplateMetaAsync(\n                    businessId: businessId,\n                    templateName: tpl.Name,\n                    language: tpl.LanguageCode,\n                    provider: null);\n\n                var ht = meta?.HeaderType?.Trim().ToUpperInvariant();\n                if (!string.IsNullOrEmpty(ht))\n                {\n                    headerKind = ht switch\n                    {\n                        \"IMAGE\" => \"image\",\n                        \"VIDEO\" => \"video\",\n                        \"DOCUMENT\" => \"document\",\n                        \"TEXT\" => \"text\",\n                        _ => headerKind\n                    };\n                    requiresHeaderMediaUrl = headerKind is \"image\" or \"video\" or \"document\";\n                }\n            }\n            catch { /* fall back to stored */ }\n\n            // ‚Äî‚Äî‚Äî‚Äî‚Äî build a normalized buttons array from RawJson\n            var buttons = new List<object>();\n            try\n            {\n                // RawJson was saved during sync; shape matches provider response.\n                // We'll look for components[].type == \"BUTTONS\".\n                var root = Newtonsoft.Json.Linq.JObject.Parse(string.IsNullOrWhiteSpace(tpl.RawJson) ? \"{}\" : tpl.RawJson);\n                var components = root.SelectToken(\"components\") ?? root.SelectToken(\"data.components\") ?? root.SelectToken(\"template.components\");\n\n                if (components is Newtonsoft.Json.Linq.JArray arr)\n                {\n                    foreach (var c in arr)\n                    {\n                        var type = c?[\"type\"]?.ToString()?.ToUpperInvariant();\n                        if (type != \"BUTTONS\") continue;\n\n                        var btns = c[\"buttons\"] as Newtonsoft.Json.Linq.JArray;\n                        if (btns == null) continue;\n\n                        int idx = 0;\n                        foreach (var b in btns)\n                        {\n                            var btnType = b?[\"type\"]?.ToString()?.ToUpperInvariant() ?? \"\";\n                            var text = b?[\"text\"]?.ToString() ?? \"\";\n                            // default fields\n                            string subType = btnType switch\n                            {\n                                \"URL\" => \"url\",\n                                \"PHONE_NUMBER\" => \"voice_call\",\n                                \"QUICK_REPLY\" => \"quick_reply\",\n                                \"COPY_CODE\" => \"copy_code\",\n                                \"CATALOG\" => \"catalog\",\n                                \"FLOW\" => \"flow\",\n                                \"REMINDER\" => \"reminder\",\n                                \"ORDER_DETAILS\" => \"order_details\",\n                                _ => \"unknown\"\n                            };\n\n                            // capture param (for dynamic URL / phone / coupon / flow)\n                            string? param =\n                                b?[\"url\"]?.ToString()\n                                ?? b?[\"phone_number\"]?.ToString()\n                                ?? b?[\"coupon_code\"]?.ToString()\n                                ?? b?[\"flow_id\"]?.ToString();\n\n                            buttons.Add(new\n                            {\n                                text = text,\n                                type = btnType,        // original provider type (UPPERCASE)\n                                subType = subType,     // normalized (lowercase)\n                                index = (int?)(b?[\"index\"]?.ToObject<int?>() ?? idx),\n                                parameterValue = param // may be null for quick replies\n                            });\n\n                            idx++;\n                        }\n                    }\n                }\n            }\n            catch\n            {\n                // ignore parse errors; just return other fields\n            }\n\n            // Fallback: If Pending (optimistic) and no buttons found in RawJson, try to load from Draft\n            if (buttons.Count == 0 && (tpl.Status == \"PENDING\" || tpl.Status == \"PENDING_APPROVAL\" || tpl.Status == \"IN_REVIEW\"))\n            {\n               var draft = await _db.TemplateDrafts\n                   .AsNoTracking()\n                   .Where(d => d.BusinessId == businessId && d.Key == tpl.Name)\n                   .OrderByDescending(d => d.UpdatedAt)\n                   .FirstOrDefaultAsync();\n               \n               if (draft != null)\n               {\n                   var variant = await _db.TemplateDraftVariants\n                       .AsNoTracking()\n                       .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == tpl.LanguageCode);\n                       \n                   if (variant != null && !string.IsNullOrEmpty(variant.ButtonsJson))\n                   {\n                        try {\n                            var dtos = System.Text.Json.JsonSerializer.Deserialize<List<xbytechat.api.Features.TemplateModule.DTOs.ButtonDto>>(variant.ButtonsJson, new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web));\n                            if (dtos != null) \n                            {\n                                int idx = 0;\n                                foreach(var b in dtos) {\n                                     string subType = b.Type.ToUpperInvariant() switch\n                                    {\n                                        \"URL\" => \"url\",\n                                        \"PHONE\" => \"voice_call\",\n                                        \"PHONE_NUMBER\" => \"voice_call\",\n                                        \"QUICK_REPLY\" => \"quick_reply\",\n                                        \"COPY_CODE\" => \"copy_code\",\n                                        _ => \"unknown\"\n                                    };\n                                    \n                                    string? param = b.Url ?? b.Phone;\n\n                                    buttons.Add(new {\n                                        text = b.Text,\n                                        type = b.Type.ToUpperInvariant() == \"PHONE\" ? \"PHONE_NUMBER\" : b.Type.ToUpperInvariant(),\n                                        subType,\n                                        index = (int?)idx++,\n                                        parameterValue = param\n                                    });\n                                }\n                            }\n                        } catch {}\n                   }\n               }\n            }\n\n            return Ok(new\n            {\n                tpl.Name,\n                LanguageCode = tpl.LanguageCode,\n                tpl.Status,\n                tpl.Category,\n                Body = tpl.Body,\n                BodyVarCount = tpl.BodyVarCount, // new field you already use in List\n                UrlButtons = tpl.UrlButtons,     // keep legacy field (indexes of URL buttons)\n                headerKind,\n                requiresHeaderMediaUrl,\n                buttons                           // üëà NEW: full set including quick replies\n            });\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/WhatsAppNumbersController.cs",
      "sha256": "81acd60e9331bc4c7b0fb8b3cfdaea4dc1c4932811338b70e0f2fd174b2dca1f",
      "language": "csharp",
      "size": 6041,
      "content": "using System;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.Shared;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/whatsappsettings/{provider}/numbers\")]\n    public class WhatsAppNumbersController : ControllerBase\n    {\n        private readonly IWhatsAppPhoneNumberService _svc;\n        private readonly ILogger<WhatsAppNumbersController> _logger;\n\n        public WhatsAppNumbersController(\n            IWhatsAppPhoneNumberService svc,\n            ILogger<WhatsAppNumbersController> logger)\n        {\n            _svc = svc;\n            _logger = logger;\n        }\n\n        // Helper to resolve BusinessId from claims/header/query (adjust to your auth)\n        private bool TryGetBusinessId(out Guid businessId)\n        {\n            businessId = Guid.Empty;\n\n            // 1) Claim (preferred)\n            var claim = User?.FindFirst(\"BusinessId\") ?? User?.FindFirst(\"businessId\");\n            if (claim != null && Guid.TryParse(claim.Value, out businessId))\n                return true;\n\n            // 2) Header fallback\n            if (Request.Headers.TryGetValue(\"X-Business-Id\", out var h)\n                && Guid.TryParse(h.ToString(), out businessId))\n                return true;\n\n            // 3) Query fallback\n            if (Guid.TryParse(HttpContext.Request.Query[\"businessId\"], out businessId))\n                return true;\n\n            return false;\n        }\n\n        // GET /api/whatsappsettings/{provider}/numbers\n        [HttpGet]\n        [ProducesResponseType(StatusCodes.Status200OK)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n        public async Task<IActionResult> List([FromRoute] string provider)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var items = await _svc.ListAsync(businessId, provider);\n            return Ok(items);\n        }\n\n        public sealed class UpsertRequest\n        {\n            public string PhoneNumberId { get; set; } = null!;\n            public string WhatsAppBusinessNumber { get; set; } = null!;\n            public string? SenderDisplayName { get; set; }\n            public bool? IsActive { get; set; }\n            public bool? IsDefault { get; set; }\n        }\n\n        // POST /api/whatsappsettings/{provider}/numbers\n        [HttpPost(\"\")]\n        [ProducesResponseType(typeof(WhatsAppPhoneNumber), StatusCodes.Status200OK)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n       // [HttpPost(\"\")]\n        public async Task<IActionResult> Upsert([FromRoute] string provider, [FromBody] UpsertRequest req)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            if (string.IsNullOrWhiteSpace(req.PhoneNumberId))\n                return BadRequest(\"phoneNumberId is required.\");\n            if (string.IsNullOrWhiteSpace(req.WhatsAppBusinessNumber))\n                return BadRequest(\"whatsAppBusinessNumber is required.\");\n\n            try\n            {\n                var saved = await _svc.UpsertAsync(\n                    businessId,\n                    provider, // service normalizes\n                    req.PhoneNumberId,\n                    req.WhatsAppBusinessNumber,\n                    req.SenderDisplayName,\n                    req.IsActive,\n                    req.IsDefault\n                );\n                return Ok(saved);\n            }\n            catch (InvalidOperationException ex) when (ex.InnerException is Npgsql.NpgsqlException npg)\n            {\n                // Bubble up constraint codes if useful\n                // 23505 unique_violation, 23503 foreign_key_violation, 23502 not_null_violation\n                return StatusCode(StatusCodes.Status409Conflict, new\n                {\n                    statusCode = 409,\n                    code = npg.SqlState,\n                    message = ex.Message\n                });\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(StatusCodes.Status500InternalServerError, new\n                {\n                    statusCode = 500,\n                    message = ex.Message\n                });\n            }\n        }\n\n        // DELETE /api/whatsappsettings/{provider}/numbers/{id}\n        [HttpDelete(\"{id:guid}\")]\n        [ProducesResponseType(StatusCodes.Status204NoContent)]\n        [ProducesResponseType(StatusCodes.Status404NotFound)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n        public async Task<IActionResult> Delete([FromRoute] string provider, [FromRoute] Guid id)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var ok = await _svc.DeleteAsync(businessId, provider, id);\n            if (!ok) return NotFound();\n\n            return NoContent();\n        }\n\n        // PATCH /api/whatsappsettings/{provider}/numbers/{id}/default\n        [HttpPatch(\"{id:guid}/default\")]\n        [ProducesResponseType(StatusCodes.Status204NoContent)]\n        [ProducesResponseType(StatusCodes.Status404NotFound)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n        public async Task<IActionResult> SetDefault([FromRoute] string provider, [FromRoute] Guid id)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var ok = await _svc.SetDefaultAsync(businessId, provider, id);\n            if (!ok) return NotFound();\n\n            return NoContent();\n        }\n\n       \n   \n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/WhatsAppSettingsController.cs",
      "sha256": "3b095e28c513b35d74d5e413e74b84f4cd6165dddf6d2fe6d576bc1eb78e19f0",
      "language": "csharp",
      "size": 19931,
      "content": "// üìÑ File: WhatsAppSettings/Controllers/WhatsAppSettingsController.cs\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat.api.Shared; // for User.GetBusinessId()\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat_api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class WhatsAppSettingsController : ControllerBase\n    {\n        private readonly IWhatsAppSettingsService _svc;\n        private readonly ILogger<WhatsAppSettingsController> _logger;\n        private readonly IWhatsAppSenderService _whatsAppSenderService;\n       \n        public WhatsAppSettingsController(\n            IWhatsAppSettingsService svc,\n            ILogger<WhatsAppSettingsController> logger, IWhatsAppSenderService whatsAppSenderService)\n        {\n            _svc = svc;\n            _logger = logger;\n            _whatsAppSenderService = whatsAppSenderService;\n\n        }\n\n \n        [HttpPut(\"update\")]\n        public async Task<IActionResult> UpdateSetting([FromBody] SaveWhatsAppSettingDto dto)\n        {\n            if (!ModelState.IsValid)\n                return BadRequest(new { message = \"Invalid input.\", errors = ModelState });\n\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); dto.BusinessId = businessId; }\n            catch { return Unauthorized(new { message = \"BusinessId missing or invalid in token.\" }); }\n\n            try\n            {\n                await _svc.SaveOrUpdateSettingAsync(dto);\n                return Ok(new { message = \"Settings saved/updated.\" });\n            }\n            catch (InvalidOperationException ex)\n            {\n                return BadRequest(new { message = ex.Message });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to update WhatsApp settings.\");\n                return StatusCode(500, new { message = \"An error occurred while saving settings.\", details = ex.Message });\n            }\n        }\n\n        // ----------------------------\n        // Get the current user's saved settings\n        // ----------------------------\n        //[HttpGet(\"me\")]\n        //public async Task<IActionResult> GetMySettings()\n        //{\n        //    var businessId = User.GetBusinessId();\n        //    var setting = await _svc.GetSettingsByBusinessIdAsync(businessId);\n        //    if (setting == null)\n        //        return NotFound(new { message = \"‚ùå WhatsApp settings not found.\" });\n\n        //    return Ok(setting);\n        //}\n        [HttpGet(\"me\")]\n        public async Task<IActionResult> GetMySettings()\n        {\n            var businessId = User.GetBusinessId();\n            var setting = await _svc.GetSettingsByBusinessIdAsync(businessId);\n\n            if (setting == null)\n            {\n                // Expected: user simply hasn't configured settings yet\n                return Ok(new\n                {\n                    ok = true,\n                    hasSettings = false,\n                    data = (object?)null\n                });\n            }\n\n            return Ok(new\n            {\n                ok = true,\n                hasSettings = true,\n                data = setting\n            });\n        }\n\n        // ----------------------------\n        // Test connection using values sent in the body (not necessarily saved)\n        // Accepts Provider = \"Pinnacle\" or \"Meta_cloud\"\n        // ----------------------------\n        [HttpPost(\"test-connection\")]\n        public async Task<IActionResult> TestConnection([FromBody] SaveWhatsAppSettingDto dto)\n        {\n            if (dto is null)\n                return BadRequest(new { message = \"‚ùå Missing request body.\" });\n\n            var provider = NormalizeProvider(dto.Provider);\n            if (provider is null)\n                return BadRequest(new { message = \"‚ùå Provider is required (Pinnacle | Meta_cloud).\" });\n\n            dto.Provider = provider; // use canonical\n\n            // Minimal provider-specific validation (service will validate again)\n            if (provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiUrl) ||\n                    string.IsNullOrWhiteSpace(dto.ApiKey) ||\n                    string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n                {\n                    return BadRequest(new { message = \"‚ùå API URL, Token and Phone Number ID are required for Meta Cloud test.\" });\n                }\n            }\n            else if (provider == \"PINNACLE\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiUrl) ||\n                    string.IsNullOrWhiteSpace(dto.ApiKey) ||\n                    (string.IsNullOrWhiteSpace(dto.WabaId) && string.IsNullOrWhiteSpace(dto.PhoneNumberId)) ||\n                    string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n                {\n                    return BadRequest(new\n                    {\n                        message = \"‚ùå API URL, API Key, (WABA ID or Phone Number ID), and Business Number are required for Pinnacle test.\"\n                    });\n                }\n            }\n\n            try\n            {\n                var message = await _svc.TestConnectionAsync(dto);\n\n                // Convention: service returns a human string; we 200 on success (starts with ‚úÖ), 400 otherwise\n                if (!string.IsNullOrEmpty(message) && message.StartsWith(\"‚úÖ\"))\n                    return Ok(new { message });\n\n                return BadRequest(new { message = string.IsNullOrEmpty(message) ? \"‚ùå Test failed.\" : message });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå [TestConnection] Failed\");\n                return StatusCode(500, new { message = \"‚ùå Test connection failed.\", details = ex.Message });\n            }\n        }\n\n\n        [HttpPost(\"test-connection/current\")]\n        public async Task<IActionResult> TestConnectionCurrent()\n        {\n            // ---- local helpers (scoped only to this action) ----\n            static string? NormalizeProvider(string? raw)\n            {\n                if (string.IsNullOrWhiteSpace(raw)) return null;\n                var s = raw.Trim().ToLowerInvariant().Replace(\"-\", \"_\").Replace(\" \", \"_\");\n                if (s is \"meta_cloud\" or \"meta\" or \"wa_cloud\" or \"facebook\" or \"whatsapp_cloud\")\n                    return \"META_CLOUD\";\n                if (s is \"pinnacle\" or \"pinnacle_official\" or \"pinbot\")\n                    return \"PINNACLE\";\n                return null; // unknown ‚Üí keep original\n            }\n\n            static string NormalizeApiUrl(string? apiUrl, string? provider)\n            {\n                if (string.Equals(provider, \"META_CLOUD\", StringComparison.Ordinal))\n                    return string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n                return string.IsNullOrWhiteSpace(apiUrl) ? string.Empty : apiUrl.Trim();\n            }\n\n            static string? T(string? s) => string.IsNullOrWhiteSpace(s) ? null : s.Trim();\n            // ---- /helpers ----\n\n            var businessId = User.GetBusinessId();\n\n            // Pulls merged settings + number from WhatsAppPhoneNumbers via your service\n            var saved = await _svc.GetSettingsByBusinessIdAsync(businessId); // returns WhatsAppSettingsDto\n            if (saved is null)\n                return NotFound(new { message = \"‚ùå No saved WhatsApp settings found.\" });\n\n            // defensive normalization (safe even if FE already sends uppercase)\n            var provider = NormalizeProvider(saved.Provider) ?? saved.Provider?.Trim().ToUpperInvariant();\n            var apiUrl = NormalizeApiUrl(saved.ApiUrl, provider);\n            var apiKey = T(saved.ApiKey);\n            var phoneId = T(saved.PhoneNumberId);\n            var wabaId = T(saved.WabaId);\n\n            var dto = new SaveWhatsAppSettingDto\n            {\n                BusinessId = businessId,\n                Provider = provider ?? saved.Provider, // keep original if we couldn't map\n                ApiUrl = apiUrl,\n                ApiKey = apiKey,\n                PhoneNumberId = phoneId, // comes from WhatsAppPhoneNumbers via DTO\n                WabaId = wabaId,\n                WhatsAppBusinessNumber = T(saved.WhatsAppBusinessNumber), // from WhatsAppPhoneNumbers\n                SenderDisplayName = null, // not used in test; include if your DTO needs it\n                WebhookSecret = null,     // ^\n                WebhookVerifyToken = null,\n                IsActive = true           // test against the active config\n            };\n\n            // Provider-specific guardrails (fail early with clear messages)\n            if (dto.Provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrEmpty(dto.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Meta access token (ApiKey).\" });\n                if (string.IsNullOrEmpty(dto.PhoneNumberId))\n                    return BadRequest(new { message = \"‚ùå Missing Meta PhoneNumberId (required for messaging endpoint tests).\" });\n                // apiUrl defaulted above if empty\n            }\n            else if (dto.Provider == \"PINNACLE\")\n            {\n                if (string.IsNullOrEmpty(dto.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API key.\" });\n                if (string.IsNullOrEmpty(dto.ApiUrl))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API URL.\" });\n                // WABA/PhoneNumberId may be optional for some Pinnacle routes; your _svc.TestConnectionAsync knows best.\n            }\n            else\n            {\n                return BadRequest(new { message = $\"‚ùå Unsupported provider: {dto.Provider}\" });\n            }\n\n            try\n            {\n                var message = await _svc.TestConnectionAsync(dto);\n\n                if (!string.IsNullOrEmpty(message) && message.StartsWith(\"‚úÖ\"))\n                    return Ok(new { message });\n\n                return BadRequest(new { message = string.IsNullOrEmpty(message) ? \"‚ùå Test failed.\" : message });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå [TestConnectionCurrent] Failed\");\n                return StatusCode(500, new { message = \"‚ùå Test connection failed.\", details = ex.Message });\n            }\n        }\n\n        [HttpDelete(\"delete\")]\n        public async Task<IActionResult> DeleteSetting()\n        {\n            var businessId = User.GetBusinessId();\n            var deleted = await _svc.DeleteSettingsAsync(businessId);\n            if (!deleted) return NotFound(new { message = \"‚ùå No WhatsApp settings found to delete.\" });\n            return Ok(new { message = \"üóëÔ∏è WhatsApp settings deleted successfully.\" });\n        }\n\n        // Optional alias for FE routes that call /delete-current\n        [HttpDelete(\"delete-current\")]\n        public Task<IActionResult> DeleteSettingAlias() => DeleteSetting();\n\n        private static string? NormalizeProvider(string? providerRaw)\n        {\n            if (string.IsNullOrWhiteSpace(providerRaw)) return null;\n\n            var p = providerRaw.Trim();\n\n            // Accept canonical values exactly and a few common variants\n            if (string.Equals(p, \"Pinnacle\", StringComparison.Ordinal)) return \"Pinnacle\";\n            if (string.Equals(p, \"Meta_cloud\", StringComparison.Ordinal)) return \"Meta_cloud\";\n\n            // tolerate some user/legacy variants from older UIs\n            var lower = p.ToLowerInvariant();\n            if (lower is \"pinbot\" or \"pinnacle (official)\" or \"pinnacle (pinnacle)\" or \"pinnacle official\")\n                return \"Pinnacle\";\n            if (lower is \"meta cloud\" or \"meta\" or \"meta-cloud\")\n                return \"Meta_cloud\";\n\n            return null;\n        }\n\n        [HttpGet(\"callback-url\")]\n        public async Task<IActionResult> GetMyCallbackUrl([FromServices] IConfiguration cfg)\n        {\n            var businessId = User.GetBusinessId();\n            var baseUrl = cfg[\"App:PublicBaseUrl\"] ?? string.Empty;\n            var url = await _svc.GetCallbackUrlAsync(businessId, baseUrl);\n            return Ok(new { callbackUrl = url });\n        }\n\n        [HttpGet(\"all\")]\n        public async Task<IActionResult> GetAllForBusinessAsync([FromServices] IWhatsAppSettingsService settingsService)\n        {\n            // Resolve BusinessId from claim/header/query (same pattern used elsewhere)\n            if (!TryResolveBusinessId(HttpContext, User, out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var items = await settingsService.GetAllForBusinessAsync(businessId);\n            return Ok(items);\n        }\n\n        // local helper (add once in this controller if you don‚Äôt already have it)\n        private static bool TryResolveBusinessId(HttpContext ctx, ClaimsPrincipal user, out Guid businessId)\n        {\n            businessId = Guid.Empty;\n\n            var claim = user?.FindFirst(\"BusinessId\") ?? user?.FindFirst(\"businessId\");\n            if (claim != null && Guid.TryParse(claim.Value, out businessId))\n                return true;\n\n            if (ctx.Request.Headers.TryGetValue(\"X-Business-Id\", out var h)\n                && Guid.TryParse(h.ToString(), out businessId))\n                return true;\n\n            if (Guid.TryParse(ctx.Request.Query[\"businessId\"], out businessId))\n                return true;\n\n            return false;\n        }\n\n        // GET /api/whatsapp/senders/{businessId}\n        [HttpGet(\"senders/{businessId:guid}\")]     // <-- align action path\n        public async Task<IActionResult> GetSenders(Guid businessId)\n        {\n            if (businessId == Guid.Empty)\n                return BadRequest(new { message = \"Invalid businessId.\" });\n\n            var items = await _whatsAppSenderService.GetBusinessSendersAsync(businessId);\n            return Ok(items);\n        }\n\n\n       \n        [HttpPost(\"fetch-numbers\")]\n        public async Task<IActionResult> FetchNumbers([FromServices] IWhatsAppPhoneNumberService phoneSvc,\n           [FromServices] IWhatsAppSettingsService settingsSvc,\n              CancellationToken ct = default)\n        {\n            // --- helpers ---\n            static string? NormalizeProvider(string? raw)\n            {\n                if (string.IsNullOrWhiteSpace(raw)) return null;\n                var s = raw.Trim().ToLowerInvariant().Replace(\"-\", \"_\").Replace(\" \", \"_\");\n                if (s is \"meta_cloud\" or \"meta\" or \"wa_cloud\" or \"facebook\" or \"whatsapp_cloud\")\n                    return \"META_CLOUD\";\n                if (s is \"pinnacle\" or \"pinnacle_official\" or \"pinbot\")\n                    return \"PINNACLE\";\n                return null;\n            }\n            static string NormalizeApiUrl(string? apiUrl, string? provider)\n            {\n                if (string.Equals(provider, \"META_CLOUD\", StringComparison.Ordinal))\n                    return string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n                return string.IsNullOrWhiteSpace(apiUrl) ? string.Empty : apiUrl.Trim();\n            }\n            static string? T(string? s) => string.IsNullOrWhiteSpace(s) ? null : s.Trim();\n            // ---------------\n\n            var businessId = User.GetBusinessId();\n\n            // Pull merged settings (includes PhoneNumberId/WhatsAppBusinessNumber from WhatsAppPhoneNumbers)\n            var saved = await settingsSvc.GetSettingsByBusinessIdAsync(businessId); // returns WhatsAppSettingsDto\n            if (saved is null)\n                return BadRequest(new { message = \"‚ùå No saved WhatsApp settings found.\" });\n\n            // Normalize provider/apiUrl defensively\n            var provider = NormalizeProvider(saved.Provider) ?? saved.Provider?.Trim().ToUpperInvariant();\n            if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n                return BadRequest(new { message = $\"‚ùå Unsupported provider: {saved.Provider}\" });\n\n            var normalized = new WhatsAppSettingsDto\n            {\n                BusinessId = saved.BusinessId,\n                Provider = provider!,\n                ApiUrl = NormalizeApiUrl(saved.ApiUrl, provider),\n                ApiKey = T(saved.ApiKey),\n                WabaId = T(saved.WabaId),\n                PhoneNumberId = T(saved.PhoneNumberId),                 // current default (may be null)\n                WhatsAppBusinessNumber = T(saved.WhatsAppBusinessNumber)\n            };\n\n            // Guardrails (clear, early, provider-specific)\n            if (provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrWhiteSpace(normalized.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Meta access token (ApiKey).\" });\n                if (string.IsNullOrWhiteSpace(normalized.WabaId))\n                    return BadRequest(new { message = \"‚ùå WABA ID is required to fetch numbers from Meta Cloud.\" });\n            }\n            else // PINNACLE\n            {\n                if (string.IsNullOrWhiteSpace(normalized.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API key.\" });\n                if (string.IsNullOrWhiteSpace(normalized.ApiUrl))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API URL.\" });\n                if (string.IsNullOrWhiteSpace(normalized.WabaId) && string.IsNullOrWhiteSpace(normalized.PhoneNumberId))\n                    return BadRequest(new { message = \"‚ùå WABA ID or PhoneNumberId required to fetch numbers from Pinnacle.\" });\n            }\n\n            // Sync/ingest numbers from the provider into WhatsAppPhoneNumbers table\n            var result = await phoneSvc.SyncFromProviderAsync(businessId, normalized, provider!, ct);\n\n            return Ok(new\n            {\n                success = true,\n                added = result.Added,\n                updated = result.Updated,\n                total = result.Total,\n                provider = provider\n            });\n        }\n\n\n\n\n\n        // --------------------------------------------------\n        // Connection Summary (Health)\n        // --------------------------------------------------\n        [HttpGet(\"connection-summary\")]\n        public async Task<IActionResult> GetConnectionSummary()\n        {\n            var businessId = User.GetBusinessId();\n            var summary = await _svc.GetConnectionSummaryAsync(businessId);\n            \n            // It's okay to return null or empty object if not connected yet\n            return Ok(new { success = true, data = summary });\n        }\n\n        [HttpPost(\"connection-summary/refresh\")]\n        public async Task<IActionResult> RefreshConnectionSummary()\n        {\n            var businessId = User.GetBusinessId();\n            try\n            {\n                var summary = await _svc.RefreshConnectionSummaryAsync(businessId);\n                return Ok(new { success = true, data = summary });\n            }\n            catch (InvalidOperationException ex)\n            {\n                return BadRequest(new { success = false, message = ex.Message });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to refresh connection summary for Business {BusinessId}\", businessId);\n                return StatusCode(500, new { success = false, message = \"Failed to refresh from Meta.\", details = ex.Message });\n            }\n        }\n\n    }\n}\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/WhatsAppTemplateFetcherController.cs",
      "sha256": "423175eb5cd31766ee4c3fe215cb17108c3cf6bc44948fc0f52a88e8a000ad39",
      "language": "csharp",
      "size": 3072,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat_api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class WhatsAppTemplateFetcherController : ControllerBase\n    {\n        private readonly IWhatsAppTemplateFetcherService _templateFetcherService;\n\n        public WhatsAppTemplateFetcherController(IWhatsAppTemplateFetcherService templateFetcherService)\n        {\n            _templateFetcherService = templateFetcherService;\n        }\n\n        [HttpGet(\"get-template/{businessId}\")]\n        [Authorize] // ‚úÖ Optional: Require authentication if your project uses JWT auth\n        public async Task<IActionResult> FetchTemplates(Guid businessId)\n        {\n            if (businessId == Guid.Empty)\n                return BadRequest(new { message = \"‚ùå Invalid BusinessId.\" });\n\n            var templates = await _templateFetcherService.FetchTemplatesAsync(businessId); // comment this line to stop fetch template as per businessid\n            //var templates = await _templateFetcherService.FetchAllTemplatesAsync(); // comment this line to stop fetch template as per businessid\n\n            return Ok(new\n            {\n                success = true,\n                templates = templates\n            });\n        }\n\n      \n\n        [HttpGet(\"get-template-all\")]\n        public async Task<IActionResult> GetAllTemplatesAsync()\n        {\n            try\n            {\n                var templates = await _templateFetcherService.FetchAllTemplatesAsync();\n                return Ok(new { success = true, templates });\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, new\n                {\n                    success = false,\n                    message = \"Error fetching templates\",\n                    detail = ex.Message\n                });\n            }\n        }\n\n        [HttpGet(\"get-template-by-name\")]\n        public async Task<IActionResult> GetTemplateByName([FromQuery] string name)\n        {\n            var businessId = Guid.Parse(User.FindFirst(\"businessId\")?.Value);\n            var template = await _templateFetcherService.GetTemplateByNameAsync(businessId, name, true);\n            return template == null ? NotFound() : Ok(template);\n        }\n        [HttpGet(\"get-by-name/{businessId}/{templateName}\")]\n        public async Task<IActionResult> GetByName(Guid businessId, string templateName, [FromQuery] bool includeButtons = true)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(templateName))\n                return BadRequest(new { success = false, message = \"‚ùå Missing or invalid parameters.\" });\n\n            var template = await _templateFetcherService.GetTemplateByNameAsync(businessId, templateName, includeButtons);\n\n            if (template == null)\n                return NotFound();\n\n            return Ok(new\n            {\n                success = true,\n                template\n            });\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/ButtonMetadataDto.cs",
      "sha256": "55b2b89dbf3f8b8f16bb134711c23334c37a60c9543a1ea34325fb89506a6dce",
      "language": "csharp",
      "size": 536,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class ButtonMetadataDto\n    {\n        public string Type { get; set; } // Example: \"URL\" or \"PHONE_NUMBER\"\n        public string Text { get; set; } // Button Text\n        public string SubType { get; set; } // (optional) for URL, Phone Number etc\n        public int Index { get; set; } // Index like 0, 1\n                                       // Optional: dynamic parameter value for validation\n        public string? ParameterValue { get; set; } // e.g. coupon_code\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/SaveWhatsAppSettingDto.cs",
      "sha256": "9c7ba8be0ccb6695a19a15e08fa4ef3542ae0978f21c1129b75fb4975cf74a32",
      "language": "csharp",
      "size": 1324,
      "content": "// üìÑ File: WhatsAppSettings/DTOs/SaveWhatsAppSettingDto.cs\nusing System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat_api.WhatsAppSettings.DTOs\n{\n    public class SaveWhatsAppSettingDto\n    {\n        public Guid BusinessId { get; set; }\n\n        // Which provider: \"pinnacle\" | \"meta_cloud\"\n        [Required, MaxLength(50)]\n        public string Provider { get; set; } = string.Empty;\n\n        [Required, MaxLength(500)]\n        public string ApiUrl { get; set; } = string.Empty;\n\n        [MaxLength(1000)]\n        public string? ApiKey { get; set; } // Pinnacle\n\n      \n        [MaxLength(100)]\n        public string? PhoneNumberId { get; set; } // Meta Cloud\n\n        [MaxLength(100)]\n        public string? WabaId { get; set; } // Optional (Pinnacle/Meta)\n\n        [MaxLength(50)]\n        public string? WhatsAppBusinessNumber { get; set; }\n\n        [MaxLength(100)]\n        public string? SenderDisplayName { get; set; }\n\n        [MaxLength(200)]\n        public string? WebhookSecret { get; set; }\n\n        [MaxLength(200)]\n        public string? WebhookVerifyToken { get; set; }\n\n        // üëá NEW: per-provider callback URL (optional, stored in DB)\n        [MaxLength(1000)]\n        public string? WebhookCallbackUrl { get; set; }\n\n        public bool IsActive { get; set; } = true;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateCatalogItem.cs",
      "sha256": "54c972f09c8bcba9a6e5138aa436898303927539032d8fe46cab52a7f283f3b4",
      "language": "csharp",
      "size": 567,
      "content": "// xbytechat.api/WhatsAppSettings/DTOs/TemplateCatalogItem.cs\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n   \n\n \n    public sealed record TemplateButtonMetadataDto\n    {\n        public string Text { get; init; } = \"\";\n        public string Type { get; init; } = \"\";     // META raw: URL / QUICK_REPLY / PHONE_NUMBER / ...\n        public string SubType { get; init; } = \"\";  // url / quick_reply / voice_call / ...\n        public int Index { get; init; }             // position in the button list\n        public string ParameterValue { get; init; } = \"\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateForUIResponseDto.cs",
      "sha256": "954d4bddaa8450da19f714aec8f819d5affa5edcee6a6e078759e3bcb04b47be",
      "language": "csharp",
      "size": 427,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class TemplateForUIResponseDto\n    {\n        public string Name { get; set; } = \"\";\n        public string Language { get; set; } = \"en_US\";\n        public string Body { get; set; } = \"\";\n        public int ParametersCount { get; set; }\n        public bool HasImageHeader { get; set; }\n        public List<ButtonMetadataDto> ButtonParams { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateMetadataDto.cs",
      "sha256": "154918abf3d7b2efa65ebcef2084ae33404f5eab44188b98d9e05a554462a4d6",
      "language": "csharp",
      "size": 968,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    /// <summary>\n    /// DTO representing a simplified view of WhatsApp template metadata.\n    /// </summary>\n    public class TemplateMetadataDto\n    {\n        /// Unique name of the template.\n        public string Name { get; set; } = string.Empty;\n\n        /// Language code used when creating the template (e.g., en_US, hi_IN).\n        public string Language { get; set; } = \"en_US\";\n\n        /// The message body content with placeholders (e.g., \"Hi {{1}}, your order is ready\").\n        public string Body { get; set; } = string.Empty;\n\n        /// Number of dynamic parameters required (e.g., 2 for {{1}} and {{2}}).\n        public int PlaceholderCount { get; set; }\n\n        public List<ButtonMetadataDto> ButtonParams { get; set; } = new List<ButtonMetadataDto>(); // ‚úÖ Added Buttons\n        public bool HasImageHeader { get; set; } = true;\n\n        public string HeaderKind { get; set; } = \"none\";\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateMetaDto.cs",
      "sha256": "2806aa041b83e7e1ef645c67f18f7d455aac9bdd1fcce9c4538b76786132c9ff",
      "language": "csharp",
      "size": 1516,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    // Normalized snapshot of a provider template for FE + snapshots\n    public sealed class TemplateMetaDto\n    {\n        public string Provider { get; set; } = \"\";     // \"META_CLOUD\" | \"PINNACLE\"\n        public string TemplateId { get; set; } = \"\";   // provider‚Äôs id if you store it\n        public string TemplateName { get; set; } = \"\";\n        public string Language { get; set; } = \"\";     // e.g., \"en_US\"\n\n        public bool HasHeaderMedia { get; set; }\n        public string? HeaderType { get; set; }        // \"IMAGE\" | \"VIDEO\" | \"DOCUMENT\" (future)\n\n        // 1-based placeholder slots for BODY\n        public List<PlaceholderSlot> BodyPlaceholders { get; set; } = new();\n\n        // Up to 3 buttons in template order\n        public List<TemplateButtonMeta> Buttons { get; set; } = new();\n\n    }\n\n    public sealed class TemplateButtonMeta\n    {\n        // Provider-level type (e.g., \"URL\", \"PHONE_NUMBER\", \"QUICK_REPLY\")\n        public string Type { get; set; } = \"\";\n        public string Text { get; set; } = \"\";         // label\n        public string? Value { get; set; }             // ParameterValue from provider (may contain \"{{1}}\")\n        public int Order { get; set; }                 // 0..2\n    }\n\n    public sealed class PlaceholderSlot\n    {\n        public int Index { get; set; }                 // 1..N\n        public string? Label { get; set; }\n        public string? Example { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplatePreviewDto.cs",
      "sha256": "ea9fe018139bee52670ef4b1030e185040a735c6eb91257088e675e75a40e3e1",
      "language": "csharp",
      "size": 2223,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public sealed class TemplatePreviewRequestDto\n    {\n        public string TemplateName { get; set; } = \"\";\n        public string? Provider { get; set; }          // \"META_CLOUD\" | \"PINNACLE\" (optional)\n        public string? Language { get; set; }          // e.g., \"en_US\" (optional)\n        public string? HeaderImageUrl { get; set; }    // for image-header previews\n        public List<string> TemplateParameters { get; set; } = new();  // BODY params in order\n        public List<PreviewButtonInputDto> Buttons { get; set; } = new(); // up to 3\n    }\n\n    public sealed class PreviewButtonInputDto\n    {\n        public int Position { get; set; }              // 1..3 aligns with template button order\n        public string? Type { get; set; }              // e.g., \"URL\"\n        public string? Title { get; set; }             // label shown to user (optional)\n        public string? Value { get; set; }             // for dynamic URL value or tel/wa deep link\n    }\n\n    public sealed class TemplatePreviewResponseDto\n    {\n        public bool FoundTemplate { get; set; }\n        public string TemplateName { get; set; } = \"\";\n        public string? Language { get; set; }\n        public bool HasHeaderMedia { get; set; }\n        public string HeaderType { get; set; } = \"\";   // \"IMAGE\", \"VIDEO\", etc.\n\n        public int RequiredPlaceholderCount { get; set; }\n        public int ProvidedPlaceholderCount { get; set; }\n        public List<int> MissingPlaceholderIndices { get; set; } = new(); // 1-based\n        public List<string> Warnings { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n\n        // A provider-shaped preview of what we'd send (Meta/Pinnacle use the same component shape)\n        // Example:\n        // [\n        //   { type:\"header\", parameters:[{ type:\"image\", image:{ link:\"...\"}}]},\n        //   { type:\"body\", parameters:[{type:\"text\",text:\"..\"}, ...] },\n        //   { type:\"button\", sub_type:\"url\", index:\"0\", parameters:[{ type:\"text\", text:\"TOKEN_OR_URL\"}] }\n        // ]\n        public List<object> ProviderComponentsPreview { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateShape.cs",
      "sha256": "b09887fc7a92992bd71f628553412f5a86b5164c175bc94e37286378488ab975",
      "language": "csharp",
      "size": 93,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class TemplateShape\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateSummaryDto.cs",
      "sha256": "fe362a273559fdfadca0d5c953779523b4c3312685fd4043802ac0c9453a2a8f",
      "language": "csharp",
      "size": 2996,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    /// <summary>\n    /// Section-aware summary of a provider template.\n    /// Distinct slots are tracked per section to avoid collisions (e.g., header {{1}} vs body {{1}}).\n    /// </summary>\n    public sealed class TemplateSummaryDto\n    {\n        // --- What users see in CSV/FE ---\n        public string HeaderKind { get; init; } = \"none\";           // none | text | image | video | document\n        public string? HeaderText { get; init; }                    // original header text if TEXT\n        public string? BodyText { get; init; }                      // original body text\n        public string CombinedPreviewBody { get; init; } = \"\";      // HeaderText + \"\\n\\n\" + BodyText (for FE/CSV)\n\n        // --- Distinct slot lists per section (order of appearance) ---\n        public List<int> HeaderParamIndices { get; init; } = new(); // e.g., [1,2]\n        public List<int> BodyParamIndices { get; init; } = new();   // e.g., [1,2,3]\n\n        // Per-button parameter templates (URL/tel/etc), each with their own local indices\n        public List<ButtonParamTemplate> Buttons { get; init; } = new(); // up to 3, in template order (1..3)\n\n        // Convenience total for CSV/validation (sum across sections, not union)\n        public int PlaceholderCount { get; init; }                  // HeaderParamIndices.Count + BodyParamIndices.Count + Œ£ Buttons[i].ParamIndices.Count\n    }\n\n    public sealed class ButtonParamTemplate\n    {\n        public int Order { get; init; }                 // 1..3 (template order)\n        public string Type { get; init; } = \"\";         // URL | PHONE_NUMBER | QUICK_REPLY | FLOW | ...\n        public string Text { get; init; } = \"\";         // Button label\n        public string? ParamTemplate { get; init; }     // e.g., \"https://x.example/{{1}}\", \"tel:+911234567890\"\n        public List<int> ParamIndices { get; init; } = new(); // e.g., [1]\n    }\n\n    /// <summary>\n    /// Result of filling values across all sections in the agreed order:\n    /// [ header slots... , body slots... , (btn1 slots...), (btn2 slots...), ... ]\n    /// </summary>\n    public sealed class TemplateFillResult\n    {\n        public string ResolvedHeaderText { get; init; } = \"\";\n        public string ResolvedBodyText { get; init; } = \"\";\n        public string ResolvedCombinedPreviewBody { get; init; } = \"\";\n        public List<ResolvedButtonParam> ResolvedButtons { get; init; } = new(); // aligned with TemplateSummaryDto.Buttons\n        public List<string> Warnings { get; init; } = new();\n        public List<string> Errors { get; init; } = new();\n    }\n\n    public sealed class ResolvedButtonParam\n    {\n        public int Order { get; init; }            // 1..3\n        public string Type { get; init; } = \"\";\n        public string Text { get; init; } = \"\";\n        public string? ResolvedValue { get; init; } // filled URL/tel/... or original if no placeholders\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateSummaryResponseDto.cs",
      "sha256": "70bdef8be64a16b303a2543426e521b694e039e2a4f0b1a403f0e8675ff9fb63",
      "language": "csharp",
      "size": 473,
      "content": "using System.Collections.Generic;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.DTOs\n{\n    public sealed class TemplateSummaryResponseDto\n    {\n        public string TemplateId { get; init; } = \"\";\n        public string Provider { get; init; } = \"\";\n        public string Name { get; init; } = \"\";\n        public string Language { get; init; } = \"\";\n\n        public TemplateSummaryDto Summary { get; init; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/WhatsAppConnectionSummaryDto.cs",
      "sha256": "0694b82985cfefd3ed4a0332039ea7792f2942ac4c707268371897b86aee1e76",
      "language": "csharp",
      "size": 735,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class WhatsAppConnectionSummaryDto\n    {\n        public Guid BusinessId { get; set; }\n        public string? WhatsAppBusinessNumber { get; set; }\n        public List<string> WhatsAppBusinessNumbers { get; set; } = new();\n        public string? PhoneNumberId { get; set; } // Metadata\n\n        // Health Fields\n        public string? VerifiedName { get; set; }\n        public string? QualityRating { get; set; }\n        public string? Status { get; set; }\n        public string? NameStatus { get; set; }\n        public string? MessagingLimitTier { get; set; }\n        \n        public DateTime? LastUpdated { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/WhatsAppSenderDto.cs",
      "sha256": "8c113389ea7e922d92ef3a6f8538003ea60f8a62298e0622300bf845f290668c",
      "language": "csharp",
      "size": 869,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class WhatsAppSenderDto\n    {\n        public Guid Id { get; set; }                         // row id in WhatsAppPhoneNumbers\n        public Guid BusinessId { get; set; }\n        public string Provider { get; set; } = string.Empty; // \"PINNACLE\" | \"META_CLOUD\"\n        public string PhoneNumberId { get; set; } = string.Empty;\n        public string WhatsAppBusinessNumber { get; set; } = string.Empty; // E.164 printable\n        public string? SenderDisplayName { get; set; }\n        public bool IsActive { get; set; }\n        public bool IsDefault { get; set; }\n        public string DisplayLabel =>\n            string.IsNullOrWhiteSpace(SenderDisplayName)\n                ? $\"{WhatsAppBusinessNumber} ‚Ä¢ {Provider}\"\n                : $\"{SenderDisplayName} ({WhatsAppBusinessNumber}) ‚Ä¢ {Provider}\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/WhatsAppSenderResolutionResult.cs",
      "sha256": "545a4cf5e4e6a2986941329126f8c417fce1d6664ff50d23e5ecb11981b1b0a2",
      "language": "csharp",
      "size": 1301,
      "content": "using System;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    /// <summary>\n    /// ESU-aware sender resolution result.\n    /// IMPORTANT: PhoneNumberId must be sourced ONLY from WhatsAppPhoneNumbers (never from WhatsAppSettings.PhoneNumberId).\n    /// </summary>\n    public sealed class WhatsAppSenderResolutionResult\n    {\n        public bool Success { get; init; }\n        public string? Provider { get; init; }\n        public string? PhoneNumberId { get; init; }\n\n        /// <summary>Non-fatal warning that should be logged by the caller.</summary>\n        public string? Warning { get; init; }\n\n        /// <summary>Fatal reason (e.g., no active sender configured).</summary>\n        public string? Error { get; init; }\n\n        public static WhatsAppSenderResolutionResult Ok(string provider, string phoneNumberId, string? warning = null)\n            => new()\n            {\n                Success = true,\n                Provider = provider,\n                PhoneNumberId = phoneNumberId,\n                Warning = warning\n            };\n\n        public static WhatsAppSenderResolutionResult Fail(string? provider, string error)\n            => new()\n            {\n                Success = false,\n                Provider = provider,\n                Error = error\n            };\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/WhatsAppSettingsDto.cs",
      "sha256": "aa2ce9d9b64f5ca5103f58c97578e0e771d2ab9303b505067fd43789b7449f01",
      "language": "csharp",
      "size": 624,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public sealed class WhatsAppSettingsDto\n    {\n        public Guid BusinessId { get; init; }\n        public string Provider { get; init; } = string.Empty;\n        public string ApiUrl { get; init; } = string.Empty;\n        public string? ApiKey { get; init; }\n        public string? WabaId { get; init; }\n\n        public string? PhoneNumberId { get; init; }  // from WhatsAppPhoneNumbers\n        public string? WhatsAppBusinessNumber { get; init; }  // from WhatsAppPhoneNumbers\n        public string? SenderDisplayName { get; init; } // from WhatsAppPhoneNumbers\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Helpers/TemplateJsonHelper.cs",
      "sha256": "aedaa16cd4ce9f6feff139747eee0211d6fb2fc2bf7aaef8492e2edb080a4bb3",
      "language": "csharp",
      "size": 13934,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.RegularExpressions;\nusing Newtonsoft.Json.Linq;\n\nnamespace xbytechat.api.WhatsAppSettings.Helpers\n{\n    public static class TemplateJsonHelper\n    {\n        // Positional like {{1}}\n        private static readonly Regex PositionalRx = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n        // Named like {{first_name}}  (letters, digits, _, -, starting with letter/_)\n        private static readonly Regex NamedRx = new(@\"\\{\\{\\s*([A-Za-z_][A-Za-z0-9_\\-]*)\\s*\\}\\}\", RegexOptions.Compiled);\n        // Any like {{...}} ‚Äî used for total counting / empty braces\n        private static readonly Regex AnyRx = new(@\"\\{\\{[^}]*\\}\\}\", RegexOptions.Compiled);\n\n        public static (string HeaderKind, string CombinedBody, int PlaceholderCount)\n            Summarize(string rawJson, string? bodyFallback = null)\n        {\n            var d = SummarizeDetailed(rawJson, bodyFallback);\n            return (d.HeaderKind ?? \"none\", d.CombinedPreviewBody ?? string.Empty, d.PlaceholderCount);\n        }\n\n        public static TemplateSummaryDto SummarizeDetailed(string rawJson, string? bodyFallback = null)\n        {\n            var doc = JToken.Parse(string.IsNullOrWhiteSpace(rawJson) ? \"{}\" : rawJson);\n            var components = doc[\"components\"] as JArray ?? new JArray();\n\n            // Provider hint (may be null/empty)\n            var parameterFormatHint = doc[\"parameter_format\"]?.ToString()?.ToUpperInvariant(); // \"POSITIONAL\" | \"NAMED\" | null\n\n            string headerKind = \"none\";\n            string? headerText = null;\n            string? bodyText = null;\n\n            var headerPosIdx = new List<int>();\n            var bodyPosIdx = new List<int>();\n            var buttons = new List<ButtonParamTemplate>();\n            var occurrences = new List<PlaceholderOccurrence>();\n\n            int order = 0;\n\n            foreach (var comp in components)\n            {\n                var type = comp?[\"type\"]?.ToString()?.ToUpperInvariant();\n                if (string.IsNullOrEmpty(type)) continue;\n\n                if (type == \"HEADER\")\n                {\n                    var format = comp?[\"format\"]?.ToString()?.ToUpperInvariant();\n                    headerKind = format switch\n                    {\n                        \"TEXT\" => \"text\",\n                        \"IMAGE\" => \"image\",\n                        \"VIDEO\" => \"video\",\n                        \"DOCUMENT\" => \"document\",\n                        _ => \"none\"\n                    };\n\n                    if (headerKind == \"text\")\n                    {\n                        headerText = comp?[\"text\"]?.ToString() ?? \"\";\n                        headerPosIdx = ExtractPositional(headerText);\n                        occurrences.AddRange(CollectOccurrences(headerText, PlaceholderLocation.Header));\n                    }\n                }\n                else if (type == \"BODY\")\n                {\n                    bodyText = comp?[\"text\"]?.ToString() ?? \"\";\n                    bodyPosIdx = ExtractPositional(bodyText);\n                    occurrences.AddRange(CollectOccurrences(bodyText, PlaceholderLocation.Body));\n                }\n                else if (type == \"BUTTONS\")\n                {\n                    var btns = comp?[\"buttons\"] as JArray ?? new JArray();\n                    foreach (var b in btns)\n                    {\n                        order++;\n                        var btnType = b?[\"type\"]?.ToString()?.ToUpperInvariant() ?? \"\";\n                        var text = b?[\"text\"]?.ToString() ?? \"\";\n\n                        string? urlLike =\n                            b?[\"url\"]?.ToString()\n                            ?? b?[\"phone_number\"]?.ToString()\n                            ?? b?[\"coupon_code\"]?.ToString()\n                            ?? b?[\"flow_id\"]?.ToString();\n\n                        // ‚Äúexample‚Äù can be string or array\n                        if (string.IsNullOrWhiteSpace(urlLike))\n                        {\n                            var ex = b?[\"example\"];\n                            if (ex is JArray arr) urlLike = arr.FirstOrDefault()?.ToString();\n                            else if (ex is JValue val) urlLike = val.ToString();\n                        }\n\n                        var tmpl = urlLike;\n                        var posIdx = string.IsNullOrEmpty(tmpl) ? new List<int>() : ExtractPositional(tmpl);\n\n                        buttons.Add(new ButtonParamTemplate\n                        {\n                            Order = order,\n                            Type = btnType,\n                            Text = text,\n                            ParamTemplate = tmpl,\n                            ParamIndices = posIdx\n                        });\n\n                        // collect occurrences for button text & param template separately\n                        if (!string.IsNullOrEmpty(text))\n                            occurrences.AddRange(CollectOccurrences(text, PlaceholderLocation.Button, order, \"text\"));\n\n                        if (!string.IsNullOrEmpty(tmpl))\n                            occurrences.AddRange(CollectOccurrences(tmpl!, PlaceholderLocation.Button, order, \"param\"));\n                    }\n                }\n            }\n\n            // fallback if no BODY block present in JSON\n            bodyText ??= bodyFallback ?? \"\";\n\n            var combined = CombinePreview(headerText, bodyText);\n\n            // Positional counting ‚Üí max index across header/body/buttons\n            var maxHeader = headerPosIdx.DefaultIfEmpty(0).Max();\n            var maxBody = bodyPosIdx.DefaultIfEmpty(0).Max();\n            var maxBtns = buttons.SelectMany(b => b.ParamIndices).DefaultIfEmpty(0).Max();\n            var maxPositional = Math.Max(maxHeader, Math.Max(maxBody, maxBtns));\n\n            int placeholderCount;\n            if (maxPositional > 0)\n            {\n                placeholderCount = maxPositional;\n            }\n            else\n            {\n                // Named/empty mode ‚Üí total {{...}} across header/body/buttons\n                placeholderCount =\n                    CountAny(headerText) +\n                    CountAny(bodyText) +\n                    buttons.Sum(b => CountAny(b.ParamTemplate)) +\n                    // button text may also contain placeholders\n                    buttons.Sum(b => CountAny(b.Text));\n            }\n\n            // ----- ParameterFormat resolution (hint ‚Üí inference) -----\n            string? parameterFormat = null;\n            if (parameterFormatHint == \"POSITIONAL\" || parameterFormatHint == \"NAMED\")\n            {\n                parameterFormat = parameterFormatHint;\n            }\n            else\n            {\n                // Infer from content\n                var hasPositional = maxPositional > 0;\n                var hasNamed = occurrences.Any(o => o.Type == PlaceholderType.Named);\n\n                if (hasPositional) parameterFormat = \"POSITIONAL\";\n                else if (hasNamed) parameterFormat = \"NAMED\";\n                else parameterFormat = null; // unknown / no placeholders\n            }\n\n            return new TemplateSummaryDto\n            {\n                HeaderKind = headerKind,\n                HeaderText = headerText,\n                BodyText = bodyText,\n                CombinedPreviewBody = combined,\n                HeaderParamIndices = headerPosIdx,\n                BodyParamIndices = bodyPosIdx,\n                Buttons = buttons,\n                PlaceholderCount = placeholderCount,\n                Placeholders = occurrences,\n\n                // NEW: summary flag so services don't have to re-derive this\n                ParameterFormat = parameterFormat\n            };\n        }\n\n\n        /// <summary>Render a text with positional placeholders ({{1}}, {{2}}, ‚Ä¶).</summary>\n        public static string RenderTextPositional(string? template, IReadOnlyDictionary<int, string> args)\n        {\n            if (string.IsNullOrEmpty(template)) return string.Empty;\n            // Replace highest-first to avoid {{1}} touching characters that form {{10}}\n            // Using Regex evaluator is safer:\n            return PositionalRx.Replace(template, m =>\n            {\n                var idx = int.Parse(m.Groups[1].Value);\n                return args.TryGetValue(idx, out var val) ? val ?? string.Empty : string.Empty;\n            });\n        }\n\n        /// <summary>Render a text with named placeholders ({{name}}, {{email}}). Empty {{}} treated as next positional index (1-based).</summary>\n        public static string RenderTextNamed(string? template, IReadOnlyDictionary<string, string> namedArgs, IReadOnlyDictionary<int, string>? positionalArgs = null)\n        {\n            if (string.IsNullOrEmpty(template)) return string.Empty;\n\n            // First replace named\n            var result = NamedRx.Replace(template, m =>\n            {\n                var key = m.Groups[1].Value;\n                return namedArgs.TryGetValue(key, out var val) ? val ?? string.Empty : string.Empty;\n            });\n\n            // Then positional if provided\n            if (positionalArgs != null && positionalArgs.Count > 0)\n            {\n                result = RenderTextPositional(result, positionalArgs);\n            }\n\n            // Finally convert empty {{}} ‚Üí empty string (or you could plug a policy here)\n            result = Regex.Replace(result, @\"\\{\\{\\s*\\}\\}\", string.Empty);\n\n            return result;\n        }\n\n        // ---------- internal helpers ----------\n\n        private static List<int> ExtractPositional(string text)\n            => PositionalRx.Matches(text).Select(m => int.Parse(m.Groups[1].Value)).Distinct().ToList();\n\n        private static int CountAny(string? text)\n            => string.IsNullOrEmpty(text) ? 0 : AnyRx.Matches(text).Count;\n\n        private static string CombinePreview(string? header, string? body)\n        {\n            var h = string.IsNullOrWhiteSpace(header) ? null : header!.Trim();\n            var b = string.IsNullOrWhiteSpace(body) ? null : body!.Trim();\n            if (h is null && b is null) return \"\";\n            if (h is null) return b!;\n            if (b is null) return h!;\n            return $\"{h}\\n\\n{b}\";\n        }\n\n        private static IEnumerable<PlaceholderOccurrence> CollectOccurrences(\n            string text,\n            PlaceholderLocation location,\n            int? buttonOrder = null,\n            string? buttonField = null)\n        {\n            // Positional\n            foreach (Match m in PositionalRx.Matches(text))\n            {\n                yield return new PlaceholderOccurrence\n                {\n                    Type = PlaceholderType.Positional,\n                    Index = int.Parse(m.Groups[1].Value),\n                    Raw = m.Value,\n                    Location = location,\n                    ButtonOrder = buttonOrder,\n                    ButtonField = buttonField\n                };\n            }\n            // Named\n            foreach (Match m in NamedRx.Matches(text))\n            {\n                yield return new PlaceholderOccurrence\n                {\n                    Type = PlaceholderType.Named,\n                    Name = m.Groups[1].Value,\n                    Raw = m.Value,\n                    Location = location,\n                    ButtonOrder = buttonOrder,\n                    ButtonField = buttonField\n                };\n            }\n            // Empty braces (that weren‚Äôt positional or named)\n            // We count them by subtracting positional+named from all-any.\n            var any = AnyRx.Matches(text).Cast<Match>().Select(mm => mm.Value).ToList();\n            var consumed = new HashSet<string>(PositionalRx.Matches(text).Cast<Match>().Select(mm => mm.Value)\n                .Concat(NamedRx.Matches(text).Cast<Match>().Select(mm => mm.Value)));\n            foreach (var token in any.Where(t => !consumed.Contains(t)))\n            {\n                yield return new PlaceholderOccurrence\n                {\n                    Type = PlaceholderType.Empty,\n                    Raw = token,\n                    Location = location,\n                    ButtonOrder = buttonOrder,\n                    ButtonField = buttonField\n                };\n            }\n        }\n    }\n\n    // ---------- DTOs ----------\n\n    public sealed class TemplateSummaryDto\n    {\n        public string HeaderKind { get; set; } = \"none\";\n        public string? HeaderText { get; set; }\n        public string? BodyText { get; set; }\n\n        public List<int> HeaderParamIndices { get; set; } = new();\n        public List<int> BodyParamIndices { get; set; } = new();\n\n        public List<ButtonParamTemplate> Buttons { get; set; } = new();\n\n        public string? CombinedPreviewBody { get; set; }\n\n        public int PlaceholderCount { get; set; }\n\n        public List<PlaceholderOccurrence> Placeholders { get; set; } = new();\n        public string ParameterFormat { get; set; } = \"UNKNOWN\"; // POSITIONAL | NAMED | MIXED | UNKNOWN\n\n    }\n\n    public sealed class ButtonParamTemplate\n    {\n        public int Order { get; set; }\n        public string Type { get; set; } = \"\";\n        public string Text { get; set; } = \"\";\n        public string? ParamTemplate { get; set; }\n        public List<int> ParamIndices { get; set; } = new();\n    }\n\n    public enum PlaceholderType { Positional, Named, Empty }\n\n    public enum PlaceholderLocation {\n\n        Header = 0, Body = 1, Button = 2\n    }\n\n    public sealed class PlaceholderOccurrence\n    {\n        public PlaceholderType Type { get; set; }\n        public int? Index { get; set; }     // for Positional\n        public string? Name { get; set; }   // for Named\n        public string Raw { get; set; } = \"{{}}\";\n        public PlaceholderLocation Location { get; set; }\n        public int? ButtonOrder { get; set; }     // when Location == Button\n        public string? ButtonField { get; set; }  // \"text\" or \"param\"\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/MakeDump.bat",
      "sha256": "1f0c8a79e7859146dab81f8a13dcdf495c12b54b888024e8500fefb4abd58a9e",
      "language": "bat",
      "size": 1618,
      "content": "@echo off\nREM This script will find relevant source files and output their names and contents into one file.\nREM The output file will be named [FolderName]_AllFileDump.txt.\n\nREM Get the current folder's name and set it as the output file name with the custom suffix\nfor %%I in (\"%cd%\") do set \"outputFile=%%~nI_AllFileDump.txt\"\n\nREM Clear the output file to start fresh and write a small header\n> \"%outputFile%\" (\n    echo Folder and File Content Report\n    echo Root folder: %cd%\n    echo Generated at: %date% %time%\n)\necho. >> \"%outputFile%\"\n\nREM NOTE:\nREM We now only dump RELEVANT text/code files (no binaries, no images, no node_modules, etc.)\nREM This keeps the file smaller and much easier to review.\n\nREM Loop through all relevant files in the current directory and subdirectories\nREM Extensions included: C#, JS/TS/React, JSON, config, SQL, Markdown, YAML\nfor /R . %%F in (*.cs *.csproj *.jsx *.tsx *.js *.ts *.json *.config *.sql *.md *.yml *.yaml *.bat) do (\n\n    REM Skip some noisy folders by path substring (node_modules, bin, obj, .git, dist, .vs)\n    echo \"%%F\" | findstr /I /C:\"\\node_modules\\\" /C:\"\\bin\\\" /C:\"\\obj\\\" /C:\"\\.git\\\" /C:\"\\dist\\\" /C:\"\\.vs\\\" >nul\n    if errorlevel 1 (\n        echo ====================================================== >> \"%outputFile%\"\n        echo FILE: %%F >> \"%outputFile%\"\n        echo ====================================================== >> \"%outputFile%\"\n        echo. >> \"%outputFile%\"\n        type \"%%F\" >> \"%outputFile%\" 2>nul\n        echo. >> \"%outputFile%\"\n        echo. >> \"%outputFile%\"\n    )\n)\n\necho Finished! All content has been extracted to %outputFile%\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Models/WhatsAppPhoneNumber.cs",
      "sha256": "7a410fb3194950797d15c390ce73a1b4360a6ba22baeb019134c3d876394a5df",
      "language": "csharp",
      "size": 1301,
      "content": "using System;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Models\n{\n    public class WhatsAppPhoneNumber\n    {\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        public Guid BusinessId { get; set; }\n        public string Provider { get; set; } = null!;                 // \"Meta_cloud\" | \"Pinnacle\" | etc.\n\n        public string PhoneNumberId { get; set; } = null!;            // provider-specific id (e.g., Meta phone_number_id)\n        public string WhatsAppBusinessNumber { get; set; } = null!;   // e.g., \"+15551234567\"\n        public string? SenderDisplayName { get; set; }\n\n        public string? VerifiedName { get; set; }\n        public string? QualityRating { get; set; }        // GREEN, YELLOW, RED, UNKNOWN\n        public string? Status { get; set; }               // CONNECTED, RATE_LIMITED, FLAGGED, etc.\n        public string? NameStatus { get; set; }           // APPROVED, PENDING, DECLINED, etc.\n        public string? MessagingLimitTier { get; set; }   // TIER_250, etc.\n        public DateTime? ConnectionDataUpdatedAt { get; set; }\n\n        public bool IsActive { get; set; } = true;\n        public bool IsDefault { get; set; } = false;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime? UpdatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Models/WhatsAppSettingEntity.cs",
      "sha256": "d4e6aff67b15f0a503cd217b7ed30bf58b63b5e508dcb5da128ac989a36c6b63",
      "language": "csharp",
      "size": 1835,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Models\n{\n    public class WhatsAppSettingEntity\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        // NEW: which provider this row belongs to (\"pinnacle\", \"meta_cloud\", \"twilio\", etc.)\n        [Required]\n        [MaxLength(50)]\n        public string Provider { get; set; } //= \"pinnacle\";\n\n        [Required]\n        [MaxLength(500)]\n        public string ApiUrl { get; set; }  // e.g. https://partnersv1.pinbot.ai/v3\n\n        [MaxLength(1000)]\n        public string ApiKey { get; set; }\n\n        //[Required]\n        //[MaxLength(1000)]\n        //public string ApiToken { get; set; } // store encrypted\n\n        //[MaxLength(20)]\n       // public string? WhatsAppBusinessNumber { get; set; }\n\n        //public string? PhoneNumberId { get; set; } // used by Meta Cloud; Pinbot doesn't need it\n        public string? WabaId { get; set; } = string.Empty;\n\n        [MaxLength(100)]\n        public string? SenderDisplayName { get; set; }\n\n        // Optional: for webhook signature/verification if provider supports it\n        [MaxLength(200)]\n        public string? WebhookSecret { get; set; }\n\n        [MaxLength(200)]\n\n\n        public string? WebhookVerifyToken { get; set; }\n\n        [MaxLength(1000)]\n        public string? WebhookCallbackUrl { get; set; }\n\n\n        [Required]\n        public bool IsActive { get; set; } = true;\n\n        [Required]\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public ICollection<WhatsAppPhoneNumber> WhatsAppBusinessNumbers { get; set; } = new List<WhatsAppPhoneNumber>();\n\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/IMetaTemplateCatalogProvider.cs",
      "sha256": "73c5af3f63545a523d620b39d6c064a1264ba069f156e96dfd4538eba6a15848",
      "language": "csharp",
      "size": 541,
      "content": "using xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    public interface IMetaTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListMetaAsync(\n           WhatsAppSettingEntity setting,\n           CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNameMetaAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/IPinnacleTemplateCatalogProvider.cs",
      "sha256": "7cb6804a809e2848861752dcdc26f6031e20ed3584ffb9872844faecabd90b67",
      "language": "csharp",
      "size": 551,
      "content": "using xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    public interface IPinnacleTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListPinnacleAsync(\n          WhatsAppSettingEntity setting,\n          CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNamePinnacleAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/MetaTemplateCatalogProvider.cs",
      "sha256": "540b0a1734129e7836651e532c2cb24a37b38bd0d4ab6bf797f3de54af2fd839",
      "language": "csharp",
      "size": 16899,
      "content": "using System.Globalization;\nusing System.Net.Http.Headers;\nusing System.Text.RegularExpressions;\nusing Microsoft.Extensions.Logging;\nusing Newtonsoft.Json;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    public sealed class MetaTemplateCatalogProvider : IMetaTemplateCatalogProvider\n    {\n        private readonly HttpClient _http;\n        private readonly ILogger<MetaTemplateCatalogProvider> _log;\n\n        public MetaTemplateCatalogProvider(HttpClient http, ILogger<MetaTemplateCatalogProvider> log)\n        {\n            _http = http;\n            _log = log;\n        }\n\n        public async Task<IReadOnlyList<TemplateCatalogItem>> ListMetaAsync(\n            WhatsAppSettingEntity s, CancellationToken ct = default)\n        {\n            var items = new List<TemplateCatalogItem>();\n            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n                return items;\n\n            var baseUrl = s.ApiUrl?.TrimEnd('/') ?? \"https://graph.facebook.com/v22.0\";\n            var next = $\"{baseUrl}/{s.WabaId}/message_templates?limit=100\";\n\n            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n            while (!string.IsNullOrWhiteSpace(next))\n            {\n                ct.ThrowIfCancellationRequested();\n\n                using var req = new HttpRequestMessage(HttpMethod.Get, next);\n                var res = await _http.SendAsync(req, ct);\n                var json = await res.Content.ReadAsStringAsync(ct);\n                if (!res.IsSuccessStatusCode) break;\n\n                dynamic parsed = JsonConvert.DeserializeObject(json);\n                foreach (var tpl in parsed.data)\n                {\n                    try\n                    {\n                        // status filter\n                        string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n                        if (status != \"APPROVED\" && status != \"ACTIVE\" && status != \"PENDING_REVIEW\" && status != \"IN_REVIEW\") continue;\n\n                        string name = tpl.name?.ToString() ?? \"\";\n                        string language = tpl.language?.ToString() ?? \"en_US\";\n                        string category = tpl.category?.ToString() ?? \"\";\n                        string externalId = tpl.id?.ToString() ?? \"\";\n\n                        string body = \"\";\n                        bool hasImageHeader = false;\n                        var buttons = new List<ButtonMetadataDto>();\n\n                        foreach (var comp in tpl.components)\n                        {\n                            string type = comp.type?.ToString()?.ToUpperInvariant() ?? \"\";\n\n                            if (type == \"BODY\")\n                            {\n                                body = comp.text?.ToString() ?? \"\";\n                            }\n                            else if (type == \"HEADER\")\n                            {\n                                if (comp.format?.ToString()?.ToUpperInvariant() == \"IMAGE\")\n                                    hasImageHeader = true;\n                            }\n                            else if (type == \"BUTTONS\")\n                            {\n                                if (comp.buttons == null) continue;\n\n                                foreach (var b in comp.buttons)\n                                {\n                                    try\n                                    {\n                                        string btnTypeRaw = b.type?.ToString() ?? \"\";\n                                        string btnType = btnTypeRaw.ToUpperInvariant();\n                                        string text = b.text?.ToString() ?? \"\";\n\n                                        // ---- robust index extraction (avoid RuntimeBinderException) ----\n                                        int index;\n                                        object? idxObj = null;\n                                        try { idxObj = b.index; } catch { /* some payloads omit index */ }\n                                        if (idxObj is int ii) index = ii;\n                                        else if (idxObj is long ll && ll <= int.MaxValue) index = (int)ll;\n                                        else if (idxObj != null && int.TryParse(idxObj.ToString(), NumberStyles.Integer, CultureInfo.InvariantCulture, out var parsedIdx))\n                                            index = parsedIdx;\n                                        else\n                                            index = buttons.Count; // fallback to current count\n\n                                        // normalize subtype & parameter value\n                                        string subType = btnType switch\n                                        {\n                                            \"URL\" => \"url\",\n                                            \"PHONE_NUMBER\" => \"voice_call\",\n                                            \"QUICK_REPLY\" => \"quick_reply\",\n                                            \"COPY_CODE\" => \"copy_code\",\n                                            \"CATALOG\" => \"catalog\",\n                                            \"FLOW\" => \"flow\",\n                                            \"REMINDER\" => \"reminder\",\n                                            \"ORDER_DETAILS\" => \"order_details\",\n                                            _ => \"unknown\"\n                                        };\n\n                                        // try to capture a useful value for URL-like buttons\n                                        string? param =\n                                            b.url != null ? b.url.ToString() :\n                                            b.phone_number != null ? b.phone_number.ToString() :\n                                            b.coupon_code != null ? b.coupon_code.ToString() :\n                                            b.flow_id != null ? b.flow_id.ToString() :\n                                            null;\n\n                                        // ‚Äúexample‚Äù can be array or scalar\n                                        if (string.IsNullOrWhiteSpace(param))\n                                        {\n                                            try\n                                            {\n                                                var ex = b.example;\n                                                if (ex != null)\n                                                {\n                                                    if (ex is string exStr) param = exStr;\n                                                    else\n                                                    {\n                                                        // attempt common shapes: { \"example\": { \"url\": [\"...\"] } } or [\"...\"]\n                                                        var exStr2 = ex.ToString();\n                                                        if (!string.IsNullOrWhiteSpace(exStr2))\n                                                            param = exStr2;\n                                                    }\n                                                }\n                                            }\n                                            catch { /* ignore */ }\n                                        }\n\n                                        // some subtypes require a value; skip if not available\n                                        bool requiresParam = subType is \"url\" or \"flow\" or \"copy_code\" or \"catalog\" or \"reminder\";\n                                        if (subType == \"unknown\" || (requiresParam && string.IsNullOrWhiteSpace(param)))\n                                            continue;\n\n                                        buttons.Add(new ButtonMetadataDto\n                                        {\n                                            Text = text,\n                                            Type = btnType,\n                                            SubType = subType,\n                                            Index = index,\n                                            ParameterValue = param ?? \"\"\n                                        });\n                                    }\n                                    catch (Exception exBtn)\n                                    {\n                                        _log.LogWarning(exBtn, \"[MetaTpl] Button parse failed for template {Name}\", name);\n                                    }\n                                }\n                            }\n                        }\n\n                        int placeholders = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n                        var raw = JsonConvert.SerializeObject(tpl);\n\n                        items.Add(new TemplateCatalogItem(\n                            Name: name,\n                            Language: language,\n                            Body: body,\n                            PlaceholderCount: placeholders,\n                            HasImageHeader: hasImageHeader,\n                            Buttons: buttons,\n                            Status: status,\n                            Category: category,\n                            ExternalId: externalId,\n                            RawJson: raw\n                        ));\n                    }\n                    catch (Exception exItem)\n                    {\n                        _log.LogWarning(exItem, \"[MetaTpl] Skipped bad template item\");\n                    }\n                }\n\n                // paging\n                try { next = parsed?.paging?.next?.ToString(); }\n                catch { next = null; }\n            }\n\n            return items;\n        }\n\n        public async Task<TemplateCatalogItem?> GetByNameMetaAsync(\n            WhatsAppSettingEntity s, string templateName, CancellationToken ct = default)\n        {\n            var all = await ListMetaAsync(s, ct);\n            return all.FirstOrDefault(t => t.Name.Equals(templateName, StringComparison.OrdinalIgnoreCase));\n        }\n    }\n}\n\n//using Newtonsoft.Json;\n//using System.Net.Http.Headers;\n//using System.Text.RegularExpressions;\n//using xbytechat.api.WhatsAppSettings.Abstractions;\n//using xbytechat.api.WhatsAppSettings.DTOs;\n//using xbytechat_api.WhatsAppSettings.Models;\n\n//namespace xbytechat.api.WhatsAppSettings.Providers\n//{\n//    public sealed class MetaTemplateCatalogProvider : ITemplateCatalogProvider\n//    {\n//        private readonly HttpClient _http;\n//        private readonly ILogger<MetaTemplateCatalogProvider> _log;\n\n//        public MetaTemplateCatalogProvider(HttpClient http, ILogger<MetaTemplateCatalogProvider> log)\n//        { _http = http; _log = log; }\n\n//        public async Task<IReadOnlyList<TemplateCatalogItem>> ListAsync(WhatsAppSettingEntity s, CancellationToken ct = default)\n//        {\n//            var items = new List<TemplateCatalogItem>();\n//            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n//                return items;\n\n//            var baseUrl = s.ApiUrl?.TrimEnd('/') ?? \"https://graph.facebook.com/v22.0\";\n//            var next = $\"{baseUrl}/{s.WabaId}/message_templates?limit=100\";\n\n//            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n//            while (!string.IsNullOrWhiteSpace(next))\n//            {\n//                var res = await _http.GetAsync(next, ct);\n//                var json = await res.Content.ReadAsStringAsync(ct);\n//                if (!res.IsSuccessStatusCode) break;\n\n//                dynamic parsed = JsonConvert.DeserializeObject(json);\n\n//                foreach (var tpl in parsed.data)\n//                {\n//                    // Filter APPROVED/ACTIVE\n//                    string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n//                    if (status != \"APPROVED\" && status != \"ACTIVE\") continue;\n\n//                    string name = tpl.name;\n//                    string language = tpl.language ?? \"en_US\";\n//                    string body = \"\";\n//                    bool hasImageHeader = false;\n//                    var buttons = new List<ButtonMetadataDto>();\n\n//                    foreach (var comp in tpl.components)\n//                    {\n//                        string type = comp.type?.ToString()?.ToUpperInvariant();\n\n//                        if (type == \"BODY\")\n//                            body = comp.text?.ToString() ?? \"\";\n\n//                        if (type == \"HEADER\" && (comp.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n//                            hasImageHeader = true;\n\n//                        if (type == \"BUTTONS\")\n//                        {\n//                            foreach (var b in comp.buttons)\n//                            {\n//                                try\n//                                {\n//                                    string btnType = b.type?.ToString()?.ToUpperInvariant() ?? \"\";\n//                                    string text = b.text?.ToString() ?? \"\";\n//                                    int index = buttons.Count;\n\n//                                    string subType = btnType switch\n//                                    {\n//                                        \"URL\" => \"url\",\n//                                        \"PHONE_NUMBER\" => \"voice_call\",\n//                                        \"QUICK_REPLY\" => \"quick_reply\",\n//                                        \"COPY_CODE\" => \"copy_code\",\n//                                        \"CATALOG\" => \"catalog\",\n//                                        \"FLOW\" => \"flow\",\n//                                        \"REMINDER\" => \"reminder\",\n//                                        \"ORDER_DETAILS\" => \"order_details\",\n//                                        _ => \"unknown\"\n//                                    };\n\n//                                    string? param = b.url != null ? b.url.ToString()\n//                                                 : b.phone_number != null ? b.phone_number.ToString()\n//                                                 : b.coupon_code != null ? b.coupon_code.ToString()\n//                                                 : b.flow_id != null ? b.flow_id.ToString()\n//                                                 : null;\n\n//                                    bool hasExample = b.example != null;\n//                                    bool isDynamic = hasExample && Regex.IsMatch(b.example.ToString(), @\"\\{\\{[0-9]+\\}\\}\");\n//                                    bool requiresParam = new[] { \"url\", \"flow\", \"copy_code\", \"catalog\", \"reminder\" }.Contains(subType);\n//                                    bool needsRuntimeValue = requiresParam && isDynamic;\n//                                    if (subType == \"unknown\" || (param == null && needsRuntimeValue)) continue;\n\n//                                    buttons.Add(new ButtonMetadataDto\n//                                    {\n//                                        Text = text,\n//                                        Type = btnType,\n//                                        SubType = subType,\n//                                        Index = index,\n//                                        ParameterValue = param ?? \"\"\n//                                    });\n//                                }\n//                                catch (Exception ex)\n//                                { _log.LogWarning(ex, \"Button parse failed for template {Name}\", (string)name); }\n//                            }\n//                        }\n//                    }\n\n//                    int placeholders = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n//                    var raw = JsonConvert.SerializeObject(tpl);\n\n//                    items.Add(new TemplateCatalogItem(\n//                        Name: name,\n//                        Language: language,\n//                        Body: body,\n//                        PlaceholderCount: placeholders,\n//                        HasImageHeader: hasImageHeader,\n//                        Buttons: buttons,\n//                        Status: status,\n//                        Category: tpl.category?.ToString(),\n//                        ExternalId: tpl.id?.ToString(),\n//                        RawJson: raw\n//                    ));\n//                }\n\n//                next = parsed?.paging?.next?.ToString();\n//            }\n\n//            return items;\n//        }\n\n//        public async Task<TemplateCatalogItem?> GetByNameAsync(WhatsAppSettingEntity s, string templateName, CancellationToken ct = default)\n//            => (await ListAsync(s, ct)).FirstOrDefault(t => t.Name.Equals(templateName, StringComparison.OrdinalIgnoreCase));\n//    }\n//}"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/PinnacleTemplateCatalogProvider.cs",
      "sha256": "45486c3f000b1b00bf396af9c79ea5c5dd3320d8cada01fc182ff422cc21c39d",
      "language": "csharp",
      "size": 11353,
      "content": "// xbytechat.api/WhatsAppSettings/Providers/PinnacleTemplateCatalogProvider.cs\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing Newtonsoft.Json;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing TemplateCatalogItem = xbytechat.api.WhatsAppSettings.Abstractions.TemplateCatalogItem;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    // Make sure your DI registers this as IPinnacleTemplateCatalogProvider *and* ITemplateCatalogProvider if needed.\n    public sealed class PinnacleTemplateCatalogProvider : IPinnacleTemplateCatalogProvider\n    {\n        private readonly HttpClient _http;\n        private readonly ILogger<PinnacleTemplateCatalogProvider> _log;\n        private readonly AppDbContext _context;\n\n        public PinnacleTemplateCatalogProvider(\n            HttpClient http,\n            ILogger<PinnacleTemplateCatalogProvider> log,\n            AppDbContext context)\n        {\n            _http = http;\n            _log = log;\n            _context = context;\n        }\n\n        // === Interface method used by TemplateSyncService ===\n        // TemplateSyncService expects _pinnacle.ListAsync(setting, ct). We delegate to the concrete method below.\n        public Task<IReadOnlyList<TemplateCatalogItem>> ListAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default)\n            => ListPinnacleAsync(setting, ct);\n\n        // === Concrete implementation ===\n        public async Task<IReadOnlyList<TemplateCatalogItem>> ListPinnacleAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default)\n        {\n            var items = new List<TemplateCatalogItem>();\n\n            if (string.IsNullOrWhiteSpace(setting.ApiKey))\n            {\n                _log.LogWarning(\"Pinnacle: missing ApiKey for BusinessId {BusinessId}\", setting.BusinessId);\n                return items;\n            }\n\n            var baseUrl = (setting.ApiUrl ?? \"https://partnersv1.pinbot.ai\").TrimEnd('/');\n            if (!baseUrl.EndsWith(\"/v3\", System.StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            var prov = (setting.Provider ?? \"\")\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\")\n                .ToUpperInvariant();\n\n            var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                ? setting.WabaId!.Trim()\n                : await _context.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .Where(p => p.BusinessId == setting.BusinessId\n                                && p.IsActive\n                                && p.Provider.ToUpper() == prov)\n                    .OrderByDescending(p => p.IsDefault)\n                    .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                    .Select(p => p.PhoneNumberId)\n                    .FirstOrDefaultAsync(ct);\n\n            if (string.IsNullOrWhiteSpace(pathId))\n            {\n                _log.LogWarning(\"Pinnacle: missing WabaId/PhoneNumberId for BusinessId {BusinessId}\", setting.BusinessId);\n                return items;\n            }\n\n            _http.DefaultRequestHeaders.Remove(\"apikey\");\n            _http.DefaultRequestHeaders.Remove(\"x-api-key\");\n            _http.DefaultRequestHeaders.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n            _http.DefaultRequestHeaders.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n\n            string? nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n            while (!string.IsNullOrWhiteSpace(nextUrl))\n            {\n                ct.ThrowIfCancellationRequested();\n\n                HttpResponseMessage res;\n                string json;\n                try\n                {\n                    using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                    res = await _http.SendAsync(req, ct);\n                    json = await res.Content.ReadAsStringAsync(ct);\n                }\n                catch (System.Exception ex)\n                {\n                    _log.LogError(ex, \"‚ùå Pinnacle HTTP error for {Url}\", nextUrl);\n                    break;\n                }\n\n                if (!res.IsSuccessStatusCode)\n                {\n                    _log.LogError(\"‚ùå Pinnacle list failed ({Status}): {Body}\", (int)res.StatusCode, json);\n                    break;\n                }\n\n                dynamic parsed;\n                try { parsed = JsonConvert.DeserializeObject(json)!; }\n                catch (System.Exception ex)\n                {\n                    _log.LogError(ex, \"‚ùå Pinnacle JSON parse error\");\n                    break;\n                }\n\n                var collection = parsed?.data ?? parsed?.templates;\n                if (collection == null)\n                {\n                    _log.LogInformation(\"Pinnacle: no data/templates array.\");\n                    break;\n                }\n\n                foreach (var tpl in collection)\n                {\n                    try\n                    {\n                        ct.ThrowIfCancellationRequested();\n\n                        string name = tpl?.name?.ToString() ?? \"\";\n                        string language = tpl?.language?.ToString() ?? \"\";\n                        string status = (tpl?.status?.ToString() ?? \"APPROVED\").Trim().ToUpperInvariant();\n                        string category = tpl?.category?.ToString() ?? \"\";\n                        string? subCat = tpl?.sub_category?.ToString();\n                        string externalId = tpl?.id?.ToString() ?? \"\";\n\n                        if (status != \"APPROVED\" && status != \"ACTIVE\" && status != \"PENDING_REVIEW\" && status != \"IN_REVIEW\")\n                            continue;\n\n                        string body = \"\";\n                        string headerKind = \"none\"; // text/image/video/document/none\n                        var buttons = new List<ButtonMetadataDto>();\n\n                        var components = tpl?.components;\n                        if (components != null)\n                        {\n                            foreach (var c in components)\n                            {\n                                var type = c?.type?.ToString()?.ToUpperInvariant();\n\n                                if (type == \"BODY\")\n                                {\n                                    body = c?.text?.ToString() ?? \"\";\n                                }\n                                else if (type == \"HEADER\")\n                                {\n                                    var fmt = c?.format?.ToString()?.ToUpperInvariant();\n                                    headerKind = fmt switch\n                                    {\n                                        \"TEXT\" => \"text\",\n                                        \"IMAGE\" => \"image\",\n                                        \"VIDEO\" => \"video\",\n                                        \"DOCUMENT\" => \"document\",\n                                        _ => \"none\"\n                                    };\n                                }\n                                else if (type == \"BUTTONS\" && c?.buttons != null)\n                                {\n                                    foreach (var b in c.buttons)\n                                    {\n                                        string btnType = b?.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                                        string text = b?.text?.ToString() ?? \"\";\n\n                                        // Prefer provider index if present; fallback to list order.\n                                        int index = 0;\n                                        if (!int.TryParse(b?.index?.ToString(), out index))\n                                            index = buttons.Count;\n\n                                        string subType = btnType switch\n                                        {\n                                            \"URL\" => \"url\",\n                                            \"PHONE_NUMBER\" => \"voice_call\",\n                                            \"QUICK_REPLY\" => \"quick_reply\",\n                                            \"COPY_CODE\" => \"copy_code\",\n                                            \"CATALOG\" => \"catalog\",\n                                            \"FLOW\" => \"flow\",\n                                            \"REMINDER\" => \"reminder\",\n                                            \"ORDER_DETAILS\" => \"order_details\",\n                                            _ => \"unknown\"\n                                        };\n                                        if (subType == \"unknown\") continue;\n\n                                        string? param =\n                                            b?.url?.ToString()\n                                            ?? b?.phone_number?.ToString()\n                                            ?? b?.coupon_code?.ToString()\n                                            ?? b?.flow_id?.ToString();\n\n                                        buttons.Add(new ButtonMetadataDto\n                                        {\n                                            Text = text,\n                                            Type = btnType,\n                                            SubType = subType,\n                                            Index = index,\n                                            ParameterValue = param ?? \"\"\n                                        });\n                                    }\n                                }\n                            }\n                        }\n\n                        // PlaceholderCount is not used by sync; it recomputes from RawJson.\n                        var raw = JsonConvert.SerializeObject(tpl);\n\n                        items.Add(new TemplateCatalogItem(\n                            Name: name,\n                            Language: language,\n                            Body: body,\n                            PlaceholderCount: 0,                 // sync derives counts from RawJson\n                            HasImageHeader: headerKind == \"image\",\n                            Buttons: buttons,\n                            Status: status,\n                            Category: category,\n                            ExternalId: externalId,\n                            RawJson: raw,\n                            SubCategory: subCat\n                        ));\n                    }\n                    catch\n                    {\n                        // swallow a bad item and continue\n                    }\n                }\n\n                // safe paging read\n                try { nextUrl = parsed?.paging?.next?.ToString(); }\n                catch { nextUrl = null; }\n                if (string.IsNullOrWhiteSpace(nextUrl)) break;\n            }\n\n            return items;\n        }\n\n        public Task<TemplateCatalogItem?> GetByNamePinnacleAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default)\n            => Task.FromResult<TemplateCatalogItem?>(null); // not used in sync path\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/ITemplatePreviewService.cs",
      "sha256": "a3a93cd8e29af752b16c49daadd82a6a419069bc5933177e663d030e47304f4e",
      "language": "csharp",
      "size": 306,
      "content": "using System;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public interface ITemplatePreviewService\n    {\n        Task<TemplatePreviewResponseDto> PreviewAsync(Guid businessId, TemplatePreviewRequestDto request);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/ITemplateSyncService.cs",
      "sha256": "4f3db9b43981973f160e937b9d1c3581dec0398d14d1fad47dd9151132b8725e",
      "language": "csharp",
      "size": 407,
      "content": "namespace xbytechat.api.WhatsAppSettings.Services\n{\n    public interface ITemplateSyncService\n    {\n        Task<TemplateSyncResult>\n            SyncBusinessTemplatesAsync(Guid businessId, \n            bool force = false,\n            bool onlyUpsert = false,\n            CancellationToken ct = default);\n    }\n    public record TemplateSyncResult(int Added, int Updated, int Skipped, DateTime SyncedAt);\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppPhoneNumberService.cs",
      "sha256": "c9bc6548dcd7992936780ef305a214e46e641f096d252bbda87cc42ed32cbfe9",
      "language": "csharp",
      "size": 1614,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Services\n{\n    public interface IWhatsAppPhoneNumberService\n    {\n        Task<IReadOnlyList<WhatsAppPhoneNumber>> ListAsync(Guid businessId, string provider, CancellationToken ct = default);\n\n        Task<WhatsAppPhoneNumber> UpsertAsync(\n            Guid businessId,\n            string provider,\n            string phoneNumberId,\n            string whatsAppBusinessNumber,\n            string? senderDisplayName,\n            bool? isActive = null,\n            bool? isDefault = null);\n\n        // Delete by entity Id (GUID)\n        Task<bool> DeleteAsync(Guid businessId, string provider, Guid id);\n\n        // Set one number as default (enforces ‚Äúone default per (business, provider)‚Äù)\n        Task<bool> SetDefaultAsync(Guid businessId, string provider, Guid id);\n\n        // Find a specific number by PhoneNumberId\n        Task<WhatsAppPhoneNumber?> FindAsync(Guid businessId, string provider, string phoneNumberId);\n\n        // Get the default number for a provider (or null if not set)\n        Task<WhatsAppPhoneNumber?> GetDefaultAsync(Guid businessId, string provider);\n\n        // in IWhatsAppPhoneNumberService\n        Task<(int Added, int Updated, int Total)> SyncFromProviderAsync(\n        Guid businessId,\n        WhatsAppSettingsDto setting,   // DTO\n        string provider,\n        CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppSenderService.cs",
      "sha256": "f761982b73ed97b35141f6f75b4e46bea7459bedc4cd72ba21927af07adec316",
      "language": "csharp",
      "size": 805,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    public interface IWhatsAppSenderService\n    {\n        Task<IReadOnlyList<WhatsAppSenderDto>> GetBusinessSendersAsync(Guid businessId, CancellationToken ct = default);\n        Task<(string Provider, string PhoneNumberId)?> ResolveSenderPairAsync(Guid businessId, string phoneNumberId, CancellationToken ct = default);\n\n        /// <summary>\n        /// Resolve a sender for outbound sends.\n        /// ESU constraint: PhoneNumberId MUST be resolved exclusively from WhatsAppPhoneNumbers.\n        /// </summary>\n        Task<WhatsAppSenderResolutionResult> ResolveDefaultSenderAsync(\n            Guid businessId,\n            string? providerHint = null,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppSettingsService.cs",
      "sha256": "060dfa057269e28ac2e8692ba1d4ce41593b6f6d402ac0d623da97a3a707650f",
      "language": "csharp",
      "size": 1066,
      "content": "using System;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public interface IWhatsAppSettingsService\n    {\n        Task SaveOrUpdateSettingAsync(SaveWhatsAppSettingDto dto);\n        Task<WhatsAppSettingsDto> GetSettingsByBusinessIdAsync(Guid businessId);\n        Task<bool> DeleteSettingsAsync(Guid businessId, CancellationToken ct = default);\n        Task<string> TestConnectionAsync(SaveWhatsAppSettingDto dto);\n        Task<string> GetCallbackUrlAsync(Guid businessId, string appBaseUrl);\n        Task<IReadOnlyList<WhatsAppSettingEntity>> GetAllForBusinessAsync(Guid businessId);\n        Task<WhatsAppSettingEntity?> GetSettingsByBusinessIdAndProviderAsync(Guid businessId, string provider);\n        \n        Task<WhatsAppConnectionSummaryDto?> GetConnectionSummaryAsync(Guid businessId);\n        Task<WhatsAppConnectionSummaryDto> RefreshConnectionSummaryAsync(Guid businessId);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppTemplateFetcherService.cs",
      "sha256": "14a7a41486ab4e78dc848576af52394b66a21a256d1edbf8e85f605c2e31e119",
      "language": "csharp",
      "size": 762,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public interface IWhatsAppTemplateFetcherService\n    {\n        Task<List<TemplateMetadataDto>> FetchTemplatesAsync(Guid businessId);\n        Task<List<TemplateForUIResponseDto>> FetchAllTemplatesAsync();\n        Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons);\n\n        Task<IReadOnlyList<TemplateMetaDto>> GetTemplatesMetaAsync(Guid businessId, string? provider = null);\n        Task<TemplateMetaDto?> GetTemplateMetaAsync(Guid businessId, string templateName, string? language = null, string? provider = null);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplatePreviewService.cs",
      "sha256": "bce7179ab5e46fe57fcab9220023da307250676d0f27bb999748ad11fc05179c",
      "language": "csharp",
      "size": 7248,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public sealed class TemplatePreviewService : ITemplatePreviewService\n    {\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n        private readonly ILogger<TemplatePreviewService> _log;\n\n        public TemplatePreviewService(IWhatsAppTemplateFetcherService fetcher, ILogger<TemplatePreviewService> log)\n        {\n            _fetcher = fetcher;\n            _log = log;\n        }\n\n        public async Task<TemplatePreviewResponseDto> PreviewAsync(Guid businessId, TemplatePreviewRequestDto request)\n        {\n            var resp = new TemplatePreviewResponseDto\n            {\n                TemplateName = request.TemplateName,\n                Language = request.Language\n            };\n\n            // 1) Fetch meta (from our catalog)\n            var meta = await _fetcher.GetTemplateMetaAsync(\n                businessId,\n                request.TemplateName,\n                language: request.Language,\n                provider: request.Provider\n            );\n\n            if (meta == null)\n            {\n                resp.FoundTemplate = false;\n                resp.Errors.Add(\"Template not found for this business/provider/language.\");\n                return resp;\n            }\n\n            resp.FoundTemplate = true;\n            resp.Language = meta.Language;\n            resp.HasHeaderMedia = meta.HasHeaderMedia;\n            resp.HeaderType = meta.HeaderType ?? \"\";\n\n            // 2) Placeholder validation\n            var required = Math.Max(0, meta.BodyPlaceholders?.Count ?? 0);\n            var provided = request.TemplateParameters?.Count ?? 0;\n\n            resp.RequiredPlaceholderCount = required;\n            resp.ProvidedPlaceholderCount = provided;\n\n            if (provided < required)\n            {\n                for (int i = provided + 1; i <= required; i++) resp.MissingPlaceholderIndices.Add(i);\n                resp.Errors.Add($\"Missing {required - provided} body parameter(s).\");\n            }\n            else if (provided > required)\n            {\n                resp.Warnings.Add($\"Ignored {provided - required} extra body parameter(s).\");\n            }\n\n            // 3) Build provider-like components preview\n            var comps = new List<object>();\n\n            // Header (image) preview only when template supports it and caller provided a URL\n            if (meta.HasHeaderMedia && !string.IsNullOrWhiteSpace(request.HeaderImageUrl))\n            {\n                comps.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                        new { type = \"image\", image = new { link = request.HeaderImageUrl } }\n                    }\n                });\n            }\n\n            // Body parameters: trim/pad to 'required'\n            if (required > 0)\n            {\n                var src = (request.TemplateParameters ?? new List<string>()).Select(s => s ?? string.Empty).ToList();\n                if (src.Count > required) src = src.Take(required).ToList();\n                while (src.Count < required) src.Add(string.Empty);\n\n                var bodyParams = src.Select(p => (object)new { type = \"text\", text = p }).ToArray();\n                comps.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // 4) Buttons validation (only dynamic URL buttons require parameters in payload)\n            // Template order is authoritative. We'll check at most 3.\n            var inputByPos = (request.Buttons ?? new List<PreviewButtonInputDto>())\n                             .Where(b => b.Position >= 1 && b.Position <= 3)\n                             .ToDictionary(b => b.Position, b => b);\n\n            var templateButtons = (meta.Buttons ?? new List<TemplateButtonMeta>())\n                                  .OrderBy(b => b.Order)\n                                  .Take(3)\n                                  .ToList();\n\n            for (int i = 0; i < templateButtons.Count; i++)\n            {\n                var tb = templateButtons[i];\n                var subType = (tb.Type ?? tb.Text ?? \"\").ToUpperInvariant(); // tb.Type from Step 2.1 mapper; sub-type is treated as URL family\n                var paramPattern = tb.Value ?? \"\"; // came from ButtonsJson ParameterValue (may contain \"{{1}}\")\n                var isUrlFamily = (tb.Type ?? \"\").Equals(\"URL\", StringComparison.OrdinalIgnoreCase);\n                var isDynamic = isUrlFamily && paramPattern.Contains(\"{{\");\n\n                if (!isUrlFamily || !isDynamic)\n                {\n                    // For static buttons (or non-URL), we preview a button component without parameters\n                    comps.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = \"url\",\n                        [\"index\"] = i.ToString()\n                    });\n                    continue;\n                }\n\n                // Dynamic URL ‚Üí expect input at this position\n                if (!inputByPos.TryGetValue(i + 1, out var userBtn) || string.IsNullOrWhiteSpace(userBtn.Value))\n                {\n                    resp.Errors.Add($\"Dynamic URL required for button position {i + 1} but no value was provided.\");\n                    continue;\n                }\n\n                var value = userBtn.Value.Trim();\n\n                // Accept absolute http/https and tel/wa deep links in preview\n                var ok = LooksValidDestination(value);\n                if (!ok)\n                {\n                    resp.Errors.Add($\"Button {i + 1} destination must be absolute http/https or tel/wa link.\");\n                    continue;\n                }\n\n                // NOTE: In live send we tokenise tracked URLs. For preview we show the **value** directly.\n                var parameters = new[] { new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = value } };\n\n                comps.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(),\n                    [\"parameters\"] = parameters\n                });\n            }\n\n            resp.ProviderComponentsPreview = comps;\n            return resp;\n        }\n\n        private static bool LooksValidDestination(string input)\n        {\n            if (string.IsNullOrWhiteSpace(input)) return false;\n            var s = input.Trim();\n            if (s.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase)) return true;\n\n            if (Uri.TryCreate(s, UriKind.Absolute, out var uri))\n                return uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase)\n                    || uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase);\n\n            return false;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplateSyncService.cs",
      "sha256": "380b47e260fe05324abaf4250ec585d6e9bcb93c47eec90f76d817cc9b75ce02",
      "language": "csharp",
      "size": 34894,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.Providers;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.WhatsAppSettings.Helpers; // canonical parser\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Newtonsoft.Json;\nusing Polly.Caching;\nusing Serilog;\nusing System.Buffers;\nusing System.Text.RegularExpressions;\n\npublic sealed class TemplateSyncService : ITemplateSyncService\n{\n    private readonly AppDbContext _db;\n    private readonly MetaTemplateCatalogProvider _meta;\n    private readonly PinnacleTemplateCatalogProvider _pinnacle;\n    private readonly ILogger<TemplateSyncService> _log;\n\n    private static readonly TimeSpan TTL = TimeSpan.FromHours(12);\n\n    public TemplateSyncService(\n        AppDbContext db,\n        MetaTemplateCatalogProvider meta,\n        PinnacleTemplateCatalogProvider pinnacle,\n        ILogger<TemplateSyncService> log)\n    {\n        _db = db; _meta = meta; _pinnacle = pinnacle; _log = log;\n    }\n\n    //public async Task<TemplateSyncResult> SyncBusinessTemplatesAsync(Guid businessId, bool force = false, CancellationToken ct = default)\n    //{\n    //    var setting = await _db.WhatsAppSettings\n    //        .AsNoTracking()\n    //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive, ct)\n    //        ?? throw new InvalidOperationException(\"Active WhatsApp settings not found.\");\n\n    //    var now = DateTime.UtcNow;\n\n    //    if (!force)\n    //    {\n    //        var recent = await _db.WhatsAppTemplates\n    //            .AsNoTracking()\n    //            .Where(t => t.BusinessId == businessId)\n    //            .OrderByDescending(t => t.LastSyncedAt)\n    //            .Select(t => t.LastSyncedAt)\n    //            .FirstOrDefaultAsync(ct);\n\n    //        if (recent != default && now - recent < TTL)\n    //        {\n    //            _log.LogInformation(\"‚è≠Ô∏è Skipping sync for {BusinessId}; TTL not expired.\", businessId);\n    //            return new TemplateSyncResult(0, 0, 0, recent);\n    //        }\n    //    }\n\n    //    // Canonical provider (UPPER)\n    //    var providerKey = ((setting.Provider ?? \"META_CLOUD\").Trim()).ToUpperInvariant();\n\n    //    IReadOnlyList<TemplateCatalogItem> incoming = providerKey switch\n    //    {\n    //        \"META_CLOUD\" => await _meta.ListMetaAsync(setting, ct),\n    //        \"PINNACLE\" => await _pinnacle.ListPinnacleAsync(setting, ct),\n    //        _ => Array.Empty<TemplateCatalogItem>()\n    //    };\n    //    incoming ??= Array.Empty<TemplateCatalogItem>();\n\n    //    // Preload existing provider rows for this business\n    //    var existing = await _db.WhatsAppTemplates\n    //        .Where(t => t.BusinessId == businessId && t.Provider == providerKey)\n    //        .ToListAsync(ct);\n\n    //    // Fast lookup maps\n    //    var byTemplateId = existing\n    //        .Where(e => !string.IsNullOrWhiteSpace(e.TemplateId))\n    //        .ToDictionary(e => e.TemplateId!, e => e, StringComparer.Ordinal);\n\n    //    //static string NLKey(string name, string? lang) => $\"{name}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n    //    static string NLKey(string? name, string? lang)\n    //=> $\"{(name ?? \"\").Trim().ToLowerInvariant()}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n    //    var byNameLang = existing.ToDictionary(\n    //        e => NLKey(e.Name, e.LanguageCode),\n    //        e => e,\n    //        StringComparer.Ordinal);\n\n    //    int added = 0, updated = 0, unchanged = 0;\n\n    //    var seenTemplateIds = new HashSet<string>(StringComparer.Ordinal);\n    //    var seenNLKeys = new HashSet<string>(StringComparer.Ordinal);\n\n    //    // Helpers\n    //    static string NK(string? k) => string.IsNullOrWhiteSpace(k) ? \"none\" : k.Trim().ToLowerInvariant();\n    //    static bool IsIdentifier(string? s) => !string.IsNullOrWhiteSpace(s) && Regex.IsMatch(s!, @\"^[A-Za-z_][A-Za-z0-9_]*$\");\n\n    //    foreach (var it in incoming)\n    //    {\n    //        ct.ThrowIfCancellationRequested();\n\n    //        var extId = it.ExternalId?.Trim();\n    //        var lang = string.IsNullOrWhiteSpace(it.Language) ? \"en_US\" : it.Language.Trim();\n    //        var nlKey = NLKey(it.Name, lang);\n\n    //        seenNLKeys.Add(nlKey);\n    //        if (!string.IsNullOrWhiteSpace(extId)) seenTemplateIds.Add(extId!);\n\n    //        // ‚Äî‚Äî Parse/summarize JSON into our canonical fields\n    //        var dto = TemplateJsonHelper.SummarizeDetailed(it.RawJson, it.Body);\n\n    //        var headerKindNorm = NK(dto.HeaderKind);\n    //        var headerTextToPersist = headerKindNorm == \"text\"\n    //            ? (string.IsNullOrWhiteSpace(dto.HeaderText) ? null : dto.HeaderText!.Trim())\n    //            : null;\n\n    //        var paramFormat = (dto.ParameterFormat ?? \"UNKNOWN\").Trim().ToUpperInvariant();\n\n    //        // Keep only real placeholders (drop \"{{}}\"). Count by location.\n    //        var occAll = (dto.Placeholders ?? new List<PlaceholderOccurrence>()).ToList();\n    //        var occFiltered = occAll.Where(o =>\n    //        {\n    //            var raw = o.Raw?.Trim();\n    //            if (string.Equals(raw, \"{{}}\", StringComparison.Ordinal)) return false;\n\n    //            if (paramFormat == \"POSITIONAL\") return o.Index is >= 1;\n    //            if (paramFormat == \"NAMED\") return IsIdentifier(o.Name);\n\n    //            return false;\n    //        }).ToList();\n\n    //        int headerVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Header);\n    //        int bodyVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Body);\n    //        int totalVars = occFiltered.Count; // header + body + buttons (filtered)\n\n    //        var combinedBody = dto.CombinedPreviewBody ?? string.Empty;\n    //        var bodyPreview = combinedBody.Length > 240 ? combinedBody[..240] : combinedBody;\n\n    //        bool requiresMediaHeader = headerKindNorm is \"image\" or \"video\" or \"document\";\n\n    //        // Named parameter keys (for NAMED format)\n    //        var namedKeys = occFiltered\n    //            .Where(p => !string.IsNullOrWhiteSpace(p.Name))\n    //            .Select(p => p.Name!.Trim())\n    //            .Where(IsIdentifier)\n    //            .Distinct(StringComparer.OrdinalIgnoreCase)\n    //            .ToArray();\n    //        string? namedKeysJson = namedKeys.Length > 0 ? JsonConvert.SerializeObject(namedKeys) : null;\n\n    //        // Placeholder map (provider-specific): keep null unless you compute elsewhere\n    //        string? placeholderMapJson = null;\n\n    //        // Buttons summary (prefer explicit from provider)\n    //        // Buttons summary (prefer explicit from provider)\n    //        string? urlButtonsJson = null;\n    //        int quickReplyCount = 0;\n    //        bool hasPhoneButton = false;\n\n    //        if (it.Buttons is { Count: > 0 })\n    //        {\n    //            // Persist only what's needed downstream: the URL button positions.\n    //            // Shape: [{ \"index\": 0 }, { \"index\": 1 }, ...]\n    //            var urlButtons = new List<object>(capacity: it.Buttons.Count);\n\n    //            foreach (var b in it.Buttons)\n    //            {\n    //                var sub = (b.SubType ?? \"\").Trim().ToLowerInvariant();\n\n    //                if (sub == \"quick_reply\") quickReplyCount++;\n    //                if (sub == \"phone_number\") hasPhoneButton = true;\n\n    //                if (sub == \"url\")\n    //                {\n    //                    urlButtons.Add(new\n    //                    {\n    //                        index = b.Index\n    //                        // no b.Parameters; not present on ButtonMetadataDto\n    //                    });\n    //                }\n    //            }\n\n    //            urlButtonsJson = urlButtons.Count > 0 ? JsonConvert.SerializeObject(urlButtons) : null;\n    //        }\n\n\n    //        var status = string.IsNullOrWhiteSpace(it.Status) ? \"APPROVED\" : it.Status!.Trim().ToUpperInvariant();\n\n    //        // ‚Äî‚Äî Locate existing row (by TemplateId first, else Name+Lang)\n    //        WhatsAppTemplate? row = null;\n\n    //        if (!string.IsNullOrWhiteSpace(extId) && byTemplateId.TryGetValue(extId!, out var foundById))\n    //        {\n    //            row = foundById;\n    //        }\n    //        else if (byNameLang.TryGetValue(nlKey, out var foundByNL))\n    //        {\n    //            row = foundByNL;\n\n    //            // backfill TemplateId if we now have it\n    //            if (!string.IsNullOrWhiteSpace(extId) && string.IsNullOrWhiteSpace(row.TemplateId))\n    //            {\n    //                row.TemplateId = extId;\n    //                updated++;\n    //            }\n    //        }\n\n    //        if (row is null)\n    //        {\n    //            // INSERT\n    //            var newRow = new WhatsAppTemplate\n    //            {\n    //                Id = Guid.NewGuid(),\n    //                BusinessId = businessId,\n    //                Provider = providerKey,\n    //                TemplateId = extId,\n    //                Name = it.Name,\n    //                LanguageCode = lang,\n    //                Status = status,\n    //                Category = it.Category,\n    //                SubCategory = null,\n\n    //                RawJson = it.RawJson ?? \"{}\",\n\n    //                ParameterFormat = paramFormat,\n    //                HeaderKind = headerKindNorm,\n    //                HeaderText = headerTextToPersist,\n    //                Body = combinedBody,\n    //                BodyPreview = bodyPreview,\n\n    //                RequiresMediaHeader = requiresMediaHeader,\n\n    //                BodyVarCount = bodyVars,\n    //                HeaderTextVarCount = headerVars,\n    //                TotalTextParamCount = totalVars,\n\n    //                UrlButtons = urlButtonsJson,\n    //                QuickReplyCount = quickReplyCount,\n    //                HasPhoneButton = hasPhoneButton,\n\n    //                NamedParamKeys = namedKeysJson,\n    //                PlaceholderMap = placeholderMapJson,\n\n    //                IsActive = true,\n    //                CreatedAt = now,\n    //                UpdatedAt = now,\n    //                LastSyncedAt = now\n    //            };\n\n    //            _db.WhatsAppTemplates.Add(newRow);\n    //            added++;\n\n    //            if (!string.IsNullOrWhiteSpace(extId)) byTemplateId[extId!] = newRow;\n    //            byNameLang[nlKey] = newRow;\n    //        }\n    //        else\n    //        {\n    //            // UPDATE (branch-predicated, no ref locals)\n    //            bool changed = false;\n\n    //            if (!string.Equals(row.Status, status, StringComparison.Ordinal))\n    //            { row.Status = status; changed = true; }\n\n    //            if (!string.Equals(row.Category, it.Category, StringComparison.Ordinal))\n    //            { row.Category = it.Category; changed = true; }\n\n    //            var newRaw = it.RawJson ?? \"{}\";\n    //            if (!string.Equals(row.RawJson, newRaw, StringComparison.Ordinal))\n    //            { row.RawJson = newRaw; changed = true; }\n\n    //            if (!string.Equals(row.ParameterFormat, paramFormat, StringComparison.Ordinal))\n    //            { row.ParameterFormat = paramFormat; changed = true; }\n\n    //            if (!string.Equals(row.HeaderKind, headerKindNorm, StringComparison.Ordinal))\n    //            { row.HeaderKind = headerKindNorm; changed = true; }\n\n    //            var existingHeaderText = string.IsNullOrWhiteSpace(row.HeaderText) ? null : row.HeaderText!.Trim();\n    //            if (!string.Equals(existingHeaderText, headerTextToPersist, StringComparison.Ordinal))\n    //            { row.HeaderText = headerTextToPersist; changed = true; }\n\n    //            if (!string.Equals(row.Body ?? string.Empty, combinedBody, StringComparison.Ordinal))\n    //            { row.Body = combinedBody; changed = true; }\n\n    //            if (!string.Equals(row.BodyPreview ?? string.Empty, bodyPreview ?? string.Empty, StringComparison.Ordinal))\n    //            { row.BodyPreview = bodyPreview; changed = true; }\n\n    //            if (row.RequiresMediaHeader != requiresMediaHeader)\n    //            { row.RequiresMediaHeader = requiresMediaHeader; changed = true; }\n\n    //            if (row.BodyVarCount != bodyVars) { row.BodyVarCount = bodyVars; changed = true; }\n    //            if (row.HeaderTextVarCount != headerVars) { row.HeaderTextVarCount = headerVars; changed = true; }\n    //            if (row.TotalTextParamCount != totalVars) { row.TotalTextParamCount = totalVars; changed = true; }\n\n    //            if (!string.Equals(row.UrlButtons ?? \"\", urlButtonsJson ?? \"\", StringComparison.Ordinal))\n    //            { row.UrlButtons = urlButtonsJson; changed = true; }\n\n    //            if (row.QuickReplyCount != quickReplyCount) { row.QuickReplyCount = quickReplyCount; changed = true; }\n    //            if (row.HasPhoneButton != hasPhoneButton) { row.HasPhoneButton = hasPhoneButton; changed = true; }\n\n    //            if (!string.Equals(row.NamedParamKeys ?? \"\", namedKeysJson ?? \"\", StringComparison.Ordinal))\n    //            { row.NamedParamKeys = namedKeysJson; changed = true; }\n\n    //            if (!string.Equals(row.PlaceholderMap ?? \"\", placeholderMapJson ?? \"\", StringComparison.Ordinal))\n    //            { row.PlaceholderMap = placeholderMapJson; changed = true; }\n\n    //            row.IsActive = true;\n    //            row.LastSyncedAt = now;\n\n    //            if (changed) { row.UpdatedAt = now; updated++; } else { unchanged++; }\n    //        }\n    //    }\n\n    //    // Deactivate templates that disappeared from provider (cheap set membership)\n    //    if (incoming.Count > 0)\n    //    {\n    //        foreach (var e in existing)\n    //        {\n    //            bool stillThere =\n    //                (!string.IsNullOrWhiteSpace(e.TemplateId) && seenTemplateIds.Contains(e.TemplateId)) ||\n    //                seenNLKeys.Contains(NLKey(e.Name, e.LanguageCode));\n\n    //            if (!stillThere && e.IsActive)\n    //            {\n    //                e.IsActive = false;\n    //                e.LastSyncedAt = now;\n    //                e.UpdatedAt = now;\n    //                updated++;\n    //            }\n    //        }\n    //    }\n\n    //    await _db.SaveChangesAsync(ct);\n    //    return new TemplateSyncResult(added, updated, unchanged, now);\n    //}\n\n    // NOTE: expects fields/services available in your class:\n    // _db (AppDbContext), _log (ILogger), _meta, _pinnacle, TTL (TimeSpan)\n\n    public async Task<TemplateSyncResult> SyncBusinessTemplatesAsync(\n     Guid businessId,\n     bool force = false,\n     bool onlyUpsert = false, // NEW: when true, do not deactivate missing rows\n     CancellationToken ct = default)\n    {\n        var setting = await _db.WhatsAppSettings\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive, ct)\n            ?? throw new InvalidOperationException(\"Active WhatsApp settings not found.\");\n\n        var now = DateTime.UtcNow;\n\n        // Canonical provider key (UPPER)\n        var providerKey = ((setting.Provider ?? \"META_CLOUD\").Trim()).ToUpperInvariant();\n\n        // TTL check is provider-scoped; will be bypassed by force:true from the button\n        if (!force)\n        {\n            var recent = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.Provider.ToUpper() == providerKey)\n                .OrderByDescending(t => t.LastSyncedAt)\n                .Select(t => t.LastSyncedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (recent != default && now - recent < TTL)\n            {\n                _log.LogInformation(\"‚è≠Ô∏è Skipping template sync (business={BusinessId}, provider={Provider}) ‚Äî TTL not expired. Last={Last}, TTL={TTLmins}m\",\n                    businessId, providerKey, recent, TTL.TotalMinutes);\n                return new TemplateSyncResult(0, 0, 0, recent);\n            }\n        }\n\n        // Fetch from provider\n        IReadOnlyList<TemplateCatalogItem> incoming = providerKey switch\n        {\n            \"META_CLOUD\" => await _meta.ListMetaAsync(setting, ct),\n            \"PINNACLE\" => await _pinnacle.ListPinnacleAsync(setting, ct),\n            _ => Array.Empty<TemplateCatalogItem>()\n        };\n        incoming ??= Array.Empty<TemplateCatalogItem>();\n\n        _log.LogInformation(\"[TplSync] Provider={Provider} fetched={Count}\", providerKey, incoming.Count);\n\n        // Load existing rows for this provider (normalize Provider case)\n        var existing = await _db.WhatsAppTemplates\n            .Where(t => t.BusinessId == businessId && t.Provider.ToUpper() == providerKey)\n            .ToListAsync(ct);\n\n        // Fast lookup maps\n        var byTemplateId = existing\n            .Where(e => !string.IsNullOrWhiteSpace(e.TemplateId))\n            .ToDictionary(e => e.TemplateId!, e => e, StringComparer.Ordinal);\n\n        static string NLKey(string? name, string? lang)\n            => $\"{(name ?? \"\").Trim().ToLowerInvariant()}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n\n        var byNameLang = existing.ToDictionary(\n            e => NLKey(e.Name, e.LanguageCode),\n            e => e,\n            StringComparer.Ordinal);\n\n        int added = 0, updated = 0, unchanged = 0;\n\n        var seenTemplateIds = new HashSet<string>(StringComparer.Ordinal);\n        var seenNLKeys = new HashSet<string>(StringComparer.Ordinal);\n\n        // Helpers\n        static string NK(string? k) => string.IsNullOrWhiteSpace(k) ? \"none\" : k.Trim().ToLowerInvariant();\n        static bool IsIdentifier(string? s) => !string.IsNullOrWhiteSpace(s) && Regex.IsMatch(s!, @\"^[A-Za-z_][A-Za-z0-9_]*$\");\n\n        foreach (var it in incoming)\n        {\n            ct.ThrowIfCancellationRequested();\n\n            var extId = it.ExternalId?.Trim();\n            var lang = string.IsNullOrWhiteSpace(it.Language) ? \"en_US\" : it.Language.Trim();\n            var nlKey = NLKey(it.Name, lang);\n\n            seenNLKeys.Add(nlKey);\n            if (!string.IsNullOrWhiteSpace(extId)) seenTemplateIds.Add(extId!);\n\n            // Parse & summarize provider JSON\n            var dto = TemplateJsonHelper.SummarizeDetailed(it.RawJson, it.Body);\n\n            var headerKindNorm = NK(dto.HeaderKind);\n            var headerTextToPersist = headerKindNorm == \"text\"\n                ? (string.IsNullOrWhiteSpace(dto.HeaderText) ? null : dto.HeaderText!.Trim())\n                : null;\n\n            var paramFormat = (dto.ParameterFormat ?? \"UNKNOWN\").Trim().ToUpperInvariant();\n\n            // Real placeholders only\n            var occAll = (dto.Placeholders ?? new List<PlaceholderOccurrence>()).ToList();\n            var occFiltered = occAll.Where(o =>\n            {\n                var raw = o.Raw?.Trim();\n                if (string.Equals(raw, \"{{}}\", StringComparison.Ordinal)) return false;\n\n                if (paramFormat == \"POSITIONAL\") return o.Index is >= 1;\n                if (paramFormat == \"NAMED\") return IsIdentifier(o.Name);\n                return false;\n            }).ToList();\n\n            int headerVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Header);\n            int bodyVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Body);\n            int totalVars = occFiltered.Count;\n\n            var combinedBody = dto.CombinedPreviewBody ?? string.Empty;\n            var bodyPreview = combinedBody.Length > 240 ? combinedBody[..240] : combinedBody;\n\n            bool requiresMediaHeader = headerKindNorm is \"image\" or \"video\" or \"document\";\n\n            // Named param keys\n            var namedKeys = occFiltered\n                .Where(p => !string.IsNullOrWhiteSpace(p.Name))\n                .Select(p => p.Name!.Trim())\n                .Where(IsIdentifier)\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .ToArray();\n            string? namedKeysJson = namedKeys.Length > 0 ? JsonConvert.SerializeObject(namedKeys) : null;\n\n            // Buttons summary\n            string? urlButtonsJson = null;\n            int quickReplyCount = 0;\n            bool hasPhoneButton = false;\n\n            if (it.Buttons is { Count: > 0 })\n            {\n                var urlButtons = new List<object>(capacity: it.Buttons.Count);\n\n                foreach (var b in it.Buttons)\n                {\n                    var sub = (b.SubType ?? \"\").Trim().ToLowerInvariant();\n\n                    if (sub == \"quick_reply\") quickReplyCount++;\n                    if (sub == \"voice_call\") hasPhoneButton = true;\n\n                    if (sub == \"url\")\n                    {\n                        urlButtons.Add(new { index = b.Index });\n                    }\n                }\n\n                urlButtonsJson = urlButtons.Count > 0 ? JsonConvert.SerializeObject(urlButtons) : null;\n            }\n\n            var status = string.IsNullOrWhiteSpace(it.Status) ? \"APPROVED\" : it.Status!.Trim().ToUpperInvariant();\n\n            // Locate existing (TemplateId first, else Name+Lang)\n            WhatsAppTemplate? row = null;\n\n            if (!string.IsNullOrWhiteSpace(extId) && byTemplateId.TryGetValue(extId!, out var foundById))\n            {\n                row = foundById;\n            }\n            else if (byNameLang.TryGetValue(nlKey, out var foundByNL))\n            {\n                row = foundByNL;\n\n                // backfill TemplateId if present now\n                if (!string.IsNullOrWhiteSpace(extId) && string.IsNullOrWhiteSpace(row.TemplateId))\n                {\n                    row.TemplateId = extId;\n                    updated++;\n                }\n            }\n\n            if (row is null)\n            {\n                // INSERT\n                var newRow = new WhatsAppTemplate\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = providerKey,\n                    TemplateId = extId,\n                    Name = it.Name,\n                    LanguageCode = lang,\n                    Status = status,\n                    Category = it.Category,\n                    SubCategory = null,\n\n                    RawJson = it.RawJson ?? \"{}\",\n\n                    ParameterFormat = paramFormat,\n                    HeaderKind = headerKindNorm,\n                    HeaderText = headerTextToPersist,\n                    Body = combinedBody,\n                    BodyPreview = bodyPreview,\n\n                    RequiresMediaHeader = requiresMediaHeader,\n\n                    BodyVarCount = bodyVars,\n                    HeaderTextVarCount = headerVars,\n                    TotalTextParamCount = totalVars,\n\n                    UrlButtons = urlButtonsJson,\n                    QuickReplyCount = quickReplyCount,\n                    HasPhoneButton = hasPhoneButton,\n\n                    NamedParamKeys = namedKeysJson,\n                    PlaceholderMap = null,\n\n                    IsActive = true,\n                    CreatedAt = now,\n                    UpdatedAt = now,\n                    LastSyncedAt = now\n                };\n\n                _db.WhatsAppTemplates.Add(newRow);\n                added++;\n\n                if (!string.IsNullOrWhiteSpace(extId)) byTemplateId[extId!] = newRow;\n                byNameLang[nlKey] = newRow;\n            }\n            else\n            {\n                // UPDATE\n                bool changed = false;\n\n                if (!string.Equals(row.Status, status, StringComparison.Ordinal))\n                { row.Status = status; changed = true; }\n\n                if (!string.Equals(row.Category, it.Category, StringComparison.Ordinal))\n                { row.Category = it.Category; changed = true; }\n\n                var newRaw = it.RawJson ?? \"{}\";\n                if (!string.Equals(row.RawJson, newRaw, StringComparison.Ordinal))\n                { row.RawJson = newRaw; changed = true; }\n\n                if (!string.Equals(row.ParameterFormat, paramFormat, StringComparison.Ordinal))\n                { row.ParameterFormat = paramFormat; changed = true; }\n\n                if (!string.Equals(row.HeaderKind, headerKindNorm, StringComparison.Ordinal))\n                { row.HeaderKind = headerKindNorm; changed = true; }\n\n                var existingHeaderText = string.IsNullOrWhiteSpace(row.HeaderText) ? null : row.HeaderText!.Trim();\n                if (!string.Equals(existingHeaderText, headerTextToPersist, StringComparison.Ordinal))\n                { row.HeaderText = headerTextToPersist; changed = true; }\n\n                if (!string.Equals(row.Body ?? string.Empty, combinedBody, StringComparison.Ordinal))\n                { row.Body = combinedBody; changed = true; }\n\n                if (!string.Equals(row.BodyPreview ?? string.Empty, bodyPreview ?? string.Empty, StringComparison.Ordinal))\n                { row.BodyPreview = bodyPreview; changed = true; }\n\n                if (row.RequiresMediaHeader != requiresMediaHeader)\n                { row.RequiresMediaHeader = requiresMediaHeader; changed = true; }\n\n                if (row.BodyVarCount != bodyVars) { row.BodyVarCount = bodyVars; changed = true; }\n                if (row.HeaderTextVarCount != headerVars) { row.HeaderTextVarCount = headerVars; changed = true; }\n                if (row.TotalTextParamCount != totalVars) { row.TotalTextParamCount = totalVars; changed = true; }\n\n                if (!string.Equals(row.UrlButtons ?? \"\", urlButtonsJson ?? \"\", StringComparison.Ordinal))\n                { row.UrlButtons = urlButtonsJson; changed = true; }\n\n                if (row.QuickReplyCount != quickReplyCount) { row.QuickReplyCount = quickReplyCount; changed = true; }\n                if (row.HasPhoneButton != hasPhoneButton) { row.HasPhoneButton = hasPhoneButton; changed = true; }\n\n                if (!string.Equals(row.NamedParamKeys ?? \"\", namedKeysJson ?? \"\", StringComparison.Ordinal))\n                { row.NamedParamKeys = namedKeysJson; changed = true; }\n\n                // PlaceholderMap remains as-is unless you compute it elsewhere\n\n                row.IsActive = true;\n                row.LastSyncedAt = now;\n\n                if (changed) { row.UpdatedAt = now; updated++; } else { unchanged++; }\n            }\n        }\n\n        // ‚õîÔ∏è Deactivation is skipped when onlyUpsert == true\n        if (!onlyUpsert && incoming.Count > 0)\n        {\n            foreach (var e in existing)\n            {\n                bool stillThere =\n                    (!string.IsNullOrWhiteSpace(e.TemplateId) && seenTemplateIds.Contains(e.TemplateId)) ||\n                    seenNLKeys.Contains(NLKey(e.Name, e.LanguageCode));\n\n                if (!stillThere && e.IsActive)\n                {\n                    e.IsActive = false;\n                    e.LastSyncedAt = now;\n                    e.UpdatedAt = now;\n                    updated++;\n                }\n            }\n        }\n\n        await _db.SaveChangesAsync(ct);\n\n        _log.LogInformation(\"[TplSync] Done (business={BusinessId}, provider={Provider}) added={Added} updated={Updated} unchanged={Unchanged} onlyUpsert={OnlyUpsert}\",\n            businessId, providerKey, added, updated, unchanged, onlyUpsert);\n\n        return new TemplateSyncResult(added, updated, unchanged, now);\n    }\n\n\n    private static (string HeaderKind, string CombinedBody, int PlaceholderCount)\n                    ComputeFromRawOrFallback(TemplateCatalogItem it)\n    {\n        var (headerKind, combinedBody, placeholderCount) =\n            TemplateJsonHelper.Summarize(it.RawJson, it.Body);\n\n        return (string.IsNullOrWhiteSpace(headerKind) ? \"none\" : headerKind,\n                combinedBody ?? string.Empty,\n                placeholderCount);\n    }\n\n    ///\n    // Add inside TemplateSyncService class\n    private static (string headerKind, bool requiresMedia, string? headerText,\n                   string parameterFormat, int bodyVars, int headerVars, int totalVars,\n                   string? namedKeysJson, string? placeholderMapJson,\n                   string? body, string? bodyPreview,\n                   string? urlButtonsJson, int quickReplyCount, bool hasPhoneButton)\n    SummarizeFromRawJson(string rawJson, string? bodyFallback)\n    {\n        // Uses your existing canonical JSON helper if present; otherwise lightweight parse.\n        // Prefer TemplateJsonHelper if it exists in your project.\n        try\n        {\n            // TemplateJsonHelper.Summarize should already compute combined details in your repo.\n            // Replace this block with that call if available to keep logic single-sourced.\n            // var s = TemplateJsonHelper.Summarize(rawJson, bodyFallback);\n            // return (... map from s ...);\n\n            var jo = Newtonsoft.Json.Linq.JObject.Parse(string.IsNullOrWhiteSpace(rawJson) ? \"{}\" : rawJson);\n            var components = (Newtonsoft.Json.Linq.JArray?)jo[\"components\"] ?? new();\n            string headerKind = \"none\";\n            string? headerText = null;\n            string parameterFormat = \"UNKNOWN\";\n\n            // HEADER detection\n            var header = components.FirstOrDefault(c =>\n                string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase)) as Newtonsoft.Json.Linq.JObject;\n\n            var headerFormat = ((string?)header?[\"format\"])?.ToLowerInvariant();\n            headerKind = headerFormat switch\n            {\n                \"image\" => \"image\",\n                \"video\" => \"video\",\n                \"document\" => \"document\",\n                \"text\" => \"text\",\n                \"location\" => \"location\",\n                _ => \"none\"\n            };\n            if (string.Equals(headerKind, \"text\", StringComparison.OrdinalIgnoreCase))\n                headerText = (string?)header?[\"text\"];\n\n            bool requiresMedia = headerKind is \"image\" or \"video\" or \"document\";\n\n            // BODY\n            var body = (string?)components.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BODY\", StringComparison.OrdinalIgnoreCase))?[\"text\"]\n                       ?? bodyFallback ?? string.Empty;\n            var bodyPreview = body?.Length > 240 ? body.Substring(0, 240) : body;\n\n            // NAMED vs POSITIONAL slots (rough heuristic: if there are explicit named keys, mark NAMED)\n            // Count positional: {{1}}, {{ 2 }}, etc. Count named blank tokens: {{}} as a slot marker.\n            var positional = System.Text.RegularExpressions.Regex.Matches(body ?? \"\", @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n            var namedBlank = System.Text.RegularExpressions.Regex.Matches(body ?? \"\", @\"\\{\\{\\s*\\}\\}\").Count;\n\n            // Collect named param keys if present in RAW JSON (Meta has examples under example/parameters/name)\n            var namedKeys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var comp in components.OfType<Newtonsoft.Json.Linq.JObject>())\n            {\n                var paramsArr = comp[\"example\"]?[\"parameters\"] as Newtonsoft.Json.Linq.JArray;\n                if (paramsArr != null)\n                {\n                    foreach (var p in paramsArr.OfType<Newtonsoft.Json.Linq.JObject>())\n                    {\n                        var name = (string?)p[\"key\"] ?? (string?)p[\"name\"];\n                        if (!string.IsNullOrWhiteSpace(name)) namedKeys.Add(name!);\n                    }\n                }\n            }\n            parameterFormat = namedKeys.Count > 0 ? \"NAMED\" : (positional > 0 ? \"POSITIONAL\" : \"UNKNOWN\");\n\n            // Header text variable count (rough: treat {{}}/positional in headerText)\n            var headerVars = 0;\n            if (!string.IsNullOrEmpty(headerText))\n            {\n                headerVars += System.Text.RegularExpressions.Regex.Matches(headerText, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n                headerVars += System.Text.RegularExpressions.Regex.Matches(headerText, @\"\\{\\{\\s*\\}\\}\").Count;\n            }\n\n            var bodyVars = positional + namedBlank;\n            var totalVars = bodyVars + headerVars;\n\n            // Buttons ‚Üí collect url buttons + quick replies + phone button presence\n            var buttons = components.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BUTTONS\", StringComparison.OrdinalIgnoreCase)) as Newtonsoft.Json.Linq.JObject;\n            var btnArr = buttons?[\"buttons\"] as Newtonsoft.Json.Linq.JArray ?? new();\n\n            var quickReplyCount = 0;\n            var hasPhoneButton = false;\n            var urlButtonsList = new List<Newtonsoft.Json.Linq.JObject>();\n\n            foreach (var b in btnArr.OfType<Newtonsoft.Json.Linq.JObject>())\n            {\n                var sub = ((string?)b[\"sub_type\"])?.ToLowerInvariant();\n                if (sub == \"quick_reply\") quickReplyCount++;\n                if (sub == \"phone_number\") hasPhoneButton = true;\n                if (sub == \"url\")\n                {\n                    // retain minimal facsimile for UrlButtons (index + parameter template if any)\n                    var index = (string?)b[\"index\"] ?? \"0\";\n                    var parameters = b[\"parameters\"] as Newtonsoft.Json.Linq.JArray;\n                    urlButtonsList.Add(new Newtonsoft.Json.Linq.JObject\n                    {\n                        [\"index\"] = index,\n                        [\"parameters\"] = parameters ?? new Newtonsoft.Json.Linq.JArray()\n                    });\n                }\n            }\n\n            var urlButtonsJson = urlButtonsList.Count > 0\n                ? Newtonsoft.Json.JsonConvert.SerializeObject(urlButtonsList)\n                : null;\n\n            var namedKeysJson = namedKeys.Count > 0\n                ? Newtonsoft.Json.JsonConvert.SerializeObject(namedKeys.ToArray())\n                : null;\n\n            // Placeholder map is provider-specific; keep null unless you compute it elsewhere\n            string? placeholderMapJson = null;\n\n            return (headerKind, requiresMedia, headerText,\n                    parameterFormat, bodyVars, headerVars, totalVars,\n                    namedKeysJson, placeholderMapJson,\n                    body, bodyPreview,\n                    urlButtonsJson, quickReplyCount, hasPhoneButton);\n        }\n        catch\n        {\n            // very defensive fallback\n            var body = bodyFallback ?? string.Empty;\n            var bodyVars = System.Text.RegularExpressions.Regex.Matches(body, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count\n                         + System.Text.RegularExpressions.Regex.Matches(body, @\"\\{\\{\\s*\\}\\}\").Count;\n            var preview = body.Length > 240 ? body.Substring(0, 240) : body;\n            return (\"none\", false, null, \"UNKNOWN\", bodyVars, 0, bodyVars, null, null, body, preview, null, 0, false);\n        }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplateSyncWorker.cs",
      "sha256": "70427556d8ed5f1c68348a414a166b4bcdd07911b8f9f8d63bb05f3897d30a04",
      "language": "csharp",
      "size": 8915,
      "content": "using System;\nusing System.Diagnostics;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Hosting;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api; // AppDbContext\n\nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    /// <summary>\n    /// Periodically refreshes WhatsApp template catalogs for all businesses\n    /// that have an active WhatsAppSettings row. Uses ITemplateSyncService\n    /// which is TTL-aware to avoid unnecessary work.\n    /// </summary>\n    public sealed class TemplateSyncWorker : BackgroundService\n    {\n        private readonly IServiceProvider _sp;\n        private readonly ILogger<TemplateSyncWorker> _log;\n        private readonly TimeSpan _interval;\n        private readonly int _maxParallel;\n        private readonly int _jitterSeconds;\n\n        public TemplateSyncWorker(IServiceProvider sp, ILogger<TemplateSyncWorker> log, IConfiguration cfg)\n        {\n            _sp = sp;\n            _log = log;\n\n            // Defaults chosen to be light on the system.\n            // appsettings.json example:\n            // \"WhatsApp\": {\n            //   \"Templates\": {\n            //     \"SyncIntervalMinutes\": 360,\n            //     \"MaxParallel\": 1,\n            //     \"JitterSeconds\": 60\n            //   }\n            // }\n            var minutes = Math.Max(15, cfg.GetValue<int?>(\"WhatsApp:Templates:SyncIntervalMinutes\") ?? 360);\n            _interval = TimeSpan.FromMinutes(minutes);\n\n            _maxParallel = Math.Clamp(cfg.GetValue<int?>(\"WhatsApp:Templates:MaxParallel\") ?? 1, 1, 8);\n            _jitterSeconds = Math.Clamp(cfg.GetValue<int?>(\"WhatsApp:Templates:JitterSeconds\") ?? 60, 0, 300);\n        }\n\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            // small delay after startup\n            await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);\n\n            var rnd = new Random();\n\n            while (!stoppingToken.IsCancellationRequested)\n            {\n                var sweepStart = DateTime.UtcNow;\n                var sw = Stopwatch.StartNew();\n                int processed = 0;\n\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                    // Get active business IDs once per sweep\n                    var bizIds = await db.WhatsAppSettings\n                        .AsNoTracking()\n                        .Where(s => s.IsActive)\n                        .Select(s => s.BusinessId)\n                        .Distinct()\n                        .ToListAsync(stoppingToken);\n\n                    if (bizIds.Count == 0)\n                    {\n                        _log.LogInformation(\"TemplateSyncWorker: no active WhatsApp settings found.\");\n                    }\n                    else\n                    {\n                        var sem = new SemaphoreSlim(_maxParallel);\n                        var tasks = bizIds.Select(async biz =>\n                        {\n                            await sem.WaitAsync(stoppingToken);\n                            try\n                            {\n                                // New scope per business to keep DbContexts short-lived\n                                using var inner = _sp.CreateScope();\n                                var sync = inner.ServiceProvider.GetRequiredService<ITemplateSyncService>();\n\n                                // TTL-aware; manual button should call force:true instead\n                                var res = await sync.SyncBusinessTemplatesAsync(biz, force: false, ct: stoppingToken);\n                                Interlocked.Increment(ref processed);\n\n                                _log.LogInformation(\n                                    \"TemplateSyncWorker: biz={Biz} added={A} updated={U} skipped={S} syncedAt={At}\",\n                                    biz, res.Added, res.Updated, res.Skipped, res.SyncedAt);\n                            }\n                            catch (OperationCanceledException) { /* shutting down */ }\n                            catch (Exception exBiz)\n                            {\n                                _log.LogWarning(exBiz, \"TemplateSyncWorker: sync failed for biz {Biz}\", biz);\n                            }\n                            finally\n                            {\n                                sem.Release();\n                            }\n                        });\n\n                        await Task.WhenAll(tasks);\n                    }\n                }\n                catch (OperationCanceledException) { /* shutting down */ }\n                catch (Exception ex)\n                {\n                    _log.LogWarning(ex, \"TemplateSyncWorker sweep failed\");\n                }\n                finally\n                {\n                    sw.Stop();\n                    _log.LogInformation(\"TemplateSyncWorker: sweep finished in {ElapsedMs} ms; processed={Processed}; next run ~{NextRun}\",\n                        sw.ElapsedMilliseconds, processed, sweepStart.Add(_interval));\n                }\n\n                // Add small jitter to avoid multiple instances syncing at the exact same time\n                var jitter = _jitterSeconds > 0 ? TimeSpan.FromSeconds(rnd.Next(0, _jitterSeconds + 1)) : TimeSpan.Zero;\n                var delay = _interval + jitter;\n\n                await Task.Delay(delay, stoppingToken);\n            }\n        }\n    }\n}\n\n\n//using System;\n//using System.Linq;\n//using System.Threading;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.Configuration;\n//using Microsoft.Extensions.DependencyInjection;\n//using Microsoft.Extensions.Hosting;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api; // AppDbContext\n\n//namespace xbytechat.api.WhatsAppSettings.Services\n//{\n//    /// <summary>\n//    /// Periodically refreshes WhatsApp template catalogs for all businesses\n//    /// that have an active WhatsAppSettings row. Uses your existing\n//    /// ITemplateSyncService (TTL-aware) so this is safe to run frequently.\n//    /// </summary>\n//    public sealed class TemplateSyncWorker : BackgroundService\n//    {\n//        private readonly IServiceProvider _sp;\n//        private readonly ILogger<TemplateSyncWorker> _log;\n//        private readonly TimeSpan _interval;\n\n//        public TemplateSyncWorker(IServiceProvider sp, ILogger<TemplateSyncWorker> log, IConfiguration cfg)\n//        {\n//            _sp = sp;\n//            _log = log;\n\n//            // Default: every 6 hours; override in appsettings:\n//            // \"WhatsApp\": { \"Templates\": { \"SyncIntervalMinutes\": 360 } }\n//            var minutes = Math.Max(15, cfg.GetValue<int?>(\"WhatsApp:Templates:SyncIntervalMinutes\") ?? 360);\n//            _interval = TimeSpan.FromMinutes(minutes);\n//        }\n\n//        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n//        {\n//            // small delay after startup\n//            await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);\n\n//            while (!stoppingToken.IsCancellationRequested)\n//            {\n//                try\n//                {\n//                    using var scope = _sp.CreateScope();\n//                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//                    var sync = scope.ServiceProvider.GetRequiredService<ITemplateSyncService>();\n\n//                    var bizIds = await db.WhatsAppSettings\n//                        .AsNoTracking()\n//                        .Where(s => s.IsActive)\n//                        .Select(s => s.BusinessId)\n//                        .Distinct()\n//                        .ToListAsync(stoppingToken);\n\n//                    foreach (var biz in bizIds)\n//                    {\n//                        try\n//                        {\n//                            var res = await sync.SyncBusinessTemplatesAsync(biz, force: false, ct: stoppingToken);\n//                            _log.LogInformation(\"TemplateSyncWorker: biz={Biz} added={A} updated={U} syncedAt={At}\",\n//                                biz, res.Added, res.Updated, res.SyncedAt);\n//                        }\n//                        catch (Exception exBiz)\n//                        {\n//                            _log.LogWarning(exBiz, \"TemplateSyncWorker: sync failed for biz {Biz}\", biz);\n//                        }\n//                    }\n//                }\n//                catch (Exception ex)\n//                {\n//                    _log.LogWarning(ex, \"TemplateSyncWorker sweep failed\");\n//                }\n\n//                await Task.Delay(_interval, stoppingToken);\n//            }\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppPhoneNumberService.cs",
      "sha256": "2ddbc862b331738129c3d1bcfed42a93b29321297036f9630e72369d57b41ef4",
      "language": "csharp",
      "size": 19657,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http.Headers;\nusing System.Net;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Services\n{\n    public sealed class WhatsAppPhoneNumberService : IWhatsAppPhoneNumberService\n    {\n        private readonly AppDbContext _db;\n\n        public WhatsAppPhoneNumberService(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<IReadOnlyList<WhatsAppPhoneNumber>> ListAsync(\n           Guid businessId,\n           string provider,\n            CancellationToken ct = default)\n        {\n            if (string.IsNullOrWhiteSpace(provider))\n                throw new ArgumentException(\"Provider is required.\", nameof(provider));\n\n            // Enforce your uppercase-only contract (no normalization here)\n            if (provider is not \"PINNACLE\" and not \"META_CLOUD\")\n                throw new ArgumentOutOfRangeException(nameof(provider),\n                    \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n            var list = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.Provider == provider) // exact, case-sensitive\n                .OrderByDescending(x => x.IsDefault)\n                .ThenBy(x => x.WhatsAppBusinessNumber)\n                .ToListAsync(ct);\n\n            return list; // List<T> implements IReadOnlyList<T>\n        }\n\n        private static string NormalizeProvider(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"Pinnacle\";\n            var s = raw.Trim();\n            if (string.Equals(s, \"Pinnacle\", StringComparison.OrdinalIgnoreCase)) return \"Pinnacle\";\n            if (string.Equals(s, \"Meta_cloud\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(s, \"meta_cloud\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(s, \"meta\", StringComparison.OrdinalIgnoreCase))\n                return \"Meta_cloud\";\n            return s;\n        }\n\n        public async Task<(int Added, int Updated, int Total)> SyncFromProviderAsync(\n            Guid businessId,\n            WhatsAppSettingsDto s,                 // DTO\n            string provider,\n            CancellationToken ct = default)\n        {\n            // Always honor the provider saved in DB (CAPS), fall back to the arg if needed\n            var providerCanon = (s.Provider ?? provider ?? string.Empty)\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n            List<(string PhoneId, string Number, string? Label, string? Status)> list = providerCanon switch\n            {\n                \"META_CLOUD\" => await FetchFromMetaAsync(s, ct),\n                \"PINNACLE\" => await FetchFromPinnacleAsync(s, ct),\n                _ => new List<(string PhoneId, string Number, string? Label, string? Status)>()\n            };\n\n            var added = 0;\n            var updated = 0;\n\n            foreach (var (phoneId, number, label, status) in list)\n            {\n                var existing = await _db.WhatsAppPhoneNumbers\n                    .FirstOrDefaultAsync(x =>\n                        x.BusinessId == businessId &&\n                        x.Provider == providerCanon &&\n                        x.PhoneNumberId == phoneId, ct);\n\n                if (existing is null)\n                {\n                    _db.WhatsAppPhoneNumbers.Add(new WhatsAppPhoneNumber\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Provider = providerCanon,                 // segregate by provider\n                        PhoneNumberId = phoneId,\n                        WhatsAppBusinessNumber = number,\n                        SenderDisplayName = string.IsNullOrWhiteSpace(label) ? null : label,\n                        Status = status,\n                        IsActive = true,\n                        IsDefault = false\n                    });\n                    added++;\n                }\n                else\n                {\n                    existing.WhatsAppBusinessNumber = number;\n                    if (!string.IsNullOrWhiteSpace(label))\n                        existing.SenderDisplayName = label;\n                    existing.Status = status;\n                    existing.IsActive = true;\n                    updated++;\n                }\n            }\n\n            await _db.SaveChangesAsync(ct);\n            return (added, updated, list.Count);\n        }\n\n        private async Task<List<(string PhoneId, string Number, string? Label, string? Status)>> FetchFromMetaAsync(\n            WhatsAppSettingsDto s,\n            CancellationToken ct)\n        {\n            var list = new List<(string, string, string?, string?)>();\n\n            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n                return list;\n\n            var baseUrl = string.IsNullOrWhiteSpace(s.ApiUrl)\n                ? \"https://graph.facebook.com/v22.0\"\n                : s.ApiUrl.TrimEnd('/');\n\n            var url = $\"{baseUrl}/{s.WabaId}/phone_numbers?fields=id,display_phone_number,verified_name,status&limit=100\";\n\n            using var http = new HttpClient();\n            http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n            var res = await http.GetAsync(url, ct);\n            var body = await res.Content.ReadAsStringAsync(ct);\n            if (!res.IsSuccessStatusCode) return list;\n\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            var data = root.ValueKind == JsonValueKind.Array\n                ? root\n                : root.TryGetProperty(\"data\", out var d) && d.ValueKind == JsonValueKind.Array ? d\n                : default;\n\n            if (data.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in data.EnumerateArray())\n                {\n                    var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString()\n                             : e.TryGetProperty(\"phone_number_id\", out var pid) ? pid.GetString()\n                             : null;\n\n                    var num = e.TryGetProperty(\"display_phone_number\", out var dnum) ? dnum.GetString()\n                             : e.TryGetProperty(\"number\", out var numEl) ? numEl.GetString()\n                             : null;\n\n                    var name = e.TryGetProperty(\"verified_name\", out var vn) ? vn.GetString()\n                             : e.TryGetProperty(\"name\", out var nm) ? nm.GetString()\n                             : null;\n\n                    var status = e.TryGetProperty(\"status\", out var stEl) ? stEl.GetString() : null;\n\n                    if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                        list.Add((id!, num!, name, status));\n                }\n            }\n\n            return list;\n        }\n\n        private async Task<List<(string PhoneId, string Number, string? Label, string? Status)>> FetchFromPinnacleAsync(\n            WhatsAppSettingsDto s,\n            CancellationToken ct)\n        {\n            var list = new List<(string, string, string?, string?)>();\n\n            if (string.IsNullOrWhiteSpace(s.ApiKey))\n                return list;\n\n            // Base URL and /v3 suffix\n            var baseUrl = string.IsNullOrWhiteSpace(s.ApiUrl)\n                ? \"https://partnersv1.pinbot.ai\"\n                : s.ApiUrl.TrimEnd('/');\n\n            if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            // Prefer WABA, fall back to PhoneNumberId\n            var pathId = !string.IsNullOrWhiteSpace(s.WabaId) ? s.WabaId!.Trim()\n                       : !string.IsNullOrWhiteSpace(s.PhoneNumberId) ? s.PhoneNumberId!.Trim()\n                       : null;\n\n            if (string.IsNullOrWhiteSpace(pathId))\n                return list;\n\n            var url = $\"{baseUrl}/{pathId}/phone_numbers\";\n\n            using var http = new HttpClient();\n            using var req = new HttpRequestMessage(HttpMethod.Get, url);\n            req.Headers.TryAddWithoutValidation(\"apikey\", s.ApiKey);\n\n            var res = await http.SendAsync(req, ct);\n            var body = await res.Content.ReadAsStringAsync(ct);\n            if (!res.IsSuccessStatusCode) return list;\n\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            var data = root.ValueKind == JsonValueKind.Array\n                ? root\n                : root.TryGetProperty(\"data\", out var d) && d.ValueKind == JsonValueKind.Array ? d\n                : default;\n\n            if (data.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in data.EnumerateArray())\n                {\n                    var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString()\n                             : e.TryGetProperty(\"phone_number_id\", out var pid) ? pid.GetString()\n                             : null;\n\n                    var num = e.TryGetProperty(\"display_phone_number\", out var dnum) ? dnum.GetString()\n                             : e.TryGetProperty(\"msisdn\", out var msisdn) ? msisdn.GetString()\n                             : e.TryGetProperty(\"number\", out var numEl) ? numEl.GetString()\n                             : null;\n\n                    var name = e.TryGetProperty(\"verified_name\", out var vn) ? vn.GetString()\n                             : e.TryGetProperty(\"name\", out var nm) ? nm.GetString()\n                             : null;\n\n                    if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                        list.Add((id!, num!, name, null));\n                }\n            }\n\n            return list;\n        }\n\n\n        private static string NormalizeMetaBase(string? apiUrl)\n                        => string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n\n        private async Task<List<(string PhoneId, string Number, string? Label, string? Status)>> FetchFromMetaAsync(\n            WhatsAppSettingEntity s, CancellationToken ct)\n        {\n            var baseUrl = NormalizeMetaBase(s.ApiUrl);\n            using var http = new HttpClient();\n            http.DefaultRequestHeaders.Authorization =\n                new AuthenticationHeaderValue(\"Bearer\", s.ApiKey!.Trim());\n\n            var list = new List<(string, string, string?, string?)>();\n            string? after = null;\n\n            do\n            {\n                var url = $\"{baseUrl}/{s.WabaId}/phone_numbers?fields=id,display_phone_number,verified_name,status\";\n                if (!string.IsNullOrEmpty(after)) url += $\"&after={WebUtility.UrlEncode(after)}\";\n\n                var json = await http.GetStringAsync(url, ct);\n                using var doc = JsonDocument.Parse(json);\n                var root = doc.RootElement;\n\n                if (root.TryGetProperty(\"data\", out var data) && data.ValueKind == JsonValueKind.Array)\n                {\n                    foreach (var e in data.EnumerateArray())\n                    {\n                        var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString() : null;\n                        var num = e.TryGetProperty(\"display_phone_number\", out var nEl) ? nEl.GetString() : null;\n                        var name = e.TryGetProperty(\"verified_name\", out var lEl) ? lEl.GetString() : null;\n                        var status = e.TryGetProperty(\"status\", out var stEl) ? stEl.GetString() : null;\n                        if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                            list.Add((id!, num!, name, status));\n                    }\n                }\n\n                after = root.TryGetProperty(\"paging\", out var p)\n                     && p.TryGetProperty(\"cursors\", out var c)\n                     && c.TryGetProperty(\"after\", out var a)\n                     && a.ValueKind == JsonValueKind.String ? a.GetString() : null;\n\n            } while (!string.IsNullOrEmpty(after));\n\n            return list;\n        }\n\n\n        public async Task<WhatsAppPhoneNumber> UpsertAsync(\n              Guid businessId,\n              string provider, string phoneNumberId,\n              string whatsAppBusinessNumber, string? senderDisplayName,\n              bool? isActive = null,\n         bool? isDefault = null)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) throw new ArgumentException(\"provider is required\");\n            if (string.IsNullOrWhiteSpace(phoneNumberId)) throw new ArgumentException(\"phoneNumberId is required\");\n            if (string.IsNullOrWhiteSpace(whatsAppBusinessNumber)) throw new ArgumentException(\"whatsAppBusinessNumber is required\");\n\n            // Canonical provider: \"PINNACLE\" | \"META_CLOUD\"\n            var prov = provider.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            var pnid = phoneNumberId.Trim();\n            var waNum = whatsAppBusinessNumber.Trim();\n            var disp = string.IsNullOrWhiteSpace(senderDisplayName) ? null : senderDisplayName!.Trim();\n\n            var now = DateTime.UtcNow;\n\n            await using var tx = await _db.Database.BeginTransactionAsync();\n\n            // 1) Ensure parent settings row exists for (BusinessId, Provider) [case-insensitive]\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.Provider.ToLower() == prov.ToLower());\n\n            if (setting == null)\n            {\n                setting = new WhatsAppSettingEntity\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = prov,\n                    ApiUrl = string.Empty,\n                    ApiKey = string.Empty,\n                    IsActive = true,\n                    CreatedAt = now\n                };\n                _db.WhatsAppSettings.Add(setting);\n                await _db.SaveChangesAsync();\n            }\n            else if (!string.Equals(setting.Provider, prov, StringComparison.Ordinal))\n            {\n                // normalize stored provider casing\n                setting.Provider = prov;\n                setting.UpdatedAt = now;\n                await _db.SaveChangesAsync();\n            }\n\n            var providerForChild = setting.Provider; // exact value used for children\n\n            // 2) Upsert phone number in WhatsAppPhoneNumbers\n            var entity = await _db.WhatsAppPhoneNumbers.FirstOrDefaultAsync(x =>\n                x.BusinessId == businessId &&\n                x.Provider.ToLower() == providerForChild.ToLower() &&\n                x.PhoneNumberId == pnid);\n\n            if (entity == null)\n            {\n                entity = new WhatsAppPhoneNumber\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = providerForChild,\n                    PhoneNumberId = pnid,\n                    WhatsAppBusinessNumber = waNum,\n                    SenderDisplayName = disp,\n                    IsActive = isActive ?? true,\n                    IsDefault = isDefault ?? false,\n                    CreatedAt = now\n                };\n                _db.WhatsAppPhoneNumbers.Add(entity);\n            }\n            else\n            {\n                entity.WhatsAppBusinessNumber = waNum;\n                entity.SenderDisplayName = disp;\n                if (isActive.HasValue) entity.IsActive = isActive.Value;\n                if (isDefault.HasValue) entity.IsDefault = isDefault.Value;\n                entity.UpdatedAt = now;\n            }\n\n            await _db.SaveChangesAsync();\n\n            // 3) Enforce a single default per (BusinessId, Provider)\n            if (isDefault == true || entity.IsDefault)\n            {\n                await _db.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == businessId &&\n                                x.Provider.ToLower() == providerForChild.ToLower() &&\n                                x.Id != entity.Id)\n                    .ExecuteUpdateAsync(up => up.SetProperty(p => p.IsDefault, false));\n\n                // We no longer mirror to WhatsAppSettings because those columns were removed.\n                // If you ever re-introduce them, you can set:\n                // setting.PhoneNumberId = entity.PhoneNumberId;\n                // setting.WhatsAppBusinessNumber = entity.WhatsAppBusinessNumber;\n                setting.UpdatedAt = now;\n                await _db.SaveChangesAsync();\n            }\n\n            await tx.CommitAsync();\n            return entity;\n        }\n\n        public async Task<bool> DeleteAsync(Guid businessId, string provider, Guid id)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            var entity = await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x => x.Id == id && x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower());\n\n            if (entity == null) return false;\n\n            _db.WhatsAppPhoneNumbers.Remove(entity);\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> SetDefaultAsync(Guid businessId, string provider, Guid id)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            await _db.Database.BeginTransactionAsync();\n            try\n            {\n                // ensure target exists and belongs to (business, provider)\n                var target = await _db.WhatsAppPhoneNumbers\n                    .FirstOrDefaultAsync(x => x.Id == id && x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower());\n                if (target == null) return false;\n\n                await _db.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower())\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsDefault, false));\n\n                target.IsDefault = true;\n                target.UpdatedAt = DateTime.UtcNow;\n                await _db.SaveChangesAsync();\n\n                await _db.Database.CommitTransactionAsync();\n                return true;\n            }\n            catch\n            {\n                await _db.Database.RollbackTransactionAsync();\n                throw;\n            }\n        }\n\n        public async Task<WhatsAppPhoneNumber?> FindAsync(Guid businessId, string provider, string phoneNumberId)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            return await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Provider.ToLower() == prov.ToLower() &&\n                    x.PhoneNumberId == phoneNumberId);\n        }\n\n        public async Task<WhatsAppPhoneNumber?> GetDefaultAsync(Guid businessId, string provider)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            // covered by partial unique index: at most one IsDefault per (biz, provider)\n            return await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Provider.ToLower() == prov.ToLower() &&\n                    x.IsDefault);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppSenderService.cs",
      "sha256": "47d2d628bbc5878b5c98d942fc2d05461d8d2fe8de0d27b24acef83bb96c5c60",
      "language": "csharp",
      "size": 6310,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.DTOs;               \nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    public sealed class WhatsAppSenderService : IWhatsAppSenderService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<WhatsAppSenderService> _logger;\n\n        public WhatsAppSenderService(AppDbContext db, ILogger<WhatsAppSenderService> logger)\n        {\n            _db = db;\n            _logger = logger;\n        }\n\n        public async Task<IReadOnlyList<WhatsAppSenderDto>> GetBusinessSendersAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) return Array.Empty<WhatsAppSenderDto>();\n\n            var rows = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive)\n                .OrderByDescending(x => x.IsDefault)\n                .ThenBy(x => x.WhatsAppBusinessNumber)\n                .ToListAsync(ct);\n\n            return rows.Select(x =>\n            {\n                // inline normalize: uppercase; map META -> META_CLOUD\n                var prov = (x.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                if (prov == \"META\") prov = \"META_CLOUD\";\n\n                return new WhatsAppSenderDto\n                {\n                    Id = x.Id,\n                    BusinessId = x.BusinessId,\n                    Provider = prov, // \"PINNACLE\" | \"META_CLOUD\" (ideally)\n                    PhoneNumberId = x.PhoneNumberId,\n                    WhatsAppBusinessNumber = x.WhatsAppBusinessNumber,\n                    SenderDisplayName = x.SenderDisplayName,\n                    IsActive = x.IsActive,\n                    IsDefault = x.IsDefault\n                };\n            }).ToList();\n        }\n        public async Task<(string Provider, string PhoneNumberId)?> ResolveSenderPairAsync(\n            Guid businessId,\n            string phoneNumberId,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(phoneNumberId))\n                return null;\n\n            var row = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.PhoneNumberId == phoneNumberId &&\n                    x.IsActive, ct);\n\n            if (row == null) return null;\n\n            // inline normalize here too\n            var prov = (row.Provider ?? string.Empty).Trim().ToUpperInvariant();\n            if (prov == \"META\") prov = \"META_CLOUD\";\n\n            return (prov, row.PhoneNumberId);\n        }\n\n        public async Task<WhatsAppSenderResolutionResult> ResolveDefaultSenderAsync(\n            Guid businessId,\n            string? providerHint = null,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty)\n                return WhatsAppSenderResolutionResult.Fail(providerHint, \"BusinessId is empty.\");\n\n            // Normalize provider hint: \"META\" -> \"META_CLOUD\", \"meta-cloud\" -> \"META_CLOUD\", etc.\n            string? provider = null;\n            if (!string.IsNullOrWhiteSpace(providerHint))\n            {\n                provider = providerHint.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n                if (provider == \"META\") provider = \"META_CLOUD\";\n            }\n\n            // ESU constraint: sender phone_number_id MUST come from WhatsAppPhoneNumbers only (never WhatsAppSettings.PhoneNumberId).\n            var q = _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(provider))\n                q = q.Where(x => x.Provider.ToUpper() == provider);\n\n            // 1) Prefer active default sender.\n            var bestDefault = await q\n                .Where(x => x.IsDefault)\n                .OrderByDescending(x => x.UpdatedAt ?? x.CreatedAt)\n                .ThenBy(x => x.PhoneNumberId)\n                .FirstOrDefaultAsync(ct);\n\n            if (bestDefault != null)\n            {\n                var prov = (bestDefault.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                if (prov == \"META\") prov = \"META_CLOUD\";\n\n                return WhatsAppSenderResolutionResult.Ok(prov, bestDefault.PhoneNumberId);\n            }\n\n            // 2) No default: pick deterministic active sender and emit a warning (guardrail).\n            var fallback = await q\n                .OrderByDescending(x => x.UpdatedAt ?? x.CreatedAt)\n                .ThenBy(x => x.PhoneNumberId)\n                .FirstOrDefaultAsync(ct);\n\n            if (fallback != null)\n            {\n                var prov = (fallback.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                if (prov == \"META\") prov = \"META_CLOUD\";\n\n                var warning = string.IsNullOrWhiteSpace(provider)\n                    ? \"No default WhatsApp sender is set. Using the most recently updated active sender (any provider).\"\n                    : $\"No default WhatsApp sender is set for provider '{provider}'. Using the most recently updated active sender for that provider.\";\n\n                // This log is intentionally inside the resolver so future call sites can't miss the guardrail.\n                _logger.LogWarning(\n                    \"WhatsAppSenderService: {Warning} biz={BusinessId} providerHint={ProviderHint} pickedProvider={PickedProvider} pickedPhoneNumberId={PhoneNumberId}\",\n                    warning, businessId, providerHint, prov, fallback.PhoneNumberId);\n\n                return WhatsAppSenderResolutionResult.Ok(prov, fallback.PhoneNumberId, warning);\n            }\n\n            return WhatsAppSenderResolutionResult.Fail(\n                provider,\n                string.IsNullOrWhiteSpace(provider)\n                    ? \"No active WhatsAppPhoneNumbers sender configured for this business.\"\n                    : $\"No active WhatsAppPhoneNumbers sender configured for provider '{provider}'.\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppSettingsService.cs",
      "sha256": "b60f7e2059b0ae296d0546c1118ade41c7f5c8ebbf06106a9cf1f7f9eea28282",
      "language": "csharp",
      "size": 24156,
      "content": "// üìÑ xbytechat_api/WhatsAppSettings/Services/WhatsAppSettingsService.cs\nusing Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public class WhatsAppSettingsService : IWhatsAppSettingsService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly IHttpClientFactory _httpClientFactory;\n\n        public WhatsAppSettingsService(\n            AppDbContext dbContext,\n            IHttpClientFactory httpClientFactory)\n        {\n            _dbContext = dbContext;\n            _httpClientFactory = httpClientFactory;\n        }\n\n        public async Task SaveOrUpdateSettingAsync(SaveWhatsAppSettingDto dto)\n        {\n            if (dto.BusinessId == Guid.Empty) throw new ArgumentException(\"BusinessId required\");\n\n            // Canonical provider: PINNACLE | META_CLOUD\n            var providerCanon = (dto.Provider ?? \"PINNACLE\")\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            if (providerCanon is not (\"PINNACLE\" or \"META_CLOUD\")) providerCanon = \"PINNACLE\";\n\n            var now = DateTime.UtcNow;\n\n            // 1. Check for duplicate WabaId across other businesses (if provided)\n            if (!string.IsNullOrWhiteSpace(dto.WabaId))\n            {\n                var cleanWaba = dto.WabaId.Trim();\n                var conflict = await _dbContext.WhatsAppSettings\n                    .AsNoTracking()\n                    .AnyAsync(x => x.BusinessId != dto.BusinessId && \n                                   x.Provider == providerCanon && \n                                   x.WabaId == cleanWaba);\n                \n                if (conflict)\n                {\n                    throw new InvalidOperationException($\"The WABA ID '{cleanWaba}' is already associated with another account. Please verify your credentials.\");\n                }\n            }\n\n            await using var tx = await _dbContext.Database.BeginTransactionAsync();\n\n            // Exact business + provider row\n            var existing = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == dto.BusinessId &&\n                                          x.Provider.ToLower() == providerCanon.ToLower());\n\n            // Use existing casing if found to avoid Principal Key update (FK mismatch)\n            var effectiveProvider = existing?.Provider ?? providerCanon;\n\n            if (existing != null)\n            {\n                if (!string.IsNullOrWhiteSpace(dto.ApiUrl)) existing.ApiUrl = dto.ApiUrl.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.ApiKey)) existing.ApiKey = dto.ApiKey.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WabaId)) existing.WabaId = dto.WabaId.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.SenderDisplayName)) existing.SenderDisplayName = dto.SenderDisplayName.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookSecret)) existing.WebhookSecret = dto.WebhookSecret.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookVerifyToken)) existing.WebhookVerifyToken = dto.WebhookVerifyToken.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookCallbackUrl)) existing.WebhookCallbackUrl = dto.WebhookCallbackUrl.Trim();\n\n                existing.IsActive = dto.IsActive;\n                existing.UpdatedAt = now;\n\n                // Ensure single active row per business\n                await _dbContext.WhatsAppSettings\n                    .Where(x => x.BusinessId == dto.BusinessId && x.Id != existing.Id)\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsActive, false));\n            }\n            else\n            {\n                var s = new WhatsAppSettingEntity\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    Provider = effectiveProvider,\n                    ApiUrl = (dto.ApiUrl ?? string.Empty).Trim(),\n                    ApiKey = (dto.ApiKey ?? string.Empty).Trim(),\n                    SenderDisplayName = string.IsNullOrWhiteSpace(dto.SenderDisplayName) ? null : dto.SenderDisplayName.Trim(),\n                    WabaId = string.IsNullOrWhiteSpace(dto.WabaId) ? null : dto.WabaId.Trim(),\n                    WebhookSecret = string.IsNullOrWhiteSpace(dto.WebhookSecret) ? null : dto.WebhookSecret.Trim(),\n                    WebhookVerifyToken = string.IsNullOrWhiteSpace(dto.WebhookVerifyToken) ? null : dto.WebhookVerifyToken.Trim(),\n                    WebhookCallbackUrl = string.IsNullOrWhiteSpace(dto.WebhookCallbackUrl) ? null : dto.WebhookCallbackUrl.Trim(),\n                    IsActive = dto.IsActive,\n                    CreatedAt = now\n                };\n                await _dbContext.WhatsAppSettings.AddAsync(s);\n            }\n\n            await _dbContext.SaveChangesAsync();\n\n            // ‚îÄ‚îÄ Numbers live in WhatsAppPhoneNumbers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n            if (!string.IsNullOrWhiteSpace(dto.PhoneNumberId) &&\n                !string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n            {\n                var pnid = dto.PhoneNumberId.Trim();\n                var waNum = dto.WhatsAppBusinessNumber.Trim();\n                var display = string.IsNullOrWhiteSpace(dto.SenderDisplayName) ? null : dto.SenderDisplayName!.Trim();\n\n                // Upsert by business+provider+phoneId\n                var providerFilter = effectiveProvider.ToLowerInvariant();\n\n                var numberRow = await _dbContext.WhatsAppPhoneNumbers.FirstOrDefaultAsync(x =>\n                    x.BusinessId == dto.BusinessId &&\n                    x.Provider.ToLower() == providerFilter &&\n                    x.PhoneNumberId == pnid);\n\n                if (numberRow == null)\n                {\n                    numberRow = new WhatsAppPhoneNumber\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = dto.BusinessId,\n                        Provider = effectiveProvider,\n                        PhoneNumberId = pnid,\n                        WhatsAppBusinessNumber = waNum,\n                        SenderDisplayName = display,\n                        IsActive = true,\n                        IsDefault = true,\n                        CreatedAt = now\n                    };\n                    _dbContext.WhatsAppPhoneNumbers.Add(numberRow);\n                }\n                else\n                {\n                    numberRow.WhatsAppBusinessNumber = waNum;\n                    numberRow.SenderDisplayName = display;\n                    numberRow.Provider = effectiveProvider; // ensure matches setting\n                    numberRow.IsActive = true;\n                    numberRow.IsDefault = true;\n                    numberRow.UpdatedAt = now;\n                }\n\n                await _dbContext.SaveChangesAsync();\n\n                // Ensure single default per business+provider\n                await _dbContext.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == dto.BusinessId &&\n                                x.Provider.ToLower() == providerFilter &&\n                                x.Id != numberRow.Id)\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsDefault, false));\n            }\n            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n            await tx.CommitAsync();\n        }\n\n        public async Task<WhatsAppSettingsDto?> GetSettingsByBusinessIdAsync(Guid businessId)\n        {\n            // 1. Get the Settings (User's configuration)\n            var setting = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Include(s => s.WhatsAppBusinessNumbers) // Load connected numbers via FK\n                .Where(s => s.BusinessId == businessId && s.IsActive)\n                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                .FirstOrDefaultAsync();\n\n            if (setting == null) return null;\n\n            // 2. Try to pick the best phone number from the navigation property (Strict FK match)\n            var phone = setting.WhatsAppBusinessNumbers\n                .Where(p => p.IsActive)\n                .OrderByDescending(p => p.IsDefault)\n                .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                .FirstOrDefault();\n\n            // 3. Fallback: If FK didn't yield a number (e.g. Provider mismatch in DB due to legacy data), \n            // query WhatsAppPhoneNumbers table directly by BusinessId.\n            if (phone == null)\n            {\n                phone = await _dbContext.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .Where(p => p.BusinessId == businessId && p.IsActive)\n                    .OrderByDescending(p => p.IsDefault)\n                    .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                    .FirstOrDefaultAsync();\n            }\n\n            return new WhatsAppSettingsDto\n            {\n                BusinessId = setting.BusinessId,\n                Provider = setting.Provider,\n                ApiUrl = setting.ApiUrl,\n                ApiKey = setting.ApiKey,\n                WabaId = setting.WabaId,\n                PhoneNumberId = phone?.PhoneNumberId,\n                WhatsAppBusinessNumber = phone?.WhatsAppBusinessNumber,\n                SenderDisplayName = phone?.SenderDisplayName\n            };\n        }\n\n        public async Task<bool> DeleteSettingsAsync(Guid businessId, CancellationToken ct = default)\n        {\n            var all = await _dbContext.WhatsAppSettings\n                .Where(x => x.BusinessId == businessId)\n                .ToListAsync(ct);\n\n            if (all.Count == 0) return false;\n\n            _dbContext.WhatsAppSettings.RemoveRange(all);\n            await _dbContext.SaveChangesAsync(ct);\n            return true;\n        }\n\n        /// <summary>\n        /// Provider-aware test connection. Returns a short message (‚úÖ/‚ùå ‚Ä¶).\n        /// The controller may convert non-‚úÖ messages to 400, etc.\n        /// </summary>\n        public async Task<string> TestConnectionAsync(SaveWhatsAppSettingDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.Provider))\n                throw new ArgumentException(\"Provider is required.\");\n\n            var provider = dto.Provider.Trim();\n            var lower = provider.ToLowerInvariant();\n            var baseUrl = (dto.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            if (string.IsNullOrWhiteSpace(baseUrl))\n                throw new ArgumentException(\"ApiUrl is required.\");\n\n            var http = _httpClientFactory.CreateClient();\n\n            // ----- Meta Cloud -----\n            if (lower == \"meta_cloud\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiKey))\n                    throw new ArgumentException(\"ApiKey is required for Meta Cloud.\");\n                if (string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n                    throw new ArgumentException(\"PhoneNumberId is required for Meta Cloud.\");\n\n                http.DefaultRequestHeaders.Authorization =\n                    new AuthenticationHeaderValue(\"Bearer\", dto.ApiKey);\n\n                var url = $\"{baseUrl}/{dto.PhoneNumberId}\";\n                var res = await http.GetAsync(url);\n                var body = await res.Content.ReadAsStringAsync();\n\n                if (!res.IsSuccessStatusCode)\n                    return $\"‚ùå Meta Cloud test failed ({(int)res.StatusCode}). Body: {body}\";\n\n                return \"‚úÖ Meta Cloud token & phone number ID are valid.\";\n            }\n\n            // ----- Pinnacle -----\n            if (lower == \"pinnacle\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiKey))\n                    return \"‚ùå API Key is required for Pinnacle.\";\n\n                var pathId =\n                    !string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? dto.PhoneNumberId!.Trim() :\n                    !string.IsNullOrWhiteSpace(dto.WabaId) ? dto.WabaId!.Trim() :\n                    null;\n\n                if (string.IsNullOrWhiteSpace(pathId))\n                    return \"‚ùå Provide PhoneNumberId or WabaId for Pinnacle.\";\n\n                if (string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n                    return \"‚ùå WhatsApp Business Number is required for Pinnacle test.\";\n\n                var url = $\"{baseUrl}/{pathId}/messages\";\n                var payload = new\n                {\n                    to = dto.WhatsAppBusinessNumber,\n                    type = \"text\",\n                    text = new { body = \"Test message\" },\n                    messaging_product = \"whatsapp\"\n                };\n\n                using var req = new HttpRequestMessage(HttpMethod.Post, url);\n                req.Headers.TryAddWithoutValidation(\"apikey\", dto.ApiKey);\n                req.Content = new StringContent(JsonSerializer.Serialize(payload), Encoding.UTF8, \"application/json\");\n\n                var res = await http.SendAsync(req);\n                var body = await res.Content.ReadAsStringAsync();\n\n                if (!res.IsSuccessStatusCode)\n                {\n                    if ((int)res.StatusCode == 401 || (int)res.StatusCode == 403)\n                        return $\"‚ùå Pinnacle rejected the API key for id '{pathId}'. Verify the key and id. Body: {body}\";\n\n                    return $\"‚ùå Pinnacle test failed ({(int)res.StatusCode}). Body: {body}\";\n                }\n\n                return \"‚úÖ Pinnacle API key and endpoint are reachable.\";\n            }\n\n            return $\"‚ùå Unsupported provider: {dto.Provider}\";\n        }\n\n        public async Task<string?> GetSenderNumberAsync(Guid businessId)\n        {\n            var providerRaw = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId && s.IsActive)\n                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                .Select(s => s.Provider)\n                .FirstOrDefaultAsync();\n\n            if (string.IsNullOrWhiteSpace(providerRaw))\n                return null;\n\n            var provider = providerRaw.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            var providerLc = provider.ToLowerInvariant();\n\n            var number = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId &&\n                            n.IsActive &&\n                            n.Provider.ToLower() == providerLc)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.WhatsAppBusinessNumber)\n                .FirstOrDefaultAsync();\n\n            if (!string.IsNullOrWhiteSpace(number))\n                return number;\n\n            number = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.IsActive)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.WhatsAppBusinessNumber)\n                .FirstOrDefaultAsync();\n\n            return string.IsNullOrWhiteSpace(number) ? null : number;\n        }\n\n        public async Task<string> GetCallbackUrlAsync(Guid businessId, string appBaseUrl)\n        {\n            var s = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(s?.WebhookCallbackUrl))\n                return s!.WebhookCallbackUrl!;\n\n            // ‚úÖ align with your Meta dashboard: POST /api/webhooks/whatsapp\n            return $\"{appBaseUrl.TrimEnd('/')}/api/webhooks/whatsapp\";\n        }\n\n        public async Task<IReadOnlyList<WhatsAppSettingEntity>> GetAllForBusinessAsync(Guid businessId)\n        {\n            var items = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId)\n                .Include(s => s.WhatsAppBusinessNumbers)\n                .OrderBy(s => s.Provider)\n                .ToListAsync();\n\n            return items.AsReadOnly();\n        }\n\n        public async Task<WhatsAppSettingEntity?> GetSettingsByBusinessIdAndProviderAsync(Guid businessId, string provider)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) return null;\n            var prov = provider.Trim();\n\n            return await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.Provider.ToLower() == prov.ToLower());\n        }\n\n        // ---------------------------------------------------------------------\n        // Connection Summary (Meta Health)\n        // ---------------------------------------------------------------------\n\n        public async Task<WhatsAppConnectionSummaryDto?> GetConnectionSummaryAsync(Guid businessId)\n        {\n            // 1. Fetch all active numbers for the business\n            var allNumbers = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.IsActive)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .ToListAsync();\n\n            if (!allNumbers.Any()) return null;\n\n            // 2. Use the primary (default or most recent) for the health summary\n            var phoneRow = allNumbers.First();\n\n            return new WhatsAppConnectionSummaryDto\n            {\n                BusinessId = phoneRow.BusinessId,\n                PhoneNumberId = phoneRow.PhoneNumberId,\n                WhatsAppBusinessNumber = phoneRow.WhatsAppBusinessNumber,\n                WhatsAppBusinessNumbers = allNumbers.Select(x => x.WhatsAppBusinessNumber).Where(x => x != null).Cast<string>().ToList(),\n                VerifiedName = phoneRow.VerifiedName,\n                QualityRating = phoneRow.QualityRating,\n                Status = phoneRow.Status,\n                NameStatus = phoneRow.NameStatus,\n                MessagingLimitTier = phoneRow.MessagingLimitTier,\n                LastUpdated = phoneRow.ConnectionDataUpdatedAt\n            };\n        }\n\n        public async Task<WhatsAppConnectionSummaryDto> RefreshConnectionSummaryAsync(Guid businessId)\n        {\n            // 1. Resolve Settings (for Token) & Number (for ID)\n            var setting = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId && s.IsActive)\n                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                .FirstOrDefaultAsync();\n\n            if (setting == null)\n                throw new InvalidOperationException(\"No active WhatsApp settings found.\");\n\n            // Only supported for Meta_Cloud (Pinnacle doesn't expose this Graph endpoint directly usually, \n            // or uses a different one. We'll support Meta_Cloud first as requested).\n            if (!setting.Provider.Equals(\"META_CLOUD\", StringComparison.OrdinalIgnoreCase))\n            {\n                // For Pinnacle, we might just return local data or throw not supported.\n                // Assuming currently we focused on Meta Graph call.\n                // If the user uses Pinnacle, we might need a specific partner API. \n                // For now, fail safe or return local.\n                // Let's throw to be explicit if they try to \"Refresh\" on non-Meta.\n                // Or better: just checking if we can do it. User asked for Graph call.\n            }\n\n            // We need the phone number ID to query graph\n            var phoneRow = await _dbContext.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(n => n.BusinessId == businessId && n.IsActive && n.IsDefault);\n\n            // Fallback to any active if no default\n            if (phoneRow == null)\n            {\n                 phoneRow = await _dbContext.WhatsAppPhoneNumbers\n                .Where(n => n.BusinessId == businessId && n.IsActive)\n                .OrderByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .FirstOrDefaultAsync();\n            }\n\n            if (phoneRow == null)\n                throw new InvalidOperationException(\"No active number found to refresh.\");\n\n            // 2. Call Graph API\n            // GET /{PhoneId}?fields=verified_name,status,quality_rating,messaging_limit_tier\n            if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                throw new InvalidOperationException(\"Missing API Key (Access Token) for Meta Cloud.\");\n\n            var http = _httpClientFactory.CreateClient();\n            var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl) \n                ? \"https://graph.facebook.com/v21.0\" \n                : setting.ApiUrl.TrimEnd('/');\n\n            var url = $\"{baseUrl}/{phoneRow.PhoneNumberId}?fields=verified_name,status,quality_rating,messaging_limit_tier,name_status&access_token={setting.ApiKey}\";\n            \n            var res = await http.GetAsync(url);\n            var body = await res.Content.ReadAsStringAsync();\n\n            if (!res.IsSuccessStatusCode)\n            {\n                throw new Exception($\"Meta Graph Error {(int)res.StatusCode}: {body}\");\n            }\n\n            // 3. Parse Response\n            // { \"verified_name\": \"...\", \"status\": \"CONNECTED\", \"quality_rating\": \"GREEN\", \"messaging_limit_tier\": \"TIER_1K\", \"id\": \"...\" }\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            // 4. Update DB\n            phoneRow.VerifiedName = root.TryGetProperty(\"verified_name\", out var v) ? v.GetString() : null;\n            phoneRow.Status = root.TryGetProperty(\"status\", out var s) ? s.GetString()?.ToUpperInvariant() : null;\n            phoneRow.QualityRating = root.TryGetProperty(\"quality_rating\", out var q) ? q.GetString()?.ToUpperInvariant() : null;\n            phoneRow.MessagingLimitTier = root.TryGetProperty(\"messaging_limit_tier\", out var m) ? m.GetString()?.ToUpperInvariant() : null;\n            phoneRow.NameStatus = root.TryGetProperty(\"name_status\", out var ns) ? ns.GetString()?.ToUpperInvariant() : null;\n            phoneRow.ConnectionDataUpdatedAt = DateTime.UtcNow;\n\n            await _dbContext.SaveChangesAsync();\n\n            // 5. Fetch all active numbers for the business to include in DTO\n            var allNumbers = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.IsActive)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .ToListAsync();\n\n            // 6. Return updated DTO\n            return new WhatsAppConnectionSummaryDto\n            {\n                BusinessId = phoneRow.BusinessId,\n                PhoneNumberId = phoneRow.PhoneNumberId,\n                WhatsAppBusinessNumber = phoneRow.WhatsAppBusinessNumber,\n                WhatsAppBusinessNumbers = allNumbers.Select(x => x.WhatsAppBusinessNumber).Where(x => x != null).Cast<string>().ToList(),\n                VerifiedName = phoneRow.VerifiedName,\n                QualityRating = phoneRow.QualityRating,\n                Status = phoneRow.Status,\n                NameStatus = phoneRow.NameStatus,\n                MessagingLimitTier = phoneRow.MessagingLimitTier,\n                LastUpdated = phoneRow.ConnectionDataUpdatedAt\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppTemplateFetcherService.cs",
      "sha256": "fc3b6d2edf876703dc48a9e8cc52bf0ad59e76c10c894460b33d15c0b82e9d1c",
      "language": "csharp",
      "size": 62589,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Newtonsoft.Json;\nusing Newtonsoft.Json.Linq;\nusing System.Net.Http.Headers;\nusing System.Security.Claims;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Shared;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.WhatsAppSettings.Helpers;\nusing DTO = xbytechat.api.WhatsAppSettings.DTOs;\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n\n    public class WhatsAppTemplateFetcherService : IWhatsAppTemplateFetcherService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly HttpClient _httpClient;\n        private readonly ILogger<WhatsAppTemplateFetcherService> _logger;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        public WhatsAppTemplateFetcherService(AppDbContext dbContext, HttpClient httpClient, ILogger<WhatsAppTemplateFetcherService> logger, IHttpContextAccessor httpContextAccessor)\n        {\n            _dbContext = dbContext;\n            _httpClient = httpClient;\n            _logger = logger;\n            _httpContextAccessor = httpContextAccessor;\n        }\n        public async Task<List<TemplateMetadataDto>> FetchTemplatesAsync(Guid businessId)\n        {\n            var templates = new List<TemplateMetadataDto>();\n\n            var setting = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"WhatsApp Settings not found for BusinessId: {BusinessId}\", businessId);\n                return templates;\n            }\n\n            // Canonical provider\n            var provider = (setting.Provider ?? string.Empty)\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n            // Common base url normalization\n            var rawBase = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            try\n            {\n                // ==================== META_CLOUD ====================\n                if (provider == \"META_CLOUD\")\n                {\n                    var baseUrl = string.IsNullOrWhiteSpace(rawBase)\n                        ? \"https://graph.facebook.com/v22.0\"\n                        : rawBase;\n\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey) || string.IsNullOrWhiteSpace(setting.WabaId))\n                    {\n                        _logger.LogWarning(\"Missing Meta ApiKey or WABA ID for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    _httpClient.DefaultRequestHeaders.Authorization =\n                        new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n\n                    var nextUrl = $\"{baseUrl}/{setting.WabaId!.Trim()}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        var response = await _httpClient.GetAsync(nextUrl);\n                        var json = await response.Content.ReadAsStringAsync();\n                        _logger.LogInformation(\"üì¶ Meta Template API Raw JSON for {BusinessId}:\\n{Json}\", setting.BusinessId, json);\n\n                        if (!response.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Failed to fetch templates from Meta: {Response}\", json);\n                            break;\n                        }\n\n                        dynamic parsed = JsonConvert.DeserializeObject(json);\n                        templates.AddRange(ParseTemplatesFromMetaLikePayload(parsed));\n                        nextUrl = parsed?.paging?.next?.ToString();\n                    }\n\n                    return templates;\n                }\n\n                // ==================== PINNACLE ====================\n                if (provider == \"PINNACLE\")\n                {\n                    // Ensure base has /v3\n                    var baseUrl = string.IsNullOrWhiteSpace(rawBase) ? \"https://partnersv1.pinbot.ai\" : rawBase;\n                    if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase)) baseUrl += \"/v3\";\n\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    {\n                        _logger.LogWarning(\"Pinnacle ApiKey missing for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    // Prefer WABA; otherwise use the DEFAULT phoneNumberId for this business+provider\n                    var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                        ? setting.WabaId!.Trim()\n                        : await _dbContext.WhatsAppPhoneNumbers\n                            .AsNoTracking()\n                            .Where(p => p.BusinessId == businessId\n                                        && p.IsActive\n                                        && p.Provider.ToUpper() == \"PINNACLE\")\n                            .OrderByDescending(p => p.IsDefault)\n                            .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                            .Select(p => p.PhoneNumberId)\n                            .FirstOrDefaultAsync();\n\n                    if (string.IsNullOrWhiteSpace(pathId))\n                    {\n                        _logger.LogWarning(\"Pinnacle path id missing (WabaId or default PhoneNumberId) for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    // Headers Pinnacle commonly accepts\n                    _httpClient.DefaultRequestHeaders.Remove(\"apikey\");\n                    _httpClient.DefaultRequestHeaders.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n\n                    var nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        var response = await _httpClient.GetAsync(nextUrl);\n                        var json = await response.Content.ReadAsStringAsync();\n                        _logger.LogInformation(\"üì¶ Pinnacle Template API Raw JSON for {BusinessId}:\\n{Json}\", setting.BusinessId, json);\n\n                        if (!response.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Failed to fetch templates from Pinnacle: {Response}\", json);\n                            break;\n                        }\n\n                        // Many BSPs mirror Meta‚Äôs shape; also accept { data: [...] }\n                        dynamic parsed = JsonConvert.DeserializeObject(json);\n                        templates.AddRange(ParseTemplatesFromMetaLikePayload(parsed));\n                        nextUrl = parsed?.paging?.next?.ToString();\n                        if (nextUrl == null) break; // if their API doesn‚Äôt paginate\n                    }\n\n                    return templates;\n                }\n\n                // ==================== UNKNOWN ====================\n                _logger.LogInformation(\"Provider {Provider} does not support listing via API in this build.\", provider);\n                return templates;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Exception while fetching WhatsApp templates for provider {Provider}.\", provider);\n                return templates;\n            }\n        }\n\n        private static IEnumerable<TemplateMetadataDto> ParseTemplatesFromMetaLikePayload(dynamic parsed)\n        {\n            var list = new List<TemplateMetadataDto>();\n            if (parsed == null) return list;\n\n            // Prefer parsed.data; fall back to parsed.templates\n            var collection = parsed.data ?? parsed.templates;\n            if (collection == null) return list;\n\n            foreach (var tpl in collection)\n            {\n                string name = tpl.name?.ToString() ?? \"\";\n                string language = tpl.language?.ToString() ?? \"en_US\";\n                string body = \"\";\n                bool hasImageHeader = false;\n                var buttons = new List<ButtonMetadataDto>();\n\n                // components may be null for some BSPs\n                var components = tpl.components;\n                if (components != null)\n                {\n                    foreach (var component in components)\n                    {\n                        string type = component.type?.ToString()?.ToUpperInvariant();\n\n                        if (type == \"BODY\")\n                            body = component.text?.ToString() ?? \"\";\n\n                        if (type == \"HEADER\" && (component.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n                            hasImageHeader = true;\n\n                        if (type == \"BUTTONS\" && component.buttons != null)\n                        {\n                            foreach (var button in component.buttons)\n                            {\n                                try\n                                {\n                                    string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                                    string text = button.text?.ToString() ?? \"\";\n                                    int index = buttons.Count;\n\n                                    string subType = btnType switch\n                                    {\n                                        \"URL\" => \"url\",\n                                        \"PHONE_NUMBER\" => \"voice_call\",\n                                        \"QUICK_REPLY\" => \"quick_reply\",\n                                        \"COPY_CODE\" => \"copy_code\",\n                                        \"CATALOG\" => \"catalog\",\n                                        \"FLOW\" => \"flow\",\n                                        \"REMINDER\" => \"reminder\",\n                                        \"ORDER_DETAILS\" => \"order_details\",\n                                        _ => \"unknown\"\n                                    };\n\n                                    string? paramValue =\n                                        button.url != null ? button.url.ToString() :\n                                        button.phone_number != null ? button.phone_number.ToString() :\n                                        button.coupon_code != null ? button.coupon_code.ToString() :\n                                        button.flow_id != null ? button.flow_id.ToString() :\n                                        null;\n\n                                    // If BSP marks dynamic examples like Meta, respect them; otherwise be lenient\n                                    buttons.Add(new ButtonMetadataDto\n                                    {\n                                        Text = text,\n                                        Type = btnType,\n                                        SubType = subType,\n                                        Index = index,\n                                        ParameterValue = paramValue ?? \"\"\n                                    });\n                                }\n                                catch { /* ignore per-button parsing issues */ }\n                            }\n                        }\n                    }\n                }\n\n                int placeholderCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n                list.Add(new TemplateMetadataDto\n                {\n                    Name = name,\n                    Language = language,\n                    Body = body,\n                    PlaceholderCount = placeholderCount,\n                    HasImageHeader = hasImageHeader,\n                    ButtonParams = buttons\n                });\n            }\n\n            return list;\n        }\n\n        public async Task<List<TemplateForUIResponseDto>> FetchAllTemplatesAsync()\n        {\n            var result = new List<TemplateForUIResponseDto>();\n\n            var user = _httpContextAccessor.HttpContext.User;\n            var businessId = user.GetBusinessId();\n            _logger.LogInformation(\"üîé Fetching templates for BusinessId {BusinessId}\", businessId);\n\n            var setting = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.IsActive && s.BusinessId == businessId);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"‚ö†Ô∏è No active WhatsApp setting for BusinessId {BusinessId}\", businessId);\n                return result;\n            }\n\n            try\n            {\n                // Canonical provider\n                var provider = (setting.Provider ?? string.Empty)\n                    .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n                // Normalize base URL once\n                var baseRaw = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n                if (provider == \"META_CLOUD\")\n                {\n                    // Meta requires ApiKey + WABA\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey) || string.IsNullOrWhiteSpace(setting.WabaId))\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Missing ApiKey or WabaId for Meta Cloud (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    var baseUrl = string.IsNullOrWhiteSpace(baseRaw) ? \"https://graph.facebook.com/v22.0\" : baseRaw;\n                    var nextUrl = $\"{baseUrl}/{setting.WabaId!.Trim()}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n\n                        using var res = await _httpClient.SendAsync(req);\n                        var json = await res.Content.ReadAsStringAsync();\n\n                        _logger.LogInformation(\"üì¶ Meta Template API (Biz {BusinessId}) payload:\\n{Json}\", businessId, json);\n\n                        if (!res.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Meta template fetch failed (Biz {BusinessId}): {Json}\", businessId, json);\n                            break;\n                        }\n\n                        result.AddRange(ParseMetaTemplates(json));\n                        nextUrl = JsonConvert.DeserializeObject<dynamic>(json)?.paging?.next?.ToString();\n                    }\n                }\n                else if (provider == \"PINNACLE\")\n                {\n                    // Pinnacle requires ApiKey and pathId (WABA or default PhoneNumberId)\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Missing ApiKey for Pinnacle (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    // Prefer WABA; otherwise pull DEFAULT phoneNumberId from WhatsAppPhoneNumbers\n                    string? pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                        ? setting.WabaId!.Trim()\n                        : await _dbContext.WhatsAppPhoneNumbers\n                            .AsNoTracking()\n                            .Where(p => p.BusinessId == businessId\n                                        && p.IsActive\n                                        && p.Provider.ToUpper() == \"PINNACLE\")\n                            .OrderByDescending(p => p.IsDefault)\n                            .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                            .Select(p => p.PhoneNumberId)\n                            .FirstOrDefaultAsync();\n\n                    if (string.IsNullOrWhiteSpace(pathId))\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Missing WabaId or default PhoneNumberId for Pinnacle (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    var baseUrl = string.IsNullOrWhiteSpace(baseRaw) ? \"https://partnersv1.pinbot.ai\" : baseRaw;\n                    if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase)) baseUrl += \"/v3\";\n\n                    var nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                        // Common header names Pinnacle accepts\n                        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n                        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n\n                        using var res = await _httpClient.SendAsync(req);\n                        var json = await res.Content.ReadAsStringAsync();\n\n                        _logger.LogInformation(\"üì¶ Pinnacle Template API (Biz {BusinessId}) payload:\\n{Json}\", businessId, json);\n\n                        if (!res.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Pinnacle template fetch failed (Biz {BusinessId}): {Json}\", businessId, json);\n                            break;\n                        }\n\n                        // Your existing mapper handles Pinnacle/Meta-like shapes\n                        result.AddRange(ParsePinnacleTemplates(json));\n\n                        // If their API paginates like Meta, follow it; otherwise we‚Äôre done\n                        nextUrl = JsonConvert.DeserializeObject<dynamic>(json)?.paging?.next?.ToString();\n                        if (nextUrl == null) break;\n                    }\n                }\n                else\n                {\n                    _logger.LogWarning(\"‚ö†Ô∏è Unknown provider '{Provider}' for Biz {BusinessId}\", provider, businessId);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå Exception while fetching templates for BusinessId {BusinessId}\", businessId);\n            }\n\n            return result;\n        }\n\n        private List<TemplateForUIResponseDto> ParseMetaTemplates(string json)\n        {\n            var list = new List<TemplateForUIResponseDto>();\n            dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n            foreach (var tpl in parsed.data)\n            {\n                string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n                if (status != \"APPROVED\" && status != \"ACTIVE\") continue;\n\n                list.Add(BuildTemplateDtoFromComponents(tpl));\n            }\n\n            return list;\n        }\n\n        private List<TemplateForUIResponseDto> ParsePinnacleTemplates(string json)\n        {\n            var list = new List<TemplateForUIResponseDto>();\n            dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n            if (parsed?.data == null) return list;\n\n            foreach (var tpl in parsed.data)\n            {\n                // Pinnacle may not use status like Meta, adjust filter if needed\n                list.Add(BuildTemplateDtoFromComponents(tpl));\n            }\n\n            return list;\n        }\n\n        private TemplateForUIResponseDto BuildTemplateDtoFromComponents(dynamic tpl)\n        {\n            string name = tpl.name;\n            string language = tpl.language ?? \"en_US\";\n            string body = \"\";\n            bool hasImageHeader = false;\n            var buttons = new List<ButtonMetadataDto>();\n\n            foreach (var component in tpl.components)\n            {\n                string type = component.type?.ToString()?.ToUpperInvariant();\n\n                if (type == \"BODY\")\n                    body = component.text?.ToString() ?? \"\";\n\n                if (type == \"HEADER\" && (component.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n                    hasImageHeader = true;\n\n                if (type == \"BUTTONS\")\n                {\n                    foreach (var button in component.buttons)\n                    {\n                        string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                        string text = button.text?.ToString() ?? \"\";\n                        int index = buttons.Count;\n\n                        string subType = btnType switch\n                        {\n                            \"URL\" => \"url\",\n                            \"PHONE_NUMBER\" => \"voice_call\",\n                            \"QUICK_REPLY\" => \"quick_reply\",\n                            \"COPY_CODE\" => \"copy_code\",\n                            \"CATALOG\" => \"catalog\",\n                            \"FLOW\" => \"flow\",\n                            \"REMINDER\" => \"reminder\",\n                            \"ORDER_DETAILS\" => \"order_details\",\n                            _ => \"unknown\"\n                        };\n\n                        string? paramValue = button.url?.ToString() ?? button.phone_number?.ToString();\n\n                        if (subType == \"unknown\") continue;\n\n                        buttons.Add(new ButtonMetadataDto\n                        {\n                            Text = text,\n                            Type = btnType,\n                            SubType = subType,\n                            Index = index,\n                            ParameterValue = paramValue ?? \"\"\n                        });\n                    }\n                }\n            }\n\n            int placeholderCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n            return new TemplateForUIResponseDto\n            {\n                Name = name,\n                Language = language,\n                Body = body,\n                ParametersCount = placeholderCount,\n                HasImageHeader = hasImageHeader,\n                ButtonParams = buttons\n            };\n        }\n\n        //public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons)\n        //{\n        //    var setting = await _dbContext.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.IsActive && x.BusinessId == businessId);\n\n        //    if (setting == null)\n        //    {\n        //        _logger.LogWarning(\"‚ùå WhatsApp settings not found for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    var provider = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n        //    var wabaId = setting.WabaId?.Trim();\n        //    if (string.IsNullOrWhiteSpace(wabaId))\n        //    {\n        //        _logger.LogWarning(\"‚ùå Missing WABA ID for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    // Build URL + request with per-request headers\n        //    string url;\n        //    using var req = new HttpRequestMessage(HttpMethod.Get, \"\");\n\n        //    if (provider == \"pinnacle\")\n        //    {\n        //        // Pinnacle: require ApiKey; use WabaId for template listing\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Pinnacle provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://partnersv1.pinbot.ai/v3\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        // add header variants\n        //        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n        //        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n        //        // safety: also append as query (some edges require it)\n        //        url = url.Contains(\"apikey=\") ? url : $\"{url}&apikey={Uri.EscapeDataString(setting.ApiKey)}\";\n        //    }\n        //    else // meta_cloud\n        //    {\n        //        // Meta Cloud: require ApiKey; use WabaId for template listing\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Meta provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://graph.facebook.com/v22.0\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    }\n\n        //    req.RequestUri = new Uri(url);\n        //    var response = await _httpClient.SendAsync(req);\n        //    var json = await response.Content.ReadAsStringAsync();\n\n        //    if (!response.IsSuccessStatusCode)\n        //    {\n        //        _logger.LogError(\"‚ùå Failed to fetch templates (provider={Provider}) for BusinessId {BusinessId}: HTTP {Status} Body: {Body}\",\n        //            provider, businessId, (int)response.StatusCode, json);\n        //        return null;\n        //    }\n\n        //    try\n        //    {\n        //        dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n        //        var data = parsed?.data;\n        //        if (data == null)\n        //        {\n        //            _logger.LogWarning(\"‚ö†Ô∏è No 'data' array in template response (provider={Provider})\", provider);\n        //            return null;\n        //        }\n\n        //        foreach (var tpl in data)\n        //        {\n        //            string name = tpl.name;\n        //            if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n        //                continue;\n\n        //            string language = tpl.language != null ? (string)tpl.language : \"en_US\";\n        //            string body = \"\";\n        //            var buttons = new List<ButtonMetadataDto>();\n        //            bool hasImageHeader = false;\n\n        //            // components loop\n        //            foreach (var component in tpl.components)\n        //            {\n        //                string type = component.type?.ToString()?.ToUpperInvariant();\n\n        //                if (type == \"BODY\")\n        //                {\n        //                    try { body = component.text?.ToString() ?? \"\"; }\n        //                    catch { body = \"\"; }\n        //                }\n\n        //                if (type == \"HEADER\")\n        //                {\n        //                    string format = component.format?.ToString()?.ToUpperInvariant();\n        //                    if (format == \"IMAGE\") hasImageHeader = true;\n        //                }\n\n        //                if (includeButtons && type == \"BUTTONS\")\n        //                {\n        //                    foreach (var button in component.buttons)\n        //                    {\n        //                        try\n        //                        {\n        //                            string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n        //                            string text = button.text?.ToString() ?? \"\";\n        //                            int index = buttons.Count;\n\n        //                            // normalize sub-type for our app\n        //                            string subType = btnType switch\n        //                            {\n        //                                \"URL\" => \"url\",\n        //                                \"PHONE_NUMBER\" => \"voice_call\",\n        //                                \"QUICK_REPLY\" => \"quick_reply\",\n        //                                \"COPY_CODE\" => \"copy_code\",\n        //                                \"CATALOG\" => \"catalog\",\n        //                                \"FLOW\" => \"flow\",\n        //                                \"REMINDER\" => \"reminder\",\n        //                                \"ORDER_DETAILS\" => \"order_details\",\n        //                                _ => \"unknown\"\n        //                            };\n\n        //                            // Known dynamic param extraction\n        //                            string? paramValue = null;\n        //                            if (button.url != null)\n        //                                paramValue = button.url.ToString();\n        //                            else if (button.phone_number != null)\n        //                                paramValue = button.phone_number.ToString();\n        //                            else if (button.coupon_code != null)\n        //                                paramValue = button.coupon_code.ToString();\n        //                            else if (button.flow_id != null)\n        //                                paramValue = button.flow_id.ToString();\n\n        //                            // Skip truly invalid\n        //                            if (subType == \"unknown\" ||\n        //                                (paramValue == null && new[] { \"url\", \"flow\", \"copy_code\" }.Contains(subType)))\n        //                            {\n        //                                _logger.LogWarning(\"‚ö†Ô∏è Skipping button '{Text}' due to unknown type or missing required param.\", text);\n        //                                continue;\n        //                            }\n\n        //                            buttons.Add(new ButtonMetadataDto\n        //                            {\n        //                                Text = text,\n        //                                Type = btnType,\n        //                                SubType = subType,\n        //                                Index = index,\n        //                                ParameterValue = paramValue ?? \"\" // empty for static buttons\n        //                            });\n        //                        }\n        //                        catch (Exception exBtn)\n        //                        {\n        //                            _logger.LogWarning(exBtn, \"‚ö†Ô∏è Failed to parse button in template {TemplateName}\", name);\n        //                        }\n        //                    }\n        //                }\n        //            }\n\n        //            // Count {{n}} placeholders in body\n        //            int paramCount = Regex.Matches(body ?? \"\", \"{{\\\\s*\\\\d+\\\\s*}}\").Count;\n\n        //            return new TemplateMetadataDto\n        //            {\n        //                Name = name,\n        //                Language = language,\n        //                Body = body,\n        //                PlaceholderCount = paramCount,\n        //                HasImageHeader = hasImageHeader,\n        //                ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n        //            };\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"‚ùå Exception while parsing template response\");\n        //    }\n\n        //    return null;\n        //}\n        //public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons)\n        //{\n        //    var setting = await _dbContext.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.IsActive && x.BusinessId == businessId);\n\n        //    if (setting == null)\n        //    {\n        //        _logger.LogWarning(\"‚ùå WhatsApp settings not found for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    var provider = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n        //    var wabaId = setting.WabaId?.Trim();\n        //    if (string.IsNullOrWhiteSpace(wabaId))\n        //    {\n        //        _logger.LogWarning(\"‚ùå Missing WABA ID for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    // Build URL + request with per-request headers\n        //    string url;\n        //    using var req = new HttpRequestMessage(HttpMethod.Get, \"\");\n\n        //    if (provider == \"pinnacle\")\n        //    {\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Pinnacle provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://partnersv1.pinbot.ai/v3\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n        //        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n        //        url = url.Contains(\"apikey=\") ? url : $\"{url}&apikey={Uri.EscapeDataString(setting.ApiKey)}\";\n        //    }\n        //    else // meta_cloud\n        //    {\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Meta provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://graph.facebook.com/v22.0\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    }\n\n        //    req.RequestUri = new Uri(url);\n        //    var response = await _httpClient.SendAsync(req);\n        //    var json = await response.Content.ReadAsStringAsync();\n\n        //    if (!response.IsSuccessStatusCode)\n        //    {\n        //        _logger.LogError(\"‚ùå Failed to fetch templates (provider={Provider}) for BusinessId {BusinessId}: HTTP {Status} Body: {Body}\",\n        //            provider, businessId, (int)response.StatusCode, json);\n        //        return null;\n        //    }\n\n        //    try\n        //    {\n        //        dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n        //        var data = parsed?.data;\n        //        if (data == null)\n        //        {\n        //            _logger.LogWarning(\"‚ö†Ô∏è No 'data' array in template response (provider={Provider})\", provider);\n        //            return null;\n        //        }\n\n        //        foreach (var tpl in data)\n        //        {\n        //            string name = tpl.name;\n        //            if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n        //                continue;\n\n        //            string language = tpl.language != null ? (string)tpl.language : \"en_US\";\n\n        //            // ---- CHANGES START ----\n        //            string body = \"\";\n        //            string headerText = \"\";                    // collect TEXT header\n        //            bool hasImageHeader = false;\n        //            var buttons = new List<ButtonMetadataDto>();\n\n        //            foreach (var component in tpl.components)\n        //            {\n        //                string type = component.type?.ToString()?.ToUpperInvariant();\n\n        //                if (type == \"HEADER\")\n        //                {\n        //                    string format = component.format?.ToString()?.ToUpperInvariant();\n        //                    if (format == \"IMAGE\")\n        //                        hasImageHeader = true;\n\n        //                    // capture header text (can include {{n}})\n        //                    if (format == \"TEXT\")\n        //                    {\n        //                        try { headerText = component.text?.ToString() ?? \"\"; }\n        //                        catch { headerText = \"\"; }\n        //                    }\n        //                }\n\n        //                if (type == \"BODY\")\n        //                {\n        //                    try { body = component.text?.ToString() ?? \"\"; }\n        //                    catch { body = \"\"; }\n        //                }\n\n        //                if (includeButtons && type == \"BUTTONS\")\n        //                {\n        //                    foreach (var button in component.buttons)\n        //                    {\n        //                        try\n        //                        {\n        //                            string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n        //                            string text = button.text?.ToString() ?? \"\";\n        //                            int index = buttons.Count;\n\n        //                            string subType = btnType switch\n        //                            {\n        //                                \"URL\" => \"url\",\n        //                                \"PHONE_NUMBER\" => \"voice_call\",\n        //                                \"QUICK_REPLY\" => \"quick_reply\",\n        //                                \"COPY_CODE\" => \"copy_code\",\n        //                                \"CATALOG\" => \"catalog\",\n        //                                \"FLOW\" => \"flow\",\n        //                                \"REMINDER\" => \"reminder\",\n        //                                \"ORDER_DETAILS\" => \"order_details\",\n        //                                _ => \"unknown\"\n        //                            };\n\n        //                            string? paramValue = null;\n        //                            if (button.url != null) paramValue = button.url.ToString();\n        //                            else if (button.phone_number != null) paramValue = button.phone_number.ToString();\n        //                            else if (button.coupon_code != null) paramValue = button.coupon_code.ToString();\n        //                            else if (button.flow_id != null) paramValue = button.flow_id.ToString();\n\n        //                            if (subType == \"unknown\" ||\n        //                                (paramValue == null && new[] { \"url\", \"flow\", \"copy_code\" }.Contains(subType)))\n        //                            {\n        //                                _logger.LogWarning(\"‚ö†Ô∏è Skipping button '{Text}' due to unknown type or missing required param.\", text);\n        //                                continue;\n        //                            }\n\n        //                            buttons.Add(new ButtonMetadataDto\n        //                            {\n        //                                Text = text,\n        //                                Type = btnType,\n        //                                SubType = subType,\n        //                                Index = index,\n        //                                ParameterValue = paramValue ?? \"\"\n        //                            });\n        //                        }\n        //                        catch (Exception exBtn)\n        //                        {\n        //                            _logger.LogWarning(exBtn, \"‚ö†Ô∏è Failed to parse button in template {TemplateName}\", name);\n        //                        }\n        //                    }\n        //                }\n        //            }\n\n        //            // Combine header + body so your DB stores what users actually see\n        //            var combined = string.IsNullOrWhiteSpace(headerText)\n        //                ? body\n        //                : (string.IsNullOrWhiteSpace(body) ? headerText : $\"{headerText}\\n{body}\");\n\n        //            // Count {{n}} across header+body\n        //            int paramCount = Regex.Matches(combined ?? \"\", \"{{\\\\s*\\\\d+\\\\s*}}\").Count;\n        //            // ---- CHANGES END ----\n\n        //            return new TemplateMetadataDto\n        //            {\n        //                Name = name,\n        //                Language = language,\n        //                Body = combined,                         // return combined text\n        //                PlaceholderCount = paramCount,\n        //                HasImageHeader = hasImageHeader,\n        //                ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n        //            };\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"‚ùå Exception while parsing template response\");\n        //    }\n\n        //    return null;\n        //}\n        // Features/CampaignModule/Services/TemplateFetcherService.cs\n\n\n\n        public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(\n            Guid businessId,\n            string templateName,\n            bool includeButtons)\n        {\n            var row = await _dbContext.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == templateName)\n                .OrderByDescending(t => t.UpdatedAt) // or LastSyncedAt if you prefer\n                .FirstOrDefaultAsync();\n\n            if (row == null) return null;\n\n            string headerKind = \"none\";\n            string combinedBody = row.Body ?? string.Empty;\n            int placeholderCount = 0;\n\n            if (!string.IsNullOrWhiteSpace(row.RawJson))\n            {\n                // Use canonical computation from provider JSON (handles header/body/buttons & NAMED/POSITIONAL)\n                var s = TemplateJsonHelper.Summarize(row.RawJson, row.Body);\n                headerKind = s.HeaderKind ?? \"none\";\n                combinedBody = s.CombinedBody ?? string.Empty;\n                placeholderCount = s.PlaceholderCount;\n            }\n            else\n            {\n                // No RawJson: fall back to counting tokens in body and buttons JSON\n                placeholderCount =\n                    CountTokensFlexible(combinedBody) +\n                    CountButtonTokensFromButtonsJson(row.UrlButtons);\n            }\n\n            var buttons = includeButtons ? ParseButtons(row.UrlButtons) : new List<ButtonMetadataDto>();\n\n            return new TemplateMetadataDto\n            {\n                Name = row.Name,\n                Language = row.LanguageCode ?? \"en_US\",\n                Body = combinedBody,\n                PlaceholderCount = placeholderCount,\n                HeaderKind = headerKind,\n                HasImageHeader = string.Equals(headerKind, \"image\", StringComparison.OrdinalIgnoreCase), // back-compat\n                ButtonParams = buttons\n            };\n        }\n\n        // -------- helpers (keep inside the same class) --------\n\n        private static readonly Regex PositionalToken =\n            new(@\"\\{\\{\\s*\\d+\\s*\\}\\}\", RegexOptions.Compiled); // {{1}}, {{ 2 }}, etc.\n\n        private static readonly Regex NamedToken =\n            new(@\"\\{\\{\\s*\\}\\}\", RegexOptions.Compiled);        // {{}} (NAMED format slot)\n\n        private static int CountTokensFlexible(string? text)\n        {\n            if (string.IsNullOrEmpty(text)) return 0;\n            return PositionalToken.Matches(text).Count + NamedToken.Matches(text).Count;\n        }\n\n        private static int CountButtonTokensFromButtonsJson(string? buttonsJson)\n        {\n            if (string.IsNullOrWhiteSpace(buttonsJson)) return 0;\n\n            try\n            {\n                var arr = JArray.Parse(buttonsJson);\n                int total = 0;\n                foreach (var b in arr)\n                {\n                    // Your ButtonsJson comes from ButtonMetadataDto serialization and includes \"ParameterValue\"\n                    var val = b?[\"ParameterValue\"]?.ToString();\n                    total += CountTokensFlexible(val);\n                }\n                return total;\n            }\n            catch\n            {\n                // If ButtonsJson is malformed, don't block reads‚Äîjust report 0 extras.\n                return 0;\n            }\n        }\n\n\n\n\n        private static string DetectHeaderKind(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var header = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase));\n                var fmt = ((string?)header?[\"format\"] ?? \"\").ToLowerInvariant(); // \"\", \"text\", \"image\", \"video\", \"document\", \"location\"\n                return string.IsNullOrWhiteSpace(fmt) ? \"none\" : fmt;\n            }\n            catch { return \"none\"; }\n        }\n\n        private static string CombineTextHeaderAndBody(string? rawJson, string? fallbackBody)\n        {\n            var headerText = ExtractTextHeader(rawJson);\n            var bodyText = ExtractBodyText(rawJson);\n            if (string.IsNullOrWhiteSpace(bodyText)) bodyText = fallbackBody ?? \"\";\n            if (!string.IsNullOrWhiteSpace(headerText))\n                return headerText.TrimEnd() + \"\\n\" + (bodyText ?? \"\");\n            return bodyText ?? \"\";\n        }\n\n        private static string ExtractTextHeader(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var header = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase));\n                if (header == null) return \"\";\n                if (!string.Equals((string?)header[\"format\"], \"TEXT\", StringComparison.OrdinalIgnoreCase)) return \"\";\n                return header[\"text\"]?.ToString() ?? \"\";\n            }\n            catch { return \"\"; }\n        }\n\n        private static string ExtractBodyText(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var body = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BODY\", StringComparison.OrdinalIgnoreCase));\n                return body?[\"text\"]?.ToString() ?? \"\";\n            }\n            catch { return \"\"; }\n        }\n\n        private static List<ButtonMetadataDto> ParseButtons(string? buttonsJson)\n        {\n            try\n            {\n                var arr = JArray.Parse(string.IsNullOrWhiteSpace(buttonsJson) ? \"[]\" : buttonsJson);\n                return arr.Select(j => new ButtonMetadataDto\n                {\n                    Text = (string?)j[\"Text\"] ?? \"\",\n                    Type = (string?)j[\"Type\"] ?? \"URL\",\n                    SubType = ((string?)j[\"SubType\"] ?? \"url\").ToLowerInvariant(),\n                    Index = (int?)j[\"Index\"] ?? 0,\n                    ParameterValue = (string?)j[\"ParameterValue\"] ?? \"\"\n                }).ToList();\n            }\n            catch { return new List<ButtonMetadataDto>(); }\n        }\n\n\n        private static TemplateMetadataDto? ExtractTemplateFromListJson(string json, string templateName, bool includeButtons)\n        {\n            var root = JObject.Parse(json);\n            var data = root[\"data\"] as JArray;\n            if (data == null) return null;\n\n            foreach (var tplToken in data.OfType<JObject>())\n            {\n                var name = tplToken.Value<string>(\"name\") ?? \"\";\n                if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var language = tplToken.Value<string>(\"language\") ?? \"en_US\";\n                var components = tplToken[\"components\"] as JArray;\n\n                string body = \"\";\n                bool hasImageHeader = false;\n                var buttons = new List<ButtonMetadataDto>();\n\n                if (components != null)\n                {\n                    foreach (var comp in components.OfType<JObject>())\n                    {\n                        var type = (comp.Value<string>(\"type\") ?? \"\").ToUpperInvariant();\n\n                        if (type == \"BODY\")\n                        {\n                            body = comp.Value<string>(\"text\") ?? body;\n                        }\n                        else if (type == \"HEADER\")\n                        {\n                            var fmt = (comp.Value<string>(\"format\") ?? \"\").ToUpperInvariant();\n                            if (fmt == \"IMAGE\") hasImageHeader = true;\n                        }\n                        else if (includeButtons && type == \"BUTTONS\")\n                        {\n                            var btns = comp[\"buttons\"] as JArray;\n                            if (btns == null) continue;\n\n                            var idx = 0;\n                            foreach (var b in btns.OfType<JObject>())\n                            {\n                                var btnTypeRaw = (b.Value<string>(\"type\") ?? \"\").ToUpperInvariant();\n                                var text = b.Value<string>(\"text\") ?? \"\";\n\n                                var subType = btnTypeRaw switch\n                                {\n                                    \"URL\" => \"url\",\n                                    \"PHONE_NUMBER\" => \"voice_call\",\n                                    \"QUICK_REPLY\" => \"quick_reply\",\n                                    \"COPY_CODE\" => \"copy_code\",\n                                    \"CATALOG\" => \"catalog\",\n                                    \"FLOW\" => \"flow\",\n                                    \"REMINDER\" => \"reminder\",\n                                    \"ORDER_DETAILS\" => \"order_details\",\n                                    _ => \"unknown\"\n                                };\n\n                                string? paramValue =\n                                    b.Value<string>(\"url\") ??\n                                    b.Value<string>(\"phone_number\") ??\n                                    b.Value<string>(\"coupon_code\") ??\n                                    b.Value<string>(\"flow_id\");\n\n                                // Skip unknown or missing required dynamic values\n                                if (subType == \"unknown\") continue;\n                                if ((subType is \"url\" or \"flow\" or \"copy_code\") && string.IsNullOrWhiteSpace(paramValue))\n                                    continue;\n\n                                buttons.Add(new ButtonMetadataDto\n                                {\n                                    Text = text,\n                                    Type = btnTypeRaw,\n                                    SubType = subType,\n                                    Index = idx++,\n                                    ParameterValue = paramValue ?? \"\"\n                                });\n                            }\n                        }\n                    }\n                }\n\n                var paramCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n                return new TemplateMetadataDto\n                {\n                    Name = name,\n                    Language = language,\n                    Body = body ?? \"\",\n                    PlaceholderCount = paramCount,\n                    HasImageHeader = hasImageHeader,\n                    ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n                };\n            }\n\n            return null;\n        }\n\n        // --- NEW: DB-backed meta projection methods ---\n        // List all template meta for a business (optionally filter by provider)\n        public async Task<IReadOnlyList<TemplateMetaDto>> GetTemplatesMetaAsync(Guid businessId, string? provider = null)\n        {\n            var q = _dbContext.WhatsAppTemplates\n                              .AsNoTracking()\n                              .Where(t => t.BusinessId == businessId && t.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(provider))\n                q = q.Where(t => t.Provider == provider);\n\n            // Pull only what we need, then map (keeps allocations low on hot paths)\n            var rows = await q.ToListAsync();\n            var result = new List<TemplateMetaDto>(rows.Count);\n            foreach (var row in rows)\n                result.Add(MapRowToMeta(row));\n            return result;\n        }\n\n        // Get a single template meta by name (+ optional language/provider)\n        public async Task<TemplateMetaDto?> GetTemplateMetaAsync(\n    Guid businessId,\n    string templateName,\n    string? language = null,\n    string? provider = null)\n        {\n            if (string.IsNullOrWhiteSpace(templateName))\n                return null;\n\n            var lang = language?.Trim();\n            var prov = string.IsNullOrWhiteSpace(provider) ? null : provider!.Trim().ToUpperInvariant();\n\n            // Base: active rows for this business\n            var q = _dbContext.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive);\n\n            // First try: treat templateName as provider TemplateId (exact match)\n            var byIdQ = q.Where(t => t.TemplateId == templateName);\n            if (prov != null) byIdQ = byIdQ.Where(t => t.Provider == prov);\n            if (lang != null) byIdQ = byIdQ.Where(t => t.LanguageCode == lang);\n\n            var pick = await byIdQ\n                .OrderByDescending(t => t.UpdatedAt)\n                .ThenByDescending(t => t.LastSyncedAt)\n                .ThenByDescending(t => t.CreatedAt)\n                .FirstOrDefaultAsync();\n\n            if (pick == null)\n            {\n                // Second try: match by logical Name (+provider/lang if provided)\n                var byNameQ = q.Where(t => t.Name == templateName);\n                if (prov != null) byNameQ = byNameQ.Where(t => t.Provider == prov);\n\n                // Prefer an exact language match if provided; then fall back to newest any-language\n                if (!string.IsNullOrWhiteSpace(lang))\n                {\n                    pick = await byNameQ\n                        .OrderByDescending(t => t.LanguageCode == lang) // exact lang first\n                        .ThenByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .ThenByDescending(t => t.CreatedAt)\n                        .FirstOrDefaultAsync();\n                }\n                else\n                {\n                    pick = await byNameQ\n                        .OrderByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .ThenByDescending(t => t.CreatedAt)\n                        .FirstOrDefaultAsync();\n                }\n            }\n\n            return pick == null ? null : MapRowToMeta(pick);\n        }\n\n\n        // Map persisted catalog row ‚Üí TemplateMetaDto\n        //private DTO.TemplateMetaDto MapRowToMeta(dynamic row)\n        //{\n        //    var meta = new DTO.TemplateMetaDto\n        //    {\n        //        Provider = row.Provider ?? \"\",\n        //        TemplateId = row.ExternalId ?? row.TemplateId ?? \"\",\n        //        TemplateName = row.Name ?? \"\",\n        //        Language = row.Language ?? \"\",\n        //        HasHeaderMedia = row.HasImageHeader ?? false,\n        //        HeaderType = (row.HasImageHeader ?? false) ? \"IMAGE\" : \"\"\n        //    };\n\n        //    int count = 0;\n        //    try { count = Convert.ToInt32(row.PlaceholderCount ?? 0); } catch { count = 0; }\n\n        //    meta.BodyPlaceholders = Enumerable.Range(1, Math.Max(0, count))\n        //                                      .Select(i => new DTO.PlaceholderSlot { Index = i })\n        //                                      .ToList();\n\n        //    // ButtonsJson ‚Üí TemplateButtonMeta[]\n        //    meta.Buttons = new List<DTO.TemplateButtonMeta>();\n        //    try\n        //    {\n        //        string buttonsJson = row.ButtonsJson ?? \"\";\n        //        if (!string.IsNullOrWhiteSpace(buttonsJson))\n        //        {\n        //            using var doc = JsonDocument.Parse(buttonsJson);\n        //            if (doc.RootElement.ValueKind == JsonValueKind.Array)\n        //            {\n        //                int i = 0;\n        //                foreach (var el in doc.RootElement.EnumerateArray())\n        //                {\n        //                    var type = el.TryGetProperty(\"Type\", out var p1) ? p1.GetString() ?? \"\"\n        //                              : el.TryGetProperty(\"type\", out var p1b) ? p1b.GetString() ?? \"\" : \"\";\n        //                    var text = el.TryGetProperty(\"Text\", out var p2) ? p2.GetString() ?? \"\"\n        //                              : el.TryGetProperty(\"text\", out var p2b) ? p2b.GetString() ?? \"\" : \"\";\n        //                    var value = el.TryGetProperty(\"ParameterValue\", out var p3) ? p3.GetString()\n        //                              : el.TryGetProperty(\"value\", out var p3b) ? p3b.GetString() : null;\n        //                    var order = el.TryGetProperty(\"Index\", out var p4) && p4.ValueKind == JsonValueKind.Number\n        //                              ? p4.GetInt32()\n        //                              : i;\n\n        //                    meta.Buttons.Add(new DTO.TemplateButtonMeta\n        //                    {\n        //                        Type = type,\n        //                        Text = text,\n        //                        Value = value,\n        //                        Order = order\n        //                    });\n        //                    i++;\n        //                }\n        //            }\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogWarning(ex, \"Failed to parse ButtonsJson for template {TemplateName}\", (string)(row.Name ?? \"(unknown)\"));\n        //    }\n\n        //    return meta;\n        //}\n        // add near the class top (once)\n        // helpers (place near the class top)\n        private static readonly Regex _phRx = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        private static int DistinctMaxPlaceholderIndex(string? text)\n        {\n            if (string.IsNullOrWhiteSpace(text)) return 0;\n            var m = _phRx.Matches(text);\n            int max = 0;\n            var seen = new HashSet<int>();\n            foreach (Match x in m)\n            {\n                if (int.TryParse(x.Groups[1].Value, out var i) && seen.Add(i) && i > max)\n                    max = i;\n            }\n            return max;\n        }\n\n        private static bool TryGetPropCI(JsonElement obj, string name, out JsonElement value)\n        {\n            foreach (var p in obj.EnumerateObject())\n            {\n                if (string.Equals(p.Name, name, StringComparison.OrdinalIgnoreCase))\n                {\n                    value = p.Value;\n                    return true;\n                }\n            }\n            value = default;\n            return false;\n        }\n\n        // Minimal allocations; assumes DTO types live in xbytechat.api.WhatsAppSettings.DTOs\n        private static TemplateMetaDto MapRowToMeta(WhatsAppTemplate row)\n        {\n            // Provider + IDs\n            var dto = new TemplateMetaDto\n            {\n                Provider = row.Provider,                   // \"META_CLOUD\" | \"PINNACLE\"\n                TemplateId = row.TemplateId ?? \"\",\n                TemplateName = row.Name,\n                Language = row.LanguageCode,               // <- final field\n            };\n\n            // Header/media\n            var hk = (row.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n            dto.HasHeaderMedia = row.RequiresMediaHeader || hk is \"image\" or \"video\" or \"document\";\n            dto.HeaderType = hk switch\n            {\n                \"image\" => \"IMAGE\",\n                \"video\" => \"VIDEO\",\n                \"document\" => \"DOCUMENT\",\n                _ => null\n            };\n\n            // BODY placeholders: we only store counts now, so synthesize 1..BodyVarCount\n            // (TemplateMetaDto consumers only need index order for preview/validation)\n            dto.BodyPlaceholders = new List<PlaceholderSlot>(row.BodyVarCount);\n            for (int i = 1; i <= row.BodyVarCount; i++)\n                dto.BodyPlaceholders.Add(new PlaceholderSlot { Index = i });\n\n            // Buttons (up to 3): reconstruct from UrlButtons (+ quick-replies + phone)\n            // UrlButtons json shape we persisted: [{ index, parameters:[...] }, ...]\n            var buttons = new List<TemplateButtonMeta>(3);\n\n            // URL buttons first (keep template order if present)\n            if (!string.IsNullOrWhiteSpace(row.UrlButtons))\n            {\n                try\n                {\n                    var arr = Newtonsoft.Json.Linq.JArray.Parse(row.UrlButtons);\n                    foreach (var j in arr)\n                    {\n                        if (buttons.Count >= 3) break;\n                        var order = (int?)j?[\"index\"] ?? buttons.Count; // fallback order\n                        buttons.Add(new TemplateButtonMeta\n                        {\n                            Type = \"URL\",\n                            Text = \"\",     // label not stored; UI doesn‚Äôt require it for preview send\n                            Value = null,   // value may contain \"{{1}}\" at send-time\n                            Order = order\n                        });\n                    }\n                }\n                catch { /* ignore malformed json */ }\n            }\n\n            // Phone button (at most one)\n            if (buttons.Count < 3 && row.HasPhoneButton)\n            {\n                buttons.Add(new TemplateButtonMeta\n                {\n                    Type = \"PHONE_NUMBER\",\n                    Text = \"\",\n                    Value = null,\n                    Order = buttons.Count\n                });\n            }\n\n            // Quick replies (add as many as persisted, up to remaining slots)\n            var toAdd = Math.Min(row.QuickReplyCount, Math.Max(0, 3 - buttons.Count));\n            for (int i = 0; i < toAdd; i++)\n            {\n                buttons.Add(new TemplateButtonMeta\n                {\n                    Type = \"QUICK_REPLY\",\n                    Text = \"\",\n                    Value = null,\n                    Order = buttons.Count\n                });\n            }\n\n            dto.Buttons = buttons;\n            return dto;\n        }\n\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Validators/SaveWhatsAppSettingValidator.cs",
      "sha256": "c62f496266c20b4463c4b43923cd1c1a3bedc5ac2141f1ab4c946716cc5c1bf3",
      "language": "csharp",
      "size": 2715,
      "content": "// üìÑ WhatsAppSettings/Validators/SaveWhatsAppSettingValidator.cs\n#nullable enable\nusing FluentValidation;\nusing xbytechat_api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Validators\n{\n    public sealed class SaveWhatsAppSettingValidator : AbstractValidator<SaveWhatsAppSettingDto>\n    {\n        public SaveWhatsAppSettingValidator()\n        {\n            // Provider\n            RuleFor(x => x.Provider)\n                .NotEmpty()\n                .Must(p => IsMeta(p) || IsPinnacle(p))\n                .WithMessage(\"Provider must be PINNACLE or META_CLOUD.\");\n\n            // ApiUrl: ONLY required when active.\n            When(x => x.IsActive, () =>\n            {\n                RuleFor(x => x.ApiUrl)\n                    .NotEmpty()\n                    .WithMessage(\"ApiUrl is required when settings are active.\");\n            });\n\n            // META_CLOUD rules\n            When(x => IsMeta(x.Provider), () =>\n            {\n                RuleFor(x => x.ApiKey)\n                    .NotEmpty()\n                    .WithMessage(\"Meta access token (ApiKey) is required for Meta Cloud.\");\n\n                // No PhoneNumberId requirement here.\n                // WabaId is allowed but not mandatory (can be filled via ESU discovery/sync).\n            });\n\n            // PINNACLE rules\n            When(x => IsPinnacle(x.Provider), () =>\n            {\n                RuleFor(x => x.ApiKey)\n                    .NotEmpty()\n                    .WithMessage(\"API Key is required for Pinnacle.\");\n\n                RuleFor(x => x)\n                    .Must(d =>\n                        !string.IsNullOrWhiteSpace(d.WabaId)\n                        || !string.IsNullOrWhiteSpace(d.PhoneNumberId))\n                    .WithMessage(\"WABA ID or PhoneNumberId required for Pinnacle.\");\n            });\n        }\n\n        // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n        private static string Canon(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return string.Empty;\n            return raw.Trim().ToUpperInvariant()\n                .Replace(\"-\", \"_\")\n                .Replace(\" \", \"_\");\n        }\n\n        private static bool IsMeta(string? raw)\n            => Canon(raw) == \"META_CLOUD\"\n               || Canon(raw) == \"META\"\n               || Canon(raw) == \"WA_CLOUD\"\n               || Canon(raw) == \"WHATSAPP_CLOUD\"\n               || Canon(raw) == \"FACEBOOK\";\n\n        private static bool IsPinnacle(string? raw)\n            => Canon(raw) == \"PINNACLE\"\n               || Canon(raw) == \"PINBOT\"\n               || Canon(raw) == \"PINNACLE_OFFICIAL\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api.http",
      "sha256": "1bbe81fafd8a4f5140ffd5c7e14b21f6d5537372ed3c3b6315b9db805b17f2a9",
      "language": "text",
      "size": 133,
      "content": "@xbytechat.api_HostAddress = http://localhost:5295\n\nGET {{xbytechat.api_HostAddress}}/weatherforecast/\nAccept: application/json\n\n###\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Common/Utils/Idempotency.cs",
      "sha256": "ead3c94c377e056a1bc9a00a7b1d1cb697a748828ba3a42e2d88231806788770",
      "language": "csharp",
      "size": 668,
      "content": "using System;\nusing System.Security.Cryptography;\nusing System.Text;\n\nnamespace xbytechat.api.Common.Utils\n{\n    public static class Idempotency\n    {\n        /// <summary>\n        /// SHA256 over a canonical string. Returns lowercase hex.\n        /// </summary>\n        public static string Sha256(string canonical)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(canonical ?? string.Empty);\n            var hash = sha.ComputeHash(bytes);\n            var sb = new StringBuilder(hash.Length * 2);\n            foreach (var b in hash) sb.Append(b.ToString(\"x2\"));\n            return sb.ToString();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/AuditLoggingHelper.cs",
      "sha256": "c5b311d19b5c69b6b78d7ca335b984e43795ef1e140c2239dea1ed7190e188c6",
      "language": "csharp",
      "size": 1690,
      "content": "using xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Features.AuditTrail.Services;\n\npublic static class AuditLoggingHelper\n{\n    private static IServiceProvider? _serviceProvider;\n\n    public static void Configure(IServiceProvider serviceProvider)\n    {\n        _serviceProvider = serviceProvider;\n    }\n\n    public static void Log(\n        string actionType,\n        string? entityName,\n        string? entityId,\n        string? description,\n        IHttpContextAccessor contextAccessor)\n    {\n        if (_serviceProvider == null) return;\n\n        var scope = _serviceProvider.CreateScope();\n        var auditLogService = scope.ServiceProvider.GetRequiredService<IAuditLogService>();\n\n        var httpContext = contextAccessor.HttpContext;\n        var user = httpContext?.User;\n        var claims = user?.Identities?.FirstOrDefault();\n\n        var log = new AuditLog\n        {\n            Id = Guid.NewGuid(),\n            ActionType = actionType,\n            Description = description,\n            BusinessId = TryParseGuid(claims?.FindFirst(\"businessId\")?.Value),\n            PerformedByUserId = TryParseGuid(claims?.FindFirst(\"sub\")?.Value),\n            PerformedByUserName = claims?.FindFirst(\"email\")?.Value,\n            RoleAtTime = claims?.FindFirst(\"role\")?.Value,\n            IPAddress = httpContext?.Connection?.RemoteIpAddress?.ToString(),\n            UserAgent = httpContext?.Request?.Headers[\"User-Agent\"].ToString(),\n            CreatedAt = DateTime.UtcNow\n        };\n\n        _ = Task.Run(() => auditLogService.SaveLogAsync(log));\n    }\n\n    private static Guid TryParseGuid(string? input) =>\n        Guid.TryParse(input, out var guid) ? guid : Guid.Empty;\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/JwtCookieHelper.cs",
      "sha256": "50ed48ffead96168a429fe26398cbc9b3021ecfebafabcbba8dc8e59f9a12885",
      "language": "csharp",
      "size": 3279,
      "content": "// üìÑ File: Helpers/JwtCookieHelper.cs\nusing Microsoft.AspNetCore.Http;\nusing System;\n\nnamespace xbytechat.api.Helpers\n{\n    public static class JwtCookieHelper\n    {\n        // ‚úÖ Set Access Token (short-lived)\n        public static void SetJwtCookie(HttpContext httpContext, string cookieName, string token, int expiryHours = 12)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"‚ö†Ô∏è Cannot set JWT cookie '{cookieName}' ‚Äî response already started.\");\n                return;\n            }\n\n            bool isProduction = Environment.GetEnvironmentVariable(\"ASPNETCORE_ENVIRONMENT\") == \"Production\";\n\n            httpContext.Response.Cookies.Append(cookieName, token, new CookieOptions\n            {\n                HttpOnly = true,\n                ///*Secure*/ = isProduction,\n                Secure = true,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddHours(expiryHours)\n            }); ;\n        }\n\n        // ‚úÖ Clear Access Token cookie\n        public static void ClearJwtCookie(HttpContext httpContext, string cookieName)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"‚ö†Ô∏è Cannot clear JWT cookie '{cookieName}' ‚Äî response already started.\");\n                return;\n            }\n\n            httpContext.Response.Cookies.Append(cookieName, \"\", new CookieOptions\n            {\n                HttpOnly = true,\n                Secure = true,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddDays(-1)\n            });\n        }\n\n        // ‚úÖ Set Refresh Token (long-lived)\n        public static void SetRefreshTokenCookie(HttpContext httpContext, string cookieName, string refreshToken, int expiryDays = 30)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"‚ö†Ô∏è Cannot set refresh cookie '{cookieName}' ‚Äî response already started.\");\n                return;\n            }\n\n            bool isProduction = Environment.GetEnvironmentVariable(\"ASPNETCORE_ENVIRONMENT\") == \"Production\";\n\n            httpContext.Response.Cookies.Append(cookieName, refreshToken, new CookieOptions\n            {\n                HttpOnly = true,\n                Secure = isProduction,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddDays(expiryDays)\n            });\n        }\n\n        // ‚úÖ Clear Refresh Token cookie\n        public static void ClearRefreshTokenCookie(HttpContext httpContext, string cookieName)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"‚ö†Ô∏è Cannot clear refresh cookie '{cookieName}' ‚Äî response already started.\");\n                return;\n            }\n\n            httpContext.Response.Cookies.Append(cookieName, \"\", new CookieOptions\n            {\n                HttpOnly = true,\n                Secure = true,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddDays(-1)\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/PhoneNumberNormalizer.cs",
      "sha256": "c4e912decef1b17eb37011b7a51bd71b3429ea764895be94ef9e882871985998",
      "language": "csharp",
      "size": 2824,
      "content": "// üìÑ xbytechat-api/Helpers/PhoneNumberNormalizer.cs\nusing System;\nusing System.Linq;\nusing PhoneNumbers;\n\nnamespace xbytechat.api.Helpers\n{\n    /// <summary>\n    /// Canonical phone format for xByteChat:\n    /// ‚úÖ E.164 digits-only (NO '+')\n    /// Example: \"+91 98765 43210\" => \"919876543210\"\n    /// </summary>\n    public static class PhoneNumberNormalizer\n    {\n        private static readonly PhoneNumberUtil Util = PhoneNumberUtil.GetInstance();\n\n        /// <summary>\n        /// Normalize any input into E.164 digits-only (no '+').\n        /// Returns null if invalid/unparseable.\n        ///\n        /// Rules:\n        /// - Accepts \"+E.164\" and \"00\" prefix (converted to '+')\n        /// - If input is local digits without '+', parses using defaultRegion\n        /// - Output is ALWAYS digits-only E.164 (country code included)\n        /// - If parsing fails:\n        ///    - If defaultRegion is IN and digits length == 10, assume IN (prepend \"91\")\n        ///    - Otherwise return null (do NOT guess) to avoid identity corruption\n        /// </summary>\n        public static string? NormalizeToE164Digits(string? input, string defaultRegion = \"IN\")\n        {\n            if (string.IsNullOrWhiteSpace(input))\n                return null;\n\n            // Keep digits and leading '+'\n            var cleaned = new string(input.Trim().Where(ch => char.IsDigit(ch) || ch == '+').ToArray());\n\n            // Common \"00\" international prefix => \"+\"\n            if (cleaned.StartsWith(\"00\", StringComparison.Ordinal))\n                cleaned = \"+\" + cleaned.Substring(2);\n\n            try\n            {\n                // If it starts with '+', parse as international; else parse using defaultRegion.\n                var parsed = Util.Parse(cleaned, cleaned.StartsWith(\"+\", StringComparison.Ordinal) ? null : defaultRegion);\n\n                if (!Util.IsValidNumber(parsed))\n                    return null;\n\n                var e164 = Util.Format(parsed, PhoneNumberFormat.E164); // \"+919876...\"\n                return e164.TrimStart('+'); // \"919876...\"\n            }\n            catch\n            {\n                // Fallback: digits-only sanity check (E.164 max 15 digits)\n                var digits = new string(cleaned.Where(char.IsDigit).ToArray());\n                if (digits.Length < 7 || digits.Length > 15) return null;\n\n                // If defaultRegion is IN and someone entered 10 digits, assume IN\n                if (defaultRegion.Equals(\"IN\", StringComparison.OrdinalIgnoreCase) && digits.Length == 10)\n                    return \"91\" + digits;\n\n                // Otherwise, DO NOT guess. Force user/business to provide a parseable number.\n                // This avoids silently storing ambiguous identities (e.g., \"9876543210\").\n                return null;\n            }\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/ResponseResult.cs",
      "sha256": "7b5c50a2cdf8601d56a0e89eb3099fdcc2078674de55eb9fe3189d92a3977561",
      "language": "csharp",
      "size": 6436,
      "content": "//namespace xbytechat.api.Helpers\n//{\n//    /// <summary>\n//    /// Represents a standardized response structure for service layer results.\n//    /// </summary>\n//    public class ResponseResult\n//    {\n//        public bool Success { get; set; }                  // ‚úÖ Whether operation succeeded\n//        public string Message { get; set; }                // ‚úÖ User-friendly message\n//        public object? Data { get; set; }                  // Optional payload (if needed)\n\n//        // ‚úÖ WhatsApp-specific diagnostics\n//        public string? ErrorMessage { get; set; }          // Error from API or exception\n//        public string? RawResponse { get; set; }           // Full API raw response\n\n//        public string? MessageId { get; set; } // üåê WhatsApp WAMID (Message ID)\n\n//        public Guid? LogId { get; set; } // ‚úÖ Unique ID of MessageLog for tracking\n//                                         // ‚úÖ Factory method for successful result\n\n//        public string? Token { get; set; }\n\n//        public string? RefreshToken { get; set; }\n//        public static ResponseResult SuccessInfo(string message, object? data = null, string? raw = null)\n//        {\n//            return new ResponseResult\n//            {\n//                Success = true,\n//                Message = message,\n//                Data = data,\n//                RawResponse = raw\n//            };\n//        }\n\n//        // ‚ùå Factory method for error result\n//        public static ResponseResult ErrorInfo(string message, string? error = null, string? raw = null)\n//        {\n//            return new ResponseResult\n//            {\n//                Success = false,\n//                Message = message,\n//                ErrorMessage = error,\n//                RawResponse = raw\n//            };\n//        }\n//    }\n//}\nusing System;\nusing System.Net;\n\nnamespace xbytechat.api.Helpers\n{\n    /// <summary>\n    /// Standard service-layer result with optional HTTP-like status code and payload.\n    /// Backward-compatible with existing callers that use SuccessInfo/ErrorInfo/Data.\n    /// </summary>\n    public class ResponseResult\n    {\n        // Primary flags\n        public bool Success { get; set; }                 // Whether operation succeeded\n        public string Message { get; set; } = string.Empty;\n\n        // Optional status code (HTTP-like, but not tied to ASP.NET)\n        public int Code { get; set; } = (int)HttpStatusCode.OK;\n\n        // Primary payload (prefer this going forward)\n        public object? Payload { get; set; }\n\n        // Back-compat data field (kept to avoid breaking callers)\n        public object? Data { get; set; }\n\n        // WhatsApp / diagnostics (retained)\n        public string? ErrorMessage { get; set; }\n        public string? RawResponse { get; set; }\n        public string? MessageId { get; set; }\n        public Guid? LogId { get; set; }\n        public string? Token { get; set; }\n        public string? RefreshToken { get; set; }\n\n        // ---- Factory helpers (preferred) ----\n        public static ResponseResult Ok(string message = \"OK\", object? payload = null)\n            => new()\n            {\n                Success = true,\n                Code = (int)HttpStatusCode.OK,\n                Message = message,\n                Payload = payload,\n                Data = payload // keep Data in sync for legacy consumers\n            };\n\n        public static ResponseResult Created(string message = \"Created\", object? payload = null)\n            => new()\n            {\n                Success = true,\n                Code = (int)HttpStatusCode.Created,\n                Message = message,\n                Payload = payload,\n                Data = payload\n            };\n\n        public static ResponseResult NotFound(string message = \"Not found\", object? payload = null)\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.NotFound,\n                Message = message,\n                Payload = payload\n            };\n\n        public static ResponseResult Conflict(string message = \"Conflict\", object? payload = null)\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.Conflict,\n                Message = message,\n                Payload = payload\n            };\n\n        public static ResponseResult BadRequest(string message = \"Bad request\", object? payload = null, string? error = null)\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.BadRequest,\n                Message = message,\n                Payload = payload,\n                ErrorMessage = error\n            };\n\n        public static ResponseResult Forbidden(string message = \"Forbidden\")\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.Forbidden,\n                Message = message\n            };\n\n        public static ResponseResult FromException(Exception ex, string message = \"Unexpected error\")\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.InternalServerError,\n                Message = message,\n                ErrorMessage = ex.Message,\n                RawResponse = ex.ToString()\n            };\n\n        // ---- Backward-compatible helpers (kept; route to new ones) ----\n\n        /// <summary>\n        /// Legacy success. Prefer Ok(...) going forward.\n        /// </summary>\n        public static ResponseResult SuccessInfo(string message, object? data = null, string? raw = null)\n        {\n            return new ResponseResult\n            {\n                Success = true,\n                Code = (int)HttpStatusCode.OK,\n                Message = message,\n                Payload = data,\n                Data = data,\n                RawResponse = raw\n            };\n        }\n\n        /// <summary>\n        /// Legacy error. Prefer BadRequest/Conflict/NotFound/... going forward.\n        /// </summary>\n        public static ResponseResult ErrorInfo(string message, string? error = null, string? raw = null)\n        {\n            return new ResponseResult\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.BadRequest,\n                Message = message,\n                ErrorMessage = error,\n                RawResponse = raw\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/SendResultExtended.cs",
      "sha256": "d70ced23d36d879eb80982f4a2508398175f5a06bc3e524c5c426cfe59635a0a",
      "language": "csharp",
      "size": 252,
      "content": "using xbytechat.api.Helpers;\n\npublic class SendResultExtended : ResponseResult\n{\n   // public string? MessageId { get; set; }         // WAMID from WhatsApp\n    public Guid? MessageLogId { get; set; }        // Our DB log ID (from MessageLogs table)\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/UserContextHelper.cs",
      "sha256": "ebabfd85a8a344a40535bccbbdb67a5241b585ecca9f9688e3eb6201b71fda0d",
      "language": "csharp",
      "size": 1432,
      "content": "using System.Security.Claims;\n\nnamespace xbytechat.api.Helpers\n{\n    public static class UserContextHelper\n    {\n        /// <summary>\n        /// Returns the logged-in user's unique ID from JWT.\n        /// </summary>\n        public static Guid GetUserId(ClaimsPrincipal user)\n        {\n            return Guid.TryParse(user.FindFirst(\"sub\")?.Value, out var id) ? id : Guid.Empty;\n        }\n\n        /// <summary>\n        /// Returns the business ID (tenant) from JWT claims.\n        /// </summary>\n        public static Guid GetBusinessId(ClaimsPrincipal user)\n        {\n            return Guid.TryParse(user.FindFirst(\"businessId\")?.Value, out var id) ? id : Guid.Empty;\n        }\n\n        /// <summary>\n        /// Returns the role of the logged-in user.\n        /// </summary>\n        public static string GetRole(ClaimsPrincipal user)\n        {\n            return user.FindFirst(\"role\")?.Value ?? \"\";\n        }\n\n        /// <summary>\n        /// Returns company name for UI display (optional).\n        /// </summary>\n        public static string GetCompanyName(ClaimsPrincipal user)\n        {\n            return user.FindFirst(\"companyName\")?.Value ?? \"\";\n        }\n\n        /// <summary>\n        /// Returns plan info if needed for plan-based access control.\n        /// </summary>\n        public static string GetPlan(ClaimsPrincipal user)\n        {\n            return user.FindFirst(\"plan\")?.Value ?? \"\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat.api.csproj",
      "sha256": "03b48810d1f2e694ff8d48e94ad9cc3c7a88ff1f6451d821c93dc80fad2429c1",
      "language": "text",
      "size": 4191,
      "content": "<Project Sdk=\"Microsoft.NET.Sdk.Web\">\n\n  <PropertyGroup>\n    <TargetFramework>net8.0</TargetFramework>\n    <Nullable>enable</Nullable>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <RootNamespace>xbytechat.api</RootNamespace>\n    <UserSecretsId>54c16f50-f987-4162-a877-70088aa68997</UserSecretsId>\n    <EnableDefaultItems>true</EnableDefaultItems>\n  </PropertyGroup>\n\n  <!-- Intentional removals (keep as-is) -->\n  <ItemGroup>\n    <Compile Remove=\"Controllers\\BusinessLoginController.cs\" />\n    <Compile Remove=\"Controllers\\SendMessageController.cs\" />\n    <Compile Remove=\"Features\\Audiences\\DTOs\\CampaignVariableMapDtos.cs\" />\n    <Compile Remove=\"Features\\ESU\\Shared\\EsuFlagKeys.cs\" />\n    <Compile Remove=\"Models\\MessageLog.cs\" />\n    <Compile Remove=\"Shared\\TemplateParameterHelper.cs\" />\n  </ItemGroup>\n\n  <ItemGroup>\n    <PackageReference Include=\"AutoMapper.Extensions.Microsoft.DependencyInjection\" Version=\"12.0.0\" />\n    <PackageReference Include=\"BCrypt.Net-Next\" Version=\"4.0.3\" />\n    <PackageReference Include=\"ClosedXML\" Version=\"0.105.0\" />\n    <PackageReference Include=\"CsvHelper\" Version=\"33.0.1\" />\n    <PackageReference Include=\"EFCore.BulkExtensions\" Version=\"8.1.3\" />\n    <PackageReference Include=\"FluentValidation\" Version=\"11.11.0\" />\n    <PackageReference Include=\"FluentValidation.AspNetCore\" Version=\"11.3.0\" />\n    <PackageReference Include=\"libphonenumber-csharp\" Version=\"9.0.21\" />\n    <PackageReference Include=\"Microsoft.AspNetCore.Authentication.JwtBearer\" Version=\"8.0.0\" />\n    <PackageReference Include=\"Microsoft.AspNetCore.OpenApi\" Version=\"8.0.15\" />\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"8.0.18\" />\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"8.0.15\">\n      <PrivateAssets>all</PrivateAssets>\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\n    </PackageReference>\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.InMemory\" Version=\"8.0.15\" />\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Tools\" Version=\"8.0.15\">\n      <PrivateAssets>all</PrivateAssets>\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\n    </PackageReference>\n    <PackageReference Include=\"Newtonsoft.Json\" Version=\"13.0.3\" />\n    <PackageReference Include=\"Npgsql.EntityFrameworkCore.PostgreSQL\" Version=\"8.0.11\" />\n    <PackageReference Include=\"Npgsql.EntityFrameworkCore.PostgreSQL.Design\" Version=\"1.1.0\" />\n    <PackageReference Include=\"Polly\" Version=\"8.6.4\" />\n    <PackageReference Include=\"Polly.Contrib.WaitAndRetry\" Version=\"1.1.1\" />\n    <PackageReference Include=\"Polly.Extensions.Http\" Version=\"3.0.0\" />\n    <PackageReference Include=\"Serilog\" Version=\"4.2.0\" />\n    <PackageReference Include=\"Serilog.AspNetCore\" Version=\"8.0.3\" />\n    <PackageReference Include=\"Serilog.Exceptions\" Version=\"8.4.0\" />\n    <PackageReference Include=\"Serilog.Sinks.Async\" Version=\"2.1.0\" />\n    <PackageReference Include=\"Serilog.Sinks.File\" Version=\"6.0.0\" />\n    <PackageReference Include=\"Swashbuckle.AspNetCore\" Version=\"6.6.2\" />\n    <PackageReference Include=\"System.IdentityModel.Tokens.Jwt\" Version=\"8.8.0\" />\n  </ItemGroup>\n\n  <!-- Folder placeholders (optional) -->\n  <ItemGroup>\n    <Folder Include=\"Features\\AuditTrail\\Controllers\\\" />\n    <Folder Include=\"Features\\AuditTrail\\Middleware\\\" />\n    <Folder Include=\"Features\\AuditTrail\\Background\\\" />\n    <Folder Include=\"Features\\Automation\\Enums\\\" />\n    <Folder Include=\"Features\\Automation\\Runtime\\\" />\n    <Folder Include=\"Features\\AutoReplyBuilder\\Helpers\\\" />\n    <Folder Include=\"Features\\AutoReplyTemplates\\Restaurant\\Templates\\\" />\n    <Folder Include=\"Features\\CampaignTracking\\Repositories\\\" />\n    <Folder Include=\"Features\\Catalog\\Repositories\\\" />\n    <Folder Include=\"Features\\CrmAnalytics\\Models\\\" />\n    <Folder Include=\"Features\\CTAFlowBuilder\\Mappers\\\" />\n    <Folder Include=\"Features\\PlanManagement\\DTOs\\\" />\n    <Folder Include=\"Features\\CRM\\Timelines\\Repositories\\\" />\n    <Folder Include=\"logs\\\" />\n    <Folder Include=\"WhatsAppSettings\\BackgroundService\\\" />\n  </ItemGroup>\n\n</Project>\n"
    }
  ]
}
