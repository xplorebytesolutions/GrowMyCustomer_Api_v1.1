{
  "name": "xbytechat-api",
  "part": 2,
  "of": 33,
  "generatedAt": "2026-02-11 19:15:17 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/BusinessModule/Services/BusinessService.cs",
      "sha256": "2a22f3f678e045f3f9c6ce389dc02a6e617b2fc784989532a484ac89669f49f3",
      "language": "csharp",
      "size": 30284,
      "content": "using Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing System.Security.Claims;\nusing System.Security.Cryptography;\nusing System.Text;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Features.AuditTrail.Services;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Repositories.Interfaces;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.Entitlements.Models;\nusing xbytechat.api.Features.Entitlements;\n\nnamespace xbytechat.api.Features.BusinessModule.Services\n{\n    public class BusinessService : IBusinessService\n    {\n        private readonly IGenericRepository<Business> _businessRepo;\n        private readonly IGenericRepository<User> _userRepo;\n        private readonly IGenericRepository<Role> _roleRepo;\n        private readonly IGenericRepository<Plan> _planRepo;\n        private readonly IGenericRepository<PlanQuota> _planQuotaRepo;\n        private readonly IAuditLogService _auditLogService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        // inside BusinessService class (class scope, not inside a method)\n        private static readonly Guid BASIC_PLAN_ID = Guid.Parse(\"5f9f5de1-a0b2-48ba-b03d-77b27345613f\");\n        private readonly IPasswordHasher<User> _passwordHasher;\n\n        private readonly AppDbContext _db;\n        public BusinessService(\n            AppDbContext db,\n            IGenericRepository<Business> businessRepo,\n            IGenericRepository<User> userRepo,\n            IGenericRepository<Role> roleRepo,\n            IGenericRepository<Plan> planRepo,\n            IGenericRepository<PlanQuota> planQuotaRepo,\n            IAuditLogService auditLogService,\n            IHttpContextAccessor httpContextAccessor, IPasswordHasher<User> passwordHasher)\n        {\n            _db = db;\n            _passwordHasher = passwordHasher;\n            _businessRepo = businessRepo;\n            _userRepo = userRepo;\n            _roleRepo = roleRepo;\n            _planRepo = planRepo;\n            _planQuotaRepo = planQuotaRepo;\n            _auditLogService = auditLogService;\n            _httpContextAccessor = httpContextAccessor;\n        }\n\n        //public async Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto)\n        //{\n        //    var normalizedEmail = dto.Email.Trim().ToLower();\n        //    var existing = await _userRepo.FirstOrDefaultAsync(u => u.Email == normalizedEmail);\n        //    if (existing != null)\n        //        return ResponseResult.ErrorInfo(\"‚ùå Email already exists\");\n\n        //    var business = new Business\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        CompanyName = dto.CompanyName,\n        //        BusinessName = dto.CompanyName,\n        //        BusinessEmail = normalizedEmail,\n        //        RepresentativeName = dto.RepresentativeName,\n        //        Phone = dto.Phone,\n        //        CreatedByPartnerId = dto.CreatedByPartnerId,\n        //        Status = Business.StatusType.Pending,\n        //        // Plan = PlanType.Basic,\n        //        IsApproved = false,\n        //        CreatedAt = DateTime.UtcNow,\n        //        PlanId = BASIC_PLAN_ID   // ‚úÖ hard-code Basic plan here\n        //    };\n        //    // STEP 2: Create Plan Info separately\n        //    var planInfo = new BusinessPlanInfo\n        //    {\n        //        BusinessId = business.Id,\n        //        Plan = PlanType.Basic,\n        //        TotalMonthlyQuota = 1000,\n        //        RemainingMessages = 1000,\n        //        QuotaResetDate = DateTime.UtcNow.AddMonths(1),\n        //        WalletBalance = 0\n        //    };\n        //    // STEP 3: Link them\n        //    business.BusinessPlanInfo = planInfo;\n        //    // STEP 4: Save both\n        //    await _businessRepo.AddAsync(business);\n        //    await _businessRepo.SaveAsync();\n\n        //    var role = await _roleRepo.FirstOrDefaultAsync(r => r.Name.ToLower() == dto.RoleName.Trim().ToLower());\n\n        //    if (role == null)\n        //        return ResponseResult.ErrorInfo(\"‚ùå Invalid role specified\");\n\n        //    var user = new User\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        Name = dto.CompanyName,\n        //        Email = normalizedEmail,\n        //        PasswordHash = HashPassword(dto.Password),\n        //        //PasswordHash = _passwordHasher.HashPassword(null!, dto.Password),\n        //        Role = role,\n        //        Status = \"Pending\",\n        //        BusinessId = business.Id\n        //    };\n\n        //    await _userRepo.AddAsync(user);\n        //    await _userRepo.SaveAsync();\n\n        //    await _auditLogService.SaveLogAsync(new AuditLog\n        //    {\n        //        BusinessId = business.Id,\n        //        PerformedByUserId = user.Id,\n        //        PerformedByUserName = user.Name,\n        //        RoleAtTime = \"business\",\n        //        ActionType = \"business.signup\",\n        //        Description = $\"New business signup: {business.CompanyName}\",\n        //        IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n        //        UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n        //    });\n\n        //    return ResponseResult.SuccessInfo(\"‚úÖ Signup successful. Pending approval.\", new { BusinessId = business.Id });\n        //}\n\n        public async Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto)\n        {\n            var normalizedEmail = dto.Email.Trim().ToLower();\n            var existing = await _userRepo.FirstOrDefaultAsync(u => u.Email == normalizedEmail);\n            if (existing != null)\n                return ResponseResult.ErrorInfo(\"‚ùå Email already exists\");\n\n            var basicPlanId = Guid.Parse(\"5f9f5de1-a0b2-48ba-b03d-77b27345613f\");\n            var business = new Business\n            {\n                Id = Guid.NewGuid(),\n                CompanyName = dto.CompanyName,\n                BusinessName = dto.CompanyName,\n                BusinessEmail = normalizedEmail,\n                RepresentativeName = dto.RepresentativeName,\n                Phone = dto.Phone,\n                CreatedByPartnerId = dto.CreatedByPartnerId,\n                Status = Business.StatusType.Pending,\n                IsApproved = false,\n                CreatedAt = DateTime.UtcNow,\n\n                // ‚ùå IMPORTANT: no plan yet at signup\n                PlanId = basicPlanId,              // if Guid?  (or just omit setting it)\n                                            // BusinessPlanInfo = null   // will be created at plan-selection time\n            };\n\n            // Only save the business now, without plan info\n            await _businessRepo.AddAsync(business);\n            await _businessRepo.SaveAsync();\n\n            var role = await _roleRepo.FirstOrDefaultAsync(\n                r => r.Name.ToLower() == dto.RoleName.Trim().ToLower()\n            );\n\n            if (role == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid role specified\");\n\n            var user = new User\n            {\n                Id = Guid.NewGuid(),\n                Name = dto.CompanyName,\n                Email = normalizedEmail,\n                PasswordHash = HashPassword(dto.Password),\n                Role = role,\n                Status = \"Pending\",\n                BusinessId = business.Id\n            };\n\n            await _userRepo.AddAsync(user);\n            await _userRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = user.Id,\n                PerformedByUserName = user.Name,\n                RoleAtTime = \"business\",\n                ActionType = \"business.signup\",\n                Description = $\"New business signup: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\n                \"‚úÖ Signup successful. Pending approval.\",\n                new { BusinessId = business.Id }\n            );\n        }\n\n\n\n        public async Task<ResponseResult> UpdateBusinessAsync(Guid businessId, UpdateBusinessDto dto)\n        {\n            if (dto == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid business update payload.\");\n\n            var business = await _businessRepo.AsQueryable()\n                .FirstOrDefaultAsync(b => b.Id == businessId && !b.IsDeleted);\n\n            if (business == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found.\");\n\n            // ---- Authorization: who is allowed to edit this business? ----\n\n            var httpContext = _httpContextAccessor.HttpContext;\n            var user = httpContext?.User;\n\n            if (user == null || !user.Identity?.IsAuthenticated == true)\n                return ResponseResult.ErrorInfo(\"‚ùå Unauthorized. Please login again.\");\n\n            var role =\n                user.FindFirst(ClaimTypes.Role)?.Value ??\n                user.FindFirst(\"role\")?.Value ??\n                user.FindFirst(\"roles\")?.Value ??\n                string.Empty;\n\n            var userIdStr =\n                user.FindFirst(\"id\")?.Value ??\n                user.FindFirst(ClaimTypes.NameIdentifier)?.Value ??\n                user.FindFirst(\"sub\")?.Value ??\n                string.Empty;\n\n            Guid.TryParse(userIdStr, out var userId);\n\n            var roleLc = (role ?? string.Empty).ToLowerInvariant();\n            var isAdmin = roleLc == \"admin\" || roleLc == \"superadmin\";\n            var isPartner = roleLc == \"partner\";\n            var isAssignedPartner = isPartner && business.CreatedByPartnerId.HasValue &&\n                                    business.CreatedByPartnerId.Value == userId;\n\n            var isBusinessUser = false;\n            if (userId != Guid.Empty)\n            {\n                var userEntity = await _userRepo.AsQueryable()\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync(u => u.Id == userId);\n\n                if (userEntity != null && userEntity.BusinessId == business.Id)\n                    isBusinessUser = true;\n            }\n\n            if (!isAdmin && !isAssignedPartner && !isBusinessUser)\n            {\n                return ResponseResult.ErrorInfo(\"‚õî You are not allowed to update this business.\");\n            }\n\n            // ---- Apply only allowed fields ----\n\n            if (!string.IsNullOrWhiteSpace(dto.CompanyName))\n                business.CompanyName = dto.CompanyName.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.BusinessName))\n                business.BusinessName = dto.BusinessName.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.BusinessEmail))\n                business.BusinessEmail = dto.BusinessEmail.Trim().ToLowerInvariant();\n\n            if (!string.IsNullOrWhiteSpace(dto.Phone))\n                business.Phone = dto.Phone.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.CompanyPhone))\n                business.CompanyPhone = dto.CompanyPhone.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Website))\n                business.Website = dto.Website.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Address))\n                business.Address = dto.Address.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Industry))\n                business.Industry = dto.Industry.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.LogoUrl))\n                business.LogoUrl = dto.LogoUrl.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Tags))\n                business.Tags = dto.Tags.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Notes))\n                business.Notes = dto.Notes.Trim();\n\n            // ‚ùå DO NOT touch:\n            // - business.Status\n            // - business.IsApproved\n            // - business.PlanId\n            // - business.BusinessPlanInfo\n            // - business.CreatedByPartnerId\n            // - deletion flags\n            // These are controlled only by dedicated admin/partner flows.\n\n            try\n            {\n                _businessRepo.Update(business);\n                await _businessRepo.SaveAsync();\n                return ResponseResult.SuccessInfo(\"‚úÖ Business updated successfully.\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to update business: \" + ex.Message);\n            }\n        }\n\n\n        public async Task<List<PendingBusinessDto>> GetPendingBusinessesAsync(string role, string userId, string? status = null)\n        {\n            try\n            {\n                var roleLc = (role ?? \"\").ToLowerInvariant();\n\n                // base: not deleted\n                IQueryable<Business> q = _businessRepo.AsQueryable()\n                    .AsNoTracking()\n                    .Include(b => b.BusinessPlanInfo)\n                    .Where(b => !b.IsDeleted);\n\n                // Filtering by status\n                if (!string.IsNullOrEmpty(status))\n                {\n                    var statusLc = status.ToLowerInvariant();\n                    if (statusLc == \"pending\")\n                        q = q.Where(b => b.Status == Business.StatusType.Pending);\n                    else if (statusLc == \"rejected\" || statusLc == \"reject\")\n                        q = q.Where(b => b.Status == Business.StatusType.Rejected);\n                    else if (statusLc == \"hold\" || statusLc == \"on-hold\" || statusLc == \"on_hold\")\n                        q = q.Where(b => b.Status == Business.StatusType.Hold);\n                    else if (statusLc == \"approved\")\n                        q = q.Where(b => b.Status == Business.StatusType.Approved);\n                }\n                else\n                {\n                    // Default to Pending if no status filter provided\n                    q = q.Where(b => b.Status == Business.StatusType.Pending);\n                }\n\n                // scope for partner\n                if (roleLc == \"partner\")\n                {\n                    if (!Guid.TryParse(userId, out var partnerId)) return new();\n                    q = q.Where(b => b.CreatedByPartnerId == partnerId);\n                }\n                else if (roleLc != \"admin\" && roleLc != \"superadmin\")\n                {\n                    return new(); // anyone else: nothing\n                }\n\n                var items = await q.OrderByDescending(b => b.CreatedAt).ToListAsync();\n\n                // Map to your existing DTO\n                return items.Select(b => new PendingBusinessDto\n                {\n                    BusinessId = b.Id,\n                    CompanyName = b.CompanyName ?? \"\",\n                    BusinessEmail = b.BusinessEmail ?? \"\",\n                    RepresentativeName = b.RepresentativeName ?? \"\",\n                    Phone = b.Phone ?? \"\",\n                    Plan = b.BusinessPlanInfo?.Plan.ToString() ?? \"Unknown\",\n                    CreatedAt = b.CreatedAt,\n                    IsApproved = b.IsApproved,\n                    Status = b.Status.ToString(),\n                    ApprovedAt = b.ApprovedAt\n                }).ToList();\n            }\n            catch\n            {\n                return new();\n            }\n        }\n\n        public async Task<ResponseResult> ApproveBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo\n                .AsQueryable()\n                .Include(b => b.Users)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (business == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found.\");\n\n            // ‚úÖ Current Logged-in User Details\n            var httpContext = _httpContextAccessor.HttpContext;\n            var currentUserId = httpContext?.User?.FindFirst(\"id\")?.Value;\n            var currentUserRole = httpContext?.User?.Claims\n    .FirstOrDefault(c => c.Type.Contains(\"role\"))?.Value;\n            //httpContext?.User?.FindFirst(\"role\")?.Value;\n\n            // var currentUserName = httpContext?.User?.FindFirst(\"name\")?.Value ?? \"Unknown\";\n            var currentUserName = httpContext?.User?.Claims\n    .FirstOrDefault(c => c.Type.Contains(\"name\"))?.Value ?? \"Unknown\";\n            if (string.IsNullOrEmpty(currentUserId) || string.IsNullOrEmpty(currentUserRole))\n                return ResponseResult.ErrorInfo(\"‚ùå Unauthorized access. Please login again.\");\n\n            var currentGuid = Guid.Parse(currentUserId);\n\n            // ‚úÖ Authorization Logic\n            var isSuperAdmin = currentUserRole.Equals(\"admin\", StringComparison.OrdinalIgnoreCase) ||\n                               currentUserRole.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase);\n\n            var isAssignedPartner = business.CreatedByPartnerId.HasValue &&\n                                     business.CreatedByPartnerId.Value == currentGuid;\n\n            if (!isSuperAdmin && !isAssignedPartner)\n            {\n                return ResponseResult.ErrorInfo(\"‚õî You are not authorized to approve this business.\");\n            }\n\n            // ‚úÖ Approve Business\n\n            business.IsApproved = true;\n            business.Status = Business.StatusType.Approved;\n            business.ApprovedAt = DateTime.UtcNow;\n            business.ApprovedBy = currentUserName;\n            _businessRepo.Update(business);\n\n            // ‚úÖ Update all Users to \"ProfilePending\"\n            foreach (var user in business.Users)\n            {\n                user.Status = \"Active\";\n                _userRepo.Update(user);\n            }\n\n            await _businessRepo.SaveAsync();\n            await _userRepo.SaveAsync();\n\n            // ‚úÖ Audit Log\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = currentGuid,\n                PerformedByUserName = currentUserName,\n                RoleAtTime = currentUserRole,\n                ActionType = \"business.approved\",\n                Description = $\"Business approved: {business.CompanyName}\",\n                IPAddress = httpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = httpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Business approved successfully.\");\n        }\n\n        public async Task<ResponseResult> RejectBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            business.Status = Business.StatusType.Rejected;\n            business.IsApproved = false;\n            // business.IsDeleted = true; // removed soft-delete to allow showing in Rejected tab\n            business.DeletedAt = null;\n\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var userId) ? userId : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value,\n                RoleAtTime = _httpContextAccessor.HttpContext?.User?.FindFirst(\"role\")?.Value,\n                ActionType = \"business.rejected\",\n                Description = $\"Business rejected: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Business rejected and marked as deleted\");\n        }\n\n        public async Task<ResponseResult> HoldBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            business.IsApproved = false;\n            business.Status = Business.StatusType.Hold;\n\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var userId) ? userId : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value,\n                RoleAtTime = _httpContextAccessor.HttpContext?.User?.FindFirst(\"role\")?.Value,\n                ActionType = \"business.hold\",\n                Description = $\"Business put on hold: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"‚è∏ Business put on hold\");\n        }\n\n        public async Task<ResponseResult> CompleteProfileAsync(Guid businessId, ProfileCompletionDto dto)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            if (!string.IsNullOrEmpty(dto.BusinessName)) business.BusinessName = dto.BusinessName;\n            if (!string.IsNullOrEmpty(dto.CompanyPhone)) business.CompanyPhone = dto.CompanyPhone;\n            if (!string.IsNullOrEmpty(dto.Website)) business.Website = dto.Website;\n            if (!string.IsNullOrEmpty(dto.Address)) business.Address = dto.Address;\n            if (!string.IsNullOrEmpty(dto.Industry)) business.Industry = dto.Industry;\n            if (!string.IsNullOrEmpty(dto.LogoUrl)) business.LogoUrl = dto.LogoUrl;\n            if (!string.IsNullOrEmpty(dto.ReperesentativeName)) business.RepresentativeName = dto.ReperesentativeName;\n            if (!string.IsNullOrEmpty(dto.Phone)) business.Phone = dto.Phone;\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n            return ResponseResult.SuccessInfo(\"‚úÖ Profile updated successfully\");\n        }\n\n        public async Task<Business?> GetBusinessByEmailAsync(string email)\n        {\n            return await _businessRepo.FirstOrDefaultAsync(b => b.BusinessEmail.ToLower() == email.Trim().ToLower());\n        }\n\n        private string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password);\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n\n        public async Task<Business?> GetByIdAsync(Guid businessId)\n        {\n            return await _businessRepo.FindByIdAsync(businessId);\n        }\n\n        public async Task<List<ApprovedBusinessDto>> GetApprovedBusinessesAsync()\n        {\n            return await _businessRepo.AsQueryable()\n               .Include(b => b.Plan)\n               .Where(b => b.IsApproved && !b.IsDeleted)\n               .OrderBy(b => b.CompanyName)\n               .Select(b => new ApprovedBusinessDto\n               {\n                   Id = b.Id,\n                   CompanyName = b.CompanyName,\n                   BusinessEmail = b.BusinessEmail,\n                   PlanId = b.PlanId,\n                   PlanName = b.Plan != null ? b.Plan.Name : null,\n                   LogoUrl = b.LogoUrl\n               })\n               .ToListAsync();\n        }\n        public async Task<ResponseResult> HardDeleteBusinessAsync(Guid businessId)\n        {\n            try\n            {\n                var business = await _businessRepo.AsQueryable()\n                    .Include(b => b.Users)\n                    .Include(b => b.BusinessPlanInfo)\n                    .FirstOrDefaultAsync(b => b.Id == businessId);\n\n                if (business == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n                // Audit log before deletion\n                await _auditLogService.SaveLogAsync(new AuditLog\n                {\n                    BusinessId = business.Id,\n                    ActionType = \"business.hard_deleted\",\n                    Description = $\"Business permanently deleted: {business.CompanyName}\",\n                    IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                    UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n                });\n\n                // Remove related users first\n                if (business.Users != null && business.Users.Any())\n                {\n                    foreach (var user in business.Users.ToList())\n                    {\n                        _userRepo.Delete(user);\n                    }\n                    await _userRepo.SaveAsync();\n                }\n\n                if (business.BusinessPlanInfo != null)\n                {\n                    _db.BusinessPlanInfos.Remove(business.BusinessPlanInfo);\n                }\n\n                _businessRepo.Delete(business);\n                await _businessRepo.SaveAsync();\n\n                return ResponseResult.SuccessInfo(\"üóëÔ∏è Business permanently deleted\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to delete business: \" + ex.Message);\n            }\n        }\n\n        public async Task<ResponseResult> AssignPlanAsync(Guid businessId, Guid planId)\n        {\n            var business = await _businessRepo.AsQueryable()\n                .Include(b => b.BusinessPlanInfo)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            // 1. Fetch Real Plan\n            var plan = await _planRepo.FindByIdAsync(planId);\n            if (plan == null)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Plan not found.\");\n            }\n\n            // 2. Fetch Quotas for this Plan\n            // Assuming we look for \"MESSAGES_PER_MONTH\"\n            var quotas = await _planQuotaRepo.AsQueryable()\n                .Where(q => q.PlanId == planId)\n                .ToListAsync();\n\n            var messageQuota = quotas\n                .FirstOrDefault(q => q.QuotaKey == QuotaKeys.MessagesPerMonth);\n\n            int monthlyLimit = messageQuota != null ? (int)messageQuota.Limit : 1000; // Default fallback if not defined\n\n            // 3. Map Plan Code to Enum (Best Effort)\n            // If Plan.Code is \"SMART\", map to PlanType.Smart\n            // This is brittle if Enum and DB drift, but necessary if BusinessPlanInfo relies on Enum.\n            PlanType planTypeEnum = PlanType.Basic;\n            if (Enum.TryParse<PlanType>(plan.Code, true, out var parsed))\n            {\n                planTypeEnum = parsed;\n            }\n            else\n            {\n                // Fallback logic by name? Or default to Basic/Smart if unknown\n                planTypeEnum = PlanType.Smart; \n            }\n\n            // Update linking\n            business.PlanId = planId;\n\n            // Handle BusinessPlanInfo\n            if (business.BusinessPlanInfo == null)\n            {\n                var newPlanInfo = new BusinessPlanInfo\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = business.Id,\n                    Plan = planTypeEnum, \n                    TotalMonthlyQuota = monthlyLimit, \n                    RemainingMessages = monthlyLimit,\n                    QuotaResetDate = DateTime.UtcNow.AddMonths(1),\n                    WalletBalance = 0\n                };\n                \n                // Explicitly add the new child entity\n                _db.Entry(newPlanInfo).State = EntityState.Added;\n                business.BusinessPlanInfo = newPlanInfo;\n            }\n            else\n            {\n                // Update existing info\n                business.BusinessPlanInfo.Plan = planTypeEnum;\n                business.BusinessPlanInfo.TotalMonthlyQuota = monthlyLimit;\n                // Ideally we shouldn't reset RemainingMessages if just upgrading mid-month unless that's policy.\n                // For now, let's reset it to the new limit to be generous, or keep it if it's lower? \n                // Let's reset it for now to ensure they get the new quota immediately.\n                business.BusinessPlanInfo.RemainingMessages = monthlyLimit; \n                \n                _db.Entry(business.BusinessPlanInfo).State = EntityState.Modified;\n            }\n            \n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                ActionType = \"business.plan_assigned\",\n                Description = $\"Assigned Plan '{plan.Name}' ({planId}) to business {business.CompanyName}. Limit: {monthlyLimit}\",\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var uid) ? uid : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value\n            });\n\n            return ResponseResult.SuccessInfo($\"‚úÖ Plan '{plan.Name}' assigned successfully.\");\n        }\n\n        public IQueryable<Business> Query()\n        {\n            return _businessRepo.AsQueryable();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Services/IBusinessService.cs",
      "sha256": "9b27fd199b73b84cad94813d99eb5cb62852f36276859c227dfd483c3d598974",
      "language": "csharp",
      "size": 1482,
      "content": "using System.Runtime.CompilerServices;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models;\nnamespace xbytechat.api.Features.BusinessModule.Services\n{\n\n    public interface IBusinessService\n    {\n        IQueryable<Business> Query();\n        Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto); /// Signup + create admin user\n\n        Task<ResponseResult> ApproveBusinessAsync(Guid businessId);      // Admin action\n        Task<ResponseResult> RejectBusinessAsync(Guid businessId);       // Admin action\n        Task<ResponseResult> HoldBusinessAsync(Guid businessId);         // Admin action\n        Task<ResponseResult> CompleteProfileAsync(Guid businessId, ProfileCompletionDto dto); // Post-login completion\n        Task<Business?> GetBusinessByEmailAsync(string email);\n        Task<Business?> GetByIdAsync(Guid businessId);\n \n        Task<ResponseResult> UpdateBusinessAsync(Guid businessId, UpdateBusinessDto dto);\n\n        Task<List<PendingBusinessDto>> GetPendingBusinessesAsync(string role, string userId, string? status = null);\n        Task<List<ApprovedBusinessDto>> GetApprovedBusinessesAsync();\n        Task<ResponseResult> HardDeleteBusinessAsync(Guid businessId);\n\n        /// <summary>\n        /// Assigns a specific plan to a business.\n        /// </summary>\n        Task<ResponseResult> AssignPlanAsync(Guid businessId, Guid planId);\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignAudienceController.cs",
      "sha256": "74c141a187b14cbca6760d96e6474d3dea69708cd2a608bbb54adcbd1019021b",
      "language": "csharp",
      "size": 4615,
      "content": "using System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/audience\")]\n    [Authorize]\n    public sealed class CampaignAudienceController : ControllerBase\n    {\n        private readonly ICampaignAudienceAttachmentService _svc;\n\n        public CampaignAudienceController(ICampaignAudienceAttachmentService svc)\n        {\n            _svc = svc;\n        }\n\n        [HttpGet]\n        public async Task<ActionResult<CampaignAudienceDto>> GetActive([FromRoute] Guid campaignId, CancellationToken ct)\n        {\n            try\n            {\n                var businessId = User.GetBusinessId();\n                var dto = await _svc.GetActiveAsync(businessId, campaignId, ct);\n                return Ok(dto);\n            }\n            catch (KeyNotFoundException)\n            {\n                return NotFound(new { message = \"Campaign not found.\" });\n            }\n        }\n\n        [HttpGet(\"history\")]\n        public async Task<IActionResult> History([FromRoute] Guid campaignId, CancellationToken ct)\n        {\n            try\n            {\n                var businessId = User.GetBusinessId();\n                var list = await _svc.GetHistoryAsync(businessId, campaignId, ct);\n                return Ok(list);\n            }\n            catch (KeyNotFoundException)\n            {\n                return NotFound(new { message = \"Campaign not found.\" });\n            }\n        }\n\n        public sealed class ReplaceForm\n        {\n            public IFormFile File { get; set; } = default!;\n            public string? AudienceName { get; set; }\n        }\n\n        [HttpPost(\"replace\")]\n        [RequestSizeLimit(1024L * 1024L * 200L)] // 200 MB\n        public async Task<IActionResult> Replace([FromRoute] Guid campaignId, [FromForm] ReplaceForm form, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var actor = ResolveActor();\n\n            try\n            {\n                var res = await _svc.ReplaceAsync(businessId, campaignId, form.File, form.AudienceName, actor, ct);\n                return Ok(res);\n            }\n            catch (CampaignAudienceAttachmentService.AudienceLockedException ex)\n            {\n                return Conflict(new { message = ex.Message });\n            }\n            catch (KeyNotFoundException)\n            {\n                return NotFound(new { message = \"Campaign not found.\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Replace CSV audience failed | campaign={CampaignId}\", campaignId);\n                return Problem(title: \"Replace CSV audience failed\", detail: ex.Message, statusCode: 400);\n            }\n        }\n\n        [HttpPost(\"remove\")]\n        public async Task<IActionResult> Remove([FromRoute] Guid campaignId, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var actor = ResolveActor();\n\n            try\n            {\n                var res = await _svc.RemoveAsync(businessId, campaignId, actor, ct);\n                return Ok(res);\n            }\n            catch (CampaignAudienceAttachmentService.AudienceLockedException ex)\n            {\n                return Conflict(new { message = ex.Message });\n            }\n            catch (KeyNotFoundException)\n            {\n                return NotFound(new { message = \"Campaign not found.\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Remove CSV audience failed | campaign={CampaignId}\", campaignId);\n                return Problem(title: \"Remove CSV audience failed\", detail: ex.Message, statusCode: 400);\n            }\n        }\n\n        private string ResolveActor()\n        {\n            // Used for CampaignAudienceAttachments.DeactivatedBy audit trail.\n            var email = User.Claims.FirstOrDefault(c => c.Type.EndsWith(\"email\", StringComparison.OrdinalIgnoreCase))?.Value;\n            if (!string.IsNullOrWhiteSpace(email)) return email!;\n\n            return User.Identity?.Name\n                   ?? (User.Claims.FirstOrDefault(c => c.Type.EndsWith(\"nameidentifier\", StringComparison.OrdinalIgnoreCase))?.Value)\n                   ?? \"system\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignController.cs",
      "sha256": "be7fb46fbcdb9c9f9ebcd7f1b71e2988b4933d14afb5444bd77674fda22fd5c9",
      "language": "csharp",
      "size": 17157,
      "content": "using DocumentFormat.OpenXml.InkML;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing Serilog.Context;\nusing System;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.BusinessModule.Services;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\nusing static xbytechat.api.Features.MessagesEngine.Controllers.MessageEngineController;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class CampaignController : ControllerBase\n    {\n        private readonly ICampaignService _campaignService;\n        private readonly IBusinessService _businessService;\n        private readonly IMessageEngineService _messageService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n\n        public CampaignController(\n            ICampaignService campaignService,\n            IBusinessService businessService,\n            IMessageEngineService messageEngineService,\n            IHttpContextAccessor httpContextAccessor)\n        {\n            _campaignService = campaignService;\n            _businessService = businessService;\n            _messageService = messageEngineService;\n            _httpContextAccessor = httpContextAccessor;\n        }\n\n\n        [HttpGet(\"get-image-campaign\")]\n        public async Task<IActionResult> GetAll([FromQuery] string? type)\n        {\n            var businessId = GetBusinessId();\n            var items = await _campaignService.GetAllCampaignsAsync(businessId, type);\n            return Ok(items);\n        }\n    \n\n        [HttpPost(\"create-text-campaign\")]\n        public async Task<IActionResult> CreateTextCampaign([FromBody] CampaignCreateDto dto)\n        {\n            try\n            {\n                var businessIdClaim = User.FindFirst(\"businessId\")?.Value;\n                if (!Guid.TryParse(businessIdClaim, out var businessId))\n                    return Unauthorized(new { message = \"üö´ Invalid or missing BusinessId claim.\" });\n\n                var createdBy = User.Identity?.Name ?? \"system\";\n\n                if (string.IsNullOrWhiteSpace(dto.Name))\n                    return BadRequest(new { message = \"üö´ Campaign name is required.\" });\n\n                if (string.IsNullOrWhiteSpace(dto.TemplateId))\n                    return BadRequest(new { message = \"üö´ TemplateId is required for template campaigns.\" });\n\n            \n\n                var campaignId = await _campaignService.CreateTextCampaignAsync(dto, businessId, createdBy);\n\n                return campaignId != null\n                    ? Ok(new\n                    {\n                        success = true,\n                        message = \"‚úÖ Campaign created successfully\",\n                        campaignId = campaignId.Value\n                    })\n                    : BadRequest(new { success = false, message = \"‚ùå Failed to create campaign\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Exception in CreateTextCampaign\");\n                return StatusCode(500, new { message = \"üö® Internal server error\", error = ex.Message });\n            }\n        }\n\n        [HttpPost(\"create-image-campaign\")]\n        public async Task<IActionResult> CreateImageCampaign([FromBody] CampaignCreateDto dto)\n        {\n            try\n            {\n                var user = HttpContext.User;\n                var businessIdClaim = user.FindFirst(\"businessId\");\n\n                if (businessIdClaim == null || !Guid.TryParse(businessIdClaim.Value, out var businessId))\n                    return Unauthorized(new { message = \"üö´ Invalid or missing BusinessId claim.\" });\n\n                if (dto.MultiButtons != null && dto.MultiButtons.Any())\n                {\n                    var allowedTypes = new[] { \"url\", \"copy_code\", \"flow\", \"phone_number\", \"quick_reply\" };\n                    foreach (var button in dto.MultiButtons)\n                    {\n                        var type = button.ButtonType?.Trim().ToLower();\n\n                        if (!allowedTypes.Contains(type))\n                            return BadRequest(new { message = $\"‚ùå Invalid ButtonType: '{type}' is not supported.\" });\n\n                        var needsValue = new[] { \"url\", \"flow\", \"copy_code\", \"phone_number\" };\n                        if (needsValue.Contains(type) && string.IsNullOrWhiteSpace(button.TargetUrl))\n                            return BadRequest(new { message = $\"‚ùå Button '{button.ButtonText}' requires a valid TargetUrl or Value for type '{type}'.\" });\n\n                        if (button.TargetUrl?.ToLower() == \"unknown\")\n                            return BadRequest(new { message = $\"‚ùå Invalid value 'unknown' found in button '{button.ButtonText}'.\" });\n                    }\n                }\n\n                var createdBy = user.Identity?.Name ?? \"system\";\n                var campaignId = await _campaignService.CreateImageCampaignAsync(businessId, dto, createdBy);\n\n                return Ok(new\n                {\n                    success = true,\n                    message = \"‚úÖ Campaign created successfully\",\n                    campaignId\n                });\n            }\n            catch (UnauthorizedAccessException ex)\n            {\n                return BadRequest(new { message = ex.Message });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Exception in CreateImageCampaign\");\n                return StatusCode(500, new { message = \"üö® Internal server error\", error = ex.Message });\n            }\n        }\n\n        // ‚úÖ Moved above {id} routes\n        [HttpPost(\"{id}/assign-contacts\")]\n        public async Task<IActionResult> AssignContactsToCampaign(Guid id, [FromBody] AssignContactsDto request)\n        {\n            try\n            {\n                var businessId = GetBusinessId();\n                var success = await _campaignService.AssignContactsToCampaignAsync(id, businessId, request.ContactIds);\n\n                return success\n                    ? Ok(new { message = \"‚úÖ Contacts assigned\" })\n                    : BadRequest(new { message = \"‚ùå Failed to assign contacts\" });\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Error assigning contacts: \" + ex.Message);\n                return StatusCode(500, new { message = \"Internal error\", error = ex.Message });\n            }\n        }\n\n        [HttpDelete(\"{campaignId}/recipients/{contactId}\")]\n        public async Task<IActionResult> RemoveCampaignRecipient(Guid campaignId, Guid contactId)\n        {\n            try\n            {\n                var businessId = GetBusinessId();\n                var success = await _campaignService.RemoveRecipientAsync(businessId, campaignId, contactId);\n\n                if (!success)\n                    return NotFound(new { message = \"Recipient not found or not assigned\" });\n\n                return NoContent();\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Remove recipient failed: \" + ex.Message);\n                return StatusCode(500, new { message = \"Error removing recipient\", detail = ex.Message });\n            }\n        }\n\n        // Put this inside CampaignService (same class as SendTemplateCampaignWithTypeDetectionAsync)\n        private static string? ResolveRecipientPhone(CampaignRecipient r)\n        {\n            // Try Contact first, then AudienceMember fallbacks\n            return r?.Contact?.PhoneNumber\n                ?? r?.AudienceMember?.PhoneE164\n                ?? r?.AudienceMember?.PhoneRaw;\n        }\n\n    \n        // Send All Type of campaign method \n\n        [Authorize]\n        [HttpPost(\"send-campaign/{campaignId}\")]\n        //[ProducesResponseType(typeof(ResponseResult), StatusCodes.Status202Accepted)]\n        //[ProducesResponseType(typeof(ResponseResult), StatusCodes.Status400BadRequest)]\n        //[ProducesResponseType(typeof(ResponseResult), StatusCodes.Status401Unauthorized)]\n        //[ProducesResponseType(typeof(ResponseResult), StatusCodes.Status500InternalServerError)]\n        public async Task<IActionResult> SendTemplateCampaign(Guid campaignId, CancellationToken ct)\n        {\n            using var _ = LogContext.PushProperty(\"CampaignId\", campaignId);\n\n            try\n            {\n                     var result = await _campaignService.SendTemplateCampaignWithTypeDetectionAsync(campaignId, ct);\n\n                if (result.Success) return Accepted(result);\n\n                // For now: any non-success from the service is treated as a client error\n                return BadRequest(result);\n            }\n            catch (OperationCanceledException)\n            {\n                Log.Warning(\"‚õî SendTemplateCampaign cancelled\");\n                return StatusCode(StatusCodes.Status499ClientClosedRequest,\n                    ResponseResult.ErrorInfo(\"Request cancelled\"));\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Exception while sending campaign\");\n                return StatusCode(StatusCodes.Status500InternalServerError,\n                    ResponseResult.ErrorInfo(\"üö® Server error while sending campaign\", ex.ToString()));\n            }\n        }\n\n\n\n        [HttpPost(\"send-template-campaign/{id}\")]\n        public async Task<IActionResult> SendImageCampaign(Guid id)\n        {\n            var result = await _campaignService.SendTemplateCampaignAsync(id);\n            return result.Success ? Ok(result) : BadRequest(result);\n        }\n\n        [HttpPost(\"send/{campaignId}\")]\n        public async Task<IActionResult> SendCampaign(Guid campaignId)\n        {\n            try\n            {\n                var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"unknown\";\n                var userAgent = Request.Headers[\"User-Agent\"].ToString() ?? \"unknown\";\n\n                var success = await _campaignService.SendCampaignAsync(campaignId, ipAddress, userAgent);\n\n                return success\n                    ? Ok(new { success = true, message = \"‚úÖ Campaign sent successfully\" })\n                    : BadRequest(new { success = false, message = \"‚ùå Campaign sending failed\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Exception in SendCampaign\");\n                return StatusCode(500, new { success = false, message = \"üö® Internal Server Error\", error = ex.Message });\n            }\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateCampaign(Guid id, [FromBody] CampaignCreateDto dto)\n        {\n            var result = await _campaignService.UpdateCampaignAsync(id, dto);\n            return result\n                ? Ok(new { message = \"‚úèÔ∏è Campaign updated successfully\" })\n                : BadRequest(new { message = \"‚ùå Update failed ‚Äî only draft campaigns can be edited\" });\n        }\n\n\n\n        [HttpDelete(\"{id:guid}\")]\n        public async Task<IActionResult> DeleteCampaign([FromRoute] Guid id, [FromQuery] bool force = false)\n        {\n            var businessId = GetBusinessId();\n            var opt = new CampaignDeletionOptions { Force = force };\n            var res = await _campaignService.DeleteCampaignAsync(businessId, id, opt);\n\n            return res.Status switch\n            {\n                CampaignDeletionStatus.Deleted => Ok(new\n                {\n                    message = force\n                        ? \"üóëÔ∏è Campaign deleted permanently\"\n                        : \"üóëÔ∏è Campaign deleted successfully\",\n                    telemetry = new\n                    {\n                        recipients = res.Recipients,\n                        queuedJobs = res.QueuedJobs,\n                        sendLogs = res.SendLogs\n                    }\n                }),\n                CampaignDeletionStatus.BlockedSending => Conflict(new\n                {\n                    message = \"‚ùå Cannot delete while campaign is sending. Cancel or wait to finish.\"\n                }),\n                CampaignDeletionStatus.BlockedState => BadRequest(new\n                {\n                    message = \"‚ùå Delete failed ‚Äî only draft campaigns can be deleted without force.\"\n                }),\n                CampaignDeletionStatus.NotFound => NotFound(new\n                {\n                    message = \"‚ùå Campaign not found.\"\n                }),\n                _ => StatusCode(500, new\n                {\n                    message = \"üö® Internal error while deleting campaign.\"\n                })\n            };\n        }\n\n        [HttpGet(\"recipients/{id}\")]\n        public async Task<IActionResult> GetCampaignRecipients(Guid id)\n        {\n            try\n            {\n                var businessId = GetBusinessId();\n                var recipients = await _campaignService.GetRecipientsByCampaignIdAsync(id, businessId);\n                return Ok(recipients);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Error fetching campaign recipients: \" + ex.Message);\n                return StatusCode(500, new { message = \"Error fetching recipients\", detail = ex.Message });\n            }\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<ActionResult<CampaignDto>> GetCampaignById(Guid id)\n        {\n            var businessId = GetBusinessId();\n            var campaign = await _campaignService.GetCampaignByIdAsync(id, businessId);\n\n            if (campaign == null)\n                return NotFound();\n\n            return Ok(campaign);\n        }\n\n        private Guid GetBusinessId()\n        {\n            var claim = HttpContext.User.FindFirst(\"businessId\")?.Value;\n            if (string.IsNullOrEmpty(claim))\n                throw new UnauthorizedAccessException(\"BusinessId not found in token claims.\");\n\n            return Guid.Parse(claim);\n        }\n\n        [HttpGet(\"list/{businessId:guid}\")]\n        public async Task<IActionResult> GetAvailableFlows(Guid businessId, [FromQuery] bool onlyPublished = true)\n        {\n            var items = await _campaignService.GetAvailableFlowsAsync(businessId, onlyPublished);\n            return Ok(new { success = true, items });\n        }\n\n        [HttpGet(\"check-name\")]\n        public async Task<IActionResult> CheckName([FromQuery] string name)\n        {\n            var businessId = GetBusinessId();\n            var available = await _campaignService.CheckNameAvailableAsync(businessId, name);\n            return Ok(new { available });\n        }\n\n        [HttpPut(\"{id:guid}/reschedule\")]\n        public async Task<IActionResult> Reschedule([FromRoute] Guid id, [FromBody] RescheduleDto body)\n        {\n            var businessId = GetBusinessId();\n            await _campaignService.RescheduleAsync(businessId, id, body.NewUtcTime);\n            return Ok(new { ok = true });\n        }\n\n        [HttpPost(\"{id:guid}/enqueue-now\")]\n        public async Task<IActionResult> EnqueueNow([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            await _campaignService.EnqueueNowAsync(businessId, id);\n            return Ok(new { ok = true });\n        }\n\n        [HttpPost(\"{id:guid}/cancel-schedule\")]\n        public async Task<IActionResult> CancelSchedule([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            await _campaignService.CancelScheduleAsync(businessId, id);\n            return Ok(new { ok = true });\n        }\n        [HttpGet(\"{id:guid}/usage\")]\n        public async Task<IActionResult> GetCampaignUsage([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            var usage = await _campaignService.GetCampaignUsageAsync(businessId, id);\n            if (usage == null) return NotFound(new { message = \"‚ùå Campaign not found.\" });\n            return Ok(usage);\n        }\n        [HttpGet(\"paginated\")]\n        public async Task<IActionResult> GetPaginatedCampaigns([FromQuery] PaginatedRequest request)\n        {\n            var user = HttpContext.User;\n            var businessIdClaim = user.FindFirst(\"businessId\");\n\n            if (businessIdClaim == null || !Guid.TryParse(businessIdClaim.Value, out var businessId))\n                return Unauthorized(new { message = \"üö´ Invalid or missing BusinessId claim.\" });\n\n            var result = await _campaignService.GetPaginatedCampaignsAsync(businessId, request);\n            return Ok(result);\n        }\n\n        [HttpGet(\"debug-claims\")]\n        public IActionResult DebugClaims()\n        {\n            var user = HttpContext.User;\n            var businessId = user.FindFirst(\"businessId\")?.Value;\n\n            return Ok(new\n            {\n                name = user.Identity?.Name,\n                businessId\n            });\n        }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignCsvSampleController.cs",
      "sha256": "e5c0f786b0bf827b8bfc29a5f32817bfdec13e5a041feefdb295b122796c4786",
      "language": "csharp",
      "size": 5533,
      "content": "// üìÑ File: Features/CampaignModule/Controllers/CampaignCsvSampleController.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.Import;   // <-- use the builder\nusing xbytechat.api.Shared;\nusing xbytechat_api.WhatsAppSettings.Services;       // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/csv-sample\")]\n    [Authorize]\n    public sealed class CampaignCsvSampleController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly CampaignCsvSchemaBuilder _schemaBuilder;\n\n        public CampaignCsvSampleController(AppDbContext db, CampaignCsvSchemaBuilder schemaBuilder)\n        {\n            _db = db;\n            _schemaBuilder = schemaBuilder;\n        }\n\n        // === Canonical schema (delegates to builder) ===\n        // GET /api/campaigns/{campaignId}/csv-sample/schema\n        [HttpGet(\"schema\")]\n        public async Task<IActionResult> GetSchema([FromRoute] Guid campaignId, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            // Use canonical builder (parameterN, header.text_paramN, button{1..3}.url_param)\n            IReadOnlyList<string> headers;\n            try\n            {\n                headers = await _schemaBuilder.BuildAsync(businessId, campaignId, ct);\n            }\n            catch (KeyNotFoundException)\n            {\n                return NotFound();\n            }\n\n            // For backward compatibility with your FE contract:\n            // placeholderCount = number of BODY positional placeholders (parameterN)\n            var placeholderCount = headers.Count(h => h.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase));\n\n            // Infer header meta for convenience\n            var headerSlots = headers.Count(h => h.StartsWith(\"header.text_param\", StringComparison.OrdinalIgnoreCase));\n            var headerType = headerSlots > 0 ? \"text\" : \"none\";\n            var needsUrl = false; // only true for image/video/doc templates; leave false here (data-only endpoint)\n\n            return Ok(new\n            {\n                headers,\n                placeholderCount,\n                header = new { type = headerType, needsUrl }\n            });\n        }\n\n        // GET /api/campaigns/{campaignId}/csv-sample\n        // Generates a dynamic sample based on the actual campaign schema\n        [HttpGet]\n        public async Task<IActionResult> GetDynamicSample([FromRoute] Guid campaignId, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            IReadOnlyList<string> headers;\n            try\n            {\n                headers = await _schemaBuilder.BuildAsync(businessId, campaignId, ct);\n            }\n            catch (KeyNotFoundException)\n            {\n                return NotFound();\n            }\n\n            var sb = new StringBuilder();\n            sb.AppendLine(string.Join(\",\", headers));\n\n            // Create a dummy row\n            var row = new List<string>();\n            foreach (var h in headers)\n            {\n                var lower = h.ToLowerInvariant();\n                if (lower.Contains(\"phone\")) row.Add(\"1234567890\");\n                else if (lower.Contains(\"parameter\")) row.Add(\"value\");\n                else if (lower.Contains(\"url\")) row.Add(\"https://example.com\");\n                else row.Add(\"abc\");\n            }\n            sb.AppendLine(string.Join(\",\", row));\n\n            var bytes = Encoding.UTF8.GetBytes(sb.ToString());\n            return File(bytes, \"text/csv\", $\"sample_{campaignId}.csv\");\n        }\n\n        // GET /api/campaigns/{campaignId}/csv-sample/sample (Legacy/Generic)\n        [HttpGet(\"sample\")]\n        public IActionResult DownloadSample([FromQuery] int bodyParams = 2, [FromQuery] int headerTextParams = 1, [FromQuery] int urlButtons = 1)\n        {\n            bodyParams = Math.Max(0, Math.Min(10, bodyParams));        // safety caps\n            headerTextParams = Math.Max(0, Math.Min(5, headerTextParams));\n            urlButtons = Math.Max(0, Math.Min(3, urlButtons));\n\n            var headers = new List<string> { \"phone\" };\n\n            for (int i = 1; i <= bodyParams; i++) headers.Add($\"parameter{i}\");\n            for (int i = 1; i <= headerTextParams; i++) headers.Add($\"header.text_param{i}\");\n            for (int i = 1; i <= urlButtons; i++) headers.Add($\"button{i}.url_param\");\n\n            var example = new List<string> { \"+911234567890\" };\n            for (int i = 1; i <= bodyParams; i++) example.Add($\"body_value_{i}\");\n            for (int i = 1; i <= headerTextParams; i++) example.Add($\"header_text_{i}\");\n            for (int i = 1; i <= urlButtons; i++) example.Add($\"https://example.com/order/{{id}}\");\n\n            var sb = new StringBuilder();\n            sb.AppendLine(string.Join(\",\", headers));\n            sb.AppendLine(string.Join(\",\", example.Select(v => v.Replace(\",\", \" \"))));\n\n            var bytes = System.Text.Encoding.UTF8.GetBytes(sb.ToString());\n            return File(bytes, \"text/csv\", \"campaign_sample.csv\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignCsvSchemaBuilder.cs",
      "sha256": "a694fdc231c120d666b13fdfb3c1135a39ccf4e262fa351e19f7646c1acc1816",
      "language": "csharp",
      "size": 4974,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.WhatsAppSettings.Helpers; // TemplateJsonHelper\n\nnamespace xbytechat.api.Features.CampaignModule.Import\n{\n    /// <summary>\n    /// Builds the CSV header schema for a campaign/template.\n    /// - BODY placeholders:\n    ///     * POSITIONAL => parameter1..N\n    ///     * NAMED      => one column per distinct body token name (e.g., name, slug),\n    ///                    and we ALSO include parameter1..N for backward compatibility.\n    /// - HEADER text placeholders => header.text_param1..K\n    /// - Dynamic URL buttons => button{1..3}.url_param (only when template button has {{..}})\n    /// - Always includes \"phone\" (first column).\n    /// </summary>\n    public sealed class CampaignCsvSchemaBuilder\n    {\n        private readonly AppDbContext _db;\n\n        public CampaignCsvSchemaBuilder(AppDbContext db) => _db = db;\n\n        public async Task<IReadOnlyList<string>> BuildAsync(Guid businessId, Guid campaignId, CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n            // Resolve template name from Campaign\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct)\n                ?? throw new KeyNotFoundException(\"Campaign not found.\");\n\n            var templateName = (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\").Trim();\n            if (string.IsNullOrWhiteSpace(templateName))\n                throw new InvalidOperationException(\"Campaign does not have a template selected.\");\n\n            // Get the freshest active WhatsAppTemplate row for this name\n            var tpl = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.Name == templateName && t.IsActive)\n                .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                .FirstOrDefaultAsync(ct)\n                ?? throw new KeyNotFoundException($\"Template '{templateName}' not found in cache.\");\n\n            // Parse raw JSON canonically (works even if you don‚Äôt store the extra JSON columns)\n            var summary = TemplateJsonHelper.SummarizeDetailed(tpl.RawJson, tpl.Body);\n\n            // ‚Äî‚Äî‚Äî Collect tokens ‚Äî‚Äî‚Äî\n            var bodyCountPositional = summary.BodyParamIndices?.Distinct().Count() ?? 0;\n            var bodyNamed = summary.Placeholders\n                .Where(p => p.Location == PlaceholderLocation.Body && p.Type == PlaceholderType.Named)\n                .Select(p => p.Name!)\n                .Where(n => !string.IsNullOrWhiteSpace(n))\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)\n                .ToList();\n\n            var headerTextSlots = (summary.HeaderKind?.Equals(\"text\", StringComparison.OrdinalIgnoreCase) == true)\n                ? (summary.HeaderParamIndices?.Distinct().Count() ?? 0)\n                : 0;\n\n            // Buttons with a dynamic param ({{..}}) in the parameter field\n            var dynamicButtonOrders = summary.Placeholders\n                .Where(p => p.Location == PlaceholderLocation.Button && string.Equals(p.ButtonField, \"param\", StringComparison.OrdinalIgnoreCase))\n                .Select(p => p.ButtonOrder ?? 0)\n                .Where(o => o > 0 && o <= 3)\n                .Distinct()\n                .OrderBy(o => o)\n                .ToList();\n\n            // ‚Äî‚Äî‚Äî Build headers in a stable order ‚Äî‚Äî‚Äî\n            var headers = new List<string> { \"phone\" };\n\n            // BODY: positional or named\n            if (bodyNamed.Count > 0)\n            {\n                // ‚Ä¢ preferred: named columns\n                headers.AddRange(bodyNamed);\n                // ‚Ä¢ backward compatible: parameter1..N (with N from placeholder count)\n                for (int i = 1; i <= Math.Max(bodyCountPositional, summary.PlaceholderCount); i++)\n                    headers.Add($\"parameter{i}\");\n            }\n            else\n            {\n                for (int i = 1; i <= bodyCountPositional; i++)\n                    headers.Add($\"parameter{i}\");\n            }\n\n            // HEADER text placeholders remain numeric\n            for (int i = 1; i <= headerTextSlots; i++)\n                headers.Add($\"header.text_param{i}\");\n\n            // Dynamic URL buttons (at most 3 in Meta)\n            foreach (var ord in dynamicButtonOrders)\n                headers.Add($\"button{ord}.url_param\");\n\n            return headers;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignDispatchController.cs",
      "sha256": "9b1df1625288107f2c9ee203b10b4a17dde0444a69b9562ef7fbf8d3755d49b8",
      "language": "csharp",
      "size": 1940,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/dispatch\")]\n    [Authorize]\n    public class CampaignDispatchController : ControllerBase\n    {\n        private readonly ICampaignDispatcher _dispatcher;\n\n        public CampaignDispatchController(ICampaignDispatcher dispatcher)\n        {\n            _dispatcher = dispatcher;\n        }\n\n        /// <summary>\n        /// Dispatch materialized recipients to the outbound queue.\n        /// Query: mode=canary|full, count=25 (used when mode=canary).\n        /// </summary>\n        [HttpPost]\n        public async Task<ActionResult<CampaignDispatchResponseDto>> Dispatch(\n            [FromRoute] Guid campaignId,\n            [FromQuery] string mode = \"canary\",\n            [FromQuery] int count = 25,\n            CancellationToken ct = default)\n        {\n            try\n            {\n                var businessId = ResolveBusinessId();\n                var resp = await _dispatcher.DispatchAsync(businessId, campaignId, mode, count, ct);\n                return Ok(resp);\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Dispatch failed for Campaign {CampaignId}\", campaignId);\n                return Problem(title: \"Dispatch failed\", detail: ex.Message, statusCode: 400);\n            }\n        }\n\n        private Guid ResolveBusinessId()\n        {\n            var bid = User.GetBusinessId(); // unified helper\n            if (bid == Guid.Empty)\n                throw new UnauthorizedAccessException(\"Invalid or missing businessId claim.\");\n            return bid;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignDispatchPlanController.cs",
      "sha256": "fa1771645ec3aa53f0c0b793831c1a0f3bd6667a876b07d2c0494eaca0a72152",
      "language": "csharp",
      "size": 1271,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/dispatch-plan\")]\n    [Authorize]\n    public class CampaignDispatchPlanController : ControllerBase\n    {\n        private readonly ICampaignDispatchPlannerService _planner;\n\n        public CampaignDispatchPlanController(ICampaignDispatchPlannerService planner)\n        {\n            _planner = planner;\n        }\n\n        /// <summary>\n        /// Returns a read-only dispatch plan: batches, offsets, and throttle summary.\n        /// </summary>\n        [HttpGet]\n        public async Task<IActionResult> Get(Guid campaignId, [FromQuery] int limit = 2000, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            Log.Information(\"Dispatch plan requested {@Ctx}\", new { businessId, campaignId, limit });\n\n            var data = await _planner.PlanAsync(businessId, campaignId, limit, ct);\n            return Ok(new { success = true, data });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignDispatchPlanExportController.cs",
      "sha256": "99c81c3dcba5bf94c119c5e35543288d8a87e691eb1f55fe071d9fee7eec30f5",
      "language": "csharp",
      "size": 1332,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/dispatch-plan.csv\")]\n    [Authorize]\n    public class CampaignDispatchPlanExportController : ControllerBase\n    {\n        private readonly ICsvExportService _csv;\n\n        public CampaignDispatchPlanExportController(ICsvExportService csv)\n        {\n            _csv = csv;\n        }\n\n        /// <summary>\n        /// Streams a CSV of the dispatch plan (batches, offsets, recipients).\n        /// </summary>\n        [HttpGet]\n        public async Task<IActionResult> Get(Guid campaignId, [FromQuery] int limit = 2000, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            Log.Information(\"Dispatch Plan CSV requested {@Ctx}\", new { businessId, campaignId, limit });\n\n            var bytes = await _csv.BuildDispatchPlanCsvAsync(businessId, campaignId, limit, ct);\n            var fileName = $\"dispatch_plan_{campaignId:N}.csv\";\n            return File(bytes, \"text/csv; charset=utf-8\", fileName);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignDryRunController.cs",
      "sha256": "578d68a41c396cb59025d014be7fa8a9c8776b15be6d7e098e8b5a3511502eb0",
      "language": "csharp",
      "size": 1127,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns\")]\n    [Authorize]\n    public sealed class CampaignDryRunController : ControllerBase\n    {\n        private readonly ICampaignService _campaigns;\n        public CampaignDryRunController(ICampaignService campaigns) => _campaigns = campaigns;\n\n        // GET /api/campaigns/{campaignId}/dry-run?limit=20\n        [HttpGet(\"{campaignId:guid}/dry-run\")]\n        public async Task<IActionResult> DryRun([FromRoute] Guid campaignId, [FromQuery] int limit = 20)\n        {\n            if (campaignId == Guid.Empty) return BadRequest(new { message = \"Invalid campaignId\" });\n            if (limit <= 0) limit = 20;\n            if (limit > 200) limit = 200; // guardrails\n\n            var resp = await _campaigns.DryRunTemplateCampaignAsync(campaignId, limit);\n            return Ok(resp);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignMappingsController.cs",
      "sha256": "e4aa5327bae9ff9f05b0388d401b2855e319d128d59889ebd9b8c165dba29616",
      "language": "csharp",
      "size": 3321,
      "content": "using System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CampaignModule.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/mappings\")]\n    [Authorize] // adjust to your auth\n    public sealed class CampaignMappingsController : ControllerBase\n    {\n        private readonly IVariableMappingService _svc;\n        private readonly IMappingSuggestionService _suggest;\n\n        public CampaignMappingsController(IVariableMappingService svc, IMappingSuggestionService suggest)\n        {\n            _svc = svc;\n            _suggest = suggest;\n        }\n\n        /// <summary>\n        /// Returns saved variable mappings for a campaign.\n        /// Shape: dictionary of token -> source (e.g., \"first_name\" -> \"csv:First Name\")\n        /// </summary>\n        [HttpGet]\n        public async Task<IActionResult> GetAsync(\n            [FromRoute] Guid campaignId,\n            CancellationToken ct = default)\n        {\n            var businessId = GetBusinessIdOrThrow();\n            var map = await _svc.GetForCampaignAsync(businessId, campaignId, ct);\n            return Ok(map ?? new System.Collections.Generic.Dictionary<string, string>());\n        }\n\n        /// <summary>\n        /// Saves variable mappings for a campaign.\n        /// Body: { \"tokenA\": \"csv:HeaderA\", \"tokenB\": \"static:Hello\", ... }\n        /// </summary>\n        [HttpPost]\n        public async Task<IActionResult> SaveAsync(\n            [FromRoute] Guid campaignId,\n            [FromBody] System.Collections.Generic.Dictionary<string, string> mappings,\n            CancellationToken ct = default)\n        {\n            if (mappings is null)\n                return BadRequest(\"Body cannot be null; send a mapping dictionary.\");\n\n            var businessId = GetBusinessIdOrThrow();\n            await _svc.SaveAsync(businessId, campaignId, mappings, ct);\n            return NoContent();\n        }\n\n        /// <summary>\n        /// Suggest default mappings from CSV headers and campaign tokens.\n        /// GET /api/campaigns/{campaignId}/mappings/suggest?batchId=...\n        /// </summary>\n        [HttpGet(\"suggest\")]\n        public async Task<IActionResult> SuggestAsync(\n            [FromRoute] Guid campaignId,\n            [FromQuery] Guid batchId,\n            CancellationToken ct = default)\n        {\n            if (batchId == Guid.Empty)\n                return BadRequest(\"batchId is required.\");\n\n            var businessId = GetBusinessIdOrThrow();\n            var map = await _suggest.SuggestAsync(businessId, campaignId, batchId, ct);\n            return Ok(map);\n        }\n\n        // -- helpers --\n\n        private Guid GetBusinessIdOrThrow()\n        {\n            string? raw =\n                User?.FindFirst(\"business_id\")?.Value ??\n                User?.FindFirst(\"BusinessId\")?.Value ??\n                Request.Headers[\"X-Business-Id\"].FirstOrDefault();\n\n            if (!Guid.TryParse(raw, out var id))\n                throw new UnauthorizedAccessException(\n                    \"Business context missing. Pass X-Business-Id header or ensure the business_id claim is present.\");\n\n            return id;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignMaterializationController.cs",
      "sha256": "ba44f1458a39c736281ecc8dbed383fac7a646d34853127258aff6364bcf25d7",
      "language": "csharp",
      "size": 1417,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/materialize\")]\n    [Authorize]\n    public class CampaignMaterializationController : ControllerBase\n    {\n        private readonly ICampaignMaterializationService _materializer;\n\n        public CampaignMaterializationController(ICampaignMaterializationService materializer)\n        {\n            _materializer = materializer;\n        }\n\n        /// <summary>\n        /// Returns a page (limit) of fully materialized recipients: placeholder values and resolved button URLs.\n        /// No send, read-only.\n        /// </summary>\n        [HttpGet]\n        public async Task<IActionResult> Get(Guid campaignId, [FromQuery] int limit = 200, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            Log.Information(\"Materialize GET requested {@Ctx}\", new { businessId, campaignId, limit });\n\n            var data = await _materializer.MaterializeAsync(businessId, campaignId, limit, ct);\n            return Ok(new { success = true, data });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignMaterializationExportController.cs",
      "sha256": "1b18901d4ea990ce054a6dbb6d28e9e86341034ba56f73c92987ba2a015d8aba",
      "language": "csharp",
      "size": 1330,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/materialize.csv\")]\n    [Authorize]\n    public class CampaignMaterializationExportController : ControllerBase\n    {\n        private readonly ICsvExportService _csv;\n\n        public CampaignMaterializationExportController(ICsvExportService csv)\n        {\n            _csv = csv;\n        }\n\n        /// <summary>\n        /// Streams a CSV of materialized recipients (params + button URLs).\n        /// </summary>\n        [HttpGet]\n        public async Task<IActionResult> Get(Guid campaignId, [FromQuery] int limit = 200, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            Log.Information(\"Materialize CSV requested {@Ctx}\", new { businessId, campaignId, limit });\n\n            var bytes = await _csv.BuildMaterializedCsvAsync(businessId, campaignId, limit, ct);\n            var fileName = $\"materialized_{campaignId:N}.csv\";\n            return File(bytes, \"text/csv; charset=utf-8\", fileName);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignMaterializeController.cs",
      "sha256": "75ff118076a1ab627e2eac5e5ad8490a32a93ec90e5638bed3c699cc6b1e5bc7",
      "language": "csharp",
      "size": 4273,
      "content": "// File: Features/CampaignModule/Controllers/CampaignMaterializeController.cs\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/materialize\")]\n    [Authorize]\n    public class CampaignMaterializeController : ControllerBase\n    {\n        private readonly ICampaignMaterializer _csvMaterializer;\n        private readonly ICampaignMaterializationService _recipientPreview;\n\n        public CampaignMaterializeController(\n            ICampaignMaterializer csvMaterializer,\n            ICampaignMaterializationService recipientPreview)\n        {\n            _csvMaterializer = csvMaterializer;\n            _recipientPreview = recipientPreview;\n        }\n\n        /// <summary>\n        /// CSV-based materialization. Use Persist=false for dry-run preview; Persist=true to commit Audience + CSV recipients.\n        /// </summary>\n        [HttpPost]\n        public async Task<ActionResult<CampaignCsvMaterializeResponseDto>> CsvCreate(\n            [FromRoute] Guid campaignId,\n            [FromBody] CampaignCsvMaterializeRequestDto dto,\n            CancellationToken ct)\n        {\n            try\n            {\n                if (dto is null) return BadRequest(\"Body required.\");\n\n                Guid businessId;\n                try { businessId = User.GetBusinessId(); }\n                catch { return Unauthorized(); }\n\n                var actor = ResolveActor();\n\n                Log.Information(\"Materialize request: campaign={CampaignId} persist={Persist} batch={BatchId} audience='{Audience}'\",\n                    campaignId, dto.Persist, dto.CsvBatchId, dto.AudienceName);\n\n                var result = await _csvMaterializer.CreateAsync(businessId, campaignId, dto, actor, ct);\n\n                Log.Information(\"Materialize result: campaign={CampaignId} materialized={Count} skipped={Skipped} audienceId={AudienceId}\",\n                    campaignId, result.MaterializedCount, result.SkippedCount, result.AudienceId);\n\n                return Ok(result);\n            }\n            catch (CampaignAudienceAttachmentService.AudienceLockedException ex)\n            {\n                return Conflict(new { message = ex.Message });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"CSV materialize failed for Campaign {CampaignId}\", campaignId);\n                return Problem(title: \"CSV materialize failed\", detail: ex.Message, statusCode: 400);\n            }\n        }\n\n        /// <summary>\n        /// Recipient-based preview (read-only), using existing recipients + contacts.\n        /// </summary>\n        [HttpGet(\"recipients\")]\n        public async Task<ActionResult<CampaignMaterializeResultDto>> RecipientPreview(\n            [FromRoute] Guid campaignId,\n            [FromQuery] int limit = 200,\n            CancellationToken ct = default)\n        {\n            try\n            {\n                Guid businessId;\n                try { businessId = User.GetBusinessId(); }\n                catch { return Unauthorized(); }\n\n                var result = await _recipientPreview.MaterializeAsync(businessId, campaignId, limit, ct);\n                return Ok(result);\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Recipient preview failed for Campaign {CampaignId}\", campaignId);\n                return Problem(title: \"Recipient preview failed\", detail: ex.Message, statusCode: 400);\n            }\n        }\n\n        private string ResolveActor()\n        {\n            var email = User.Claims.FirstOrDefault(c => c.Type.EndsWith(\"email\", StringComparison.OrdinalIgnoreCase))?.Value;\n            if (!string.IsNullOrWhiteSpace(email)) return email!;\n\n            return User.Identity?.Name\n                   ?? (User.Claims.FirstOrDefault(c => c.Type.EndsWith(\"nameidentifier\", StringComparison.OrdinalIgnoreCase))?.Value)\n                   ?? \"system\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignPreviewController.cs",
      "sha256": "0f88ad7bec9bc43c01918eaa6fe58c499f1926fecc2a7e9430ae6d99cc47cf36",
      "language": "csharp",
      "size": 1384,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/preview\")]\n    [Authorize]\n    public class CampaignPreviewController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly ICampaignPreviewService _preview;\n\n        public CampaignPreviewController(AppDbContext db, ICampaignPreviewService preview)\n        {\n            _db = db; _preview = preview;\n        }\n\n        [HttpPost]\n        public async Task<ActionResult<CampaignPreviewResponseDto>> Preview(Guid campaignId, [FromBody] CampaignPreviewRequestDto req)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            var exists = await _db.Campaigns.AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n            if (!exists) return NotFound();\n\n            var data = await _preview.PreviewAsync(businessId, campaignId, req?.ContactId);\n            return Ok(data);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignRecipientController.cs",
      "sha256": "1439351d33ce2b37017fa44d06b15ae0c52b72cdfb7e7b6843820642fb1ce49b",
      "language": "csharp",
      "size": 4029,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class CampaignRecipientController : ControllerBase\n    {\n        private readonly ICampaignRecipientService _recipientService;\n\n        public CampaignRecipientController(ICampaignRecipientService recipientService)\n        {\n            _recipientService = recipientService;\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<ActionResult<CampaignRecipientDto>> GetRecipientById(Guid id)\n        {\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); }\n            catch { return Unauthorized(); }\n\n            var recipient = await _recipientService.GetByIdAsync(businessId, id);\n            if (recipient == null)\n                return NotFound(new { message = \"Recipient not found\" });\n\n            return Ok(recipient);\n        }\n\n        [HttpGet(\"/api/campaigns/{campaignId}/recipients\")]\n        public async Task<ActionResult> GetRecipientsForCampaign(Guid campaignId)\n        {\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); }\n            catch { return Unauthorized(); }\n\n            var recipients = await _recipientService.GetByCampaignIdAsync(businessId, campaignId);\n            return Ok(recipients);\n        }\n\n        [HttpPut(\"{recipientId}/status\")]\n        public async Task<ActionResult> UpdateStatus(Guid recipientId, [FromQuery] string newStatus)\n        {\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); }\n            catch { return Unauthorized(); }\n\n            var success = await _recipientService.UpdateStatusAsync(businessId, recipientId, newStatus);\n            if (!success)\n                return NotFound(new { message = \"Recipient not found or update failed\" });\n\n            return Ok(new { message = \"Status updated\" });\n        }\n\n        [HttpPut(\"{recipientId}/reply\")]\n        public async Task<ActionResult> TrackReply(Guid recipientId, [FromQuery] string replyText)\n        {\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); }\n            catch { return Unauthorized(); }\n\n            var success = await _recipientService.TrackReplyAsync(businessId, recipientId, replyText);\n            if (!success)\n                return NotFound(new { message = \"Recipient not found or tracking failed\" });\n\n            return Ok(new { message = \"Reply tracked\" });\n        }\n\n        [HttpGet(\"search\")]\n        public async Task<ActionResult<List<CampaignRecipientDto>>> SearchRecipients([FromQuery] string? status, [FromQuery] string? keyword)\n        {\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); }\n            catch { return Unauthorized(); }\n\n            var results = await _recipientService.SearchRecipientsAsync(businessId, status, keyword);\n            return Ok(results);\n        }\n\n        [HttpPost(\"{id}/assign-contacts\")]\n        public async Task<IActionResult> AssignContacts(Guid id, [FromBody] AssignContactsDto dto)\n        {\n            try\n            {\n                Guid businessId;\n                try { businessId = User.GetBusinessId(); }\n                catch { return Unauthorized(); }\n\n                await _recipientService.AssignContactsToCampaignAsync(businessId, id, dto.ContactIds);\n                return Ok(new { message = \"Contacts assigned successfully\" });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Error assigning contacts to campaign\");\n                return StatusCode(500, new { message = \"Failed to assign contacts\" });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignRetargetController.cs",
      "sha256": "82e0a7a70da1b52fae40fa16555c7257d1b6361c9cd764527f97f8adb8149fd1",
      "language": "csharp",
      "size": 1374,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Authorize]\n    [Route(\"api/campaigns/retarget\")]\n    public class CampaignRetargetController : BusinessControllerBase\n    {\n        private readonly ICampaignRetargetService _svc;\n\n        public CampaignRetargetController(ICampaignRetargetService svc)\n        {\n            _svc = svc;\n        }\n        [HttpPost]\n        public async Task<IActionResult> CreateRetargetCampaign(\n            [FromBody] RetargetCampaignRequestDto dto,\n            CancellationToken ct)\n        {\n            var campaignName = dto.Name?.Trim() ?? dto.Campaign?.Name?.Trim();\n            if (string.IsNullOrWhiteSpace(campaignName))\n            {\n                return BadRequest(new { error = \"Campaign Name is required for retargeting.\" });\n            }\n\n            var createdBy = UserId.ToString();\n            var result = await _svc.CreateRetargetCampaignAsync(BusinessId, dto, createdBy, ct);\n            return Ok(result);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignRetryController.cs",
      "sha256": "ca2204f071f6a85505d1550007e2bb2fa0ea7c35a4d13542b1ed9727751b1b9f",
      "language": "csharp",
      "size": 1424,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns\")]\n    [Authorize]\n    public sealed class CampaignRetryController : ControllerBase\n    {\n        private readonly Services.ICampaignRetryService _retry;\n\n        public CampaignRetryController(Services.ICampaignRetryService retry)\n        {\n            _retry = retry;\n        }\n\n        // POST /api/campaigns/{campaignId}/retry-failed?limit=200\n        [HttpPost(\"{campaignId:guid}/retry-failed\")]\n        public async Task<IActionResult> RetryFailed([FromRoute] Guid campaignId, [FromQuery] int limit = 200)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty)\n                return Unauthorized(new { success = false, error = \"Invalid business context.\" });\n\n            try\n            {\n                var data = await _retry.RetryFailedAsync(businessId, campaignId, limit);\n                return Ok(new { success = true, data });\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"RetryFailed error for Campaign {CampaignId}\", campaignId);\n                return BadRequest(new { success = false, error = ex.Message });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignSendValidator.cs",
      "sha256": "cb9b4a3ee2f532a382778e8eb8e608b1f807cf30fa4ee5fa71dcb5c6de489a0c",
      "language": "csharp",
      "size": 4488,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignModule.SendEngine;\nusing xbytechat.api.WhatsAppSettings.Helpers; // TemplateJsonHelper\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine\n{\n    public interface ICampaignSendValidator\n    {\n        (bool Ok, string? Error) Validate(SendPlan plan, RecipientPlan recipient, TemplateEnvelope env, WhatsAppTemplate tmplRow);\n    }\n\n    public sealed class CampaignSendValidator : ICampaignSendValidator\n    {\n        public (bool Ok, string? Error) Validate(SendPlan plan, RecipientPlan recipient, TemplateEnvelope env, WhatsAppTemplate tmplRow)\n        {\n            // Summarize the provider-native template JSON to know how many placeholders exist\n            var summary = TemplateJsonHelper.SummarizeDetailed(tmplRow.RawJson ?? \"{}\", tmplRow.Body);\n\n            // ----- BODY: positional placeholders (parameter1..N)\n            var bodySlots = summary.BodyParamIndices?.DefaultIfEmpty(0).Max() ?? 0;\n            var bodyHave = env.BodyParams?.Count ?? 0;\n            if (bodyHave < bodySlots)\n            {\n                return (false, $\"Body parameters missing: need {bodySlots}, got {bodyHave}. Expected keys parameter1..parameter{bodySlots}.\");\n            }\n\n            // ----- HEADER: text placeholders (header.text_param1..K) only if header is Text\n            var isHeaderText = string.Equals(summary.HeaderKind ?? \"none\", \"text\", StringComparison.OrdinalIgnoreCase)\n                               || plan.HeaderKind == HeaderKind.Text;\n            if (isHeaderText)\n            {\n                var headerSlots = summary.HeaderParamIndices?.DefaultIfEmpty(0).Max() ?? 0;\n                var headerHave = env.HeaderParams?.Count ?? 0;\n                if (headerHave < headerSlots)\n                {\n                    return (false, $\"Header text parameters missing: need {headerSlots}, got {headerHave}. Expected keys header.text_param1..header.text_param{headerSlots}.\");\n                }\n            }\n\n            // ----- BUTTONS: url parameter per button position present in template\n            var urlButtonPositions = summary.Placeholders\n                .Where(p => p.Location == PlaceholderLocation.Button &&\n                            string.Equals(p.ButtonField, \"param\", StringComparison.OrdinalIgnoreCase))\n                .Select(p => p.ButtonOrder ?? 0)\n                .Where(o => o > 0 && o <= 3)\n                .Distinct()\n                .OrderBy(o => o)\n                .ToArray();\n\n            if (urlButtonPositions.Length > 0)\n            {\n                // Read per-recipient button params (prefer canonical dict, fallback to legacy array)\n                var (btnDict, btnList) = ReadButtonParams(env.PerRecipientButtonParamsJson);\n\n                foreach (var pos in urlButtonPositions)\n                {\n                    // canonical dict key\n                    var key = $\"button{pos}.url_param\";\n\n                    var hasValue =\n                        (btnDict != null && btnDict.TryGetValue(key, out var dv) && !string.IsNullOrWhiteSpace(dv))\n                        || (btnList != null && btnList.Count >= pos && !string.IsNullOrWhiteSpace(btnList[pos - 1]));\n\n                    if (!hasValue)\n                        return (false, $\"Missing per-recipient button parameter: '{key}'. Provide a value for the URL button at position {pos}.\");\n                }\n            }\n\n            return (true, null);\n        }\n\n        // Returns (dict,list) where exactly one is non-null when data is present\n        private static (Dictionary<string, string>? dict, List<string>? list) ReadButtonParams(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json))\n                return (null, null);\n\n            // try dict first (canonical)\n            try\n            {\n                var dict = JsonSerializer.Deserialize<Dictionary<string, string>>(json!);\n                if (dict is { Count: > 0 }) return (dict, null);\n            }\n            catch { /* ignore */ }\n\n            // fallback to list (legacy)\n            try\n            {\n                var list = JsonSerializer.Deserialize<List<string>>(json!);\n                if (list is { Count: > 0 }) return (null, list);\n            }\n            catch { /* ignore */ }\n\n            return (null, null);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CampaignVariableMapController.cs",
      "sha256": "882eb072e75759c98b2257f09ada75c7721d73996978f7d35a4ce3721ee13767",
      "language": "csharp",
      "size": 1942,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/variables\")]\n    [Authorize]\n    public class CampaignVariableMapController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly ICampaignVariableMapService _svc;\n\n        public CampaignVariableMapController(AppDbContext db, ICampaignVariableMapService svc)\n        { _db = db; _svc = svc; }\n\n        [HttpGet]\n        public async Task<IActionResult> Get(Guid campaignId)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            var exists = await _db.Campaigns.AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n            if (!exists) return NotFound(new { success = false, message = \"Campaign not found\" });\n\n            var data = await _svc.GetAsync(businessId, campaignId);\n            return Ok(new { success = true, data });\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> Save(Guid campaignId, [FromBody] CampaignVariableMapDto body)\n        {\n            var businessId = User.GetBusinessId();\n            var userName = User.Identity?.Name ?? \"system\";\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            if (body == null) return BadRequest(new { success = false, message = \"Body required\" });\n            body.CampaignId = campaignId;\n\n            var ok = await _svc.SaveAsync(businessId, body, userName);\n            return Ok(new { success = ok });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/CsvBatchController.cs",
      "sha256": "adb9f2110c4e4ed93fd06752020663c2545b35c04cc1c3e38949026b57bbd347",
      "language": "csharp",
      "size": 5298,
      "content": "using System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared;   // User.GetBusinessId()\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.CampaignModule.DTOs.Requests;  // ResponseResult\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/csv/batch\")]\n    [Authorize]\n    public class CsvBatchController : ControllerBase\n    {\n        private readonly ICsvBatchService _service;\n\n        public CsvBatchController(ICsvBatchService service)\n        {\n            _service = service;\n        }\n\n        /// <summary>Upload a CSV, create a batch, and ingest rows.</summary>\n        [HttpPost]\n        [RequestSizeLimit(1024L * 1024L * 200L)] // 200 MB\n        public async Task<IActionResult> Upload(\n            [FromForm] CsvBatchUploadForm form,\n            CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty)\n                return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n            if (form.File is null || form.File.Length == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV file is required\"));\n\n            // soft sanity (many browsers use text/csv; don't block others)\n            var allowed = new[] { \"text/csv\", \"application/vnd.ms-excel\", \"application/octet-stream\" };\n            if (!allowed.Contains(form.File.ContentType, StringComparer.OrdinalIgnoreCase))\n                Log.Warning(\"Unusual CSV content type: {ContentType}\", form.File.ContentType);\n\n            await using var stream = form.File.OpenReadStream();\n\n            var result = await _service.CreateAndIngestAsync(\n                businessId: businessId,\n                fileName: form.File.FileName,\n                stream: stream,\n                audienceId: form.AudienceId,\n                campaignId: form.CampaignId,\n                ct: ct);\n\n            return Ok(new { success = true, data = result });\n        }\n\n\n        [HttpGet(\"{batchId:guid}\")]\n        public async Task<IActionResult> Get(Guid batchId, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n            var result = await _service.GetBatchAsync(businessId, batchId, ct);\n            if (result == null) return NotFound(ResponseResult.ErrorInfo(\"Batch not found\"));\n            return Ok(new { success = true, data = result });\n        }\n\n        [HttpGet(\"{batchId:guid}/sample\")]\n        public async Task<IActionResult> Sample(Guid batchId, [FromQuery] int take = 20, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n            var rows = await _service.GetSamplesAsync(businessId, batchId, take, ct);\n            return Ok(new { success = true, data = rows });\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> List([FromQuery] int limit = 20, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n            var list = await _service.ListBatchesAsync(businessId, limit, ct);\n            return Ok(new { success = true, data = list });\n        }\n\n        [HttpGet(\"{batchId:guid}/rows\")]\n        public async Task<IActionResult> RowsPage(Guid batchId, [FromQuery] int skip = 0, [FromQuery] int take = 50, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n            var page = await _service.GetRowsPageAsync(businessId, batchId, skip, take, ct);\n            return Ok(new { success = true, data = page });\n        }\n\n        //[HttpPost(\"{batchId:guid}/validate\")]\n        //public async Task<IActionResult> Validate(Guid batchId, [FromBody] CsvBatchValidationRequestDto request, CancellationToken ct = default)\n        //{\n        //    var businessId = User.GetBusinessId();\n        //    if (businessId == Guid.Empty) return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n        //    var result = await _service.ValidateAsync(businessId, batchId, request, ct);\n        //    return Ok(new { success = true, data = result });\n        //}\n\n        [HttpDelete(\"{batchId:guid}\")]\n        public async Task<IActionResult> Delete(Guid batchId, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized(ResponseResult.ErrorInfo(\"Invalid business\"));\n\n            var ok = await _service.DeleteBatchAsync(businessId, batchId, ct);\n            return ok ? Ok(new { success = true }) : NotFound(ResponseResult.ErrorInfo(\"Batch not found\"));\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Controllers/OutboundCampaignQueueController.cs",
      "sha256": "b32af6b334cd55462ca38b0506a7d1d5a4961309a1c4d260324faec64efb7c12",
      "language": "csharp",
      "size": 4153,
      "content": "using System;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing System.Collections.Generic;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Shared; // for User.GetBusinessId()\n\nnamespace xbytechat.api.Features.CampaignModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaigns/{campaignId:guid}/queue\")]\n    [Authorize]\n    public class OutboundCampaignQueueController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly IOutboundCampaignQueueService _queue;\n\n        public OutboundCampaignQueueController(AppDbContext db, IOutboundCampaignQueueService queue)\n        {\n            _db = db; _queue = queue;\n        }\n\n        // GET: /api/campaigns/{id}/queue/jobs\n        [HttpGet(\"jobs\")]\n        public async Task<ActionResult<IEnumerable<OutboundCampaignJobDto>>> ListJobs(Guid campaignId)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            // ownership check\n            var exists = await _db.Campaigns.AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n            if (!exists) return NotFound();\n\n            var jobs = await _queue.GetJobsForCampaignAsync(businessId, campaignId);\n            return Ok(jobs.Select(Map));\n        }\n\n        // POST: /api/campaigns/{id}/queue/enqueue?forceDuplicate=false\n        [HttpPost(\"enqueue\")]\n        public async Task<ActionResult<object>> Enqueue(Guid campaignId, [FromQuery] bool forceDuplicate = false)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            var exists = await _db.Campaigns.AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n            if (!exists) return NotFound();\n\n            var jobId = await _queue.EnqueueAsync(businessId, campaignId, forceDuplicate);\n            return Ok(new { success = true, jobId });\n        }\n\n        // POST: /api/campaigns/{id}/queue/{jobId}/retry\n        [HttpPost(\"{jobId:guid}/retry\")]\n        public async Task<ActionResult<object>> Retry(Guid campaignId, Guid jobId)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            // Optional: ensure job belongs to this campaign & business\n            var job = await _db.OutboundCampaignJobs\n                .AsNoTracking()\n                .FirstOrDefaultAsync(j => j.Id == jobId && j.BusinessId == businessId && j.CampaignId == campaignId);\n\n            if (job == null) return NotFound();\n\n            var ok = await _queue.ForceRetryNowAsync(businessId, jobId);\n            return Ok(new { success = ok });\n        }\n\n        // POST: /api/campaigns/{id}/queue/{jobId}/cancel\n        [HttpPost(\"{jobId:guid}/cancel\")]\n        public async Task<ActionResult<object>> Cancel(Guid campaignId, Guid jobId)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            var job = await _db.OutboundCampaignJobs\n                .AsNoTracking()\n                .FirstOrDefaultAsync(j => j.Id == jobId && j.BusinessId == businessId && j.CampaignId == campaignId);\n\n            if (job == null) return NotFound();\n\n            var ok = await _queue.CancelAsync(businessId, jobId);\n            return Ok(new { success = ok });\n        }\n\n        private static OutboundCampaignJobDto Map(OutboundCampaignJob j) => new OutboundCampaignJobDto\n        {\n            Id = j.Id,\n            BusinessId = j.BusinessId,\n            CampaignId = j.CampaignId,\n            Status = j.Status,\n            Attempt = j.Attempt,\n            MaxAttempts = j.MaxAttempts,\n            NextAttemptAt = j.NextAttemptAt,\n            LastError = j.LastError,\n            CreatedAt = j.CreatedAt,\n            UpdatedAt = j.UpdatedAt\n        };\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/CountryCodes/WhatsAppPhoneValidationOptions.cs",
      "sha256": "7fcbddc921c2e01586f8d029c3df9e9a5dc5250603aea41d78d9cf6ef4c97e50",
      "language": "csharp",
      "size": 276,
      "content": "namespace xbytechat.api.Features.CampaignModule.CountryCodes\n{\n    public sealed class WhatsAppPhoneValidationOptions\n    {\n        public string Mode { get; set; } = \"allow\"; // \"allow\" or \"deny\"\n        public List<string> AllowedCountryCodes { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/AssignContactsDto.cs",
      "sha256": "8f8b9b0da213111f833dd07dd7e5189ccc02984cef1b34deb5b1d93a5d40678e",
      "language": "csharp",
      "size": 156,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class AssignContactsDto\n    {\n        public List<Guid> ContactIds { get; set; }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignAudienceDtos.cs",
      "sha256": "958e2b1191e2578f7d73ab6f8038b49a1a853a8e61013f9f7b833b79a07c5e7e",
      "language": "csharp",
      "size": 1722,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    /// <summary>\n    /// Current CSV audience attachment state for a campaign (active attachment only).\n    /// Returned by GET /api/campaigns/{campaignId}/audience.\n    /// </summary>\n    public sealed class CampaignAudienceDto\n    {\n        public Guid? AttachmentId { get; set; }\n        public Guid? AudienceId { get; set; }\n        public string? AudienceName { get; set; }\n\n        public Guid? CsvBatchId { get; set; }\n        public string? FileName { get; set; }\n        public DateTime? CreatedAt { get; set; }\n\n        public int MemberCount { get; set; }\n\n        /// <summary>\n        /// True when the campaign has already been sent (or has send logs) and the audience is immutable.\n        /// </summary>\n        public bool IsLocked { get; set; }\n    }\n\n    public sealed class CampaignAudienceHistoryItemDto\n    {\n        public Guid AttachmentId { get; set; }\n        public Guid AudienceId { get; set; }\n        public string? AudienceName { get; set; }\n\n        public Guid CsvBatchId { get; set; }\n        public string? FileName { get; set; }\n\n        public bool IsActive { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public DateTime? DeactivatedAt { get; set; }\n        public string? DeactivatedBy { get; set; }\n    }\n\n    public sealed class CampaignAudienceReplaceResponseDto\n    {\n        public CampaignAudienceDto Active { get; set; } = new();\n        public int CsvRecipientsInserted { get; set; }\n    }\n\n    public sealed class CampaignAudienceRemoveResponseDto\n    {\n        public CampaignAudienceDto Active { get; set; } = new();\n        public int CsvRecipientsDeleted { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignButtonDto.cs",
      "sha256": "edeaae8d1d1c7ff60b77f0dc68a4f382420cad6364302ea6816f34938c76a45e",
      "language": "csharp",
      "size": 465,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignButtonDto\n    {\n        public string ButtonText { get; set; } = string.Empty; // üìç e.g., \"Buy Now\"\n        public string ButtonType { get; set; } = \"url\";         // üîò url | quick_reply | call\n        public string TargetUrl { get; set; } = string.Empty;  // üåê or phone/call param\n\n        public string? Value { get; set; }\n        public int Position { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignButtonParamFromMetaDto.cs",
      "sha256": "d218adbbc4e6418548f3dfe962c8b867fc7f364be490f6533d04fb5c61f17f30",
      "language": "csharp",
      "size": 391,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignButtonParamFromMetaDto\n    {\n        public string Text { get; set; } = string.Empty;\n        public string Type { get; set; } = string.Empty;\n        public string SubType { get; set; } = string.Empty;\n        public string Value { get; set; } = string.Empty;\n        public int Position { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignCreateDto.cs",
      "sha256": "6b6b7b78d42631d7c64b527942ea1452b1d5860ded056d77d24b634d801cd6be",
      "language": "csharp",
      "size": 1881,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.CTAManagement.DTOs;\nusing xbytechat.api.Features.MessagesEngine.DTOs; // Required to reference CTAButtonDto\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignCreateDto\n    {\n        public string Name { get; set; }\n\n        [Column(TypeName = \"text\")]\n        public string MessageTemplate { get; set; }\n\n        public string? TemplateId { get; set; } // ‚úÖ Optional Meta template ID\n\n        public string? FollowUpTemplateId { get; set; } // üîÅ Auto-reply template after interest\n\n        public string? CampaignType { get; set; } //= \"template\"; // \"text\", \"template\", \"cta\"\n\n        public Guid? CtaId { get; set; } // üîò For legacy CTA support (optional)\n\n        public Guid? CTAFlowConfigId { get; set; }\n        public List<CampaignButtonDto> MultiButtons { get; set; } = new(); // ‚úÖ New multi-button support\n        public DateTime? ScheduledAt { get; set; } // üìÖ Optional future scheduling\n\n        //public List<Guid>? ContactIds { get; set; } // üë• Target contact list\n\n        public string? ImageUrl { get; set; } // üñºÔ∏è Optional image field\n\n        public string? ImageCaption { get; set; } // üìù Optional caption\n\n        public List<Guid> ContactIds { get; set; } = new();\n\n        public List<string>? TemplateParameters { get; set; }\n        public List<CampaignButtonParamFromMetaDto>? ButtonParams { get; set; }\n\n        // Sender fields (REQUIRED for reliability)\n        public string Provider { get; set; }            // \"PINNACLE\" | \"META_CLOUD\" (UPPERCASE)\n        public string PhoneNumberId { get; set; }\n\n        public string? HeaderKind { get; set; }        // \"image\" | \"video\" | \"document\" | \"text\" | \"none\"\n        public string? HeaderMediaUrl { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignCsvMaterializeDtos.cs",
      "sha256": "56c8084a7a0a181e779d3ad774edd588567949c55bcca324c7614b3c7528098c",
      "language": "csharp",
      "size": 1503,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CampaignCsvMaterializeRequestDto\n    {\n        [Required] public Guid CsvBatchId { get; set; }\n        public Dictionary<string, string>? Mappings { get; set; } // token -> header or \"constant:Value\"\n        public string? PhoneField { get; set; }\n        public bool NormalizePhones { get; set; } = true;\n        public bool Deduplicate { get; set; } = true;\n        public int? Limit { get; set; } = 200;\n\n        public bool Persist { get; set; } = false;\n        public string? AudienceName { get; set; } // required when Persist=true\n    }\n\n    public sealed class CsvMaterializedRowDto\n    {\n        public int RowIndex { get; set; }\n        public string? Phone { get; set; }\n        public Dictionary<string, string> Variables { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n    }\n\n    public sealed class CampaignCsvMaterializeResponseDto\n    {\n        public Guid CampaignId { get; set; }\n        public Guid CsvBatchId { get; set; }\n        public int TotalRows { get; set; }\n        public int MaterializedCount { get; set; }\n        public int SkippedCount { get; set; }\n        public Guid? AudienceId { get; set; }          // if persisted\n        public List<CsvMaterializedRowDto> Preview { get; set; } = new();\n        public List<string> Warnings { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignDispatchDtos.cs",
      "sha256": "141796a3913c2089c829bec345ac9d929fb9d8d23826436df34de7d709426f82",
      "language": "csharp",
      "size": 884,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CampaignDispatchResponseDto\n    {\n        public Guid CampaignId { get; set; }\n        public string Mode { get; set; } = \"canary\"; // canary|full\n        public int RequestedCount { get; set; }\n        public int SelectedCount { get; set; }\n        public int EnqueuedCount { get; set; }\n        public List<DispatchedRecipientDto> Sample { get; set; } = new(); // small sample for debug\n        public List<string> Warnings { get; set; } = new();\n    }\n\n    public sealed class DispatchedRecipientDto\n    {\n        public Guid RecipientId { get; set; }\n        public string? Phone { get; set; }\n        public string? Status { get; set; }\n        public DateTime? MaterializedAt { get; set; }\n        public string? IdempotencyKey { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignDispatchPlanDtos.cs",
      "sha256": "11f2306c03e0faa381004558316aded4856107a52df35dde32c528be27d16f34",
      "language": "csharp",
      "size": 1870,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class DispatchBatchDto\n    {\n        public int BatchNumber { get; set; }\n        public int StartIndex { get; set; }\n        public int Count { get; set; }\n\n        /// <summary>Total approximate payload size for this batch in bytes (text + buttons, naive estimate).</summary>\n        public int ApproxBytes { get; set; }\n\n        /// <summary>Seconds since plan start when this batch is allowed to start (based on throttling).</summary>\n        public int OffsetSeconds { get; set; }\n\n        public List<Guid?> RecipientIds { get; set; } = new();   // when using CampaignRecipients\n        public List<string?> Phones { get; set; } = new();\n        public List<string> Notes { get; set; } = new();\n    }\n\n    public class DispatchThrottleDto\n    {\n        public string Plan { get; set; } = \"Unknown\";\n        public string Provider { get; set; } = \"Auto\";\n        public int MaxBatchSize { get; set; } = 50;\n        public int MaxPerMinute { get; set; } = 300;\n        public int ComputedBatches { get; set; }\n        public int EstimatedMinutes { get; set; }\n        public List<string> Warnings { get; set; } = new();\n    }\n\n    public class CampaignDispatchPlanResultDto\n    {\n        public Guid CampaignId { get; set; }\n        public string TemplateName { get; set; } = string.Empty;\n        public string Language { get; set; } = \"en\";\n        public int PlaceholderCount { get; set; }\n\n        public int TotalRecipients { get; set; }\n        public int TotalApproxBytes { get; set; }\n\n        public DispatchThrottleDto Throttle { get; set; } = new();\n        public List<DispatchBatchDto> Batches { get; set; } = new();\n\n        public int WarningCount { get; set; }\n        public List<string> GlobalWarnings { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignDryRunDto.cs",
      "sha256": "eb3c8b6acf0bcc6f3ce31d5d3b62a9183655a8bdcef813406921403f8625371b",
      "language": "csharp",
      "size": 1530,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CampaignDryRunRecipientResultDto\n    {\n        public Guid? ContactId { get; set; }\n        public string? ContactName { get; set; }\n        public string PhoneNumber { get; set; } = \"\";\n        public bool WouldSend { get; set; }\n        public List<string> Errors { get; set; } = new();\n        public List<string> Warnings { get; set; } = new();\n\n        // Provider-shaped components (Meta/Pinnacle compatible)\n        public List<object> ProviderComponents { get; set; } = new();\n    }\n\n    public sealed class CampaignDryRunResponseDto\n    {\n        public Guid CampaignId { get; set; }\n        public string CampaignType { get; set; } = \"\";\n        public string TemplateName { get; set; } = \"\";\n        public string? Language { get; set; }\n        public bool HasHeaderMedia { get; set; }\n        public int RequiredPlaceholders { get; set; }\n        public int ProvidedPlaceholders { get; set; }\n\n        public int RecipientsConsidered { get; set; }\n        public int WouldSendCount { get; set; }\n        public int ErrorCount { get; set; }\n\n        // Billability (best-effort estimate)\n        public bool EstimatedChargeable { get; set; } = true;\n        public string EstimatedConversationCategory { get; set; } = \"template_outbound\";\n        public List<string> Notes { get; set; } = new();\n\n        public List<CampaignDryRunRecipientResultDto> Results { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignDryRunDtos.cs",
      "sha256": "3ed24bbc0f923a1d28720fad67c5d2c1d8065edfb882467e24b0669d00433711",
      "language": "csharp",
      "size": 1116,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignDryRunIssueDto\n    {\n        public Guid? RecipientId { get; set; }\n        public Guid? ContactId { get; set; }\n        public string Phone { get; set; } = string.Empty;\n\n        /// <summary>\n        /// error | warn\n        /// </summary>\n        public string Severity { get; set; } = \"error\";\n\n        public string Message { get; set; } = string.Empty;\n    }\n\n    public class CampaignDryRunResultDto\n    {\n        public Guid CampaignId { get; set; }\n        public string TemplateName { get; set; } = string.Empty;\n        public string Language { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Placeholder count detected in the template (e.g., {{1}}, {{2}}, ...).\n        /// </summary>\n        public int PlaceholderCount { get; set; }\n\n        public int CheckedRecipients { get; set; }\n        public int ErrorCount { get; set; }\n        public int WarningCount { get; set; }\n\n        public List<CampaignDryRunIssueDto> Issues { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignDto.cs",
      "sha256": "bf33c6aa688063d8efd2734082713e23890bb97409bae31a5bc9d18c00ccd001",
      "language": "csharp",
      "size": 1223,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignDto\n    {\n        public Guid Id { get; set; }\n\n        public string Name { get; set; }\n\n        public string MessageTemplate { get; set; }\n\n        public string? TemplateId { get; set; }\n        public string? MessageBody { get; set; }\n        public string? CampaignType { get; set; }\n\n        public string? Status { get; set; }\n\n        public string? ImageUrl { get; set; }\n\n        public string? ImageCaption { get; set; }\n\n        public DateTime CreatedAt { get; set; }\n\n        public DateTime? ScheduledAt { get; set; }\n\n        public Guid? CtaId { get; set; }\n\n        public CtaPreviewDto? Cta { get; set; }\n\n        public List<CampaignButtonDto> MultiButtons { get; set; } = new();\n\n        public Guid? CTAFlowConfigId { get; set; }\n        public string? CTAFlowName { get; set; }\n    }\n\n    // üì¶ Embedded DTO for CTA preview (title + button text only)\n    public class CtaPreviewDto\n    {\n        public string Title { get; set; } = string.Empty;\n\n        public string ButtonText { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignMaterializationDtos.cs",
      "sha256": "8764d77154e31907654114e66ffc6eb0c83f456db58b64632a1df0a92a139b8e",
      "language": "csharp",
      "size": 2077,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class ButtonResolutionDto\n    {\n        public string ButtonText { get; set; } = string.Empty;\n        public string? RawTemplateValue { get; set; } // e.g. \"https://x.com/{{1}}?q={{2}}\"\n        public string? ResolvedUrl { get; set; }\n        public List<string> UsedPlaceholders { get; set; } = new(); // e.g. [\"{{1}}\",\"{{2}}\"]\n        public List<string> MissingArguments { get; set; } = new(); // e.g. [\"{{2}}\"]\n        public List<string> Notes { get; set; } = new();\n    }\n\n    public class TemplateParamResolutionDto\n    {\n        public int Index { get; set; } // 1-based placeholder index from template ({{1}}, {{2}}, ...)\n        public string? Value { get; set; }\n        public string SourceType { get; set; } = string.Empty; // AudienceColumn | Static | Expression\n        public string? SourceKey { get; set; } // column name when SourceType = AudienceColumn\n        public bool IsMissing { get; set; }\n        public string? Note { get; set; }\n    }\n\n    public class MaterializedRecipientDto\n    {\n        public Guid? RecipientId { get; set; }      // when using CampaignRecipients\n        public Guid? ContactId { get; set; }\n        public string? Phone { get; set; }\n\n        public List<TemplateParamResolutionDto> Parameters { get; set; } = new();\n        public List<ButtonResolutionDto> Buttons { get; set; } = new();\n\n        public List<string> Warnings { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n    }\n\n    public class CampaignMaterializeResultDto\n    {\n        public Guid CampaignId { get; set; }\n        public string TemplateName { get; set; } = string.Empty;\n        public string Language { get; set; } = string.Empty;\n        public int PlaceholderCount { get; set; }\n\n        public int ReturnedCount { get; set; }\n        public int ErrorCount { get; set; }\n        public int WarningCount { get; set; }\n\n        public List<MaterializedRecipientDto> Rows { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignMaterializeDtos.cs",
      "sha256": "b0877006311fb95066d695b7004e7b9ac971424f049675ca95d2e24fbbbcced6",
      "language": "csharp",
      "size": 2046,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CampaignMaterializeRequestDto\n    {\n        [Required] public Guid CsvBatchId { get; set; }\n\n        /// <summary>\n        /// Optional explicit mapping: token -> CSV header name or \"constant:Value\".\n        /// If null/empty, we‚Äôll try loading saved mappings; if none exist, we fall back to header==token.\n        /// </summary>\n        public Dictionary<string, string>? Mappings { get; set; }\n\n        /// <summary>\n        /// If not provided, we will try common headers like phone, mobile, whatsapp, msisdn.\n        /// </summary>\n        public string? PhoneField { get; set; }\n\n        public bool NormalizePhones { get; set; } = true;\n        public bool Deduplicate { get; set; } = true;\n\n        /// <summary>Preview only first N rows; 0 or null means all.</summary>\n        public int? Limit { get; set; } = 200;\n\n        /// <summary>When true, materialized rows are persisted to Audience + CampaignRecipients.</summary>\n        public bool Persist { get; set; } = false;\n\n        /// <summary>Required when Persist = true.</summary>\n        public string? AudienceName { get; set; }\n    }\n\n    public sealed class MaterializedRowDto\n    {\n        public int RowIndex { get; set; }\n        public string? Phone { get; set; }\n        public Dictionary<string, string> Variables { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n    }\n\n    public sealed class CampaignMaterializeResponseDto\n    {\n        public Guid CampaignId { get; set; }\n        public Guid CsvBatchId { get; set; }\n        public int TotalRows { get; set; }\n        public int MaterializedCount { get; set; }\n        public int SkippedCount { get; set; }\n        public Guid? AudienceId { get; set; } // when persisted\n        public List<MaterializedRowDto> Preview { get; set; } = new();\n        public List<string> Warnings { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignPreviewDto.cs",
      "sha256": "ebe80e7f7af1dd5e800a15177ed1305cff9c9b04a8a9b5c000a8afc3de02d1c5",
      "language": "csharp",
      "size": 1547,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignPreviewRequestDto\n    {\n        // Optional: preview using a specific recipient‚Äôs contact info\n        public Guid? ContactId { get; set; }\n    }\n\n    public class CampaignPreviewResponseDto\n    {\n        public Guid CampaignId { get; set; }\n        public string TemplateName { get; set; } = \"\";\n        public string Language { get; set; } = \"en_US\";\n        public int PlaceholderCount { get; set; }\n\n        public string BodyPreview { get; set; } = \"\";\n        public List<string> MissingParams { get; set; } = new();  // e.g. [\"{{2}} required but not supplied\"]\n\n        public bool HasHeaderMedia { get; set; }\n        public string? HeaderType { get; set; } // IMAGE/VIDEO/DOCUMENT (if you later persist)\n\n        public List<ButtonPreviewDto> Buttons { get; set; } = new();\n    }\n\n    public class ButtonPreviewDto\n    {\n        public int Index { get; set; }            // 0..2\n        public string Text { get; set; } = \"\";\n        public string Type { get; set; } = \"URL\"; // Meta types\n        public bool IsDynamic { get; set; }       // needs parameter\n        public string? TemplateParamBase { get; set; } // e.g. \"/r/{{1}}\"\n        public string? CampaignValue { get; set; } // what user set in campaign (for dynamic)\n        public string? TokenParam { get; set; }    // what we‚Äôd send when base has {{1}}\n        public string? FinalUrlPreview { get; set; } // full tracked URL preview\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignRecipientDto.cs",
      "sha256": "028557690cc0247c25a5db36100a674f3a36f1d96ac0eba571a51fd3aa57febe",
      "language": "csharp",
      "size": 756,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignRecipientDto\n    {\n        public Guid Id { get; set; }\n\n        public Guid? ContactId { get; set; }\n        public string ContactName { get; set; }\n        public string ContactPhone { get; set; }\n\n        public string Status { get; set; }\n        public DateTime? SentAt { get; set; }\n\n        // üîÅ Advanced Fields (for analytics & future automation)\n        public string? BotId { get; set; }\n        public string? MessagePreview { get; set; }\n        public string? ClickedCTA { get; set; }\n        public string? CategoryBrowsed { get; set; }\n        public string? ProductBrowsed { get; set; }\n        public bool IsAutoTagged { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignRetryDtos.cs",
      "sha256": "f6d2dd143ecf14f40ec9b5d30aad7ad83309e99f5aab199c117f31dce552d68f",
      "language": "csharp",
      "size": 539,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignRetryResultDto\n    {\n        public Guid CampaignId { get; set; }\n        public int ConsideredFailed { get; set; }\n        public int Retried { get; set; }\n        public int Skipped { get; set; }  // e.g., duplicates, already succeeded, or filtered out\n        public List<Guid> RecipientIdsSample { get; set; } = new(); // up to 20 IDs for quick inspection\n        public string? Note { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignSummaryDto.cs",
      "sha256": "e34665bb059ebf40c11f0bc8ab502fdbf8ed27b2139b2fcd6c48b33b07ac4bac",
      "language": "csharp",
      "size": 965,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignSummaryDto\n    {\n        public Guid Id { get; set; }\n        public string? Name { get; set; }\n        public string? Status { get; set; }\n        public DateTime? ScheduledAt { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public int Delivered { get; set; }\n        public int Read { get; set; }\n\n        public string? ImageUrl { get; set; } // ‚úÖ Add this\n        public string? ImageCaption { get; set; } // ‚úÖ Add this\n        public string? CtaTitle { get; set; } // Optional: For CTA info\n        public int RecipientCount { get; set; } // Optional: To show 0/10 etc\n\n        public DateTime? SentAt { get; set; } // ‚úÖ Added to track sent time\n\n        // ‚úÖ Added for Preview\n        public string? MessageTemplate { get; set; } \n        public List<CampaignButtonDto>? MultiButtons { get; set; }\n    }\n        \n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignUsageDto.cs",
      "sha256": "11bbb343956c5c20a328cdab6846d82227497a5e8fbef864b3e3f71ddd503a0e",
      "language": "csharp",
      "size": 780,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CampaignUsageDto\n    {\n        public Guid CampaignId { get; set; }\n        public string? Name { get; set; }\n        public string Status { get; set; } = \"DRAFT\"; // DRAFT/SCHEDULED/QUEUED/SENDING/SENT/...\n        public int Recipients { get; set; }\n        public int QueuedJobs { get; set; }\n        public int SendLogs { get; set; }\n\n        // Flow linkage (for parity with CTA Flow deletion UX)\n        public bool HasFlow { get; set; }\n        public Guid? FlowId { get; set; }\n\n        // Useful timestamps for UX copy\n        public DateTime? CreatedAt { get; set; }\n        public DateTime? ScheduledAt { get; set; }\n        public DateTime? FirstSentAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CampaignVariableMapDto.cs",
      "sha256": "09ea689514db078a870217be4fac18f0168d401c0cc23df1d1e9a96099feaa5e",
      "language": "csharp",
      "size": 936,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CampaignVariableMapDto\n    {\n        public Guid CampaignId { get; set; }\n        public List<CampaignVariableMapItemDto> Items { get; set; } = new();\n    }\n\n    public class CampaignVariableMapItemDto\n    {\n        // Matches your normalized model fields\n        public string Component { get; set; } = \"\";   // \"body\", \"header\", \"button:url:1\"\n        public int Index { get; set; }                // 1..N\n\n        public string SourceType { get; set; } = \"Static\"; // ContactField | CsvColumn | Static | Expression\n        public string? SourceKey { get; set; }             // \"name\" / CSV header, etc.\n        public string? StaticValue { get; set; }\n        public string? Expression { get; set; }\n        public string? DefaultValue { get; set; }\n        public bool IsRequired { get; set; } = false;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CsvBatchListItemDto.cs",
      "sha256": "a3ecc66b83ee911be585b7fc50285b27717bedb0f0d6a709ee1532a5116f338a",
      "language": "csharp",
      "size": 501,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    /// <summary>\n    /// Lightweight projection for listing recent CSV batches.\n    /// </summary>\n    public sealed class CsvBatchListItemDto\n    {\n        public Guid BatchId { get; set; }\n        public string? FileName { get; set; }\n        public int RowCount { get; set; }\n        public string Status { get; set; } = \"ready\"; // ready | ingesting | failed | complete\n        public DateTime CreatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CsvBatchRowsPageDto.cs",
      "sha256": "f884ce43dea32e9316e6d9c44036d937745a81ce2f82ea1da5625cdcd446f6a9",
      "language": "csharp",
      "size": 481,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    /// <summary>\n    /// Paged slice of CSV rows for previewing a batch.\n    /// </summary>\n    public sealed class CsvBatchRowsPageDto\n    {\n        public Guid BatchId { get; set; }\n        public int TotalRows { get; set; }\n        public int Skip { get; set; }\n        public int Take { get; set; }\n        public List<CsvRowSampleDto> Rows { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/CsvBatchValidationDtos.cs",
      "sha256": "ad1652fd6b89c2d226dd44e051a9b9c5311e7db7d377de150c8dafcd4e454bd2",
      "language": "csharp",
      "size": 1541,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CsvBatchValidationRequestDto\n    {\n        /// <summary>Explicit phone column to use; if null we'll try to auto-detect.</summary>\n        public string? PhoneField { get; set; }\n\n        /// <summary>Normalize phones (strip punctuation/leading zeros; add 91 for 10-digit local).</summary>\n        public bool NormalizePhones { get; set; } = true;\n\n        /// <summary>Report duplicates after normalization.</summary>\n        public bool Deduplicate { get; set; } = true;\n\n        /// <summary>Headers that must exist in the CSV.</summary>\n        public List<string>? RequiredHeaders { get; set; }\n\n        /// <summary>How many problematic rows to include in the response samples.</summary>\n        public int SampleSize { get; set; } = 20;\n    }\n\n    public sealed class CsvBatchValidationResultDto\n    {\n        public Guid BatchId { get; set; }\n        public int TotalRows { get; set; }\n\n        public string? PhoneField { get; set; }\n\n        public int MissingPhoneCount { get; set; }\n        public int DuplicatePhoneCount { get; set; }\n\n        public List<string> MissingRequiredHeaders { get; set; } = new();\n        public List<string> Warnings { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n\n        /// <summary>Sample of problematic rows (missing phone / dup / other).</summary>\n        public List<CsvRowSampleDto> ProblemSamples { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/FlowListItemDto.cs",
      "sha256": "3121c1e145f2d4fd8f1f4978f314782f0afa5d7be9ffe7be6709cfc04af7d068",
      "language": "csharp",
      "size": 246,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class FlowListItemDto\n    {\n        public Guid Id { get; set; }\n        public string FlowName { get; set; } = string.Empty;\n        public bool IsPublished { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/OutboundCampaignJobCreateDto.cs",
      "sha256": "31ade95e7e39a78f5fd669bc7ce9d887c7c004acd05e3e44eb0a6e487b837bd4",
      "language": "csharp",
      "size": 613,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Queueing.DTOs\n{\n    /// <summary>\n    /// Minimal job creation payload for outbound campaign sends.\n    /// The worker will hydrate the template parameters from CampaignRecipient.\n    /// </summary>\n    public sealed class OutboundCampaignJobCreateDto\n    {\n        public Guid BusinessId { get; set; }\n        public Guid CampaignId { get; set; }\n        public Guid CampaignRecipientId { get; set; }\n\n        /// <summary>Deduplication key. The queue should drop duplicates with the same key.</summary>\n        public string? IdempotencyKey { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/OutboundCampaignJobDto.cs",
      "sha256": "3f95f27a03d9cf5a08d649a168cd9cf34b1e790c060f74411eb1cc8dd981f190",
      "language": "csharp",
      "size": 649,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class OutboundCampaignJobDto\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid CampaignId { get; set; }\n\n        public string Status { get; set; } = \"queued\"; // queued | running | succeeded | failed | canceled\n        public int Attempt { get; set; }\n        public int MaxAttempts { get; set; }\n\n        public DateTimeOffset? NextAttemptAt { get; set; }\n        public string? LastError { get; set; }\n\n        public DateTime CreatedAt { get; set; }\n        public DateTime UpdatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/Requests/CsvBatchUploadForm.cs",
      "sha256": "8d7abcaa0b234c79afe0fecb5e15221a682d1424f268caea86cd71181f14ceee",
      "language": "csharp",
      "size": 432,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing Microsoft.AspNetCore.Http;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs.Requests\n{\n    // Swagger-safe wrapper for multipart upload\n    public sealed class CsvBatchUploadForm\n    {\n        public Guid? AudienceId { get; set; }\n\n        [Required]\n        public IFormFile File { get; set; } = default!;\n\n        public Guid? CampaignId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/RescheduleDto.cs",
      "sha256": "ed9069221c8458a5aa8001cefe2e490c5739b33cf503b8b516e49013407283a9",
      "language": "csharp",
      "size": 180,
      "content": "namespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class RescheduleDto\n    {\n        // must be UTC!\n        public DateTime NewUtcTime { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/RetargetCampaignRequestDto.cs",
      "sha256": "a3cc90536fd410b01c28bcab18d4c013e46218640bf42f4bb314efb7a8e18385",
      "language": "csharp",
      "size": 1295,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    /// <summary>\n    /// Retarget creates a NORMAL campaign in DB but skips audience assignment.\n    /// The selected recipients come explicitly from analytics selection.\n    /// </summary>\n    public class RetargetCampaignRequestDto\n    {\n        // Source context (optional but useful for audit + future UI)\n        public Guid SourceCampaignId { get; set; }\n        public Guid? SourceRunId { get; set; }\n        public string? SourceBucket { get; set; } // clicked | replied | failed | etc.\n\n        // The \"new campaign details\" user fills in retarget wizard\n        public string? Name { get; set; }\n        public CampaignCreateDto Campaign { get; set; } = new();\n\n        // Explicit selection\n        public List<Guid> ContactIds { get; set; } = new();      // preferred\n        public List<string> RecipientPhones { get; set; } = new(); // fallback for rows without ContactId\n\n        // Optional: safety\n        public bool Deduplicate { get; set; } = true;\n    }\n\n    public class RetargetCampaignResponseDto\n    {\n        public Guid NewCampaignId { get; set; }\n        public int MaterializedRecipients { get; set; }\n        public int SkippedDuplicates { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/SendJobDtos.cs",
      "sha256": "6e46d4af7214847bbbb20aad58770f26f7885d22c06b9fd7934ba21449e5e25f",
      "language": "csharp",
      "size": 1907,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public enum SendJobState\n    {\n        Pending = 0,\n        Running = 1,\n        Succeeded = 2,\n        Failed = 3,\n        Canceled = 4,\n        Partial = 5\n    }\n\n    public class SendJobStartRequestDto\n    {\n        public bool Force { get; set; } = false;     // allow send even if dry-run has errors (logged loudly)\n        public int Limit { get; set; } = 2000;       // cap on planned recipients\n    }\n\n    public class SendJobStartResponseDto\n    {\n        public Guid JobId { get; set; }\n        public Guid CampaignId { get; set; }\n        public string Message { get; set; } = \"Send job queued.\";\n    }\n\n    public class SendJobBatchResultDto\n    {\n        public int BatchNumber { get; set; }\n        public int Count { get; set; }\n        public int Success { get; set; }\n        public int Failed { get; set; }\n        public int Skipped { get; set; }\n        public string Notes { get; set; } = string.Empty;\n        public int OffsetSeconds { get; set; }\n    }\n\n    public class SendJobStatusDto\n    {\n        public Guid JobId { get; set; }\n        public Guid CampaignId { get; set; }\n        public SendJobState State { get; set; }\n        public DateTimeOffset CreatedAt { get; set; }\n        public DateTimeOffset? StartedAt { get; set; }\n        public DateTimeOffset? CompletedAt { get; set; }\n\n        public int PlannedBatches { get; set; }\n        public int CompletedBatches { get; set; }\n\n        public int PlannedRecipients { get; set; }\n        public int SentSuccess { get; set; }\n        public int SentFailed { get; set; }\n        public int Skipped { get; set; }\n\n        public List<SendJobBatchResultDto> Batches { get; set; } = new();\n        public List<string> Warnings { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/DTOs/VideoTemplateMessageDto.cs",
      "sha256": "d46c45dcc1d7b4109a51ea465c89038fe205538ef0d02d55804421de868b6bbb",
      "language": "csharp",
      "size": 631,
      "content": "// Features/CampaignModule/DTOs/VideoTemplateMessageDto.cs\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class VideoTemplateMessageDto\n    {\n        public string RecipientNumber { get; set; } = \"\";\n        public string TemplateName { get; set; } = \"\";\n        public string LanguageCode { get; set; } = \"en_US\";\n\n        // URL for the video header (HTTPS)\n        public string? HeaderVideoUrl { get; set; }\n\n        public List<string> TemplateParameters { get; set; } = new();\n        public List<CampaignButtonDto> ButtonParameters { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Helpers/IVariableResolver.cs",
      "sha256": "f956c04fe5689e3e6613e4d68e1e7dd8ead05b4dd82944fddaffbda5fce24ede",
      "language": "csharp",
      "size": 316,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.Helpers\n{\n    public interface IVariableResolver\n    {\n        Dictionary<string, string> ResolveVariables(\n            IReadOnlyDictionary<string, string> rowData,\n            IReadOnlyDictionary<string, string>? mappings);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Helpers/VariableResolver.cs",
      "sha256": "c197b1ec2533e625ecf3dfcaf4b0b493fee799da4bfc5e3daff06f171cc46716",
      "language": "csharp",
      "size": 3323,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.CampaignModule.Helpers\n{\n    public sealed class VariableResolver : IVariableResolver\n    {\n        // Back-compat: legacy CSV columns -> canonical keys\n        //   headerpara1     => header.text_param1\n        //   buttonpara2     => button2.url_param\n        private static readonly Regex RxHeaderPara = new(@\"^headerpara(\\d+)$\",\n            RegexOptions.IgnoreCase | RegexOptions.Compiled);\n        private static readonly Regex RxButtonPara = new(@\"^buttonpara(\\d+)$\",\n            RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n        private static string CanonicalizeKey(string key)\n        {\n            if (string.IsNullOrWhiteSpace(key)) return string.Empty;\n            key = key.Trim();\n\n            var m1 = RxHeaderPara.Match(key);\n            if (m1.Success) return $\"header.text_param{m1.Groups[1].Value}\";\n\n            var m2 = RxButtonPara.Match(key);\n            if (m2.Success) return $\"button{m2.Groups[1].Value}.url_param\";\n\n            // Already canonical (parameterN, header.text_paramN, buttonX.url_param, or named body tokens)\n            return key;\n        }\n\n        public Dictionary<string, string> ResolveVariables(\n            IReadOnlyDictionary<string, string> rowData,\n            IReadOnlyDictionary<string, string>? mappings)\n        {\n            var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            // Fast path: no explicit mappings ‚Äî just canonicalize incoming CSV keys\n            if (mappings == null || mappings.Count == 0)\n            {\n                foreach (var kv in rowData)\n                {\n                    var canon = CanonicalizeKey(kv.Key);\n                    result[canon] = kv.Value?.Trim() ?? string.Empty;\n                }\n                return result;\n            }\n\n            // With explicit mappings: support constants and canonicalize source columns\n            foreach (var (token, srcRaw) in mappings)\n            {\n                if (string.IsNullOrWhiteSpace(token)) continue;\n\n                // Back-compat: allow mapping keys like \"headerpara1\"/\"buttonpara1\" and canonicalize them.\n                var canonToken = CanonicalizeKey(token);\n\n                var src = (srcRaw ?? string.Empty).Trim();\n\n                // Allow \"constant:VALUE\" mapping\n                if (src.StartsWith(\"constant:\", StringComparison.OrdinalIgnoreCase))\n                {\n                    result[canonToken] = src.Substring(\"constant:\".Length).Trim();\n                    continue;\n                }\n\n                // Canonicalize the source column name (handles legacy headerpara*/buttonpara*)\n                var canonSrc = CanonicalizeKey(src);\n\n                if (rowData.TryGetValue(canonSrc, out var vCanon) && vCanon != null)\n                {\n                    result[canonToken] = vCanon.Trim();\n                }\n                else if (rowData.TryGetValue(src, out var vRaw) && vRaw != null) // final fallback\n                {\n                    result[canonToken] = vRaw.Trim();\n                }\n                else\n                {\n                    result[canonToken] = string.Empty;\n                }\n            }\n\n            return result;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/Audience.cs",
      "sha256": "2db4c6eff72fe7fba7aa3c4f1ccd8fd9dc575292048d4d6fd27664c7a7ac0a94",
      "language": "csharp",
      "size": 1191,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    /// <summary>\n    /// Logical grouping of recipients (often tied to a CsvBatch).\n    /// A campaign can materialize recipients from one Audience.\n    /// </summary>\n    public class Audience\n    {\n        [Key] public Guid Id { get; set; }\n\n        [Required] public Guid BusinessId { get; set; }\n\n        [Required, MaxLength(160)]\n        public string Name { get; set; } = \"Untitled Audience\";\n\n        [MaxLength(512)]\n        public string? Description { get; set; }  // useful in UI\n               \n        //public Guid? CampaignId { get; set; }\n        //public Campaign? Campaign { get; set; }\n\n        public Guid? CsvBatchId { get; set; }\n        public CsvBatch? CsvBatch { get; set; }\n\n        public bool IsDeleted { get; set; } = false;\n\n        public Guid? CreatedByUserId { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public DateTime? UpdatedAt { get; set; }   // audit\n\n        public ICollection<AudienceMember> Members { get; set; } = new List<AudienceMember>();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/AudienceMember.cs",
      "sha256": "9d7b99694c279cd7bd36310ea787ed4c4ee781e20167060799d281170358f6da",
      "language": "csharp",
      "size": 1615,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    /// <summary>\n    /// A single member of an Audience. May or may not be linked to a Contact.\n    /// </summary>\n    public class AudienceMember\n    {\n        [Key] public Guid Id { get; set; }\n\n        [Required] public Guid AudienceId { get; set; }\n        public Audience Audience { get; set; } = null!;\n\n        // üÜï explicit tenant for fast filtering & safety\n        [Required] public Guid BusinessId { get; set; }\n\n        /// <summary>Optional CRM link; null for non-CRM rows until promotion</summary>\n        public Guid? ContactId { get; set; }\n\n        [MaxLength(64)]\n        public string? PhoneRaw { get; set; }\n\n        [MaxLength(32)]\n        public string? PhoneE164 { get; set; }\n\n        [MaxLength(160)]\n        public string? Name { get; set; }\n\n        [MaxLength(256)]\n        public string? Email { get; set; }   // üÜï\n\n        /// <summary>Additional attributes from CSV row (json)</summary>\n        public string? AttributesJson { get; set; } // keep name as-is\n\n        /// <summary>True if an ‚Äúauto-created‚Äù CRM contact; subject to retention</summary>\n        public bool IsTransientContact { get; set; } = false;\n\n        public bool IsDeleted { get; set; } = false;  // üÜï\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime? UpdatedAt { get; set; }      // üÜï\n        public DateTime? PromotedAt { get; set; }     // when transient ‚Üí durable Contact\n        public Guid? CreatedByUserId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/Campaign.cs",
      "sha256": "023b91ed702fd11df1e6e408206c12bff9e0eccb212a7413c495303cfc69077a",
      "language": "csharp",
      "size": 3453,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CTAManagement.Models;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.CTAFlowBuilder.Models; // üÜï Import for CTAFlowConfig\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class Campaign\n    {\n        public Guid Id { get; set; }\n\n        // üîó Business info\n        public Guid BusinessId { get; set; }\n        public Business Business { get; set; }\n        public Guid? CampaignId { get; set; }\n        public Campaign? SourceCampaign { get; set; }\n\n        // üìã Core campaign details\n        public string Name { get; set; }\n        public string MessageTemplate { get; set; }\n        public string? TemplateId { get; set; } // ‚úÖ Meta-approved template ID\n\n        [Column(TypeName = \"text\")]\n        public string? MessageBody { get; set; } // ‚úÖ Final resolved WhatsApp message body\n\n        public string? FollowUpTemplateId { get; set; }\n        public string? CampaignType { get; set; } // text, template, cta\n\n        // üîò CTA tracking (optional)\n        public Guid? CtaId { get; set; }\n        public CTADefinition? Cta { get; set; }\n\n        // üÜï Link to Flow Config (optional)\n        public Guid? CTAFlowConfigId { get; set; }\n       // [ForeignKey(nameof(CTAFlowConfigId))]\n        public CTAFlowConfig? CTAFlowConfig { get; set; }\n\n        public DateTime? ScheduledAt { get; set; }\n        public string Status { get; set; } = \"Draft\"; // Draft, Scheduled, Sent\n\n        // üë§ Metadata\n        public string? CreatedBy { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n\n        // üóëÔ∏è Soft delete support\n        public bool IsDeleted { get; set; } = false;\n        public DateTime? DeletedAt { get; set; }\n        public string? DeletedBy { get; set; }\n\n        // üë• Recipient relationship\n        public ICollection<CampaignRecipient> Recipients { get; set; }\n\n        // üìä Logs\n        public ICollection<CampaignSendLog> SendLogs { get; set; } = new List<CampaignSendLog>();\n        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n\n        public string? ImageUrl { get; set; }\n        public string? ImageCaption { get; set; }\n        public string? TemplateParameters { get; set; }\n\n        public ICollection<CampaignButton> MultiButtons { get; set; } = new List<CampaignButton>();\n\n        public ICollection<MessageLog> MessageLogs { get; set; } = new List<MessageLog>();\n\n        public string? Provider { get; set; }            // UPPERCASE only\n        public string? PhoneNumberId { get; set; }\n\n        public string? TemplateSchemaSnapshot { get; set; }\n\n        public ICollection<CampaignVariableMap> VariableMaps { get; set; } = new List<CampaignVariableMap>();\n\n        //public Guid? AudienceId { get; set; }\n        //public ICollection<Audience> Audiences { get; set; } = new List<Audience>();\n\n        public string? VideoUrl { get; set; }\n        public string? DocumentUrl { get; set; }\n\n        public ICollection<CampaignAudienceAttachment> AudienceAttachments { get; set; }\n    = new List<CampaignAudienceAttachment>();\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignAudienceAttachment.cs",
      "sha256": "d9336b2a36b378b21fb508769a89d241bf9d13b715ab58ed4b3728959d269b64",
      "language": "csharp",
      "size": 1070,
      "content": "// üìÑ Features/CampaignModule/Models/CampaignAudienceAttachment.cs\nusing System;\nusing xbytechat.api.Features.BusinessModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignAudienceAttachment\n    {\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n        public Business Business { get; set; } = default!;\n\n        public Guid CampaignId { get; set; }\n        public Campaign Campaign { get; set; } = default!;\n\n        public Guid AudienceId { get; set; }\n        public Audience Audience { get; set; } = default!;\n\n        public Guid CsvBatchId { get; set; }\n        public CsvBatch CsvBatch { get; set; } = default!;\n\n        // ‚úÖ \"only one active attachment per campaign\"\n        public bool IsActive { get; set; } = true;\n\n        public string? FileName { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        // When replaced/disabled\n        public DateTime? DeactivatedAt { get; set; }\n        public string? DeactivatedBy { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignButton.cs",
      "sha256": "bfca22e0aed3117f3be8b3712de4a7b229991bc3c4b02bdb1f17e43709991977",
      "language": "csharp",
      "size": 654,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignButton\n    {\n        public Guid Id { get; set; }\n\n        public Guid CampaignId { get; set; } // üîó Foreign key\n        public Campaign Campaign { get; set; }\n\n        public string Title { get; set; } = string.Empty; // Button Text (e.g. Buy Now)\n        public string Type { get; set; } = \"url\"; // Type: url, quick_reply, call, etc.\n        public string Value { get; set; } = string.Empty; // Target URL or payload\n\n        public int Position { get; set; } // Button order (1‚Äì3)\n        public bool IsFromTemplate { get; set; } = false;\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignFlowOverride.cs",
      "sha256": "c4ee719e7601cfb0eb6d67fbba7e11cbd4a57ad5be58dd84f72beead08d88370",
      "language": "csharp",
      "size": 798,
      "content": "using System.ComponentModel.DataAnnotations.Schema;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignFlowOverride\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid CampaignId { get; set; }\n\n        [Required]\n        [MaxLength(100)]\n        public string TemplateName { get; set; } = string.Empty;\n\n        [Required]\n        [MaxLength(50)]\n        public string ButtonText { get; set; } = string.Empty;\n\n        public string? OverrideNextTemplate { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public string? CreatedBy { get; set; }\n\n        [ForeignKey(\"CampaignId\")]\n        public Campaign? Campaign { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignRecipient.cs",
      "sha256": "ec0f719107e1e7ac5928e10245041ca32f9b14701d84deee6381b449edae8e05",
      "language": "csharp",
      "size": 1790,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class CampaignRecipient\n    {\n        public Guid Id { get; set; }\n\n        public Guid CampaignId { get; set; }\n        public Campaign? Campaign { get; set; }   // nav is optional at runtime\n\n        public Guid? ContactId { get; set; }      // ‚Üê optional FK\n        public Contact? Contact { get; set; }\n\n        public string Status { get; set; } = \"Pending\"; // Pending, Sent, Delivered, Failed, Replied\n        public DateTime? SentAt { get; set; }\n\n        public string? BotId { get; set; }\n        public string? MessagePreview { get; set; }\n        public string? ClickedCTA { get; set; }\n        public string? CategoryBrowsed { get; set; }\n        public string? ProductBrowsed { get; set; }\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n\n        public bool IsAutoTagged { get; set; } = false;\n\n        // Logs\n        public ICollection<CampaignSendLog> SendLogs { get; set; } = new List<CampaignSendLog>();\n\n        public Guid BusinessId { get; set; }\n        public Business? Business { get; set; }\n\n        public Guid? AudienceMemberId { get; set; }\n        public AudienceMember? AudienceMember { get; set; } = null!;\n\n        [Column(TypeName = \"jsonb\")]\n        public string? ResolvedParametersJson { get; set; }\n\n        [Column(TypeName = \"jsonb\")]\n        public string? ResolvedButtonUrlsJson { get; set; }\n\n        public string? IdempotencyKey { get; set; }\n        public DateTime? MaterializedAt { get; set; }\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CampaignVariableMap.cs",
      "sha256": "c20c9a369db1d26855d7c1f75e480de9e892b21cc63635b31220904e75f0194b",
      "language": "csharp",
      "size": 2019,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    /// <summary>\n    /// Maps a template placeholder to a data source for a specific campaign.\n    /// Examples of Component:\n    ///   \"body\", \"header\", \"button:url:1\"\n    /// Index is 1-based ({{1}}, {{2}}, ...).\n    /// </summary>\n    public class CampaignVariableMap\n    {\n        [Key] public Guid Id { get; set; }\n\n        [Required] public Guid CampaignId { get; set; }\n        public Campaign Campaign { get; set; } = null!;\n\n        /// <summary> \"body\" | \"header\" | \"button:url:1\" </summary>\n        [Required, MaxLength(64)]\n        public string Component { get; set; } = null!;\n\n        /// <summary> 1..N (corresponds to {{index}}) </summary>\n        [Required]\n        public int Index { get; set; }\n\n        /// <summary>\n        /// ContactField | CsvColumn | Static | Expression\n        /// </summary>\n        [Required, MaxLength(32)]\n        public string SourceType { get; set; } = null!;\n\n        /// <summary>\n        /// If SourceType == ContactField ‚Üí \"name\",\"phone\",\"email\",...\n        /// If SourceType == CsvColumn ‚Üí CSV header name.\n        /// Otherwise null.\n        /// </summary>\n        [MaxLength(128)]\n        public string? SourceKey { get; set; }\n\n        /// <summary>Used when SourceType == Static</summary>\n        public string? StaticValue { get; set; }\n\n        /// <summary>Optional expression (mini DSL) for computed values</summary>\n        public string? Expression { get; set; }\n\n        /// <summary>Fallback when source is empty/invalid</summary>\n        public string? DefaultValue { get; set; }\n\n        /// <summary>If true, missing value = validation error in dry-run</summary>\n        public bool IsRequired { get; set; } = false;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public Guid? CreatedByUserId { get; set; }\n        public Guid BusinessId { get; set; }  // denormalized for ownership checks\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CsvBatch.cs",
      "sha256": "9ab2036813c02e1428373fb89419b490fe5c4f4a0279eb40c5c2e5b8d87398cd",
      "language": "csharp",
      "size": 1513,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    /// <summary>\n    /// Represents a single CSV upload (file) for a business.\n    /// Stores headers and basic metadata; rows live in CsvRow.\n    /// </summary>\n    public class CsvBatch\n    {\n        [Key] public Guid Id { get; set; }\n\n        [Required] public Guid BusinessId { get; set; }\n\n        public Guid? AudienceId { get; set; }\n        /// <summary>Original filename, if available</summary>\n        [MaxLength(256)]\n        public string? FileName { get; set; }\n\n      \n        /// <summary>Comma-separated or JSON array of headers (we‚Äôll map to jsonb via DbContext)</summary>\n        public string? HeadersJson { get; set; }\n\n        /// <summary>SHA256 (or similar) of file contents for dedupe</summary>\n        [MaxLength(128)]\n        public string? Checksum { get; set; }\n\n        /// <summary>Total rows parsed (including headerless lines after validation)</summary>\n        public int RowCount { get; set; }\n\n        /// <summary>Total rows skipped due to validation</summary>\n        public int SkippedCount { get; set; }\n\n        [MaxLength(32)]\n        public string Status { get; set; } = \"ready\"; // ready | ingesting | failed | complete\n\n        public string? ErrorMessage { get; set; }\n\n        public Guid? CreatedByUserId { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CsvBatchDtos.cs",
      "sha256": "8a302f82fd2cec1db09b6ef343902b803d507900620ea83b8e551b3e59d620c3",
      "language": "csharp",
      "size": 1008,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public class CsvBatchUploadResultDto\n    {\n        public Guid BatchId { get; set; }\n        public Guid? AudienceId { get; set; }           // <-- nullable: matches CsvBatch.AudienceId (Guid?)\n        public int RowCount { get; set; }\n        public List<string> Headers { get; set; } = new();\n        public string Message { get; set; } = \"CSV batch created.\";\n        public string FileName { get; set; } = string.Empty;\n    }\n\n    public class CsvBatchInfoDto\n    {\n        public Guid BatchId { get; set; }\n        public Guid? AudienceId { get; set; }           // <-- nullable\n        public int RowCount { get; set; }\n        public List<string> Headers { get; set; } = new();\n        public DateTime CreatedAt { get; set; }\n    }\n\n    public class CsvRowSampleDto\n    {\n        public int RowIndex { get; set; }\n        public Dictionary<string, string?> Data { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/CsvRow.cs",
      "sha256": "26dc0e4b4ef801544a8e3935a243f3cb34507713dc1561f9cf08cd7895b316ba",
      "language": "csharp",
      "size": 1816,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    /// <summary>\n    /// One parsed CSV row. Data stored as JSON (key = header, value = cell).\n    /// RowIndex is 0-based (first data row = 0) to match streaming ingest.\n    /// </summary>\n    public class CsvRow\n    {\n        [Key] public Guid Id { get; set; }\n\n        /// <summary>Tenant scoping for fast filters</summary>\n        [Required] public Guid BusinessId { get; set; }\n\n        /// <summary>FK to CsvBatch.Id</summary>\n        [Required] public Guid BatchId { get; set; }\n        public CsvBatch Batch { get; set; } = null!;\n\n        /// <summary>0-based row number within the batch</summary>\n        [Required]\n        public int RowIndex { get; set; }\n\n        /// <summary>Raw phone, exactly as uploaded (optional convenience)</summary>\n        [MaxLength(64)]\n        public string? PhoneRaw { get; set; }\n\n        /// <summary>Normalized phone in E.164 (+&lt;country&gt;&lt;number&gt;)</summary>\n        [MaxLength(32)]\n        public string? PhoneE164 { get; set; }\n\n        /// <summary>JSON of the row: {\"header\":\"value\", ...}</summary>\n        public string RowJson { get; set; } = \"{}\";\n\n        /// <summary>\n        /// Back-compat shim for code that uses DataJson.\n        /// Not mapped to its own column; simply forwards to RowJson.\n        /// </summary>\n        [NotMapped]\n        public string? DataJson\n        {\n            get => RowJson;\n            set => RowJson = value ?? \"{}\";\n        }\n\n        /// <summary>If invalid at ingest/validation time, store reason here</summary>\n        public string? ValidationError { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/OutboundCampaignJob.cs",
      "sha256": "d9575f6ce2eee26b028d3f7d233b75faafc1be91456fee92b9d19a78ff0bf0e2",
      "language": "csharp",
      "size": 1507,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    /// <summary>\n    /// Queue item to send a whole campaign. Worker will call CampaignService to send.\n    /// </summary>\n    public class OutboundCampaignJob\n    {\n        [Key]\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        [Required]\n        public Guid CampaignId { get; set; }\n\n        /// <summary>\n        /// queued | running | succeeded | failed\n        /// </summary>\n        [MaxLength(32)]\n        public string Status { get; set; } = \"queued\";\n\n        /// <summary>\n        /// Number of send attempts performed.\n        /// </summary>\n        public int Attempt { get; set; } = 0;\n\n        /// <summary>\n        /// Max attempts before we mark failed.\n        /// </summary>\n        public int MaxAttempts { get; set; } = 5;\n\n        /// <summary>\n        /// When this job becomes eligible for pickup (for backoff).\n        /// </summary>\n        public DateTimeOffset NextAttemptAt { get; set; } = DateTimeOffset.UtcNow;\n\n        /// <summary>\n        /// Last error string (truncated in service).\n        /// </summary>\n        [MaxLength(4000)]\n        public string? LastError { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Models/OutboundMessageJob.cs",
      "sha256": "a8fe42226a8e2a6e41dabd53f702ac9b75008309273bbd045a60088c9884ffbc",
      "language": "csharp",
      "size": 1725,
      "content": "using System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignModule.Models\n{\n    public class OutboundMessageJob\n    {\n        [Key] public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n        public Guid CampaignId { get; set; }\n        public Guid RecipientId { get; set; }\n\n        // Exactly what to send\n        public string Provider { get; set; } = string.Empty;          // DB value as-is\n        public string MediaType { get; set; } = \"text\";               // text|image|video|document\n        public string TemplateName { get; set; } = string.Empty;\n        public string LanguageCode { get; set; } \n        public string? PhoneNumberId { get; set; }                    // for Meta\n\n        // Pre-resolved components/materialization (avoid recomputation in worker)\n        public string ResolvedParamsJson { get; set; } = \"[]\";\n        public string ResolvedButtonUrlsJson { get; set; } = \"[]\";\n        public string? HeaderMediaUrl { get; set; }                   // image/video/document\n        public string? MessageBody { get; set; }                      // optional\n\n        // For idempotency (dedupe retries & restarts)\n        public string IdempotencyKey { get; set; } = string.Empty;\n\n        // Job lifecycle\n        public string Status { get; set; } = \"Pending\";               // Pending|InFlight|Sent|Failed|Dead\n        public int Attempt { get; set; } = 0;\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime? NextAttemptAt { get; set; }                  // backoff\n        public string? LastError { get; set; }                        // truncated\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Outbox/Channels.cs",
      "sha256": "ca54067f17dccbd7e50c182b8e84054c91fa3d13197de3544cb9d5b44eef8466",
      "language": "csharp",
      "size": 504,
      "content": "using System.Threading.Channels;\n\nnamespace XByteChat.api.Features.CampaignModule.Outbox;\n\npublic static class OutboxChannels\n{\n    public static readonly Channel<OutboundItem> SendChannel =\n        Channel.CreateBounded<OutboundItem>(new BoundedChannelOptions(10_000) { FullMode = BoundedChannelFullMode.Wait });\n\n    public static readonly Channel<MessageLog> LogChannel =\n        Channel.CreateBounded<MessageLog>(new BoundedChannelOptions(20_000) { FullMode = BoundedChannelFullMode.DropOldest });\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Outbox/OutboundModels.cs",
      "sha256": "ebd6f8966131b21aef8fe72d64a9b8844dbc9bc654f92d1658be6e28821dbe53",
      "language": "csharp",
      "size": 436,
      "content": "using xbytechat.api.Features.CampaignModule.SendEngine;\n\nnamespace XByteChat.api.Features.CampaignModule.Outbox;\n\npublic sealed record OutboundItem(\n    Guid CampaignId, Guid BusinessId, Provider Provider, string PhoneNumberId,\n    string TemplateName, string LanguageCode, HeaderKind HeaderKind, string? HeaderUrl,\n    string ParametersJson, string? ButtonParamsJson,\n    string ToPhoneE164, Guid RecipientId, string IdempotencyKey\n);\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Progress/Controllers/CampaignProgressController.cs",
      "sha256": "b5ef8455bfeb8afa07748d4719eaba8aa79f974bfa565bab83ef6236604c0e24",
      "language": "csharp",
      "size": 13851,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\n\nnamespace xbytechat.api.Features.CampaignModule.Progress.Controllers\n{\n    // NOTE: route is plural to match your frontend: /api/campaigns/{id}/progress\n    [ApiController]\n    [Route(\"api/campaigns\")]\n    public class CampaignsProgressController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n\n        public CampaignsProgressController(AppDbContext db) => _db = db;\n\n        [HttpGet(\"{id:guid}/progress\")]\n        public async Task<ActionResult<CampaignProgressDto>> GetProgress([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessIdOrThrow();\n\n            // 1) Aggregate OutboundMessageJobs for this campaign\n            var jobsQuery = _db.OutboundMessageJobs\n                .AsNoTracking()\n                .Where(j => j.BusinessId == businessId && j.CampaignId == id);\n\n            var total = await jobsQuery.CountAsync();\n\n            // group-by status safely (statuses are strings in your worker: Pending/InFlight/Sent/Failed)\n            var grouped = await jobsQuery\n                .GroupBy(j => j.Status)\n                .Select(g => new { Status = g.Key, Count = g.Count() })\n                .ToListAsync();\n\n            int pending = grouped.FirstOrDefault(x => x.Status == \"Pending\")?.Count ?? 0;\n            int inFlight = grouped.FirstOrDefault(x => x.Status == \"InFlight\")?.Count ?? 0;\n            int sent = grouped.FirstOrDefault(x => x.Status == \"Sent\")?.Count ?? 0;\n            int failed = grouped.FirstOrDefault(x => x.Status == \"Failed\")?.Count ?? 0;\n\n            // \"Dead\" = failed attempts that exceeded the worker retry policy.\n            // Your worker uses DEFAULT_MAX_ATTEMPTS = 3; mark those as dead for visibility.\n            const int MAX_ATTEMPTS = 3;\n            int dead = await jobsQuery.Where(j => j.Status == \"Failed\" && j.Attempt >= MAX_ATTEMPTS).CountAsync();\n\n            var completed = sent + failed; // treat both as terminal\n            var pct = total > 0 ? (completed * 100.0) / total : 0.0;\n\n            // 2) Percentiles from MessageLogs over the last hour (SentAt or CreatedAt ‚Üí latency)\n            // We‚Äôll compute duration_ms = (COALESCE(SentAt, CreatedAt) - CreatedAt) in milliseconds\n            // and use PostgreSQL percentile_cont via raw SQL. If DB isn‚Äôt PostgreSQL, you can replace with a fallback.\n\n            double? p50 = null, p95 = null, p99 = null;\n\n            try\n            {\n                var sql = @\"\nSELECT\n  percentile_cont(0.50) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (COALESCE(\"\"SentAt\"\", \"\"CreatedAt\"\") - \"\"CreatedAt\"\")) * 1000.0) AS p50,\n  percentile_cont(0.95) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (COALESCE(\"\"SentAt\"\", \"\"CreatedAt\"\") - \"\"CreatedAt\"\")) * 1000.0) AS p95,\n  percentile_cont(0.99) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (COALESCE(\"\"SentAt\"\", \"\"CreatedAt\"\") - \"\"CreatedAt\"\")) * 1000.0) AS p99\nFROM \"\"MessageLogs\"\"\nWHERE \"\"BusinessId\"\" = {0}\n  AND \"\"CampaignId\"\" = {1}\n  AND \"\"Source\"\" = 'campaign'\n  AND \"\"CreatedAt\"\" >= NOW() - INTERVAL '1 hour';\n\";\n                var row = await _db.Set<PercentileRow>()\n                    .FromSqlRaw(sql, businessId, id)\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync();\n\n                if (row != null)\n                {\n                    p50 = row.p50;\n                    p95 = row.p95;\n                    p99 = row.p99;\n                }\n            }\n            catch\n            {\n                // Swallow percentile errors (e.g., not Postgres); UI shows \"‚Äì\" if null.\n            }\n\n            var dto = new CampaignProgressDto\n            {\n                CampaignId = id,\n                TotalJobs = total,\n                Pending = pending,\n                InFlight = inFlight,\n                Sent = sent,\n                Failed = failed,\n                Dead = dead,\n                Completed = completed,\n                CompletionPct = Math.Round(pct, 2),\n                P50ms = p50,\n                P95ms = p95,\n                P99ms = p99,\n                RetrievedAtUtc = DateTime.UtcNow\n            };\n\n            return Ok(dto);\n        }\n\n        private Guid GetBusinessIdOrThrow()\n        {\n            string? raw =\n                User?.FindFirst(\"business_id\")?.Value ??\n                User?.FindFirst(\"BusinessId\")?.Value ??\n                User?.FindFirst(\"businessId\")?.Value ??\n                Request.Headers[\"X-Business-Id\"].FirstOrDefault();\n\n            if (!Guid.TryParse(raw, out var id))\n                throw new UnauthorizedAccessException(\"Business context missing.\");\n            return id;\n        }\n\n        // local result shape for FromSqlRaw\n        private sealed class PercentileRow\n        {\n            public double? p50 { get; set; }\n            public double? p95 { get; set; }\n            public double? p99 { get; set; }\n        }\n    }\n}\n\n\n//using Microsoft.AspNetCore.Mvc;\n//using Microsoft.EntityFrameworkCore;\n//using xbytechat.api.Features.CampaignModule.DTOs;\n//using xbytechat.api.Features.CampaignModule.Progress.Dtos;\n\n//namespace xbytechat.api.Features.CampaignModule.Progress.Controllers\n//{\n//    [ApiController]\n//    [Route(\"campaigns\")]\n//    public sealed class CampaignProgressController : ControllerBase\n//    {\n//        private readonly AppDbContext _db;\n\n//        public CampaignProgressController(AppDbContext db) => _db = db;\n\n//        [HttpGet(\"{campaignId:guid}/progress\")]\n//        public async Task<ActionResult<CampaignProgressDto>> GetProgress(Guid campaignId, CancellationToken ct)\n//        {\n//            // 1) Queue/job status from OutboundMessageJobs\n//            var baseQuery = _db.OutboundMessageJobs\n//                .AsNoTracking()\n//                .Where(j => j.CampaignId == campaignId);\n\n//            var total = await baseQuery.CountAsync(ct);\n\n//            var byStatus = await baseQuery\n//                .GroupBy(j => j.Status)\n//                .Select(g => new { Status = g.Key, Count = g.Count() })\n//                .ToListAsync(ct);\n\n//            int pending = byStatus.FirstOrDefault(x => x.Status == \"Pending\")?.Count ?? 0;\n//            int inflight = byStatus.FirstOrDefault(x => x.Status == \"InFlight\")?.Count ?? 0;\n//            int sent = byStatus.FirstOrDefault(x => x.Status == \"Sent\")?.Count ?? 0;\n//            int failed = byStatus.FirstOrDefault(x => x.Status == \"Failed\")?.Count ?? 0;\n//            int dead = byStatus.FirstOrDefault(x => x.Status == \"Dead\")?.Count ?? 0;\n\n//            // 2) Last-hour send latency from MessageLogs (Sent rows only)\n//            var since = DateTime.UtcNow.AddHours(-1);\n//            var recent = await _db.MessageLogs.AsNoTracking()\n//                .Where(m => m.CampaignId == campaignId && m.SentAt != null && m.CreatedAt >= since)\n//                .Select(m => new { m.CreatedAt, m.SentAt })\n//                .ToListAsync(ct);\n\n//            double? p50 = null, p95 = null, p99 = null;\n//            if (recent.Count > 0)\n//            {\n//                var latenciesMs = new List<double>(recent.Count);\n//                foreach (var r in recent)\n//                {\n//                    var ts = r.SentAt!.Value - r.CreatedAt;\n//                    latenciesMs.Add(ts.TotalMilliseconds);\n//                }\n//                latenciesMs.Sort();\n\n//                double Percentile(List<double> xs, double p)\n//                {\n//                    if (xs.Count == 0) return 0;\n//                    var rank = (p / 100.0) * (xs.Count - 1);\n//                    var lo = (int)Math.Floor(rank);\n//                    var hi = (int)Math.Ceiling(rank);\n//                    if (lo == hi) return xs[lo];\n//                    var frac = rank - lo;\n//                    return xs[lo] + (xs[hi] - xs[lo]) * frac;\n//                }\n\n//                p50 = Percentile(latenciesMs, 50);\n//                p95 = Percentile(latenciesMs, 95);\n//                p99 = Percentile(latenciesMs, 99);\n//            }\n\n//            var dto = new CampaignProgressDto\n//            {\n//                CampaignId = campaignId,\n//                TotalJobs = total,\n//                Pending = pending,\n//                InFlight = inflight,\n//                Sent = sent,\n//                Failed = failed,\n//                Dead = dead,\n//                P50ms = p50,\n//                P95ms = p95,\n//                P99ms = p99,\n//                RetrievedAtUtc = DateTime.UtcNow\n//            };\n\n//            return Ok(dto);\n//        }\n//    }\n//}\n\n\n//using Microsoft.AspNetCore.Mvc;\n//using Microsoft.EntityFrameworkCore;\n//using System;\n//using System.Linq;\n//using System.Threading.Tasks;\n//using xbytechat.api.AuthModule.Models;\n//using xbytechat.api.Features.CampaignModule.DTOs;\n\n//namespace xbytechat.api.Features.CampaignModule.Controllers\n//{\n//    // NOTE: route is plural to match your frontend: /api/campaigns/{id}/progress\n//    [ApiController]\n//    [Route(\"api/campaigns\")]\n//    public class CampaignsProgressController : ControllerBase\n//    {\n//        private readonly AppDbContext _db;\n\n//        public CampaignsProgressController(AppDbContext db) => _db = db;\n\n//        [HttpGet(\"{id:guid}/progress\")]\n//        public async Task<ActionResult<CampaignProgressDto>> GetProgress([FromRoute] Guid id)\n//        {\n//            var businessId = GetBusinessIdOrThrow();\n\n//            // 1) Aggregate OutboundMessageJobs for this campaign\n//            var jobsQuery = _db.OutboundMessageJobs\n//                .AsNoTracking()\n//                .Where(j => j.BusinessId == businessId && j.CampaignId == id);\n\n//            var total = await jobsQuery.CountAsync();\n\n//            // group-by status safely (statuses are strings in your worker: Pending/InFlight/Sent/Failed)\n//            var grouped = await jobsQuery\n//                .GroupBy(j => j.Status)\n//                .Select(g => new { Status = g.Key, Count = g.Count() })\n//                .ToListAsync();\n\n//            int pending = grouped.FirstOrDefault(x => x.Status == \"Pending\")?.Count ?? 0;\n//            int inFlight = grouped.FirstOrDefault(x => x.Status == \"InFlight\")?.Count ?? 0;\n//            int sent = grouped.FirstOrDefault(x => x.Status == \"Sent\")?.Count ?? 0;\n//            int failed = grouped.FirstOrDefault(x => x.Status == \"Failed\")?.Count ?? 0;\n\n//            // \"Dead\" = failed attempts that exceeded the worker retry policy.\n//            // Your worker uses DEFAULT_MAX_ATTEMPTS = 3; mark those as dead for visibility.\n//            const int MAX_ATTEMPTS = 3;\n//            int dead = await jobsQuery.Where(j => j.Status == \"Failed\" && j.Attempt >= MAX_ATTEMPTS).CountAsync();\n\n//            var completed = sent + failed; // treat both as terminal\n//            var pct = total > 0 ? (completed * 100.0) / total : 0.0;\n\n//            // 2) Percentiles from MessageLogs over the last hour (SentAt or CreatedAt ‚Üí latency)\n//            // We‚Äôll compute duration_ms = (COALESCE(SentAt, CreatedAt) - CreatedAt) in milliseconds\n//            // and use PostgreSQL percentile_cont via raw SQL. If DB isn‚Äôt PostgreSQL, you can replace with a fallback.\n\n//            double? p50 = null, p95 = null, p99 = null;\n\n//            try\n//            {\n//                var sql = @\"\n//SELECT\n//  percentile_cont(0.50) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (COALESCE(\"\"SentAt\"\", \"\"CreatedAt\"\") - \"\"CreatedAt\"\")) * 1000.0) AS p50,\n//  percentile_cont(0.95) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (COALESCE(\"\"SentAt\"\", \"\"CreatedAt\"\") - \"\"CreatedAt\"\")) * 1000.0) AS p95,\n//  percentile_cont(0.99) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (COALESCE(\"\"SentAt\"\", \"\"CreatedAt\"\") - \"\"CreatedAt\"\")) * 1000.0) AS p99\n//FROM \"\"MessageLogs\"\"\n//WHERE \"\"BusinessId\"\" = {0}\n//  AND \"\"CampaignId\"\" = {1}\n//  AND \"\"Source\"\" = 'campaign'\n//  AND \"\"CreatedAt\"\" >= NOW() - INTERVAL '1 hour';\n//\";\n//                var row = await _db.Set<PercentileRow>()\n//                    .FromSqlRaw(sql, businessId, id)\n//                    .AsNoTracking()\n//                    .FirstOrDefaultAsync();\n\n//                if (row != null)\n//                {\n//                    p50 = row.p50;\n//                    p95 = row.p95;\n//                    p99 = row.p99;\n//                }\n//            }\n//            catch\n//            {\n//                // Swallow percentile errors (e.g., not Postgres); UI shows \"‚Äì\" if null.\n//            }\n\n//            var dto = new CampaignProgressDto\n//            {\n//                CampaignId = id,\n//                TotalJobs = total,\n//                Pending = pending,\n//                InFlight = inFlight,\n//                Sent = sent,\n//                Failed = failed,\n//                Dead = dead,\n//                Completed = completed,\n//                CompletionPct = Math.Round(pct, 2),\n//                P50ms = p50,\n//                P95ms = p95,\n//                P99ms = p99,\n//                RetrievedAtUtc = DateTime.UtcNow\n//            };\n\n//            return Ok(dto);\n//        }\n\n//        private Guid GetBusinessIdOrThrow()\n//        {\n//            string? raw =\n//                User?.FindFirst(\"business_id\")?.Value ??\n//                User?.FindFirst(\"BusinessId\")?.Value ??\n//                User?.FindFirst(\"businessId\")?.Value ??\n//                Request.Headers[\"X-Business-Id\"].FirstOrDefault();\n\n//            if (!Guid.TryParse(raw, out var id))\n//                throw new UnauthorizedAccessException(\"Business context missing.\");\n//            return id;\n//        }\n\n//        // local result shape for FromSqlRaw\n//        private sealed class PercentileRow\n//        {\n//            public double? p50 { get; set; }\n//            public double? p95 { get; set; }\n//            public double? p99 { get; set; }\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Progress/Dtos/CampaignProgressDto.cs",
      "sha256": "18200e59baf279b4a7cc18a87861a54eb5dd85d8cd5c1dfba9d96e2c08feb6f6",
      "language": "csharp",
      "size": 1582,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    public sealed class CampaignProgressDto\n    {\n        public Guid CampaignId { get; set; }\n        public int TotalJobs { get; set; }\n        public int Pending { get; set; }\n        public int InFlight { get; set; }\n        public int Sent { get; set; }\n        public int Failed { get; set; }\n        public int Dead { get; set; }\n        public int Completed { get; set; }\n        public double CompletionPct { get; set; }\n        public double? P50ms { get; set; }\n        public double? P95ms { get; set; }\n        public double? P99ms { get; set; }\n        public DateTime RetrievedAtUtc { get; set; }\n    }\n}\n\n\n\n//namespace xbytechat.api.Features.CampaignModule.Progress.Dtos\n//{\n//    public sealed class CampaignProgressDto\n//    {\n//        public Guid CampaignId { get; init; }\n\n//        // Queue / job state\n//        public int TotalJobs { get; init; }\n//        public int Pending { get; init; }\n//        public int InFlight { get; init; }\n//        public int Sent { get; init; }\n//        public int Failed { get; init; }\n//        public int Dead { get; init; }\n\n//        // Derived\n//        public int Completed => Sent + Failed + Dead;\n//        public double CompletionPct => TotalJobs == 0 ? 0 : (double)Completed / TotalJobs * 100.0;\n\n//        // Last-hour send latency (ms)\n//        public double? P50ms { get; init; }\n//        public double? P95ms { get; init; }\n//        public double? P99ms { get; init; }\n\n//        public DateTime RetrievedAtUtc { get; init; }\n//    }\n//}"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/Adapters/IProviderPayloadMapper.cs",
      "sha256": "1e9a31d34be2cf3ed1b6dd390a429ca6e98d08ce2852c55d1a17ef6dede7a840",
      "language": "csharp",
      "size": 277,
      "content": "namespace xbytechat.api.Features.CampaignModule.SendEngine;\n\npublic interface IProviderPayloadMapper\n{\n    /// Maps our provider-agnostic envelope into the wire payload object the engine expects.\n    object BuildPayload(SendPlan plan, RecipientPlan r, TemplateEnvelope env);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/Adapters/MetaCloudPayloadMapper.cs",
      "sha256": "878403eea3ab67c8e793d87f2051bcd73660249f17a3fc6fa322223e2baa72a0",
      "language": "csharp",
      "size": 21830,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine\n{\n    public sealed class MetaCloudPayloadMapper : IProviderPayloadMapper\n    {\n        private readonly ILogger<MetaCloudPayloadMapper> _log;\n\n        public MetaCloudPayloadMapper(ILogger<MetaCloudPayloadMapper> log)\n        {\n            _log = log;\n        }\n\n        public object BuildPayload(SendPlan plan, RecipientPlan recipient, TemplateEnvelope env)\n        {\n            var to = recipient?.ToPhoneE164 ?? \"\";\n            _log.LogInformation(\"MetaMapper: BuildPayload start | template={Template} lang={Lang} to={To}\",\n                plan?.TemplateName, plan?.LanguageCode, to);\n\n            try\n            {\n                var components = BuildComponents(env);\n\n                var msg = new MetaTemplateMessage(\n                    MessagingProduct: \"whatsapp\",\n                    To: to,\n                    Type: \"template\",\n                    Template: new MetaTemplate(\n                        Name: plan.TemplateName,\n                        // Use exactly what you saved in DB (e.g., \"en_US\")\n                        Language: new MetaLanguage(plan.LanguageCode),\n                        Components: components\n                    )\n                );\n\n                _log.LogDebug(\"MetaMapper: Components built | headerKind={HeaderKind} bodyParams={BodyCount} buttons={BtnCount}\",\n                    env.HeaderKind, env.BodyParams?.Count ?? 0, env.Buttons?.Count ?? 0);\n\n                return msg;\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex,\n                    \"MetaMapper: Failed to build payload | template={Template} lang={Lang} to={To}\",\n                    plan?.TemplateName, plan?.LanguageCode, to);\n                throw;\n            }\n        }\n\n        // Build typed Meta components (header/body/buttons)\n        private IReadOnlyList<MetaComponentBase> BuildComponents(TemplateEnvelope env)\n        {\n            var list = new List<MetaComponentBase>(capacity: 4);\n\n            // ----- HEADER -----\n            if (env.HeaderKind != HeaderKind.None)\n            {\n                switch (env.HeaderKind)\n                {\n                    case HeaderKind.Text:\n                        if (env.HeaderParams is { Count: > 0 })\n                        {\n                            _log.LogDebug(\"MetaMapper: Header=text | params={Count}\", env.HeaderParams.Count);\n                            list.Add(new MetaHeaderTextComponent(\n                                Type: \"header\",\n                                Parameters: BuildTextParams(env.HeaderParams, \"header\")\n                            ));\n                        }\n                        else\n                        {\n                            _log.LogDebug(\"MetaMapper: Header=text but no params present\");\n                        }\n                        break;\n\n                    case HeaderKind.Image:\n                        if (!string.IsNullOrWhiteSpace(env.HeaderUrl))\n                        {\n                            _log.LogDebug(\"MetaMapper: Header=image | url set\");\n                            list.Add(new MetaHeaderImageComponent(\n                                Type: \"header\",\n                                Parameters: new[]\n                                {\n                                    new MetaMediaParam(\"image\", Image: CreateMediaLink(env.HeaderUrl!))\n                                }\n                            ));\n                        }\n                        else\n                        {\n                            _log.LogWarning(\"MetaMapper: Header=image but HeaderUrl is missing/empty\");\n                        }\n                        break;\n\n                    case HeaderKind.Video:\n                        if (!string.IsNullOrWhiteSpace(env.HeaderUrl))\n                        {\n                            _log.LogDebug(\"MetaMapper: Header=video | url set\");\n                            list.Add(new MetaHeaderVideoComponent(\n                                Type: \"header\",\n                                Parameters: new[]\n                                {\n                                    new MetaMediaParam(\"video\", Video: CreateMediaLink(env.HeaderUrl!))\n                                }\n                            ));\n                        }\n                        else\n                        {\n                            _log.LogWarning(\"MetaMapper: Header=video but HeaderUrl is missing/empty\");\n                        }\n                        break;\n\n                    case HeaderKind.Document:\n                        if (!string.IsNullOrWhiteSpace(env.HeaderUrl))\n                        {\n                            _log.LogDebug(\"MetaMapper: Header=document | url set\");\n                            list.Add(new MetaHeaderDocumentComponent(\n                                Type: \"header\",\n                                Parameters: new[]\n                                {\n                                    new MetaMediaParam(\"document\", Document: CreateMediaLink(env.HeaderUrl!))\n                                }\n                            ));\n                        }\n                        else\n                        {\n                            _log.LogWarning(\"MetaMapper: Header=document but HeaderUrl is missing/empty\");\n                        }\n                        break;\n                }\n            }\n\n            // ----- BODY -----\n            if (env.BodyParams is { Count: > 0 })\n            {\n                _log.LogDebug(\"MetaMapper: Body params={Count}\", env.BodyParams.Count);\n                list.Add(new MetaBodyComponent(\n                    Type: \"body\",\n                    Parameters: BuildTextParams(env.BodyParams, \"body\")\n                ));\n            }\n            else\n            {\n                _log.LogDebug(\"MetaMapper: No body params present\");\n            }\n\n            // ----- BUTTONS (URL only) -----\n            var perRecipient = ParsePerRecipient(env.PerRecipientButtonParamsJson);\n\n            for (int i = 0; i < (env.Buttons?.Count ?? 0) && i < 3; i++)\n            {\n                var b = env.Buttons[i];\n                if (!string.Equals(b.Type, \"url\", StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var idxStr = i.ToString(); // Meta uses \"0\" | \"1\" | \"2\"\n                var key = $\"button{i + 1}.url_param\";\n                MetaTextParam[]? parameters = null;\n\n                if (perRecipient.TryGetValue(key, out var dyn))\n                {\n                    if (string.IsNullOrWhiteSpace(dyn))\n                    {\n                        _log.LogWarning(\"MetaMapper: URL button param is empty | index={Index} key={Key}\", i, key);\n                        // Leave parameters=null; if template actually requires a dynamic value,\n                        // Meta will 400. Better to fail earlier in your validation pipeline if possible.\n                    }\n                    else\n                    {\n                        parameters = new[] { new MetaTextParam(\"text\", dyn) };\n                        _log.LogDebug(\"MetaMapper: URL button dynamic param set | index={Index} key={Key}\", i, key);\n                    }\n                }\n                else\n                {\n                    _log.LogDebug(\"MetaMapper: URL button has no dynamic param in payload | index={Index} key={Key}\", i, key);\n                }\n\n                list.Add(new MetaButtonUrlComponent(\n                    Type: \"button\",\n                    SubType: \"url\",\n                    Index: idxStr,\n                    Parameters: parameters\n                ));\n            }\n\n            return list;\n        }\n\n        private MetaMediaLink CreateMediaLink(string url)\n        {\n            if (url.StartsWith(\"handle:\", StringComparison.OrdinalIgnoreCase))\n            {\n                var identifier = url.Substring(7);\n                _log.LogInformation(\"MetaMapper: Mapping media handle/id: {Identifier}\", identifier);\n                // For Template messages, handles must be passed in the \"id\" field\n                return new MetaMediaLink(Id: identifier);\n            }\n            \n            _log.LogInformation(\"MetaMapper: Mapping media URL: {Url}\", url);\n            return new MetaMediaLink(Link: url);\n        }\n\n        /// <summary>\n        /// Build Meta \"text\" parameters ensuring no empty/whitespace values are sent.\n        /// Throws InvalidOperationException with a clear message if any value is missing.\n        /// </summary>\n        private MetaTextParam[] BuildTextParams(IReadOnlyList<string> values, string componentName)\n        {\n            if (values is null || values.Count == 0)\n                return Array.Empty<MetaTextParam>();\n\n            var result = new List<MetaTextParam>(values.Count);\n            for (int i = 0; i < values.Count; i++)\n            {\n                var v = values[i];\n                if (string.IsNullOrWhiteSpace(v))\n                {\n                    _log.LogWarning(\"MetaMapper: Empty placeholder value detected | component={Component} index={Index}\", componentName, i + 1);\n                    // Fail early instead of hitting Meta with bad payload -> avoids 400 (#131008)\n                    throw new InvalidOperationException(\n                        $\"Template {componentName} parameter #{i + 1} is empty/whitespace. \" +\n                        $\"Provide a value for all placeholders required by the template.\");\n                }\n                result.Add(new MetaTextParam(\"text\", v));\n            }\n            return result.ToArray();\n        }\n\n        // === Lenient parser: never throws; supports {}, [] forms; returns empty on any issue.\n        private Dictionary<string, string> ParsePerRecipient(string? json)\n        {\n            var map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            if (string.IsNullOrWhiteSpace(json))\n                return map;\n\n            // Try object form first: { \"button1.url_param\": \"https://...\", \"code\":\"ABC\" }\n            try\n            {\n                var obj = JsonSerializer.Deserialize<Dictionary<string, string>>(json!);\n                if (obj != null)\n                {\n                    foreach (var kv in obj)\n                    {\n                        if (!string.IsNullOrWhiteSpace(kv.Key))\n                            map[kv.Key.Trim()] = kv.Value ?? string.Empty;\n                    }\n                    return map;\n                }\n            }\n            catch\n            {\n                // fall through to array form\n            }\n\n            // Try array form: [ { \"key\":\"button1.url_param\", \"value\":\"https://...\" }, ... ]\n            try\n            {\n                var arr = JsonSerializer.Deserialize<List<Dictionary<string, string>>>(json!);\n                if (arr != null)\n                {\n                    foreach (var item in arr)\n                    {\n                        if (!item.TryGetValue(\"key\", out var key) || string.IsNullOrWhiteSpace(key))\n                            continue;\n                        item.TryGetValue(\"value\", out var value);\n                        map[key.Trim()] = value ?? string.Empty;\n                    }\n                }\n            }\n            catch\n            {\n                // swallow ‚Äì return empty for malformed payload\n            }\n\n            return map;\n        }\n    }\n}\n\n\n\n//using System;\n//using System.Collections.Generic;\n//using System.Linq;\n//using System.Text.Json;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta;\n\n//namespace xbytechat.api.Features.CampaignModule.SendEngine\n//{\n//    public sealed class MetaCloudPayloadMapper : IProviderPayloadMapper\n//    {\n//        private readonly ILogger<MetaCloudPayloadMapper> _log;\n\n//        public MetaCloudPayloadMapper(ILogger<MetaCloudPayloadMapper> log)\n//        {\n//            _log = log;\n//        }\n\n//        public object BuildPayload(SendPlan plan, RecipientPlan recipient, TemplateEnvelope env)\n//        {\n//            var to = recipient?.ToPhoneE164 ?? \"\";\n//            _log.LogInformation(\"MetaMapper: BuildPayload start | template={Template} lang={Lang} to={To}\",\n//                plan?.TemplateName, plan?.LanguageCode, to);\n\n//            try\n//            {\n//                var components = BuildComponents(env);\n\n//                var msg = new MetaTemplateMessage(\n//                    MessagingProduct: \"whatsapp\",\n//                    To: to,\n//                    Type: \"template\",\n//                    Template: new MetaTemplate(\n//                        Name: plan.TemplateName,\n//                        // Use exactly what you saved in DB (e.g., \"en_US\")\n//                        Language: new MetaLanguage(plan.LanguageCode),\n//                        Components: components\n//                    )\n//                );\n\n//                _log.LogDebug(\"MetaMapper: Components built | headerKind={HeaderKind} bodyParams={BodyCount} buttons={BtnCount}\",\n//                    env.HeaderKind, env.BodyParams?.Count ?? 0, env.Buttons?.Count ?? 0);\n\n//                return msg;\n//            }\n//            catch (Exception ex)\n//            {\n//                _log.LogError(ex,\n//                    \"MetaMapper: Failed to build payload | template={Template} lang={Lang} to={To}\",\n//                    plan?.TemplateName, plan?.LanguageCode, to);\n//                throw;\n//            }\n//        }\n\n//        // Build typed Meta components (header/body/buttons)\n//        private IReadOnlyList<MetaComponentBase> BuildComponents(TemplateEnvelope env)\n//        {\n//            var list = new List<MetaComponentBase>(capacity: 4);\n\n//            // ----- HEADER -----\n//            if (env.HeaderKind != HeaderKind.None)\n//            {\n//                switch (env.HeaderKind)\n//                {\n//                    case HeaderKind.Text:\n//                        if (env.HeaderParams is { Count: > 0 })\n//                        {\n//                            _log.LogDebug(\"MetaMapper: Header=text | params={Count}\", env.HeaderParams.Count);\n//                            list.Add(new MetaHeaderTextComponent(\n//                                Type: \"header\",\n//                                Parameters: BuildTextParams(env.HeaderParams, \"header\")\n//                            ));\n//                        }\n//                        else\n//                        {\n//                            _log.LogDebug(\"MetaMapper: Header=text but no params present\");\n//                        }\n//                        break;\n\n//                    case HeaderKind.Image:\n//                        if (!string.IsNullOrWhiteSpace(env.HeaderUrl))\n//                        {\n//                            _log.LogDebug(\"MetaMapper: Header=image | url set\");\n//                            list.Add(new MetaHeaderImageComponent(\n//                                Type: \"header\",\n//                                Parameters: new[]\n//                                {\n//                                    new MetaMediaParam(\"image\", Image: new MetaMediaLink(env.HeaderUrl!))\n//                                }\n//                            ));\n//                        }\n//                        else\n//                        {\n//                            _log.LogWarning(\"MetaMapper: Header=image but HeaderUrl is missing/empty\");\n//                        }\n//                        break;\n\n//                    case HeaderKind.Video:\n//                        if (!string.IsNullOrWhiteSpace(env.HeaderUrl))\n//                        {\n//                            _log.LogDebug(\"MetaMapper: Header=video | url set\");\n//                            list.Add(new MetaHeaderVideoComponent(\n//                                Type: \"header\",\n//                                Parameters: new[]\n//                                {\n//                                    new MetaMediaParam(\"video\", Video: new MetaMediaLink(env.HeaderUrl!))\n//                                }\n//                            ));\n//                        }\n//                        else\n//                        {\n//                            _log.LogWarning(\"MetaMapper: Header=video but HeaderUrl is missing/empty\");\n//                        }\n//                        break;\n\n//                    case HeaderKind.Document:\n//                        if (!string.IsNullOrWhiteSpace(env.HeaderUrl))\n//                        {\n//                            _log.LogDebug(\"MetaMapper: Header=document | url set\");\n//                            list.Add(new MetaHeaderDocumentComponent(\n//                                Type: \"header\",\n//                                Parameters: new[]\n//                                {\n//                                    new MetaMediaParam(\"document\", Document: new MetaMediaLink(env.HeaderUrl!))\n//                                }\n//                            ));\n//                        }\n//                        else\n//                        {\n//                            _log.LogWarning(\"MetaMapper: Header=document but HeaderUrl is missing/empty\");\n//                        }\n//                        break;\n//                }\n//            }\n\n//            // ----- BODY -----\n//            if (env.BodyParams is { Count: > 0 })\n//            {\n//                _log.LogDebug(\"MetaMapper: Body params={Count}\", env.BodyParams.Count);\n//                list.Add(new MetaBodyComponent(\n//                    Type: \"body\",\n//                    Parameters: BuildTextParams(env.BodyParams, \"body\")\n//                ));\n//            }\n//            else\n//            {\n//                _log.LogDebug(\"MetaMapper: No body params present\");\n//            }\n\n//            // ----- BUTTONS (URL only) -----\n//            var perRecipient = ParsePerRecipient(env.PerRecipientButtonParamsJson);\n\n//            for (int i = 0; i < (env.Buttons?.Count ?? 0) && i < 3; i++)\n//            {\n//                var b = env.Buttons[i];\n//                if (!string.Equals(b.Type, \"url\", StringComparison.OrdinalIgnoreCase))\n//                    continue;\n\n//                var idxStr = i.ToString(); // Meta uses \"0\" | \"1\" | \"2\"\n//                var key = $\"button{i + 1}.url_param\";\n//                MetaTextParam[]? parameters = null;\n\n//                if (perRecipient.TryGetValue(key, out var dyn))\n//                {\n//                    if (string.IsNullOrWhiteSpace(dyn))\n//                    {\n//                        _log.LogWarning(\"MetaMapper: URL button param is empty | index={Index} key={Key}\", i, key);\n//                        // Leave parameters=null; if template actually requires a dynamic value,\n//                        // Meta will 400. Better to fail earlier in your validation pipeline if possible.\n//                    }\n//                    else\n//                    {\n//                        parameters = new[] { new MetaTextParam(\"text\", dyn) };\n//                        _log.LogDebug(\"MetaMapper: URL button dynamic param set | index={Index} key={Key}\", i, key);\n//                    }\n//                }\n//                else\n//                {\n//                    _log.LogDebug(\"MetaMapper: URL button has no dynamic param in payload | index={Index} key={Key}\", i, key);\n//                }\n\n//                list.Add(new MetaButtonUrlComponent(\n//                    Type: \"button\",\n//                    SubType: \"url\",\n//                    Index: idxStr,\n//                    Parameters: parameters\n//                ));\n//            }\n\n//            return list;\n//        }\n\n//        /// <summary>\n//        /// Build Meta \"text\" parameters ensuring no empty/whitespace values are sent.\n//        /// Throws InvalidOperationException with a clear message if any value is missing.\n//        /// </summary>\n//        private MetaTextParam[] BuildTextParams(IReadOnlyList<string> values, string componentName)\n//        {\n//            if (values is null || values.Count == 0)\n//                return Array.Empty<MetaTextParam>();\n\n//            var result = new List<MetaTextParam>(values.Count);\n//            for (int i = 0; i < values.Count; i++)\n//            {\n//                var v = values[i];\n//                if (string.IsNullOrWhiteSpace(v))\n//                {\n//                    _log.LogWarning(\"MetaMapper: Empty placeholder value detected | component={Component} index={Index}\", componentName, i + 1);\n//                    // Fail early instead of hitting Meta with bad payload -> avoids 400 (#131008)\n//                    throw new InvalidOperationException(\n//                        $\"Template {componentName} parameter #{i + 1} is empty/whitespace. \" +\n//                        $\"Provide a value for all placeholders required by the template.\");\n//                }\n//                result.Add(new MetaTextParam(\"text\", v));\n//            }\n//            return result.ToArray();\n//        }\n\n//        private Dictionary<string, string> ParsePerRecipient(string? json)\n//        {\n//            if (string.IsNullOrWhiteSpace(json))\n//                return new();\n\n//            try\n//            {\n//                return JsonSerializer.Deserialize<Dictionary<string, string>>(json!) ?? new();\n//            }\n//            catch (Exception ex)\n//            {\n//                _log.LogError(ex, \"MetaMapper: Failed to parse PerRecipientButtonParamsJson. Using empty object.\");\n//                return new();\n//            }\n//        }\n//    }\n//}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/Adapters/PinnaclePayloadMapper.cs",
      "sha256": "5547470e572582a467db7d4ae69e2bdfc1437ea530d612b30f6bb0b175ae0418",
      "language": "csharp",
      "size": 7137,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Pinnacle;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine\n{\n    public sealed class PinnaclePayloadMapper : IProviderPayloadMapper\n    {\n        public object BuildPayload(SendPlan plan, RecipientPlan recipient, TemplateEnvelope env)\n        {\n            var components = BuildComponents(env);\n\n            var msg = new PinnacleTemplateMessage(\n                MessagingProduct: \"whatsapp\",\n                To: recipient.ToPhoneE164,\n                Type: \"template\",\n                Template: new PinnacleTemplate(\n                    Name: plan.TemplateName,\n                    Language: new PinnacleLanguage(plan.LanguageCode),\n                    Components: components\n                )\n            );\n\n            return msg; // typed record; engine serializes via JsonCtx\n        }\n\n        // Build fully-typed components for Pinnacle (camelCase subType, numeric index)\n        private static IReadOnlyList<PinnacleComponentBase> BuildComponents(TemplateEnvelope env)\n        {\n            var list = new List<PinnacleComponentBase>(capacity: 4);\n\n            // ===== HEADER =====\n            if (env.HeaderKind != HeaderKind.None)\n            {\n                switch (env.HeaderKind)\n                {\n                    // TEXT header uses HeaderParams (0..N)\n                    case HeaderKind.Text when env.HeaderParams is { Count: > 0 }:\n                        {\n                            var pars = new PinnTextParam[env.HeaderParams.Count];\n                            for (int i = 0; i < env.HeaderParams.Count; i++)\n                                pars[i] = new PinnTextParam(\"text\", env.HeaderParams[i] ?? string.Empty);\n\n                            list.Add(new PinnHeaderTextComponent(\n                                Type: \"header\",\n                                Parameters: pars\n                            ));\n                            break;\n                        }\n\n                    case HeaderKind.Image when !string.IsNullOrWhiteSpace(env.HeaderUrl):\n                        list.Add(new PinnHeaderImageComponent(\n                            Type: \"header\",\n                            Parameters: new[] { new PinnMediaParam(\"image\", Image: new PinnMediaLink(env.HeaderUrl!)) }\n                        ));\n                        break;\n\n                    case HeaderKind.Video when !string.IsNullOrWhiteSpace(env.HeaderUrl):\n                        list.Add(new PinnHeaderVideoComponent(\n                            Type: \"header\",\n                            Parameters: new[] { new PinnMediaParam(\"video\", Video: new PinnMediaLink(env.HeaderUrl!)) }\n                        ));\n                        break;\n\n                    case HeaderKind.Document when !string.IsNullOrWhiteSpace(env.HeaderUrl):\n                        list.Add(new PinnHeaderDocumentComponent(\n                            Type: \"header\",\n                            Parameters: new[] { new PinnMediaParam(\"document\", Document: new PinnMediaLink(env.HeaderUrl!)) }\n                        ));\n                        break;\n                }\n            }\n\n            // ===== BODY =====\n            if (env.BodyParams is { Count: > 0 })\n            {\n                var pars = new PinnTextParam[env.BodyParams.Count];\n                for (int i = 0; i < env.BodyParams.Count; i++)\n                    pars[i] = new PinnTextParam(\"text\", env.BodyParams[i] ?? string.Empty);\n\n                list.Add(new PinnBodyComponent(\n                    Type: \"body\",\n                    Parameters: pars\n                ));\n            }\n\n            // ===== BUTTONS ‚Äî URL only =====\n            var dyn = ReadPerRecipientButtonParams(env); // prefer dict, fallback to list\n\n            var buttonsCount = env.Buttons?.Count ?? 0;\n            if (buttonsCount > 0)\n            {\n                var max = Math.Min(3, buttonsCount);\n                for (int i = 0; i < max; i++)\n                {\n                    var meta = env.Buttons![i];\n                    if (!string.Equals(meta.Type, \"url\", StringComparison.OrdinalIgnoreCase))\n                        continue; // only URL buttons consume a dynamic \"param\"\n\n                    PinnTextParam[]? parameters = null;\n                    var isDynamic = !string.IsNullOrWhiteSpace(meta.TargetUrl) && meta.TargetUrl.IndexOf(\"{{\", StringComparison.Ordinal) >= 0;\n                    if (isDynamic)\n                    {\n                        // index i => position (i+1) in canonical dict; ReadPerRecipientButtonParams already ordered by pos\n                        var pv = i < dyn.Count ? dyn[i] ?? string.Empty : string.Empty;\n                        parameters = new[] { new PinnTextParam(\"text\", pv) };\n                    }\n\n                    list.Add(new PinnButtonUrlComponent(\n                        Type: \"button\",\n                        SubType: \"url\",\n                        Index: i,                 // numeric index for Pinnacle (0,1,2)\n                        Parameters: parameters    // null for static, one text param for dynamic\n                    ));\n                }\n            }\n\n            return list;\n        }\n\n        // Prefer canonical dict: { \"button1.url_param\": \"X\", \"button2.url_param\": \"Y\", ... }\n        // Fallback to legacy array: [\"X\",\"Y\",\"Z\"]\n        private static IReadOnlyList<string> ReadPerRecipientButtonParams(TemplateEnvelope env)\n        {\n            var json = env.PerRecipientButtonParamsJson;\n            if (string.IsNullOrWhiteSpace(json))\n                return Array.Empty<string>();\n\n            // 1) Try dict first (canonical)\n            try\n            {\n                var dict = JsonSerializer.Deserialize<Dictionary<string, string>>(json!);\n                if (dict is { Count: > 0 })\n                {\n                    var list = new List<string>(capacity: 3);\n                    for (int pos = 1; pos <= 3; pos++)\n                    {\n                        if (dict.TryGetValue($\"button{pos}.url_param\", out var v) && !string.IsNullOrWhiteSpace(v))\n                            list.Add(v);\n                    }\n                    return list;\n                }\n            }\n            catch\n            {\n                // fall through to array\n            }\n\n            // 2) Legacy array fallback\n            try\n            {\n                var arr = JsonSerializer.Deserialize<List<string>>(json!);\n                if (arr is null || arr.Count == 0) return Array.Empty<string>();\n                // Trim empties, preserve order (index => button index)\n                var cleaned = new List<string>(capacity: Math.Min(3, arr.Count));\n                for (int i = 0; i < arr.Count && i < 3; i++)\n                {\n                    var s = arr[i];\n                    if (!string.IsNullOrWhiteSpace(s)) cleaned.Add(s);\n                }\n                return cleaned;\n            }\n            catch\n            {\n                return Array.Empty<string>();\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/Contracts.cs",
      "sha256": "0ce09f3d25a800c6de5983c63bf58d643362807ac08ed348d8ed7326df784ada",
      "language": "csharp",
      "size": 1005,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine;\n\npublic sealed record ButtonMeta(string Text, string Type, string? TargetUrl);\n\npublic sealed record SendPlan(\n    Guid BusinessId,\n    Provider Provider,\n    string PhoneNumberId,\n    string TemplateName,\n    string LanguageCode,\n    HeaderKind HeaderKind,\n    string? HeaderUrl,\n    IReadOnlyList<ButtonMeta> Buttons\n);\n\npublic sealed record RecipientPlan(\n    Guid RecipientId,\n    string ToPhoneE164,\n    string ParametersJson,        // e.g. [\"p1\",\"p2\",...]\n    string? ButtonParamsJson,     // optional per-recipient button params json\n    string IdempotencyKey\n);\n\npublic sealed record TemplateEnvelope(\n    HeaderKind HeaderKind,\n    IReadOnlyList<string> HeaderParams,   // NEW: for TEXT headers\n    string? HeaderUrl,                    // for IMAGE/VIDEO/DOCUMENT\n    IReadOnlyList<string> BodyParams,\n    IReadOnlyList<ButtonMeta> Buttons,\n    string? PerRecipientButtonParamsJson\n);\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/HeaderKind.cs",
      "sha256": "8e427006538944b64e3d9218ffe902c8046814f0468a9a6be06e6135ec140f72",
      "language": "csharp",
      "size": 163,
      "content": "namespace xbytechat.api.Features.CampaignModule.SendEngine;\n\npublic enum HeaderKind\n{\n    None = 0,\n    Text = 1,\n    Image = 2,\n    Video = 3,\n    Document = 4\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/PayloadModels/Meta/Components.cs",
      "sha256": "d856f123a6a9b3f5c85ee644a60047b0cd5d9b5157000426f89b6c5c02d74540",
      "language": "csharp",
      "size": 3068,
      "content": "using System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta\n{\n    // Polymorphic set for Meta (WhatsApp Cloud). \"index\" is STRING, \"sub_type\" is snake_case.\n\n    \n    [JsonDerivedType(typeof(MetaBodyComponent), typeDiscriminator: \"body\")]\n    [JsonDerivedType(typeof(MetaHeaderTextComponent), typeDiscriminator: \"header_text\")]\n    [JsonDerivedType(typeof(MetaHeaderImageComponent), typeDiscriminator: \"header_image\")]\n    [JsonDerivedType(typeof(MetaHeaderVideoComponent), typeDiscriminator: \"header_video\")]\n    [JsonDerivedType(typeof(MetaHeaderDocumentComponent), typeDiscriminator: \"header_document\")]\n    [JsonDerivedType(typeof(MetaButtonUrlComponent), typeDiscriminator: \"button_url\")]\n    public abstract record MetaComponentBase;\n\n    public sealed record MetaTextParam(\n        [property: JsonPropertyName(\"type\")] string Type,\n        [property: JsonPropertyName(\"text\")] string Text\n    );\n\n    public sealed record MetaMediaParam(\n        [property: JsonPropertyName(\"type\")] string Type,\n        [property: JsonPropertyName(\"image\")] MetaMediaLink? Image = null,\n        [property: JsonPropertyName(\"video\")] MetaMediaLink? Video = null,\n        [property: JsonPropertyName(\"document\")] MetaMediaLink? Document = null\n    );\n\n    public sealed record MetaMediaLink(\n        [property: JsonPropertyName(\"link\")] string? Link = null,\n        [property: JsonPropertyName(\"handle\")] string? Handle = null,\n        [property: JsonPropertyName(\"id\")] string? Id = null\n    );\n\n    public sealed record MetaBodyComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"body\"\n        [property: JsonPropertyName(\"parameters\")] MetaTextParam[] Parameters\n    ) : MetaComponentBase;\n\n    public sealed record MetaHeaderTextComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] MetaTextParam[] Parameters\n    ) : MetaComponentBase;\n\n    public sealed record MetaHeaderImageComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] MetaMediaParam[] Parameters\n    ) : MetaComponentBase;\n\n    public sealed record MetaHeaderVideoComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] MetaMediaParam[] Parameters\n    ) : MetaComponentBase;\n\n    public sealed record MetaHeaderDocumentComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] MetaMediaParam[] Parameters\n    ) : MetaComponentBase;\n\n    public sealed record MetaButtonUrlComponent(\n        [property: JsonPropertyName(\"type\")] string Type,     // \"button\"\n        [property: JsonPropertyName(\"sub_type\")] string SubType,  // \"url\"\n        [property: JsonPropertyName(\"index\")] string Index,    // NOTE: string for Meta\n        [property: JsonPropertyName(\"parameters\")] MetaTextParam[]? Parameters\n    ) : MetaComponentBase;\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/PayloadModels/Meta/MetaTemplateMessage.cs",
      "sha256": "3f09cd432190a4c7c349150d12fe78205b238e5db09b498ab05f9abbe88dafe8",
      "language": "csharp",
      "size": 1113,
      "content": "using System.Collections.Generic;\nusing System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta\n{\n    public sealed record MetaTemplateMessage(\n        [property: JsonPropertyName(\"messaging_product\")] string MessagingProduct,\n        [property: JsonPropertyName(\"to\")] string To,\n        [property: JsonPropertyName(\"type\")] string Type,\n        [property: JsonPropertyName(\"template\")] MetaTemplate Template\n    );\n\n    public sealed record MetaTemplate(\n        [property: JsonPropertyName(\"name\")] string Name,\n        [property: JsonPropertyName(\"language\")] MetaLanguage Language,\n        //[property: JsonPropertyName(\"components\")] IReadOnlyList<MetaComponentBase>? Components,\n        [property: JsonPropertyName(\"components\")] IReadOnlyList<object>? Components\n    );\n\n    //public sealed record MetaLanguage([property: JsonPropertyName(\"code\")] string Code);\n\n    public sealed class MetaLanguage\n    {\n        [JsonPropertyName(\"code\")]\n        public string Code { get; init; }\n\n        public MetaLanguage(string code) => Code = code;\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/PayloadModels/Pinnacle/Components.cs",
      "sha256": "cfc69654c9cd823a198e805db3ec0ff6fcc26001182983b3be66ef5c1f22d635",
      "language": "csharp",
      "size": 2985,
      "content": "using System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Pinnacle\n{\n    // Pinnacle differences: \"subType\" camelCase; \"index\" is NUMBER.\n\n    [JsonPolymorphic(TypeDiscriminatorPropertyName = \"$pinnType\")]\n    [JsonDerivedType(typeof(PinnBodyComponent), typeDiscriminator: \"body\")]\n    [JsonDerivedType(typeof(PinnHeaderTextComponent), typeDiscriminator: \"header_text\")]\n    [JsonDerivedType(typeof(PinnHeaderImageComponent), typeDiscriminator: \"header_image\")]\n    [JsonDerivedType(typeof(PinnHeaderVideoComponent), typeDiscriminator: \"header_video\")]\n    [JsonDerivedType(typeof(PinnHeaderDocumentComponent), typeDiscriminator: \"header_document\")]\n    [JsonDerivedType(typeof(PinnButtonUrlComponent), typeDiscriminator: \"button_url\")]\n    public abstract record PinnacleComponentBase;\n\n    public sealed record PinnTextParam(\n        [property: JsonPropertyName(\"type\")] string Type,\n        [property: JsonPropertyName(\"text\")] string Text\n    );\n\n    public sealed record PinnMediaParam(\n        [property: JsonPropertyName(\"type\")] string Type,\n        [property: JsonPropertyName(\"image\")] PinnMediaLink? Image = null,\n        [property: JsonPropertyName(\"video\")] PinnMediaLink? Video = null,\n        [property: JsonPropertyName(\"document\")] PinnMediaLink? Document = null\n    );\n\n    public sealed record PinnMediaLink([property: JsonPropertyName(\"link\")] string Link);\n\n    public sealed record PinnBodyComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"body\"\n        [property: JsonPropertyName(\"parameters\")] PinnTextParam[] Parameters\n    ) : PinnacleComponentBase;\n\n    public sealed record PinnHeaderTextComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] PinnTextParam[] Parameters\n    ) : PinnacleComponentBase;\n\n    public sealed record PinnHeaderImageComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] PinnMediaParam[] Parameters\n    ) : PinnacleComponentBase;\n\n    public sealed record PinnHeaderVideoComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] PinnMediaParam[] Parameters\n    ) : PinnacleComponentBase;\n\n    public sealed record PinnHeaderDocumentComponent(\n        [property: JsonPropertyName(\"type\")] string Type, // \"header\"\n        [property: JsonPropertyName(\"parameters\")] PinnMediaParam[] Parameters\n    ) : PinnacleComponentBase;\n\n    public sealed record PinnButtonUrlComponent(\n        [property: JsonPropertyName(\"type\")] string Type,     // \"button\"\n        [property: JsonPropertyName(\"subType\")] string SubType,  // \"url\"\n        [property: JsonPropertyName(\"index\")] int Index,       // NOTE: number for Pinnacle\n        [property: JsonPropertyName(\"parameters\")] PinnTextParam[]? Parameters\n    ) : PinnacleComponentBase;\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/PayloadModels/Pinnacle/PinnacleTemplateMessage.cs",
      "sha256": "c017c048abb73f8bde17c430a6ff887627d6ebeb0478b0e6d0a62aa72ac3de44",
      "language": "csharp",
      "size": 865,
      "content": "using System.Collections.Generic;\nusing System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Pinnacle\n{\n    public sealed record PinnacleTemplateMessage(\n        [property: JsonPropertyName(\"messaging_product\")] string MessagingProduct,\n        [property: JsonPropertyName(\"to\")] string To,\n        [property: JsonPropertyName(\"type\")] string Type,\n        [property: JsonPropertyName(\"template\")] PinnacleTemplate Template\n    );\n\n    public sealed record PinnacleTemplate(\n        [property: JsonPropertyName(\"name\")] string Name,\n        [property: JsonPropertyName(\"language\")] PinnacleLanguage Language,\n        [property: JsonPropertyName(\"components\")] IReadOnlyList<PinnacleComponentBase>? Components\n    );\n\n    public sealed record PinnacleLanguage([property: JsonPropertyName(\"code\")] string Code);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/Provider.cs",
      "sha256": "ec1219d380917ac643ad5e8765c7b891f7abde39e95c1557679fba7175625ed0",
      "language": "csharp",
      "size": 410,
      "content": "namespace xbytechat.api.Features.CampaignModule.SendEngine;\n\npublic enum Provider\n{\n    MetaCloud = 1,\n    Pinnacle = 2\n}\n\npublic static class ProviderUtil\n{\n    public static Provider Parse(string? s) => s?.Trim().ToUpperInvariant() switch\n    {\n        \"META_CLOUD\" or \"META\" or \"METACLOUD\" => Provider.MetaCloud,\n        \"PINNACLE\" or \"PINBOT\" => Provider.Pinnacle,\n        _ => Provider.MetaCloud\n    };\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/Services/CampaignSendValidator.cs",
      "sha256": "c7813f7c5ae4e7c27aef8a79bdd702aa72175732ca7b48c4be0e2ab7ac700f88",
      "language": "csharp",
      "size": 6018,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing xbytechat.api.Features.CampaignModule.SendEngine;\nnamespace xbytechat.api.Features.CampaignModule.SendEngine.Services\n{\n    public sealed record ValidationIssue(string Field, string Message, string Severity = \"error\");\n\n    public sealed class ValidationResult\n    {\n        public bool IsValid => Issues.Count == 0 || Issues.All(i => i.Severity == \"warning\");\n        public List<ValidationIssue> Issues { get; } = new();\n        public void Error(string field, string msg) => Issues.Add(new(field, msg, \"error\"));\n        public void Warn(string field, string msg) => Issues.Add(new(field, msg, \"warning\"));\n    }\n\n    public static class CampaignSendValidator\n    {\n        public static ValidationResult ValidateBeforePayload(\n            SendPlan plan,\n            RecipientPlan recipient,\n            TemplateEnvelope envelope)\n        {\n            var vr = new ValidationResult();\n\n            // ---- PLAN ----\n            if (plan.BusinessId == Guid.Empty)\n                vr.Error(\"plan.businessId\", \"BusinessId is required.\");\n\n            if (string.IsNullOrWhiteSpace(plan.TemplateName))\n                vr.Error(\"plan.templateName\", \"Template name is required.\");\n\n            if (string.IsNullOrWhiteSpace(plan.LanguageCode))\n                vr.Warn(\"plan.language\", \"Language not specified; default will be used.\");\n\n            if (string.IsNullOrWhiteSpace(plan.PhoneNumberId))\n                vr.Error(\"plan.phoneNumberId\", \"PhoneNumberId is required to send.\");\n\n            if (plan.Buttons is { Count: > 3 })\n                vr.Error(\"plan.buttons\", \"Max 3 buttons are allowed by WhatsApp.\");\n\n            // Header media URL if media header\n            if (plan.HeaderKind is HeaderKind.Image or HeaderKind.Video or HeaderKind.Document)\n            {\n                if (string.IsNullOrWhiteSpace(envelope.HeaderUrl))\n                    vr.Error(\"header.url\", $\"HeaderKind={plan.HeaderKind} requires a non-empty HeaderUrl.\");\n                else if (!LooksLikeAbsoluteUrl(envelope.HeaderUrl!))\n                    vr.Error(\"header.url\", \"HeaderUrl must be absolute http/https URL (or wa/tel where supported).\");\n            }\n\n            // ---- RECIPIENT ----\n            if (recipient.RecipientId == Guid.Empty)\n                vr.Error(\"recipient.id\", \"RecipientId is required.\");\n\n            if (string.IsNullOrWhiteSpace(recipient.ToPhoneE164))\n                vr.Error(\"recipient.phone\", \"Recipient phone (E164) is required.\");\n            else if (!IsLikelyPhone(recipient.ToPhoneE164))\n                vr.Warn(\"recipient.phone\", \"Phone shape looks unusual for E.164.\");\n\n            if (string.IsNullOrWhiteSpace(recipient.IdempotencyKey))\n                vr.Warn(\"recipient.idemKey\", \"IdempotencyKey missing (retries may duplicate).\");\n\n            // ---- PARAM COUNTS ----\n            // BODY params come from recipient.ParametersJson (array of strings)\n            var bodyParams = DeserializeArray(recipient.ParametersJson);\n            // HEADER TEXT params come from envelope.HeaderParams (already extracted)\n            var headerParams = envelope.HeaderParams?.ToArray() ?? Array.Empty<string>();\n\n            if (plan.HeaderKind == HeaderKind.Text && headerParams.Length == 0)\n                vr.Warn(\"header.text.params\", \"Template has TEXT header but no header params were provided.\");\n\n            // ---- DYNAMIC URL BUTTONS ----\n            // Provider mappers look for keys like: button1.url_param / button2.url_param ...\n            var perRecipient = DeserializeDict(envelope.PerRecipientButtonParamsJson);\n            var dynNeeded = plan.Buttons\n                .Select((b, i) => new { b, idx = i })\n                .Where(x => string.Equals(x.b.Type, \"url\", StringComparison.OrdinalIgnoreCase))\n                .Select(x => new { Index = x.idx, Key = $\"button{x.idx + 1}.url_param\" })\n                .ToList();\n\n            foreach (var need in dynNeeded)\n            {\n                if (perRecipient.TryGetValue(need.Key, out var val))\n                {\n                    if (string.IsNullOrWhiteSpace(val))\n                        vr.Error($\"buttons[{need.Index}]\", $\"Dynamic URL button {need.Index + 1} has empty param value.\");\n                }\n                // Note: Not all URL buttons must be dynamic. If your template *requires* dynamic,\n                // you can enforce using live metadata at materialization time.\n            }\n\n            return vr;\n        }\n\n        private static string[] DeserializeArray(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return Array.Empty<string>();\n            try { return JsonSerializer.Deserialize<string[]>(json!) ?? Array.Empty<string>(); }\n            catch { return Array.Empty<string>(); }\n        }\n\n        private static Dictionary<string, string> DeserializeDict(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return new();\n            try { return JsonSerializer.Deserialize<Dictionary<string, string>>(json!) ?? new(); }\n            catch { return new(); }\n        }\n\n        private static bool LooksLikeAbsoluteUrl(string s)\n        {\n            if (s.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase)) return true;\n            return Uri.TryCreate(s, UriKind.Absolute, out var uri) &&\n                   (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase));\n        }\n\n        private static bool IsLikelyPhone(string? s)\n        {\n            if (string.IsNullOrWhiteSpace(s)) return false;\n            var digits = s.Count(char.IsDigit);\n            return digits >= 10 && digits <= 15 && s.StartsWith(\"+\");\n        }\n    }\n}"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/TemplatePayloadBuilder.cs",
      "sha256": "a17c0dcb06ca9a2513070ca37218d5754f877bdf9a59eadefe124ffa30ba3c04",
      "language": "csharp",
      "size": 4995,
      "content": "// Features/CampaignModule/SendEngine/TemplatePayloadBuilder.cs\nusing System;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Collections.Generic;\nusing System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine\n{\n    public interface ITemplatePayloadBuilder\n    {\n        TemplateEnvelope Build(SendPlan plan, RecipientPlan r);\n    }\n\n    public sealed class TemplatePayloadBuilder : ITemplatePayloadBuilder\n    {\n        // Back-compat for legacy CSV/header names:\n        //   headerpara1     => header.text_param1\n        //   buttonpara2     => button2.url_param\n        private static readonly Regex RxHeaderPara = new(@\"^headerpara(\\d+)$\",\n            RegexOptions.IgnoreCase | RegexOptions.Compiled);\n        private static readonly Regex RxButtonPara = new(@\"^buttonpara(\\d+)$\",\n            RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n        private static string CanonicalizeKey(string key)\n        {\n            if (string.IsNullOrWhiteSpace(key)) return string.Empty;\n            key = key.Trim();\n\n            var m1 = RxHeaderPara.Match(key);\n            if (m1.Success) return $\"header.text_param{m1.Groups[1].Value}\";\n\n            var m2 = RxButtonPara.Match(key);\n            if (m2.Success) return $\"button{m2.Groups[1].Value}.url_param\";\n\n            return key; // already canonical (parameterN, header.text_paramN, buttonX.url_param, named tokens, etc.)\n        }\n\n        private static Dictionary<string, string> NormalizeKeys(Dictionary<string, string> dict)\n        {\n            var res = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var kv in dict)\n            {\n                var canon = CanonicalizeKey(kv.Key);\n                res[canon] = kv.Value ?? string.Empty;\n            }\n            return res;\n        }\n\n        public TemplateEnvelope Build(SendPlan plan, RecipientPlan r)\n        {\n            var bodyParams = DeserializeStringArray(r.ParametersJson);\n\n            // Parse per-recipient extras (header + button params live here)\n            var origJson = r.ButtonParamsJson ?? \"{}\";\n            var looksLikeList = LooksLikeJsonArray(origJson);\n\n            // If dict ‚Üí normalize legacy keys; if list ‚Üí keep as-is (we'll align Pinnacle in Step 4)\n            var perRecipientDict = DeserializeDict(looksLikeList ? \"{}\" : origJson);\n            var perRecipient = NormalizeKeys(perRecipientDict);\n\n            // Accept both styles: \"header.text.1\" and \"header.text_param1\"\n            var headerParams =\n                ExtractOrdered(perRecipient, \"header.text.\")\n                .Concat(ExtractOrdered(perRecipient, \"header.text_param\"))\n                .ToArray();\n\n            // If input was a dict, write back normalized dict so mappers see canonical keys.\n            // If input was a list, preserve original JSON to avoid breaking current Pinnacle behavior.\n            var outButtonParamsJson = looksLikeList\n                ? origJson\n                : JsonSerializer.Serialize(perRecipient);\n\n            return new TemplateEnvelope(\n                HeaderKind: plan.HeaderKind,\n                HeaderParams: headerParams,\n                HeaderUrl: plan.HeaderUrl,\n                BodyParams: bodyParams,\n                Buttons: plan.Buttons,\n                PerRecipientButtonParamsJson: outButtonParamsJson\n            );\n        }\n\n        private static bool LooksLikeJsonArray(string json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return false;\n            for (int i = 0; i < json.Length; i++)\n            {\n                var ch = json[i];\n                if (char.IsWhiteSpace(ch)) continue;\n                return ch == '['; // first non-space\n            }\n            return false;\n        }\n\n        private static string[] DeserializeStringArray(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return Array.Empty<string>();\n            try { return JsonSerializer.Deserialize<string[]>(json!) ?? Array.Empty<string>(); }\n            catch { return Array.Empty<string>(); }\n        }\n\n        private static Dictionary<string, string> DeserializeDict(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return new();\n            try { return JsonSerializer.Deserialize<Dictionary<string, string>>(json!) ?? new(); }\n            catch { return new(); }\n        }\n\n        private static string[] ExtractOrdered(Dictionary<string, string> dict, string prefix)\n        {\n            return dict\n                .Where(kv => kv.Key.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))\n                .Select(kv => (Idx: TryIndex(kv.Key, prefix), Val: kv.Value))\n                .Where(x => x.Idx > 0)\n                .OrderBy(x => x.Idx)\n                .Select(x => x.Val)\n                .ToArray();\n\n            static int TryIndex(string key, string prefix)\n                => int.TryParse(key.AsSpan(prefix.Length), out var i) ? i : -1;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignAudienceAttachmentService.cs",
      "sha256": "0af5180168abc9453bb1e71724e06c383a44842d4ff086f98c2a3bb26f5ca7b9",
      "language": "csharp",
      "size": 36585,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Helpers;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Owns campaign CSV audience attachment lifecycle:\n    /// - preserves attachment history (deactivate, never delete)\n    /// - enforces \"sent-lock\" (409 once any send occurred)\n    /// - rebuilds ONLY CSV-derived recipients (AudienceMemberId != null)\n    /// </summary>\n    public sealed class CampaignAudienceAttachmentService : ICampaignAudienceAttachmentService\n    {\n        private readonly AppDbContext _db;\n        private readonly ICsvBatchService _csv;\n        private readonly IVariableResolver _resolver;\n\n        // Common phone header candidates (case-insensitive)\n        private static readonly string[] PhoneHeaderCandidates =\n        {\n            \"phone\", \"mobile\", \"whatsapp\", \"msisdn\", \"whatsapp_number\", \"contact\", \"contact_number\"\n        };\n\n        public CampaignAudienceAttachmentService(AppDbContext db, ICsvBatchService csv, IVariableResolver resolver)\n        {\n            _db = db;\n            _csv = csv;\n            _resolver = resolver;\n        }\n\n        public async Task<CampaignAudienceDto> GetActiveAsync(Guid businessId, Guid campaignId, CancellationToken ct = default)\n        {\n            // Return an \"empty\" DTO rather than 404 so the UI can render \"no attachment\".\n            var (exists, isLocked) = await GetCampaignExistenceAndLockAsync(businessId, campaignId, ct);\n            if (!exists) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            var active = await _db.CampaignAudienceAttachments\n                .AsNoTracking()\n                .Where(a => a.BusinessId == businessId && a.CampaignId == campaignId && a.IsActive)\n                .Select(a => new\n                {\n                    a.Id,\n                    a.AudienceId,\n                    AudienceName = a.Audience.Name,\n                    a.CsvBatchId,\n                    a.FileName,\n                    a.CreatedAt\n                })\n                .FirstOrDefaultAsync(ct);\n\n            if (active == null)\n                return new CampaignAudienceDto { IsLocked = isLocked };\n\n            var memberCount = await _db.AudienceMembers\n                .AsNoTracking()\n                .Where(m => m.BusinessId == businessId && m.AudienceId == active.AudienceId && !m.IsDeleted)\n                .CountAsync(ct);\n\n            return new CampaignAudienceDto\n            {\n                AttachmentId = active.Id,\n                AudienceId = active.AudienceId,\n                AudienceName = active.AudienceName,\n                CsvBatchId = active.CsvBatchId,\n                FileName = active.FileName,\n                CreatedAt = active.CreatedAt,\n                MemberCount = memberCount,\n                IsLocked = isLocked\n            };\n        }\n\n        public async Task<IReadOnlyList<CampaignAudienceHistoryItemDto>> GetHistoryAsync(Guid businessId, Guid campaignId, CancellationToken ct = default)\n        {\n            var (exists, _) = await GetCampaignExistenceAndLockAsync(businessId, campaignId, ct);\n            if (!exists) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            return await _db.CampaignAudienceAttachments\n                .AsNoTracking()\n                .Where(a => a.BusinessId == businessId && a.CampaignId == campaignId)\n                .OrderByDescending(a => a.CreatedAt)\n                .Select(a => new CampaignAudienceHistoryItemDto\n                {\n                    AttachmentId = a.Id,\n                    AudienceId = a.AudienceId,\n                    AudienceName = a.Audience.Name,\n                    CsvBatchId = a.CsvBatchId,\n                    FileName = a.FileName,\n                    IsActive = a.IsActive,\n                    CreatedAt = a.CreatedAt,\n                    DeactivatedAt = a.DeactivatedAt,\n                    DeactivatedBy = a.DeactivatedBy\n                })\n                .ToListAsync(ct);\n        }\n\n        public async Task<CampaignAudienceReplaceResponseDto> ReplaceAsync(\n            Guid businessId,\n            Guid campaignId,\n            IFormFile csvFile,\n            string? audienceName,\n            string actor,\n            CancellationToken ct = default)\n        {\n            if (csvFile == null || csvFile.Length <= 0)\n                throw new ArgumentException(\"CSV file is required.\", nameof(csvFile));\n\n            // 1) Sent-lock & ownership check first so we do not ingest/allocate data for a locked campaign.\n            await EnsureAudienceNotLockedAsync(businessId, campaignId, ct);\n\n            // 2) Ingest into CsvBatch/CsvRows (reusing the existing ingestion pipeline).\n            await using var stream = csvFile.OpenReadStream();\n            var upload = await _csv.CreateAndIngestAsync(\n                businessId: businessId,\n                fileName: csvFile.FileName,\n                stream: stream,\n                audienceId: null,\n                campaignId: null, // IMPORTANT: attachment replacement is owned by this service, not by CSV ingest\n                ct: ct);\n\n            // 3) Materialize rows from the just-uploaded batch and persist it as the active attachment.\n            var req = new CampaignCsvMaterializeRequestDto\n            {\n                CsvBatchId = upload.BatchId,\n                Persist = true,\n                AudienceName = string.IsNullOrWhiteSpace(audienceName)\n                    ? $\"{Path.GetFileNameWithoutExtension(csvFile.FileName)} (CSV)\"\n                    : audienceName,\n                NormalizePhones = true,\n                Deduplicate = true,\n                Limit = null, // Persist should use ALL rows\n                PhoneField = null,\n                Mappings = null\n            };\n\n            var materialized = await MaterializeBatchAsync(businessId, campaignId, req, ct);\n            return await ReplaceFromMaterializationAsync(businessId, campaignId, req, materialized.Preview, actor, ct);\n        }\n\n        public async Task<CampaignAudienceRemoveResponseDto> RemoveAsync(Guid businessId, Guid campaignId, string actor, CancellationToken ct = default)\n        {\n            await EnsureAudienceNotLockedAsync(businessId, campaignId, ct);\n\n            await using var tx = await _db.Database.BeginTransactionAsync(ct);\n            try\n            {\n                var now = DateTime.UtcNow;\n\n                // Deactivate active attachment (history preserved). No-op if none exists.\n                var active = await _db.CampaignAudienceAttachments\n                    .Where(a => a.BusinessId == businessId && a.CampaignId == campaignId && a.IsActive)\n                    .FirstOrDefaultAsync(ct);\n\n                if (active != null)\n                {\n                    active.IsActive = false;\n                    active.DeactivatedAt = now;\n                    active.DeactivatedBy = actor;\n                }\n\n                // Delete ONLY CSV-derived recipients; keep manual assignments intact.\n                var deleted = await _db.CampaignRecipients\n                    .Where(r => r.BusinessId == businessId && r.CampaignId == campaignId && r.AudienceMemberId != null)\n                    .ExecuteDeleteAsync(ct);\n\n                await _db.SaveChangesAsync(ct);\n                await tx.CommitAsync(ct);\n\n                return new CampaignAudienceRemoveResponseDto\n                {\n                    Active = new CampaignAudienceDto { IsLocked = false },\n                    CsvRecipientsDeleted = deleted\n                };\n            }\n            catch\n            {\n                await tx.RollbackAsync(ct);\n                throw;\n            }\n        }\n\n        public async Task<CampaignAudienceReplaceResponseDto> ReplaceFromMaterializationAsync(\n            Guid businessId,\n            Guid campaignId,\n            CampaignCsvMaterializeRequestDto request,\n            IReadOnlyList<CsvMaterializedRowDto> materializedRows,\n            string actor,\n            CancellationToken ct = default)\n        {\n            if (request == null) throw new ArgumentNullException(nameof(request));\n            if (request.CsvBatchId == Guid.Empty) throw new ArgumentException(\"CsvBatchId is required.\", nameof(request));\n            if (string.IsNullOrWhiteSpace(request.AudienceName))\n                throw new ArgumentException(\"AudienceName is required when persisting.\", nameof(request));\n\n            await EnsureAudienceNotLockedAsync(businessId, campaignId, ct);\n\n            // Persist attachment + recipients atomically.\n            await using var tx = await _db.Database.BeginTransactionAsync(ct);\n            try\n            {\n                var now = DateTime.UtcNow;\n\n                // Load batch (for filename) and ensure tenant ownership.\n                var batch = await _db.CsvBatches\n                    .FirstOrDefaultAsync(b => b.Id == request.CsvBatchId && b.BusinessId == businessId, ct);\n                if (batch == null) throw new KeyNotFoundException(\"CSV batch not found.\");\n\n                // 1) Deactivate current active attachment (history row remains) - required for \"replace\".\n                var active = await _db.CampaignAudienceAttachments\n                    .Where(a => a.BusinessId == businessId && a.CampaignId == campaignId && a.IsActive)\n                    .FirstOrDefaultAsync(ct);\n\n                if (active != null)\n                {\n                    active.IsActive = false;\n                    active.DeactivatedAt = now;\n                    active.DeactivatedBy = actor;\n                }\n\n                // 2) Create a new Audience that represents the materialized snapshot for this campaign.\n                var audience = new Audience\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = request.AudienceName!.Trim(),\n                    CsvBatchId = batch.Id,\n                    CreatedAt = now,\n                    UpdatedAt = now,\n                    IsDeleted = false\n                };\n                _db.Audiences.Add(audience);\n\n                // Keep batch -> audience aligned for later export/debug.\n                batch.AudienceId = audience.Id;\n\n                // 3) Rebuild recipients (CSV only) and create AudienceMembers for the new Audience.\n                // IMPORTANT: Do NOT touch manual recipients (ContactId != null && AudienceMemberId == null).\n                var deleted = await _db.CampaignRecipients\n                    .Where(r => r.BusinessId == businessId && r.CampaignId == campaignId && r.AudienceMemberId != null)\n                    .ExecuteDeleteAsync(ct);\n\n                // Avoid duplicates against manual recipients (best effort by normalized phone).\n                var existingManualPhones = await GetExistingManualRecipientPhonesAsync(_db, businessId, campaignId, ct);\n\n                var phones = materializedRows\n                    .Select(r => NormalizePhoneDigits(r.Phone))\n                    .Where(p => !string.IsNullOrWhiteSpace(p))\n                    .Distinct(StringComparer.Ordinal)\n                    .ToList();\n\n                var contactByPhone = await LoadContactsByPhoneAsync(businessId, phones, ct);\n\n                var membersToAdd = new List<AudienceMember>(capacity: phones.Count);\n                var recipientsToAdd = new List<CampaignRecipient>(capacity: phones.Count);\n\n                // Extra safety: always deduplicate inserts by phone, even if request.Deduplicate=false.\n                var seenCsvPhones = new HashSet<string>(StringComparer.Ordinal);\n\n                foreach (var r in materializedRows)\n                {\n                    var phoneDigits = NormalizePhoneDigits(r.Phone);\n                    if (string.IsNullOrWhiteSpace(phoneDigits)) continue;\n\n                    if (existingManualPhones.Contains(phoneDigits))\n                        continue;\n\n                    if (!seenCsvPhones.Add(phoneDigits))\n                        continue;\n\n                    var variables = r.Variables ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n                    // Shapes expected by sender:\n                    var bodyParams = BuildBodyParamArray(variables);\n                    var headerAndButtons = BuildHeaderAndButtonVars(variables);\n\n                    var resolvedParamsJson = JsonSerializer.Serialize(bodyParams);\n                    var resolvedButtonsJson = JsonSerializer.Serialize(headerAndButtons);\n\n                    // Deterministic idempotency per (campaign, phone, resolved params).\n                    var idemPayload = JsonSerializer.Serialize(new { p = bodyParams, b = headerAndButtons });\n                    var idempotencyKey = ComputeIdempotencyKey(campaignId, phoneDigits, idemPayload);\n\n                    contactByPhone.TryGetValue(phoneDigits, out var contactId);\n\n                    var member = new AudienceMember\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        AudienceId = audience.Id,\n                        ContactId = contactId,\n                        PhoneE164 = phoneDigits,\n                        PhoneRaw = null,\n                        AttributesJson = JsonSerializer.Serialize(variables),\n                        IsTransientContact = !contactId.HasValue,\n                        IsDeleted = false,\n                        CreatedAt = now,\n                        UpdatedAt = now\n                    };\n\n                    membersToAdd.Add(member);\n\n                    var recipient = new CampaignRecipient\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        CampaignId = campaignId,\n                        AudienceMemberId = member.Id,\n                        ContactId = contactId,\n                        IdempotencyKey = idempotencyKey,\n                        ResolvedParametersJson = resolvedParamsJson,\n                        ResolvedButtonUrlsJson = resolvedButtonsJson,\n                        MaterializedAt = now,\n                        SentAt = null,\n                        Status = \"Pending\",\n                        UpdatedAt = now\n                    };\n\n                    recipientsToAdd.Add(recipient);\n                }\n\n                if (membersToAdd.Count > 0)\n                    await _db.AudienceMembers.AddRangeAsync(membersToAdd, ct);\n                if (recipientsToAdd.Count > 0)\n                    await _db.CampaignRecipients.AddRangeAsync(recipientsToAdd, ct);\n\n                // 4) Create new active attachment row.\n                var attach = new CampaignAudienceAttachment\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    CampaignId = campaignId,\n                    AudienceId = audience.Id,\n                    CsvBatchId = batch.Id,\n                    FileName = batch.FileName,\n                    IsActive = true,\n                    CreatedAt = now\n                };\n                _db.CampaignAudienceAttachments.Add(attach);\n\n                await _db.SaveChangesAsync(ct);\n                await tx.CommitAsync(ct);\n\n                Log.Information(\n                    \"Campaign audience replaced | biz={Biz} campaign={Campaign} batch={Batch} deletedCsvRecipients={Deleted} insertedCsvRecipients={Inserted} actor={Actor}\",\n                    businessId, campaignId, batch.Id, deleted, recipientsToAdd.Count, actor);\n\n                return new CampaignAudienceReplaceResponseDto\n                {\n                    Active = new CampaignAudienceDto\n                    {\n                        AttachmentId = attach.Id,\n                        AudienceId = audience.Id,\n                        AudienceName = audience.Name,\n                        CsvBatchId = batch.Id,\n                        FileName = attach.FileName,\n                        CreatedAt = attach.CreatedAt,\n                        MemberCount = membersToAdd.Count,\n                        IsLocked = false\n                    },\n                    CsvRecipientsInserted = recipientsToAdd.Count\n                };\n            }\n            catch\n            {\n                await tx.RollbackAsync(ct);\n                throw;\n            }\n        }\n\n        private async Task EnsureAudienceNotLockedAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            var (exists, locked) = await GetCampaignExistenceAndLockAsync(businessId, campaignId, ct);\n            if (!exists) throw new KeyNotFoundException(\"Campaign not found.\");\n            if (locked) throw new AudienceLockedException();\n        }\n\n        private async Task<(bool exists, bool locked)> GetCampaignExistenceAndLockAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            if (businessId == Guid.Empty) return (false, false);\n            if (campaignId == Guid.Empty) return (false, false);\n\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId && !c.IsDeleted)\n                .Select(c => new { c.Id, c.Status })\n                .FirstOrDefaultAsync(ct);\n\n            if (campaign == null) return (false, false);\n\n            var hasSendLogs = await _db.CampaignSendLogs\n                .AsNoTracking()\n                .AnyAsync(l => l.BusinessId == businessId && l.CampaignId == campaignId, ct);\n\n            var locked = string.Equals(campaign.Status, \"Sent\", StringComparison.OrdinalIgnoreCase) || hasSendLogs;\n            return (true, locked);\n        }\n\n        public sealed class AudienceLockedException : Exception\n        {\n            public AudienceLockedException() : base(\"Audience cannot be changed after sending.\") { }\n        }\n\n        // ---------------- Materialize (shared) ----------------\n        // Used by /audience/replace so it can use the same CSV->variables behavior as /materialize.\n        private async Task<CampaignCsvMaterializeResponseDto> MaterializeBatchAsync(\n            Guid businessId,\n            Guid campaignId,\n            CampaignCsvMaterializeRequestDto request,\n            CancellationToken ct)\n        {\n            var owns = await _db.Campaigns\n                .AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n            if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n            var rowsQuery = _db.CsvRows\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == request.CsvBatchId)\n                .OrderBy(r => r.RowIndex);\n\n            var totalRows = await rowsQuery.CountAsync(ct);\n            var csvRows = await rowsQuery.ToListAsync(ct); // Persist path uses ALL rows\n\n            var resp = new CampaignCsvMaterializeResponseDto\n            {\n                CampaignId = campaignId,\n                CsvBatchId = request.CsvBatchId,\n                TotalRows = totalRows\n            };\n\n            var headerSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var r in csvRows)\n                foreach (var k in JsonToDict(r.DataJson).Keys)\n                    headerSet.Add(k);\n\n            var phoneField = request.PhoneField;\n            if (string.IsNullOrWhiteSpace(phoneField))\n                phoneField = PhoneHeaderCandidates.FirstOrDefault(headerSet.Contains);\n\n            if (string.IsNullOrWhiteSpace(phoneField))\n                resp.Warnings.Add(\"No phone field provided or detected; rows without phone will be skipped.\");\n\n            var requiredBodySlots = await GetRequiredBodySlotsAsync(businessId, campaignId, ct);\n            var namedBodyTokens = await GetNamedBodyTokensAsync(businessId, campaignId, ct);\n\n            var effectiveMappings = request.Mappings ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            var seenPhones = new HashSet<string>(StringComparer.Ordinal);\n\n            foreach (var row in csvRows)\n            {\n                ct.ThrowIfCancellationRequested();\n\n                var rowDict = JsonToDict(row.DataJson);\n                var m = new CsvMaterializedRowDto { RowIndex = row.RowIndex };\n\n                var mappingsToUse =\n                    (effectiveMappings.Count > 0)\n                        ? new Dictionary<string, string>(effectiveMappings, StringComparer.OrdinalIgnoreCase)\n                        : BuildAutoMappingsFromRow(rowDict, requiredBodySlots, namedBodyTokens);\n\n                m.Variables = _resolver.ResolveVariables(rowDict, mappingsToUse);\n\n                string? phoneRaw = null;\n                if (!string.IsNullOrWhiteSpace(phoneField))\n                    rowDict.TryGetValue(phoneField, out phoneRaw);\n                else\n                    foreach (var cand in PhoneHeaderCandidates)\n                        if (rowDict.TryGetValue(cand, out phoneRaw) && !string.IsNullOrWhiteSpace(phoneRaw))\n                            break;\n\n                var phoneDigits = NormalizePhoneDigits(phoneRaw, request.NormalizePhones);\n                m.Phone = phoneDigits;\n\n                if (string.IsNullOrWhiteSpace(m.Phone))\n                {\n                    m.Errors.Add(\"Missing phone\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                if (request.Deduplicate && !seenPhones.Add(m.Phone))\n                {\n                    m.Errors.Add(\"Duplicate phone (deduped)\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                var prelimBodyParams = BuildBodyParamArrayFromVariables(m.Variables);\n                var enforced = EnsureBodyParamsComplete(prelimBodyParams, requiredBodySlots, out var missingSlots);\n                if (enforced == null)\n                {\n                    m.Errors.Add($\"Missing body parameters: {string.Join(\", \", missingSlots)}\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                resp.Preview.Add(m);\n            }\n\n            resp.MaterializedCount = resp.Preview.Count;\n            return resp;\n        }\n\n        private static Dictionary<string, string> JsonToDict(string? json)\n        {\n            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            if (string.IsNullOrWhiteSpace(json)) return dict;\n\n            using var doc = JsonDocument.Parse(json);\n            if (doc.RootElement.ValueKind != JsonValueKind.Object) return dict;\n            foreach (var p in doc.RootElement.EnumerateObject())\n                dict[p.Name] = p.Value.ValueKind == JsonValueKind.Null ? \"\" : p.Value.ToString();\n\n            return dict;\n        }\n\n        // Canonical \"digits-only\" E.164-ish normalization (no leading '+'), aligned with other backend validators.\n        private static string? NormalizePhoneDigits(string? raw, bool normalize = true)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n            if (!normalize) return raw.Trim();\n            return PhoneNumberNormalizer.NormalizeToE164Digits(raw, \"IN\");\n        }\n\n        private static string NormalizePhoneDigits(string? raw)\n            => NormalizePhoneDigits(raw, normalize: true) ?? string.Empty;\n\n        private static string ComputeIdempotencyKey(Guid campaignId, string phoneDigits, string parametersJson)\n        {\n            var raw = $\"{campaignId}|{phoneDigits}|{parametersJson}\";\n            using var sha = SHA256.Create();\n            var bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(raw));\n            return Convert.ToHexString(bytes);\n        }\n\n        private static string[] BuildBodyParamArrayFromVariables(IDictionary<string, string> vars)\n        {\n            var pairs = new List<(int idx, string val)>();\n            foreach (var kv in vars)\n            {\n                var k = kv.Key;\n                var v = kv.Value ?? string.Empty;\n\n                if (k.StartsWith(\"body.\", StringComparison.OrdinalIgnoreCase) &&\n                    int.TryParse(k.AsSpan(\"body.\".Length), out var n1) && n1 > 0)\n                {\n                    pairs.Add((n1, v));\n                    continue;\n                }\n\n                if (k.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase) &&\n                    int.TryParse(k.AsSpan(\"parameter\".Length), out var n2) && n2 > 0)\n                {\n                    pairs.Add((n2, v));\n                }\n\n                var m = Regex.Match(k, @\"^\\{\\{\\s*(\\d+)\\s*\\}\\}$\");\n                if (m.Success && int.TryParse(m.Groups[1].Value, out var t) && t > 0)\n                {\n                    pairs.Add((t, v));\n                }\n            }\n\n            if (pairs.Count == 0) return Array.Empty<string>();\n\n            var max = pairs.Max(p => p.idx);\n            var arr = new string[max];\n            for (int i = 0; i < max; i++) arr[i] = string.Empty;\n            foreach (var (idx, val) in pairs) arr[idx - 1] = val ?? string.Empty;\n            return arr;\n        }\n\n        private static string[]? EnsureBodyParamsComplete(string[] bodyParams, int requiredSlots, out List<string> missing)\n        {\n            missing = new List<string>();\n            if (requiredSlots <= 0) return bodyParams;\n\n            var arr = new string[requiredSlots];\n            for (int i = 0; i < requiredSlots; i++)\n            {\n                var v = (i < bodyParams.Length ? bodyParams[i] : string.Empty) ?? string.Empty;\n                arr[i] = v;\n                if (string.IsNullOrWhiteSpace(v))\n                    missing.Add($\"{{{{{i + 1}}}}}\");\n            }\n\n            return missing.Count > 0 ? null : arr;\n        }\n\n        private static string[] BuildBodyParamArray(IDictionary<string, string> vars)\n        {\n            var pairs = new List<(int idx, string val)>();\n\n            foreach (var kv in vars)\n            {\n                var k = kv.Key;\n\n                if (k.StartsWith(\"body.\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (int.TryParse(k.AsSpan(\"body.\".Length), out var n) && n > 0)\n                        pairs.Add((n, kv.Value ?? string.Empty));\n                    continue;\n                }\n\n                if (k.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (int.TryParse(k.AsSpan(\"parameter\".Length), out var n) && n > 0)\n                        pairs.Add((n, kv.Value ?? string.Empty));\n                }\n            }\n\n            if (pairs.Count == 0) return Array.Empty<string>();\n\n            var max = pairs.Max(p => p.idx);\n            var arr = new string[max];\n            for (int i = 0; i < max; i++) arr[i] = string.Empty;\n            foreach (var (idx, val) in pairs) arr[idx - 1] = val ?? string.Empty;\n            return arr;\n        }\n\n        private static Dictionary<string, string> BuildHeaderAndButtonVars(IDictionary<string, string> vars)\n        {\n            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            foreach (var kv in vars)\n            {\n                var k = kv.Key;\n                var v = kv.Value ?? string.Empty;\n\n                if (k.StartsWith(\"header.\", StringComparison.OrdinalIgnoreCase) &&\n                    (k.EndsWith(\"_url\", StringComparison.OrdinalIgnoreCase) ||\n                     k.EndsWith(\".url\", StringComparison.OrdinalIgnoreCase)))\n                {\n                    dict[k] = v;\n                    continue;\n                }\n\n                if (k.StartsWith(\"header.text.\", StringComparison.OrdinalIgnoreCase))\n                {\n                    var tail = k.Substring(\"header.text.\".Length);\n                    if (int.TryParse(tail, out var n) && n > 0)\n                        dict[k] = v;\n                    continue;\n                }\n\n                if (k.StartsWith(\"button\", StringComparison.OrdinalIgnoreCase))\n                {\n                    var normKey = k\n                        .Replace(\".url.param\", \".url_param\", StringComparison.OrdinalIgnoreCase)\n                        .Replace(\".urlparam\", \".url_param\", StringComparison.OrdinalIgnoreCase);\n\n                    if (normKey.EndsWith(\".url_param\", StringComparison.OrdinalIgnoreCase))\n                        dict[normKey] = v;\n                }\n            }\n\n            return dict;\n        }\n\n        private static Dictionary<string, string> BuildAutoMappingsFromRow(\n            IDictionary<string, string> rowDict,\n            int requiredBodySlots,\n            IReadOnlyCollection<string>? namedBodyTokens = null)\n        {\n            var map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            int n = requiredBodySlots > 0\n                ? requiredBodySlots\n                : rowDict.Keys.Select(k =>\n                {\n                    var m = Regex.Match(k, @\"^parameter(\\d+)$\", RegexOptions.IgnoreCase);\n                    return m.Success ? int.Parse(m.Groups[1].Value) : 0;\n                }).DefaultIfEmpty(0).Max();\n\n            for (int i = 1; i <= n; i++)\n            {\n                var csvHeader = rowDict.Keys.FirstOrDefault(k => string.Equals(k, $\"parameter{i}\", StringComparison.OrdinalIgnoreCase));\n                if (!string.IsNullOrWhiteSpace(csvHeader))\n                    map[$\"{{{{{i}}}}}\"] = csvHeader;\n            }\n\n            if (namedBodyTokens != null && namedBodyTokens.Count > 0)\n            {\n                foreach (var token in namedBodyTokens)\n                {\n                    var csvHeader = rowDict.Keys.FirstOrDefault(k => string.Equals(k, token, StringComparison.OrdinalIgnoreCase));\n                    if (!string.IsNullOrWhiteSpace(csvHeader))\n                        map[$\"{{{{{token}}}}}\"] = csvHeader;\n                }\n            }\n\n            foreach (var kv in rowDict)\n            {\n                var m = Regex.Match(kv.Key, @\"^headerpara(\\d+)$\", RegexOptions.IgnoreCase);\n                if (m.Success)\n                {\n                    var slot = int.Parse(m.Groups[1].Value);\n                    map[$\"header.text_param{slot}\"] = kv.Key;\n                }\n            }\n\n            foreach (var kv in rowDict)\n            {\n                var m = Regex.Match(kv.Key, @\"^buttonpara(\\d+)$\", RegexOptions.IgnoreCase);\n                if (m.Success)\n                {\n                    var pos = int.Parse(m.Groups[1].Value);\n                    if (pos >= 1 && pos <= 3)\n                        map[$\"button{pos}.url_param\"] = kv.Key;\n                }\n            }\n\n            return map;\n        }\n\n        private async Task<int> GetRequiredBodySlotsAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            var snap = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.TemplateId, c.MessageTemplate })\n                .FirstOrDefaultAsync(ct);\n\n            if (snap is null) return 0;\n\n            WhatsAppTemplate? tpl = null;\n            if (!string.IsNullOrWhiteSpace(snap.TemplateId))\n            {\n                tpl = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == snap.TemplateId)\n                    .OrderByDescending(t => t.UpdatedAt)\n                    .ThenByDescending(t => t.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            if (tpl == null && !string.IsNullOrWhiteSpace(snap.MessageTemplate))\n            {\n                tpl = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == snap.MessageTemplate)\n                    .OrderByDescending(t => t.UpdatedAt)\n                    .ThenByDescending(t => t.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            return tpl?.BodyVarCount ?? 0;\n        }\n\n        private async Task<IReadOnlyList<string>> GetNamedBodyTokensAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            var data = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.MessageTemplate, c.TemplateId })\n                .FirstOrDefaultAsync(ct);\n\n            var templateName = !string.IsNullOrWhiteSpace(data?.TemplateId)\n                ? data!.TemplateId!\n                : (data?.MessageTemplate ?? string.Empty);\n\n            if (string.IsNullOrWhiteSpace(templateName))\n                return Array.Empty<string>();\n\n            var tpl = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == templateName)\n                .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (tpl == null) return Array.Empty<string>();\n\n            var summary = xbytechat.api.WhatsAppSettings.Helpers.TemplateJsonHelper\n                .SummarizeDetailed(tpl.RawJson, tpl.Body);\n\n            return summary.Placeholders\n                .Where(p => p.Location == xbytechat.api.WhatsAppSettings.Helpers.PlaceholderLocation.Body\n                         && p.Type == xbytechat.api.WhatsAppSettings.Helpers.PlaceholderType.Named)\n                .Select(p => p.Name!)\n                .Where(n => !string.IsNullOrWhiteSpace(n))\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)\n                .ToList();\n        }\n\n        private static async Task<HashSet<string>> GetExistingManualRecipientPhonesAsync(\n            AppDbContext db,\n            Guid businessId,\n            Guid campaignId,\n            CancellationToken ct)\n        {\n            // Manual recipients are assigned by Contact (AudienceMemberId == null). We keep them untouched,\n            // and also avoid inserting a CSV-derived duplicate for the same normalized phone.\n            var contactPhones = await db.CampaignRecipients\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.CampaignId == campaignId && r.AudienceMemberId == null && r.ContactId != null)\n                .Join(db.Contacts.AsNoTracking(),\n                    r => r.ContactId!.Value,\n                    c => c.Id,\n                    (r, c) => c.PhoneNumber)\n                .ToListAsync(ct);\n\n            var set = new HashSet<string>(StringComparer.Ordinal);\n            foreach (var p in contactPhones)\n            {\n                var norm = PhoneNumberNormalizer.NormalizeToE164Digits(p, \"IN\");\n                if (!string.IsNullOrWhiteSpace(norm)) set.Add(norm);\n            }\n\n            return set;\n        }\n\n        private async Task<Dictionary<string, Guid?>> LoadContactsByPhoneAsync(Guid businessId, IReadOnlyList<string> phoneDigits, CancellationToken ct)\n        {\n            var result = new Dictionary<string, Guid?>(StringComparer.Ordinal);\n            if (phoneDigits.Count == 0) return result;\n\n            var candidates = phoneDigits\n                .SelectMany(p => new[] { p, \"+\" + p })\n                .Distinct()\n                .ToList();\n\n            var contacts = await _db.Contacts\n                .AsNoTracking()\n                .Where(c => c.BusinessId == businessId && candidates.Contains(c.PhoneNumber))\n                .Select(c => new { c.Id, c.PhoneNumber })\n                .ToListAsync(ct);\n\n            foreach (var c in contacts)\n            {\n                var norm = PhoneNumberNormalizer.NormalizeToE164Digits(c.PhoneNumber, \"IN\");\n                if (string.IsNullOrWhiteSpace(norm)) continue;\n                result[norm] = c.Id;\n            }\n\n            return result;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDeletionResult.cs",
      "sha256": "710f394b8a1c578edc909b649fe696c5ad9a3bd0fa7d33ea7fba8fc1fe2f21b3",
      "language": "csharp",
      "size": 1270,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n\n    public sealed class CampaignDeletionOptions { public bool Force { get; set; } }\n\n    public enum CampaignDeletionStatus\n    {\n        Deleted,\n        NotFound,\n        BlockedSending,\n        BlockedState,\n        Error\n    }\n\n    public sealed class CampaignDeletionResult\n    {\n        public CampaignDeletionStatus Status { get; init; }\n        public int Recipients { get; init; }\n        public int QueuedJobs { get; init; }\n        public int SendLogs { get; init; }\n\n        public static CampaignDeletionResult Deleted(int r, int q, int s)\n            => new() { Status = CampaignDeletionStatus.Deleted, Recipients = r, QueuedJobs = q, SendLogs = s };\n\n        public static CampaignDeletionResult NotFound()\n            => new() { Status = CampaignDeletionStatus.NotFound };\n\n        public static CampaignDeletionResult BlockedSending(int r, int q, int s)\n            => new() { Status = CampaignDeletionStatus.BlockedSending, Recipients = r, QueuedJobs = q, SendLogs = s };\n\n        public static CampaignDeletionResult BlockedState(int r, int q, int s)\n            => new() { Status = CampaignDeletionStatus.BlockedState, Recipients = r, QueuedJobs = q, SendLogs = s };\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDispatcher.cs",
      "sha256": "3d2dde021dad6913b85c106875271d20afbd73a861509db2c8b98c8fd676b336",
      "language": "csharp",
      "size": 9628,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n// DO NOT import a different interface namespace; the interface is in this same namespace.\nusing xbytechat.api.Features.Queueing.DTOs;     // OutboundCampaignJobCreateDto\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Picks materialized recipients (MaterializedAt != null) in a stable order,\n    /// filters to \"ready\" statuses, and enqueues send jobs via your outbound queue.\n    /// </summary>\n    public sealed class CampaignDispatcher : ICampaignDispatcher\n    {\n        private readonly AppDbContext _db;\n        private readonly IOutboundCampaignQueueService _queue; // interface is in this same namespace\n\n        // If you use enums, map these accordingly.\n        private static readonly string[] ReadyStatuses = { \"Pending\", \"Ready\" };\n\n        public CampaignDispatcher(AppDbContext db, IOutboundCampaignQueueService queue)\n        {\n            _db = db;\n            _queue = queue;\n        }\n\n        //public async Task<CampaignDispatchResponseDto> DispatchAsync(\n        //    Guid businessId,\n        //    Guid campaignId,\n        //    string mode,\n        //    int count,\n        //    CancellationToken ct = default)\n        //{\n        //    if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n        //    if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n        //    mode = (mode ?? \"canary\").Trim().ToLowerInvariant();\n        //    if (mode != \"canary\" && mode != \"full\") mode = \"canary\";\n        //    if (count <= 0) count = 25;\n\n        //    // 1) Sanity: ownership\n        //    var owns = await _db.Campaigns.AsNoTracking()\n        //        .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n        //    if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n        //    // 2) Base recipients query (materialized + ready)\n        //    var baseQuery = _db.CampaignRecipients.AsNoTracking()\n        //        .Where(r => r.BusinessId == businessId\n        //                 && r.CampaignId == campaignId\n        //                 && r.MaterializedAt != null\n        //                 && ReadyStatuses.Contains(r.Status));\n\n        //    // 3) Stable order: oldest materialized first; then Id as tiebreaker\n        //    baseQuery = baseQuery.OrderBy(r => r.MaterializedAt).ThenBy(r => r.Id);\n\n        //    // 4) Select candidates (slightly over-select; queue dedupes)\n        //    var desired = mode == \"canary\" ? count : int.MaxValue;\n        //    var take = Math.Min(desired * 2, 5000);\n        //    var candidates = await baseQuery.Take(take).ToListAsync(ct);\n\n        //    // --- Build queue jobs ---\n        //    var jobs = new List<OutboundCampaignJobCreateDto>(candidates.Count);\n        //    foreach (var r in candidates)\n        //    {\n        //        jobs.Add(new OutboundCampaignJobCreateDto\n        //        {\n        //            BusinessId = businessId,\n        //            CampaignId = campaignId,\n        //            CampaignRecipientId = r.Id,\n        //            IdempotencyKey = r.IdempotencyKey\n        //        });\n        //    }\n\n        //    // 5) Enqueue (no-op adapter will just count)\n        //    var enqueued = await _queue.EnqueueBulkAsync(jobs, ct);\n\n        //    // --- Prepare response ---\n\n        //    // Fetch phones for the sample (phone is on AudienceMember, not CampaignRecipient)\n        //    var memberIds = candidates\n        //        .Where(r => r.AudienceMemberId.HasValue)\n        //        .Select(r => r.AudienceMemberId!.Value)\n        //        .Distinct()\n        //        .ToList();\n\n        //    var phoneByMemberId = await _db.AudiencesMembers.AsNoTracking()\n        //        .Where(m => m.BusinessId == businessId && memberIds.Contains(m.Id))\n        //        .Select(m => new { m.Id, m.PhoneE164 })\n        //        .ToDictionaryAsync(x => x.Id, x => x.PhoneE164, ct);\n\n        //    var resp = new CampaignDispatchResponseDto\n        //    {\n        //        CampaignId = campaignId,\n        //        Mode = mode,\n        //        RequestedCount = count,\n        //        SelectedCount = candidates.Count,\n        //        EnqueuedCount = enqueued,\n        //        Sample = candidates\n        //            .Take(10)\n        //            .Select(r => new DispatchedRecipientDto\n        //            {\n        //                RecipientId = r.Id,\n        //                Phone = (r.AudienceMemberId.HasValue &&\n        //                         phoneByMemberId.TryGetValue(r.AudienceMemberId.Value, out var p))\n        //                            ? p\n        //                            : null,\n        //                Status = r.Status,\n        //                MaterializedAt = r.MaterializedAt,\n        //                IdempotencyKey = r.IdempotencyKey\n        //            })\n        //            .ToList()\n        //    };\n\n        //    if (mode == \"full\")\n        //    {\n        //        resp.Warnings.Add(\"Full dispatch requested; rate limiting/backoff is enforced by the worker/queue.\");\n        //    }\n\n        //    Log.Information(\"Dispatch queued {@Summary}\", new\n        //    {\n        //        businessId,\n        //        campaignId,\n        //        mode,\n        //        requested = count,\n        //        selected = candidates.Count,\n        //        enqueued\n        //    });\n\n        //    return resp;\n        //}\n\n        public async Task<CampaignDispatchResponseDto> DispatchAsync(\n    Guid businessId,\n    Guid campaignId,\n    string mode,\n    int count,\n    CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n            mode = (mode ?? \"canary\").Trim().ToLowerInvariant();\n            if (mode != \"canary\" && mode != \"full\") mode = \"canary\";\n            if (count <= 0) count = 25;\n\n            var owns = await _db.Campaigns.AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n            if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n            var baseQuery = _db.CampaignRecipients.AsNoTracking()\n                .Where(r => r.BusinessId == businessId\n                         && r.CampaignId == campaignId\n                         && r.MaterializedAt != null\n                         && ReadyStatuses.Contains(r.Status))\n                .OrderBy(r => r.MaterializedAt).ThenBy(r => r.Id);\n\n            var desired = mode == \"canary\" ? count : int.MaxValue;\n            var take = Math.Min(desired * 2, 5000);\n            var candidates = await baseQuery.Take(take).ToListAsync(ct);\n\n            var jobs = new List<OutboundCampaignJobCreateDto>(candidates.Count);\n            foreach (var r in candidates)\n            {\n                jobs.Add(new OutboundCampaignJobCreateDto\n                {\n                    BusinessId = businessId,\n                    CampaignId = campaignId,\n                    CampaignRecipientId = r.Id,\n                    IdempotencyKey = r.IdempotencyKey\n                });\n            }\n            var enqueued = await _queue.EnqueueBulkAsync(jobs, ct);\n\n            // ---- CHANGED: AudienceMemberId is Guid (non-nullable)\n            //var memberIds = candidates\n            //    .Select(r => r.AudienceMemberId)\n            //    .Distinct()\n            //    .ToHashSet(); // perf for Contains\n\n            var memberIds = candidates\n    .Where(r => r.AudienceMemberId.HasValue)\n    .Select(r => r.AudienceMemberId!.Value)\n    .Distinct()\n    .ToHashSet();\n\n            var phoneByMemberId = await _db.AudienceMembers   // or _db.AudiencesMembers if that's your DbSet\n      .AsNoTracking()\n      .Where(m => m.BusinessId == businessId && memberIds.Contains(m.Id))\n      .Select(m => new { m.Id, m.PhoneE164 })\n      .ToDictionaryAsync(x => x.Id, x => x.PhoneE164, ct);\n\n            var resp = new CampaignDispatchResponseDto\n            {\n                CampaignId = campaignId,\n                Mode = mode,\n                RequestedCount = count,\n                SelectedCount = candidates.Count,\n                EnqueuedCount = enqueued,\n                Sample = candidates\n                .Take(10)\n                .Select(r => new DispatchedRecipientDto\n                {\n                    RecipientId = r.Id,\n                    Phone = (r.AudienceMemberId.HasValue &&\n                             phoneByMemberId.TryGetValue(r.AudienceMemberId.Value, out var p))\n                                ? p\n                                : null,\n                    Status = r.Status,\n                    MaterializedAt = r.MaterializedAt,\n                    IdempotencyKey = r.IdempotencyKey\n                })\n                .ToList()\n            };\n\n            if (mode == \"full\")\n                resp.Warnings.Add(\"Full dispatch requested; rate limiting/backoff is enforced by the worker/queue.\");\n\n            Log.Information(\"Dispatch queued {@Summary}\", new { businessId, campaignId, mode, requested = count, selected = candidates.Count, enqueued });\n            return resp;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDispatchPlannerService.cs",
      "sha256": "fe613afed24f76c48409b379b1e82e36e259c41afe57aacb1122ace6dff1ea83",
      "language": "csharp",
      "size": 8973,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignDispatchPlannerService\n    {\n        /// <summary>\n        /// Build a read-only dispatch plan: batches, offsets, size estimates, and throttle summary.\n        /// No messages are sent and no DB writes are performed.\n        /// </summary>\n        Task<CampaignDispatchPlanResultDto> PlanAsync(Guid businessId, Guid campaignId, int limit = 2000, CancellationToken ct = default);\n    }\n\n    /// <summary>\n    /// Computes batch plan from materialized rows with simple throttling:\n    /// - Derives batch size and per-minute cap from Business.Plan (fallback defaults).\n    /// - Slices rows into batches and schedules offsets (seconds) so per-minute cap is respected.\n    /// - Approximates payload size per row/batch for sanity checks.\n    /// </summary>\n    public class CampaignDispatchPlannerService : ICampaignDispatchPlannerService\n    {\n        private readonly AppDbContext _db;\n        private readonly ICampaignMaterializationService _materializer;\n\n        public CampaignDispatchPlannerService(AppDbContext db, ICampaignMaterializationService materializer)\n        {\n            _db = db;\n            _materializer = materializer;\n        }\n\n        public async Task<CampaignDispatchPlanResultDto> PlanAsync(Guid businessId, Guid campaignId, int limit = 2000, CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"CampaignId is required.\");\n\n            // Load campaign shell for meta\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct)\n                ?? throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Materialize (reuses Step 2.11) ‚Äî read-only\n            var mat = await _materializer.MaterializeAsync(businessId, campaignId, limit, ct);\n\n            // Business plan & provider heuristics (non-fatal if missing)\n            var biz = await _db.Businesses\n                .AsNoTracking()\n                .FirstOrDefaultAsync(b => b.Id == businessId, ct);\n\n            // var planName = (biz?.Plan ?? \"Basic\").Trim();\n            var planName = (biz == null\n     ? \"Basic\"\n     : (biz.Plan?.ToString() ?? \"Basic\")\n ).Trim();\n            var provider = (campaign.Provider ?? \"Auto\").Trim(); // if you snapshot provider on Campaign; otherwise \"Auto\"\n\n            // Throttle rules (sane defaults; adjust to your real plan matrix if available)\n            var (maxBatch, perMinute) = GetThrottleForPlan(planName);\n\n            var result = new CampaignDispatchPlanResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = mat.TemplateName,\n                Language = mat.Language,\n                PlaceholderCount = mat.PlaceholderCount,\n                TotalRecipients = mat.Rows.Count,\n                Throttle = new DispatchThrottleDto\n                {\n                    Plan = planName,\n                    Provider = provider,\n                    MaxBatchSize = maxBatch,\n                    MaxPerMinute = perMinute\n                }\n            };\n\n            if (mat.Rows.Count == 0)\n            {\n                result.GlobalWarnings.Add(\"No recipients available to plan. Ensure audience or campaign recipients exist.\");\n                result.WarningCount = result.GlobalWarnings.Count;\n                return result;\n            }\n\n            // Approx size per row (naive): sum of parameter lengths + resolved button urls + a small fixed header cost\n            var approxBytesPerRow = new List<int>(mat.Rows.Count);\n            foreach (var row in mat.Rows)\n            {\n                var paramBytes = row.Parameters.Sum(p => (p.Value?.Length ?? 0));\n                var btnBytes = row.Buttons.Sum(b => (b.ResolvedUrl?.Length ?? 0) + (b.ButtonText?.Length ?? 0));\n                // add a tiny constant for template envelope; tweak if you maintain captions/text\n                var approx = (paramBytes + btnBytes + 64);\n                approxBytesPerRow.Add(approx);\n            }\n\n            result.TotalApproxBytes = approxBytesPerRow.Sum();\n\n            // Build batches by MaxBatchSize\n            var batches = new List<DispatchBatchDto>();\n            var total = mat.Rows.Count;\n            var batchCount = (int)Math.Ceiling(total / (double)maxBatch);\n\n            // Schedule offsets constrained by MaxPerMinute:\n            // At most 'perMinute' messages may start within any 60-second window.\n            // Strategy: bucket batches into \"minutes\", each minute can hold floor(perMinute / maxBatch) full batches.\n            var batchesPerMinute = Math.Max(1, perMinute / Math.Max(1, maxBatch));\n            if (batchesPerMinute == 0) batchesPerMinute = 1; // guard\n\n            var offsetMinutes = 0;\n            var slotInMinute = 0;\n            int globalIdx = 0;\n\n            for (int b = 0; b < batchCount; b++)\n            {\n                var startIndex = b * maxBatch;\n                var take = Math.Min(maxBatch, total - startIndex);\n\n                var slicePhones = new List<string?>(take);\n                var sliceRecipientIds = new List<Guid?>(take);\n                var sliceApprox = 0;\n\n                for (int i = 0; i < take; i++)\n                {\n                    var row = mat.Rows[startIndex + i];\n                    slicePhones.Add(row.Phone);\n                    sliceRecipientIds.Add(row.RecipientId);\n                    sliceApprox += approxBytesPerRow[startIndex + i];\n                }\n\n                var batch = new DispatchBatchDto\n                {\n                    BatchNumber = b + 1,\n                    StartIndex = startIndex,\n                    Count = take,\n                    ApproxBytes = sliceApprox,\n                    RecipientIds = sliceRecipientIds,\n                    Phones = slicePhones,\n                    OffsetSeconds = offsetMinutes * 60\n                };\n\n                // Notes for the curious\n                if (slicePhones.Any(p => string.IsNullOrWhiteSpace(p)))\n                    batch.Notes.Add(\"Some rows missing phone; those will fail at send-time unless corrected.\");\n                if (sliceApprox / Math.Max(1, take) > 2000)\n                    batch.Notes.Add(\"Average payload per row is large; provider truncation risk.\");\n\n                batches.Add(batch);\n\n                // advance slot & minute window\n                slotInMinute++;\n                if (slotInMinute >= batchesPerMinute)\n                {\n                    slotInMinute = 0;\n                    offsetMinutes++;\n                }\n\n                globalIdx += take;\n            }\n\n            result.Batches = batches;\n            result.Throttle.ComputedBatches = batches.Count;\n            // Estimated minutes: ceil(total recipients / perMinute)\n            result.Throttle.EstimatedMinutes = (int)Math.Ceiling(total / (double)Math.Max(1, perMinute));\n\n            // Warnings\n            if (perMinute < 30) result.Throttle.Warnings.Add(\"Low per-minute limit; delivery may be slow for large audiences.\");\n            if (result.TotalApproxBytes > 5_000_000) result.GlobalWarnings.Add(\"Plan size is large (>5MB). Consider splitting the audience.\");\n\n            result.WarningCount =\n                result.GlobalWarnings.Count +\n                result.Throttle.Warnings.Count +\n                result.Batches.Sum(bh => bh.Notes.Count);\n\n            Log.Information(\"Dispatch plan computed {@PlanSummary}\",\n                new\n                {\n                    campaignId,\n                    businessId,\n                    mat.TemplateName,\n                    mat.Language,\n                    totalRecipients = result.TotalRecipients,\n                    batches = result.Batches.Count,\n                    perMinute,\n                    maxBatch,\n                    estMinutes = result.Throttle.EstimatedMinutes\n                });\n\n            return result;\n        }\n\n        private static (int maxBatch, int perMinute) GetThrottleForPlan(string planName)\n        {\n            // Conservative defaults; align with your real billing/plan matrix when available.\n            switch ((planName ?? \"\").Trim().ToLowerInvariant())\n            {\n                case \"advanced\":\n                    return (100, 600);\n                case \"smart\":\n                    return (50, 300);\n                case \"basic\":\n                default:\n                    return (25, 120);\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDryRunService.cs",
      "sha256": "7951a4dbf036d9ec05750278c322b32b635d8135cb7a51d75748e0ac3f1a0d0a",
      "language": "csharp",
      "size": 9184,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Dry-run validator for campaigns. Checks template existence, parameter counts,\n    /// dynamic button placeholders, and recipient phone presence/shape.\n    /// </summary>\n    public class CampaignDryRunService : ICampaignDryRunService\n    {\n        private readonly AppDbContext _db;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcher;\n\n        private static readonly Regex PlaceholderRe = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        public CampaignDryRunService(AppDbContext db, IWhatsAppTemplateFetcherService templateFetcher)\n        {\n            _db = db;\n            _templateFetcher = templateFetcher;\n        }\n\n        public async Task<CampaignDryRunResultDto> ValidateAsync(\n            Guid businessId,\n            Guid campaignId,\n            int limit = 200,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n            // Load campaign + recipients(+contacts) + variable maps + buttons (read-only)\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .Include(c => c.MultiButtons)\n                .Include(c => c.VariableMaps)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n\n            if (campaign == null)\n                throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Recipients (contact needed for phone)\n            var recipients = await _db.CampaignRecipients\n                .AsNoTracking()\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaignId && r.BusinessId == businessId)\n                .OrderBy(r => r.UpdatedAt)\n                .Take(limit)\n                .ToListAsync(ct);\n\n            // Determine template name (prefer TemplateId ‚Üí MessageTemplate) and fetch metadata\n            var templateName = (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\").Trim();\n            if (string.IsNullOrWhiteSpace(templateName))\n            {\n                // No template at all ‚Äî return result with a single global error across all recipients\n                return BuildResult(\n                    campaignId,\n                    templateName: \"\",\n                    language: \"en_US\",\n                    placeholderCount: 0,\n                    recipients: recipients,\n                    globalError: \"Template name is missing on campaign.\"\n                );\n            }\n\n            var meta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n            if (meta == null)\n            {\n                return BuildResult(\n                    campaignId,\n                    templateName,\n                    language: \"en_US\",\n                    placeholderCount: 0,\n                    recipients: recipients,\n                    globalError: $\"Template '{templateName}' not found for business.\"\n                );\n            }\n\n            var language = (meta.Language ?? \"en_US\").Trim();\n            var placeholderCount = Math.Max(0, meta.PlaceholderCount);\n\n            // Campaign-stored parameters: if supplied, compare counts\n            var storedParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n            bool paramCountMismatch = storedParams.Count > 0 && storedParams.Count != placeholderCount;\n\n            // Validate buttons for dynamic placeholders ({{n}})\n            var dynamicButtonIssues = new List<string>();\n            var buttonPlaceholdersNeeded = new HashSet<int>();\n\n            foreach (var b in (campaign.MultiButtons ?? Enumerable.Empty<CampaignButton>()))\n            {\n                var value = b.Value ?? \"\";\n                foreach (Match m in PlaceholderRe.Matches(value))\n                {\n                    if (int.TryParse(m.Groups[1].Value, out var n))\n                    {\n                        buttonPlaceholdersNeeded.Add(n);\n                    }\n                }\n            }\n\n            foreach (var n in buttonPlaceholdersNeeded)\n            {\n                if (storedParams.Count > 0 && (n < 1 || n > storedParams.Count))\n                {\n                    dynamicButtonIssues.Add($\"Button needs placeholder {{%{n}%}} but campaign parameters only provide {storedParams.Count} value(s).\");\n                }\n                if (placeholderCount > 0 && (n < 1 || n > placeholderCount))\n                {\n                    dynamicButtonIssues.Add($\"Button needs placeholder {{%{n}%}} but template defines only {placeholderCount} placeholder(s).\");\n                }\n            }\n\n            // Build per-recipient issues\n            var issues = new List<CampaignDryRunIssueDto>();\n            foreach (var r in recipients)\n            {\n                var phone = r.Contact?.PhoneNumber?.Trim();\n\n                if (string.IsNullOrWhiteSpace(phone))\n                {\n                    issues.Add(new CampaignDryRunIssueDto\n                    {\n                        RecipientId = r.Id,\n                        ContactId = r.ContactId,\n                        Phone = phone,\n                        Severity = \"error\",\n                        Message = \"Phone is missing.\"\n                    });\n                }\n                else if (!IsLikelyPhone(phone))\n                {\n                    issues.Add(new CampaignDryRunIssueDto\n                    {\n                        RecipientId = r.Id,\n                        ContactId = r.ContactId,\n                        Phone = phone,\n                        Severity = \"warning\",\n                        Message = \"Phone format looks unusual.\"\n                    });\n                }\n            }\n\n            // Add global-ish issues once (we‚Äôll attribute them to a null recipient)\n            if (paramCountMismatch)\n            {\n                issues.Add(new CampaignDryRunIssueDto\n                {\n                    Severity = \"warning\",\n                    Message = $\"Placeholder count mismatch: template expects {placeholderCount}, campaign provided {storedParams.Count}.\",\n                });\n            }\n\n            foreach (var bi in dynamicButtonIssues.Distinct())\n            {\n                issues.Add(new CampaignDryRunIssueDto\n                {\n                    Severity = \"error\",\n                    Message = bi\n                });\n            }\n\n            var result = new CampaignDryRunResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = templateName,\n                Language = language,\n                PlaceholderCount = placeholderCount,\n                CheckedRecipients = recipients.Count,\n                Issues = issues,\n                ErrorCount = issues.Count(i => string.Equals(i.Severity, \"error\", StringComparison.OrdinalIgnoreCase)),\n                WarningCount = issues.Count(i => string.Equals(i.Severity, \"warning\", StringComparison.OrdinalIgnoreCase)),\n            };\n\n            Log.Information(\"Dry-run completed for Campaign {CampaignId} (biz {BusinessId}) ‚Üí {Errors} errors, {Warnings} warnings over {Checked} recipients\",\n                campaignId, businessId, result.ErrorCount, result.WarningCount, result.CheckedRecipients);\n\n            return result;\n        }\n\n        private static CampaignDryRunResultDto BuildResult(\n            Guid campaignId,\n            string templateName,\n            string language,\n            int placeholderCount,\n            List<CampaignRecipient> recipients,\n            string globalError)\n        {\n            var issues = new List<CampaignDryRunIssueDto>\n            {\n                new CampaignDryRunIssueDto\n                {\n                    Severity = \"error\",\n                    Message = globalError\n                }\n            };\n\n            return new CampaignDryRunResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = templateName,\n                Language = language,\n                PlaceholderCount = placeholderCount,\n                CheckedRecipients = recipients.Count,\n                Issues = issues,\n                ErrorCount = issues.Count,\n                WarningCount = 0\n            };\n        }\n\n        private static bool IsLikelyPhone(string? s)\n        {\n            if (string.IsNullOrWhiteSpace(s)) return false;\n            var digits = s.Count(char.IsDigit);\n            return digits >= 10 && digits <= 15;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignMaterializationService.cs",
      "sha256": "4a5f472d01df252626340dc976ed72905f8ed91da5f745f0c5897bf9a72ca4d4",
      "language": "csharp",
      "size": 33263,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.WhatsAppSettings.Services; // ensure namespace matches your project\nusing xbytechat.api.Features.MessageManagement.Services;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.WhatsAppSettings.DTOs; // IUrlBuilderService\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    \n\n    /// <summary>\n    /// Read-only ‚Äúcompiler‚Äù that materializes template params and button URLs per recipient.\n    /// Mirrors the live send behavior (no dispatch, no DB writes).\n    /// </summary>\n    public sealed class CampaignMaterializationService : ICampaignMaterializationService\n    {\n        private readonly AppDbContext _db;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcher;\n        private readonly IUrlBuilderService _urlBuilderService;\n\n        private static readonly Regex PlaceholderRe = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        public CampaignMaterializationService(\n            AppDbContext db,\n            IWhatsAppTemplateFetcherService templateFetcher,\n            IUrlBuilderService urlBuilderService)\n        {\n            _db = db;\n            _templateFetcher = templateFetcher;\n            _urlBuilderService = urlBuilderService;\n        }\n\n        //public async Task<CampaignMaterializeResultDto> MaterializeAsync(\n        //    Guid businessId,\n        //    Guid campaignId,\n        //    int limit = 200,\n        //    CancellationToken ct = default)\n        //{\n        //    if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n        //    if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required\");\n        //    if (limit <= 0) limit = 200;\n\n        //    // Load campaign + variable maps + buttons + recipients (+ contacts)\n        //    var campaign = await _db.Campaigns\n        //        .AsNoTracking()\n        //        .Include(c => c.VariableMaps)\n        //        .Include(c => c.MultiButtons)\n        //        .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n        //        .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n\n        //    if (campaign == null)\n        //        throw new KeyNotFoundException(\"Campaign not found.\");\n\n        //    // Resolve template meta from snapshot/params; fallback to live\n        //    var meta = await ResolveTemplateMetaAsync(campaign, businessId, ct);\n        //    var templateName = meta.TemplateName;\n        //    var language = meta.Language;\n        //    var placeholderCount = meta.PlaceholderCount;\n\n        //    if (string.IsNullOrWhiteSpace(templateName))\n        //        throw new InvalidOperationException(\"Campaign does not have a resolvable template name.\");\n\n        //    // Try to fetch provider button meta (for dynamic URL detection & alignment)\n        //    TemplateMetadataDto? liveMeta = null;\n        //    try\n        //    {\n        //        liveMeta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        Log.Warning(ex, \"Template fetch failed during materialization for {Template}\", templateName);\n        //    }\n\n        //    var result = new CampaignMaterializeResultDto\n        //    {\n        //        CampaignId = campaignId,\n        //        TemplateName = templateName,\n        //        Language = language,\n        //        PlaceholderCount = placeholderCount\n        //    };\n\n        //    var varMaps = (campaign.VariableMaps ?? new List<CampaignVariableMap>())\n        //        .Where(m => m.CampaignId == campaignId)\n        //        .ToList();\n\n        //    var recipients = (campaign.Recipients ?? new List<CampaignRecipient>())\n        //        .OrderBy(r => r.UpdatedAt)\n        //        .Take(limit)\n        //        .ToList();\n\n        //    // order buttons by Position (then by their original index) to align with template button index\n        //    var orderedButtons = (campaign.MultiButtons ?? new List<CampaignButton>())\n        //        .Select((b, idx) => new { Btn = b, idx })\n        //        .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n        //        .ThenBy(x => x.idx)\n        //        .Select(x => x.Btn)\n        //        .ToList();\n\n        //    foreach (var r in recipients)\n        //    {\n        //        var row = new MaterializedRecipientDto\n        //        {\n        //            RecipientId = r.Id,\n        //            ContactId = r.ContactId,\n        //            Phone = NormalizePhone(r?.Contact?.PhoneNumber)\n        //        };\n\n        //        // Parameters 1..N via variable maps (Static/Default/Expression placeholder)\n        //        for (int idx = 1; idx <= placeholderCount; idx++)\n        //        {\n        //            var map = varMaps.FirstOrDefault(m => m.Index == idx);\n        //            if (map == null)\n        //            {\n        //                row.Parameters.Add(new TemplateParamResolutionDto\n        //                {\n        //                    Index = idx,\n        //                    Value = null,\n        //                    IsMissing = true,\n        //                    SourceType = \"Unmapped\",\n        //                    Note = \"No variable map for this placeholder.\"\n        //                });\n        //                continue;\n        //            }\n\n        //            var (value, isMissing, note) = ResolveValue(map, r);\n        //            row.Parameters.Add(new TemplateParamResolutionDto\n        //            {\n        //                Index = idx,\n        //                Value = value,\n        //                IsMissing = isMissing,\n        //                SourceType = map.SourceType ?? string.Empty,\n        //                SourceKey = map.SourceKey\n        //            });\n\n        //            if (!string.IsNullOrWhiteSpace(note))\n        //                row.Warnings.Add($\"{{{{{idx}}}}}: {note}\");\n        //        }\n\n        //        // Buttons: mirror live send behavior for dynamic URL buttons (index 0..2)\n        //        if (liveMeta?.ButtonParams != null && liveMeta.ButtonParams.Count > 0 && orderedButtons.Count > 0)\n        //        {\n        //            var total = Math.Min(3, Math.Min(orderedButtons.Count, liveMeta.ButtonParams.Count));\n\n        //            for (int i = 0; i < total; i++)\n        //            {\n        //                var metaBtn = liveMeta.ButtonParams[i];\n        //                var subType = (metaBtn.SubType ?? \"url\").ToLowerInvariant();\n        //                var metaParam = metaBtn.ParameterValue?.Trim();\n\n        //                var br = new ButtonResolutionDto\n        //                {\n        //                    ButtonText = orderedButtons[i]?.Title ?? string.Empty,\n        //                    RawTemplateValue = orderedButtons[i]?.Value\n        //                };\n\n        //                // We only handle dynamic URL buttons here (consistent with send logic)\n        //                if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n        //                {\n        //                    br.Notes.Add(\"Non-URL button (no dynamic resolution).\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n        //                if (!isDynamic)\n        //                {\n        //                    br.Notes.Add(\"Static URL button (no parameters required by template).\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                var btn = orderedButtons[i];\n        //                var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n        //                if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n        //                {\n        //                    br.Notes.Add($\"Template expects a dynamic URL at index {i}, but campaign button type is '{btn?.Type}'.\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                var valueRaw = btn?.Value?.Trim();\n        //                if (string.IsNullOrWhiteSpace(valueRaw))\n        //                {\n        //                    br.Notes.Add($\"Template requires a dynamic URL at index {i}, but campaign button value is empty.\");\n        //                    br.MissingArguments.Add(\"{{1}}\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                // optional phone substitution into destination\n        //                var phone = row.Phone ?? \"\";\n        //                var encodedPhone = Uri.EscapeDataString(phone);\n\n        //                var resolvedDestination = valueRaw.Contains(\"{{1}}\")\n        //                    ? valueRaw.Replace(\"{{1}}\", encodedPhone)\n        //                    : valueRaw;\n\n        //                // normalize/validate URL (allow tel:, wa:, wa.me links)\n        //                try\n        //                {\n        //                    resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn!.Title ?? $\"Button {i + 1}\", i);\n        //                }\n        //                catch (Exception ex)\n        //                {\n        //                    br.Notes.Add($\"Destination invalid: {ex.Message}\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                // Build both styles and pick based on template absolute base rule\n        //                var fakeSendLogId = Guid.NewGuid(); // preview-only tokenization\n        //                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(\n        //                    fakeSendLogId, i, btn!.Title, resolvedDestination);\n\n        //                var tokenParam = BuildTokenParam(fakeSendLogId, i, btn.Title, resolvedDestination);\n\n        //                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n        //                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n        //                br.UsedPlaceholders.Add(\"{{1}}\"); // meta indicates dynamic\n        //                br.ResolvedUrl = valueToSend;\n        //                row.Buttons.Add(br);\n        //            }\n        //        }\n        //        else\n        //        {\n        //            // no dynamic buttons in template\n        //        }\n\n        //        // Basic phone sanity\n        //        if (string.IsNullOrWhiteSpace(row.Phone))\n        //            row.Errors.Add(\"Phone is missing.\");\n        //        else if (!IsLikelyPhone(row.Phone))\n        //            row.Warnings.Add(\"Phone format looks unusual.\");\n\n        //        result.Rows.Add(row);\n        //    }\n\n        //    result.ReturnedCount = result.Rows.Count;\n        //    result.ErrorCount = result.Rows.Sum(r => r.Errors.Count);\n        //    result.WarningCount = result.Rows.Sum(r => r.Warnings.Count)\n        //                          + result.Rows.Sum(r => r.Parameters.Count(p => p.IsMissing));\n\n        //    Log.Information(\"Campaign materialization computed {@Summary}\",\n        //        new\n        //        {\n        //            campaignId,\n        //            businessId,\n        //            result.ReturnedCount,\n        //            result.ErrorCount,\n        //            result.WarningCount,\n        //            result.PlaceholderCount,\n        //            result.TemplateName,\n        //            result.Language\n        //        });\n\n        //    return result;\n        //}\n        public async Task<CampaignMaterializeResultDto> MaterializeAsync(\n    Guid businessId,\n    Guid campaignId,\n    int limit = 200,\n    CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required\");\n            if (limit <= 0) limit = 200;\n\n            // Load campaign + variable maps + buttons + recipients (+ contacts)\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .Include(c => c.VariableMaps)\n                .Include(c => c.MultiButtons)\n                .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n\n            if (campaign == null)\n                throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Resolve template meta from snapshot/params; fallback to live\n            var meta = await ResolveTemplateMetaAsync(campaign, businessId, ct);\n            var templateName = meta.TemplateName;\n            var language = meta.Language;\n            var placeholderCount = meta.PlaceholderCount;\n\n            if (string.IsNullOrWhiteSpace(templateName))\n                throw new InvalidOperationException(\"Campaign does not have a resolvable template name.\");\n\n            // Try to fetch provider button meta (for dynamic URL detection & alignment)\n            TemplateMetadataDto? liveMeta = null;\n            try\n            {\n                liveMeta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n            }\n            catch (Exception ex)\n            {\n                Log.Warning(ex, \"Template fetch failed during materialization for {Template}\", templateName);\n            }\n\n            var result = new CampaignMaterializeResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = templateName,\n                Language = language,\n                PlaceholderCount = placeholderCount\n            };\n\n            var varMaps = (campaign.VariableMaps ?? new List<CampaignVariableMap>())\n                .Where(m => m.CampaignId == campaignId)\n                .ToList();\n\n            var recipients = (campaign.Recipients ?? new List<CampaignRecipient>())\n                .OrderBy(r => r.UpdatedAt)\n                .Take(limit)\n                .ToList();\n\n            // order buttons by Position (then by their original index) to align with template button index\n            var orderedButtons = (campaign.MultiButtons ?? new List<CampaignButton>())\n                .Select((b, idx) => new { Btn = b, idx })\n                .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                .ThenBy(x => x.idx)\n                .Select(x => x.Btn)\n                .ToList();\n\n            foreach (var r in recipients)\n            {\n                var row = new MaterializedRecipientDto\n                {\n                    RecipientId = r.Id,\n                    ContactId = r.ContactId,\n                    Phone = NormalizePhone(r?.Contact?.PhoneNumber)\n                };\n\n                // üîß INLINE TOLERANT CONTACT LOOKUP (no helpers, no DB writes)\n                // If the recipient isn't linked to a Contact yet but we have a phone,\n                // try to find a Contact by either +E.164 or plain-digits form.\n                if ((row.ContactId == null || row.ContactId == Guid.Empty) && !string.IsNullOrWhiteSpace(row.Phone))\n                {\n                    string pPlus, pPlain;\n\n                    if (row.Phone.StartsWith(\"+\", StringComparison.Ordinal))\n                    {\n                        var digitsOnly = new string(row.Phone.Skip(1).Where(char.IsDigit).ToArray());\n                        pPlus = row.Phone;\n                        pPlain = digitsOnly;\n                    }\n                    else\n                    {\n                        var digitsOnly = new string(row.Phone.Where(char.IsDigit).ToArray());\n                        pPlus = \"+\" + digitsOnly;\n                        pPlain = digitsOnly;\n                    }\n\n                    // Only query if we have something meaningful\n                    if (!string.IsNullOrWhiteSpace(pPlus) || !string.IsNullOrWhiteSpace(pPlain))\n                    {\n                        var foundId = await _db.Contacts\n                            .AsNoTracking()\n                            .Where(c => c.BusinessId == businessId &&\n                                        (c.PhoneNumber == pPlus || c.PhoneNumber == pPlain))\n                            .Select(c => c.Id)\n                            .FirstOrDefaultAsync(ct);\n\n                        if (foundId != Guid.Empty)\n                            row.ContactId = foundId; // reflect resolvable linkage in preview\n                    }\n                }\n\n                // Parameters 1..N via variable maps (Static/Default/Expression placeholder)\n                for (int idx = 1; idx <= placeholderCount; idx++)\n                {\n                    var map = varMaps.FirstOrDefault(m => m.Index == idx);\n                    if (map == null)\n                    {\n                        row.Parameters.Add(new TemplateParamResolutionDto\n                        {\n                            Index = idx,\n                            Value = null,\n                            IsMissing = true,\n                            SourceType = \"Unmapped\",\n                            Note = \"No variable map for this placeholder.\"\n                        });\n                        continue;\n                    }\n\n                    var (value, isMissing, note) = ResolveValue(map, r);\n                    row.Parameters.Add(new TemplateParamResolutionDto\n                    {\n                        Index = idx,\n                        Value = value,\n                        IsMissing = isMissing,\n                        SourceType = map.SourceType ?? string.Empty,\n                        SourceKey = map.SourceKey\n                    });\n\n                    if (!string.IsNullOrWhiteSpace(note))\n                        row.Warnings.Add($\"{{{{{idx}}}}}: {note}\");\n                }\n\n                // Buttons: mirror live send behavior for dynamic URL buttons (index 0..2)\n                if (liveMeta?.ButtonParams != null && liveMeta.ButtonParams.Count > 0 && orderedButtons.Count > 0)\n                {\n                    var total = Math.Min(3, Math.Min(orderedButtons.Count, liveMeta.ButtonParams.Count));\n\n                    for (int i = 0; i < total; i++)\n                    {\n                        var metaBtn = liveMeta.ButtonParams[i];\n                        var subType = (metaBtn.SubType ?? \"url\").ToLowerInvariant();\n                        var metaParam = metaBtn.ParameterValue?.Trim();\n\n                        var br = new ButtonResolutionDto\n                        {\n                            ButtonText = orderedButtons[i]?.Title ?? string.Empty,\n                            RawTemplateValue = orderedButtons[i]?.Value\n                        };\n\n                        // We only handle dynamic URL buttons here (consistent with send logic)\n                        if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            br.Notes.Add(\"Non-URL button (no dynamic resolution).\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                        if (!isDynamic)\n                        {\n                            br.Notes.Add(\"Static URL button (no parameters required by template).\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        var btn = orderedButtons[i];\n                        var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n                        if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            br.Notes.Add($\"Template expects a dynamic URL at index {i}, but campaign button type is '{btn?.Type}'.\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        var valueRaw = btn?.Value?.Trim();\n                        if (string.IsNullOrWhiteSpace(valueRaw))\n                        {\n                            br.Notes.Add($\"Template requires a dynamic URL at index {i}, but campaign button value is empty.\");\n                            br.MissingArguments.Add(\"{{1}}\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        // optional phone substitution into destination\n                        var phone = row.Phone ?? \"\";\n                        var encodedPhone = Uri.EscapeDataString(phone);\n\n                        var resolvedDestination = valueRaw.Contains(\"{{1}}\")\n                            ? valueRaw.Replace(\"{{1}}\", encodedPhone)\n                            : valueRaw;\n\n                        // normalize/validate URL (allow tel:, wa:, wa.me links)\n                        try\n                        {\n                            resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn!.Title ?? $\"Button {i + 1}\", i);\n                        }\n                        catch (Exception ex)\n                        {\n                            br.Notes.Add($\"Destination invalid: {ex.Message}\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        // Build both styles and pick based on template absolute base rule\n                        var fakeSendLogId = Guid.NewGuid(); // preview-only tokenization\n                        var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(\n                            fakeSendLogId, i, btn!.Title, resolvedDestination);\n\n                        var tokenParam = BuildTokenParam(fakeSendLogId, i, btn.Title, resolvedDestination);\n\n                        var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                        var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                        br.UsedPlaceholders.Add(\"{{1}}\"); // meta indicates dynamic\n                        br.ResolvedUrl = valueToSend;\n                        row.Buttons.Add(br);\n                    }\n                }\n                else\n                {\n                    // no dynamic buttons in template\n                }\n\n                // Basic phone sanity\n                if (string.IsNullOrWhiteSpace(row.Phone))\n                    row.Errors.Add(\"Phone is missing.\");\n                else if (!IsLikelyPhone(row.Phone))\n                    row.Warnings.Add(\"Phone format looks unusual.\");\n\n                result.Rows.Add(row);\n            }\n\n            result.ReturnedCount = result.Rows.Count;\n            result.ErrorCount = result.Rows.Sum(r => r.Errors.Count);\n            result.WarningCount = result.Rows.Sum(r => r.Warnings.Count)\n                                  + result.Rows.Sum(r => r.Parameters.Count(p => p.IsMissing));\n\n            Log.Information(\"Campaign materialization computed {@Summary}\",\n                new\n                {\n                    campaignId,\n                    businessId,\n                    result.ReturnedCount,\n                    result.ErrorCount,\n                    result.WarningCount,\n                    result.PlaceholderCount,\n                    result.TemplateName,\n                    result.Language\n                });\n\n            return result;\n        }\n\n\n        // --- Helpers (mirror your send logic where relevant) ---\n\n        private static (string? value, bool isMissing, string? note) ResolveValue(\n            CampaignVariableMap map,\n            CampaignRecipient recipient)\n        {\n            var source = (map.SourceType ?? \"\").Trim();\n\n            switch (source)\n            {\n                case \"Static\":\n                    {\n                        var v = map.StaticValue;\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, missing ? \"Required static value missing.\" : null);\n                    }\n\n                case \"Expression\":\n                    {\n                        // no eval engine; use DefaultValue if provided\n                        var v = map.DefaultValue;\n                        var note = \"Expression present; no evaluation engine configured. Used DefaultValue.\";\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, missing ? \"Required expression result missing (no default provided).\" : note);\n                    }\n\n                case \"AudienceColumn\":\n                    {\n                        // Current CampaignRecipient shape doesn't carry Audience/CSV row data.\n                        // If you later link AudienceMember.AttributesJson here, resolve from it.\n                        var v = map.DefaultValue;\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, \"Audience/CSV source not available on CampaignRecipient; used DefaultValue.\");\n                    }\n\n                default:\n                    {\n                        var v = map.DefaultValue;\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, missing ? \"Unrecognized mapping type and no default.\" : \"Unrecognized mapping type; used DefaultValue.\");\n                    }\n            }\n        }\n\n        private static string NormalizePhone(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"\";\n            var p = raw.Trim();\n            if (!p.StartsWith(\"+\")) p = \"+\" + new string(p.Where(char.IsDigit).ToArray());\n            return p;\n        }\n\n        private static bool IsLikelyPhone(string? s)\n        {\n            if (string.IsNullOrWhiteSpace(s)) return false;\n            var digits = s.Count(char.IsDigit);\n            return digits >= 10 && digits <= 15;\n        }\n\n        private static string NormalizeAbsoluteUrlOrThrowForButton(string input, string buttonTitle, int buttonIndex)\n        {\n            if (string.IsNullOrWhiteSpace(input))\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            var cleaned = new string(input.Trim().Where(c => !char.IsControl(c)).ToArray());\n            if (cleaned.Length == 0)\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            // Accept tel: / wa: / wa.me deep links\n            if (cleaned.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase))\n            {\n                return cleaned;\n            }\n\n            if (Uri.TryCreate(cleaned, UriKind.Absolute, out var uri) &&\n                (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                 uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase)))\n            {\n                return uri.ToString();\n            }\n\n            throw new ArgumentException(\n                $\"Destination must be an absolute http/https/tel/wa URL for button '{buttonTitle}' (index {buttonIndex}). Got: '{input}'\");\n        }\n\n        private static bool LooksLikeAbsoluteBaseUrlWithPlaceholder(string? templateUrl)\n        {\n            if (string.IsNullOrWhiteSpace(templateUrl)) return false;\n            var s = templateUrl.Trim();\n            if (!s.Contains(\"{{\")) return false;\n            var probe = s.Replace(\"{{1}}\", \"x\").Replace(\"{{0}}\", \"x\");\n            return Uri.TryCreate(probe, UriKind.Absolute, out var abs) &&\n                   (abs.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    abs.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase));\n        }\n\n        private string BuildTokenParam(Guid campaignSendLogId, int buttonIndex, string? buttonTitle, string destinationUrlAbsolute)\n        {\n            var full = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, buttonIndex, buttonTitle, destinationUrlAbsolute);\n            var pos = full.LastIndexOf(\"/r/\", StringComparison.OrdinalIgnoreCase);\n            return (pos >= 0) ? full[(pos + 3)..] : full;\n        }\n\n        private sealed record ResolvedTemplateMeta(string TemplateName, string Language, int PlaceholderCount);\n\n       \n\n        private static int CountPlaceholders(string? text)\n        {\n            if (string.IsNullOrWhiteSpace(text)) return 0;\n            // matches {{1}}, {{ 2 }}, etc.\n            return Regex.Matches(text, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n        }\n\n        private async Task<ResolvedTemplateMeta> ResolveTemplateMetaAsync(\n            Campaign campaign,\n            Guid businessId,\n            CancellationToken ct)\n        {\n            string templateName = string.Empty;\n            string language = \"en\";\n            int placeholderCount = 0;\n\n            // 1) Snapshot first (if stored)\n            if (!string.IsNullOrWhiteSpace(campaign.TemplateSchemaSnapshot))\n            {\n                try\n                {\n                    using var doc = JsonDocument.Parse(campaign.TemplateSchemaSnapshot);\n                    var root = doc.RootElement;\n\n                    if (root.TryGetProperty(\"name\", out var n) && n.ValueKind == JsonValueKind.String)\n                        templateName = n.GetString() ?? string.Empty;\n\n                    if (root.TryGetProperty(\"language\", out var l) && l.ValueKind == JsonValueKind.String)\n                        language = l.GetString() ?? \"en\";\n\n                    if (root.TryGetProperty(\"placeholderCount\", out var pc) && pc.TryGetInt32(out var snapCount))\n                        placeholderCount = snapCount;\n                }\n                catch { /* non-fatal */ }\n            }\n\n            // 2) Prefer stored TemplateParameters count if present\n            if (!string.IsNullOrWhiteSpace(campaign.TemplateParameters))\n            {\n                try\n                {\n                    var arr = JsonSerializer.Deserialize<List<string>>(campaign.TemplateParameters) ?? new();\n                    placeholderCount = Math.Max(placeholderCount, arr.Count);\n                }\n                catch { /* ignore bad param JSON */ }\n            }\n\n            // 3) If name still missing, use MessageTemplate as canonical name (fall back to TemplateId)\n            if (string.IsNullOrWhiteSpace(templateName))\n                templateName = campaign.MessageTemplate ?? campaign.TemplateId ?? string.Empty;\n\n            // 4) Fallback to live metadata if essentials missing\n            if (placeholderCount <= 0 || string.IsNullOrWhiteSpace(templateName))\n            {\n                try\n                {\n                    var live = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n                    if (live != null)\n                    {\n                        if (string.IsNullOrWhiteSpace(templateName) && !string.IsNullOrWhiteSpace(live.Name))\n                            templateName = live.Name!;\n                        if (!string.IsNullOrWhiteSpace(live.Language))\n                            language = live.Language!;\n\n                        // Your TemplateMetadataDto exposes PlaceholderCount and Body (no .Parameters)\n                        var liveCount = live.PlaceholderCount > 0\n                            ? live.PlaceholderCount\n                            : CountPlaceholders(live.Body);\n\n                        placeholderCount = Math.Max(placeholderCount, liveCount);\n                    }\n                }\n                catch (Exception ex)\n                {\n                    Log.Warning(ex, \"Live template meta fetch failed for {Template}/{Lang}\", templateName, language);\n                }\n            }\n\n            if (string.IsNullOrWhiteSpace(language)) language = \"en\";\n            if (placeholderCount < 0) placeholderCount = 0;\n\n            return new ResolvedTemplateMeta(templateName, language, placeholderCount);\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignMaterializer.cs",
      "sha256": "635bfbaa70d7f49cdcff1e91f0eb2f7662c2d09306f33d61cb6833d2e0e2473c",
      "language": "csharp",
      "size": 27155,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Helpers;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n\n    public sealed class CampaignMaterializer : ICampaignMaterializer\n    {\n        private readonly AppDbContext _db;\n        private readonly IVariableResolver _resolver;\n        private readonly ICampaignAudienceAttachmentService _audienceAttachments;\n\n        // Common phone header candidates (case-insensitive)\n        private static readonly string[] PhoneHeaderCandidates =\n        {\n            \"phone\", \"mobile\", \"whatsapp\", \"msisdn\", \"whatsapp_number\", \"contact\", \"contact_number\"\n        };\n\n        public CampaignMaterializer(AppDbContext db, IVariableResolver resolver, ICampaignAudienceAttachmentService audienceAttachments)\n        {\n            _db = db;\n            _resolver = resolver;\n            _audienceAttachments = audienceAttachments;\n        }\n       \n        private static Dictionary<string, string> BuildAutoMappingsFromRow(\n            IDictionary<string, string> rowDict,\n            int requiredBodySlots,\n            IReadOnlyCollection<string>? namedBodyTokens = null)\n        {\n            var map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            // 1) BODY (positional)\n            int n = requiredBodySlots > 0\n                ? requiredBodySlots\n                : rowDict.Keys.Select(k =>\n                {\n                    var m = System.Text.RegularExpressions.Regex.Match(k, @\"^parameter(\\d+)$\", System.Text.RegularExpressions.RegexOptions.IgnoreCase);\n                    return m.Success ? int.Parse(m.Groups[1].Value) : 0;\n                }).DefaultIfEmpty(0).Max();\n\n            for (int i = 1; i <= n; i++)\n            {\n                var csvHeader = rowDict.Keys.FirstOrDefault(k => string.Equals(k, $\"parameter{i}\", StringComparison.OrdinalIgnoreCase));\n                if (!string.IsNullOrWhiteSpace(csvHeader))\n                    map[$\"{{{{{i}}}}}\"] = csvHeader; // -> {{i}}\n            }\n\n            // 1b) BODY (named): if template has named tokens and CSV has columns with those names\n            if (namedBodyTokens != null && namedBodyTokens.Count > 0)\n            {\n                foreach (var token in namedBodyTokens)\n                {\n                    // look for a column exactly named as token (case-insensitive)\n                    var csvHeader = rowDict.Keys.FirstOrDefault(k => string.Equals(k, token, StringComparison.OrdinalIgnoreCase));\n                    if (!string.IsNullOrWhiteSpace(csvHeader))\n                    {\n                        // map \"{{token}}\" -> that column\n                        map[$\"{{{{{token}}}}}\"] = csvHeader;\n                    }\n                }\n            }\n\n            // 2) HEADER (text) variables: headerparaN -> header.text_paramN\n            foreach (var kv in rowDict)\n            {\n                var m = System.Text.RegularExpressions.Regex.Match(kv.Key, @\"^headerpara(\\d+)$\", System.Text.RegularExpressions.RegexOptions.IgnoreCase);\n                if (m.Success)\n                {\n                    var slot = int.Parse(m.Groups[1].Value);\n                    map[$\"header.text_param{slot}\"] = kv.Key;\n                }\n            }\n\n            // 3) dynamic URL buttons: buttonparaN -> buttonN.url_param\n            foreach (var kv in rowDict)\n            {\n                var m = System.Text.RegularExpressions.Regex.Match(kv.Key, @\"^buttonpara(\\d+)$\", System.Text.RegularExpressions.RegexOptions.IgnoreCase);\n                if (m.Success)\n                {\n                    var pos = int.Parse(m.Groups[1].Value);\n                    if (pos >= 1 && pos <= 3)\n                        map[$\"button{pos}.url_param\"] = kv.Key;\n                }\n            }\n\n            return map;\n        }\n\n\n        private async Task<int> GetRequiredBodySlotsAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            // Get campaign‚Äôs saved template identifiers\n            var snap = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.TemplateId, c.MessageTemplate })\n                .FirstOrDefaultAsync(ct);\n\n            if (snap is null) return 0;\n\n            WhatsAppTemplate? tpl = null;\n\n            // 1) Prefer exact provider id match (TemplateId)\n            if (!string.IsNullOrWhiteSpace(snap.TemplateId))\n            {\n                tpl = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.TemplateId == snap.TemplateId)\n                    .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            // 2) Fallback: match by template Name (MessageTemplate)\n            if (tpl is null && !string.IsNullOrWhiteSpace(snap.MessageTemplate))\n            {\n                tpl = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.Name == snap.MessageTemplate)\n                    .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            // BODY slots only. If you need header+buttons too, use TotalTextParamCount instead.\n            return tpl?.BodyVarCount ?? 0;\n        }\n\n\n        private static string[]? EnsureBodyParamsComplete(string[] bodyParams, int requiredSlots, out List<string> missing)\n        {\n            missing = new List<string>();\n            if (requiredSlots <= 0) return bodyParams; // nothing to enforce\n\n            // Resize to requiredSlots\n            var arr = new string[requiredSlots];\n            for (int i = 0; i < requiredSlots; i++)\n            {\n                var v = (i < bodyParams.Length ? bodyParams[i] : string.Empty) ?? string.Empty;\n                arr[i] = v;\n                if (string.IsNullOrWhiteSpace(v))\n                    missing.Add($\"{{{{{i + 1}}}}}\");\n            }\n\n            if (missing.Count > 0)\n                return null;\n\n            return arr;\n        }\n\n        // File: Features/CampaignModule/Services/CampaignMaterializer.cs\n        // Method: CreateAsync(...)\n        // NOTE: This version is identical to yours except we pull `requiredBodySlots` ONCE before the foreach.\n        //       Everything else remains the same (including the enforcement you added).\n\n        public async Task<CampaignCsvMaterializeResponseDto> CreateAsync(\n       Guid businessId,\n       Guid campaignId,\n       CampaignCsvMaterializeRequestDto request,\n       string actor,\n       CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"Invalid campaign id.\");\n            if (request is null) throw new ArgumentNullException(nameof(request));\n            if (request.CsvBatchId == Guid.Empty) throw new ArgumentException(\"CsvBatchId is required.\");\n            if (request.Persist && string.IsNullOrWhiteSpace(request.AudienceName))\n                throw new ArgumentException(\"AudienceName is required when Persist=true.\");\n\n            actor = string.IsNullOrWhiteSpace(actor) ? \"system\" : actor;\n\n            // Campaign ownership check\n            var owns = await _db.Campaigns\n                .AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n            if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n            // Load CSV rows for the batch\n            var rowsQuery = _db.CsvRows\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == request.CsvBatchId)\n                .OrderBy(r => r.RowIndex);\n\n            var totalRows = await rowsQuery.CountAsync(ct);\n            var csvRows = (!request.Persist && request.Limit.HasValue && request.Limit.Value > 0)\n                ? await rowsQuery.Take(request.Limit.Value).ToListAsync(ct)\n                : await rowsQuery.ToListAsync(ct);\n\n            var resp = new CampaignCsvMaterializeResponseDto\n            {\n                CampaignId = campaignId,\n                CsvBatchId = request.CsvBatchId,\n                TotalRows = totalRows\n            };\n\n            // Build header set to help autodetect phone field\n            var headerSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var r in csvRows)\n            {\n                foreach (var k in JsonToDict(r.DataJson).Keys)\n                    headerSet.Add(k);\n            }\n\n            // Mapping precedence: request ‚Üí fallback header==token\n            var effectiveMappings = request.Mappings ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            // Determine phone field\n            var phoneField = request.PhoneField;\n            if (string.IsNullOrWhiteSpace(phoneField))\n                phoneField = PhoneHeaderCandidates.FirstOrDefault(headerSet.Contains);\n\n            if (string.IsNullOrWhiteSpace(phoneField))\n                resp.Warnings.Add(\"No phone field provided or detected; rows without phone will be skipped.\");\n\n            // üîé Pull required body slots ONCE (avoid N queries)\n            var requiredBodySlots = await GetRequiredBodySlotsAsync(businessId, campaignId, ct);\n\n            // üîé NEW: pull named BODY tokens ONCE (e.g., first_name, slug) for auto-mapping\n            var namedBodyTokens = await GetNamedBodyTokensAsync(businessId, campaignId, ct);\n\n            var seenPhones = new HashSet<string>(StringComparer.Ordinal);\n            var preview = resp.Preview; // alias\n\n            foreach (var row in csvRows)\n            {\n                ct.ThrowIfCancellationRequested();\n\n                var rowDict = JsonToDict(row.DataJson);\n                var m = new CsvMaterializedRowDto { RowIndex = row.RowIndex };\n\n                // üß≠ effective mappings: request.Mappings OR auto-infer from row\n                var mappingsToUse =\n                    (effectiveMappings != null && effectiveMappings.Count > 0)\n                        ? new Dictionary<string, string>(effectiveMappings, StringComparer.OrdinalIgnoreCase)\n                        // NEW: include namedBodyTokens so CSV columns like \"slug\" map to {{slug}}\n                        : BuildAutoMappingsFromRow(rowDict, requiredBodySlots, namedBodyTokens);\n\n                // Variables for template (canonicalized by resolver)\n                m.Variables = _resolver.ResolveVariables(rowDict, mappingsToUse);\n\n                // Phone selection\n                string? phone = null;\n                if (!string.IsNullOrWhiteSpace(phoneField))\n                {\n                    rowDict.TryGetValue(phoneField, out phone);\n                }\n                else\n                {\n                    foreach (var cand in PhoneHeaderCandidates)\n                        if (rowDict.TryGetValue(cand, out phone) && !string.IsNullOrWhiteSpace(phone))\n                            break;\n                }\n\n                phone = NormalizePhoneMaybe(phone, request.NormalizePhones);\n                m.Phone = phone;\n\n                if (string.IsNullOrWhiteSpace(m.Phone))\n                {\n                    m.Errors.Add(\"Missing phone\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                if (request.Deduplicate && !seenPhones.Add(m.Phone))\n                {\n                    m.Errors.Add(\"Duplicate phone (deduped)\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                // üîí Enforce required body placeholders BEFORE adding to preview\n                var prelimBodyParams = BuildBodyParamArrayFromVariables(\n                    m.Variables ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase));\n\n                var enforced = EnsureBodyParamsComplete(prelimBodyParams, requiredBodySlots, out var missingSlots);\n                if (enforced == null)\n                {\n                    // at least one required slot missing ‚Üí skip this row\n                    m.Errors.Add($\"Missing body parameters: {string.Join(\", \", missingSlots)}\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                // (Optional) keep for troubleshooting:\n                // m.DebugBodyParams = enforced;\n\n                preview.Add(m);\n            }\n\n            resp.MaterializedCount = preview.Count;\n\n            // Persist if requested\n            if (request.Persist && resp.MaterializedCount > 0)\n            {\n                var replace = await _audienceAttachments.ReplaceFromMaterializationAsync(\n                    businessId, campaignId, request, preview, actor, ct);\n\n                resp.AudienceId = replace.Active.AudienceId;\n            }\n\n            return resp;\n        }\n\n\n\n        private static string[] BuildBodyParamArrayFromVariables(IDictionary<string, string> vars)\n        {\n            var pairs = new List<(int idx, string val)>();\n\n            foreach (var kv in vars)\n            {\n                var k = kv.Key ?? string.Empty;\n                var v = kv.Value ?? string.Empty;\n\n                // 1) body.N\n                if (k.StartsWith(\"body.\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (int.TryParse(k.AsSpan(\"body.\".Length), out var n) && n > 0)\n                        pairs.Add((n, v));\n                    continue;\n                }\n\n                // 2) parameterN (FE mapping keys)\n                if (k.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (int.TryParse(k.AsSpan(\"parameter\".Length), out var n) && n > 0)\n                        pairs.Add((n, v));\n                    continue;\n                }\n\n                // 3) {{N}} (auto-mapper tokens)\n                // match exactly {{  number  }}\n                var m = System.Text.RegularExpressions.Regex.Match(k, @\"^\\{\\{\\s*(\\d+)\\s*\\}\\}$\");\n                if (m.Success && int.TryParse(m.Groups[1].Value, out var t) && t > 0)\n                {\n                    pairs.Add((t, v));\n                    continue;\n                }\n            }\n\n            if (pairs.Count == 0) return Array.Empty<string>();\n\n            var max = pairs.Max(p => p.idx);\n            var arr = new string[max];\n            for (int i = 0; i < max; i++) arr[i] = string.Empty;\n            foreach (var (idx, val) in pairs) arr[idx - 1] = val ?? string.Empty;\n            return arr;\n        }\n\n        private async Task<Guid> PersistAudienceAndRecipientsAsync(\n            Guid businessId,\n            Guid campaignId,\n            string audienceName,\n            List<CsvMaterializedRowDto> rows,\n            CancellationToken ct)\n        {\n            await using var tx = await _db.Database.BeginTransactionAsync(ct);\n            try\n            {\n                var now = DateTime.UtcNow;\n\n                var audience = new Audience\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = audienceName,\n                    CreatedAt = now,\n                    UpdatedAt = now\n                };\n                _db.Audiences.Add(audience);\n\n                // --- local helpers --------------------------------------------------\n                static string[] BuildBodyParamArray(IDictionary<string, string> vars)\n                {\n                    // Accept both \"body.N\" and \"parameterN\"\n                    var pairs = new List<(int idx, string val)>();\n\n                    foreach (var kv in vars)\n                    {\n                        var k = kv.Key;\n\n                        // body.N\n                        if (k.StartsWith(\"body.\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            if (int.TryParse(k.AsSpan(\"body.\".Length), out var n) && n > 0)\n                                pairs.Add((n, kv.Value ?? string.Empty));\n                            continue;\n                        }\n\n                        // parameterN (compat)\n                        if (k.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            if (int.TryParse(k.AsSpan(\"parameter\".Length), out var n) && n > 0)\n                                pairs.Add((n, kv.Value ?? string.Empty));\n                        }\n                    }\n\n                    if (pairs.Count == 0) return Array.Empty<string>();\n\n                    var max = pairs.Max(p => p.idx);\n                    var arr = new string[max];\n                    for (int i = 0; i < max; i++) arr[i] = string.Empty;\n                    foreach (var (idx, val) in pairs) arr[idx - 1] = val ?? string.Empty;\n                    return arr;\n                }\n\n                static Dictionary<string, string> BuildHeaderAndButtonVars(IDictionary<string, string> vars)\n                {\n                    // We store non-body keys in ResolvedButtonUrlsJson (generic bag):\n                    // - header.image_url / header.video_url / header.document_url\n                    // - header.text.N\n                    // - button{1..3}.url_param\n                    var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n                    foreach (var kv in vars)\n                    {\n                        var k = kv.Key;\n                        var v = kv.Value ?? string.Empty;\n\n                        // header media urls\n                        if (k.StartsWith(\"header.\", StringComparison.OrdinalIgnoreCase) &&\n                           (k.EndsWith(\"_url\", StringComparison.OrdinalIgnoreCase) ||\n                            k.EndsWith(\".url\", StringComparison.OrdinalIgnoreCase)))\n                        {\n                            dict[k] = v;\n                            continue;\n                        }\n\n                        // header text placeholders: header.text.N\n                        if (k.StartsWith(\"header.text.\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            var tail = k.Substring(\"header.text.\".Length);\n                            if (int.TryParse(tail, out var n) && n > 0)\n                                dict[k] = v;\n                            continue;\n                        }\n\n                        // URL button param variants ‚Üí normalize to .url_param\n                        if (k.StartsWith(\"button\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            var normKey = k\n                                .Replace(\".url.param\", \".url_param\", StringComparison.OrdinalIgnoreCase)\n                                .Replace(\".urlparam\", \".url_param\", StringComparison.OrdinalIgnoreCase);\n\n                            if (normKey.EndsWith(\".url_param\", StringComparison.OrdinalIgnoreCase))\n                                dict[normKey] = v;\n                        }\n                    }\n\n                    return dict;\n                }\n                // --------------------------------------------------------------------\n\n                foreach (var r in rows)\n                {\n                    if (string.IsNullOrWhiteSpace(r.Phone))\n                        continue; // safety; missing phone rows were already filtered\n\n                    // Try to link to an existing Contact by normalized phone\n                    Guid? contactId = await _db.Contacts\n                        .Where(c => c.BusinessId == businessId && c.PhoneNumber == r.Phone)\n                        .Select(c => (Guid?)c.Id)\n                        .FirstOrDefaultAsync(ct);\n\n                    var variables = r.Variables ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n                    // Keep full variable map on AudienceMember for export/debug\n                    var attributesJson = JsonSerializer.Serialize(variables);\n\n                    // Shapes expected by sender:\n                    var bodyParams = BuildBodyParamArray(variables);            // string[] for {{1}}..{{N}}\n                    var headerAndButtons = BuildHeaderAndButtonVars(variables); // dict for header.* + button*.url_param\n\n                    var resolvedParamsJson = JsonSerializer.Serialize(bodyParams);\n                    var resolvedButtonsJson = JsonSerializer.Serialize(headerAndButtons);\n\n                    // Idempotency: include both body params and header/button vars\n                    var idemPayload = JsonSerializer.Serialize(new { p = bodyParams, b = headerAndButtons });\n                    var idempotencyKey = ComputeIdempotencyKey(campaignId, r.Phone, idemPayload);\n\n                    var member = new AudienceMember\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        AudienceId = audience.Id,\n                        ContactId = contactId,                 // stays null if no match\n                        PhoneE164 = r.Phone,                   // normalized earlier\n                        AttributesJson = attributesJson,\n                        IsTransientContact = !contactId.HasValue,\n                        CreatedAt = now,\n                        UpdatedAt = now\n                    };\n                    _db.AudienceMembers.Add(member);\n\n                    var recipient = new CampaignRecipient\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        CampaignId = campaignId,\n                        AudienceMemberId = member.Id,\n                        IdempotencyKey = idempotencyKey,\n                        ResolvedParametersJson = resolvedParamsJson,   // string[] (body)\n                        ResolvedButtonUrlsJson = resolvedButtonsJson,  // dict (header + buttons)\n                        MaterializedAt = now,\n                        Status = \"Pending\",\n                        UpdatedAt = now\n                    };\n\n                    if (contactId.HasValue)\n                        recipient.ContactId = contactId.Value;\n\n                    _db.CampaignRecipients.Add(recipient);\n                }\n\n                await _db.SaveChangesAsync(ct);\n                await tx.CommitAsync(ct);\n                return audience.Id;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Materialize persist failed\");\n                await tx.RollbackAsync(ct);\n                throw;\n            }\n        }\n\n\n        // ---------- Utils ----------\n        private static Dictionary<string, string> JsonToDict(string? json)\n        {\n            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            if (string.IsNullOrWhiteSpace(json)) return dict;\n\n            using var doc = JsonDocument.Parse(json);\n            if (doc.RootElement.ValueKind != JsonValueKind.Object) return dict;\n            foreach (var p in doc.RootElement.EnumerateObject())\n                dict[p.Name] = p.Value.ValueKind == JsonValueKind.Null ? \"\" : p.Value.ToString();\n\n            return dict;\n        }\n\n       \n        private static string NormalizePhoneMaybe(string? raw, bool normalize)\n        {\n            var s = raw?.Trim();\n            if (string.IsNullOrWhiteSpace(s)) return string.Empty;\n\n            // Keep digits only\n            var digits = new string(s.Where(char.IsDigit).ToArray());\n            if (digits.Length == 0) return string.Empty;\n\n            if (normalize)\n            {\n                // Preserve your current behavior for now (we'll make this country-aware in STEP 2):\n                // If it \"looks like\" a local Indian number (10 digits), prepend 91.\n                if (digits.Length == 10)\n                    digits = \"91\" + digits;\n                // Else leave as-is (assumed to already include country code).\n            }\n\n            // Ensure we store E.164 with '+' (DB and downstream should always see '+')\n            return \"+\" + digits;\n        }\n\n        private static string ComputeIdempotencyKey(Guid campaignId, string phone, string parametersJson)\n        {\n            var raw = $\"{campaignId}|{phone}|{parametersJson}\";\n            using var sha = SHA256.Create();\n            var bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(raw));\n            return Convert.ToHexString(bytes);\n        }\n\n        // NEW: fetch named BODY tokens by parsing WhatsAppTemplate.RawJson canonically.\n        private async Task<IReadOnlyList<string>> GetNamedBodyTokensAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            var data = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.MessageTemplate, c.TemplateId })\n                .FirstOrDefaultAsync(ct);\n\n            var templateName = !string.IsNullOrWhiteSpace(data?.TemplateId)\n                ? data!.TemplateId!\n                : (data?.MessageTemplate ?? string.Empty);\n\n            if (string.IsNullOrWhiteSpace(templateName))\n                return Array.Empty<string>();\n\n            var tpl = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == templateName)\n                .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (tpl == null) return Array.Empty<string>();\n\n            var summary = xbytechat.api.WhatsAppSettings.Helpers.TemplateJsonHelper\n                .SummarizeDetailed(tpl.RawJson, tpl.Body);\n\n            var names = summary.Placeholders\n                .Where(p => p.Location == xbytechat.api.WhatsAppSettings.Helpers.PlaceholderLocation.Body\n                         && p.Type == xbytechat.api.WhatsAppSettings.Helpers.PlaceholderType.Named)\n                .Select(p => p.Name!)\n                .Where(n => !string.IsNullOrWhiteSpace(n))\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)\n                .ToList();\n\n            return names;\n        }\n\n    }\n}\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignPreviewService.cs",
      "sha256": "f22c3c48656b000ef7cae70e285c577aeca2d1a1e68f34053854c8c676622b3d",
      "language": "csharp",
      "size": 11562,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog; // ‚úÖ use Serilog like the rest of your services\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignPreviewService\n    {\n        Task<CampaignPreviewResponseDto> PreviewAsync(Guid businessId, Guid campaignId, Guid? contactId);\n    }\n\n    public class CampaignPreviewService : ICampaignPreviewService\n    {\n        private readonly AppDbContext _db;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcher;\n        private readonly IUrlBuilderService _urlBuilder;\n\n        public CampaignPreviewService(\n            AppDbContext db,\n            IWhatsAppTemplateFetcherService templateFetcher,\n            IUrlBuilderService urlBuilder)\n        {\n            _db = db;\n            _templateFetcher = templateFetcher;\n            _urlBuilder = urlBuilder;\n        }\n\n        public async Task<CampaignPreviewResponseDto> PreviewAsync(Guid businessId, Guid campaignId, Guid? contactId)\n        {\n            try\n            {\n                Log.Information(\"üß™ Preview start | biz={BusinessId} campaign={CampaignId} contactId={ContactId}\",\n                    businessId, campaignId, contactId);\n\n                var campaign = await _db.Campaigns\n                    .AsNoTracking()\n                    .Include(c => c.MultiButtons)\n                    .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n                    .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n                if (campaign == null)\n                {\n                    Log.Warning(\"‚ùå Preview aborted: campaign not found | biz={BusinessId} campaign={CampaignId}\",\n                        businessId, campaignId);\n                    throw new InvalidOperationException(\"Campaign not found.\");\n                }\n\n                // Resolve template name (respect flow entry if any)\n                var templateName = await ResolveStartTemplateName(businessId, campaign);\n                Log.Information(\"üîé Preview resolved template | campaign={CampaignId} template={TemplateName}\",\n                    campaign.Id, templateName);\n\n                // Fetch template meta (body/buttons/lang/header)\n                var meta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n                if (meta == null)\n                {\n                    Log.Warning(\"‚ùå Preview aborted: template metadata not found | biz={BusinessId} template={TemplateName}\",\n                        businessId, templateName);\n                    throw new InvalidOperationException(\"Template metadata not found.\");\n                }\n\n                // Prepare parameters/body\n                var parsedParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n                var body = meta.Body ?? campaign.MessageTemplate ?? string.Empty;\n                var bodyPreview = TemplateParameterHelper.FillPlaceholders(body, parsedParams);\n\n                // Compute missing params (simple check: count vs supplied)\n                var missing = new List<string>();\n                if (meta.PlaceholderCount > 0)\n                {\n                    var supplied = parsedParams?.Count ?? 0;\n                    if (supplied < meta.PlaceholderCount)\n                    {\n                        for (int i = supplied + 1; i <= meta.PlaceholderCount; i++)\n                            missing.Add($\"{{{{{i}}}}} parameter is missing\");\n\n                        Log.Warning(\"‚ö†Ô∏è Preview found missing params | campaign={CampaignId} required={Required} supplied={Supplied}\",\n                            campaign.Id, meta.PlaceholderCount, supplied);\n                    }\n                }\n\n                // Choose contact for dynamic phone substitutions\n                var contact = await PickContactAsync(campaign, contactId);\n\n                // Buttons preview\n                var buttons = BuildButtonsPreview(campaign, meta, contact);\n\n                var result = new CampaignPreviewResponseDto\n                {\n                    CampaignId = campaign.Id,\n                    TemplateName = templateName,\n                    Language = meta.Language ?? \"en_US\",\n                    PlaceholderCount = meta.PlaceholderCount,\n                    BodyPreview = bodyPreview,\n                    MissingParams = missing,\n                    HasHeaderMedia = meta.HasImageHeader,\n                    HeaderType = meta.HasImageHeader ? \"IMAGE\" : null,\n                    Buttons = buttons\n                };\n\n                Log.Information(\"‚úÖ Preview ready | campaign={CampaignId} template={TemplateName} placeholders={Count}\",\n                    campaign.Id, templateName, meta.PlaceholderCount);\n\n                return result;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"üö® Preview failed | biz={BusinessId} campaign={CampaignId}\", businessId, campaignId);\n                throw; // let controller shape the HTTP response (keeps consistency with your pattern)\n            }\n        }\n\n        // ---------- helpers ----------\n\n        private async Task<string> ResolveStartTemplateName(Guid businessId, Campaign campaign)\n        {\n            string selected = campaign.TemplateId ?? campaign.MessageTemplate ?? string.Empty;\n            if (!campaign.CTAFlowConfigId.HasValue || campaign.CTAFlowConfigId.Value == Guid.Empty)\n                return selected;\n\n            var flow = await _db.CTAFlowConfigs\n                .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n                .FirstOrDefaultAsync(f => f.Id == campaign.CTAFlowConfigId.Value\n                                        && f.BusinessId == businessId\n                                        && f.IsActive);\n\n            if (flow == null || flow.Steps == null || flow.Steps.Count == 0)\n                return selected;\n\n            var incoming = new HashSet<Guid>(flow.Steps\n                .SelectMany(s => s.ButtonLinks)\n                .Where(l => l.NextStepId.HasValue)\n                .Select(l => l.NextStepId!.Value));\n\n            var entry = flow.Steps.OrderBy(s => s.StepOrder)\n                                  .FirstOrDefault(s => !incoming.Contains(s.Id));\n\n            return string.IsNullOrWhiteSpace(entry?.TemplateToSend) ? selected : entry!.TemplateToSend!;\n        }\n\n        private async Task<Contact?> PickContactAsync(Campaign campaign, Guid? requestedContactId)\n        {\n            if (requestedContactId.HasValue)\n            {\n                var specific = campaign.Recipients?.FirstOrDefault(r => r.ContactId == requestedContactId)?.Contact;\n                if (specific != null) return specific;\n\n                // allow direct lookup if not in recipients yet\n                return await _db.Contacts.FirstOrDefaultAsync(c =>\n                    c.Id == requestedContactId.Value && c.BusinessId == campaign.BusinessId);\n            }\n\n            // fallback: first recipient‚Äôs contact\n            return campaign.Recipients?.FirstOrDefault()?.Contact;\n        }\n\n        private List<ButtonPreviewDto> BuildButtonsPreview(Campaign campaign, TemplateMetadataDto meta, Contact? contact)\n        {\n            var result = new List<ButtonPreviewDto>();\n            var campaignButtons = campaign.MultiButtons?\n                .OrderBy(b => b.Position)\n                .Take(3)\n                .ToList() ?? new List<CampaignButton>();\n\n            var templateButtons = meta.ButtonParams ?? new List<ButtonMetadataDto>();\n            var total = Math.Min(3, Math.Min(campaignButtons.Count, templateButtons.Count));\n\n            for (int i = 0; i < total; i++)\n            {\n                var tplBtn = templateButtons[i];\n                var campBtn = campaignButtons[i];\n\n                var subType = (tplBtn.SubType ?? \"url\").ToLowerInvariant();\n                var baseParam = tplBtn.ParameterValue?.Trim();\n                var isDynamic = subType == \"url\" && !string.IsNullOrWhiteSpace(baseParam) && baseParam.Contains(\"{{\");\n\n                string? token = null;\n                string? previewUrl = null;\n                string? campaignValue = campBtn.Value?.Trim();\n\n                if (isDynamic && string.IsNullOrWhiteSpace(campaignValue))\n                {\n                    Log.Warning(\"‚ö†Ô∏è Preview: dynamic URL button without campaign value | campaign={CampaignId} idx={Index} label={Label}\",\n                        campaign.Id, i, tplBtn.Text ?? campBtn.Title ?? \"\");\n                }\n\n                if (isDynamic && !string.IsNullOrWhiteSpace(campaignValue))\n                {\n                    // optional phone substitution\n                    var phone = NormalizePhone(contact?.PhoneNumber);\n                    var replaced = campaignValue.Contains(\"{{1}}\")\n                        ? campaignValue.Replace(\"{{1}}\", Uri.EscapeDataString(phone ?? \"\"))\n                        : campaignValue;\n\n                    // Build tracked URL using a synthetic id (only for preview)\n                    var fakeLogId = Guid.NewGuid();\n                    var tracked = _urlBuilder.BuildTrackedButtonUrl(fakeLogId, i, campBtn.Title, NormalizeAbsoluteUrl(replaced));\n                    previewUrl = tracked;\n\n                    // extract token after \"/r/\"\n                    token = ExtractToken(tracked);\n                }\n\n                result.Add(new ButtonPreviewDto\n                {\n                    Index = i,\n                    Text = tplBtn.Text ?? campBtn.Title ?? \"\",\n                    Type = tplBtn.Type ?? \"URL\",\n                    IsDynamic = isDynamic,\n                    TemplateParamBase = baseParam,\n                    CampaignValue = campaignValue,\n                    TokenParam = token,\n                    FinalUrlPreview = previewUrl\n                });\n            }\n\n            return result;\n        }\n\n        private static string? NormalizePhone(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n            var s = raw.Trim();\n            if (!s.StartsWith(\"+\")) s = \"+\" + new string(s.Where(char.IsDigit).ToArray());\n            return s;\n        }\n\n        private static string NormalizeAbsoluteUrl(string input)\n        {\n            // allow tel:/wa: for preview, but tracking expects http(s); if not absolute http(s), keep as-is.\n            if (Uri.TryCreate(input, UriKind.Absolute, out var uri) &&\n                (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                 uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase)))\n            {\n                return uri.ToString();\n            }\n            return input;\n        }\n\n        private static string? ExtractToken(string fullTrackedUrl)\n        {\n            var pos = fullTrackedUrl.LastIndexOf(\"/r/\", StringComparison.OrdinalIgnoreCase);\n            if (pos < 0) return null;\n            var token = fullTrackedUrl[(pos + 3)..];\n            return string.IsNullOrWhiteSpace(token) ? null : token;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignRecipientService.cs",
      "sha256": "e0358b199dc50d69cfdffcfdfb6c907f19eabdb54356a4f879a52e34ea570418",
      "language": "csharp",
      "size": 7985,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class CampaignRecipientService : ICampaignRecipientService\n    {\n        private readonly AppDbContext _context;\n\n        public CampaignRecipientService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        public async Task<CampaignRecipientDto?> GetByIdAsync(Guid businessId, Guid id)\n        {\n            return await _context.CampaignRecipients\n                .AsNoTracking()\n                .Include(r => r.Contact)\n                .Include(r => r.AudienceMember)\n                .Where(r => r.BusinessId == businessId && r.Id == id)\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact != null\n                        ? (r.Contact.Name ?? string.Empty)\n                        : (r.AudienceMember != null ? (r.AudienceMember.Name ?? string.Empty) : string.Empty),\n                    ContactPhone = r.Contact != null\n                        ? (r.Contact.PhoneNumber ?? string.Empty)\n                        : (r.AudienceMember != null ? (r.AudienceMember.PhoneE164 ?? r.AudienceMember.PhoneRaw ?? string.Empty) : string.Empty),\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .FirstOrDefaultAsync();\n        }\n\n        public async Task<List<CampaignRecipientDto>> GetByCampaignIdAsync(Guid businessId, Guid campaignId)\n        {\n            return await _context.CampaignRecipients\n                .AsNoTracking()\n                .Include(r => r.Contact)\n                .Include(r => r.AudienceMember)\n                .Where(r => r.BusinessId == businessId && r.CampaignId == campaignId)\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact != null\n                        ? (r.Contact.Name ?? string.Empty)\n                        : (r.AudienceMember != null ? (r.AudienceMember.Name ?? string.Empty) : string.Empty),\n                    ContactPhone = r.Contact != null\n                        ? (r.Contact.PhoneNumber ?? string.Empty)\n                        : (r.AudienceMember != null ? (r.AudienceMember.PhoneE164 ?? r.AudienceMember.PhoneRaw ?? string.Empty) : string.Empty),\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .ToListAsync();\n        }\n\n        public async Task<bool> UpdateStatusAsync(Guid businessId, Guid recipientId, string newStatus)\n        {\n            var recipient = await _context.CampaignRecipients\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == recipientId);\n            if (recipient == null) return false;\n\n            recipient.Status = newStatus;\n            recipient.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> TrackReplyAsync(Guid businessId, Guid recipientId, string replyText)\n        {\n            var recipient = await _context.CampaignRecipients\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == recipientId);\n            if (recipient == null) return false;\n\n            recipient.ClickedCTA = replyText;\n            recipient.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<List<CampaignRecipientDto>> SearchRecipientsAsync(Guid businessId, string? status = null, string? keyword = null)\n        {\n            var query = _context.CampaignRecipients\n                .AsNoTracking()\n                .Include(r => r.Contact)\n                .Include(r => r.AudienceMember)\n                .Where(r => r.BusinessId == businessId)\n                .AsQueryable();\n\n            if (!string.IsNullOrWhiteSpace(status))\n                query = query.Where(r => r.Status == status);\n\n            if (!string.IsNullOrWhiteSpace(keyword))\n            {\n                query = query.Where(r =>\n                    (r.Contact != null &&\n                     ((r.Contact.Name != null && r.Contact.Name.Contains(keyword)) ||\n                      (r.Contact.PhoneNumber != null && r.Contact.PhoneNumber.Contains(keyword))))\n                    ||\n                    (r.AudienceMember != null &&\n                     ((r.AudienceMember.Name != null && r.AudienceMember.Name.Contains(keyword)) ||\n                      (r.AudienceMember.PhoneE164 != null && r.AudienceMember.PhoneE164.Contains(keyword)) ||\n                      (r.AudienceMember.PhoneRaw != null && r.AudienceMember.PhoneRaw.Contains(keyword)))));\n            }\n\n            return await query\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact != null\n                        ? (r.Contact.Name ?? string.Empty)\n                        : (r.AudienceMember != null ? (r.AudienceMember.Name ?? string.Empty) : string.Empty),\n                    ContactPhone = r.Contact != null\n                        ? (r.Contact.PhoneNumber ?? string.Empty)\n                        : (r.AudienceMember != null ? (r.AudienceMember.PhoneE164 ?? r.AudienceMember.PhoneRaw ?? string.Empty) : string.Empty),\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .ToListAsync();\n        }\n\n        public async Task AssignContactsToCampaignAsync(Guid businessId, Guid campaignId, List<Guid> contactIds)\n        {\n            var campaign = await _context.Campaigns\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n            if (campaign == null)\n                throw new Exception(\"Campaign not found.\");\n\n            var now = DateTime.UtcNow;\n\n            var contactIdsClean = (contactIds ?? new List<Guid>())\n                .Where(id => id != Guid.Empty)\n                .Distinct()\n                .ToList();\n\n            if (contactIdsClean.Count == 0)\n                return;\n\n            var validContactIds = await _context.Contacts\n                .Where(c => c.BusinessId == businessId && contactIdsClean.Contains(c.Id))\n                .Select(c => c.Id)\n                .ToListAsync();\n\n            if (validContactIds.Count == 0)\n                return;\n\n            var existingContactIds = await _context.CampaignRecipients\n                .Where(r => r.BusinessId == businessId\n                            && r.CampaignId == campaignId\n                            && r.ContactId.HasValue\n                            && validContactIds.Contains(r.ContactId.Value))\n                .Select(r => r.ContactId!.Value)\n                .ToListAsync();\n\n            var newContactIds = validContactIds.Except(existingContactIds).ToList();\n            if (newContactIds.Count == 0)\n                return;\n\n            var newRecipients = newContactIds.Select(contactId => new CampaignRecipient\n            {\n                Id = Guid.NewGuid(),\n                CampaignId = campaignId,\n                BusinessId = businessId,\n                ContactId = contactId,\n                Status = \"Pending\",\n                MaterializedAt = now,\n                SentAt = null,\n                UpdatedAt = now,\n                IsAutoTagged = false\n            }).ToList();\n\n            await _context.CampaignRecipients.AddRangeAsync(newRecipients);\n            await _context.SaveChangesAsync();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignRetargetService.cs",
      "sha256": "de4c8f04dbba3400712d2a5a1e2abc42a39dd682d67c30ecdbabb28de127ecdd",
      "language": "csharp",
      "size": 3083,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class CampaignRetargetService : ICampaignRetargetService\n    {\n        private readonly AppDbContext _db;\n        private readonly ICampaignService _campaignService;\n\n        public CampaignRetargetService(AppDbContext db, ICampaignService campaignService)\n        {\n            _db = db;\n            _campaignService = campaignService;\n        }\n\n        public async Task<RetargetCampaignResponseDto> CreateRetargetCampaignAsync(\n            Guid businessId,\n            RetargetCampaignRequestDto dto,\n            string createdBy,\n            CancellationToken ct)\n        {\n            if (dto?.Campaign == null)\n                throw new ArgumentException(\"Campaign payload is required.\");\n\n            // 1) Enforce name presence (pre-validation in controller is better, but guard here too)\n            var campaignName = dto.Name?.Trim() ?? dto.Campaign.Name?.Trim();\n            if (string.IsNullOrWhiteSpace(campaignName))\n                throw new ArgumentException(\"Campaign name is required for retargeting.\");\n\n            dto.Campaign.Name = campaignName;\n\n            // 2) Combine ContactIds and RecipientPhones\n            var contactIds = dto.ContactIds?.Where(x => x != Guid.Empty).Distinct().ToList() ?? new();\n            var phones = dto.RecipientPhones?.Where(x => !string.IsNullOrWhiteSpace(x))\n                                            .Select(x => x.Trim())\n                                            .Distinct()\n                                            .ToList() ?? new();\n\n            if (phones.Any())\n            {\n                var resolvedIds = await _db.Contacts\n                    .AsNoTracking()\n                    .Where(c => c.BusinessId == businessId && phones.Contains(c.PhoneNumber))\n                    .Select(c => c.Id)\n                    .ToListAsync(ct);\n                \n                contactIds.AddRange(resolvedIds);\n                contactIds = contactIds.Distinct().ToList();\n            }\n\n            // 3) Populate Campaign DTO for reuse\n            dto.Campaign.ContactIds = contactIds;\n            \n            // 4) Call existing CampaignService logic (handles name guards, templates, jobs, etc.)\n            // Status is forced to 'Draft' or 'Scheduled' inside CreateTextCampaignAsync based on dto.ScheduledAt\n            var newId = await _campaignService.CreateTextCampaignAsync(dto.Campaign, businessId, createdBy);\n\n            if (newId == null)\n                throw new Exception(\"Failed to create campaign via CampaignService.\");\n\n            return new RetargetCampaignResponseDto\n            {\n                NewCampaignId = newId.Value,\n                MaterializedRecipients = contactIds.Count,\n                SkippedDuplicates = 0 // Deduplication is handled by CampaignService (unique ContactIds)\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignRetryService.cs",
      "sha256": "0e4a2ec463e21ef4eb537bc3ae1cae0e54f3c9282b73bfb666017834dab474f2",
      "language": "csharp",
      "size": 4212,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n \n    public sealed class CampaignRetryService : ICampaignRetryService\n    {\n        private readonly AppDbContext _db;\n        private readonly CampaignService _campaignService; // use concrete to reach batch method\n\n        public CampaignRetryService(AppDbContext db, ICampaignService campaignService)\n        {\n            _db = db;\n            // We know our concrete implementation exposes the batch entry.\n            _campaignService = (CampaignService)campaignService;\n        }\n\n        public async Task<CampaignRetryResultDto> RetryFailedAsync(Guid businessId, Guid campaignId, int limit = 200)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required\");\n            if (limit <= 0) limit = 200;\n\n            var exists = await _db.Campaigns\n                .AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId && !c.IsDeleted);\n            if (!exists) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Most recent log per recipient, keep only those whose latest is Failed\n            var failedQuery =\n                from log in _db.CampaignSendLogs.AsNoTracking()\n                where log.BusinessId == businessId && log.CampaignId == campaignId\n                group log by log.RecipientId into g\n                let last = g.OrderByDescending(x => x.CreatedAt).First()\n                where last.SendStatus == \"Failed\"\n                select new { RecipientId = last.RecipientId }; // <-- Guid (non-nullable)\n\n            var failed = await failedQuery\n                .Select(x => x.RecipientId)   // <-- no .Value\n                .Distinct()\n                .Take(limit)\n                .ToListAsync();\n\n            var result = new CampaignRetryResultDto\n            {\n                CampaignId = campaignId,\n                ConsideredFailed = failed.Count\n            };\n\n            if (failed.Count == 0)\n            {\n                result.Note = \"No failed recipients found to retry.\";\n                return result;\n            }\n\n            // Filter out recipients whose latest log is Sent (paranoia/safety)\n            var latestOkQuery =\n                from log in _db.CampaignSendLogs.AsNoTracking()\n                where log.BusinessId == businessId && log.CampaignId == campaignId\n                group log by log.RecipientId into g\n                let last = g.OrderByDescending(x => x.CreatedAt).First()\n                where last.SendStatus == \"Sent\"\n                select new { RecipientId = last.RecipientId }; // Guid\n\n            var alreadyOk = await latestOkQuery\n                .Select(x => x.RecipientId)\n                .ToListAsync();\n\n            var toRetry = failed.Except(alreadyOk).ToList();\n            result.Skipped = failed.Count - toRetry.Count;\n\n            if (toRetry.Count == 0)\n            {\n                result.Note = \"All failed recipients appear to have a later successful send.\";\n                return result;\n            }\n\n            // Send the batch via canonical pipeline (freezing + idempotency safeguard)\n            var resp = await _campaignService.SendTemplateCampaignBatchAsync(campaignId, toRetry);\n\n            result.Retried = resp.Success ? toRetry.Count : 0;\n            result.Note = resp.Success ? \"Retry dispatched.\" : (\"Retry failed: \" + (resp.Message ?? \"Unknown error.\"));\n            result.RecipientIdsSample = toRetry.Take(20).ToList();\n\n            Log.Information(\"Campaign retry executed {@Retry}\", new\n            {\n                businessId,\n                campaignId,\n                consideredFailed = result.ConsideredFailed,\n                skipped = result.Skipped,\n                retried = result.Retried\n            });\n\n            return result;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignService.BatchSend.cs",
      "sha256": "9d3785359f7dace6742cd0602183c331c17695aa9c1cbfb7346421d774cdaf0c",
      "language": "csharp",
      "size": 1876,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public partial class CampaignService\n    {\n        /// <summary>\n        /// Sends a text/template campaign to a given subset of recipient IDs (batch).\n        /// Leverages the same pipeline & idempotency you just implemented.\n        /// </summary>\n        public async Task<ResponseResult> SendTemplateCampaignBatchAsync(Guid campaignId, IEnumerable<Guid> recipientIds)\n        {\n            if (campaignId == Guid.Empty) return ResponseResult.ErrorInfo(\"Invalid campaign id.\");\n            var ids = recipientIds?.Where(id => id != Guid.Empty).Distinct().ToList() ?? new List<Guid>();\n            if (ids.Count == 0) return ResponseResult.ErrorInfo(\"No recipients to send in this batch.\");\n\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients.Where(r => ids.Contains(r.Id))).ThenInclude(r => r.Contact)\n                .Include(c => c.MultiButtons)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && !c.IsDeleted);\n\n            if (campaign == null) return ResponseResult.ErrorInfo(\"Campaign not found.\");\n            if (campaign.Recipients == null || campaign.Recipients.Count == 0)\n                return ResponseResult.ErrorInfo(\"No batch recipients matched this campaign.\");\n\n            // Reuse your existing method that sends a single campaign object with its recipients loaded.\n            // It already handles: provider resolution, template meta, freezing params/URLs,\n            // idempotency key, logs, and billing ingest.\n            return await SendTextTemplateCampaignAsync(campaign);\n        }\n    }\n}\n"
    }
  ]
}
