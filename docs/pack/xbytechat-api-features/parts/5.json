{
  "name": "xbytechat-api/Features",
  "part": 5,
  "of": 6,
  "generatedAt": "2026-02-11 19:15:17 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/MessagesEngine/Factory/WhatsAppProviderFactory.cs",
      "sha256": "4277e6669492d91b902efa2b8002e0f31b0523da3c9f5f3edbb7ff45d0462513",
      "language": "csharp",
      "size": 11987,
      "content": "using System;\nusing System.Net.Http;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat.api.Features.MessagesEngine.Providers;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing static System.Net.WebRequestMethods;\nusing static System.Runtime.InteropServices.JavaScript.JSType;\n\nnamespace xbytechat.api.Features.MessagesEngine.Factory\n{\n    public class WhatsAppProviderFactory : IWhatsAppProviderFactory\n    {\n        private readonly IServiceProvider _sp;\n        private readonly AppDbContext _db;\n        private readonly ILogger<WhatsAppProviderFactory> _logger;\n\n        public WhatsAppProviderFactory(IServiceProvider sp, AppDbContext db, ILogger<WhatsAppProviderFactory> logger)\n        {\n            _sp = sp;\n            _db = db;\n            _logger = logger;\n        }\n\n        //public async Task<IWhatsAppProvider> CreateAsync(Guid businessId)\n        //{\n        //    var setting = await _db.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n        //        ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n        //    var providerKey = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n\n        //    using var scope = _sp.CreateScope();\n\n        //    var httpClientFactory = scope.ServiceProvider.GetService<IHttpClientFactory>();\n        //    var http =\n        //        httpClientFactory != null\n        //            ? httpClientFactory.CreateClient(providerKey == \"meta_cloud\" ? \"wa:meta_cloud\" : \"wa:pinnacle\")\n        //            : scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n        //    return providerKey switch\n        //    {\n        //        //\"pinnacle\" =>\n        //        //            new PinnacleProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(), setting),\n        //        \"pinnacle\" => new PinnacleProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(), setting),\n        //        \"meta_cloud\" =>\n        //            new MetaCloudProvider(_db, http, scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(), setting),\n\n        //        _ => throw new NotSupportedException($\"Unsupported WhatsApp provider: {providerKey}\")\n        //    };\n        //}\n\n\n\n        //public async Task<IWhatsAppProvider> CreateAsync(Guid businessId, string? phoneNumberId)\n        //{\n        //    var setting = await _db.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n        //        ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n        //    // per-send override of the sender number (in-memory only)\n        //    if (!string.IsNullOrWhiteSpace(phoneNumberId))\n        //        setting.PhoneNumberId = phoneNumberId.Trim();\n\n        //    var providerKey = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n\n        //    using var scope = _sp.CreateScope();\n\n        //    var httpClientFactory = scope.ServiceProvider.GetService<IHttpClientFactory>();\n        //    var http =\n        //        httpClientFactory != null\n        //            ? httpClientFactory.CreateClient(providerKey == \"meta_cloud\" ? \"wa:meta_cloud\" : \"wa:pinnacle\")\n        //            : scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n        //    return providerKey switch\n        //    {\n        //        \"pinnacle\" => new PinnacleProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(), setting),\n        //        \"meta_cloud\" => new MetaCloudProvider(_db, http, scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(), setting),\n        //        _ => throw new NotSupportedException($\"Unsupported WhatsApp provider: {providerKey}\")\n        //    };\n        //}\n\n        public async Task<IWhatsAppProvider> CreateAsync(Guid businessId)\n        {\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n                ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n            // Canonical provider: META_CLOUD | PINNACLE (ALL CAPS)\n            var provider = (setting.Provider ?? \"META_CLOUD\")\n                .Trim()\n                .Replace(\"-\", \"_\")\n                .Replace(\" \", \"_\")\n                .ToUpperInvariant();\n\n            using var scope = _sp.CreateScope();\n\n            var httpFactory = scope.ServiceProvider.GetService<IHttpClientFactory>();\n            var clientName = provider == \"META_CLOUD\" ? \"wa:meta_cloud\" : \"wa:pinnacle\"; // named client key\n            var http = httpFactory != null\n                ? httpFactory.CreateClient(clientName)\n                : scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n            switch (provider)\n            {\n                case \"PINNACLE\":\n                    {\n                        // Prefer WABA id; else default active number for PINNACLE\n                        string? pathIdOverride = !string.IsNullOrWhiteSpace(setting.WabaId)\n                            ? setting.WabaId!.Trim()\n                            : await _db.WhatsAppPhoneNumbers\n                                .AsNoTracking()\n                                .Where(p => p.BusinessId == businessId\n                                            && p.IsActive\n                                            && p.Provider.ToUpper() == \"PINNACLE\")\n                                .OrderByDescending(p => p.IsDefault)\n                                .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                                .Select(p => p.PhoneNumberId)\n                                .FirstOrDefaultAsync();\n\n                        return new PinnacleProvider(\n                            _db,\n                            http,\n                            scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(),\n                            setting,\n                            pathIdOverride);\n                    }\n\n                case \"META_CLOUD\":\n                    return new MetaCloudProvider(\n                        _db,\n                        http,\n                        scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(),\n                        setting);\n\n                default:\n                    throw new NotSupportedException($\"Unsupported WhatsApp provider: {provider}\");\n            }\n        }\n\n        public async Task<IWhatsAppProvider> CreateAsync(Guid businessId, string provider, string? phoneNumberId)\n        {\n            if (string.IsNullOrWhiteSpace(provider))\n                throw new ArgumentException(\"Provider is required.\", nameof(provider));\n\n            // Canonical provider: PINNACLE | META_CLOUD (ALL CAPS)\n            provider = provider.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            if (provider is not (\"PINNACLE\" or \"META_CLOUD\"))\n                throw new NotSupportedException($\"Unsupported provider: {provider}\");\n\n            // If a sender was chosen, ensure it belongs to THIS business+provider\n            if (!string.IsNullOrWhiteSpace(phoneNumberId))\n            {\n                var exists = await _db.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .AnyAsync(n => n.BusinessId == businessId\n                                   && n.Provider.ToUpper() == provider\n                                   && n.PhoneNumberId == phoneNumberId);\n                if (!exists)\n                    throw new InvalidOperationException(\n                        \"Selected PhoneNumberId does not belong to this provider/business.\");\n            }\n\n            // Load the settings row for the exact (BusinessId, Provider)\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId\n                                          && s.IsActive\n                                          && s.Provider.ToUpper() == provider)\n                ?? throw new InvalidOperationException(\n                    $\"WhatsApp settings not found for provider {provider}.\");\n\n            if (string.IsNullOrWhiteSpace(setting.ApiUrl))\n                throw new InvalidOperationException(\"API URL is empty. Save provider settings first.\");\n            if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                throw new InvalidOperationException(\"API Key/Token is empty. Save provider settings first.\");\n\n            using var scope = _sp.CreateScope();\n            var http = scope.ServiceProvider\n                .GetRequiredService<IHttpClientFactory>()\n                .CreateClient(provider == \"META_CLOUD\" ? \"wa:meta_cloud\" : \"wa:pinnacle\");\n\n            // NOTE: providers accept optional overrides; do NOT write into settings\n            return provider switch\n            {\n                \"PINNACLE\" => new PinnacleProvider(\n                    _db,\n                    http,\n                    scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(),\n                    setting,\n                    pathIdOverride: string.IsNullOrWhiteSpace(phoneNumberId) ? setting.WabaId : phoneNumberId),\n\n                \"META_CLOUD\" => new MetaCloudProvider(\n                    _db,\n                    http,\n                    scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(),\n                    setting,\n                    phoneNumberIdOverride: phoneNumberId),\n\n                _ => throw new NotSupportedException($\"Unsupported provider: {provider}\")\n            };\n        }\n\n    }\n}\n\n\n//// üìÑ File: Features/MessagesEngine/Factory/WhatsAppProviderFactory.cs\n//using System;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.DependencyInjection;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api;\n//using xbytechat.api.Features.MessagesEngine.Abstractions;\n//using xbytechat.api.Features.MessagesEngine.Providers;\n\n//namespace xbytechat.api.Features.MessagesEngine.Factory\n//{\n\n//    public class WhatsAppProviderFactory : IWhatsAppProviderFactory\n//    {\n//        private readonly IServiceProvider _sp;\n//        private readonly AppDbContext _db;\n//        private readonly ILogger<WhatsAppProviderFactory> _logger;\n\n//        public WhatsAppProviderFactory(IServiceProvider sp, AppDbContext db, ILogger<WhatsAppProviderFactory> logger)\n//        {\n//            _sp = sp;\n//            _db = db;\n//            _logger = logger;\n//        }\n\n//        public async Task<IWhatsAppProvider> CreateAsync(Guid businessId)\n//        {\n//            var setting = await _db.WhatsAppSettings.FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n//                          ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n//            var providerKey = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n\n//            // Create a new scope to inject the per-tenant setting into provider constructor\n//            var scope = _sp.CreateScope();\n//            var http = scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n//            return providerKey switch\n//            {\n//                \"pinnacle\" => new PinbotProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinbotProvider>>(), setting),\n//                \"meta_cloud\" => new MetaCloudProvider(_db, http, scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(), setting),\n//                _ => throw new NotSupportedException($\"Unsupported WhatsApp provider: {providerKey}\")\n//            };\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Outbox/OutboxMessage.cs",
      "sha256": "caa5c09bc7c28e6aaa5bb1aa93cd76f38c41f5c2754790d9c45f6af037ed1a25",
      "language": "csharp",
      "size": 1109,
      "content": "using System;\n\nnamespace xbytechat.api.Features.MessagesEngine.Outbox\n{\n    public enum OutboxStatus\n    {\n        Queued = 0,\n        Sending = 1,\n        Sent = 2,\n        Failed = 3\n    }\n\n    public class OutboxMessage\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid? CampaignId { get; set; }\n        public Guid? ContactId { get; set; }\n\n        public string RecipientNumber { get; set; } = \"\";\n        public string ProviderKey { get; set; } = \"\"; // \"meta_cloud\" | \"pinnacle\" (optional hint)\n        public string PayloadJson { get; set; } = \"\"; // serialized MessageEnvelope\n        public string CorrelationId { get; set; } = \"\"; // for idempotency & tracing\n\n        public OutboxStatus Status { get; set; } = OutboxStatus.Queued;\n        public int AttemptCount { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime? NextAttemptAt { get; set; } = DateTime.UtcNow;\n        public string? LastError { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/CtaMessagePayloadBuilder.cs",
      "sha256": "f23794fdb8775eff63c5d249f23e74b7ff5e4497daa7b255ce94693b3ba9a6f7",
      "language": "csharp",
      "size": 1063,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class CtaMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"interactive\",\n                interactive = new\n                {\n                    type = \"button\",\n                    body = new { text = dto.TextContent },\n                    action = new\n                    {\n                        buttons = dto.CtaButtons?.Select(b => new\n                        {\n                            type = \"reply\",\n                            reply = new\n                            {\n                                id = b.Value,\n                                title = b.Title\n                            }\n                        }).ToList()\n                    }\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/ImageMessagePayloadBuilder.cs",
      "sha256": "1400148a9ed0b32af7ece6c87b111a1407feda0f5b651819257c5b740bb01106",
      "language": "csharp",
      "size": 554,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class ImageMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"image\",\n                image = new\n                {\n                    link = dto.MediaUrl\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/IWhatsAppPayloadBuilder.cs",
      "sha256": "89d6b688ba597eb931cd71401717698a692f3e3b645a02d60c1d73dae24731d3",
      "language": "csharp",
      "size": 225,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public interface IWhatsAppPayloadBuilder\n    {\n        object BuildPayload(SendMessageDto dto);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/MessagePayloadBuilder.cs",
      "sha256": "ec8606e744a878efdd7f12dadcc799b2aaf290e66c9e419f639672d0003b4bd0",
      "language": "csharp",
      "size": 7842,
      "content": "// Features/MessagesEngine/PayloadBuilders/MessagePayloadBuilder.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public static class MessagePayloadBuilder\n    {\n        // New: a single canonical builder that understands our CSV-materialized shapes.\n        public static object BuildTemplatePayload(\n            string toPhoneE164,\n            string templateName,\n            string languageCode,\n            string headerType,                 // \"none\"|\"text\"|\"image\"|\"video\"|\"document\"\n            string? headerMediaUrl,            // for image/video/document\n            IReadOnlyList<string> bodyParams,  // {{1}}..{{N}}\n            IReadOnlyList<string>? headerTextParams, // header text {{n}} if headerType==\"text\"\n            IReadOnlyDictionary<string, string>? buttonUrlParams // keys: \"button1.url_param\"..\"button3.url_param\"\n        )\n        {\n            var components = new List<object>();\n\n            // 1) HEADER\n            switch ((headerType ?? \"none\").ToLowerInvariant())\n            {\n                case \"text\":\n                    if (headerTextParams != null && headerTextParams.Count > 0)\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = headerTextParams.Select(v => new { type = \"text\", text = v ?? string.Empty }).ToArray()\n                        });\n                    }\n                    break;\n\n                case \"image\":\n                    if (!string.IsNullOrWhiteSpace(headerMediaUrl))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"image\", image = new { link = headerMediaUrl } }\n                            }\n                        });\n                    }\n                    break;\n\n                case \"video\":\n                    if (!string.IsNullOrWhiteSpace(headerMediaUrl))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"video\", video = new { link = headerMediaUrl } }\n                            }\n                        });\n                    }\n                    break;\n\n                case \"document\":\n                    if (!string.IsNullOrWhiteSpace(headerMediaUrl))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"document\", document = new { link = headerMediaUrl } }\n                            }\n                        });\n                    }\n                    break;\n            }\n\n            // 2) BODY\n            if (bodyParams != null && bodyParams.Count > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = bodyParams.Select(v => new { type = \"text\", text = v ?? string.Empty }).ToArray()\n                });\n            }\n\n            // 3) BUTTONS (URL dynamic only)\n            // Expect buttonUrlParams: button{1..3}.url_param -> string\n            if (buttonUrlParams != null && buttonUrlParams.Count > 0)\n            {\n                var buttons = new List<object>();\n\n                for (var pos = 1; pos <= 3; pos++)\n                {\n                    var key = $\"button{pos}.url_param\";\n                    if (buttonUrlParams.TryGetValue(key, out var val) && !string.IsNullOrWhiteSpace(val))\n                    {\n                        buttons.Add(new\n                        {\n                            type = \"button\",\n                            sub_type = \"url\",\n                            index = pos - 1, // Meta expects 0-based index\n                            parameters = new object[]\n                            {\n                                new { type = \"text\", text = val }\n                            }\n                        });\n                    }\n                }\n\n                if (buttons.Count > 0)\n                {\n                    components.AddRange(buttons);\n                }\n            }\n\n            // Meta/Pinnacle style template envelope\n            var payload = new\n            {\n                messaging_product = \"whatsapp\",\n                to = toPhoneE164,\n                type = \"template\",\n                template = new\n                {\n                    name = templateName,\n                    language = new { code = languageCode }, // << not hardcoded\n                    components = components.ToArray()\n                }\n            };\n\n            return payload;\n        }\n    }\n}\n\n\n//using xbytechat.api.Features.CampaignModule.Models;\n//using xbytechat.api.Shared.utility;\n\n//namespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n//{\n//    public static class MessagePayloadBuilder\n//    {\n//        /// <summary>\n//        /// Builds a WhatsApp template message payload for image header + buttons.\n//        /// </summary>\n//        public static object BuildImageTemplatePayload(\n//            string templateName,\n//            string languageCode,\n//            string recipientNumber,\n//            List<string> templateParams,\n//            string? imageUrl,\n//            List<CampaignButton>? buttons\n//        )\n//        {\n//            var components = new List<object>();\n\n//            // ‚úÖ Body with template params\n//            if (templateParams != null && templateParams.Any())\n//            {\n//                components.Add(new\n//                {\n//                    type = \"body\",\n//                    parameters = templateParams.Select(p => new { type = \"text\", text = p }).ToArray()\n//                });\n//            }\n\n//            // ‚úÖ Header image if present\n//            if (!string.IsNullOrWhiteSpace(imageUrl))\n//            {\n//                components.Add(new\n//                {\n//                    type = \"header\",\n//                    parameters = new[]\n//                    {\n//                    new { type = \"image\", image = new { link = imageUrl } }\n//                }\n//                });\n//            }\n\n//            // ‚úÖ CTA buttons\n//            if (buttons != null && buttons.Any())\n//            {\n//                var buttonComponents = buttons\n//                    .OrderBy(b => b.Position)\n//                    .Take(3)\n//                    .Select((btn, index) => new\n//                    {\n//                        type = \"button\",\n//                        sub_type = btn.Type, // \"url\" or \"phone_number\"\n//                        index = index.ToString(),\n//                        parameters = new[]\n//                        {\n//                        new { type = \"text\", text = btn.Value }\n//                        }\n//                    });\n\n//                components.AddRange(buttonComponents);\n//            }\n\n//            // ‚úÖ Final WhatsApp Template Payload\n//            return new\n//            {\n//                messaging_product = \"whatsapp\",\n//                to = recipientNumber,\n//                type = \"template\",\n//                template = new\n//                {\n//                    name = templateName,\n//                    language = new { code = languageCode },\n//                    components = components\n//                }\n//            };\n//        }\n//    }\n\n//}"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/TemplateMessagePayloadBuilder.cs",
      "sha256": "1beb36776f57bf30bf67df07af07052f4d5fe2609dfe6a4015bf512dff64aee8",
      "language": "csharp",
      "size": 5342,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class TemplateMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            if (dto == null) throw new ArgumentNullException(nameof(dto));\n            if (string.IsNullOrWhiteSpace(dto.TemplateName))\n                throw new ArgumentException(\"TemplateName is required.\");\n            if (dto.TemplateParameters == null || dto.TemplateParameters.Count == 0)\n                throw new ArgumentException(\"TemplateParameters are required for template messages.\");\n\n            // Sort by placeholder index like {{1}}, {{2}}, guarding against bad keys\n            var bodyParams = dto.TemplateParameters\n                .Select(kvp =>\n                {\n                    var key = kvp.Key?.Trim('{', '}');\n                    _ = int.TryParse(key, out var idx);\n                    return (idx, kvp.Value);\n                })\n                .OrderBy(t => t.idx)\n                .Select(t => new { type = \"text\", text = t.Value })\n                .ToArray();\n\n            var components = new List<object>\n            {\n                new { type = \"body\", parameters = bodyParams }\n            };\n\n            if (dto.ButtonParams != null && dto.ButtonParams.Any())\n            {\n                for (int i = 0; i < dto.ButtonParams.Count; i++)\n                {\n                    components.Add(new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i.ToString(),\n                        parameters = new[]\n                        {\n                            new { type = \"text\", text = dto.ButtonParams[i] }\n                        }\n                    });\n                }\n            }\n\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"template\",\n                template = new\n                {\n                    name = dto.TemplateName,\n                    language = new { code = \"en_US\" },\n                    components\n                }\n            };\n        }\n    }\n}\n\n\n//using xbytechat.api.Features.MessagesEngine.DTOs;\n//using xbytechat.api.Helpers;\n\n//namespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n//{\n//    public class TemplateMessagePayloadBuilder : IWhatsAppPayloadBuilder\n//    {\n//        public object BuildPayload(SendMessageDto dto)\n//        {\n//            var components = new List<object>();\n\n//            // ‚úÖ BODY PARAMETERS: Insert dynamic values into the template body\n//            // WhatsApp expects these to be in order ({{1}}, {{2}}, etc.)\n//            if (dto.TemplateParameters == null || dto.TemplateParameters.Count == 0)\n//                return ResponseResult.ErrorInfo(\"‚ùå Missing template parameters.\");\n//            if (dto.TemplateParameters != null && dto.TemplateParameters.Any())\n//                {\n//                var bodyParams = dto.TemplateParameters\n//                    .OrderBy(kvp => int.Parse(kvp.Key.Trim('{', '}'))) // üî¢ Extract and sort by index\n//                    .Select(kvp => new\n//                    {\n//                        type = \"text\",\n//                        text = kvp.Value\n//                    }).ToArray();\n\n//                components.Add(new\n//                {\n//                    type = \"body\",\n//                    parameters = bodyParams\n//                });\n//            }\n\n//            // ‚úÖ BUTTON PARAMETERS: For templates with dynamic URL buttons (index-based)\n//            if (dto.ButtonParams != null && dto.ButtonParams.Any())\n//            {\n//                for (int i = 0; i < dto.ButtonParams.Count; i++)\n//                {\n//                    components.Add(new\n//                    {\n//                        type = \"button\",\n//                        sub_type = \"url\",\n//                        index = i.ToString(), // WhatsApp requires index as a string\n//                        parameters = new[]\n//                        {\n//                            new\n//                            {\n//                                type = \"text\",\n//                                text = dto.ButtonParams[i]\n//                            }\n//                        }\n//                    });\n//                }\n//            }\n\n//            // ‚úÖ FINAL WHATSAPP TEMPLATE PAYLOAD\n//            var payload = new\n//            {\n//                messaging_product = \"whatsapp\",\n//                to = dto.RecipientNumber,\n//                type = \"template\",\n//                template = new\n//                {\n//                    name = dto.TemplateName,\n//                    language = new { code = \"en_US\" },\n//                    components = components\n//                }\n//            };\n\n//            // ü™µ Debug log for developer console (optional)\n//            Console.WriteLine(\"üì¶ Built WhatsApp Template Payload:\");\n//            Console.WriteLine(System.Text.Json.JsonSerializer.Serialize(payload, new System.Text.Json.JsonSerializerOptions\n//            {\n//                WriteIndented = true\n//            }));\n\n//            return payload;\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/TemplateStaticButtonPayloadBuilder.cs",
      "sha256": "68979e5fa2d53ce3fa319c20377ca2022bf9e46b7244c817fb53f84594392f72",
      "language": "csharp",
      "size": 1397,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class TemplateStaticButtonPayloadBuilder\n    {\n        public static object Build(SendTemplateMessageSimpleDto dto)\n        {\n            var components = new List<object>();\n\n            // ‚úÖ Add Body Params\n            if (dto.TemplateParameters != null && dto.TemplateParameters.Any())\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = dto.TemplateParameters.Select(p => new\n                    {\n                        type = \"text\",\n                        text = p\n                    }).ToArray()\n                });\n            }\n\n            // ‚ö†Ô∏è DO NOT add button components for static buttons\n            // Meta will render them automatically if template has static buttons defined\n            // You can later add logic here for dynamic buttons if needed\n\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"template\",\n                template = new\n                {\n                    name = dto.TemplateName,\n                    language = new { code = \"en_US\" },\n                    components = components\n                }\n            };\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/TextMessagePayloadBuilder.cs",
      "sha256": "abc17e5a60e2f58ba07c610db126262040f598a15aca27d2f85d52afc2fb4766",
      "language": "csharp",
      "size": 554,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class TextMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"text\",\n                text = new\n                {\n                    body = dto.TextContent\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Providers/MetaCloudProvider.cs",
      "sha256": "0bcab60a10252b65d74e289fbbc539e500374db9c0f3c72e405d1b60fe8b1ed0",
      "language": "csharp",
      "size": 6942,
      "content": "// üìÑ File: Features/MessagesEngine/Providers/MetaCloudProvider.cs\nusing System.Collections.Generic;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.Json.Nodes;\nusing System.Text.Json.Serialization;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore; // for AsNoTracking()\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Providers\n{\n    public class MetaCloudProvider : IWhatsAppProvider\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http;\n        private readonly ILogger<MetaCloudProvider> _logger;\n        private readonly WhatsAppSettingEntity _setting;\n\n        // Optional per-send override injected by the factory/engine (safe to leave null)\n        private readonly string? _phoneNumberIdOverride;\n\n        private static readonly JsonSerializerOptions _jsonOpts = new()\n        {\n            // camelCase ensures typed models serialize as Meta expects (e.g. `language.code`)\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,\n            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull\n        };\n\n        public MetaCloudProvider(\n            AppDbContext db,\n            HttpClient http,\n            ILogger<MetaCloudProvider> logger,\n            WhatsAppSettingEntity setting,\n            string? phoneNumberIdOverride = null)\n        {\n            _db = db;\n            _http = http;\n            _logger = logger;\n            _setting = setting;\n            _phoneNumberIdOverride = phoneNumberIdOverride;\n        }\n\n        /// <summary>\n        /// Resolve the phone_number_id to use for Meta Cloud:\n        /// 1) explicit override if provided; else\n        /// 2) default active number from WhatsAppPhoneNumbers for this business+provider.\n        /// </summary>\n        private string? ResolvePhoneNumberId()\n        {\n            if (!string.IsNullOrWhiteSpace(_phoneNumberIdOverride))\n                return _phoneNumberIdOverride;\n\n            var providerKey = (_setting.Provider ?? string.Empty).Trim().ToLowerInvariant();\n\n            var pnid = _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == _setting.BusinessId\n                            && n.IsActive\n                            && n.Provider.ToLower() == providerKey)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.PhoneNumberId)\n                .FirstOrDefault();\n\n            return pnid;\n        }\n\n        private string BuildUrl()\n        {\n            var baseUrl = string.IsNullOrWhiteSpace(_setting.ApiUrl)\n                ? \"https://graph.facebook.com/v22.0\"\n                : _setting.ApiUrl.TrimEnd('/');\n\n            var phoneNumberId = ResolvePhoneNumberId();\n            if (string.IsNullOrWhiteSpace(phoneNumberId))\n            {\n                _logger.LogError(\"MetaCloudProvider: PhoneNumberId is missing for BusinessId {BusinessId}\", _setting.BusinessId);\n                return $\"{baseUrl}/-/messages\"; // inert path; request will fail with clear logs\n            }\n\n            return $\"{baseUrl}/{phoneNumberId}/messages\";\n        }\n\n        /// <summary>\n        /// Recursively remove any `$type` discriminator properties from a JsonNode tree.\n        /// Meta rejects unknown keys like `$type` inside template.components[*].\n        /// </summary>\n        private static void StripDollarType(JsonNode? node)\n        {\n            if (node is null) return;\n\n            if (node is JsonObject obj)\n            {\n                if (obj.ContainsKey(\"$type\"))\n                    obj.Remove(\"$type\");\n\n                // safe enumeration snapshot\n                foreach (var kv in obj.ToList())\n                    StripDollarType(kv.Value);\n            }\n            else if (node is JsonArray arr)\n            {\n                foreach (var child in arr)\n                    StripDollarType(child);\n            }\n        }\n\n        private async Task<WaSendResult> PostAsync(object payload)\n        {\n            var url = BuildUrl();\n\n            // Sanitize payload to remove any $type injected by polymorphic models\n            var node = JsonSerializer.SerializeToNode(payload, _jsonOpts);\n            StripDollarType(node);\n            var json = node?.ToJsonString(_jsonOpts) ?? \"{}\";\n\n            using var req = new HttpRequestMessage(HttpMethod.Post, url)\n            {\n                Content = new StringContent(json, Encoding.UTF8, \"application/json\")\n            };\n            req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(\"application/json\"));\n\n            if (!string.IsNullOrWhiteSpace(_setting.ApiKey))\n            {\n                req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", _setting.ApiKey);\n            }\n            else\n            {\n                _logger.LogWarning(\"MetaCloudProvider: ApiToken is empty for BusinessId {BusinessId}\", _setting.BusinessId);\n            }\n\n            var res = await _http.SendAsync(req);\n            var body = await res.Content.ReadAsStringAsync();\n\n            if (!res.IsSuccessStatusCode)\n            {\n                _logger.LogWarning(\"MetaCloud send failed (HTTP {Status}): {Body}\", (int)res.StatusCode, body);\n                return new WaSendResult(false, \"MetaCloud\", null, res.StatusCode, body, res.ReasonPhrase);\n            }\n\n            string? id = null;\n            try\n            {\n                var root = JsonNode.Parse(body);\n                id = root?[\"messages\"]?[0]?[\"id\"]?.GetValue<string>();\n            }\n            catch { /* keep raw */ }\n\n            return new WaSendResult(true, \"MetaCloud\", id, res.StatusCode, body, null);\n        }\n\n        public Task<WaSendResult> SendTextAsync(string to, string body)\n            => PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"text\",\n                text = new { preview_url = false, body }\n            });\n\n        public Task<WaSendResult> SendTemplateAsync(string to, string templateName, string languageCode, IEnumerable<object> components)\n            => PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"template\",\n                template = new\n                {\n                    name = templateName,\n                    language = new { code = languageCode }, // Meta expects { \"code\": \"en_US\" }\n                    components = components ?? System.Linq.Enumerable.Empty<object>()\n                }\n            });\n\n        public Task<WaSendResult> SendInteractiveAsync(object fullPayload)\n            => PostAsync(fullPayload);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Providers/PinnacleProvider.cs",
      "sha256": "d803171cd01474f2c03261a8db09e547472a5af8272ca59d08eaffe95990051f",
      "language": "csharp",
      "size": 8325,
      "content": "// üìÑ File: Features/MessagesEngine/Providers/PinnacleProvider.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.Json.Serialization;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Providers\n{\n    public class PinnacleProvider : IWhatsAppProvider\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http;\n        private readonly ILogger<PinnacleProvider> _logger;\n        private readonly WhatsAppSettingEntity _setting;\n\n        // optional per-send override (phone_number_id or wabaId path segment)\n        private readonly string? _pathIdOverride;\n\n        private static readonly JsonSerializerOptions _jsonOpts = new()\n        {\n            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull\n        };\n\n        public PinnacleProvider(\n            AppDbContext db,\n            HttpClient http,\n            ILogger<PinnacleProvider> logger,\n            WhatsAppSettingEntity setting,\n            string? pathIdOverride = null)\n        {\n            _db = db;\n            _http = http;\n            _logger = logger;\n            _setting = setting;\n            _pathIdOverride = pathIdOverride;\n        }\n\n        /// <summary>\n        /// Resolve the path identifier used by Pinnacle: prefer explicit override,\n        /// then WabaId from settings, then PhoneNumberId from WhatsAppPhoneNumbers.\n        /// </summary>\n        private string? ResolvePathIdOrNull()\n        {\n            if (!string.IsNullOrWhiteSpace(_pathIdOverride))\n                return _pathIdOverride;\n\n            if (!string.IsNullOrWhiteSpace(_setting.WabaId))\n                return _setting.WabaId;\n\n            var providerKey = (_setting.Provider ?? string.Empty).Trim().ToLowerInvariant();\n\n            // fallback to default active sender for this provider\n            var phoneId = _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == _setting.BusinessId\n                            && n.IsActive\n                            && n.Provider.ToLower() == providerKey)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.PhoneNumberId)\n                .FirstOrDefault();\n\n            return phoneId;\n        }\n\n        private string BuildBaseUrl()\n        {\n            var baseUrl = string.IsNullOrWhiteSpace(_setting.ApiUrl)\n                ? \"https://partnersv1.pinbot.ai\"\n                : _setting.ApiUrl.TrimEnd('/');\n\n            if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            return baseUrl;\n        }\n\n        /// <summary>\n        /// Build the final send URL. If pathId is already a full URL, use as-is (for tracking cases).\n        /// Otherwise, compose the Pinnacle endpoint and ALWAYS append apikey in the query.\n        /// </summary>\n        private string BuildSendUrlWithApiKey(string pathId)\n        {\n            if (Uri.IsWellFormedUriString(pathId, UriKind.Absolute))\n                return pathId;\n\n            var baseUrl = BuildBaseUrl();\n            var apiKey = _setting.ApiKey ?? string.Empty;\n            return $\"{baseUrl}/{pathId}/messages?apikey={Uri.EscapeDataString(apiKey)}\";\n        }\n\n        private async Task<WaSendResult> PostAsync(object payload)\n        {\n            var pathId = ResolvePathIdOrNull();\n            if (string.IsNullOrWhiteSpace(pathId))\n            {\n                const string err = \"Pinnacle: Missing path id (need WabaId or PhoneNumberId/default sender).\";\n                _logger.LogError(err);\n                return new WaSendResult(false, \"Pinnacle\", null, null, null, err);\n            }\n\n            if (string.IsNullOrWhiteSpace(_setting.ApiKey))\n            {\n                const string err = \"Pinnacle: ApiKey is missing in WhatsApp settings.\";\n                _logger.LogError(err);\n                return new WaSendResult(false, \"Pinnacle\", null, null, null, err);\n            }\n\n            var url = BuildSendUrlWithApiKey(pathId);\n            var json = JsonSerializer.Serialize(payload, _jsonOpts);\n\n            using var req = new HttpRequestMessage(HttpMethod.Post, url);\n            req.Content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            // Put key in all common header places (some tenants validate one or the other)\n            req.Headers.Remove(\"apikey\");\n            req.Headers.Remove(\"x-api-key\");\n            req.Headers.TryAddWithoutValidation(\"apikey\", _setting.ApiKey);\n            req.Headers.TryAddWithoutValidation(\"x-api-key\", _setting.ApiKey);\n            req.Headers.Authorization = new AuthenticationHeaderValue(\"Apikey\", _setting.ApiKey);\n            req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(\"application/json\"));\n\n            // trace (shortened key)\n            _logger.LogInformation(\"Pinnacle POST {Url}\", url);\n\n            var res = await _http.SendAsync(req);\n            var body = await res.Content.ReadAsStringAsync();\n\n            if (!res.IsSuccessStatusCode)\n            {\n                _logger.LogWarning(\"Pinnacle send failed (HTTP {Status}): {Body}\", (int)res.StatusCode, body);\n                return new WaSendResult(false, \"Pinnacle\", null, res.StatusCode, body, res.ReasonPhrase);\n            }\n\n            string? id = TryGetPinnMessageId(body);\n            return new WaSendResult(true, \"Pinnacle\", id, res.StatusCode, body, null);\n        }\n\n        public Task<WaSendResult> SendTextAsync(string to, string body)\n            => PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"text\",\n                text = new { preview_url = false, body }\n            });\n\n        public Task<WaSendResult> SendTemplateAsync(string to, string templateName, string languageCode, IEnumerable<object> components)\n        {\n            components ??= Enumerable.Empty<object>();\n            // Pinnacle expects language as-is (not { code: \"xx_YY\" })\n            var langValue = languageCode;\n            return PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"template\",\n                template = new\n                {\n                    name = templateName,\n                    language = langValue,\n                    components\n                }\n            });\n        }\n\n        private static string? TryGetPinnMessageId(string json)\n        {\n            try\n            {\n                using var doc = JsonDocument.Parse(json);\n                var root = doc.RootElement;\n\n                if (root.TryGetProperty(\"messages\", out var msgs) &&\n                    msgs.ValueKind == JsonValueKind.Array &&\n                    msgs.GetArrayLength() > 0 &&\n                    msgs[0].TryGetProperty(\"id\", out var id0))\n                    return id0.GetString();\n\n                if (root.TryGetProperty(\"message\", out var msg) && msg.ValueKind == JsonValueKind.Object)\n                {\n                    if (msg.TryGetProperty(\"id\", out var id1)) return id1.GetString();\n                    if (msg.TryGetProperty(\"messageId\", out var id2)) return id2.GetString();\n                }\n\n                if (root.TryGetProperty(\"message_id\", out var id3)) return id3.GetString();\n                if (root.TryGetProperty(\"messageId\", out var id4)) return id4.GetString();\n                if (root.TryGetProperty(\"data\", out var data) &&\n                    data.ValueKind == JsonValueKind.Object &&\n                    data.TryGetProperty(\"messageId\", out var id5)) return id5.GetString();\n                if (root.TryGetProperty(\"id\", out var idTop)) return idTop.GetString();\n            }\n            catch { /* ignore parse errors, return null */ }\n\n            return null;\n        }\n\n        public Task<WaSendResult> SendInteractiveAsync(object fullPayload) => PostAsync(fullPayload);\n    }\n}\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/IMessageEngineService.cs",
      "sha256": "09b825ad8c2e13d48cc66e824e1d79fecd5f2752c550e0122b4eed8e4b673701",
      "language": "csharp",
      "size": 2409,
      "content": "// ‚úÖ Step 1: Final interface\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Helpers;\nusing System.Threading.Tasks;\nusing System.IO.Pipelines;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing System.Threading;\nusing xbytechat.api.Features.MessagesEngine.Enums;\n\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public interface IMessageEngineService\n    {\n\n        Task<ResponseResult> SendTemplateMessageAsync(SendMessageDto dto); //\n        Task<ResponseResult> SendTextDirectAsync(TextMessageSendDto dto);\n        Task<ResponseResult> SendImageDirectAsync(MediaMessageSendDto dto);\n        Task<ResponseResult> SendDocumentDirectAsync(MediaMessageSendDto dto);\n        Task<ResponseResult> SendVideoDirectAsync(MediaMessageSendDto dto);\n        Task<ResponseResult> SendAudioDirectAsync(MediaMessageSendDto dto);\n        Task<ResponseResult> SendLocationDirectAsync(LocationMessageSendDto dto);\n        Task<ResponseResult> SendAutomationReply(TextMessageSendDto dto);\n        Task<ResponseResult> SendTemplateMessageSimpleAsync(Guid businessId, SimpleTemplateMessageDto dto);\n        Task<ResponseResult> SendImageCampaignAsync(Guid campaignId, Guid businessId, string triggeredBy);\n        Task<ResponseResult> SendImageTemplateMessageAsync(ImageTemplateMessageDto dto, Guid businessId);\n            Task<ResponseResult> SendPayloadAsync(\n         Guid businessId,\n         string provider,          // \"PINNACLE\" or \"META_CLOUD\"\n         object payload,\n         string? phoneNumberId = null);\n        Task<ResponseResult> SendVideoTemplateMessageAsync(VideoTemplateMessageDto dto, Guid businessId);\n        Task<ResponseResult> SendDocumentTemplateMessageAsync(\n           DocumentTemplateMessageDto dto,\n           Guid businessId);\n\n        // ‚úÖ NEW: Auto-reply helper (for webhook / AutoReplyBuilder runtime)\n        Task<ResponseResult> SendAutoReplyTextAsync(\n             Guid businessId,\n             string recipientNumber,\n             string body,\n             CancellationToken ct = default);\n\n        // ‚úÖ NEW overload ‚Äì AutoReply with explicit DeliveryMode\n        Task<ResponseResult> SendAutoReplyTextAsync(\n            Guid businessId,\n            string recipientNumber,\n            string body,\n            DeliveryMode mode,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/ITemplateMessageSender.cs",
      "sha256": "7051d636ceaac1c53f50319b247f59828ed24e774132628d0e4894e65da74c87",
      "language": "csharp",
      "size": 831,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public interface ITemplateMessageSender\n    {\n        Task<ResponseResult> SendTemplateMessageToContactAsync(\n           Guid businessId,\n           Contact contact,\n           string templateName,\n           List<string> templateParams,\n           string? imageUrl = null,\n           List<CampaignButton>? buttons = null,\n           string? source = null,\n           Guid? refMessageId = null\n       );\n\n        Task<ResponseResult> SendTemplateCampaignAsync(Campaign campaign);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/MessageEngineDeliveryModeExtensions.cs",
      "sha256": "4ba3a0dffa1efa78453ac6f3aa9055a7af0fc6108feef391852a8f8e9b4b61e1",
      "language": "csharp",
      "size": 2671,
      "content": "// üìÑ xbytechat-api/Features/MessagesEngine/Services/MessageEngineDeliveryModeExtensions.cs\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Enums;\nusing xbytechat.api.Helpers; // ResponseResult\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    /// <summary>\n    /// Extension methods that add DeliveryMode-aware overloads\n    /// on top of the existing IMessageEngineService interface.\n    ///\n    /// v1 behaviour:\n    /// - These methods mostly delegate to the original overloads.\n    /// - For templates, we now copy the DeliveryMode onto the DTO.\n    /// - The core MessageEngineService can later read dto.DeliveryMode\n    ///   and decide whether to use the Outbox or send immediately.\n    /// </summary>\n    public static class MessageEngineDeliveryModeExtensions\n    {\n        /// <summary>\n        /// DeliveryMode-aware overload for sending simple template messages.\n        /// Currently sets dto.DeliveryMode = mode, then calls the existing implementation.\n        /// </summary>\n        public static Task<ResponseResult> SendTemplateMessageSimpleAsync(\n            this IMessageEngineService engine,\n            Guid businessId,\n            SimpleTemplateMessageDto dto,\n            DeliveryMode mode,\n            CancellationToken ct = default)\n        {\n            if (engine is null) throw new ArgumentNullException(nameof(engine));\n            if (dto is null) throw new ArgumentNullException(nameof(dto));\n\n            // üÜï Stamp the requested mode onto the DTO so the engine can inspect it.\n            dto.DeliveryMode = mode;\n\n            // v1: underlying implementation still behaves the same.\n            return engine.SendTemplateMessageSimpleAsync(businessId, dto);\n        }\n\n        /// <summary>\n        /// DeliveryMode-aware overload for auto-reply text messages.\n        /// For now, the mode is ignored and we delegate to the existing method.\n        /// Later we can teach the engine to branch on mode here as well.\n        /// </summary>\n        public static Task<ResponseResult> SendAutoReplyTextAsync(\n            this IMessageEngineService engine,\n            Guid businessId,\n            string recipientNumber,\n            string body,\n            DeliveryMode mode,\n            CancellationToken ct = default)\n        {\n            if (engine is null) throw new ArgumentNullException(nameof(engine));\n\n            // v1: keep existing behaviour for text; still uses the current pipeline.\n            return engine.SendAutoReplyTextAsync(businessId, recipientNumber, body, ct);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/MessageEngineService.cs",
      "sha256": "e79414ced6036a9e85cd11e95590f6181ca09f5f9a9352d0143825a8485039c4",
      "language": "csharp",
      "size": 130677,
      "content": "// üìÑ File: Features/MessagesEngine/Services/MessageEngineService.cs\nusing System;\nusing System.Collections.Concurrent;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.SignalR;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Pinnacle;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.Inbox.Hubs;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Enums;\nusing xbytechat.api.Features.MessagesEngine.Factory;\nusing xbytechat.api.Features.MessagesEngine.PayloadBuilders;\nusing xbytechat.api.Features.PlanManagement.Services;\nusing xbytechat.api.Features.ReportingModule.DTOs;\nusing xbytechat.api.Features.Webhooks.Services.Resolvers;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Infrastructure.Json;         // <- source-gen context (JsonCtx)\nusing xbytechat.api.Shared;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public class MessageEngineService : IMessageEngineService\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http; // kept for any internal calls\n        private readonly TextMessagePayloadBuilder _textBuilder;\n        private readonly ImageMessagePayloadBuilder _imageBuilder;\n        private readonly TemplateMessagePayloadBuilder _templateBuilder;\n        private readonly CtaMessagePayloadBuilder _ctaBuilder;\n        private readonly IPlanManager _planManager;\n        private readonly IHubContext<InboxHub> _hubContext;\n        private readonly IMessageIdResolver _messageIdResolver;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        private readonly IContactService _contactService;\n        private readonly IWhatsAppProviderFactory _providerFactory;\n        private readonly ILogger<MessageEngineService> _logger;\n\n        // Basic cache for WhatsApp settings to reduce DB load\n        private readonly ConcurrentDictionary<Guid, (IReadOnlyList<WhatsAppSettingEntity> setting, DateTime expiresAt)> _settingsCache = new();\n\n        public MessageEngineService(\n            AppDbContext db,\n            HttpClient http,\n            TextMessagePayloadBuilder textBuilder,\n            ImageMessagePayloadBuilder imageBuilder,\n            TemplateMessagePayloadBuilder templateBuilder,\n            CtaMessagePayloadBuilder ctaBuilder,\n            IPlanManager planManager,\n            IHubContext<InboxHub> hubContext,\n            IMessageIdResolver messageIdResolver,\n            IHttpContextAccessor httpContextAccessor,\n            IContactService contactService,\n            IWhatsAppProviderFactory providerFactory,\n            ILogger<MessageEngineService> logger)\n        {\n            _db = db;\n            _http = http;\n            _textBuilder = textBuilder;\n            _imageBuilder = imageBuilder;\n            _templateBuilder = templateBuilder;\n            _ctaBuilder = ctaBuilder;\n            _planManager = planManager;\n            _hubContext = hubContext;\n            _messageIdResolver = messageIdResolver;\n            _httpContextAccessor = httpContextAccessor;\n            _contactService = contactService;\n            _providerFactory = providerFactory;\n            _logger = logger;\n        }\n\n        // ---------- small helpers ----------\n        private static string ResolveGreeting(string? profileName, string? contactName)\n        {\n            var s = (profileName ?? contactName)?.Trim();\n            return string.IsNullOrEmpty(s) ? \"there\" : s;\n        }\n\n        private static void EnsureArgsLength(List<string> args, int slot1Based)\n        {\n            while (args.Count < slot1Based) args.Add(string.Empty);\n        }\n\n        // ‚úÖ Public helper so both Flow + Campaign send paths can use it\n        //public async Task<List<string>> ApplyProfileNameAsync(\n        //    Guid businessId,\n        //    Guid contactId,\n        //    bool useProfileName,\n        //    int? profileNameSlot,\n        //    List<string> args,\n        //    CancellationToken ct = default)\n        //{\n        //    if (!useProfileName || !(profileNameSlot is int slot) || slot < 1)\n        //        return args;\n\n        //    //var contact = await _db.Contacts\n        //    //    .AsNoTracking()\n        //    //    .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId, ct);\n\n        //    var greet = ResolveGreeting(contact?.ProfileName, contact?.Name);\n        //    EnsureArgsLength(args, slot);\n        //    args[slot - 1] = greet;\n        //    return args;\n        //}\n        public async Task<List<string>> ApplyProfileNameAsync(\n    Guid businessId,\n    Guid contactId,\n    bool useProfileName,\n    int? profileNameSlot,\n    List<string> args,\n    CancellationToken ct = default)\n        {\n            // Normalize args so we never return null\n            args ??= new List<string>();\n\n            // Quick outs\n            if (!useProfileName || profileNameSlot is not int slot || slot < 1)\n                return args;\n\n            // Load the contact only when needed\n            var contact = await _db.Contacts\n                .AsNoTracking()\n                .Where(c => c.BusinessId == businessId && c.Id == contactId)\n                .Select(c => new { c.Name, c.ProfileName })\n                .FirstOrDefaultAsync(ct);\n\n            // If no contact, just return args unchanged\n            if (contact is null)\n                return args;\n\n            // Build the greeting / display name (adjust ResolveGreeting to your needs)\n            var greet = ResolveGreeting(contact.ProfileName, contact.Name);\n            if (string.IsNullOrWhiteSpace(greet))\n                return args; // nothing to apply\n\n            // Ensure args has capacity for the requested slot (1-based)\n            if (args.Count < slot)\n                args.AddRange(Enumerable.Repeat(string.Empty, slot - args.Count));\n\n            // Set the value at the requested slot\n            args[slot - 1] = greet;\n\n            return args;\n        }\n\n        // ============================================================\n        //  SOURCE-GEN PATH FOR TYPED PAYLOADS (Step 9 ‚Äì point #5)\n        // ============================================================\n        public async Task<ResponseResult> SendPayloadAsync(Guid businessId, string provider, object payload, string? phoneNumberId = null)\n        {\n            if (string.IsNullOrWhiteSpace(provider) || (provider != \"PINNACLE\" && provider != \"META_CLOUD\"))\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\", \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n            var payloadRecipient = TryExtractRecipientFromPayload(payload);\n            if (string.IsNullOrWhiteSpace(payloadRecipient))\n            {\n                _logger.LogWarning(\n                    \"Outbound consent guard could not be applied because payload recipient is missing. businessId={BusinessId}\",\n                    businessId);\n            }\n            else\n            {\n                // Compliance guard must run before any outbound provider send call.\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, payloadRecipient);\n                if (consentBlock != null) return consentBlock;\n            }\n\n            // If already-typed, keep your current JsonElement path:\n            if (payload is MetaTemplateMessage m)\n            {\n                var json = JsonSerializer.Serialize(m, JsonCtx.Default.MetaTemplateMessage);\n                using var doc = JsonDocument.Parse(json);\n                return await SendViaProviderAsync(businessId, provider, p => p.SendInteractiveAsync(doc.RootElement.Clone()), phoneNumberId);\n            }\n            if (payload is PinnacleTemplateMessage pmsg)\n            {\n                var json = JsonSerializer.Serialize(pmsg, JsonCtx.Default.PinnacleTemplateMessage);\n                using var doc = JsonDocument.Parse(json);\n                return await SendViaProviderAsync(businessId, provider, p => p.SendInteractiveAsync(doc.RootElement.Clone()), phoneNumberId);\n            }\n\n            // NEW: if the anonymous payload looks like a WhatsApp \"template\" message,\n            // extract the parts and call SendTemplateAsync directly (no raw object pass-through).\n            if (payload is JsonElement je && je.ValueKind == JsonValueKind.Object &&\n                je.TryGetProperty(\"type\", out var t) && t.GetString() == \"template\" &&\n                je.TryGetProperty(\"to\", out var toProp) &&\n                je.TryGetProperty(\"template\", out var tmpl) &&\n                tmpl.TryGetProperty(\"name\", out var nameProp) &&\n                tmpl.TryGetProperty(\"language\", out var langProp) &&\n                langProp.TryGetProperty(\"code\", out var codeProp) &&\n                tmpl.TryGetProperty(\"components\", out var comps))\n            {\n                var to = toProp.GetString()!;\n                var name = nameProp.GetString()!;\n                var code = codeProp.GetString()!;\n                // Materialize components as plain anonymous objects to guarantee no $type:\n                var components = new List<object>();\n                foreach (var c in comps.EnumerateArray())\n                {\n                    var type = c.GetProperty(\"type\").GetString();\n                    if (type == \"body\")\n                    {\n                        var pars = c.TryGetProperty(\"parameters\", out var pr)\n                            ? pr.EnumerateArray().Select(p => new { type = p.GetProperty(\"type\").GetString(), text = p.GetProperty(\"text\").GetString() }).ToArray()\n                            : System.Array.Empty<object>();\n                        components.Add(new { type = \"body\", parameters = pars });\n                    }\n                    else if (type == \"header\")\n                    {\n                        // support header image\n                        if (c.TryGetProperty(\"parameters\", out var pr) && pr.GetArrayLength() > 0)\n                        {\n                            var p0 = pr[0];\n                            if (p0.TryGetProperty(\"type\", out var pt) && pt.GetString() == \"image\")\n                            {\n                                var link = p0.GetProperty(\"image\").GetProperty(\"link\").GetString();\n                                components.Add(new { type = \"header\", parameters = new object[] { new { type = \"image\", image = new { link } } } });\n                            }\n                            else\n                            {\n                                components.Add(new { type = \"header\", parameters = new object[] { } });\n                            }\n                        }\n                        else components.Add(new { type = \"header\", parameters = new object[] { } });\n                    }\n                    else if (type == \"button\")\n                    {\n                        var subType = c.GetProperty(\"sub_type\").GetString();\n                        var index = c.GetProperty(\"index\").GetString();\n                        if (subType == \"url\" && c.TryGetProperty(\"parameters\", out var pr) && pr.GetArrayLength() > 0)\n                        {\n                            var urlParam = pr[0].GetProperty(\"text\").GetString();\n                            components.Add(new { type = \"button\", sub_type = \"url\", index, parameters = new object[] { new { type = \"text\", text = urlParam } } });\n                        }\n                    }\n                }\n\n                return await SendViaProviderAsync(businessId, provider,\n                    p => p.SendTemplateAsync(to, name, code, components),\n                    phoneNumberId);\n            }\n\n            // Fallback: send as-is via interactive\n            return await SendViaProviderAsync(businessId, provider, p => p.SendInteractiveAsync(payload), phoneNumberId);\n        }\n\n\n\n\n\n        private static string NormalizeProviderOrThrow(string? p)\n        {\n            if (string.IsNullOrWhiteSpace(p))\n                throw new ArgumentException(\"Provider is required.\");\n\n            var u = p.Trim().ToUpperInvariant();\n            return u switch\n            {\n                \"META\" => \"META_CLOUD\", // internal convenience; callers should still pass exact values\n                \"META_CLOUD\" => \"META_CLOUD\",\n                \"PINNACLE\" => \"PINNACLE\",\n                _ => throw new ArgumentException($\"Invalid provider: {p}\")\n            };\n        }\n\n        private async Task<ResponseResult> SendViaProviderAsync(\n            Guid businessId,\n            string provider,                                // explicit\n            Func<IWhatsAppProvider, Task<WaSendResult>> action,\n            string? phoneNumberId = null)\n        {\n            try\n            {\n                // normalize internally (tolerate \"META\" here) but keep external API strict\n                var normalizedProvider = NormalizeProviderOrThrow(provider);\n\n                // For both META_CLOUD and PINNACLE we require a sender id here\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Campaign has no sender number.\",\n                        \"Missing PhoneNumberId\");\n\n                // Build provider bound to business + sender\n                var wa = await _providerFactory.CreateAsync(\n                    businessId,\n                    normalizedProvider,\n                    phoneNumberId);\n\n                // post request to http URL\n                var response = await action(wa);\n\n                if (!response.Success)\n                    return ResponseResult.ErrorInfo(\"‚ùå WhatsApp API returned an error.\", response.Error, response.RawResponse);\n\n                var rr = ResponseResult.SuccessInfo(\"‚úÖ Message sent successfully\", data: null, raw: response.RawResponse);\n                rr.MessageId = string.IsNullOrWhiteSpace(response.ProviderMessageId)\n                    ? TryExtractMetaWamid(response.RawResponse)\n                    : response.ProviderMessageId;\n                return rr;\n            }\n            catch (ArgumentException ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\", ex.Message);\n            }\n            catch (InvalidOperationException ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Provider configuration error.\", ex.Message);\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Provider call failed.\", ex.Message);\n            }\n        }\n\n        private static string? TryExtractMetaWamid(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n            var s = raw.TrimStart();\n            if (!s.StartsWith(\"{\")) return null;\n            try\n            {\n                using var doc = JsonDocument.Parse(s);\n                if (doc.RootElement.TryGetProperty(\"messages\", out var msgs) &&\n                    msgs.ValueKind == JsonValueKind.Array &&\n                    msgs.GetArrayLength() > 0 &&\n                    msgs[0].TryGetProperty(\"id\", out var idProp))\n                {\n                    return idProp.GetString();\n                }\n            }\n            catch { }\n            return null;\n        }\n\n        private static string NormalizeRecipientDigits(string? recipientNumber)\n        {\n            var raw = (recipientNumber ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(raw))\n                return string.Empty;\n\n            var normalized = PhoneNumberNormalizer.NormalizeToE164Digits(raw, \"IN\");\n            if (!string.IsNullOrWhiteSpace(normalized))\n                return normalized;\n\n            // Defensive fallback for legacy/loosely-formatted numbers.\n            var digits = new string(raw.Where(char.IsDigit).ToArray());\n            return digits.Length is >= 7 and <= 15 ? digits : string.Empty;\n        }\n\n        private static List<string> BuildRecipientLookupCandidates(string? recipientNumber)\n        {\n            var candidates = new HashSet<string>(StringComparer.Ordinal);\n            var raw = (recipientNumber ?? string.Empty).Trim();\n            var normalized = NormalizeRecipientDigits(raw);\n            var digitsOnly = new string(raw.Where(char.IsDigit).ToArray());\n\n            if (!string.IsNullOrWhiteSpace(normalized))\n            {\n                candidates.Add(normalized);\n                candidates.Add(\"+\" + normalized);\n\n                // Legacy IN contacts may still exist as local 10-digit numbers.\n                if (normalized.Length == 12 && normalized.StartsWith(\"91\", StringComparison.Ordinal))\n                    candidates.Add(normalized.Substring(2));\n            }\n\n            if (!string.IsNullOrWhiteSpace(digitsOnly))\n            {\n                candidates.Add(digitsOnly);\n                candidates.Add(\"+\" + digitsOnly);\n\n                if (digitsOnly.Length == 10)\n                {\n                    candidates.Add(\"91\" + digitsOnly);\n                    candidates.Add(\"+91\" + digitsOnly);\n                }\n                else if (digitsOnly.Length == 12 && digitsOnly.StartsWith(\"91\", StringComparison.Ordinal))\n                {\n                    candidates.Add(digitsOnly.Substring(2));\n                }\n            }\n\n            if (!string.IsNullOrWhiteSpace(raw))\n                candidates.Add(raw);\n\n            return candidates.Where(c => !string.IsNullOrWhiteSpace(c)).ToList();\n        }\n\n        private static bool TryReadRecipientFromPayload(JsonElement root, out string? recipient)\n        {\n            recipient = null;\n            if (root.ValueKind != JsonValueKind.Object) return false;\n\n            if (root.TryGetProperty(\"to\", out var toProp) && toProp.ValueKind == JsonValueKind.String)\n            {\n                recipient = toProp.GetString();\n                return !string.IsNullOrWhiteSpace(recipient);\n            }\n\n            if (root.TryGetProperty(\"To\", out var toPascalProp) && toPascalProp.ValueKind == JsonValueKind.String)\n            {\n                recipient = toPascalProp.GetString();\n                return !string.IsNullOrWhiteSpace(recipient);\n            }\n\n            return false;\n        }\n\n        private static string? TryExtractRecipientFromPayload(object payload)\n        {\n            if (payload is JsonElement jsonElement)\n                return TryReadRecipientFromPayload(jsonElement, out var fromJsonElement) ? fromJsonElement : null;\n\n            try\n            {\n                using var payloadDoc = JsonDocument.Parse(JsonSerializer.Serialize(payload));\n                return TryReadRecipientFromPayload(payloadDoc.RootElement, out var fromPayloadObject) ? fromPayloadObject : null;\n            }\n            catch\n            {\n                return null;\n            }\n        }\n\n        private async Task<ResponseResult?> EnforceOutboundConsentGuardAsync(Guid businessId, string? recipientNumber, CancellationToken ct = default)\n        {\n            var lookupCandidates = BuildRecipientLookupCandidates(recipientNumber);\n            var normalizedPhone = NormalizeRecipientDigits(recipientNumber);\n            if (lookupCandidates.Count == 0)\n                return null;\n\n            var contact = await _db.Contacts\n                .Where(c => c.BusinessId == businessId && lookupCandidates.Contains(c.PhoneNumber))\n                .OrderByDescending(c => c.OptStatus == ContactOptStatus.OptedOut)\n                .ThenByDescending(c => c.OptStatusUpdatedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (contact == null)\n            {\n                _logger.LogWarning(\n                    \"Outbound consent guard could not be applied because contact was not found. businessId={BusinessId} phone={Phone}\",\n                    businessId,\n                    normalizedPhone);\n                return null;\n            }\n\n            if (contact.OptStatus == ContactOptStatus.OptedOut)\n            {\n                _logger.LogInformation(\n                    \"Outbound blocked by consent guard. businessId={BusinessId} phone={Phone} optStatus={OptStatus} channelStatus={ChannelStatus}\",\n                    businessId,\n                    normalizedPhone,\n                    contact.OptStatus,\n                    contact.ChannelStatus);\n                return ResponseResult.ErrorInfo(\"CONTACT_OPTED_OUT\");\n            }\n\n            if (contact.ChannelStatus != ContactChannelStatus.Valid)\n            {\n                _logger.LogInformation(\n                    \"Outbound blocked by channel guard. businessId={BusinessId} phone={Phone} optStatus={OptStatus} channelStatus={ChannelStatus}\",\n                    businessId,\n                    normalizedPhone,\n                    contact.OptStatus,\n                    contact.ChannelStatus);\n                return ResponseResult.ErrorInfo(\"CONTACT_CHANNEL_BLOCKED_OR_INVALID\");\n            }\n\n            return null;\n        }\n\n        // ---------- CSV-materialized variable helpers (for campaign recipients) ----------\n        private static string[] ReadBodyParams(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return Array.Empty<string>();\n            try { return JsonSerializer.Deserialize<string[]>(json) ?? Array.Empty<string>(); }\n            catch { return Array.Empty<string>(); }\n        }\n\n        private static Dictionary<string, string> ReadVarDict(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json))\n                return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            try\n            {\n                return JsonSerializer.Deserialize<Dictionary<string, string>>(json)\n                       ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n            catch\n            {\n                return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n        }\n\n        private static List<string> BuildHeaderTextParams(IDictionary<string, string> kv)\n        {\n            var matches = kv.Keys\n                .Select(k => new\n                {\n                    k,\n                    m = System.Text.RegularExpressions.Regex.Match(\n                        k, @\"^(?:header(?:\\.text)?\\.)?(\\d+)$|^header(?:\\.text)?\\.(\\d+)$|^headerpara(\\d+)$\",\n                        System.Text.RegularExpressions.RegexOptions.IgnoreCase)\n                })\n                .Where(x => x.m.Success)\n                .Select(x =>\n                {\n                    for (int g = 1; g < x.m.Groups.Count; g++)\n                        if (x.m.Groups[g].Success) return int.Parse(x.m.Groups[g].Value);\n                    return 0;\n                })\n                .Where(n => n > 0)\n                .Distinct()\n                .OrderBy(n => n)\n                .ToList();\n\n            if (matches.Count == 0) return new List<string>();\n\n            var list = new List<string>(new string[matches.Last()]);\n            for (int i = 1; i <= list.Count; i++)\n            {\n                var k1 = $\"header.text.{i}\";\n                var k2 = $\"headerpara{i}\";\n                if (!kv.TryGetValue(k1, out var v))\n                    kv.TryGetValue(k2, out v);\n                list[i - 1] = v ?? string.Empty;\n            }\n\n            return list;\n        }\n\n        private static IReadOnlyDictionary<string, string> BuildButtonUrlParams(IDictionary<string, string> kv)\n        {\n            var map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            for (int pos = 1; pos <= 3; pos++)\n            {\n                var k1 = $\"button{pos}.url_param\";\n                var k2 = $\"buttonpara{pos}\";\n                if (kv.TryGetValue(k1, out var v1) && !string.IsNullOrWhiteSpace(v1))\n                    map[k1] = v1;\n                else if (kv.TryGetValue(k2, out var v2) && !string.IsNullOrWhiteSpace(v2))\n                    map[k1] = v2;\n            }\n            return map;\n        }\n\n        // ======================================================================\n        //  SEND METHODS (kept from your file; minor tidy + consistent responses)\n        // ======================================================================\n\n        public async Task<ResponseResult> SendTemplateMessageAsync(SendMessageDto dto)\n        {\n            try\n            {\n                Console.WriteLine($\"üì® Sending template message to {dto.RecipientNumber} via BusinessId {dto.BusinessId}\");\n\n                if (dto.MessageType != MessageTypeEnum.Template)\n                    return ResponseResult.ErrorInfo(\"Only template messages are supported in this method.\");\n\n                // strict provider check at API surface\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(dto.BusinessId, dto.RecipientNumber);\n                if (consentBlock != null) return consentBlock;\n\n                // Quota\n                var quotaCheck = await _planManager.CheckQuotaBeforeSendingAsync(dto.BusinessId);\n                if (!quotaCheck.Success) return quotaCheck;\n\n                // Build components (body only here)\n                var bodyParams = (dto.TemplateParameters?.Values?.ToList() ?? new List<string>())\n                    .Select(p => new { type = \"text\", text = p })\n                    .ToArray();\n\n                var components = new List<object>();\n                if (bodyParams.Length > 0)\n                    components.Add(new { type = \"body\", parameters = bodyParams });\n\n                // Send via provider\n                var sendResult = await SendViaProviderAsync(\n                    dto.BusinessId,\n                    dto.Provider,\n                    p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName!, \"en_US\", components),\n                    dto.PhoneNumberId\n                );\n\n                // Rendered body (for logs)\n                var resolvedBody = TemplateParameterHelper.FillPlaceholders(\n                    dto.TemplateBody ?? \"\",\n                    dto.TemplateParameters?.Values.ToList() ?? new List<string>());\n\n                // Log result\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName ?? \"N/A\",\n                    RenderedBody = resolvedBody,\n                    MediaUrl = null,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                var planInfo = await _db.BusinessPlanInfos.FirstOrDefaultAsync(p => p.BusinessId == dto.BusinessId);\n                if (planInfo != null && planInfo.RemainingMessages > 0)\n                {\n                    planInfo.RemainingMessages -= 1;\n                    planInfo.UpdatedAt = DateTime.UtcNow;\n                }\n                await _db.SaveChangesAsync();\n\n                // SignalR push\n                await _hubContext.Clients\n                    .Group($\"business_{dto.BusinessId}\")\n                    .SendAsync(\"ReceiveMessage\", new\n                    {\n                        Id = log.Id,\n                        RecipientNumber = log.RecipientNumber,\n                        MessageContent = log.RenderedBody,\n                        MediaUrl = log.MediaUrl,\n                        Status = log.Status,\n                        CreatedAt = log.CreatedAt,\n                        SentAt = log.SentAt\n                    });\n\n                return ResponseResult.SuccessInfo(\"‚úÖ Template message sent successfully.\", sendResult, log.RawResponse);\n            }\n            catch (Exception ex)\n            {\n                var errorId = Guid.NewGuid();\n                Console.WriteLine($\"üß® Error ID: {errorId}\\n{ex}\");\n\n                await _db.MessageLogs.AddAsync(new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName ?? \"N/A\",\n                    RenderedBody = TemplateParameterHelper.FillPlaceholders(\n                        dto.TemplateBody ?? \"\",\n                        dto.TemplateParameters?.Values.ToList() ?? new List<string>()),\n                    Status = \"Failed\",\n                    ErrorMessage = ex.Message,\n                    RawResponse = ex.ToString(),\n                    CreatedAt = DateTime.UtcNow\n                });\n\n                await _db.SaveChangesAsync();\n\n                return ResponseResult.ErrorInfo(\n                    $\"‚ùå Exception occurred while sending template message. [Ref: {errorId}]\",\n                    ex.ToString());\n            }\n        }\n        [Obsolete(\"Use outbox + SendPayloadAsync via worker.\")]\n        public async Task<ResponseResult> SendVideoTemplateMessageAsync(VideoTemplateMessageDto dto, Guid businessId)\n        {\n            try\n            {\n                var provider = (dto.Provider ?? \"META_CLOUD\").Trim().ToUpperInvariant();\n                if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\", \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n                if (string.IsNullOrWhiteSpace(dto.RecipientNumber))\n                    return ResponseResult.ErrorInfo(\"‚ùå Missing recipient number.\");\n                if (string.IsNullOrWhiteSpace(dto.TemplateName))\n                    return ResponseResult.ErrorInfo(\"‚ùå Missing template name.\");\n                if (string.IsNullOrWhiteSpace(dto.HeaderVideoUrl))\n                    return ResponseResult.ErrorInfo(\"üö´ Missing HeaderVideoUrl (must be a direct HTTPS link to a video file).\");\n\n                var langCode = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!.Trim();\n\n                // components: header video + body + optional buttons\n                var components = new List<object>\n                {\n                    new\n                    {\n                        type = \"header\",\n                        parameters = new object[]\n                        {\n                            new { type = \"video\", video = new { link = dto.HeaderVideoUrl! } }\n                        }\n                    }\n                };\n\n                var bodyParams = (dto.TemplateParameters ?? new List<string>())\n                    .Select(p => new { type = \"text\", text = p })\n                    .ToArray();\n\n                components.Add(new { type = \"body\", parameters = bodyParams });\n\n                var btns = (dto.ButtonParameters ?? new List<CampaignButtonDto>()).Take(3).ToList();\n                for (int i = 0; i < btns.Count; i++)\n                {\n                    var b = btns[i];\n                    var sub = (b.ButtonType ?? \"\").Trim().ToLowerInvariant();\n                    if (string.IsNullOrEmpty(sub)) continue;\n\n                    var button = new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = sub,\n                        [\"index\"] = i.ToString()\n                    };\n\n                    if (sub == \"url\" && !string.IsNullOrWhiteSpace(b.TargetUrl))\n                        button[\"parameters\"] = new object[] { new { type = \"text\", text = b.TargetUrl! } };\n                    else if (sub == \"quick_reply\" && !string.IsNullOrWhiteSpace(b.TargetUrl))\n                        button[\"parameters\"] = new object[] { new { type = \"payload\", payload = b.TargetUrl! } };\n\n                    components.Add(button);\n                }\n\n                // full payload object for WhatsApp template\n                var payload = new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = dto.RecipientNumber!,\n                    type = \"template\",\n                    template = new\n                    {\n                        name = dto.TemplateName!,\n                        language = new { code = langCode },\n                        components = components\n                    }\n                };\n\n                var sendResult = await SendPayloadAsync(businessId, provider, payload, dto.PhoneNumberId);\n\n                var renderedBody = TemplateParameterHelper.FillPlaceholders(\n                    dto.TemplateBody ?? \"\",\n                    dto.TemplateParameters ?? new List<string>());\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber!,\n                    MessageContent = dto.TemplateName!,\n                    MediaUrl = dto.HeaderVideoUrl,\n                    RenderedBody = renderedBody,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.ErrorMessage ?? (sendResult.Success ? null : \"WhatsApp API returned an error.\"),\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    SentAt = DateTime.UtcNow,\n                    CreatedAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success ? \"‚úÖ Template sent successfully.\" : (sendResult.ErrorMessage ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new { Success = sendResult.Success, MessageId = sendResult.MessageId, LogId = log.Id },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                try\n                {\n                    await _db.MessageLogs.AddAsync(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        RecipientNumber = dto.RecipientNumber ?? \"\",\n                        MessageContent = dto.TemplateName ?? \"\",\n                        RenderedBody = TemplateParameterHelper.FillPlaceholders(dto.TemplateBody ?? \"\", dto.TemplateParameters ?? new List<string>()),\n                        MediaUrl = dto.HeaderVideoUrl,\n                        Status = \"Failed\",\n                        ErrorMessage = ex.Message,\n                        CreatedAt = DateTime.UtcNow,\n                        CTAFlowConfigId = dto.CTAFlowConfigId,\n                        CTAFlowStepId = dto.CTAFlowStepId\n                    });\n                    await _db.SaveChangesAsync();\n                }\n                catch { /* ignore */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Template send failed\", ex.Message);\n            }\n        }\n\n        public async Task<ResponseResult> SendTextDirectAsync(TextMessageSendDto dto)\n        {\n            try\n            {\n                var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                    ?? throw new UnauthorizedAccessException(\"‚ùå Cannot resolve BusinessId from context.\");\n\n                // Normalize inbound intent\n                string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n                    ? null\n                    : dto.Provider!.Trim().ToUpperInvariant();\n                string? providerKey = providerUpper?.ToLowerInvariant();\n                string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? null : dto.PhoneNumberId!.Trim();\n\n                // Derive provider/sender from default phone row if needed\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var defaultPhone = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId && n.IsActive)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => new { n.Provider, n.PhoneNumberId })\n                        .FirstOrDefaultAsync();\n\n                    if (defaultPhone == null)\n                    {\n                        var anySetting = await _db.WhatsAppSettings\n                            .AsNoTracking()\n                            .Where(s => s.BusinessId == businessId && s.IsActive)\n                            .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                            .Select(s => s.Provider)\n                            .FirstOrDefaultAsync();\n\n                        if (string.IsNullOrWhiteSpace(anySetting))\n                            return ResponseResult.ErrorInfo(\"‚ùå WhatsApp configuration not found (no active numbers or settings).\");\n\n                        providerUpper = anySetting.Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                    }\n                    else\n                    {\n                        providerUpper = (defaultPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                        if (string.IsNullOrWhiteSpace(phoneNumberId))\n                            phoneNumberId = defaultPhone.PhoneNumberId;\n                    }\n                }\n\n                if (providerUpper != \"PINNACLE\" && providerUpper != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider. Must be 'PINNACLE' or 'META_CLOUD'.\");\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    var phoneRow = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId\n                                    && n.IsActive\n                                    && n.Provider.ToLower() == providerKey)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => n.PhoneNumberId)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(phoneRow))\n                        phoneNumberId = phoneRow;\n                }\n\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"‚ùå Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n                var chosenSetting = await _db.WhatsAppSettings\n                    .AsNoTracking()\n                    .Where(s => s.BusinessId == businessId\n                                && s.IsActive\n                                && s.Provider.ToLower() == providerKey)\n                    .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                    .FirstOrDefaultAsync();\n\n                if (chosenSetting == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå WhatsApp settings row not found for the selected provider.\");\n\n                // Contact upsert/touch\n                Guid? contactId = null;\n\n                var recipientRaw = (dto.RecipientNumber ?? string.Empty).Trim();\n                var recipientDigits = PhoneNumberNormalizer.NormalizeToE164Digits(recipientRaw, \"IN\");\n                if (string.IsNullOrWhiteSpace(recipientDigits))\n                    return ResponseResult.ErrorInfo(\"? Invalid recipient number.\", $\"Invalid/unsupported phone: '{recipientRaw}'\");\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, recipientDigits);\n                if (consentBlock != null) return consentBlock;\n\n                // Canonical lookup: digits-only E.164 (no '+')\n                var contact = await _db.Contacts.FirstOrDefaultAsync(c =>\n                    c.BusinessId == businessId &&\n                    c.PhoneNumber == recipientDigits);\n\n                if (contact != null)\n                {\n                    contactId = contact.Id;\n                    contact.LastContactedAt = DateTime.UtcNow;\n\n                    // If caller wants to save and provided a better name, backfill placeholders only.\n                    if (dto.IsSaveContact && !string.IsNullOrWhiteSpace(dto.ContactName))\n                    {\n                        var preferredName = dto.ContactName.Trim();\n                        if (!string.IsNullOrWhiteSpace(preferredName) &&\n                            (string.IsNullOrWhiteSpace(contact.Name) ||\n                             contact.Name == \"WhatsApp User\" ||\n                             contact.Name == contact.PhoneNumber))\n                        {\n                            contact.Name = preferredName;\n                        }\n                    }\n                }\n                else if (dto.IsSaveContact)\n                {\n                    var preferredName = string.IsNullOrWhiteSpace(dto.ContactName)\n                        ? null\n                        : dto.ContactName.Trim();\n\n                    contact = new Contact\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Name = preferredName ?? \"WhatsApp User\",\n                        PhoneNumber = recipientDigits,\n                        CreatedAt = DateTime.UtcNow,\n                        LastContactedAt = DateTime.UtcNow\n                    };\n                    _db.Contacts.Add(contact);\n                    contactId = contact.Id;\n                }\n\n                await _db.SaveChangesAsync();\n\n                // Send\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    providerUpper!,\n                    p => p.SendTextAsync(recipientDigits, dto.TextContent),\n                    phoneNumberId\n                );\n\n                // Extract provider message id if missing\n                string? messageId = sendResult.MessageId;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(sendResult.RawResponse))\n                {\n                    try\n                    {\n                        var raw = sendResult.RawResponse!.TrimStart();\n                        if (raw.StartsWith(\"{\"))\n                        {\n                            using var parsed = JsonDocument.Parse(raw);\n                            if (parsed.RootElement.TryGetProperty(\"messages\", out var msgs)\n                                && msgs.ValueKind == JsonValueKind.Array\n                                && msgs.GetArrayLength() > 0\n                                && msgs[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* ignore parse issues */ }\n                }\n\n                // Log\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = recipientDigits,\n                    MessageContent = dto.TextContent,\n                    RenderedBody = dto.TextContent,\n                    ContactId = contactId,\n                    MediaUrl = null,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId,\n                    ProviderMessageId = messageId\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                // Optional campaign mapping\n                Guid? campaignSendLogId = null;\n                if (dto.Source == \"campaign\" && !string.IsNullOrEmpty(messageId))\n                {\n                    try { campaignSendLogId = await _messageIdResolver.ResolveCampaignSendLogIdAsync(messageId); }\n                    catch { /* non-fatal */ }\n                }\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Text message sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id,\n                        CampaignSendLogId = campaignSendLogId\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                try\n                {\n                    var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId();\n                    if (businessId != null)\n                    {\n                        await _db.MessageLogs.AddAsync(new MessageLog\n                        {\n                            Id = Guid.NewGuid(),\n                            BusinessId = businessId.Value,\n                            RecipientNumber = dto.RecipientNumber,\n                            MessageContent = dto.TextContent,\n                            Status = \"Failed\",\n                            ErrorMessage = ex.Message,\n                            CreatedAt = DateTime.UtcNow\n                        });\n                        await _db.SaveChangesAsync();\n                    }\n                }\n                catch { /* ignore */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to send text message.\", ex.ToString());\n            }\n        }\n\n        public Task<ResponseResult> SendImageDirectAsync(MediaMessageSendDto dto)\n            => SendMediaDirectAsync(dto, mediaType: \"image\");\n\n        public Task<ResponseResult> SendDocumentDirectAsync(MediaMessageSendDto dto)\n            => SendMediaDirectAsync(dto, mediaType: \"document\");\n\n        public Task<ResponseResult> SendVideoDirectAsync(MediaMessageSendDto dto)\n            => SendMediaDirectAsync(dto, mediaType: \"video\");\n\n        public Task<ResponseResult> SendAudioDirectAsync(MediaMessageSendDto dto)\n            => SendMediaDirectAsync(dto, mediaType: \"audio\");\n\n        private async Task<ResponseResult> SendMediaDirectAsync(MediaMessageSendDto dto, string mediaType)\n        {\n            try\n            {\n                var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                    ?? throw new UnauthorizedAccessException(\"? Cannot resolve BusinessId from context.\");\n\n                if (dto == null) throw new ArgumentNullException(nameof(dto));\n\n                var type = (mediaType ?? string.Empty).Trim().ToLowerInvariant();\n                if (type is not (\"image\" or \"document\" or \"video\" or \"audio\"))\n                    return ResponseResult.ErrorInfo(\"? Invalid media type.\", \"Media type must be 'image', 'document', 'video', or 'audio'.\");\n\n                var recipientRaw = (dto.RecipientNumber ?? string.Empty).Trim();\n                var recipientDigits = PhoneNumberNormalizer.NormalizeToE164Digits(recipientRaw, \"IN\");\n                if (string.IsNullOrWhiteSpace(recipientDigits))\n                    return ResponseResult.ErrorInfo(\"? Invalid recipient number.\", $\"Invalid/unsupported phone: '{recipientRaw}'\");\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, recipientDigits);\n                if (consentBlock != null) return consentBlock;\n\n                var mediaId = (dto.MediaId ?? string.Empty).Trim();\n                if (string.IsNullOrWhiteSpace(mediaId))\n                    return ResponseResult.ErrorInfo(\"? Missing media id.\", \"mediaId is required.\");\n\n                // Normalize provider + resolve phone_number_id similarly to SendTextDirectAsync\n                string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n                    ? null\n                    : dto.Provider!.Trim().ToUpperInvariant();\n                string? providerKey = providerUpper?.ToLowerInvariant();\n                string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? null : dto.PhoneNumberId!.Trim();\n\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var defaultPhone = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId && n.IsActive)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => new { n.Provider, n.PhoneNumberId })\n                        .FirstOrDefaultAsync();\n\n                    if (defaultPhone == null)\n                    {\n                        var anySetting = await _db.WhatsAppSettings\n                            .AsNoTracking()\n                            .Where(s => s.BusinessId == businessId && s.IsActive)\n                            .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                            .Select(s => s.Provider)\n                            .FirstOrDefaultAsync();\n\n                        if (string.IsNullOrWhiteSpace(anySetting))\n                            return ResponseResult.ErrorInfo(\"? WhatsApp configuration not found (no active numbers or settings).\");\n\n                        providerUpper = anySetting.Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                    }\n                    else\n                    {\n                        providerUpper = (defaultPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                        if (string.IsNullOrWhiteSpace(phoneNumberId))\n                            phoneNumberId = defaultPhone.PhoneNumberId;\n                    }\n                }\n\n                if (providerUpper != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"? Unsupported provider for Inbox media.\", \"Inbox media is supported only for META_CLOUD.\");\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    var phoneRow = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId\n                                    && n.IsActive\n                                    && n.Provider.ToLower() == providerKey)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => n.PhoneNumberId)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(phoneRow))\n                        phoneNumberId = phoneRow;\n                }\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"? Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n                Guid? contactId = dto.ContactId != Guid.Empty ? dto.ContactId : null;\n                if (!contactId.HasValue)\n                {\n                    var contact = await _db.Contacts.FirstOrDefaultAsync(c =>\n                        c.BusinessId == businessId &&\n                        c.PhoneNumber == recipientDigits);\n                    contactId = contact?.Id;\n                }\n\n                var caption = string.IsNullOrWhiteSpace(dto.Caption) ? null : dto.Caption.Trim();\n                if (type == \"audio\" && !string.IsNullOrWhiteSpace(caption))\n                    return ResponseResult.ErrorInfo(\"? Audio does not support captions.\", \"Remove Caption/Text when sending an audio message.\");\n\n                object payload = type switch\n                {\n                    \"image\" => new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = recipientDigits,\n                        type = \"image\",\n                        image = new { id = mediaId, caption }\n                    },\n                    \"document\" => new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = recipientDigits,\n                        type = \"document\",\n                        document = new { id = mediaId, caption, filename = dto.FileName }\n                    },\n                    \"video\" => new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = recipientDigits,\n                        type = \"video\",\n                        video = new { id = mediaId, caption }\n                    },\n                    \"audio\" => new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = recipientDigits,\n                        type = \"audio\",\n                        audio = new { id = mediaId }\n                    },\n                    _ => throw new InvalidOperationException(\"Unsupported media type.\")\n                };\n\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    providerUpper!,\n                    p => p.SendInteractiveAsync(payload),\n                    phoneNumberId\n                );\n\n                string? messageId = sendResult.MessageId;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(sendResult.RawResponse))\n                {\n                    try\n                    {\n                        var raw = sendResult.RawResponse!.TrimStart();\n                        if (raw.StartsWith(\"{\"))\n                        {\n                            using var parsed = JsonDocument.Parse(raw);\n                            if (parsed.RootElement.TryGetProperty(\"messages\", out var msgs)\n                                && msgs.ValueKind == JsonValueKind.Array\n                                && msgs.GetArrayLength() > 0\n                                && msgs[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* ignore parse issues */ }\n                }\n\n                var rendered =\n                    string.IsNullOrWhiteSpace(caption)\n                        ? type switch\n                        {\n                            \"image\" => string.IsNullOrWhiteSpace(dto.FileName) ? \"Image sent\" : $\"Image sent: {dto.FileName}\",\n                            \"document\" => string.IsNullOrWhiteSpace(dto.FileName) ? \"PDF sent\" : $\"PDF sent: {dto.FileName}\",\n                            \"video\" => string.IsNullOrWhiteSpace(dto.FileName) ? \"Video sent\" : $\"Video sent: {dto.FileName}\",\n                            \"audio\" => string.IsNullOrWhiteSpace(dto.FileName) ? \"Audio sent\" : $\"Audio sent: {dto.FileName}\",\n                            _ => \"Media sent\"\n                        }\n                        : caption!;\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = recipientDigits,\n                    MessageContent = rendered,\n                    RenderedBody = rendered,\n                    ContactId = contactId,\n                    MediaUrl = null,\n                    MediaId = mediaId,\n                    MediaType = type,\n                    FileName = dto.FileName,\n                    MimeType = dto.MimeType,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId,\n                    ProviderMessageId = messageId,\n                    Source = dto.Source\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"? Media message sent successfully.\"\n                        : (sendResult.Message ?? \"? WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"? Failed to send media message.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendLocationDirectAsync(LocationMessageSendDto dto)\n        {\n            try\n            {\n                var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                    ?? throw new UnauthorizedAccessException(\"? Cannot resolve BusinessId from context.\");\n\n                if (dto == null) throw new ArgumentNullException(nameof(dto));\n\n                if (dto.Latitude < -90 || dto.Latitude > 90)\n                    return ResponseResult.ErrorInfo(\"? Invalid latitude.\", \"Latitude must be between -90 and 90.\");\n                if (dto.Longitude < -180 || dto.Longitude > 180)\n                    return ResponseResult.ErrorInfo(\"? Invalid longitude.\", \"Longitude must be between -180 and 180.\");\n\n                var recipientRaw = (dto.RecipientNumber ?? string.Empty).Trim();\n                var recipientDigits = PhoneNumberNormalizer.NormalizeToE164Digits(recipientRaw, \"IN\");\n                if (string.IsNullOrWhiteSpace(recipientDigits))\n                    return ResponseResult.ErrorInfo(\"? Invalid recipient number.\", $\"Invalid/unsupported phone: '{recipientRaw}'\");\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, recipientDigits);\n                if (consentBlock != null) return consentBlock;\n\n                string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n                    ? null\n                    : dto.Provider!.Trim().ToUpperInvariant();\n                string? providerKey = providerUpper?.ToLowerInvariant();\n                string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? null : dto.PhoneNumberId!.Trim();\n\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var defaultPhone = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId && n.IsActive)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => new { n.Provider, n.PhoneNumberId })\n                        .FirstOrDefaultAsync();\n\n                    if (defaultPhone == null)\n                    {\n                        var anySetting = await _db.WhatsAppSettings\n                            .AsNoTracking()\n                            .Where(s => s.BusinessId == businessId && s.IsActive)\n                            .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                            .Select(s => s.Provider)\n                            .FirstOrDefaultAsync();\n\n                        if (string.IsNullOrWhiteSpace(anySetting))\n                            return ResponseResult.ErrorInfo(\"? WhatsApp configuration not found (no active numbers or settings).\");\n\n                        providerUpper = anySetting.Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                    }\n                    else\n                    {\n                        providerUpper = (defaultPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                        if (string.IsNullOrWhiteSpace(phoneNumberId))\n                            phoneNumberId = defaultPhone.PhoneNumberId;\n                    }\n                }\n\n                if (providerUpper != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"? Unsupported provider for Inbox location.\", \"Inbox location is supported only for META_CLOUD.\");\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    var phoneRow = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId\n                                    && n.IsActive\n                                    && n.Provider.ToLower() == providerKey)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => n.PhoneNumberId)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(phoneRow))\n                        phoneNumberId = phoneRow;\n                }\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"? Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n                object payload = new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = recipientDigits,\n                    type = \"location\",\n                    location = new\n                    {\n                        latitude = dto.Latitude,\n                        longitude = dto.Longitude,\n                        name = string.IsNullOrWhiteSpace(dto.Name) ? null : dto.Name.Trim(),\n                        address = string.IsNullOrWhiteSpace(dto.Address) ? null : dto.Address.Trim()\n                    }\n                };\n\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    providerUpper!,\n                    p => p.SendInteractiveAsync(payload),\n                    phoneNumberId\n                );\n\n                string? messageId = sendResult.MessageId;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(sendResult.RawResponse))\n                {\n                    try\n                    {\n                        var raw = sendResult.RawResponse!.TrimStart();\n                        if (raw.StartsWith(\"{\"))\n                        {\n                            using var parsed = JsonDocument.Parse(raw);\n                            if (parsed.RootElement.TryGetProperty(\"messages\", out var msgs)\n                                && msgs.ValueKind == JsonValueKind.Array\n                                && msgs.GetArrayLength() > 0\n                                && msgs[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* ignore parse issues */ }\n                }\n\n                var rendered = string.IsNullOrWhiteSpace(dto.Name)\n                    ? \"Location sent\"\n                    : dto.Name!.Trim();\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = recipientDigits,\n                    MessageContent = rendered,\n                    RenderedBody = rendered,\n                    ContactId = dto.ContactId != Guid.Empty ? dto.ContactId : (Guid?)null,\n                    MediaUrl = null,\n                    MediaId = null,\n                    MediaType = \"location\",\n                    FileName = null,\n                    MimeType = null,\n                    LocationLatitude = dto.Latitude,\n                    LocationLongitude = dto.Longitude,\n                    LocationName = string.IsNullOrWhiteSpace(dto.Name) ? null : dto.Name.Trim(),\n                    LocationAddress = string.IsNullOrWhiteSpace(dto.Address) ? null : dto.Address.Trim(),\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId,\n                    ProviderMessageId = messageId,\n                    Source = dto.Source\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"? Location sent successfully.\"\n                        : (sendResult.Message ?? \"? WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"? Failed to send location message.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendAutomationReply(TextMessageSendDto dto)\n        {\n            try\n            {\n                var businessId =\n                    dto.BusinessId != Guid.Empty\n                        ? dto.BusinessId\n                        : _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                          ?? throw new UnauthorizedAccessException(\"‚ùå Cannot resolve BusinessId from context or DTO.\");\n\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, dto.RecipientNumber);\n                if (consentBlock != null) return consentBlock;\n\n                Guid? contactId = null;\n                try\n                {\n                    var contact = await _contactService.FindOrCreateAsync(businessId, dto.RecipientNumber);\n                    contactId = contact.Id;\n                }\n                catch (Exception ex)\n                {\n                    Console.WriteLine($\"‚ö†Ô∏è Failed to resolve or create contact: {ex.Message}\");\n                }\n\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    dto.Provider,\n                    p => p.SendTextAsync(dto.RecipientNumber, dto.TextContent),\n                    dto.PhoneNumberId\n                );\n\n                string? messageId = sendResult.MessageId;\n                var raw = sendResult.RawResponse;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(raw))\n                {\n                    try\n                    {\n                        var s = raw.TrimStart();\n                        if (s.StartsWith(\"{\"))\n                        {\n                            using var parsed = JsonDocument.Parse(s);\n                            if (parsed.RootElement.TryGetProperty(\"messages\", out var messages) &&\n                                messages.ValueKind == JsonValueKind.Array &&\n                                messages.GetArrayLength() > 0 &&\n                                messages[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* ignore */ }\n                }\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent,\n                    RenderedBody = dto.TextContent,\n                    ContactId = contactId,\n                    MediaUrl = null,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                Guid? campaignSendLogId = null;\n                if (dto.Source == \"campaign\" && !string.IsNullOrEmpty(messageId))\n                {\n                    try\n                    {\n                        campaignSendLogId = await _messageIdResolver.ResolveCampaignSendLogIdAsync(messageId);\n                        Console.WriteLine($\"üì¶ CampaignSendLog resolved: {campaignSendLogId}\");\n                    }\n                    catch (Exception ex)\n                    {\n                        Console.WriteLine($\"‚ö†Ô∏è Failed to resolve campaign log for {messageId}: {ex.Message}\");\n                    }\n                }\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Text message sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id,\n                        CampaignSendLogId = campaignSendLogId\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"‚ùå Exception in SendAutomationReply: {ex.Message}\");\n\n                try\n                {\n                    var businessId =\n                        dto.BusinessId != Guid.Empty\n                            ? dto.BusinessId\n                            : _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                              ?? throw new UnauthorizedAccessException(\"‚ùå Cannot resolve BusinessId in failure path.\");\n\n                    await _db.MessageLogs.AddAsync(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        RecipientNumber = dto.RecipientNumber,\n                        MessageContent = dto.TextContent,\n                        Status = \"Failed\",\n                        ErrorMessage = ex.Message,\n                        CreatedAt = DateTime.UtcNow\n                    });\n\n                    await _db.SaveChangesAsync();\n                }\n                catch { /* ignore log errors */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to send text message.\", ex.ToString());\n            }\n        }\n\n        /// <summary>\n        /// Sends a simple text auto-reply on behalf of a business.\n        /// This helper assumes Meta Cloud as the default provider and\n        /// uses the default active WhatsAppPhoneNumber to resolve PhoneNumberId.\n        /// Intended for AutoReplyBuilder / webhook runtime (no user context).\n        /// </summary>\n        public async Task<ResponseResult> SendAutoReplyTextAsync(\n       Guid businessId,\n       string recipientNumber,\n       string body,\n       CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty)\n            {\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed.\",\n                    \"BusinessId is required.\");\n            }\n\n            if (string.IsNullOrWhiteSpace(recipientNumber))\n            {\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed.\",\n                    \"Recipient phone number is required.\");\n            }\n\n            if (string.IsNullOrWhiteSpace(body))\n            {\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed.\",\n                    \"Reply body is empty.\");\n            }\n\n            try\n            {\n                // 1) Normalize the recipient a bit (full E.164 normalization happens elsewhere)\n                var trimmedNumber = recipientNumber.Trim();\n\n                // 2) Load active WhatsApp settings for this business\n                var setting = await _db.WhatsAppSettings\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive, ct);\n\n                if (setting == null)\n                {\n                    _logger.LogWarning(\n                        \"‚ö†Ô∏è AutoReply: WhatsApp settings not found for BusinessId={BusinessId}.\",\n                        businessId);\n\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Auto-reply failed.\",\n                        \"WhatsApp settings are not configured for this business.\");\n                }\n\n                var provider = (setting.Provider ?? string.Empty)\n                    .Trim()\n                    .ToUpperInvariant();\n\n                if (provider != \"META_CLOUD\" && provider != \"PINNACLE\")\n                {\n                    _logger.LogWarning(\n                        \"‚ö†Ô∏è AutoReply: Unsupported provider '{Provider}' for BusinessId={BusinessId}.\",\n                        provider,\n                        businessId);\n\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Auto-reply failed.\",\n                        \"WhatsApp provider is not correctly configured for this business.\");\n                }\n\n                // 3) Resolve the default sender (PhoneNumberId) for this provider\n                var phone = await _db.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .Where(p => p.BusinessId == businessId\n                                && p.IsActive\n                                && p.Provider.ToLower() == provider.ToLower())\n                    .OrderByDescending(p => p.IsDefault)\n                    .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                    .Select(p => new { p.PhoneNumberId, p.WhatsAppBusinessNumber })\n                    .FirstOrDefaultAsync(ct);\n\n                string? phoneNumberId = phone?.PhoneNumberId;\n\n                if (provider == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    _logger.LogWarning(\n                        \"‚ö†Ô∏è AutoReply: No default PhoneNumberId configured for BusinessId={BusinessId}, Provider={Provider}.\",\n                        businessId,\n                        provider);\n\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Auto-reply failed.\",\n                        \"No default WhatsApp sender number is configured for this business.\");\n                }\n\n                // 4) Build DTO for the core text sender\n                var dto = new TextMessageSendDto\n                {\n                    BusinessId = businessId,\n                    RecipientNumber = trimmedNumber,\n                    TextContent = body,\n                    Provider = provider,         // use provider from settings\n                    PhoneNumberId = phoneNumberId,\n                    Source = \"auto-reply\"\n                };\n\n                _logger.LogInformation(\n                    \"üì§ AutoReply: sending simple text reply for BusinessId={BusinessId}, Recipient={Recipient}, Preview={Preview}\",\n                    businessId,\n                    trimmedNumber,\n                    body.Length > 60 ? body.Substring(0, 60) + \"...\" : body);\n\n                // 5) Delegate to the existing pipeline (logs + OutboundMessageJob, etc.)\n                var result = await SendAutomationReply(dto);\n\n                if (!result.Success)\n                {\n                    _logger.LogWarning(\n                        \"‚ùå AutoReply: SendAutomationReply failed for BusinessId={BusinessId}, Recipient={Recipient}. Error={Error}\",\n                        businessId,\n                        trimmedNumber,\n                        result.Message);\n                }\n                else\n                {\n                    _logger.LogInformation(\n                        \"‚úÖ AutoReply: message sent successfully for BusinessId={BusinessId}, Recipient={Recipient}.\",\n                        businessId,\n                        trimmedNumber);\n                }\n\n                return result;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\n                    ex,\n                    \"‚ùå AutoReply: unexpected exception while sending simple text reply for BusinessId={BusinessId}, Recipient={Recipient}.\",\n                    businessId,\n                    recipientNumber);\n\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed due to an unexpected error.\",\n                    ex.Message);\n            }\n        }\n\n\n        /// <summary>\n        /// New overload for AutoReply that accepts a DeliveryMode.\n        /// Currently it delegates to the legacy implementation so\n        /// behaviour is unchanged. In the next steps we will route\n        /// Immediate vs Queued differently.\n        /// </summary>\n        public Task<ResponseResult> SendAutoReplyTextAsync(\n            Guid businessId,\n            string recipientNumber,\n            string body,\n            DeliveryMode mode,\n            CancellationToken ct = default)\n        {\n            // üîÅ Step 1: ignore mode, keep current behaviour.\n            return SendAutoReplyTextAsync(businessId, recipientNumber, body, ct);\n        }\n\n\n\n        #region SendTemplateMessageSimpleAsync Overload\n\n\n\n        //public async Task<ResponseResult> SendTemplateMessageSimpleAsync(Guid businessId, SimpleTemplateMessageDto dto)\n        //{\n        //    try\n        //    {\n        //        // Normalize inbound\n        //        string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n        //            ? null\n        //            : dto.Provider!.Trim().ToUpperInvariant();\n        //        string? providerKey = providerUpper?.ToLowerInvariant();\n        //        string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId)\n        //            ? null\n        //            : dto.PhoneNumberId!.Trim();\n\n        //        // Resolve missing provider/sender from WhatsAppPhoneNumbers\n        //        if (string.IsNullOrWhiteSpace(providerUpper))\n        //        {\n        //            var defPhone = await _db.WhatsAppPhoneNumbers\n        //                .AsNoTracking()\n        //                .Where(n => n.BusinessId == businessId && n.IsActive)\n        //                .OrderByDescending(n => n.IsDefault)\n        //                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n        //                .Select(n => new { n.Provider, n.PhoneNumberId })\n        //                .FirstOrDefaultAsync();\n\n        //            if (defPhone != null)\n        //            {\n        //                providerUpper = (defPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n        //                providerKey = providerUpper.ToLowerInvariant();\n        //                if (string.IsNullOrWhiteSpace(phoneNumberId))\n        //                    phoneNumberId = defPhone.PhoneNumberId;\n        //            }\n        //        }\n\n        //        if (string.IsNullOrWhiteSpace(providerUpper))\n        //        {\n        //            var anySettingProvider = await _db.WhatsAppSettings\n        //                .AsNoTracking()\n        //                .Where(s => s.BusinessId == businessId && s.IsActive)\n        //                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n        //                .Select(s => s.Provider)\n        //                .FirstOrDefaultAsync();\n\n        //            if (!string.IsNullOrWhiteSpace(anySettingProvider))\n        //            {\n        //                providerUpper = anySettingProvider.Trim().ToUpperInvariant();\n        //                providerKey = providerUpper.ToLowerInvariant();\n        //            }\n        //        }\n\n        //        if (providerUpper != \"PINNACLE\" && providerUpper != \"META_CLOUD\")\n        //        {\n        //            return ResponseResult.ErrorInfo(\n        //                \"‚ùå Missing provider.\",\n        //                \"No active WhatsApp sender found. Configure a PINNACLE or META_CLOUD sender for this business.\"\n        //            );\n        //        }\n\n        //        if (string.IsNullOrWhiteSpace(phoneNumberId))\n        //        {\n        //            var pn = await _db.WhatsAppPhoneNumbers\n        //                .AsNoTracking()\n        //                .Where(n => n.BusinessId == businessId\n        //                            && n.IsActive\n        //                            && n.Provider.ToLower() == providerKey)\n        //                .OrderByDescending(n => n.IsDefault)\n        //                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n        //                .Select(n => n.PhoneNumberId)\n        //                .FirstOrDefaultAsync();\n\n        //            if (!string.IsNullOrWhiteSpace(pn))\n        //                phoneNumberId = pn;\n        //        }\n\n        //        if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n        //            return ResponseResult.ErrorInfo(\"‚ùå Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n        //        // Build minimal components (body only)\n        //        var parameters = (dto.TemplateParameters ?? new List<string>())\n        //            .Select(p => new { type = \"text\", text = p })\n        //            .ToArray();\n\n        //        var components = new List<object>();\n        //        if (parameters.Length > 0)\n        //            components.Add(new { type = \"body\", parameters });\n\n        //        var lang = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!;\n        //        _logger?.LogInformation(\"‚û°Ô∏è SEND-INTENT tmpl={Template} to={To} provider={Provider} pnid={PhoneNumberId}\",\n        //            dto.TemplateName, dto.RecipientNumber, providerUpper, phoneNumberId ?? \"(default)\");\n\n        //        var sendResult = await SendViaProviderAsync(\n        //            businessId,\n        //            providerUpper,\n        //            p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName, lang, components),\n        //            phoneNumberId\n        //        );\n\n        //        var log = new MessageLog\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            BusinessId = businessId,\n        //            RecipientNumber = dto.RecipientNumber,\n        //            MessageContent = dto.TemplateName,\n        //            RenderedBody = TemplateParameterHelper.FillPlaceholders(\n        //                dto.TemplateBody ?? string.Empty,\n        //                dto.TemplateParameters ?? new List<string>()),\n\n        //            CTAFlowConfigId = dto.CTAFlowConfigId,\n        //            CTAFlowStepId = dto.CTAFlowStepId,\n\n        //            Provider = providerUpper,\n        //            ProviderMessageId = sendResult.MessageId,\n\n        //            Status = sendResult.Success ? \"Sent\" : \"Failed\",\n        //            ErrorMessage = sendResult.Success ? null : sendResult.Message,\n        //            RawResponse = sendResult.RawResponse,\n        //            MessageId = sendResult.MessageId,\n        //            SentAt = sendResult.Success ? DateTime.UtcNow : (DateTime?)null,\n        //            CreatedAt = DateTime.UtcNow,\n        //            Source = \"api\"\n        //        };\n\n        //        await _db.MessageLogs.AddAsync(log);\n        //        await _db.SaveChangesAsync();\n\n        //        return new ResponseResult\n        //        {\n        //            Success = sendResult.Success,\n        //            Message = sendResult.Success\n        //                ? \"‚úÖ Template sent successfully.\"\n        //                : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n        //            Data = new\n        //            {\n        //                Success = sendResult.Success,\n        //                MessageId = sendResult.MessageId,\n        //                LogId = log.Id\n        //            },\n        //            RawResponse = sendResult.RawResponse,\n        //            MessageId = sendResult.MessageId,\n        //            LogId = log.Id\n        //        };\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        try\n        //        {\n        //            await _db.MessageLogs.AddAsync(new MessageLog\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                BusinessId = businessId,\n        //                RecipientNumber = dto.RecipientNumber,\n        //                MessageContent = dto.TemplateName,\n        //                RenderedBody = TemplateParameterHelper.FillPlaceholders(\n        //                    dto.TemplateBody ?? string.Empty,\n        //                    dto.TemplateParameters ?? new List<string>()),\n        //                Status = \"Failed\",\n        //                ErrorMessage = ex.Message,\n        //                CreatedAt = DateTime.UtcNow,\n        //                Source = \"api\"\n        //            });\n        //            await _db.SaveChangesAsync();\n        //        }\n        //        catch { /* ignore */ }\n\n        //        return ResponseResult.ErrorInfo(\"‚ùå Template send failed\", ex.Message);\n        //    }\n        //}\n        ///// <summary>\n        ///// New overload that is aware of DeliveryMode.\n        ///// For now, it simply delegates to the existing implementation\n        ///// (which behaves as immediate/direct send).\n        ///// In the next steps, we will branch on <paramref name=\"mode\"/>.\n        ///// </summary>\n        //// Over Load method\n        //public Task<ResponseResult> SendTemplateMessageSimpleAsync(\n        //    Guid businessId,\n        //    SimpleTemplateMessageDto dto,\n        //    DeliveryMode mode)\n        //{\n        //    // üîÅ Step 1: keep behaviour identical.\n        //    // We ignore `mode` for now and just call the existing method.\n        //    // Later we will:\n        //    //  - use Queued mode for outbox\n        //    //  - use Immediate mode for direct Meta Cloud sends\n        //    return SendTemplateMessageSimpleAsync(businessId, dto);\n        //}\n\n        #endregion\n\n        public async Task<ResponseResult> SendTemplateMessageSimpleAsync(Guid businessId, SimpleTemplateMessageDto dto)\n        {\n            try\n            {\n                // üîé Normalize inbound + respect DeliveryMode for logging/analytics\n                var mode = dto.DeliveryMode; // default is Queued if caller didn't set\n\n                string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n                    ? null\n                    : dto.Provider!.Trim().ToUpperInvariant();\n                string? providerKey = providerUpper?.ToLowerInvariant();\n                string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId)\n                    ? null\n                    : dto.PhoneNumberId!.Trim();\n\n                // Resolve missing provider/sender from WhatsAppPhoneNumbers\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var defPhone = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId && n.IsActive)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => new { n.Provider, n.PhoneNumberId })\n                        .FirstOrDefaultAsync();\n\n                    if (defPhone != null)\n                    {\n                        providerUpper = (defPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                        if (string.IsNullOrWhiteSpace(phoneNumberId))\n                            phoneNumberId = defPhone.PhoneNumberId;\n                    }\n                }\n\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var anySettingProvider = await _db.WhatsAppSettings\n                        .AsNoTracking()\n                        .Where(s => s.BusinessId == businessId && s.IsActive)\n                        .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                        .Select(s => s.Provider)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(anySettingProvider))\n                    {\n                        providerUpper = anySettingProvider.Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                    }\n                }\n\n                if (providerUpper != \"PINNACLE\" && providerUpper != \"META_CLOUD\")\n                {\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Missing provider.\",\n                        \"No active WhatsApp sender found. Configure a PINNACLE or META_CLOUD sender for this business.\"\n                    );\n                }\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    var pn = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId\n                                    && n.IsActive\n                                    && n.Provider.ToLower() == providerKey)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => n.PhoneNumberId)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(pn))\n                        phoneNumberId = pn;\n                }\n\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, dto.RecipientNumber);\n                if (consentBlock != null) return consentBlock;\n\n                // Build components (header + body + dynamic URL buttons)\n                var components = new List<object>();\n\n                var headerKind = (dto.HeaderKind ?? string.Empty).Trim().ToLowerInvariant();\n                var headerUrl = string.IsNullOrWhiteSpace(dto.HeaderMediaUrl) ? null : dto.HeaderMediaUrl!.Trim();\n\n                if (!string.IsNullOrWhiteSpace(headerUrl))\n                {\n                    if (headerKind == \"image\")\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"image\", image = new { link = headerUrl } }\n                            }\n                        });\n                    }\n                    else if (headerKind == \"video\")\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"video\", video = new { link = headerUrl } }\n                            }\n                        });\n                    }\n                    else if (headerKind == \"document\")\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"document\", document = new { link = headerUrl } }\n                            }\n                        });\n                    }\n                }\n\n                var parameters = (dto.TemplateParameters ?? new List<string>())\n                    .Select(p => new { type = \"text\", text = p })\n                    .ToArray();\n\n                if (parameters.Length > 0)\n                    components.Add(new { type = \"body\", parameters });\n\n                var urlParams = dto.UrlButtonParams ?? new List<string>();\n                for (int i = 0; i < urlParams.Count && i < 3; i++)\n                {\n                    var p = (urlParams[i] ?? string.Empty).Trim();\n                    if (string.IsNullOrWhiteSpace(p)) continue;\n\n                    components.Add(new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i.ToString(),\n                        parameters = new object[]\n                        {\n                            new { type = \"text\", text = p }\n                        }\n                    });\n                }\n\n                var lang = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!;\n\n                _logger?.LogInformation(\n                    \"‚û°Ô∏è SEND-INTENT tmpl={Template} to={To} provider={Provider} pnid={PhoneNumberId} mode={Mode} ctaFlowConfig={CtaFlowConfigId} ctaFlowStep={CtaFlowStepId}\",\n                    dto.TemplateName,\n                    dto.RecipientNumber,\n                    providerUpper,\n                    phoneNumberId ?? \"(default)\",\n                    mode,\n                    dto.CTAFlowConfigId,\n                    dto.CTAFlowStepId\n                );\n\n                // üßµ IMPORTANT:\n                // For now, BOTH Queued + Immediate behave the same: direct send.\n                // Later, if you wire a true Outbox, you can special-case `mode == DeliveryMode.Queued`\n                // to enqueue instead of calling SendViaProviderAsync.\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    providerUpper,\n                    p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName, lang, components),\n                    phoneNumberId\n                );\n\n                // üè∑ Smarter Source tagging:\n                // - If CTAFlowConfigId is set ‚Üí this is a CTA Flow step\n                // - Else ‚Üí normal API/template send\n                var isCtaFlow = dto.CTAFlowConfigId.HasValue;\n\n                var sourceTag = isCtaFlow\n                    ? (mode == DeliveryMode.Immediate ? \"cta-flow-immediate\" : \"cta-flow-queued\")\n                    : (mode == DeliveryMode.Immediate ? \"api-immediate\" : \"api-queued\");\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName,\n                    MediaUrl = headerUrl,\n                    RenderedBody = TemplateParameterHelper.FillPlaceholders(\n                        dto.TemplateBody ?? string.Empty,\n                        dto.TemplateParameters ?? new List<string>()),\n\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n\n                    Provider = providerUpper,\n                    ProviderMessageId = sendResult.MessageId,\n\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    SentAt = sendResult.Success ? DateTime.UtcNow : (DateTime?)null,\n                    CreatedAt = DateTime.UtcNow,\n\n                    // üëá now carries CTA vs non-CTA + mode\n                    Source = sourceTag\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Template sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = sendResult.MessageId,\n                        LogId = log.Id\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                try\n                {\n                    await _db.MessageLogs.AddAsync(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        RecipientNumber = dto.RecipientNumber,\n                        MessageContent = dto.TemplateName,\n                        MediaUrl = string.IsNullOrWhiteSpace(dto.HeaderMediaUrl) ? null : dto.HeaderMediaUrl.Trim(),\n                        RenderedBody = TemplateParameterHelper.FillPlaceholders(\n                            dto.TemplateBody ?? string.Empty,\n                            dto.TemplateParameters ?? new List<string>()),\n                        Status = \"Failed\",\n                        ErrorMessage = ex.Message,\n                        CreatedAt = DateTime.UtcNow,\n                        Source = \"api-error\"\n                    });\n                    await _db.SaveChangesAsync();\n                }\n                catch { /* ignore */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Template send failed\", ex.Message);\n            }\n        }\n\n        /// <summary>\n        /// New overload that is aware of DeliveryMode.\n        /// Right now it just stamps the mode into the DTO\n        /// and calls the core implementation. Later, if you\n        /// implement a real outbox, this is the natural place\n        /// to branch behaviour.\n        /// </summary>\n        public Task<ResponseResult> SendTemplateMessageSimpleAsync(\n            Guid businessId,\n            SimpleTemplateMessageDto dto,\n            DeliveryMode mode)\n        {\n            // Keep DTO + intent in sync\n            dto.DeliveryMode = mode;\n\n            // For now, both modes use the same path.\n            return SendTemplateMessageSimpleAsync(businessId, dto);\n        }\n\n        public async Task<ResponseResult> SendImageCampaignAsync(Guid campaignId, Guid businessId, string sentBy)\n        {\n            try\n            {\n                var campaign = await _db.Campaigns\n                    .Include(c => c.MultiButtons)\n                    .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n                if (campaign == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign not found or unauthorized.\");\n\n                var recipients = await _db.CampaignRecipients\n                    .Include(r => r.Contact)\n                    .Where(r => r.CampaignId == campaignId && r.BusinessId == businessId)\n                    .ToListAsync();\n\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ö†Ô∏è No recipients assigned to this campaign.\");\n\n                var validButtons = campaign.MultiButtons\n                    ?.Where(b => !string.IsNullOrWhiteSpace(b.Title))\n                    .Select(b => new CtaButtonDto { Title = b.Title, Value = b.Value })\n                    .ToList();\n\n                if (validButtons == null || validButtons.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ùå At least one CTA button with a valid title is required.\");\n\n                int successCount = 0, failCount = 0;\n\n                foreach (var recipient in recipients)\n                {\n                    if (recipient.Contact == null || string.IsNullOrWhiteSpace(recipient.Contact.PhoneNumber))\n                    {\n                        recipient.Status = \"Failed\";\n                        recipient.UpdatedAt = DateTime.UtcNow;\n                        failCount++;\n                        continue;\n                    }\n\n                    var dto = new SendMessageDto\n                    {\n                        BusinessId = businessId,\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        MessageType = MessageTypeEnum.Image,\n                        MediaUrl = campaign.ImageUrl,\n                        TextContent = campaign.MessageTemplate,\n                        CtaButtons = validButtons,\n\n                        CampaignId = campaign.Id,\n                        SourceModule = \"image-campaign\",\n                        CustomerId = recipient.Contact.Id.ToString(),\n                        CustomerName = recipient.Contact.Name,\n                        CustomerPhone = recipient.Contact.PhoneNumber,\n                        CTATriggeredFrom = \"campaign\"\n                    };\n\n                    var result = await SendImageWithCtaAsync(dto);\n\n                    var sendLog = new CampaignSendLog\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaign.Id,\n                        ContactId = recipient.Contact.Id,\n                        RecipientId = recipient.Id,\n                        MessageLogId = result?.LogId,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        SentAt = result.Success ? DateTime.UtcNow : (DateTime?)null,\n                        CreatedBy = sentBy,\n                        BusinessId = businessId,\n                    };\n                    await _db.CampaignSendLogs.AddAsync(sendLog);\n\n                    if (result.Success)\n                    {\n                        recipient.Status = \"Sent\";\n                        recipient.SentAt = DateTime.UtcNow;\n                        recipient.UpdatedAt = DateTime.UtcNow;\n                        successCount++;\n                    }\n                    else\n                    {\n                        recipient.Status = \"Failed\";\n                        recipient.UpdatedAt = DateTime.UtcNow;\n                        failCount++;\n                    }\n                }\n\n                await _db.SaveChangesAsync();\n\n                await _db.Campaigns\n                    .Where(c => c.Id == campaign.Id && c.BusinessId == businessId)\n                    .ExecuteUpdateAsync(s => s\n                        .SetProperty(c => c.Status, _ => \"Sent\")\n                        .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow));\n\n                return ResponseResult.SuccessInfo($\"‚úÖ Campaign sent.\\nüì§ Success: {successCount}, ‚ùå Failed: {failCount}\");\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"‚ùå Error sending image campaign: {ex.Message}\");\n                return ResponseResult.ErrorInfo(\"‚ùå Unexpected error while sending image campaign.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendTemplateCampaignAsync(Guid campaignId, Guid businessId, string sentBy)\n        {\n            try\n            {\n                var campaign = await _db.Campaigns\n                    .AsNoTracking()\n                    .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                    .Select(c => new\n                    {\n                        c.Id,\n                        c.BusinessId,\n                        c.MessageTemplate,\n                        c.TemplateId,\n                        c.Provider,\n                        c.PhoneNumberId,\n                        c.ImageUrl\n                    })\n                    .FirstOrDefaultAsync();\n\n                if (campaign == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign not found or unauthorized.\");\n\n                var templateName = !string.IsNullOrWhiteSpace(campaign.TemplateId)\n                    ? campaign.TemplateId!\n                    : (campaign.MessageTemplate ?? \"\").Trim();\n\n                if (string.IsNullOrWhiteSpace(templateName))\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign has no template selected.\");\n\n                var lang = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(w => w.BusinessId == businessId && w.Name == templateName)\n                    .OrderByDescending(w => (w.UpdatedAt > w.CreatedAt ? w.UpdatedAt : w.CreatedAt))\n                    .Select(w => w.LanguageCode)\n                    .FirstOrDefaultAsync();\n                if (string.IsNullOrWhiteSpace(lang)) lang = \"en_US\";\n\n                var recipients = await _db.CampaignRecipients\n                    .AsNoTracking()\n                    .Include(r => r.AudienceMember)\n                    .Include(r => r.Contact)\n                    .Where(r => r.CampaignId == campaignId && r.BusinessId == businessId)\n                    .Select(r => new\n                    {\n                        r.Id,\n                        r.ContactId,\n                        AudienceContactId = r.AudienceMember != null ? r.AudienceMember.ContactId : (Guid?)null,\n                        r.ResolvedParametersJson,\n                        r.ResolvedButtonUrlsJson,\n                        Phone = r.AudienceMember != null && !string.IsNullOrEmpty(r.AudienceMember.PhoneE164)\n                                ? r.AudienceMember.PhoneE164\n                                : (r.Contact != null ? r.Contact.PhoneNumber : null)\n                    })\n                    .ToListAsync();\n\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ö†Ô∏è No recipients materialized for this campaign.\");\n\n                var provider = (campaign.Provider ?? \"\").Trim().ToUpperInvariant();\n                if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider on campaign. Must be 'PINNACLE' or 'META_CLOUD'.\");\n\n                var phoneNumberId = string.IsNullOrWhiteSpace(campaign.PhoneNumberId) ? null : campaign.PhoneNumberId!.Trim();\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign has no sender number (PhoneNumberId).\");\n\n                int success = 0, fail = 0;\n                var successIds = new List<Guid>(recipients.Count);\n                var failedIds = new List<Guid>();\n                var sendLogs = new List<CampaignSendLog>(recipients.Count);\n\n                foreach (var r in recipients)\n                {\n                    if (string.IsNullOrWhiteSpace(r.Phone))\n                    {\n                        failedIds.Add(r.Id);\n                        continue;\n                    }\n\n                    string[] bodyParams;\n                    try\n                    {\n                        bodyParams = string.IsNullOrWhiteSpace(r.ResolvedParametersJson)\n                            ? Array.Empty<string>()\n                            : JsonSerializer.Deserialize<string[]>(r.ResolvedParametersJson!) ?? Array.Empty<string>();\n                    }\n                    catch { bodyParams = Array.Empty<string>(); }\n\n                    Dictionary<string, string> buttonVars;\n                    try\n                    {\n                        buttonVars = string.IsNullOrWhiteSpace(r.ResolvedButtonUrlsJson)\n                            ? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)\n                            : JsonSerializer.Deserialize<Dictionary<string, string>>(r.ResolvedButtonUrlsJson!)\n                              ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n                    }\n                    catch { buttonVars = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase); }\n\n                    var components = new List<object>();\n\n                    var headerImage = !string.IsNullOrWhiteSpace(campaign.ImageUrl)\n                        ? campaign.ImageUrl\n                        : (buttonVars.TryGetValue(\"header.image_url\", out var hv) && !string.IsNullOrWhiteSpace(hv) ? hv : null);\n\n                    if (!string.IsNullOrWhiteSpace(headerImage))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"image\", image = new { link = headerImage! } }\n                            }\n                        });\n                    }\n\n                    if (bodyParams.Length > 0)\n                    {\n                        components.Add(new\n                        {\n                            type = \"body\",\n                            parameters = bodyParams.Select(p => (object)new { type = \"text\", text = p }).ToArray()\n                        });\n                    }\n\n                    foreach (var pos in new[] { 1, 2, 3 })\n                    {\n                        var key = $\"button{pos}.url_param\";\n                        if (buttonVars.TryGetValue(key, out var urlParam) && !string.IsNullOrWhiteSpace(urlParam))\n                        {\n                            components.Add(new\n                            {\n                                type = \"button\",\n                                sub_type = \"url\",\n                                index = (pos - 1).ToString(),\n                                parameters = new object[] { new { type = \"text\", text = urlParam } }\n                            });\n                        }\n                    }\n\n                    var payload = new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = r.Phone!,\n                        type = \"template\",\n                        template = new\n                        {\n                            name = templateName,\n                            language = new { code = lang },\n                            components = components\n                        }\n                    };\n\n                    var result = await SendPayloadAsync(businessId, provider, payload, phoneNumberId);\n                    if (result.Success) { success++; successIds.Add(r.Id); } else { fail++; failedIds.Add(r.Id); }\n\n                    var contactId = r.ContactId ?? r.AudienceContactId;\n                    sendLogs.Add(new CampaignSendLog\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaign.Id,\n                        ContactId = contactId,\n                        RecipientId = r.Id,\n                        MessageLogId = result?.LogId,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        SentAt = result.Success ? DateTime.UtcNow : (DateTime?)null,\n                        CreatedBy = sentBy,\n                        BusinessId = businessId,\n                    });\n                }\n\n                if (sendLogs.Count > 0)\n                    await _db.CampaignSendLogs.AddRangeAsync(sendLogs);\n\n                if (successIds.Count > 0)\n                {\n                    await _db.CampaignRecipients\n                        .Where(x => x.CampaignId == campaignId && x.BusinessId == businessId && successIds.Contains(x.Id))\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(x => x.Status, _ => \"Sent\")\n                            .SetProperty(x => x.SentAt, _ => DateTime.UtcNow)\n                            .SetProperty(x => x.UpdatedAt, _ => DateTime.UtcNow));\n                }\n\n                if (failedIds.Count > 0)\n                {\n                    await _db.CampaignRecipients\n                        .Where(x => x.CampaignId == campaignId && x.BusinessId == businessId && failedIds.Contains(x.Id))\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(x => x.Status, _ => \"Failed\")\n                            .SetProperty(x => x.UpdatedAt, _ => DateTime.UtcNow));\n                }\n\n                await _db.SaveChangesAsync();\n\n                await _db.Campaigns\n                    .Where(c => c.Id == campaign.Id && c.BusinessId == businessId)\n                    .ExecuteUpdateAsync(s => s\n                        .SetProperty(c => c.Status, _ => \"Sent\")\n                        .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow));\n\n                return ResponseResult.SuccessInfo($\"‚úÖ Template campaign sent. üì§ Success: {success}, ‚ùå Failed: {fail}\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Error sending template campaign.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendImageWithCtaAsync(SendMessageDto dto)\n        {\n            try\n            {\n                Console.WriteLine($\"üì§ Sending image+CTA to {dto.RecipientNumber}\");\n\n                if (string.IsNullOrWhiteSpace(dto.TextContent))\n                    return ResponseResult.ErrorInfo(\"‚ùå Image message caption (TextContent) cannot be empty.\");\n\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(dto.BusinessId, dto.RecipientNumber);\n                if (consentBlock != null) return consentBlock;\n\n                var validButtons = dto.CtaButtons?\n                    .Where(b => !string.IsNullOrWhiteSpace(b.Title))\n                    .Take(3)\n                    .Select((btn, index) => new\n                    {\n                        type = \"reply\",\n                        reply = new\n                        {\n                            id = $\"btn_{index + 1}_{Guid.NewGuid():N}\".Substring(0, 16),\n                            title = btn.Title\n                        }\n                    })\n                    .ToList();\n\n                if (validButtons == null || validButtons.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ùå At least one CTA button with a valid title is required.\");\n\n                var payload = new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = dto.RecipientNumber,\n                    type = \"interactive\",\n                    interactive = new\n                    {\n                        type = \"button\",\n                        body = new { text = dto.TextContent },\n                        action = new { buttons = validButtons }\n                    },\n                    image = string.IsNullOrWhiteSpace(dto.MediaUrl) ? null : new { link = dto.MediaUrl }\n                };\n\n                var sendResult = await SendViaProviderAsync(\n                    dto.BusinessId,\n                    dto.Provider,\n                    p => p.SendInteractiveAsync(payload),\n                    dto.PhoneNumberId\n                );\n\n                string? messageId = sendResult.MessageId;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(sendResult.RawResponse))\n                {\n                    try\n                    {\n                        var raw = sendResult.RawResponse.TrimStart();\n                        if (raw.StartsWith(\"{\"))\n                        {\n                            using var doc = JsonDocument.Parse(raw);\n                            if (doc.RootElement.TryGetProperty(\"messages\", out var msgs) &&\n                                msgs.ValueKind == JsonValueKind.Array &&\n                                msgs.GetArrayLength() > 0 &&\n                                msgs[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* best-effort */ }\n                }\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent ?? \"[Image with CTA]\",\n                    RenderedBody = dto.TextContent ?? \"\",\n                    MediaUrl = dto.MediaUrl,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Image+CTA message sent.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id\n\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Exception in SendImageWithCtaAsync: \" + ex.Message);\n\n                await _db.MessageLogs.AddAsync(new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent ?? \"[Image CTA Failed]\",\n                    RenderedBody = dto.TextContent ?? \"[Failed image CTA]\",\n                    Status = \"Failed\",\n                    ErrorMessage = ex.Message,\n                    RawResponse = ex.ToString(),\n                    CreatedAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                });\n\n                await _db.SaveChangesAsync();\n\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to send image+CTA.\", ex.ToString());\n            }\n        }\n        [Obsolete(\"Use outbox + SendPayloadAsync via worker.\")]\n        public async Task<ResponseResult> SendImageTemplateMessageAsync(ImageTemplateMessageDto dto, Guid businessId)\n        {\n            try\n            {\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                var consentBlock = await EnforceOutboundConsentGuardAsync(businessId, dto.RecipientNumber);\n                if (consentBlock != null) return consentBlock;\n\n                var components = new List<object>();\n\n                if (!string.IsNullOrWhiteSpace(dto.HeaderImageUrl))\n                {\n                    components.Add(new\n                    {\n                        type = \"header\",\n                        parameters = new[]\n                        {\n                            new { type = \"image\", image = new { link = dto.HeaderImageUrl! } }\n                        }\n                    });\n                }\n\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = (dto.TemplateParameters ?? new List<string>())\n                        .Select(p => new { type = \"text\", text = p })\n                        .ToArray()\n                });\n\n                var btns = dto.ButtonParameters ?? new List<CampaignButtonDto>();\n                for (int i = 0; i < btns.Count && i < 3; i++)\n                {\n                    var btn = btns[i];\n                    var subType = btn.ButtonType?.ToLowerInvariant();\n                    if (string.IsNullOrWhiteSpace(subType)) continue;\n\n                    var button = new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = subType,\n                        [\"index\"] = i.ToString()\n                    };\n\n                    if (subType == \"quick_reply\" && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                        button[\"parameters\"] = new[] { new { type = \"payload\", payload = btn.TargetUrl! } };\n                    else if (subType == \"url\" && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                        button[\"parameters\"] = new[] { new { type = \"text\", text = btn.TargetUrl! } };\n\n                    components.Add(button);\n                }\n\n                var lang = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!;\n\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    dto.Provider,\n                    p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName, lang, components),\n                    dto.PhoneNumberId\n                );\n\n                var renderedBody = TemplateParameterHelper.FillPlaceholders(\n                    dto.TemplateBody ?? \"\",\n                    dto.TemplateParameters ?? new List<string>());\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName,\n                    MediaUrl = dto.HeaderImageUrl,\n                    RenderedBody = renderedBody,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Image template sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new { Success = sendResult.Success, MessageId = sendResult.MessageId, LogId = log.Id },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                await _db.MessageLogs.AddAsync(new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName,\n                    RenderedBody = TemplateParameterHelper.FillPlaceholders(dto.TemplateBody ?? \"\", dto.TemplateParameters ?? new List<string>()),\n                    MediaUrl = dto.HeaderImageUrl,\n                    Status = \"Failed\",\n                    ErrorMessage = ex.Message,\n                    RawResponse = ex.ToString(),\n                    CreatedAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                });\n\n                await _db.SaveChangesAsync();\n                return ResponseResult.ErrorInfo(\"‚ùå Error sending image template.\", ex.ToString());\n            }\n        }\n\n        public async Task<IEnumerable<RecentMessageLogDto>> GetLogsByBusinessIdAsync(Guid businessId)\n        {\n            var logs = await _db.MessageLogs\n                .Where(m => m.BusinessId == businessId)\n                .OrderByDescending(m => m.CreatedAt)\n                .Take(1000)\n                .Select(m => new RecentMessageLogDto\n                {\n                    Id = m.Id,\n                    RecipientNumber = m.RecipientNumber,\n                    MessageContent = m.MessageContent,\n                    Status = m.Status,\n                    CreatedAt = m.CreatedAt,\n                    SentAt = m.SentAt,\n                    ErrorMessage = m.ErrorMessage\n                })\n                .ToListAsync();\n\n            return logs;\n        }\n\n        public Task<ResponseResult> SendDocumentTemplateMessageAsync(DocumentTemplateMessageDto dto, Guid businessId)\n        {\n            throw new NotImplementedException();\n        }\n\n        private async Task<IReadOnlyList<WhatsAppSettingEntity>> GetBusinessWhatsAppSettingsAsync(Guid businessId)\n        {\n            if (_settingsCache.TryGetValue(businessId, out var cached) && cached.expiresAt > DateTime.UtcNow)\n                return cached.setting;\n\n            var items = await _db.WhatsAppSettings\n                .Where(s => s.BusinessId == businessId)\n                .ToListAsync();\n\n            if (items == null || items.Count == 0)\n                throw new Exception(\"WhatsApp settings not found.\");\n\n            var ro = items.AsReadOnly();\n            _settingsCache[businessId] = (ro, DateTime.UtcNow.AddMinutes(5));\n            return ro;\n        }\n    }\n}\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/SendPipeline/ProviderNormalizer.cs",
      "sha256": "b1aa904138bd23abe377835e2a4ccce78f1742142ddb717df48287d9d1e100ea",
      "language": "csharp",
      "size": 846,
      "content": "namespace xbytechat.api.Features.CampaignModule.Services.SendPipeline\n{\n    public static class ProviderNormalizer\n    {\n\n        public static string ForDb(string? providerFromSettings)\n        {\n            var v = (providerFromSettings ?? string.Empty).Trim();\n            // If you store \"meta_cloud\" / \"pinnacle\" in DB, keep it as-is:\n            return v.ToLowerInvariant(); // e.g. \"meta_cloud\", \"pinnacle\"\n        }\n\n        public static string ForSend(string? providerFromSettings)\n        {\n            var v = (providerFromSettings ?? string.Empty).Trim().ToLowerInvariant();\n            return v switch\n            {\n                \"pinnacle\" => \"PINNACLE\",\n                \"meta_cloud\" => \"META_CLOUD\",\n                _ => providerFromSettings ?? string.Empty // pass-through for future providers\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/SendPipeline/TemplateHeaderInspector.cs",
      "sha256": "d6dfbd0106161bd235f70126864bcb5cf4ede304695288ffd610794077c5b428",
      "language": "csharp",
      "size": 3096,
      "content": "using System;\nusing Newtonsoft.Json.Linq;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services.SendPipeline\n{\n    public enum TemplateHeaderKind\n    {\n        Text,\n        Image,\n        Video,\n        Document\n    }\n\n    public static class TemplateHeaderInspector\n    {\n        /// <summary>\n        /// Reads a WhatsApp template row (from DB) and infers the HEADER kind quickly,\n        /// using RawJson when present, otherwise falling back to flags like HasImageHeader.\n        /// No network calls. Pure and deterministic.\n        /// </summary>\n        public static TemplateHeaderKind Infer(WhatsAppTemplate templateRow)\n        {\n            if (templateRow == null) return TemplateHeaderKind.Text;\n\n            // 1) Prefer RawJson (when available) ‚Äî read only the minimal bits we need\n            var raw = templateRow.RawJson;\n            if (!string.IsNullOrWhiteSpace(raw))\n            {\n                try\n                {\n                    var root = JObject.Parse(raw);\n                    var comps = root[\"components\"] as JArray;\n                    if (comps != null)\n                    {\n                        foreach (var comp in comps)\n                        {\n                            var type = comp?[\"type\"]?.ToString()?.Trim().ToUpperInvariant();\n                            if (type == \"HEADER\")\n                            {\n                                var format = comp?[\"format\"]?.ToString()?.Trim().ToUpperInvariant();\n                                if (!string.IsNullOrEmpty(format))\n                                {\n                                    if (format == \"IMAGE\") return TemplateHeaderKind.Image;\n                                    if (format == \"VIDEO\") return TemplateHeaderKind.Video;\n                                    if (format == \"DOCUMENT\" || format == \"PDF\") return TemplateHeaderKind.Document;\n                                    return TemplateHeaderKind.Text;\n                                }\n                                // If TYPE=HEADER but no format => treat as Text\n                                return TemplateHeaderKind.Text;\n                            }\n                        }\n                    }\n                }\n                catch\n                {\n                    // swallow; fall through to flags\n                }\n            }\n\n            // 2) Fallback: existing DB flags\n           // if (templateRow.HasImageHeader) return TemplateHeaderKind.Image;\n\n            return TemplateHeaderKind.Text;\n        }\n\n        /// <summary>\n        /// Maps a header kind to our ‚ÄúmediaType‚Äù shorthand used by send routing.\n        /// </summary>\n        public static string ToMediaType(TemplateHeaderKind kind)\n        {\n            return kind switch\n            {\n                TemplateHeaderKind.Image => \"image\",\n                TemplateHeaderKind.Video => \"video\",\n                TemplateHeaderKind.Document => \"document\",\n                _ => \"text\"\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/TemplateMessageSender.cs",
      "sha256": "ccf337582a45a95cf31b6229f11d4734a66913dcdbf49f14b0499257ccc01fbe",
      "language": "csharp",
      "size": 15092,
      "content": "// üìÑ File: Features/MessagesEngine/Services/TemplateMessageSender.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Helpers;\n\n//using xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public class TemplateMessageSender : ITemplateMessageSender\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _httpClient;\n        private readonly ILogger<TemplateMessageSender> _logger;\n        private readonly IWhatsAppTemplateFetcherService _templateService;\n\n        public TemplateMessageSender(\n            AppDbContext db,\n            HttpClient httpClient,\n            ILogger<TemplateMessageSender> logger,\n            IWhatsAppTemplateFetcherService templateService)\n        {\n            _db = db;\n            _httpClient = httpClient;\n            _logger = logger;\n            _templateService = templateService;\n        }\n\n        //public async Task<ResponseResult> SendTemplateMessageToContactAsync(\n        //    Guid businessId,\n        //    Contact contact,\n        //    string templateName,\n        //    List<string> templateParams,\n        //    string? imageUrl = null,\n        //    List<CampaignButton>? buttons = null,\n        //    string? source = null,\n        //    Guid? refMessageId = null)\n        //{\n        //    var setting = await _db.WhatsAppSettings.FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive);\n        //    if (setting == null)\n        //        return ResponseResult.ErrorInfo(\"WhatsApp settings not found for this business.\");\n\n        //    var template = await _templateService.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n        //    if (template == null)\n        //        return ResponseResult.ErrorInfo(\"Template not found or invalid.\");\n\n        //    var payload = new Dictionary<string, object>\n        //    {\n        //        [\"messaging_product\"] = \"whatsapp\",\n        //        [\"to\"] = contact.PhoneNumber,\n        //        [\"type\"] = \"template\",\n        //        [\"template\"] = new\n        //        {\n        //            name = template.Name,\n        //            language = new { code = template.Language },\n        //            components = BuildTemplateComponents(template, templateParams, imageUrl, buttons)\n        //        }\n        //    };\n\n        //    _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    var json = JsonSerializer.Serialize(payload);\n        //    var response = await _httpClient.PostAsync(\n        //        $\"{setting.ApiUrl?.TrimEnd('/') ?? \"https://graph.facebook.com/v22.0\"}/{setting.PhoneNumberId}/messages\",\n        //        new StringContent(json, Encoding.UTF8, \"application/json\"));\n\n        //    var responseBody = await response.Content.ReadAsStringAsync();\n        //    var status = response.IsSuccessStatusCode ? \"Sent\" : \"Failed\";\n\n        //    await _db.MessageLogs.AddAsync(new MessageLog\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = businessId,\n        //        ContactId = contact.Id,\n        //        MessageContent = template.Name,\n        //        MediaUrl = imageUrl,\n        //        Status = status,\n        //        RawResponse = responseBody,\n        //        ErrorMessage = response.IsSuccessStatusCode ? null : responseBody,\n        //        Source = source,\n        //        RefMessageId = refMessageId,\n        //        CreatedAt = DateTime.UtcNow,\n        //        SentAt = DateTime.UtcNow\n        //    });\n\n        //    await _db.SaveChangesAsync();\n        //    return response.IsSuccessStatusCode\n        //        ? ResponseResult.SuccessInfo(\"‚úÖ Message sent successfully\", null, responseBody)\n        //        : ResponseResult.ErrorInfo(\"‚ùå Message failed\", null, responseBody);\n\n        //}\n\n        public async Task<ResponseResult> SendTemplateMessageToContactAsync(\n    Guid businessId,\n    Contact contact,\n    string templateName,\n    List<string> templateParams,\n    string? imageUrl = null,\n    List<CampaignButton>? buttons = null,\n    string? source = null,\n    Guid? refMessageId = null)\n        {\n            // 1) Load settings (provider, keys, base url, etc.)\n            var setting = await _db.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive);\n\n            if (setting == null)\n                return ResponseResult.ErrorInfo(\"‚ùå WhatsApp settings not found for this business.\");\n\n            // 2) Pick the default phone number for THIS provider from WhatsAppPhoneNumbers\n            var phone = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(p => p.BusinessId == businessId\n                            && p.IsActive\n                            && p.Provider.ToLower() == (setting.Provider ?? string.Empty).ToLower())\n                .OrderByDescending(p => p.IsDefault)\n                .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                .Select(p => new { p.PhoneNumberId, p.WhatsAppBusinessNumber })\n                .FirstOrDefaultAsync();\n\n            var provider = (setting.Provider ?? string.Empty).Trim().ToUpperInvariant();\n            var phoneNumberId = phone?.PhoneNumberId;  // may be null for Pinnacle if you use WABA id\n            var baseUrl = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            // 3) Template meta\n            var template = await _templateService.GetTemplateByNameAsync(\n                businessId, templateName, includeButtons: true);\n\n            if (template == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Template not found or invalid.\");\n\n            // 4) Provider-specific URL + headers\n            string url;\n            using var req = new HttpRequestMessage(HttpMethod.Post, \"\");\n\n            if (provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    return ResponseResult.ErrorInfo(\"‚ùå Meta access token (ApiKey) missing.\");\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"‚ùå PhoneNumberId not configured for Meta Cloud.\");\n\n                if (string.IsNullOrWhiteSpace(baseUrl))\n                    baseUrl = \"https://graph.facebook.com/v22.0\";\n\n                url = $\"{baseUrl}/{phoneNumberId}/messages\";\n                req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n            }\n            else if (provider == \"PINNACLE\")\n            {\n                if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    return ResponseResult.ErrorInfo(\"‚ùå Pinnacle API key missing.\");\n\n                if (string.IsNullOrWhiteSpace(baseUrl))\n                    baseUrl = \"https://partnersv1.pinbot.ai\";\n                if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                    baseUrl += \"/v3\";\n\n                var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                                ? setting.WabaId!.Trim()\n                                : (phoneNumberId ?? string.Empty).Trim();\n                if (string.IsNullOrWhiteSpace(pathId))\n                    return ResponseResult.ErrorInfo(\"‚ùå Provide WABA ID or PhoneNumberId for Pinnacle.\");\n\n                url = $\"{baseUrl}/{pathId}/messages\";\n                // put the key everywhere Pinnacle might accept it\n                req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n                req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n                req.Headers.Authorization = new AuthenticationHeaderValue(\"Apikey\", setting.ApiKey);\n            }\n            else\n            {\n                return ResponseResult.ErrorInfo($\"‚ùå Unsupported provider: {setting.Provider}\");\n            }\n\n            // 5) Payload (language field differs by provider)\n            object components = BuildTemplateComponents(template, templateParams, imageUrl, buttons);\n            object payload = (provider == \"PINNACLE\")\n                ? new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = contact.PhoneNumber,\n                    type = \"template\",\n                    template = new\n                    {\n                        name = template.Name,\n                        language = template.Language,    // Pinnacle expects a string\n                        components\n                    }\n                }\n                : new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = contact.PhoneNumber,\n                    type = \"template\",\n                    template = new\n                    {\n                        name = template.Name,\n                        language = new { code = template.Language }, // Meta needs { code: \"en_US\" }\n                        components\n                    }\n                };\n\n            var json = JsonSerializer.Serialize(payload, new JsonSerializerOptions\n            {\n                DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull\n            });\n\n            req.RequestUri = new Uri(url);\n            req.Content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            // 6) Send and log\n            var response = await _httpClient.SendAsync(req);\n            var responseBody = await response.Content.ReadAsStringAsync();\n            var status = response.IsSuccessStatusCode ? \"Sent\" : \"Failed\";\n\n            await _db.MessageLogs.AddAsync(new MessageLog\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                ContactId = contact.Id,\n                MessageContent = template.Name,\n                MediaUrl = imageUrl,\n                Status = status,\n                RawResponse = responseBody,\n                ErrorMessage = response.IsSuccessStatusCode ? null : responseBody,\n                Source = source,\n                RefMessageId = refMessageId,\n                CreatedAt = DateTime.UtcNow,\n                SentAt = DateTime.UtcNow\n            });\n\n            await _db.SaveChangesAsync();\n\n            return response.IsSuccessStatusCode\n                ? ResponseResult.SuccessInfo(\"‚úÖ Message sent successfully\", null, responseBody)\n                : ResponseResult.ErrorInfo(\"‚ùå Message failed\", null, responseBody);\n        }\n\n        public async Task<ResponseResult> SendTemplateCampaignAsync(Campaign campaign)\n        {\n            if (campaign == null || campaign.IsDeleted)\n                return ResponseResult.ErrorInfo(\"Invalid or deleted campaign.\");\n\n            var contacts = await _db.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaign.Id && r.Contact != null)\n                .ToListAsync();\n\n            if (!contacts.Any())\n                return ResponseResult.ErrorInfo(\"No contacts found for this campaign.\");\n\n            var templateName = campaign.TemplateId;\n            var templateParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n            var templateMeta = await _templateService.GetTemplateByNameAsync(campaign.BusinessId, templateName, includeButtons: true);\n\n            if (templateMeta == null)\n                return ResponseResult.ErrorInfo(\"Template metadata not found.\");\n\n            int success = 0, failed = 0;\n\n            foreach (var r in contacts)\n            {\n                var result = await SendTemplateMessageToContactAsync(\n                    campaign.BusinessId,\n                    r.Contact,\n                    templateName,\n                    templateParams,\n                    campaign.ImageUrl,\n                    campaign.MultiButtons?.ToList(),\n                    source: \"campaign\",\n                    refMessageId: campaign.Id);\n\n                await _db.CampaignSendLogs.AddAsync(new CampaignSendLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaign.Id,\n                    ContactId = r.ContactId,\n                    RecipientId = r.Id,\n                    MessageBody = campaign.MessageBody ?? templateName,\n                    TemplateId = templateName,\n                    SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CreatedBy = campaign.CreatedBy\n                });\n\n                if (result.Success) success++;\n                else failed++;\n            }\n\n            await _db.SaveChangesAsync();\n            return ResponseResult.SuccessInfo($\"üì§ Sent to {success}, ‚ùå Failed for {failed}.\");\n        }\n\n        private List<object> BuildTemplateComponents(\n            TemplateMetadataDto template,\n            List<string> paramsList,\n            string? imageUrl,\n            List<CampaignButton>? buttons)\n        {\n            var components = new List<object>();\n\n            if (template.HasImageHeader && !string.IsNullOrWhiteSpace(imageUrl))\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new[] { new { type = \"image\", image = new { link = imageUrl } } }\n                });\n            }\n\n            if (paramsList.Any())\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = paramsList.Select(p => new { type = \"text\", text = p }).ToList()\n                });\n            }\n\n            if (buttons != null && buttons.Any())\n            {\n                for (int i = 0; i < buttons.Count; i++)\n                {\n                    var btn = buttons[i];\n                    components.Add(new\n                    {\n                        type = \"button\",\n                        sub_type = btn.Type?.ToLower() == \"url\" ? \"url\" : \"quick_reply\",\n                        index = i.ToString(),\n                        parameters = new[] {\n                            new {\n                                type = \"text\",\n                                text = btn.Value ?? btn.Title\n                            }\n                        }\n                    });\n                }\n            }\n\n            return components;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Validators/ValidateMessageDtoAttribute.cs",
      "sha256": "9b7355295c8cecdf6c4416a324d05f0910b3ff67e99fd35e04e397f715096a9b",
      "language": "csharp",
      "size": 1760,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.DTOs.Validation\n{\n    [AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]\n    public class ValidateMessageDtoAttribute : ValidationAttribute\n    {\n        protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)\n        {\n            if (value is not SendMessageDto dto)\n                return ValidationResult.Success;\n\n            switch (dto.MessageType)\n            {\n                case MessageTypeEnum.Text:\n                    if (string.IsNullOrWhiteSpace(dto.TextContent))\n                        return new ValidationResult(\"TextContent is required for text messages.\", new[] { nameof(dto.TextContent) });\n                    break;\n\n                case MessageTypeEnum.Image:\n                    if (string.IsNullOrWhiteSpace(dto.MediaUrl))\n                        return new ValidationResult(\"MediaUrl is required for image messages.\", new[] { nameof(dto.MediaUrl) });\n                    break;\n\n                case MessageTypeEnum.Template:\n                    if (string.IsNullOrWhiteSpace(dto.TemplateName))\n                        return new ValidationResult(\"TemplateName is required for template messages.\", new[] { nameof(dto.TemplateName) });\n                    break;\n\n                case MessageTypeEnum.Cta:\n                    if (dto.CtaButtons == null || dto.CtaButtons.Count == 0)\n                        return new ValidationResult(\"CtaButtons is required for CTA messages.\", new[] { nameof(dto.CtaButtons) });\n                    break;\n            }\n\n            return ValidationResult.Success;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Controllers/AdminCouponController.cs",
      "sha256": "a7250e3bdf4896eec0bce059b867b23414630af93fb4a0bc64be94aeab683195",
      "language": "csharp",
      "size": 3449,
      "content": "#nullable enable\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\n\nnamespace xbytechat.api.Features.Payment.Controllers\n{\n    /// <summary>\n    /// Minimal admin-only APIs to manage coupons.\n    /// Protect via role/policy in your auth setup.\n    /// </summary>\n    [ApiController]\n    [Route(\"api/admin/payment/coupons\")]\n    [Authorize(Roles = \"SuperAdmin\")] // adjust to your actual role system\n    public sealed class AdminCouponController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n\n        public AdminCouponController(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAll(CancellationToken ct)\n        {\n            var items = await _db.Coupons\n                .OrderByDescending(c => c.ValidFromUtc ?? DateTime.MinValue)\n                .ToListAsync(ct);\n\n            return Ok(new { ok = true, data = items });\n        }\n\n        public sealed class UpsertCouponRequest\n        {\n            public string Code { get; set; } = string.Empty;\n            public string? Description { get; set; }\n            public DiscountType DiscountType { get; set; }\n            public decimal DiscountValue { get; set; }\n            public DateTime? ValidFromUtc { get; set; }\n            public DateTime? ValidToUtc { get; set; }\n            public bool IsActive { get; set; } = true;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> Create([FromBody] UpsertCouponRequest req, CancellationToken ct)\n        {\n            if (string.IsNullOrWhiteSpace(req.Code))\n                return BadRequest(new { ok = false, message = \"Code is required.\" });\n\n            var exists = await _db.Coupons.AnyAsync(c => c.Code == req.Code, ct);\n            if (exists)\n                return Conflict(new { ok = false, message = \"Coupon code already exists.\" });\n\n            var coupon = new Coupon\n            {\n                Id = Guid.NewGuid(),\n                Code = req.Code,\n                Description = req.Description,\n                DiscountType = req.DiscountType,\n                DiscountValue = req.DiscountValue,\n                ValidFromUtc = req.ValidFromUtc,\n                ValidToUtc = req.ValidToUtc,\n                IsActive = req.IsActive\n            };\n\n            _db.Coupons.Add(coupon);\n            await _db.SaveChangesAsync(ct);\n\n            return Ok(new { ok = true, data = coupon });\n        }\n\n        [HttpPut(\"{id:guid}\")]\n        public async Task<IActionResult> Update(Guid id, [FromBody] UpsertCouponRequest req, CancellationToken ct)\n        {\n            var coupon = await _db.Coupons.FirstOrDefaultAsync(c => c.Id == id, ct);\n            if (coupon is null)\n                return NotFound(new { ok = false, message = \"Coupon not found.\" });\n\n            coupon.Description = req.Description;\n            coupon.DiscountType = req.DiscountType;\n            coupon.DiscountValue = req.DiscountValue;\n            coupon.ValidFromUtc = req.ValidFromUtc;\n            coupon.ValidToUtc = req.ValidToUtc;\n            coupon.IsActive = req.IsActive;\n\n            await _db.SaveChangesAsync(ct);\n\n            return Ok(new { ok = true, data = coupon });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Controllers/AdminPaymentMaintenanceController.cs",
      "sha256": "c9aaa1660f210e61a4e34834ffeea027655539cc02ce774b08f977728521cb15",
      "language": "csharp",
      "size": 1197,
      "content": "#nullable enable\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.Payment.Services;\n\nnamespace xbytechat.api.Features.Payment.Controllers\n{\n    /// <summary>\n    /// Admin-only endpoints for running payment/subscription maintenance tasks.\n    /// In production, prefer a scheduled job instead of manual calling.\n    /// </summary>\n    [ApiController]\n    [Route(\"api/admin/payment/maintenance\")]\n    [Authorize(Roles = \"SuperAdmin\")] // adjust to your actual admin role\n    public sealed class AdminPaymentMaintenanceController : ControllerBase\n    {\n        private readonly SubscriptionLifecycleService _lifecycle;\n\n        public AdminPaymentMaintenanceController(SubscriptionLifecycleService lifecycle)\n        {\n            _lifecycle = lifecycle;\n        }\n\n        /// <summary>\n        /// Runs subscription lifecycle sync manually.\n        /// </summary>\n        [HttpPost(\"run-lifecycle\")]\n        public async Task<IActionResult> RunLifecycle(CancellationToken ct)\n        {\n            await _lifecycle.RunAsync(ct);\n            return Ok(new { ok = true });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Controllers/PaymentController.cs",
      "sha256": "23dfec21d19333100bc4131f346e12e04cc1afed552b2909c199d79444029a98",
      "language": "csharp",
      "size": 7219,
      "content": "#nullable enable\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Services;\nusing xbytechat.api.Shared; // assuming User.GetBusinessId() lives here or similar\n\nnamespace xbytechat.api.Features.Payment.Controllers\n{\n    [ApiController]\n    [Route(\"api/payment\")]\n    [Authorize] // must be authenticated\n    public sealed class PaymentController : ControllerBase\n    {\n        private readonly ISubscriptionService _subscriptions;\n        private readonly IInvoiceService _invoices;\n        private readonly ICouponService _coupons;\n        private readonly IPaymentGatewayService _gateway;\n        private readonly ISubscriptionCheckoutService _checkout;\n        private readonly PaymentOverviewService _overview;\n        public PaymentController(\n            ISubscriptionService subscriptions,\n            IInvoiceService invoices,\n            ICouponService coupons,\n            IPaymentGatewayService gateway,\n            ISubscriptionCheckoutService checkout,\n            PaymentOverviewService overview)\n        {\n            _subscriptions = subscriptions;\n            _invoices = invoices;\n            _coupons = coupons;\n            _gateway = gateway;\n            _checkout = checkout;\n            _overview = overview;\n        }\n\n        /// <summary>\n        /// Returns the current subscription for the logged-in business.\n        /// </summary>\n        [HttpGet(\"subscription\")]\n        public async Task<IActionResult> GetCurrentSubscription(CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId(); // your existing extension\n            var sub = await _subscriptions.GetCurrentForBusinessAsync(businessId, ct);\n            return Ok(new { ok = true, data = sub });\n        }\n\n        /// <summary>\n        /// Creates or updates subscription for the logged-in business.\n        /// NOTE:\n        /// - For MVP this directly activates.\n        /// - Later, call only after payment confirmation.\n        /// </summary>\n        [HttpPost(\"subscription\")]\n        public async Task<IActionResult> CreateOrUpdateSubscription(\n            [FromBody] CreateSubscriptionRequestDto request,\n            CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var sub = await _subscriptions.CreateOrUpdateSubscriptionAsync(businessId, request, ct);\n            return Ok(new { ok = true, data = sub });\n        }\n\n        /// <summary>\n        /// Marks the current subscription to cancel at period end.\n        /// </summary>\n        [HttpPost(\"subscription/cancel-at-period-end\")]\n        public async Task<IActionResult> CancelAtPeriodEnd(CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var ok = await _subscriptions.MarkCancelAtPeriodEndAsync(businessId, ct);\n            return Ok(new { ok });\n        }\n\n        /// <summary>\n        /// Reactivates auto-renew for the current subscription.\n        /// </summary>\n        [HttpPost(\"subscription/reactivate\")]\n        public async Task<IActionResult> Reactivate(CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var ok = await _subscriptions.ReactivateAutoRenewAsync(businessId, ct);\n            return Ok(new { ok });\n        }\n\n        /// <summary>\n        /// Returns all invoices for the logged-in business.\n        /// </summary>\n        [HttpGet(\"invoices\")]\n        public async Task<IActionResult> GetInvoices(CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var items = await _invoices.GetInvoicesForBusinessAsync(businessId, ct);\n            return Ok(new { ok = true, data = items });\n        }\n\n        /// <summary>\n        /// Returns a specific invoice.\n        /// </summary>\n        [HttpGet(\"invoices/{invoiceId:guid}\")]\n        public async Task<IActionResult> GetInvoice(Guid invoiceId, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var invoice = await _invoices.GetInvoiceAsync(businessId, invoiceId, ct);\n            if (invoice is null)\n                return NotFound(new { ok = false, message = \"Invoice not found.\" });\n\n            return Ok(new { ok = true, data = invoice });\n        }\n\n        /// <summary>\n        /// Validates a coupon code for the current context (e.g. before checkout).\n        /// </summary>\n        [HttpGet(\"coupon/validate\")]\n        public async Task<IActionResult> ValidateCoupon(\n            [FromQuery] string code,\n            [FromQuery] string currency = \"INR\",\n            CancellationToken ct = default)\n        {\n            var coupon = await _coupons.ValidateCouponAsync(code, currency, ct);\n            if (coupon is null)\n                return Ok(new { ok = false, message = \"Invalid or expired coupon.\" });\n\n            return Ok(new { ok = true, data = coupon });\n        }\n\n        /// <summary>\n        /// Creates a payment session for the given invoice and returns redirect info.\n        /// Frontend should call this before opening Razorpay checkout.\n        /// </summary>\n        [HttpPost(\"invoices/{invoiceId:guid}/checkout\")]\n        public async Task<IActionResult> CreateCheckoutForInvoice(\n            Guid invoiceId,\n            [FromBody] CreatePaymentSessionRequestDto body,\n            CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n\n            if (body.InvoiceId.HasValue && body.InvoiceId.Value != invoiceId)\n            {\n                return BadRequest(new { ok = false, message = \"Invoice id mismatch.\" });\n            }\n\n            var session = await _gateway.CreatePaymentSessionForInvoiceAsync(\n                businessId,\n                invoiceId,\n                body.CouponCode,\n                ct);\n\n            return Ok(new { ok = true, data = session });\n        }\n        /// <summary>\n        /// Starts subscription checkout for a selected plan:\n        /// - Creates invoice with coupon+GST\n        /// - Creates Razorpay order\n        /// - Returns session/redirect info for frontend.\n        /// </summary>\n        [HttpPost(\"subscribe/checkout\")]\n        public async Task<IActionResult> StartSubscriptionCheckout(\n            [FromBody] CreateSubscriptionRequestDto request,\n            CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n\n            var session = await _checkout.StartSubscriptionCheckoutAsync(\n                businessId,\n                request,\n                ct);\n\n            return Ok(new { ok = true, data = session });\n        }\n        /// <summary>\n        /// Returns a compact payment overview for the logged-in business.\n        /// Intended for Billing page + Account Insights integration.\n        /// </summary>\n        [HttpGet(\"overview\")]\n        public async Task<IActionResult> GetOverview(CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            var data = await _overview.GetAsync(businessId, ct);\n            return Ok(new { ok = true, data });\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Controllers/PaymentWebhookController.cs",
      "sha256": "9e6af3395a6e0c4478a6573d677c7bc86b012c5d544459cf7b73eba9f43ae88f",
      "language": "csharp",
      "size": 6922,
      "content": "#nullable enable\nusing System;\nusing System.IO;\nusing System.Security.Cryptography;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.Payment.Options;\nusing xbytechat.api.Features.Payment.Services;\n\nnamespace xbytechat.api.Features.Payment.Controllers\n{\n    [ApiController]\n    [Route(\"api/payment/webhook/razorpay\")]\n    public sealed class PaymentWebhookController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly RazorpayOptions _opts;\n        private readonly ISubscriptionService _subscriptions;\n\n        public PaymentWebhookController(\n            AppDbContext db,\n            IOptions<RazorpayOptions> opts,\n            ISubscriptionService subscriptions)\n        {\n            _db = db;\n            _opts = opts.Value;\n            _subscriptions = subscriptions;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> Handle(CancellationToken ct)\n        {\n            // 1. Read body\n            string body;\n            using (var reader = new StreamReader(Request.Body, Encoding.UTF8))\n            {\n                body = await reader.ReadToEndAsync(ct);\n            }\n\n            // 2. Verify signature\n            var signature = Request.Headers[\"X-Razorpay-Signature\"].ToString();\n            if (!VerifySignature(body, signature, _opts.WebhookSecret))\n            {\n                return Unauthorized();\n            }\n\n            // 3. Parse minimal fields\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            // Webhook schema differs by event; we read what we need:\n            // payment.captured / payment.failed etc.\n            var eventType = root.GetProperty(\"event\").GetString();\n\n            if (string.IsNullOrWhiteSpace(eventType))\n                return Ok(); // ignore unknown\n\n            if (eventType.StartsWith(\"payment.\"))\n            {\n                var payload = root.GetProperty(\"payload\").GetProperty(\"payment\").GetProperty(\"entity\");\n                var paymentId = payload.GetProperty(\"id\").GetString();\n                var orderId = payload.TryGetProperty(\"order_id\", out var oidEl) ? oidEl.GetString() : null;\n                var status = payload.GetProperty(\"status\").GetString();\n\n                if (!string.IsNullOrWhiteSpace(orderId))\n                {\n                    var tx = await _db.PaymentTransactions\n                        .FirstOrDefaultAsync(t => t.GatewayOrderId == orderId, ct);\n\n                    if (tx != null)\n                    {\n                        await ApplyPaymentStatusAsync(tx, paymentId, status, ct);\n                    }\n                }\n            }\n\n            // You may also handle order.paid events similarly.\n\n            return Ok();\n        }\n\n        private static bool VerifySignature(string body, string signature, string secret)\n        {\n            if (string.IsNullOrWhiteSpace(signature) || string.IsNullOrWhiteSpace(secret))\n                return false;\n\n            var keyBytes = Encoding.UTF8.GetBytes(secret);\n            var bodyBytes = Encoding.UTF8.GetBytes(body);\n\n            using var hmac = new HMACSHA256(keyBytes);\n            var hash = hmac.ComputeHash(bodyBytes);\n            var generated = BitConverter.ToString(hash).Replace(\"-\", \"\").ToLowerInvariant();\n\n            return string.Equals(generated, signature, StringComparison.OrdinalIgnoreCase);\n        }\n\n        private async Task ApplyPaymentStatusAsync(\n            PaymentTransaction tx,\n            string? paymentId,\n            string? paymentStatus,\n            CancellationToken ct)\n        {\n            // Normalize\n            paymentStatus = paymentStatus?.ToLowerInvariant();\n\n            if (paymentStatus == \"captured\" || paymentStatus == \"authorized\" || paymentStatus == \"paid\")\n            {\n                // ---- SUCCESS ----\n                tx.Status = PaymentStatus.Success;\n                tx.GatewayPaymentId = paymentId;\n                tx.CompletedAtUtc = DateTime.UtcNow;\n\n                var invoice = await _db.Invoices\n                    .Include(i => i.Plan)\n                    .FirstOrDefaultAsync(i => i.Id == tx.InvoiceId, ct);\n\n                if (invoice != null)\n                {\n                    invoice.Status = InvoiceStatus.Paid;\n                    invoice.PaidAtUtc = DateTime.UtcNow;\n                }\n\n                // If this invoice is for a subscription (has PlanId + BillingCycle),\n                // we activate/update subscription via SubscriptionService.\n                if (invoice?.PlanId != null && invoice.BillingCycle != null)\n                {\n                    await _subscriptions.CreateOrUpdateSubscriptionAsync(\n                        tx.BusinessId,\n                        new DTOs.CreateSubscriptionRequestDto\n                        {\n                            PlanId = invoice.PlanId.Value,\n                            BillingCycle = invoice.BillingCycle.Value,\n                            // Coupon already baked into invoice; no need to send here.\n                            CouponCode = null\n                        },\n                        ct);\n                }\n            }\n            else if (paymentStatus == \"failed\")\n            {\n                // ---- FAILURE ----\n                tx.Status = PaymentStatus.Failed;\n                tx.GatewayPaymentId = paymentId;\n                tx.CompletedAtUtc = DateTime.UtcNow;\n\n                var invoice = await _db.Invoices\n                    .FirstOrDefaultAsync(i => i.Id == tx.InvoiceId, ct);\n\n                if (invoice != null)\n                {\n                    // Keep invoice open for retry / dunning if it was draft.\n                    if (invoice.Status == InvoiceStatus.Draft)\n                    {\n                        invoice.Status = InvoiceStatus.Open;\n                    }\n\n                    // If this was a renewal / subscription-linked invoice,\n                    // mark subscription as PastDue so AccessGuard can block.\n                    if (invoice.SubscriptionId != null)\n                    {\n                        var sub = await _db.Subscriptions\n                            .FirstOrDefaultAsync(s => s.Id == invoice.SubscriptionId.Value, ct);\n\n                        if (sub != null &&\n                            (sub.Status == SubscriptionStatus.Active ||\n                             sub.Status == SubscriptionStatus.Grace))\n                        {\n                            sub.Status = SubscriptionStatus.PastDue;\n                        }\n                    }\n                }\n            }\n\n            await _db.SaveChangesAsync(ct);\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/CouponDto.cs",
      "sha256": "41bbaafa2e7c60f2756dc4bf42958e2a72e070a171b411b7f9d313534cd3e94f",
      "language": "csharp",
      "size": 562,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    public class CouponDto\n    {\n        public Guid Id { get; set; }\n        public string Code { get; set; } = string.Empty;\n        public string? Description { get; set; }\n\n        public DiscountType DiscountType { get; set; }\n        public decimal DiscountValue { get; set; }\n\n        public bool IsActive { get; set; }\n        public DateTime? ValidFromUtc { get; set; }\n        public DateTime? ValidToUtc { get; set; }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/CreatePaymentSessionRequestDto.cs",
      "sha256": "9455eaa06f4ae1ebbc9df4bde78baa270d1261b9314f5e4227ea6162563180b8",
      "language": "csharp",
      "size": 836,
      "content": "#nullable enable\nusing System;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    /// <summary>\n    /// Request to start a payment for a subscription or invoice.\n    /// Maps to a gateway checkout / payment link.\n    /// </summary>\n    public class CreatePaymentSessionRequestDto\n    {\n        /// <summary>\n        /// Optional: target subscription change (upgrade/downgrade/renewal).\n        /// </summary>\n        public Guid? SubscriptionId { get; set; }\n\n        /// <summary>\n        /// Optional: invoice to pay. If null, backend can construct\n        /// a new invoice based on plan selection.\n        /// </summary>\n        public Guid? InvoiceId { get; set; }\n\n        /// <summary>\n        /// Optional coupon code to apply at time of payment.\n        /// </summary>\n        public string? CouponCode { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/CreateSubscriptionRequestDto.cs",
      "sha256": "a6fa013d724c01c7ceb8a165e931c3722e74e4637072483a2ede13ccf46530ba",
      "language": "csharp",
      "size": 807,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    /// <summary>\n    /// Request to start or change a subscription for the current business.\n    /// Payment authorization will be handled via a separate payment flow.\n    /// </summary>\n    public class CreateSubscriptionRequestDto\n    {\n        /// <summary>\n        /// Target plan to subscribe to.\n        /// </summary>\n        public Guid PlanId { get; set; }\n\n        /// <summary>\n        /// Selected billing cycle (Monthly / Yearly).\n        /// </summary>\n        public BillingCycle BillingCycle { get; set; }\n\n        /// <summary>\n        /// Optional coupon code the user wants to apply.\n        /// </summary>\n        public string? CouponCode { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/InvoiceDto.cs",
      "sha256": "9f69933f3b4e85863294c4806e684a8bc1b513c1ba62cb13a3920eaad9c95f95",
      "language": "csharp",
      "size": 983,
      "content": "#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    public class InvoiceDto\n    {\n        public Guid Id { get; set; }\n        public string InvoiceNumber { get; set; } = string.Empty;\n\n        public Guid BusinessId { get; set; }\n        public Guid? SubscriptionId { get; set; }\n\n        public InvoiceStatus Status { get; set; }\n\n        public decimal SubtotalAmount { get; set; }\n        public decimal DiscountAmount { get; set; }\n        public decimal TaxAmount { get; set; }\n        public decimal TotalAmount { get; set; }\n\n        public string Currency { get; set; } = \"INR\";\n        public string? AppliedCouponCode { get; set; }\n\n        public DateTime IssuedAtUtc { get; set; }\n        public DateTime? DueAtUtc { get; set; }\n        public DateTime? PaidAtUtc { get; set; }\n\n        public List<InvoiceLineItemDto> LineItems { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/InvoiceLineItemDto.cs",
      "sha256": "903f7a64b848f9c8d215a83e90a855a76e27818c57c23ecabb47c9eeb1203668",
      "language": "csharp",
      "size": 371,
      "content": "#nullable enable\nusing System;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    public class InvoiceLineItemDto\n    {\n        public Guid Id { get; set; }\n        public string Description { get; set; } = string.Empty;\n        public decimal Quantity { get; set; }\n        public decimal UnitPrice { get; set; }\n        public decimal LineTotal { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/PaymentOverviewDto.cs",
      "sha256": "dabb719741973867fa712fad3ea28e7ef6a4aeee44d2b8950671fee9cadce0df",
      "language": "csharp",
      "size": 648,
      "content": "#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    public sealed class PaymentOverviewDto\n    {\n        public SubscriptionDto? CurrentSubscription { get; set; }\n\n        public decimal? LastInvoiceAmount { get; set; }\n        public DateTime? LastInvoicePaidAtUtc { get; set; }\n\n        public decimal? NextInvoiceEstimatedAmount { get; set; }\n        public DateTime? CurrentPeriodEndUtc { get; set; }\n\n        public bool CanUseCoreFeatures { get; set; }\n\n        public List<InvoiceDto> RecentInvoices { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/PaymentSessionResponseDto.cs",
      "sha256": "7a5d87a6170743bc39d51094df42be0d45c03ed96fd09015a3c52f073bea6177",
      "language": "csharp",
      "size": 656,
      "content": "#nullable enable\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    /// <summary>\n    /// Response containing info needed by the frontend to redirect the user\n    /// to the payment gateway (hosted page, popup, etc.).\n    /// </summary>\n    public class PaymentSessionResponseDto\n    {\n        /// <summary>\n        /// Internal id for tracking this session/intent.\n        /// </summary>\n        public string SessionId { get; set; } = string.Empty;\n\n        /// <summary>\n        /// URL to redirect the user to (Razorpay Checkout, Stripe Checkout, etc.).\n        /// </summary>\n        public string RedirectUrl { get; set; } = string.Empty;\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/PaymentTransactionDto.cs",
      "sha256": "89a71e90b7c469709d0ef2a6f79dd885fc8a74021c427949cd88476f1449f5f6",
      "language": "csharp",
      "size": 828,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    public class PaymentTransactionDto\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid? SubscriptionId { get; set; }\n        public Guid? InvoiceId { get; set; }\n\n        public decimal Amount { get; set; }\n        public string Currency { get; set; } = \"INR\";\n\n        public PaymentStatus Status { get; set; }\n        public string Gateway { get; set; } = string.Empty;\n        public string? GatewayPaymentId { get; set; }\n        public string? GatewayOrderId { get; set; }\n\n        public string? FailureReason { get; set; }\n        public DateTime CreatedAtUtc { get; set; }\n        public DateTime? CompletedAtUtc { get; set; }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/DTOs/SubscriptionDto.cs",
      "sha256": "436fc732e13a70d4003832129b9324c5f880ed8876f3f97e1af5426cd9a553b1",
      "language": "csharp",
      "size": 951,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.DTOs\n{\n    /// <summary>\n    /// Read model for exposing subscription info to UI / API.\n    /// </summary>\n    public class SubscriptionDto\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid PlanId { get; set; }\n\n        public string PlanName { get; set; } = string.Empty;\n        public SubscriptionStatus Status { get; set; }\n        public BillingCycle BillingCycle { get; set; }\n\n        public DateTime CurrentPeriodStartUtc { get; set; }\n        public DateTime CurrentPeriodEndUtc { get; set; }\n        public DateTime? TrialEndsAtUtc { get; set; }\n\n        public bool AutoRenew { get; set; }\n        public bool CancelAtPeriodEnd { get; set; }\n\n        public string? GatewayCustomerId { get; set; }\n        public string? GatewaySubscriptionId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Enums/BillingCycle.cs",
      "sha256": "9cb8996565e691a52d0699158ee47db0492cd78d7cde8f8cdd369e9658afa428",
      "language": "csharp",
      "size": 268,
      "content": "namespace xbytechat.api.Features.Payment.Enums\n{\n    /// <summary>\n    /// How often a subscription renews.\n    /// </summary>\n    public enum BillingCycle\n    {\n        Monthly = 1,\n        Yearly = 2\n        // Add Quarterly or other cycles later if needed.\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Enums/DiscountType.cs",
      "sha256": "567a3ce46956929d0715e847858ef74a1c7f10788dcfaba8c5dc450127da8991",
      "language": "csharp",
      "size": 415,
      "content": "namespace xbytechat.api.Features.Payment.Enums\n{\n    /// <summary>\n    /// Defines how a discount value should be applied.\n    /// </summary>\n    public enum DiscountType\n    {\n        /// <summary>\n        /// Fixed amount off (e.g. ‚Çπ500 off).\n        /// </summary>\n        FixedAmount = 1,\n\n        /// <summary>\n        /// Percentage off (e.g. 20% off).\n        /// </summary>\n        Percentage = 2\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Enums/InvoiceStatus.cs",
      "sha256": "74e0b1ffe3e333aa1c9937858e5c3f004e1b473df0fda25363636e6134afce89",
      "language": "csharp",
      "size": 256,
      "content": "namespace xbytechat.api.Features.Payment.Enums\n{\n    /// <summary>\n    /// State of an invoice in the billing lifecycle.\n    /// </summary>\n    public enum InvoiceStatus\n    {\n        Draft = 0,\n        Open = 1,\n        Paid = 2,\n        Void = 3\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Enums/PaymentStatus.cs",
      "sha256": "7655e3b36f220768e7ebee978d19075ef1481a80511d6f14a01ae6a7bdc10acc",
      "language": "csharp",
      "size": 815,
      "content": "namespace xbytechat.api.Features.Payment.Enums\n{\n    /// <summary>\n    /// Status of a single payment transaction with a gateway.\n    /// </summary>\n    public enum PaymentStatus\n    {\n        /// <summary>\n        /// Initiated but not confirmed yet (checkout created, awaiting gateway result).\n        /// </summary>\n        Pending = 0,\n\n        /// <summary>\n        /// Successfully captured/confirmed by the gateway.\n        /// </summary>\n        Success = 1,\n\n        /// <summary>\n        /// Failed/declined; no funds captured.\n        /// </summary>\n        Failed = 2,\n\n        /// <summary>\n        /// Refunded (partial or full).\n        /// </summary>\n        Refunded = 3,\n\n        /// <summary>\n        /// Chargeback/dispute or manual reversal.\n        /// </summary>\n        Reversed = 4\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Enums/SubscriptionStatus.cs",
      "sha256": "cce65de55c8f3cc221dead81b2dae70a372d248393d2095257ebd12ecee41d74",
      "language": "csharp",
      "size": 1312,
      "content": "namespace xbytechat.api.Features.Payment.Enums\n{\n    /// <summary>\n    /// Represents the lifecycle state of a business account's subscription.\n    /// This will drive access control and account insights.\n    /// </summary>\n    public enum SubscriptionStatus\n    {\n        /// <summary>\n        /// Newly created trial, within the active trial window.\n        /// </summary>\n        Trial = 0,\n\n        /// <summary>\n        /// Active and fully paid. All subscribed features are enabled.\n        /// </summary>\n        Active = 1,\n\n        /// <summary>\n        /// Payment failed or not received; retry / dunning in progress.\n        /// </summary>\n        PastDue = 2,\n\n        /// <summary>\n        /// In grace window before hard suspension.\n        /// </summary>\n        Grace = 3,\n\n        /// <summary>\n        /// Marked to cancel at the end of the current billing period.\n        /// </summary>\n        CancelAtPeriodEnd = 4,\n\n        /// <summary>\n        /// Fully cancelled with no future renewals.\n        /// </summary>\n        Cancelled = 5,\n\n        /// <summary>\n        /// Access blocked due to non-payment / policy violation.\n        /// </summary>\n        Suspended = 6,\n\n        /// <summary>\n        /// Trial ended without activation.\n        /// </summary>\n        Expired = 7\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Filters/RequireActiveSubscriptionAttribute.cs",
      "sha256": "d47615d45bb8244c929876afa5c4fa1bcae07a84a306c22a99231ca705825d3e",
      "language": "csharp",
      "size": 2129,
      "content": "#nullable enable\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing xbytechat.api.Features.Payment.Services;\nusing xbytechat.api.Shared; // for User.GetBusinessId()\n\nnamespace xbytechat.api.Features.Payment.Filters\n{\n    /// <summary>\n    /// Use [RequireActiveSubscription] on controllers/actions that should be accessible\n    /// only when the business has an allowed subscription state.\n    /// \n    /// Logic is delegated to IAccessGuard so rules stay centralized.\n    /// </summary>\n    public sealed class RequireActiveSubscriptionAttribute : TypeFilterAttribute\n    {\n        public RequireActiveSubscriptionAttribute()\n            : base(typeof(RequireActiveSubscriptionFilter))\n        {\n        }\n\n        private sealed class RequireActiveSubscriptionFilter : IAsyncActionFilter\n        {\n            private readonly IAccessGuard _accessGuard;\n\n            public RequireActiveSubscriptionFilter(IAccessGuard accessGuard)\n            {\n                _accessGuard = accessGuard;\n            }\n\n            public async Task OnActionExecutionAsync(\n     ActionExecutingContext context,\n     ActionExecutionDelegate next)\n            {\n                var user = context.HttpContext.User;\n\n                // Let [Authorize] handle unauthenticated cases.\n                if (user?.Identity is null || !user.Identity.IsAuthenticated)\n                {\n                    await next();\n                    return;\n                }\n\n                var businessId = user.GetBusinessId();\n\n                var result = await _accessGuard.CheckAsync(businessId);\n\n                if (!result.Allowed)\n                {\n                    context.Result = new ObjectResult(new\n                    {\n                        ok = false,\n                        status = result.Status?.ToString(),\n                        message = result.Message\n                    })\n                    {\n                        StatusCode = 403\n                    };\n\n                    return;\n                }\n\n                await next();\n            }\n\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Models/Coupon.cs",
      "sha256": "49fd7b2d4f6b5ca068b32f6cf499b9eb2c0b35936b119bcc6763c81108a8640c",
      "language": "csharp",
      "size": 2301,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.Models\n{\n    /// <summary>\n    /// Represents a promotional coupon that can apply discounts\n    /// on subscriptions or invoices (like big players do).\n    /// </summary>\n    public class Coupon\n    {\n        public Guid Id { get; set; }\n\n        /// <summary>\n        /// Unique code entered by the user, e.g. \"LAUNCH20\".\n        /// </summary>\n        public string Code { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Human-friendly description for admins.\n        /// </summary>\n        public string? Description { get; set; }\n\n        /// <summary>\n        /// How the discount is calculated (fixed / percentage).\n        /// </summary>\n        public DiscountType DiscountType { get; set; }\n\n        /// <summary>\n        /// Discount value:\n        /// - If Percentage: 10 = 10%\n        /// - If FixedAmount: absolute amount in invoice currency (e.g. 500 = ‚Çπ500).\n        /// </summary>\n        public decimal DiscountValue { get; set; }\n\n        /// <summary>\n        /// Optional: limit total number of times the coupon can be used globally.\n        /// Null = unlimited.\n        /// </summary>\n        public int? MaxRedemptions { get; set; }\n\n        /// <summary>\n        /// Optional: limit per business usage count.\n        /// Null = no per-business cap.\n        /// </summary>\n        public int? MaxRedemptionsPerBusiness { get; set; }\n\n        /// <summary>\n        /// Optional: apply only to a specific plan.\n        /// Null = can apply to any eligible plan.\n        /// </summary>\n        public Guid? PlanId { get; set; }\n\n        /// <summary>\n        /// Start time of coupon validity (UTC).\n        /// </summary>\n        public DateTime? ValidFromUtc { get; set; }\n\n        /// <summary>\n        /// End time of coupon validity (UTC).\n        /// </summary>\n        public DateTime? ValidToUtc { get; set; }\n\n        /// <summary>\n        /// Whether this coupon is currently active (admin toggle).\n        /// </summary>\n        public bool IsActive { get; set; } = true;\n\n        /// <summary>\n        /// Optional metadata or rules (JSON) for future logic.\n        /// </summary>\n        public string? MetaJson { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Models/Invoice.cs",
      "sha256": "dad830cfae5ab10bc3d1cdac0dfcbeb4b0b5c1124bb064985edf72679a3f9eac",
      "language": "csharp",
      "size": 3293,
      "content": "#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.Payment.Models\n{\n    /// <summary>\n    /// Represents a bill issued to a business for a period, plan, or usage.\n    /// Can be mapped to one or more payment transactions.\n    /// </summary>\n    public class Invoice\n    {\n        public Guid Id { get; set; }\n\n        /// <summary>\n        /// Business this invoice belongs to.\n        /// </summary>\n        public Guid BusinessId { get; set; }\n\n        /// <summary>\n        /// Optional related subscription for recurring charges.\n        /// </summary>\n        public Guid? SubscriptionId { get; set; }\n\n        /// <summary>\n        /// Human-readable invoice number (e.g. \"XP-2025-000123\").\n        /// </summary>\n        public string InvoiceNumber { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Current status of the invoice (Draft/Open/Paid/Void).\n        /// </summary>\n        public InvoiceStatus Status { get; set; }\n\n        /// <summary>\n        /// Total before tax.\n        /// </summary>\n        public decimal SubtotalAmount { get; set; }\n\n        /// <summary>\n        /// Total tax amount (GST/VAT etc.) if applicable.\n        /// </summary>\n        public decimal TaxAmount { get; set; }\n\n        /// <summary>\n        /// Grand total (Subtotal + Tax - Discounts).\n        /// </summary>\n        public decimal TotalAmount { get; set; }\n\n        /// <summary>\n        /// ISO currency code, e.g. \"INR\".\n        /// </summary>\n        public string Currency { get; set; } = \"INR\";\n\n        /// <summary>\n        /// When invoice was issued (UTC).\n        /// </summary>\n        public DateTime IssuedAtUtc { get; set; }\n\n        /// <summary>\n        /// When payment is due (UTC).\n        /// </summary>\n        public DateTime? DueAtUtc { get; set; }\n\n        /// <summary>\n        /// When invoice was fully paid (UTC).\n        /// </summary>\n        public DateTime? PaidAtUtc { get; set; }\n\n        /// <summary>\n        /// Optional free-form notes (e.g., terms, adjustments).\n        /// </summary>\n        public string? Notes { get; set; }\n\n        public string? AppliedCouponCode { get; set; }\n\n        /// <summary>\n        /// Total discount amount applied on this invoice (>= 0).\n        /// </summary>\n        public decimal DiscountAmount { get; set; }\n\n        public string? TaxBreakdownJson { get; set; }\n\n\n        /// <summary>\n        /// Optional: plan this invoice refers to (for subscription charges).\n        /// </summary>\n        public Guid? PlanId { get; set; }\n\n        /// <summary>\n        /// Optional: billing cycle for this invoice's subscription charge.\n        /// </summary>\n        public BillingCycle? BillingCycle { get; set; }\n        // ---- Navigation ----\n\n        public Business? Business { get; set; }\n        public Subscription? Subscription { get; set; }\n\n        public ICollection<InvoiceLineItem> LineItems { get; set; } = new List<InvoiceLineItem>();\n        public ICollection<PaymentTransaction> Payments { get; set; } = new List<PaymentTransaction>();\n\n        public Plan? Plan { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Models/InvoiceLineItem.cs",
      "sha256": "7a577bfd7803d7492400518e9efb53c110d0128b947e2fa14c66cf780bb4fa6d",
      "language": "csharp",
      "size": 1364,
      "content": "#nullable enable\nusing System;\n\nnamespace xbytechat.api.Features.Payment.Models\n{\n    /// <summary>\n    /// Represents a single line item on an invoice\n    /// (plan fee, add-on, usage charge, discount as negative, etc.).\n    /// </summary>\n    public class InvoiceLineItem\n    {\n        public Guid Id { get; set; }\n\n        /// <summary>\n        /// Parent invoice.\n        /// </summary>\n        public Guid InvoiceId { get; set; }\n\n        /// <summary>\n        /// Short description shown on the invoice.\n        /// e.g. \"Pro Plan - Monthly\", \"WhatsApp Usage - Jan 2025\"\n        /// </summary>\n        public string Description { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Logical quantity (months, message blocks, add-ons).\n        /// </summary>\n        public decimal Quantity { get; set; } = 1m;\n\n        /// <summary>\n        /// Price per unit (before tax).\n        /// </summary>\n        public decimal UnitPrice { get; set; }\n\n        /// <summary>\n        /// Computed total for this line (Quantity * UnitPrice).\n        /// </summary>\n        public decimal LineTotal { get; set; }\n\n        /// <summary>\n        /// Optional metadata (JSON) for internal reconciliation.\n        /// </summary>\n        public string? MetaJson { get; set; }\n\n        // ---- Navigation ----\n\n        public Invoice? Invoice { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Models/PaymentTransaction.cs",
      "sha256": "f8cc2aed683bd8ea7a9c9221d67d87057ad649df9daae02e7373146611ad9f9f",
      "language": "csharp",
      "size": 3043,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.BusinessModule.Models;\n\nnamespace xbytechat.api.Features.Payment.Models\n{\n    /// <summary>\n    /// Represents a single payment interaction with a gateway\n    /// (checkout session, order, capture, refund, etc.).\n    /// </summary>\n    public class PaymentTransaction\n    {\n        public Guid Id { get; set; }\n\n        /// <summary>\n        /// Business that owns this transaction.\n        /// </summary>\n        public Guid BusinessId { get; set; }\n\n        /// <summary>\n        /// Optional related subscription (plan change, renewal, etc.).\n        /// </summary>\n        public Guid? SubscriptionId { get; set; }\n\n        /// <summary>\n        /// Optional related invoice (if this payment settles a specific invoice).\n        /// </summary>\n        public Guid? InvoiceId { get; set; }\n\n        /// <summary>\n        /// Total amount in smallest currency unit or decimal depending on your standard.\n        /// Use decimal for INR and similar.\n        /// </summary>\n        public decimal Amount { get; set; }\n\n        /// <summary>\n        /// ISO currency code, e.g. \"INR\", \"USD\".\n        /// </summary>\n        public string Currency { get; set; } = \"INR\";\n\n        /// <summary>\n        /// Current status of the transaction (pending, success, failed, etc.).\n        /// </summary>\n        public PaymentStatus Status { get; set; }\n\n        /// <summary>\n        /// Gateway name/provider identifier (e.g. \"Razorpay\", \"Stripe\").\n        /// Kept as string for flexibility; can be enum'ed later.\n        /// </summary>\n        public string Gateway { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Payment/charge id from the gateway.\n        /// </summary>\n        public string? GatewayPaymentId { get; set; }\n\n        /// <summary>\n        /// Order/checkout/session id from the gateway (if applicable).\n        /// </summary>\n        public string? GatewayOrderId { get; set; }\n\n        /// <summary>\n        /// Optional gateway signature or verification token (for validation).\n        /// </summary>\n        public string? GatewaySignature { get; set; }\n\n        /// <summary>\n        /// In case of failure, store short reason for debugging / UI.\n        /// </summary>\n        public string? FailureReason { get; set; }\n\n        /// <summary>\n        /// Any extra metadata (JSON) for debugging or support audits.\n        /// </summary>\n        public string? MetaJson { get; set; }\n\n        /// <summary>\n        /// When this record was created (UTC).\n        /// </summary>\n        public DateTime CreatedAtUtc { get; set; }\n\n        /// <summary>\n        /// When transaction was completed (success/failure/refund), if known (UTC).\n        /// </summary>\n        public DateTime? CompletedAtUtc { get; set; }\n\n        // ---- Navigation ----\n        public Business? Business { get; set; }\n        public Subscription? Subscription { get; set; }\n        public Invoice? Invoice { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Models/Subscription.cs",
      "sha256": "dc53299428c492d66865c3bf0d2760f65ca0a62124181ac4bcb23c1d82b4aab6",
      "language": "csharp",
      "size": 3244,
      "content": "#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.Payment.Models\n{\n    /// <summary>\n    /// Represents the subscription of a Business to a specific plan.\n    /// Drives access control, trials, renewals, and suspension.\n    /// </summary>\n    public class Subscription\n    {\n        /// <summary>\n        /// Primary key for the subscription.\n        /// </summary>\n        public Guid Id { get; set; }\n\n        /// <summary>\n        /// The business (account) this subscription belongs to.\n        /// </summary>\n        public Guid BusinessId { get; set; }\n\n        /// <summary>\n        /// The plan the business is subscribed to.\n        /// This should reference your PlanManagement module.\n        /// </summary>\n        public Guid PlanId { get; set; }\n\n        /// <summary>\n        /// Current lifecycle state of the subscription.\n        /// </summary>\n        public SubscriptionStatus Status { get; set; }\n\n        /// <summary>\n        /// Billing frequency (e.g. Monthly / Yearly).\n        /// </summary>\n        public BillingCycle BillingCycle { get; set; }\n\n        /// <summary>\n        /// When the current billing period starts (UTC).\n        /// </summary>\n        public DateTime CurrentPeriodStartUtc { get; set; }\n\n        /// <summary>\n        /// When the current billing period ends (UTC).\n        /// </summary>\n        public DateTime CurrentPeriodEndUtc { get; set; }\n\n        /// <summary>\n        /// Optional trial end (UTC). When passed and not activated -> Expired.\n        /// </summary>\n        public DateTime? TrialEndsAtUtc { get; set; }\n\n        /// <summary>\n        /// If true, subscription will auto-renew at the end of each period.\n        /// </summary>\n        public bool AutoRenew { get; set; } = true;\n\n        /// <summary>\n        /// If true, subscription will be cancelled when the current period ends.\n        /// </summary>\n        public bool CancelAtPeriodEnd { get; set; }\n\n        /// <summary>\n        /// Gateway specific customer id (Stripe, Razorpay, etc) for this business.\n        /// Stored here so multiple subscriptions can still share mapping if needed.\n        /// </summary>\n        public string? GatewayCustomerId { get; set; }\n\n        /// <summary>\n        /// Gateway specific subscription id, if managed on the gateway side.\n        /// </summary>\n        public string? GatewaySubscriptionId { get; set; }\n\n        /// <summary>\n        /// Optional internal notes (manual overrides, special deals, etc.).\n        /// </summary>\n        public string? Notes { get; set; }\n\n        // ---- Navigation properties ----\n\n        public Business? Business { get; set; }          // from BusinessModule\n        public Plan? Plan { get; set; }                  // from PlanManagement\n        public ICollection<PaymentTransaction> Payments { get; set; } = new List<PaymentTransaction>();\n        public ICollection<Invoice> Invoices { get; set; } = new List<Invoice>();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Options/RazorpayOptions.cs",
      "sha256": "b3955ae606e837242a71718a7365f4a068a66ab5c960000deb52d03867f4d313",
      "language": "csharp",
      "size": 738,
      "content": "#nullable enable\nnamespace xbytechat.api.Features.Payment.Options\n{\n    /// <summary>\n    /// Razorpay configuration bound from appsettings.\n    /// Never hard-code secrets in code.\n    /// </summary>\n    public sealed class RazorpayOptions\n    {\n        public string KeyId { get; set; } = string.Empty;\n        public string KeySecret { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Secret for validating Razorpay webhooks.\n        /// </summary>\n        public string WebhookSecret { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Base URL of your frontend where you handle success/failure (if needed).\n        /// </summary>\n        public string FrontendBaseUrl { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Options/SubscriptionLifecycleOptions.cs",
      "sha256": "acd4cdaf003dbabe03e8a2e81e657e7307201d0202953f31faf345a42dca66e3",
      "language": "csharp",
      "size": 453,
      "content": "#nullable enable\n\nnamespace xbytechat.api.Features.Payment.Options\n{\n    /// <summary>\n    /// Configuration for automatic subscription status transitions.\n    /// Values are in days unless noted.\n    /// </summary>\n    public sealed class SubscriptionLifecycleOptions\n    {\n        /// <summary>\n        /// After this many days in PastDue, move to Suspended.\n        /// </summary>\n        public int PastDueToSuspendedDays { get; set; } = 7;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/AccessCheckResult.cs",
      "sha256": "4f45881a7c082c9bac19582823676a818e765eb340cbd47cfd917316b6827bcf",
      "language": "csharp",
      "size": 416,
      "content": "#nullable enable\nusing xbytechat.api.Features.Payment.Enums;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Result of an access check for core, billable features.\n    /// </summary>\n    public sealed class AccessCheckResult\n    {\n        public bool Allowed { get; init; }\n        public SubscriptionStatus? Status { get; init; }\n        public string? Message { get; init; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/AccessGuard.cs",
      "sha256": "d961c3456ef2fb78fb80341a4eaa6af91dc2cd92179c1a3634c046d9f9da0bf4",
      "language": "csharp",
      "size": 5346,
      "content": "#nullable enable\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Subscription-based access control:\n    /// decides if core features (like messaging, campaigns) are allowed.\n    /// All rules centralized here.\n    /// </summary>\n    public sealed class AccessGuard : IAccessGuard\n    {\n        private readonly AppDbContext _db;\n\n        public AccessGuard(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<bool> CanUseCoreFeaturesAsync(Guid businessId, CancellationToken ct = default)\n        {\n            var result = await CheckAsync(businessId, ct);\n            return result.Allowed;\n        }\n\n        public async Task<AccessCheckResult> CheckAsync(Guid businessId, CancellationToken ct = default)\n        {\n            var now = DateTime.UtcNow;\n\n            var sub = await _db.Subscriptions\n                .Where(s => s.BusinessId == businessId)\n                .OrderByDescending(s => s.CurrentPeriodStartUtc)\n                .FirstOrDefaultAsync(ct);\n\n            // Case: no subscription at all\n            if (sub is null)\n            {\n                return new AccessCheckResult\n                {\n                    Allowed = false,\n                    Status = null,\n                    Message = \"You don‚Äôt have an active plan. Choose a plan in Billing to start using messaging and campaigns.\"\n                };\n            }\n\n            var status = sub.Status;\n\n            switch (status)\n            {\n                case SubscriptionStatus.Active:\n                    return new AccessCheckResult\n                    {\n                        Allowed = true,\n                        Status = status\n                    };\n\n                case SubscriptionStatus.Trial:\n                    // Trial active\n                    if (sub.TrialEndsAtUtc is null || sub.TrialEndsAtUtc > now)\n                    {\n                        return new AccessCheckResult\n                        {\n                            Allowed = true,\n                            Status = status\n                        };\n                    }\n\n                    // Trial expired\n                    return new AccessCheckResult\n                    {\n                        Allowed = false,\n                        Status = SubscriptionStatus.Expired,\n                        Message = \"Your trial has ended. Choose a plan in Billing to continue using messaging and campaigns.\"\n                    };\n\n                case SubscriptionStatus.Grace:\n                    // Grace = still allowed; show banner via UI if you want\n                    return new AccessCheckResult\n                    {\n                        Allowed = true,\n                        Status = status\n                    };\n\n                case SubscriptionStatus.PastDue:\n                    // Payment failed / due date passed\n                    return new AccessCheckResult\n                    {\n                        Allowed = false,\n                        Status = status,\n                        Message = \"Your subscription payment is overdue. Please clear the pending invoice in Billing to restore access.\"\n                    };\n\n                case SubscriptionStatus.CancelAtPeriodEnd:\n                    if (sub.CurrentPeriodEndUtc > now)\n                    {\n                        // Still in paid period\n                        return new AccessCheckResult\n                        {\n                            Allowed = true,\n                            Status = status\n                        };\n                    }\n\n                    // Period ended -> treat as cancelled\n                    return new AccessCheckResult\n                    {\n                        Allowed = false,\n                        Status = SubscriptionStatus.Cancelled,\n                        Message = \"Your subscription has ended. Select a plan in Billing to continue using your account.\"\n                    };\n\n                case SubscriptionStatus.Cancelled:\n                case SubscriptionStatus.Expired:\n                    return new AccessCheckResult\n                    {\n                        Allowed = false,\n                        Status = status,\n                        Message = \"Your subscription is no longer active. Select a plan in Billing to continue using your account.\"\n                    };\n\n                case SubscriptionStatus.Suspended:\n                    return new AccessCheckResult\n                    {\n                        Allowed = false,\n                        Status = status,\n                        Message = \"Your account has been suspended due to payment issues. Update your payment method or contact support to restore access.\"\n                    };\n\n                default:\n                    return new AccessCheckResult\n                    {\n                        Allowed = false,\n                        Status = status,\n                        Message = \"Your subscription status does not allow access. Please check Billing or contact support.\"\n                    };\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/CouponPricingHelper.cs",
      "sha256": "606ce2e78f72f5929451312374fd656e0521436252e69f3eb70c99c1acd16275",
      "language": "csharp",
      "size": 1158,
      "content": "#nullable enable\nusing System;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Small helper to apply coupon math consistently.\n    /// This does not check validity windows or max usage - that stays in CouponService.\n    /// </summary>\n    internal static class CouponPricingHelper\n    {\n        public static (decimal discountAmount, decimal finalAmount) ApplyCoupon(\n            Coupon coupon,\n            decimal subtotal)\n        {\n            if (subtotal <= 0 || !coupon.IsActive)\n                return (0m, subtotal);\n\n            decimal discount = coupon.DiscountType switch\n            {\n                DiscountType.Percentage =>\n                    Math.Round(subtotal * (coupon.DiscountValue / 100m), 2, MidpointRounding.AwayFromZero),\n\n                DiscountType.FixedAmount =>\n                    Math.Min(coupon.DiscountValue, subtotal),\n\n                _ => 0m\n            };\n\n            var final = subtotal - discount;\n            if (final < 0) final = 0;\n\n            return (discount, final);\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/CouponService.cs",
      "sha256": "6885d6873aaa667ac68883aab998bed6b3f967e3a772e80b5a568577e5f06406",
      "language": "csharp",
      "size": 1990,
      "content": "#nullable enable\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Minimal coupon validator:\n    /// - checks code, active flag, date range.\n    /// - does NOT yet enforce redemption limits.\n    /// </summary>\n    public sealed class CouponService : ICouponService\n    {\n        private readonly AppDbContext _db;\n\n        public CouponService(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<CouponDto?> ValidateCouponAsync(\n            string code,\n            string currency,\n            CancellationToken ct = default)\n        {\n            if (string.IsNullOrWhiteSpace(code))\n                return null;\n\n            var now = DateTime.UtcNow;\n            var coupon = await _db.Coupons\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c =>\n                        c.IsActive &&\n                        c.Code == code &&\n                        (c.ValidFromUtc == null || c.ValidFromUtc <= now) &&\n                        (c.ValidToUtc == null || c.ValidToUtc >= now),\n                    ct);\n\n            if (coupon is null)\n                return null;\n\n            // Future:\n            // - Validate currency, plan scope, usage limits.\n            // - For now we trust currency compatibility implicitly.\n\n            return new CouponDto\n            {\n                Id = coupon.Id,\n                Code = coupon.Code,\n                Description = coupon.Description,\n                DiscountType = coupon.DiscountType,\n                DiscountValue = coupon.DiscountValue,\n                IsActive = coupon.IsActive,\n                ValidFromUtc = coupon.ValidFromUtc,\n                ValidToUtc = coupon.ValidToUtc\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/IAccessGuard.cs",
      "sha256": "a396a820f8282d2bc56f43fad75de0341d2f2c2c89371f96137bc5a834d9ee1c",
      "language": "csharp",
      "size": 492,
      "content": "#nullable enable\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Central guard to decide if a business is allowed to use billable features.\n    /// </summary>\n    public interface IAccessGuard\n    {\n        Task<bool> CanUseCoreFeaturesAsync(Guid businessId, CancellationToken ct = default);\n        Task<AccessCheckResult> CheckAsync(Guid businessId, CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/ICouponService.cs",
      "sha256": "e9762a2227164503e672c3b167224efe6147864859ca5c11671e7f4fb52dc1e9",
      "language": "csharp",
      "size": 507,
      "content": "#nullable enable\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Payment.DTOs;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Validates coupons and exposes safe coupon info.\n    /// Admin management can be a separate module.\n    /// </summary>\n    public interface ICouponService\n    {\n        Task<CouponDto?> ValidateCouponAsync(\n            string code,\n            string currency,\n            CancellationToken ct = default);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/IInvoiceService.cs",
      "sha256": "585437bb5981309ae50ba8e00a4647199330efb4e2ea638769db662857c68e70",
      "language": "csharp",
      "size": 677,
      "content": "#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Payment.DTOs;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Creates and retrieves invoices for businesses.\n    /// Actual tax/coupon/usage logic will be implemented inside.\n    /// </summary>\n    public interface IInvoiceService\n    {\n        Task<IReadOnlyList<InvoiceDto>> GetInvoicesForBusinessAsync(\n            Guid businessId,\n            CancellationToken ct = default);\n\n        Task<InvoiceDto?> GetInvoiceAsync(Guid businessId, Guid invoiceId, CancellationToken ct = default);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/InvoiceService.cs",
      "sha256": "c2186e5a30552a96ae94d0251d272d8957dfffb61a0741029438b92fb0b20be3",
      "language": "csharp",
      "size": 2779,
      "content": "#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Read-only invoice service for now.\n    /// Future:\n    /// - generation based on subscriptions & usage\n    /// - GST-compliant export.\n    /// </summary>\n    public sealed class InvoiceService : IInvoiceService\n    {\n        private readonly AppDbContext _db;\n\n        public InvoiceService(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<IReadOnlyList<InvoiceDto>> GetInvoicesForBusinessAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            var invoices = await _db.Invoices\n                .Include(i => i.LineItems)\n                .Where(i => i.BusinessId == businessId)\n                .OrderByDescending(i => i.IssuedAtUtc)\n                .ToListAsync(ct);\n\n            return invoices.Select(MapToDto).ToList();\n        }\n\n        public async Task<InvoiceDto?> GetInvoiceAsync(\n            Guid businessId,\n            Guid invoiceId,\n            CancellationToken ct = default)\n        {\n            var invoice = await _db.Invoices\n                .Include(i => i.LineItems)\n                .FirstOrDefaultAsync(i => i.Id == invoiceId && i.BusinessId == businessId, ct);\n\n            return invoice is null ? null : MapToDto(invoice);\n        }\n\n        private static InvoiceDto MapToDto(Invoice invoice)\n        {\n            return new InvoiceDto\n            {\n                Id = invoice.Id,\n                InvoiceNumber = invoice.InvoiceNumber,\n                BusinessId = invoice.BusinessId,\n                SubscriptionId = invoice.SubscriptionId,\n                Status = invoice.Status,\n                SubtotalAmount = invoice.SubtotalAmount,\n                DiscountAmount = invoice.DiscountAmount,\n                TaxAmount = invoice.TaxAmount,\n                TotalAmount = invoice.TotalAmount,\n                Currency = invoice.Currency,\n                AppliedCouponCode = invoice.AppliedCouponCode,\n                IssuedAtUtc = invoice.IssuedAtUtc,\n                DueAtUtc = invoice.DueAtUtc,\n                PaidAtUtc = invoice.PaidAtUtc,\n                LineItems = invoice.LineItems.Select(li => new InvoiceLineItemDto\n                {\n                    Id = li.Id,\n                    Description = li.Description,\n                    Quantity = li.Quantity,\n                    UnitPrice = li.UnitPrice,\n                    LineTotal = li.LineTotal\n                }).ToList()\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/IPaymentGatewayService.cs",
      "sha256": "409d1d87341a931f5ea4a5129b75d859144e06166146b1964e22084cd3310470",
      "language": "csharp",
      "size": 804,
      "content": "#nullable enable\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Payment.DTOs;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Abstraction over the underlying payment provider (Razorpay, Stripe, etc.).\n    /// Implementation will:\n    /// - create checkout/payment sessions\n    /// - verify signatures\n    /// - map webhooks to PaymentTransaction updates.\n    /// </summary>\n    public interface IPaymentGatewayService\n    {\n        Task<PaymentSessionResponseDto> CreatePaymentSessionForInvoiceAsync(\n            Guid businessId,\n            Guid invoiceId,\n            string? couponCode,\n            CancellationToken ct = default);\n\n        // We will add webhook-handling signatures later when wiring gateway.\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/ISubscriptionCheckoutService.cs",
      "sha256": "70caced3708db2d78510dbc7a306b90d3cbf5928ad2de27a3915b5a5fab1dd73",
      "language": "csharp",
      "size": 563,
      "content": "#nullable enable\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Payment.DTOs;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Orchestrates plan selection -> invoice -> payment session for subscriptions.\n    /// </summary>\n    public interface ISubscriptionCheckoutService\n    {\n        Task<PaymentSessionResponseDto> StartSubscriptionCheckoutAsync(\n            Guid businessId,\n            CreateSubscriptionRequestDto request,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/ISubscriptionService.cs",
      "sha256": "bb311c9360309f2f785913b2edf1fee96d7a66bbcc0784ec59392e3cc5718845",
      "language": "csharp",
      "size": 879,
      "content": "#nullable enable\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Payment.DTOs;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Handles business-facing subscription lifecycle:\n    /// trial, activation, upgrade/downgrade, cancellation.\n    /// </summary>\n    public interface ISubscriptionService\n    {\n        Task<SubscriptionDto?> GetCurrentForBusinessAsync(Guid businessId, CancellationToken ct = default);\n\n        Task<SubscriptionDto> CreateOrUpdateSubscriptionAsync(\n            Guid businessId,\n            CreateSubscriptionRequestDto request,\n            CancellationToken ct = default);\n\n        Task<bool> MarkCancelAtPeriodEndAsync(Guid businessId, CancellationToken ct = default);\n\n        Task<bool> ReactivateAutoRenewAsync(Guid businessId, CancellationToken ct = default);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/PaymentOverviewService.cs",
      "sha256": "90fc29922281ffee1c3c6140193d81efce9c482132b8ed63aebc9b269c4b546e",
      "language": "csharp",
      "size": 2140,
      "content": "#nullable enable\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Lightweight read service to power Billing/Insights UI.\n    /// Aggregates subscription + invoices + access flag.\n    /// </summary>\n    public sealed class PaymentOverviewService\n    {\n        private readonly AppDbContext _db;\n        private readonly ISubscriptionService _subscriptions;\n        private readonly IInvoiceService _invoices;\n        private readonly IAccessGuard _accessGuard;\n\n        public PaymentOverviewService(\n            AppDbContext db,\n            ISubscriptionService subscriptions,\n            IInvoiceService invoices,\n            IAccessGuard accessGuard)\n        {\n            _db = db;\n            _subscriptions = subscriptions;\n            _invoices = invoices;\n            _accessGuard = accessGuard;\n        }\n\n        public async Task<PaymentOverviewDto> GetAsync(Guid businessId, CancellationToken ct = default)\n        {\n            var sub = await _subscriptions.GetCurrentForBusinessAsync(businessId, ct);\n            var invoices = await _invoices.GetInvoicesForBusinessAsync(businessId, ct);\n\n            var lastPaid = invoices\n                .Where(i => i.Status == InvoiceStatus.Paid)\n                .OrderByDescending(i => i.PaidAtUtc ?? i.IssuedAtUtc)\n                .FirstOrDefault();\n\n            var canUse = await _accessGuard.CanUseCoreFeaturesAsync(businessId, ct);\n\n            return new PaymentOverviewDto\n            {\n                CurrentSubscription = sub,\n                LastInvoiceAmount = lastPaid?.TotalAmount,\n                LastInvoicePaidAtUtc = lastPaid?.PaidAtUtc,\n                CurrentPeriodEndUtc = sub?.CurrentPeriodEndUtc,\n                CanUseCoreFeatures = canUse,\n                RecentInvoices = invoices\n                    .Take(10)\n                    .ToList()\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/RazorpayPaymentGatewayService.cs",
      "sha256": "bbc11c906ea24283a7a891f205a389e6d72ca9fdf01f7dda65c50a6633d090eb",
      "language": "csharp",
      "size": 5962,
      "content": "#nullable enable\nusing System;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.Payment.Options;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Razorpay-based implementation of IPaymentGatewayService.\n    /// This is a minimal skeleton:\n    /// - Creates a Razorpay Order for an existing Invoice.\n    /// - Persists a Pending PaymentTransaction.\n    /// - Returns data for frontend to open Razorpay Checkout.\n    ///\n    /// Webhook handling that marks success/failure is done separately.\n    /// </summary>\n    public sealed class RazorpayPaymentGatewayService : IPaymentGatewayService\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http;\n        private readonly RazorpayOptions _opts;\n        private readonly ILogger<RazorpayPaymentGatewayService> _log;\n\n        public RazorpayPaymentGatewayService(\n            AppDbContext db,\n            HttpClient httpClient,\n            IOptions<RazorpayOptions> opts,\n            ILogger<RazorpayPaymentGatewayService> log)\n        {\n            _db = db;\n            _http = httpClient;\n            _opts = opts.Value;\n            _log = log;\n\n            if (!string.IsNullOrWhiteSpace(_opts.KeyId) &&\n                !string.IsNullOrWhiteSpace(_opts.KeySecret))\n            {\n                var authToken = Convert.ToBase64String(\n                    Encoding.UTF8.GetBytes($\"{_opts.KeyId}:{_opts.KeySecret}\"));\n\n                _http.BaseAddress ??= new Uri(\"https://api.razorpay.com/v1/\");\n                _http.DefaultRequestHeaders.Authorization =\n                    new AuthenticationHeaderValue(\"Basic\", authToken);\n            }\n        }\n\n        /// <summary>\n        /// Creates a payment session (Razorpay Order) for the given invoice.\n        /// Assumes:\n        /// - Invoice is already created with TotalAmount & Currency.\n        /// - BusinessId already validated by caller.\n        /// </summary>\n        public async Task<PaymentSessionResponseDto> CreatePaymentSessionForInvoiceAsync(\n            Guid businessId,\n            Guid invoiceId,\n            string? couponCode,\n            CancellationToken ct = default)\n        {\n            var invoice = await _db.Invoices\n                .FirstOrDefaultAsync(i => i.Id == invoiceId && i.BusinessId == businessId, ct);\n\n            if (invoice is null)\n                throw new InvalidOperationException(\"Invoice not found for this business.\");\n\n            if (invoice.Status is InvoiceStatus.Paid or InvoiceStatus.Void)\n                throw new InvalidOperationException(\"Invoice is already closed.\");\n\n            if (invoice.TotalAmount <= 0)\n                throw new InvalidOperationException(\"Invoice total must be greater than zero.\");\n\n            // ---- Create PaymentTransaction record (Pending) ----\n            var tx = new PaymentTransaction\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                InvoiceId = invoice.Id,\n                SubscriptionId = invoice.SubscriptionId,\n                Amount = invoice.TotalAmount,\n                Currency = invoice.Currency,\n                Status = PaymentStatus.Pending,\n                Gateway = \"Razorpay\",\n                CreatedAtUtc = DateTime.UtcNow,\n                MetaJson = null\n            };\n\n            _db.PaymentTransactions.Add(tx);\n            await _db.SaveChangesAsync(ct);\n\n            // ---- Call Razorpay Orders API ----\n            // amount in paise for INR (multiply by 100)\n            var amountInMinor = (int)(invoice.TotalAmount * 100m);\n\n            var payload = new\n            {\n                amount = amountInMinor,\n                currency = invoice.Currency,\n                receipt = invoice.InvoiceNumber,\n                payment_capture = 1 // auto-capture\n            };\n\n            var json = JsonSerializer.Serialize(payload);\n            var content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            HttpResponseMessage resp;\n            try\n            {\n                resp = await _http.PostAsync(\"orders\", content, ct);\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Error calling Razorpay Orders API\");\n                throw new InvalidOperationException(\"Unable to create payment order at this time.\");\n            }\n\n            if (!resp.IsSuccessStatusCode)\n            {\n                var body = await resp.Content.ReadAsStringAsync(ct);\n                _log.LogError(\"Razorpay order failed: {Status} {Body}\", resp.StatusCode, body);\n                throw new InvalidOperationException(\"Failed to create payment order.\");\n            }\n\n            using var stream = await resp.Content.ReadAsStreamAsync(ct);\n            using var doc = await JsonDocument.ParseAsync(stream, cancellationToken: ct);\n\n            var orderId = doc.RootElement.GetProperty(\"id\").GetString();\n\n            // Save order id on transaction\n            tx.GatewayOrderId = orderId;\n            tx.MetaJson = json;\n            await _db.SaveChangesAsync(ct);\n\n            // ---- Return session info for frontend ----\n            // Frontend will:\n            // - Use Razorpay JS with key_id + order_id + customer info\n            // - On success, webhook will confirm and we update DB.\n            var session = new PaymentSessionResponseDto\n            {\n                SessionId = tx.Id.ToString(),\n                RedirectUrl = $\"{_opts.FrontendBaseUrl}/billing/checkout?orderId={orderId}&txId={tx.Id}\"\n            };\n\n            return session;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/SubscriptionCheckoutService.cs",
      "sha256": "48af43a4143fe1c6dae9034239311fb59a206b94fd914453c3f690300017c59e",
      "language": "csharp",
      "size": 7681,
      "content": "#nullable enable\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Handles the \"subscribe to plan\" flow:\n    /// - Validates plan & coupon\n    /// - Creates invoice with coupon + GST\n    /// - Creates payment session via gateway.\n    /// </summary>\n    public sealed class SubscriptionCheckoutService : ISubscriptionCheckoutService\n    {\n        private readonly AppDbContext _db;\n        private readonly ICouponService _coupons;\n        private readonly IPaymentGatewayService _gateway;\n\n        public SubscriptionCheckoutService(\n            AppDbContext db,\n            ICouponService coupons,\n            IPaymentGatewayService gateway)\n        {\n            _db = db;\n            _coupons = coupons;\n            _gateway = gateway;\n        }\n\n        public async Task<PaymentSessionResponseDto> StartSubscriptionCheckoutAsync(\n            Guid businessId,\n            CreateSubscriptionRequestDto request,\n            CancellationToken ct = default)\n        {\n            var plan = await _db.Set<Plan>()\n                .AsNoTracking()\n                .FirstOrDefaultAsync(p => p.Id == request.PlanId, ct)\n                ?? throw new InvalidOperationException(\"Plan not found.\");\n\n            // Resolve base price from plan & cycle (adjust property names to your Plan model).\n            var (price, currency) = GetPlanPrice(plan, request.BillingCycle);\n            if (price <= 0)\n                throw new InvalidOperationException(\"Plan price is not configured.\");\n\n            var subtotal = price;\n\n            // ---- Apply coupon if present ----\n            string? appliedCode = null;\n            decimal discountAmount = 0m;\n\n            if (!string.IsNullOrWhiteSpace(request.CouponCode))\n            {\n                var coupon = await _coupons.ValidateCouponAsync(request.CouponCode, currency, ct);\n                if (coupon != null)\n                {\n                    // Load full Coupon entity to use in helper\n                    var fullCoupon = await _db.Coupons\n                        .FirstAsync(c => c.Id == coupon.Id, ct);\n\n                    var (disc, finalAfterDisc) = CouponPricingHelper.ApplyCoupon(fullCoupon, subtotal);\n                    discountAmount = disc;\n                    subtotal = finalAfterDisc;\n                    appliedCode = coupon.Code;\n                }\n            }\n\n            // ---- Apply GST (India) ----\n            // For now assume intra-state = false/true via a simple flag or config.\n            // You can later compute based on Business address vs your GST registration.\n            var (taxAmount, taxBreakdownJson) =\n                TaxCalculator.CalculateGstForIndianCustomer(subtotal, isInterState: true);\n\n            var total = subtotal + taxAmount;\n\n            // ---- Create Invoice ----\n            var invoice = new Invoice\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                SubscriptionId = null,                // will be linked on success\n                PlanId = plan.Id,\n                BillingCycle = request.BillingCycle,\n                InvoiceNumber = GenerateInvoiceNumber(),\n                Status = InvoiceStatus.Open,\n                SubtotalAmount = price,\n                DiscountAmount = discountAmount,\n                TaxAmount = taxAmount,\n                TotalAmount = total,\n                Currency = currency,\n                AppliedCouponCode = appliedCode,\n                TaxBreakdownJson = taxBreakdownJson,\n                IssuedAtUtc = DateTime.UtcNow,\n                DueAtUtc = null\n            };\n\n            // Single line item: \"Plan - cycle\"\n            invoice.LineItems.Add(new InvoiceLineItem\n            {\n                Id = Guid.NewGuid(),\n                InvoiceId = invoice.Id,\n                Description = $\"{plan.Name} - {request.BillingCycle}\",\n                Quantity = 1,\n                UnitPrice = price,\n                LineTotal = price\n            });\n\n            _db.Invoices.Add(invoice);\n            await _db.SaveChangesAsync(ct);\n\n            // ---- Create payment session via gateway ----\n            var session = await _gateway.CreatePaymentSessionForInvoiceAsync(\n                businessId,\n                invoice.Id,\n                appliedCode,\n                ct);\n\n            return session;\n        }\n\n        private static (decimal price, string currency) GetPlanPrice(Plan plan, BillingCycle cycle)\n        {\n            // We don't hardcode your Plan schema here.\n            // Instead, we try common property names via reflection so this compiles\n            // even if your Plan model is different. Later you can replace this\n            // with a strict implementation once pricing fields are finalized.\n\n            var type = plan.GetType();\n\n            // 1) Currency: try common names, fallback to INR\n            var currencyProp =\n                type.GetProperty(\"Currency\") ??\n                type.GetProperty(\"DefaultCurrency\") ??\n                type.GetProperty(\"PlanCurrency\");\n\n            var currency =\n                (currencyProp?.GetValue(plan) as string)\n                ?? \"INR\";\n\n            // 2) Price: prefer cycle-specific fields if they exist\n            string[] yearlyNames = { \"YearlyPrice\", \"PriceYearly\", \"YearlyAmount\", \"AnnualPrice\" };\n            string[] monthlyNames = { \"MonthlyPrice\", \"PriceMonthly\", \"MonthlyAmount\" };\n\n            decimal price = 0m;\n\n            if (cycle == BillingCycle.Yearly)\n            {\n                foreach (var name in yearlyNames)\n                {\n                    var p = type.GetProperty(name);\n                    if (p != null && p.PropertyType == typeof(decimal))\n                    {\n                        price = (decimal)(p.GetValue(plan) ?? 0m);\n                        if (price > 0) break;\n                    }\n                }\n            }\n            else\n            {\n                foreach (var name in monthlyNames)\n                {\n                    var p = type.GetProperty(name);\n                    if (p != null && p.PropertyType == typeof(decimal))\n                    {\n                        price = (decimal)(p.GetValue(plan) ?? 0m);\n                        if (price > 0) break;\n                    }\n                }\n            }\n\n            // 3) Fallback: single generic price property if cycle-specific not found\n            if (price <= 0)\n            {\n                var singlePriceProp =\n                    type.GetProperty(\"Price\") ??\n                    type.GetProperty(\"Amount\") ??\n                    type.GetProperty(\"BasePrice\");\n\n                if (singlePriceProp != null && singlePriceProp.PropertyType == typeof(decimal))\n                {\n                    price = (decimal)(singlePriceProp.GetValue(plan) ?? 0m);\n                }\n            }\n\n            // At this point:\n            // - If price is still 0 => your Plan doesn't have any of the expected fields.\n            //   That‚Äôs a config/contract decision, not a runtime crash.\n            return (price, currency);\n        }\n\n        private static string GenerateInvoiceNumber()\n        {\n            // Primitive; replace with your own sequence if needed.\n            return \"XP-\" + DateTime.UtcNow.ToString(\"yyyyMMddHHmmssfff\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/SubscriptionLifecycleService.cs",
      "sha256": "51355740e1dc5177760bd770f8d1d2486b75eefe83436373792dacce2653f1d8",
      "language": "csharp",
      "size": 3768,
      "content": "#nullable enable\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.Payment.Options;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Runs periodic maintenance to keep subscription statuses in sync with time & invoices.\n    /// Should be called by a scheduled job (e.g. daily).\n    /// </summary>\n    public sealed class SubscriptionLifecycleService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<SubscriptionLifecycleService> _log;\n        private readonly SubscriptionLifecycleOptions _options;\n\n        public SubscriptionLifecycleService(\n            AppDbContext db,\n            IOptions<SubscriptionLifecycleOptions> options,\n            ILogger<SubscriptionLifecycleService> log)\n        {\n            _db = db;\n            _log = log;\n            _options = options.Value;\n        }\n\n        /// <summary>\n        /// Run lifecycle sync for all subscriptions.\n        /// Safe to run daily (or more often).\n        /// </summary>\n        public async Task RunAsync(CancellationToken ct = default)\n        {\n            var now = DateTime.UtcNow;\n            var pastDueCutoff = now.AddDays(-_options.PastDueToSuspendedDays);\n\n            // Load subs in one go; for huge scale you'd batch.\n            var subs = await _db.Subscriptions\n                .AsTracking()\n                .ToListAsync(ct);\n\n            foreach (var sub in subs)\n            {\n                try\n                {\n                    switch (sub.Status)\n                    {\n                        case SubscriptionStatus.Trial:\n                            if (sub.TrialEndsAtUtc is not null &&\n                                sub.TrialEndsAtUtc.Value < now)\n                            {\n                                sub.Status = SubscriptionStatus.Expired;\n                            }\n                            break;\n\n                        case SubscriptionStatus.CancelAtPeriodEnd:\n                            if (sub.CurrentPeriodEndUtc < now)\n                            {\n                                sub.Status = SubscriptionStatus.Cancelled;\n                            }\n                            break;\n\n                        case SubscriptionStatus.PastDue:\n                            // If there is an unpaid invoice older than cutoff,\n                            // we suspend the subscription.\n                            var hasOldUnpaid = await _db.Invoices\n                                .AnyAsync(i =>\n                                    i.SubscriptionId == sub.Id &&\n                                    i.Status != InvoiceStatus.Paid &&\n                                    (i.DueAtUtc ?? i.IssuedAtUtc) < pastDueCutoff,\n                                    ct);\n\n                            if (hasOldUnpaid)\n                            {\n                                sub.Status = SubscriptionStatus.Suspended;\n                            }\n                            break;\n\n                        default:\n                            // Active, Grace, Suspended, Cancelled, Expired:\n                            // no automatic change here for now.\n                            break;\n                    }\n                }\n                catch (Exception ex)\n                {\n                    _log.LogError(ex,\n                        \"Error processing lifecycle for subscription {SubscriptionId}\", sub.Id);\n                }\n            }\n\n            await _db.SaveChangesAsync(ct);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/SubscriptionService.cs",
      "sha256": "1b95797bd39279882a472d47da6b09c5470847fe9e3ea58d17742c0f7fe2d9ae",
      "language": "csharp",
      "size": 7200,
      "content": "#nullable enable\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.Payment.DTOs;\nusing xbytechat.api.Features.Payment.Enums;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.Payment.Services;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Default implementation for managing business subscriptions.\n    /// NOTE:\n    /// - For now we assume \"backend-approved\" calls (e.g. after payment success or admin action).\n    /// - Later we will tighten this to be driven purely by gateway webhooks.\n    /// </summary>\n    public sealed class SubscriptionService : ISubscriptionService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<SubscriptionService> _log;\n\n        public SubscriptionService(AppDbContext db, ILogger<SubscriptionService> log)\n        {\n            _db = db;\n            _log = log;\n        }\n\n        /// <summary>\n        /// Gets the latest subscription for a business (if any).\n        /// </summary>\n        public async Task<SubscriptionDto?> GetCurrentForBusinessAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            var sub = await _db.Subscriptions\n                .Include(s => s.Plan)\n                .Where(s => s.BusinessId == businessId)\n                .OrderByDescending(s => s.CurrentPeriodStartUtc)\n                .FirstOrDefaultAsync(ct);\n\n            if (sub is null) return null;\n\n            return MapToDto(sub);\n        }\n\n        /// <summary>\n        /// Creates or updates a subscription for a business.\n        /// IMPORTANT:\n        /// - This is a logical operation; real activation should be tied to payment success later.\n        /// - For MVP we mark as Active immediately (assuming external validation).\n        /// </summary>\n        public async Task<SubscriptionDto> CreateOrUpdateSubscriptionAsync(\n            Guid businessId,\n            CreateSubscriptionRequestDto request,\n            CancellationToken ct = default)\n        {\n            var business = await _db.Set<Business>()\n                .AsNoTracking()\n                .FirstOrDefaultAsync(b => b.Id == businessId, ct)\n                ?? throw new InvalidOperationException(\"Business not found.\");\n\n            var plan = await _db.Set<Plan>()\n                .AsNoTracking()\n                .FirstOrDefaultAsync(p => p.Id == request.PlanId, ct)\n                ?? throw new InvalidOperationException(\"Plan not found.\");\n\n            var now = DateTime.UtcNow;\n\n            // Simple: 1 active subscription per business (latest wins).\n            var existing = await _db.Subscriptions\n                .Where(s => s.BusinessId == businessId\n                            && s.Status != SubscriptionStatus.Cancelled\n                            && s.Status != SubscriptionStatus.Expired)\n                .OrderByDescending(s => s.CurrentPeriodStartUtc)\n                .FirstOrDefaultAsync(ct);\n\n            var periodEnd = request.BillingCycle switch\n            {\n                BillingCycle.Yearly => now.AddYears(1),\n                _ => now.AddMonths(1)\n            };\n\n            if (existing is null)\n            {\n                var sub = new Subscription\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    PlanId = plan.Id,\n                    Status = SubscriptionStatus.Active,   // later: controlled by payment result\n                    BillingCycle = request.BillingCycle,\n                    CurrentPeriodStartUtc = now,\n                    CurrentPeriodEndUtc = periodEnd,\n                    AutoRenew = true,\n                    CancelAtPeriodEnd = false,\n                    TrialEndsAtUtc = null\n                };\n\n                _db.Subscriptions.Add(sub);\n                await _db.SaveChangesAsync(ct);\n\n                return MapToDto(sub, plan.Name);\n            }\n            else\n            {\n                // Update existing into new plan / cycle.\n                existing.PlanId = plan.Id;\n                existing.BillingCycle = request.BillingCycle;\n                existing.Status = SubscriptionStatus.Active;\n                existing.AutoRenew = true;\n                existing.CancelAtPeriodEnd = false;\n                existing.CurrentPeriodStartUtc = now;\n                existing.CurrentPeriodEndUtc = periodEnd;\n\n                await _db.SaveChangesAsync(ct);\n\n                return MapToDto(existing, plan.Name);\n            }\n        }\n\n        public async Task<bool> MarkCancelAtPeriodEndAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            var sub = await _db.Subscriptions\n                .Where(s => s.BusinessId == businessId &&\n                            (s.Status == SubscriptionStatus.Active || s.Status == SubscriptionStatus.Trial))\n                .OrderByDescending(s => s.CurrentPeriodStartUtc)\n                .FirstOrDefaultAsync(ct);\n\n            if (sub is null) return false;\n\n            sub.CancelAtPeriodEnd = true;\n            sub.Status = SubscriptionStatus.CancelAtPeriodEnd;\n\n            await _db.SaveChangesAsync(ct);\n            return true;\n        }\n\n        public async Task<bool> ReactivateAutoRenewAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            var sub = await _db.Subscriptions\n                .Where(s => s.BusinessId == businessId &&\n                            (s.Status == SubscriptionStatus.CancelAtPeriodEnd ||\n                             s.Status == SubscriptionStatus.Active))\n                .OrderByDescending(s => s.CurrentPeriodStartUtc)\n                .FirstOrDefaultAsync(ct);\n\n            if (sub is null) return false;\n\n            sub.CancelAtPeriodEnd = false;\n            if (sub.Status == SubscriptionStatus.CancelAtPeriodEnd)\n            {\n                sub.Status = SubscriptionStatus.Active;\n            }\n\n            await _db.SaveChangesAsync(ct);\n            return true;\n        }\n\n        private static SubscriptionDto MapToDto(Subscription sub, string? planNameOverride = null)\n        {\n            return new SubscriptionDto\n            {\n                Id = sub.Id,\n                BusinessId = sub.BusinessId,\n                PlanId = sub.PlanId,\n                PlanName = planNameOverride ?? sub.Plan?.Name ?? string.Empty,\n                Status = sub.Status,\n                BillingCycle = sub.BillingCycle,\n                CurrentPeriodStartUtc = sub.CurrentPeriodStartUtc,\n                CurrentPeriodEndUtc = sub.CurrentPeriodEndUtc,\n                TrialEndsAtUtc = sub.TrialEndsAtUtc,\n                AutoRenew = sub.AutoRenew,\n                CancelAtPeriodEnd = sub.CancelAtPeriodEnd,\n                GatewayCustomerId = sub.GatewayCustomerId,\n                GatewaySubscriptionId = sub.GatewaySubscriptionId\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Payment/Services/TaxCalculator.cs",
      "sha256": "fc3592dc1f9909a3402d232a7c85f4e0fa28adcdf2b29679f06c5d69de52003a",
      "language": "csharp",
      "size": 1602,
      "content": "#nullable enable\nusing System;\nusing System.Text.Json;\n\nnamespace xbytechat.api.Features.Payment.Services\n{\n    /// <summary>\n    /// Central place for GST/tax math so rules can be updated without touching many files.\n    /// This is intentionally simple for now.\n    /// </summary>\n    public static class TaxCalculator\n    {\n        // For now: default 18% GST (update via config/feature flags later).\n        private const decimal DefaultGstRate = 0.18m;\n\n        public static (decimal taxAmount, string? breakdownJson) CalculateGstForIndianCustomer(\n            decimal taxableAmount,\n            bool isInterState)\n        {\n            if (taxableAmount <= 0)\n                return (0m, null);\n\n            var totalGst = Math.Round(taxableAmount * DefaultGstRate, 2, MidpointRounding.AwayFromZero);\n\n            // Simple split:\n            if (isInterState)\n            {\n                var igst = totalGst;\n                var breakdown = new\n                {\n                    type = \"IGST\",\n                    rate = 18,\n                    igst\n                };\n                return (totalGst, JsonSerializer.Serialize(breakdown));\n            }\n            else\n            {\n                var half = Math.Round(totalGst / 2m, 2, MidpointRounding.AwayFromZero);\n                var breakdown = new\n                {\n                    type = \"CGST_SGST\",\n                    rate = 18,\n                    cgst = half,\n                    sgst = half\n                };\n                return (totalGst, JsonSerializer.Serialize(breakdown));\n            }\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Models/BusinessPlanInfo.cs",
      "sha256": "4a8d4603750b0630eec386cbb831948aaa2cc2f5872d4e1b178da2b9a6952bc7",
      "language": "csharp",
      "size": 1240,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\n\nnamespace xbytechat.api.Models.BusinessModel\n{\n    public class BusinessPlanInfo\n    {\n        [Key]\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        // üîó Foreign key to Business\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        [ForeignKey(nameof(BusinessId))]\n        public Business Business { get; set; }\n\n        // üì¶ Plan Management\n        [Required]\n        public PlanType Plan { get; set; } = PlanType.Trial; // Default Trial\n\n        [Required]\n        public int TotalMonthlyQuota { get; set; } = 100; // Default Trial Messages\n\n        [Required]\n        public int RemainingMessages { get; set; } = 100;\n\n        public DateTime QuotaResetDate { get; set; } = DateTime.UtcNow.AddMonths(1);\n\n        // üí∞ Wallet Management (optional)\n        public decimal WalletBalance { get; set; } = 0.00m;\n\n        // üìÖ Timestamps\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Models/PlanFeature.cs",
      "sha256": "af8483d1a28e7555f8111b552d2730fd4ef167d9ba562bebb508328248b01a12",
      "language": "csharp",
      "size": 687,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.PlanManagement.Models\n{\n    [Table(\"PlanFeatureMatrix\")]\n    public class PlanFeatureMatrix\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        [MaxLength(20)]\n        public string PlanName { get; set; } = string.Empty;  // \"Basic\", \"Smart\", \"Advance\"\n\n        [Required]\n        [MaxLength(50)]\n        public string FeatureName { get; set; } = string.Empty; // \"Contacts\", \"Catalog\", etc.\n\n        [Required]\n        public bool IsEnabled { get; set; }  // Default state for this plan-feature pair\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Models/PlanType.cs",
      "sha256": "52170542c11ff0a0e52b9f16289446106038cd266cd602169980aa1d684672ea",
      "language": "csharp",
      "size": 187,
      "content": "namespace xbytechat.api.Features.PlanManagement.Models\n{\n    public enum PlanType\n    {\n       \n        Basic = 0,\n        Smart = 1,\n        Advanced = 2,\n            Trial = 3,\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Services/IPlanManager.cs",
      "sha256": "69cb77d9f587d971ee0cc96bf3fa399d9982294045981db84e714050dc242d85",
      "language": "csharp",
      "size": 418,
      "content": "using xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.PlanManagement.Services\n{\n    public interface IPlanManager\n    {\n        /// <summary>\n        /// Checks if business has enough quota to send a message.\n        /// </summary>\n        Task<ResponseResult> CheckQuotaBeforeSendingAsync(Guid businessId);\n        Dictionary<string, bool> GetPlanFeatureMap(string plan);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Services/PlanManager.cs",
      "sha256": "707ec30ee3f48687b9eaae8569ef4c6152ca6dc7b72d2f8662687b3cec58f666",
      "language": "csharp",
      "size": 4252,
      "content": "// üìÑ Features/PlanManagement/Services/PlanManager.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Entitlements;\nusing xbytechat.api.Features.Entitlements.Services;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.PlanManagement.Services\n{\n    public class PlanManager : IPlanManager\n    {\n        private readonly AppDbContext _db;\n        private readonly IQuotaService _quota;\n\n        public PlanManager(AppDbContext db, IQuotaService quota)\n        {\n            _db = db;\n            _quota = quota;\n        }\n\n        /// <summary>\n        /// Check and CONSUME 1 unit of \"messages per month\" quota for this business.\n        /// If not allowed, returns a ResponseResult with a user-friendly error.\n        /// </summary>\n        public async Task<ResponseResult> CheckQuotaBeforeSendingAsync(Guid businessId)\n        {\n            // Load plan info for better error messaging (Trial vs Paid)\n            var business = await _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (business is null)\n            {\n                return ResponseResult.ErrorInfo(\n                    \"Business not found.\",\n                    \"Invalid business ID in CheckQuotaBeforeSendingAsync.\");\n            }\n\n            var planType = business.BusinessPlanInfo?.Plan ?? PlanType.Trial;\n\n            // Use the generic quota engine\n            var result = await _quota.CheckAndConsumeAsync(\n                businessId,\n                QuotaKeys.MessagesPerMonth,\n                amount: 1,\n                ct: CancellationToken.None);\n\n            if (!result.Allowed)\n            {\n                // 1) Prefer denial text coming from PlanQuotas / overrides\n                var userMessage = !string.IsNullOrWhiteSpace(result.Message)\n                    ? result.Message!\n                    // 2) Fallback to your old behavior\n                    : planType == PlanType.Trial\n                        ? \"Trial limit reached. Please upgrade your plan.\"\n                        : \"Monthly message quota exhausted. Please upgrade or wait for reset.\";\n\n                return ResponseResult.ErrorInfo(\n                    userMessage,\n                    $\"Quota exceeded for {QuotaKeys.MessagesPerMonth}\");\n            }\n\n            // OK ‚Üí caller (message send service) can proceed to send\n            return ResponseResult.SuccessInfo(\"Quota check passed.\");\n        }\n\n        /// <summary>\n        /// Legacy feature map per plan.\n        /// You can keep this for now; later we can align it with Permission/Entitlements.\n        /// </summary>\n        public Dictionary<string, bool> GetPlanFeatureMap(string plan)\n        {\n            // Keep your previous behavior here.\n            // If your old code had slightly different maps, just plug them in.\n\n            switch (plan?.Trim().ToLowerInvariant())\n            {\n                case \"basic\":\n                    return new Dictionary<string, bool>\n                    {\n                        { \"CATALOG\", true },\n                        { \"MESSAGE_SEND\", true },\n                        { \"CRM_NOTES\", true },\n                        { \"CRM_TAGS\", true }\n                    };\n\n                case \"smart\":\n                    return new Dictionary<string, bool>\n                    {\n                        { \"CATALOG\", true },\n                        { \"MESSAGE_SEND\", true },\n                        { \"CRM_NOTES\", true },\n                        { \"CRM_TAGS\", true }\n                    };\n\n                case \"advanced\":\n                    return new Dictionary<string, bool>\n                    {\n                        { \"CATALOG\", true },\n                        { \"MESSAGE_SEND\", true },\n                        { \"CRM_NOTES\", true },\n                        { \"CRM_TAGS\", true }\n                    };\n\n                default:\n                    return new Dictionary<string, bool>();\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/ReportingModule/Controllers/MessageAnalyticsController.cs",
      "sha256": "99dc4aa00c1bae7339a4b7cf1c00c7946b5aebeb41f493a46adb22e6d15af298",
      "language": "csharp",
      "size": 1238,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.ReportingModule.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.ReportingModule.Controllers\n{\n    [ApiController]\n    [Authorize] // ‚úÖ add this\n    [Route(\"api/reporting/messages\")]\n    public class MessageAnalyticsController : ControllerBase\n    {\n        private readonly IMessageAnalyticsService _service;\n\n        public MessageAnalyticsController(IMessageAnalyticsService service)\n        {\n            _service = service;\n        }\n\n        [HttpGet(\"recent\")]\n        public async Task<IActionResult> GetRecentLogs([FromQuery] int limit = 20)\n        {\n            var businessId = User.GetBusinessId();\n            var logs = await _service.GetRecentLogsAsync(businessId, limit);\n            return Ok(new { success = true, data = logs });\n        }\n\n        [HttpGet(\"history\")]\n        public async Task<IActionResult> GetPaginatedLogs([FromQuery] PaginatedRequest request)\n        {\n            var businessId = User.GetBusinessId();\n            var result = await _service.GetPaginatedLogsAsync(businessId, request);\n            return Ok(new { success = true, data = result });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/ReportingModule/DTOs/DirectMessageLogFilterDto.cs",
      "sha256": "e8f948d0367820dd6dce43d8c057e8bfe7a65889ab2eb6361f062de66d36922b",
      "language": "csharp",
      "size": 293,
      "content": "namespace xbytechat.api.Features.ReportingModule.DTOs\n{\n    public class DirectMessageLogFilterDto\n\n    {\n        public int Page { get; set; } = 1;\n        public int PageSize { get; set; } = 10;\n        public string? Status { get; set; }\n        public string? Search { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/ReportingModule/DTOs/RecentMessageLogDto.cs",
      "sha256": "f86a239c42fefe2d63c5087c403a7c2cc1e2eea942cc1443bd03495783bbb2f4",
      "language": "csharp",
      "size": 586,
      "content": "// üìÑ File: Features/ReportingModule/DTOs/RecentMessageLogDto.cs\nusing System;\n\nnamespace xbytechat.api.Features.ReportingModule.DTOs\n{\n    public class RecentMessageLogDto\n    {\n        public Guid Id { get; set; }\n        public string RecipientNumber { get; set; }\n        public string MessageContent { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public DateTime? SentAt { get; set; }             \n        public Guid? CampaignId { get; set; }\n        public string? Status { get; set; }\n        public string? ErrorMessage { get; set; }         \n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/ReportingModule/Services/IMessageAnalyticsService.cs",
      "sha256": "08c8fb19a092bb252492d04c2114547e4ca4a5725875accb403182551c8229f4",
      "language": "csharp",
      "size": 536,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.ReportingModule.DTOs;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.ReportingModule.Services\n{\n    public interface IMessageAnalyticsService\n    {\n        Task<List<RecentMessageLogDto>> GetRecentLogsAsync(Guid businessId, int limit);\n        Task<PaginatedResponse<RecentMessageLogDto>> GetPaginatedLogsAsync(Guid businessId, PaginatedRequest request);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/ReportingModule/Services/MessageAnalyticsService.cs",
      "sha256": "3a87316fa63b4890a5bc35b2d867a96a2a7d73e8aea0e52ff6854e89c4245b7a",
      "language": "csharp",
      "size": 2844,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.ReportingModule.DTOs;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.ReportingModule.Services\n{\n    public class MessageAnalyticsService : IMessageAnalyticsService\n    {\n        private readonly AppDbContext _context;\n\n        public MessageAnalyticsService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        public async Task<List<RecentMessageLogDto>> GetRecentLogsAsync(Guid businessId, int limit)\n        {\n            return await _context.MessageLogs\n                .Where(x => x.BusinessId == businessId)\n                .OrderByDescending(x => x.CreatedAt)\n                .Take(limit)\n                .Select(x => new RecentMessageLogDto\n                {\n                    Id = x.Id,\n                    RecipientNumber = x.RecipientNumber,\n                    MessageContent = x.MessageContent,\n                    CreatedAt = x.CreatedAt,\n                    CampaignId = x.CampaignId,\n                    Status = x.Status,\n                    SentAt = x.SentAt,\n                })\n                .ToListAsync();\n        }\n\n        public async Task<PaginatedResponse<RecentMessageLogDto>> GetPaginatedLogsAsync(Guid businessId, PaginatedRequest request)\n        {\n            var query = _context.MessageLogs\n                .Where(x => x.BusinessId == businessId);\n\n            if (!string.IsNullOrEmpty(request.Status))\n                query = query.Where(x => x.Status == request.Status);\n\n            if (!string.IsNullOrEmpty(request.Search))\n                query = query.Where(x =>\n                    x.RecipientNumber.Contains(request.Search) ||\n                    x.MessageContent.Contains(request.Search));\n\n            var totalCount = await query.CountAsync();\n\n            var items = await query\n                .OrderByDescending(x => x.CreatedAt)\n                .Skip((request.Page - 1) * request.PageSize)\n                .Take(request.PageSize)\n                .Select(x => new RecentMessageLogDto\n                {\n                    Id = x.Id,\n                    RecipientNumber = x.RecipientNumber,\n                    MessageContent = x.MessageContent,\n                    CreatedAt = x.CreatedAt,\n                    CampaignId = x.CampaignId,\n                    Status = x.Status,\n                    SentAt = x.SentAt,\n                })\n                .ToListAsync();\n\n            return new PaginatedResponse<RecentMessageLogDto>\n            {\n                Items = items,\n                TotalCount = totalCount,\n                Page = request.Page,\n                PageSize = request.PageSize\n            };\n        }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/Controllers/TeamStaffController.cs",
      "sha256": "82b0a88218a8dd1335798aa98d26d68be43883df3c8cfc28aa1f4745c3d32ee7",
      "language": "csharp",
      "size": 4700,
      "content": "using System;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TeamStaff.DTOs;\nusing xbytechat.api.Features.TeamStaff.Services;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.TeamStaff.Controllers\n{\n    \n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    //[Authorize(Policy = Policies.AdminOrOwner)]\n    public sealed class TeamStaffController : ControllerBase\n    {\n        private readonly ITeamStaffService _service;\n\n        public TeamStaffController(ITeamStaffService service)\n        {\n            _service = service;\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetStaff()\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var rows = await _service.GetStaffAsync(businessId.Value);\n            return Ok(ResponseResult.SuccessInfo(\"‚úÖ Staff list fetched.\", rows));\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> CreateStaff([FromBody] CreateStaffUserDto dto)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.CreateStaffAsync(businessId.Value, actorUserId.Value, dto);\n            return Ok(result);\n        }\n\n        [HttpPut(\"{id:guid}\")]\n        public async Task<IActionResult> UpdateStaff([FromRoute] Guid id, [FromBody] UpdateStaffUserDto dto)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.UpdateStaffAsync(businessId.Value, actorUserId.Value, id, dto);\n            return Ok(result);\n        }\n\n        [HttpPost(\"{id:guid}/activate\")]\n        public async Task<IActionResult> Activate([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.SetStatusAsync(businessId.Value, actorUserId.Value, id, \"Active\");\n            return Ok(result);\n        }\n\n        [HttpPost(\"{id:guid}/deactivate\")]\n        public async Task<IActionResult> Deactivate([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.SetStatusAsync(businessId.Value, actorUserId.Value, id, \"Hold\");\n            return Ok(result);\n        }\n\n        // ---- helpers ----\n\n        private Guid? GetBusinessId()\n        {\n            // You store both \"BusinessId\" and \"businessId\" in JWT.\n            var raw = User.FindFirstValue(\"BusinessId\") ?? User.FindFirstValue(\"businessId\");\n            if (Guid.TryParse(raw, out var id)) return id;\n            return null;\n        }\n\n        private Guid? GetUserId()\n        {\n            var raw = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? User.FindFirstValue(\"id\");\n            if (Guid.TryParse(raw, out var id)) return id;\n            return null;\n        }\n        [HttpGet(\"roles\")]\n        public async Task<IActionResult> GetAssignableRoles()\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var rows = await _service.GetAssignableRolesAsync(businessId.Value);\n            return Ok(ResponseResult.SuccessInfo(\"‚úÖ Roles fetched.\", rows));\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/AssignableRoleDto.cs",
      "sha256": "e83c65aae9de7a12d45b7cb6a32fa24164a31849fe654cd2ddc84ea0796a5bf6",
      "language": "csharp",
      "size": 305,
      "content": "using System;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Minimal role payload for dropdowns (TeamStaff).\n    /// </summary>\n    public sealed class AssignableRoleDto\n    {\n        public Guid Id { get; set; }\n        public string Name { get; set; } = \"unknown\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/CreateStaffUserDto.cs",
      "sha256": "dd29d80a5bcba26dd3115e9141dde09804f5d9ecb68d95a92909c0e5db0c35bb",
      "language": "csharp",
      "size": 941,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Create a staff user under the current Business.\n    /// </summary>\n    public sealed class CreateStaffUserDto\n    {\n        [Required]\n        [MinLength(2)]\n        public string Name { get; set; } = string.Empty;\n\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Raw password (MVP). We will hash it using the same SHA256 strategy as AuthService.\n        /// Future enhancement: switch to BCrypt/Identity.\n        /// </summary>\n        [Required]\n        [MinLength(6)]\n        public string Password { get; set; } = string.Empty;\n\n        /// <summary>\n        /// RoleId for the staff user (e.g., agent/staff/manager role).\n        /// </summary>\n        [Required]\n        public Guid RoleId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/StaffUserDto.cs",
      "sha256": "0b71f0d1eeade902964f6d6820063b1d349d48a7fdfa79faf68b28995ff5d80f",
      "language": "csharp",
      "size": 627,
      "content": "using System;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Staff user list item for UI.\n    /// </summary>\n    public sealed class StaffUserDto\n    {\n        public Guid Id { get; set; }\n        public Guid? BusinessId { get; set; }\n\n        public string Name { get; set; } = string.Empty;\n        public string Email { get; set; } = string.Empty;\n\n        public Guid? RoleId { get; set; }\n        public string RoleName { get; set; } = \"unknown\";\n\n        public string Status { get; set; } = \"Pending\"; // Active/Hold/Rejected/Pending\n        public DateTime CreatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/UpdateStaffUserDto.cs",
      "sha256": "00f1dc5e620c16d55d5cb3b57e4ef0625462cda323b71cd8a47db0c439d8e827",
      "language": "csharp",
      "size": 459,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Update staff details (name + role). Status toggles are handled by dedicated endpoints.\n    /// </summary>\n    public sealed class UpdateStaffUserDto\n    {\n        [Required]\n        [MinLength(2)]\n        public string Name { get; set; } = string.Empty;\n\n        [Required]\n        public Guid RoleId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/Services/ITeamStaffService.cs",
      "sha256": "4574984d0c1ef8b4e03b07aac1241385fb3be2a205fec8d400d4c1a901142c23",
      "language": "csharp",
      "size": 755,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.TeamStaff.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.TeamStaff.Services\n{\n    public interface ITeamStaffService\n    {\n        Task<List<StaffUserDto>> GetStaffAsync(Guid businessId);\n\n        Task<ResponseResult> CreateStaffAsync(Guid businessId, Guid actorUserId, CreateStaffUserDto dto);\n\n        Task<ResponseResult> UpdateStaffAsync(Guid businessId, Guid actorUserId, Guid staffUserId, UpdateStaffUserDto dto);\n\n        Task<ResponseResult> SetStatusAsync(Guid businessId, Guid actorUserId, Guid staffUserId, string newStatus);\n        Task<List<AssignableRoleDto>> GetAssignableRolesAsync(Guid businessId);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/Services/TeamStaffService.cs",
      "sha256": "579c36903a51301718057899a6dc71411af122ea62b80b06d8bfb70de38e3a83",
      "language": "csharp",
      "size": 8420,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.TeamStaff.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.TeamStaff.Services\n{\n    /// <summary>\n    /// Business-scoped staff management using the existing Users table.\n    /// Staff users = Users with BusinessId set + Role assigned.\n    /// </summary>\n    public sealed class TeamStaffService : ITeamStaffService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<TeamStaffService> _logger;\n\n        public TeamStaffService(AppDbContext db, ILogger<TeamStaffService> logger)\n        {\n            _db = db;\n            _logger = logger;\n        }\n\n        public async Task<List<StaffUserDto>> GetStaffAsync(Guid businessId)\n        {\n            var rows = await _db.Users\n                .AsNoTracking()\n                .Where(u => u.BusinessId == businessId && !u.IsDeleted)\n                .Include(u => u.Role)\n                .OrderByDescending(u => u.CreatedAt)\n                .Select(u => new StaffUserDto\n                {\n                    Id = u.Id,\n                    BusinessId = u.BusinessId,\n                    Name = u.Name,\n                    Email = u.Email,\n                    RoleId = u.RoleId,\n                    RoleName = (u.Role != null && u.Role.Name != null) ? u.Role.Name : \"unknown\",\n                    Status = u.Status ?? \"unknown\",\n                    CreatedAt = u.CreatedAt\n                })\n                .ToListAsync();\n\n            return rows;\n        }\n\n        public async Task<ResponseResult> CreateStaffAsync(Guid businessId, Guid actorUserId, CreateStaffUserDto dto)\n        {\n            // Basic duplicate protection (DB unique index is still recommended)\n            var email = (dto.Email ?? \"\").Trim().ToLowerInvariant();\n\n            var exists = await _db.Users\n                .AnyAsync(u => !u.IsDeleted && ((u.Email ?? \"\").ToLower() == email));\n\n            if (exists)\n                return ResponseResult.ErrorInfo(\"‚ùå A user with this email already exists.\");\n\n            // ‚úÖ Ensure role is assignable INSIDE THIS BUSINESS\n            var (ok, role, err) = await TryGetAssignableRoleAsync(businessId, dto.RoleId);\n            if (!ok)\n                return err!;\n\n            var user = new User\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                Name = dto.Name?.Trim() ?? \"\",\n                Email = email,\n                PasswordHash = HashPassword(dto.Password),\n                RoleId = role!.Id,\n                Status = \"Active\",          // ‚úÖ Staff should be immediately usable\n                CreatedAt = DateTime.UtcNow,\n                IsDeleted = false\n            };\n\n            _db.Users.Add(user);\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"‚úÖ Staff user created. StaffUserId={StaffUserId}, BusinessId={BusinessId}, ActorUserId={ActorUserId}\",\n                user.Id, businessId, actorUserId);\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Staff user created successfully.\", new { user.Id });\n        }\n\n        public async Task<ResponseResult> UpdateStaffAsync(Guid businessId, Guid actorUserId, Guid staffUserId, UpdateStaffUserDto dto)\n        {\n            var user = await _db.Users\n                .Include(u => u.Role)\n                .FirstOrDefaultAsync(u => u.Id == staffUserId && u.BusinessId == businessId && !u.IsDeleted);\n\n            if (user == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Staff user not found.\");\n\n            // Prevent editing yourself via staff screen (avoid self-lockout edge cases)\n            if (staffUserId == actorUserId)\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot edit your own account from TeamStaff.\");\n\n            // Prevent changing a business-owner account (role \"business\") via staff UI\n            var currentRoleName = (user.Role?.Name ?? \"\").Trim().ToLowerInvariant();\n            if (currentRoleName == \"business\")\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot modify the Business Owner from TeamStaff.\");\n\n            // ‚úÖ Ensure new role is assignable INSIDE THIS BUSINESS\n            var (ok, newRole, err) = await TryGetAssignableRoleAsync(businessId, dto.RoleId);\n            if (!ok)\n                return err!;\n\n            user.Name = dto.Name?.Trim() ?? user.Name;\n            user.RoleId = newRole!.Id;\n\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"‚úÖ Staff user updated. StaffUserId={StaffUserId}, BusinessId={BusinessId}, ActorUserId={ActorUserId}\",\n                staffUserId, businessId, actorUserId);\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Staff user updated successfully.\");\n        }\n\n        public async Task<ResponseResult> SetStatusAsync(Guid businessId, Guid actorUserId, Guid staffUserId, string newStatus)\n        {\n            var normalized = (newStatus ?? \"\").Trim();\n            if (normalized is not (\"Active\" or \"Hold\"))\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid status. Allowed: Active, Hold.\");\n\n            var user = await _db.Users\n                .Include(u => u.Role)\n                .FirstOrDefaultAsync(u => u.Id == staffUserId && u.BusinessId == businessId && !u.IsDeleted);\n\n            if (user == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Staff user not found.\");\n\n            if (staffUserId == actorUserId)\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot change your own status.\");\n\n            var roleName = (user.Role?.Name ?? \"\").Trim().ToLowerInvariant();\n            if (roleName == \"business\")\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot deactivate the Business Owner.\");\n\n            user.Status = normalized;\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"‚úÖ Staff status updated. StaffUserId={StaffUserId}, NewStatus={NewStatus}, BusinessId={BusinessId}, ActorUserId={ActorUserId}\",\n                staffUserId, normalized, businessId, actorUserId);\n\n            return ResponseResult.SuccessInfo($\"‚úÖ Staff user status updated to {normalized}.\");\n        }\n\n        public async Task<List<AssignableRoleDto>> GetAssignableRolesAsync(Guid businessId)\n        {\n            // only business-scoped roles for that business\n            var roles = await _db.Roles\n                .AsNoTracking()\n                .Where(r => r.IsActive && r.BusinessId == businessId)\n                .OrderBy(r => r.Name)\n                .Select(r => new AssignableRoleDto\n                {\n                    Id = r.Id,\n                    Name = r.Name\n                })\n                .ToListAsync();\n\n            return roles;\n        }\n\n        /// <summary>\n        /// ‚úÖ Central guard: role must belong to this business and be active.\n        /// Also blocks admin-type roles from being assigned via TeamStaff.\n        /// </summary>\n        private async Task<(bool Ok, Role? Role, ResponseResult? Error)> TryGetAssignableRoleAsync(Guid businessId, Guid roleId)\n        {\n            // ‚úÖ IMPORTANT: role must be scoped to the same business\n            var role = await _db.Roles\n                .AsNoTracking()\n                .FirstOrDefaultAsync(r => r.Id == roleId && r.IsActive && r.BusinessId == businessId);\n\n            if (role == null)\n                return (false, null, ResponseResult.ErrorInfo(\"‚ùå Invalid role selected.\"));\n\n            var roleName = (role.Name ?? \"\").Trim().ToLowerInvariant();\n            if (roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\")\n                return (false, null, ResponseResult.ErrorInfo(\"‚ùå You cannot assign an admin-type role from TeamStaff.\"));\n\n            return (true, role, null);\n        }\n\n        // üîí MVP hashing (same as AuthService)\n        private static string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password ?? \"\");\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/IMetaCredentialsResolver.cs",
      "sha256": "4a78a5a1759d8a82f7dbacdab0ba713c7c388ee66789f7c401a0c81fe0afb7a7",
      "language": "csharp",
      "size": 553,
      "content": "namespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic sealed record MetaCredentials(\n    string AccessToken,\n    string GraphBaseUrl,\n    string GraphVersion,\n    string WabaId,\n    string? PhoneNumberId\n);\n\npublic interface IMetaCredentialsResolver\n{\n    /// <summary>\n    /// Resolve access token, graph base/version, and WABA ID for a business.\n    /// Implement this by reading your WhatsAppSettings (active provider row).\n    /// </summary>\n    Task<MetaCredentials> ResolveAsync(Guid businessId, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/IMetaTemplateClient.cs",
      "sha256": "cfaaa859e011696a5cf1a997f52cd5f1731ab7cf8f33aa18971da6e5ba243c39",
      "language": "csharp",
      "size": 841,
      "content": "namespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface IMetaTemplateClient\n{\n    Task<string> UploadMediaAsync(Guid businessId, string localPathOrUrl, string mediaType, CancellationToken ct = default);\n    Task<MetaTemplateCallResult> CreateTemplateAsync(Guid businessId, string name, string category, string language, object componentsPayload, object examplesPayload, CancellationToken ct = default);\n    Task<int> SyncTemplatesAsync(Guid businessId, CancellationToken ct = default);\n    Task<bool> DeleteTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default);\n    Task<(Stream? ValidStream, string? ContentType)> GetMediaStreamAsync(Guid businessId, string mediaId, CancellationToken ct = default);\n}\n\npublic sealed record MetaTemplateCallResult(bool Success, string? Error);\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/IMetaUploadService.cs",
      "sha256": "8349b79165a2ffc86bfbcca62c8a50cfa8eb88b657fe228844b1ed182413e150",
      "language": "csharp",
      "size": 846,
      "content": "namespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic enum HeaderMediaType { IMAGE, VIDEO, DOCUMENT }\n\npublic sealed record HeaderUploadResult(\n    string Handle,        // raw handle, e.g. \"4::abc...\"\n    string MimeType,\n    long SizeBytes,\n    bool IsStub         // true if returned by stub mode\n);\n\npublic interface IMetaUploadService\n{\n    /// <summary>\n    /// Upload a header media to Meta (resumable) and return the asset handle.\n    /// If sourceUrl is provided, the service will download and upload it.\n    /// Exactly one of (fileStream, sourceUrl) must be provided.\n    /// </summary>\n    Task<HeaderUploadResult> UploadHeaderAsync(\n        Guid businessId,\n        HeaderMediaType mediaType,\n        Stream? fileStream,\n        string? fileName,\n        string? sourceUrl,\n        CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateDraftLifecycleService.cs",
      "sha256": "ab5c47b3585f770b75c95da28772c071469bef04a4e5f866c5ca078b64bc5d64",
      "language": "csharp",
      "size": 611,
      "content": "using xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateDraftLifecycleService\n{\n    Task<TemplateDraft> DuplicateDraftAsync(Guid businessId, Guid draftId, string newKey, CancellationToken ct = default);\n    Task<bool> DeleteDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n\n    /// <summary>Delete an approved WhatsApp template at Meta and soft-delete it locally.</summary>\n    Task<bool> DeleteApprovedTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateDraftService.cs",
      "sha256": "ea5e827c0b4d12bb6477bd68960d49a762e3d8041d2cfc064ff401a57629963e",
      "language": "csharp",
      "size": 1455,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateDraftService\n{\n    Task<TemplateDraft> CreateDraftAsync(Guid businessId, TemplateDraftCreateDto dto, CancellationToken ct = default);\n    Task<TemplateDraft> UpdateDraftAsync(Guid businessId, Guid draftId, TemplateDraftUpdateDto dto, CancellationToken ct = default);\n    Task<TemplateDraftVariant> UpsertVariantAsync(Guid businessId, Guid draftId, TemplateDraftVariantUpsertDto dto, CancellationToken ct = default);\n    Task<bool> ValidateAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<TemplateDraft?> GetDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<IReadOnlyList<DraftListItemDto>> ListDraftsAsync(Guid businessId, CancellationToken ct = default);\n    Task<(bool ok, Dictionary<string, List<string>> errors)> ValidateAllAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<bool> SetHeaderHandleAsync(\n    Guid businessId,\n    Guid draftId,\n    string language,\n    string mediaType,          // IMAGE | VIDEO | DOCUMENT\n    string assetHandle,        // raw handle without \"handle:\" prefix\n    CancellationToken ct = default);\n    Task<TemplatePreviewDto?> GetPreviewAsync(\n        Guid businessId, Guid draftId, string language, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateLibraryService.cs",
      "sha256": "59834c407d151c75fa70b329cc653ad4f7cb19d09ffd90ed402976a1ab61f7a3",
      "language": "csharp",
      "size": 1208,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateLibraryService\n{\n    Task<IReadOnlyList<TemplateLibraryItem>> ListAsync(string? industry, CancellationToken ct = default);\n    Task<TemplateDraft> InstantiateDraftAsync(Guid businessId, Guid libraryItemId, IEnumerable<string> languages, CancellationToken ct = default);\n    Task<(TemplateLibraryItem item, List<TemplateLibraryVariant> variants)> GetItemAsync(\n               Guid libraryItemId,\n               CancellationToken ct = default);\n    Task<IReadOnlyList<string>> ListIndustriesAsync(CancellationToken ct = default);\n    //Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, CancellationToken ct = default);\n    Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, bool dryRun = false, CancellationToken ct = default);\n    Task<TemplateLibraryListResponse> SearchAsync(\n        string? industry, string? q, string? sort, int page, int pageSize, CancellationToken ct = default);\n    Task<LibraryImportRequest> ExportAsync(string? industry, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateStatusService.cs",
      "sha256": "deef6281241c55e436207d42dacf72b10bce5a23cfdfb994b0cb9897c51cfb65",
      "language": "csharp",
      "size": 681,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic sealed record TemplateStatusItemDto(\n    string LanguageCode,\n    string Status,\n    string? TemplateId,\n    DateTime? UpdatedAt,\n    DateTime? LastSyncedAt\n);\n\npublic interface ITemplateStatusService\n{\n    /// <summary>\n    /// Returns the Meta name derived from the draft key (the one used on submit)\n    /// and the per-language rows from WhatsAppTemplates for that business.\n    /// </summary>\n    Task<(string metaName, IReadOnlyList<TemplateStatusItemDto> items)> GetStatusAsync(\n        Guid businessId, Guid draftId, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateSubmissionService.cs",
      "sha256": "2d026f2801ec06397e4f2336c0cda4ca58d81982e6b5c90c897be5add9101b6f",
      "language": "csharp",
      "size": 354,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateSubmissionService\n{\n    Task<TemplateSubmitResponseDto> SubmitAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<int> SyncStatusAsync(Guid businessId, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Config/UploadLimitsOptions.cs",
      "sha256": "f28a32dae0610a85b8232509b1e012446a4639455bbe67bfa47490f26a626116",
      "language": "csharp",
      "size": 859,
      "content": "namespace xbytechat.api.Features.TemplateModule.Config;\n\npublic sealed class UploadLimitsOptions\n{\n    public long ImageMaxBytes { get; set; } = 10 * 1024 * 1024;    // 10 MB\n    public long VideoMaxBytes { get; set; } = 16 * 1024 * 1024;    // 16 MB\n    public long DocumentMaxBytes { get; set; } = 16 * 1024 * 1024; // 16 MB\n\n    public string[] AllowedImageMime { get; set; } = new[] { \"image/jpeg\", \"image/png\", \"image/webp\" };\n    public string[] AllowedVideoMime { get; set; } = new[] { \"video/mp4\", \"video/3gpp\" };\n    public string[] AllowedDocMime { get; set; } = new[] { \"application/pdf\" };\n\n    /// <summary>\n    /// If true, the upload service returns a generated fake handle instead of calling Meta.\n    /// Flip to false when you implement the real HTTP resumable flow.\n    /// </summary>\n    public bool UseStubHandle { get; set; } = false;\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateDraftsController.cs",
      "sha256": "aedbf9d6ab23be1915df8e5d4f9a83df9b657c7788bd915c051439c621e9a28b",
      "language": "csharp",
      "size": 15324,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Validators;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.TemplateModule.Services; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers;\n\n[ApiController]\n[Route(\"api/template-builder\")]\n[Authorize]\npublic sealed class TemplateDraftsController : ControllerBase\n{\n    private readonly ITemplateDraftService _drafts;\n    private readonly ITemplateSubmissionService _submitter;\n    private readonly ITemplateNameCheckService _nameCheck;\n    private readonly ITemplateStatusService _status;\n\n    private readonly ITemplateDraftLifecycleService _lifecycle;\n    private readonly IMetaTemplateClient _meta;\n\n    public TemplateDraftsController(\n        ITemplateDraftService drafts,\n        ITemplateSubmissionService submitter,\n        ITemplateNameCheckService nameCheck,\n        ITemplateStatusService status,\n        ITemplateDraftLifecycleService lifecycle,\n        IMetaTemplateClient meta)\n    {\n        _drafts = drafts;\n        _submitter = submitter;\n        _status = status;\n        _nameCheck = nameCheck;\n        _lifecycle = lifecycle;\n        _meta = meta;\n    }\n\n    // POST /api/template-builder/drafts\n    [HttpPost(\"drafts\")]\n    public async Task<ActionResult<object>> CreateDraft([FromBody] TemplateDraftCreateDto dto, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (dto is null)\n            return BadRequest(new { success = false, message = \"Body required\" });\n\n        if (string.IsNullOrWhiteSpace(dto.Key))\n            return BadRequest(new { success = false, message = \"Key is required.\" });\n\n        try\n        {\n            var draft = await _drafts.CreateDraftAsync(businessId, dto, ct);\n            return CreatedAtAction(nameof(GetDraft), new { draftId = draft.Id }, new\n            {\n                success = true,\n                message = \"Draft created.\",\n                draftId = draft.Id,\n                key = draft.Key,\n                category = draft.Category,\n                defaultLanguage = draft.DefaultLanguage\n            });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return Conflict(new { success = false, message = ex.Message });\n        }\n    }\n\n    // GET /api/template-builder/drafts\n    [HttpGet(\"drafts\")]\n    public async Task<ActionResult<object>> ListDrafts(CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        var items = await _drafts.ListDraftsAsync(businessId, ct);\n        return Ok(new\n        {\n            success = true,\n            message = \"Drafts loaded.\",\n            businessId,\n            count = items.Count,\n            items\n        });\n    }\n\n    // GET /api/template-builder/drafts/{draftId}\n    [HttpGet(\"drafts/{draftId:guid}\")]\n    public async Task<ActionResult<object>> GetDraft(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        var draft = await _drafts.GetDraftAsync(businessId, draftId, ct);\n        if (draft is null)\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n\n        return Ok(new\n        {\n            success = true,\n            message = \"Draft loaded.\",\n            draft\n        });\n    }\n\n    // PATCH /api/template-builder/drafts/{draftId}\n    [HttpPatch(\"drafts/{draftId:guid}\")]\n    [HttpPut(\"drafts/{draftId:guid}\")]\n    public async Task<ActionResult<object>> UpdateDraft(Guid draftId, [FromBody] TemplateDraftUpdateDto dto, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        if (dto is null)\n            return BadRequest(new { success = false, message = \"Body required\" });\n\n        try\n        {\n            var updated = await _drafts.UpdateDraftAsync(businessId, draftId, dto, ct);\n            return Ok(new\n            {\n                success = true,\n                message = \"Draft updated.\",\n                draft = new { updated.Id, updated.Key, updated.Category, updated.DefaultLanguage, updated.UpdatedAt }\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // POST /api/template-builder/drafts/{draftId}/variants\n    [HttpPost(\"drafts/{draftId:guid}/variants\")]\n    public async Task<ActionResult<object>> UpsertVariant(Guid draftId, [FromBody] TemplateDraftVariantUpsertDto dto, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        if (dto is null)\n            return BadRequest(new { success = false, message = \"Body required\" });\n\n        if (string.IsNullOrWhiteSpace(dto.Language)) dto.Language = \"en_US\";\n        if (string.IsNullOrWhiteSpace(dto.HeaderType)) dto.HeaderType = \"NONE\";\n\n        try\n        {\n            var variant = await _drafts.UpsertVariantAsync(businessId, draftId, dto, ct);\n            return Accepted(new\n            {\n                success = true,\n                message = \"Variant saved.\",\n                draftId,\n                language = variant.Language\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // POST /api/template-builder/drafts/{draftId}/validate\n    // Validation endpoint stays payload-only (single variant)\n    [HttpPost(\"drafts/{draftId:guid}/validate\")]\n    public ActionResult<object> Validate(Guid draftId, [FromBody] TemplateDraftVariantUpsertDto body)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        if (body is null)\n            return BadRequest(new { success = false, message = \"Body required.\" });\n\n        var result = VariantValidator.Validate(body);\n        return Ok(new\n        {\n            success = result.Ok,\n            message = result.Ok ? \"Validation passed.\" : \"Validation failed.\",\n            businessId,\n            draftId,\n            errors = result.Errors\n        });\n    }\n\n    // POST /api/template-builder/drafts/{draftId}/validate-all\n    [HttpPost(\"drafts/{draftId:guid}/validate-all\")]\n    public async Task<ActionResult<object>> ValidateAll(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        var (ok, errors) = await _drafts.ValidateAllAsync(businessId, draftId, ct);\n\n        return Ok(new\n        {\n            success = ok,\n            message = ok\n                ? \"All language variants are valid and consistent.\"\n                : \"Validation failed for one or more languages.\",\n            draftId,\n            errors\n        });\n    }\n\n    // POST /api/template-builder/drafts/{draftId}/submit\n    [HttpPost(\"drafts/{draftId:guid}/submit\")]\n    public async Task<ActionResult<object>> Submit(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        var resp = await _submitter.SubmitAsync(businessId, draftId, ct);\n        if (!resp.Success)\n            return BadRequest(resp);\n\n        return Accepted(resp);\n    }\n\n    // GET /api/template-builder/drafts/{draftId}/status\n    [HttpGet(\"drafts/{draftId:guid}/status\")]\n    public async Task<ActionResult<object>> GetStatus(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        try\n        {\n            var (metaName, items) = await _status.GetStatusAsync(businessId, draftId, ct);\n            return Ok(new\n            {\n                success = true,\n                message = items.Count == 0\n                    ? \"No synced rows yet. Try again later.\"\n                    : \"Latest status from WhatsAppTemplates.\",\n                draftId,\n                name = metaName,\n                items\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n        }\n    }\n\n    // ‚úÖ FIXED ROUTE:\n    // GET /api/template-builder/drafts/{draftId}/preview?language=en_US\n    [HttpGet(\"drafts/{draftId:guid}/preview\")]\n    public async Task<ActionResult<object>> Preview(Guid draftId, [FromQuery] string language, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        if (string.IsNullOrWhiteSpace(language))\n            return BadRequest(new { success = false, message = \"language is required.\" });\n\n        var dto = await _drafts.GetPreviewAsync(businessId, draftId, language, ct);\n        if (dto is null)\n            return NotFound(new { success = false, message = \"Draft or language variant not found.\" });\n\n        return Ok(new { success = true, preview = dto });\n    }\n\n    // GET /api/template-builder/media/{mediaId}\n    [HttpGet(\"media/{**mediaId}\")]\n    public async Task<IActionResult> ProxyMedia(string mediaId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (string.IsNullOrWhiteSpace(mediaId))\n             return BadRequest(\"Media ID required.\");\n\n        var (stream, contentType) = await _meta.GetMediaStreamAsync(businessId, mediaId, ct);\n        if (stream == null)\n             return NotFound();\n\n        return File(stream, contentType ?? \"application/octet-stream\");\n    }\n\n    // GET /api/template-builder/drafts/{draftId}/name-check?language=en_US\n    [HttpGet(\"drafts/{draftId:guid}/name-check\")]\n    public async Task<ActionResult<object>> NameCheck(Guid draftId, [FromQuery] string? language, CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId();\n        var lang = string.IsNullOrWhiteSpace(language) ? \"en_US\" : language;\n\n        var result = await _nameCheck.CheckAsync(businessId, draftId, lang, ct);\n        if (result is null)\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n\n        return Ok(new\n        {\n            success = true,\n            name = result.Name,\n            available = result.Available,\n            suggestion = result.Suggestion,\n            language = result.Language,\n            draftId = result.DraftId\n        });\n    }\n\n    public sealed record DuplicateDraftRequest(string Key);\n\n    // POST /api/template-builder/drafts/{draftId}/duplicate\n    [HttpPost(\"drafts/{draftId:guid}/duplicate\")]\n    public async Task<ActionResult<object>> Duplicate(\n        Guid draftId,\n        [FromBody] DuplicateDraftRequest request,\n        CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId();\n        if (request is null || string.IsNullOrWhiteSpace(request.Key))\n            return BadRequest(new { success = false, message = \"New template name is required.\" });\n\n        try\n        {\n            var dup = await _lifecycle.DuplicateDraftAsync(businessId, draftId, request.Key, ct);\n            return Ok(new { success = true, draftId = dup.Id, key = dup.Key });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return Conflict(new { success = false, message = ex.Message });\n        }\n        catch (ArgumentException ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // DELETE /api/template-builder/drafts/{draftId}\n    [HttpDelete(\"drafts/{draftId:guid}\")]\n    public async Task<ActionResult<object>> Delete(Guid draftId, CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId();\n        var ok = await _lifecycle.DeleteDraftAsync(businessId, draftId, ct);\n        if (!ok) return NotFound(new { success = false, message = \"Draft not found.\" });\n        return Ok(new { success = true });\n    }\n\n    // DELETE /api/template-builder/templates/{name}?language=en_US\n    [HttpDelete(\"~/api/template-builder/templates/{name}\")]\n    public async Task<ActionResult<object>> DeleteApprovedTemplate(\n        [FromRoute] string name,\n        [FromQuery] string language = \"en_US\",\n        CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId();\n        if (string.IsNullOrWhiteSpace(name))\n            return BadRequest(new { success = false, message = \"Template name is required.\" });\n\n        var ok = await _lifecycle.DeleteApprovedTemplateAsync(businessId, name, language, ct);\n        return Ok(new { success = ok, name, language });\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateLibraryAdminController.cs",
      "sha256": "0247de08701765cef198ea2eec0de87320ad519b5d362d7ef0a437acd39733a6",
      "language": "csharp",
      "size": 2836,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/admin/template-builder/library\")] // <-- unique admin prefix (no conflict with public controller)\n    [Authorize]                                    // add policy/roles as needed\n    [Produces(\"application/json\")]\n    public sealed class TemplateLibraryAdminController : ControllerBase\n    {\n        private readonly ITemplateLibraryService _library;\n\n        public TemplateLibraryAdminController(ITemplateLibraryService library)\n        {\n            _library = library;\n        }\n\n        // POST /api/admin/template-builder/library/import?dryRun=true\n        [HttpPost(\"import\")]\n        public async Task<ActionResult<object>> Import(\n            [FromBody] LibraryImportRequest request,\n            [FromQuery] bool dryRun = false,\n            CancellationToken ct = default)\n        {\n            if (request is null || request.Items is null)\n                return BadRequest(new { success = false, message = \"Invalid request payload.\" });\n\n            // If you want admin-only: [Authorize(Policy = \"templates.library.import\")] at class or action level.\n\n            var result = await _library.ImportAsync(request, dryRun, ct);\n\n            return Ok(new\n            {\n                success = result.Success,\n                dryRun,\n                result.TotalItems,\n                result.CreatedItems,\n                result.UpdatedItems,\n                result.CreatedVariants,\n                result.UpdatedVariants,\n                errors = result.Errors\n            });\n        }\n\n        // GET /api/admin/template-builder/library/browse?industry=...&q=...&sort=name&page=1&pageSize=20\n        [HttpGet(\"browse\")]\n        public async Task<ActionResult<object>> Browse(\n            [FromQuery] string? industry,\n            [FromQuery] string? q,\n            [FromQuery] string? sort,\n            [FromQuery] int page = 1,\n            [FromQuery] int pageSize = 20,\n            CancellationToken ct = default)\n        {\n            var resp = await _library.SearchAsync(industry, q, sort, page, pageSize, ct);\n            return Ok(resp);\n        }\n\n        // GET /api/admin/template-builder/library/export?industry=SALON\n        [HttpGet(\"export\")]\n        public async Task<ActionResult<object>> Export([FromQuery] string? industry, CancellationToken ct = default)\n        {\n            var payload = await _library.ExportAsync(industry, ct);\n            return Ok(new\n            {\n                success = true,\n                count = payload.Items.Count,\n                items = payload.Items\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateLibraryController.cs",
      "sha256": "dc4dac5078ca00d398e2b6236453602fe0a332d658da7dbef1ccb365366a2cc5",
      "language": "csharp",
      "size": 9186,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat_api.WhatsAppSettings.Services; // User.GetBusinessId()\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers;\n\n[ApiController]\n[Route(\"api/template-builder/library\")]\n[Authorize]\n[Produces(\"application/json\")]\npublic sealed class TemplateLibraryController : ControllerBase\n{\n    private readonly ITemplateLibraryService _library;\n\n    public TemplateLibraryController(ITemplateLibraryService library)\n    {\n        _library = library;\n    }\n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // Legacy, simple list (kept under /list to avoid collision with /browse)\n    // GET /api/template-builder/library/list?industry=SALON\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    [HttpGet(\"list\")]\n    public async Task<ActionResult<object>> List([FromQuery] string? industry, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        var items = await _library.ListAsync(industry, ct);\n\n        return Ok(new\n        {\n            success = true,\n            message = \"Library loaded.\",\n            businessId,\n            count = items.Count,\n            items = items.Select(i => new { i.Id, i.Industry, i.Key, i.Category, i.IsFeatured })\n        });\n    }\n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // New, paged & searchable browse endpoint used by the UI\n    // GET /api/template-builder/library/browse?industry=&q=&sort=&page=&pageSize=\n    // sort: \"featured\" | \"name\"\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    [HttpGet(\"browse\")]\n    public async Task<ActionResult<TemplateLibraryListResponse>> Browse(\n        [FromQuery] string? industry,\n        [FromQuery] string? q,\n        [FromQuery] string? sort,\n        [FromQuery] int page = 1,\n        [FromQuery] int pageSize = 20,\n        CancellationToken ct = default)\n    {\n        var data = await _library.SearchAsync(industry, q, sort, page, pageSize, ct);\n        return Ok(data);\n    }\n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // Activate (variant A) - legacy style\n    // POST /api/template-builder/library/use/{libraryItemId}\n    // body: { \"languages\": [\"en_US\",\"hi_IN\"] }\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    [HttpPost(\"use/{libraryItemId:guid}\")]\n    public async Task<ActionResult<object>> Use(Guid libraryItemId, [FromBody] TemplateLibraryUseRequestDto body, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (libraryItemId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid libraryItemId.\" });\n\n        if (body is null || body.Languages is null || body.Languages.Count == 0)\n            return BadRequest(new { success = false, message = \"At least one language is required.\" });\n\n        var draft = await _library.InstantiateDraftAsync(businessId, libraryItemId, body.Languages, ct);\n\n        // If your TemplateDraftsController exposes GetDraft, keep CreatedAtAction; otherwise return Ok(...)\n        return CreatedAtAction(\"GetDraft\", \"TemplateDrafts\", new { draftId = draft.Id }, new\n        {\n            success = true,\n            message = \"Draft created from library.\",\n            draftId = draft.Id,\n            key = draft.Key,\n            category = draft.Category\n        });\n    }\n\n    public sealed class ActivateRequest\n    {\n        public IEnumerable<string>? Languages { get; set; } // e.g., [\"en_US\",\"hi_IN\"]\n    }\n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // Activate (variant B) - current UI contract\n    // POST /api/template-builder/library/{itemId}/activate\n    // body: { \"languages\": [\"en_US\",\"hi_IN\"] }  (supports \"ALL\" if your service does)\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    [HttpPost(\"{itemId:guid}/activate\")]\n    public async Task<ActionResult<object>> Activate(Guid itemId, [FromBody] ActivateRequest body, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (itemId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid itemId.\" });\n\n        var langs = (body?.Languages ?? Array.Empty<string>()).ToArray();\n        if (langs.Length == 0)\n            return BadRequest(new { success = false, message = \"At least one language is required. You can also pass \\\"ALL\\\".\" });\n\n        try\n        {\n            var draft = await _library.InstantiateDraftAsync(businessId, itemId, langs, ct);\n            return Ok(new\n            {\n                success = true,\n                message = \"Template activated as draft.\",\n                draftId = draft.Id,\n                draft\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Library item not found.\" });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // Get a library item with its variants for preview\n    // GET /api/template-builder/library/item/{itemId}\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    [HttpGet(\"item/{itemId:guid}\")]\n    public async Task<ActionResult<object>> GetItem(Guid itemId, CancellationToken ct)\n    {\n        if (itemId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid itemId.\" });\n\n        try\n        {\n            var (item, variants) = await _library.GetItemAsync(itemId, ct);\n            return Ok(new\n            {\n                success = true,\n                item,\n                variants\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Library item not found.\" });\n        }\n    }\n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // List distinct industries available in the library\n    // GET /api/template-builder/library/industries\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    [HttpGet(\"industries\")]\n    public async Task<ActionResult<object>> Industries(CancellationToken ct)\n    {\n        var list = await _library.ListIndustriesAsync(ct);\n        return Ok(new\n        {\n            success = true,\n            count = list.Count,\n            industries = list\n        });\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplatesController.cs",
      "sha256": "b7014e9c08b5d3cf85e8dbd5edf632bc51e34a2acac661dbb3109dcd259edf4c",
      "language": "csharp",
      "size": 1479,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.Services;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates\")]\n    public class TemplatesController : ControllerBase\n    {\n        private readonly IWhatsAppTemplateService _templateService;\n        private readonly ILogger<TemplatesController> _logger;\n\n        public TemplatesController(IWhatsAppTemplateService templateService, ILogger<TemplatesController> logger)\n        {\n            _templateService = templateService;\n            _logger = logger;\n        }\n\n        /// <summary>\n        /// Fetches WhatsApp template metadata (name, language, body, placeholders)\n        /// </summary>\n        [HttpGet(\"metadata\")]\n        public async Task<IActionResult> GetTemplates()\n        {\n            try\n            {\n                var templates = await _templateService.FetchTemplatesAsync();\n                return Ok(new\n                {\n                    success = true,\n                    templates\n                });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\"Error fetching template metadata: \" + ex.Message);\n                return StatusCode(500, new\n                {\n                    success = false,\n                    message = \"‚ùå Failed to retrieve template metadata\",\n                    error = ex.Message\n                });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateUploadsController.cs",
      "sha256": "cc38aa3a878d59e2ee204ab30bbc2ab40a7d68f2ce6a24415d32465ebcee8996",
      "language": "csharp",
      "size": 10970,
      "content": "using System.ComponentModel.DataAnnotations;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers;\n\n[ApiController]\n[Route(\"api/template-builder/uploads\")]\n[Authorize]\n[Produces(\"application/json\")]\npublic sealed class TemplateUploadsController : ControllerBase\n{\n    private readonly IMetaUploadService _uploader;\n    private readonly ITemplateDraftService _drafts;\n\n    public TemplateUploadsController(IMetaUploadService uploader, ITemplateDraftService drafts)\n    {\n        _uploader = uploader;\n        _drafts = drafts;\n    }\n\n    // ---------- Form DTO so Swagger can model multipart correctly ----------\n    public sealed class UploadHeaderForm\n    {\n        /// <summary>Draft Id to update</summary>\n        [Required]\n        public Guid DraftId { get; set; }\n\n        /// <summary>Variant language, e.g. en_US</summary>\n        [Required]\n        public string Language { get; set; } = default!;\n\n        /// <summary>IMAGE | VIDEO | DOCUMENT</summary>\n        [Required]\n        public string MediaType { get; set; } = default!;\n\n        /// <summary>Upload a file (use either File or SourceUrl)</summary>\n        public IFormFile? File { get; set; }\n\n        /// <summary>Remote URL to fetch and upload (use either File or SourceUrl)</summary>\n        public string? SourceUrl { get; set; }\n\n        /// <summary>Optional override filename (improves MIME guess)</summary>\n        public string? FileName { get; set; }\n    }\n\n    // POST /api/template-builder/uploads/header\n    [HttpPost(\"header\")]\n    [Consumes(\"multipart/form-data\")]\n    [RequestSizeLimit(64_000_000)] // 64MB cap; per-type limits enforced in service\n    [ProducesResponseType(typeof(object), StatusCodes.Status200OK)]\n    [ProducesResponseType(typeof(object), StatusCodes.Status400BadRequest)]\n    [ProducesResponseType(typeof(object), StatusCodes.Status401Unauthorized)]\n    public async Task<ActionResult<object>> UploadHeader([FromForm] UploadHeaderForm form, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (form is null)\n            return BadRequest(new { success = false, message = \"Empty form.\" });\n\n        if (string.IsNullOrWhiteSpace(form.Language))\n            return BadRequest(new { success = false, message = \"language is required.\" });\n\n        if ((form.File is null && string.IsNullOrWhiteSpace(form.SourceUrl)) ||\n            (form.File is not null && !string.IsNullOrWhiteSpace(form.SourceUrl)))\n        {\n            return BadRequest(new { success = false, message = \"Provide either a file or a sourceUrl (not both).\" });\n        }\n\n        if (!Enum.TryParse<HeaderMediaType>(form.MediaType?.Trim(), true, out var kind))\n            return BadRequest(new { success = false, message = \"mediaType must be IMAGE, VIDEO, or DOCUMENT.\" });\n\n        Stream? stream = null;\n        string? fileName = form.FileName;\n\n        if (form.File is not null)\n        {\n            if (form.File.Length <= 0)\n                return BadRequest(new { success = false, message = \"Empty file.\" });\n\n            stream = form.File.OpenReadStream();\n            fileName ??= form.File.FileName;\n        }\n\n        try\n        {\n            var result = await _uploader.UploadHeaderAsync(\n                businessId: businessId,\n                mediaType: kind,\n                fileStream: stream,\n                fileName: fileName,\n                sourceUrl: form.SourceUrl,\n                ct: ct\n            );\n\n            // Persist handle on the variant. Service stores \"handle:{handle}\" internally.\n            var ok = await _drafts.SetHeaderHandleAsync(\n                businessId,\n                form.DraftId,\n                form.Language,\n                kind.ToString(),\n                result.Handle,\n                ct\n            );\n\n            if (!ok)\n                return NotFound(new { success = false, message = \"Draft not found for this business.\" });\n\n            return Ok(new\n            {\n                success = true,\n                message = result.IsStub ? \"Uploaded (stub handle generated).\" : \"Uploaded successfully.\",\n                draftId = form.DraftId,\n                language = form.Language,\n                mediaType = kind.ToString(),\n                handle = result.Handle,   // e.g., \"4::abcdef...\"\n                mime = result.MimeType,\n                bytes = result.SizeBytes,\n                isStub = result.IsStub\n            });\n        }\n        catch (Exception ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // POST /api/template-builder/uploads/standalone\n    [HttpPost(\"standalone\")]\n    [Consumes(\"multipart/form-data\")]\n    [RequestSizeLimit(64_000_000)]\n    [ProducesResponseType(typeof(object), StatusCodes.Status200OK)]\n    public async Task<ActionResult<object>> UploadStandalone([FromForm] StandaloneUploadForm form, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (form is null) return BadRequest(new { success = false, message = \"Empty form.\" });\n\n        if ((form.File is null && string.IsNullOrWhiteSpace(form.SourceUrl)) ||\n            (form.File is not null && !string.IsNullOrWhiteSpace(form.SourceUrl)))\n        {\n            return BadRequest(new { success = false, message = \"Provide either a file or a sourceUrl (not both).\" });\n        }\n\n        if (!Enum.TryParse<HeaderMediaType>(form.MediaType?.Trim(), true, out var kind))\n            return BadRequest(new { success = false, message = \"mediaType must be IMAGE, VIDEO, or DOCUMENT.\" });\n\n        Stream? stream = null;\n        string? fileName = form.FileName;\n        if (form.File is not null)\n        {\n            if (form.File.Length <= 0) return BadRequest(new { success = false, message = \"Empty file.\" });\n            stream = form.File.OpenReadStream();\n            fileName ??= form.File.FileName;\n        }\n\n        try\n        {\n            var result = await _uploader.UploadHeaderAsync(\n                businessId: businessId,\n                mediaType: kind,\n                fileStream: stream,\n                fileName: fileName,\n                sourceUrl: form.SourceUrl,\n                ct: ct\n            );\n\n            return Ok(new\n            {\n                success = true,\n                message = result.IsStub ? \"Uploaded (stub).\" : \"Uploaded successfully.\",\n                mediaType = kind.ToString(),\n                handle = result.Handle,\n                mime = result.MimeType,\n                bytes = result.SizeBytes,\n                isStub = result.IsStub\n            });\n        }\n        catch (Exception ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    public sealed class StandaloneUploadForm\n    {\n        [Required]\n        public string MediaType { get; set; } = default!;\n        public IFormFile? File { get; set; }\n        public string? SourceUrl { get; set; }\n        public string? FileName { get; set; }\n    }\n}\n\n\n//using Microsoft.AspNetCore.Authorization;\n//using Microsoft.AspNetCore.Mvc;\n//using xbytechat.api.Features.TemplateModule.Abstractions;\n//using xbytechat.api.Shared;\n\n//namespace xbytechat.api.Features.TemplateModule.Controllers;\n\n//[ApiController]\n//[Route(\"api/template-builder/uploads\")]\n//[Authorize]\n//public sealed class TemplateUploadsController : ControllerBase\n//{\n//    private readonly IMetaUploadService _uploader;\n//    private readonly ITemplateDraftService _drafts;\n\n//    public TemplateUploadsController(IMetaUploadService uploader, ITemplateDraftService drafts)\n//    {\n//        _uploader = uploader;\n//        _drafts = drafts;\n//    }\n\n//    // POST /api/template-builder/uploads/header\n//    // multipart/form-data:\n//    //  - draftId: guid (required)\n//    //  - language: string (required)\n//    //  - mediaType: IMAGE|VIDEO|DOCUMENT (required)\n//    //  - file: IFormFile (optional if sourceUrl provided)\n//    //  - sourceUrl: string (optional if file provided)\n//    [HttpPost(\"header\")]\n//    [RequestSizeLimit(64_000_000)] // 64MB cap; actual limits enforced per type in service\n//    public async Task<ActionResult<object>> UploadHeader(\n//        [FromForm] Guid draftId,\n//        [FromForm] string language,\n//        [FromForm] string mediaType,\n//        [FromForm] IFormFile? file,\n//        [FromForm] string? sourceUrl,\n//        CancellationToken ct)\n//    {\n//        var businessId = User.GetBusinessId();\n//        if (businessId == Guid.Empty)\n//            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n//        if (draftId == Guid.Empty)\n//            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n//        if (string.IsNullOrWhiteSpace(language))\n//            return BadRequest(new { success = false, message = \"language is required.\" });\n\n//        if (!Enum.TryParse<HeaderMediaType>(mediaType, true, out var kind))\n//            return BadRequest(new { success = false, message = \"mediaType must be IMAGE, VIDEO, or DOCUMENT.\" });\n\n//        Stream? stream = null;\n//        string? fileName = null;\n\n//        if (file is not null)\n//        {\n//            if (file.Length <= 0) return BadRequest(new { success = false, message = \"Empty file.\" });\n//            stream = file.OpenReadStream();\n//            fileName = file.FileName;\n//        }\n\n//        try\n//        {\n//            var result = await _uploader.UploadHeaderAsync(businessId, kind, stream, fileName, sourceUrl, ct);\n\n//            // Persist handle on the variant\n//            var ok = await _drafts.SetHeaderHandleAsync(\n//                businessId, draftId, language, kind.ToString(), result.Handle, ct);\n\n//            if (!ok) return NotFound(new { success = false, message = \"Draft not found for this business.\" });\n\n//            return Ok(new\n//            {\n//                success = true,\n//                message = result.IsStub ? \"Uploaded (stub handle generated).\" : \"Uploaded successfully.\",\n//                draftId,\n//                language,\n//                mediaType = kind.ToString(),\n//                handle = result.Handle, // raw handle; draft stores \"handle:{handle}\"\n//                mime = result.MimeType,\n//                size = result.SizeBytes,\n//                isStub = result.IsStub\n//            });\n//        }\n//        catch (Exception ex)\n//        {\n//            return BadRequest(new { success = false, message = ex.Message });\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/ButtonDto.cs",
      "sha256": "c2555d5cc7d0128fda2e7cffee67e3eefb104cc34586f04d4c6128a580c4ed65",
      "language": "csharp",
      "size": 298,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class ButtonDto\n{\n    public string Type { get; set; } = \"QUICK_REPLY\";  // QUICK_REPLY|URL|PHONE\n    public string Text { get; set; } = string.Empty;\n    public string? Url { get; set; }\n    public string? Phone { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/ButtonMetadataDto.cs",
      "sha256": "ec982e593c9ef32a980dd298dcb89ba9990c7f10b0ca7822fa9c613e23b98dfc",
      "language": "csharp",
      "size": 512,
      "content": "namespace xbytechat.api.Features.TemplatesModule.DTOs\n{\n    // e.g. in the same file or a shared DTOs folder\n    public sealed class ButtonMetadataDto\n    {\n        public string Text { get; set; } = \"\";\n        public string Type { get; set; } = \"\";     // e.g. \"QUICK_REPLY\", \"URL\", \"COPY_CODE\", \"FLOW\"\n        public string SubType { get; set; } = \"\";  // e.g. \"url\", \"copy_code\", \"flow\" (lowercase for UI)\n        public string? ParameterValue { get; set; } // URL template or static value (if any)\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/DraftListItemDto.cs",
      "sha256": "1252235ef12414d1e1ca0352b4cda21a106d260eedf2bd83492b0c3df1e41284",
      "language": "csharp",
      "size": 612,
      "content": "\nusing System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic class DraftListItemDto\n{\n    public Guid Id { get; set; }\n    public string Key { get; set; } = string.Empty;\n    public string Category { get; set; } = string.Empty;\n    public string DefaultLanguage { get; set; } = \"en_US\";\n    public DateTime UpdatedAt { get; set; }\n    public List<ComponentItemDto> Components { get; set; } = new();\n}\n\npublic class ComponentItemDto\n{\n    public string Type { get; set; } = \"BODY\";\n    public string? Text { get; set; }\n    public string? Format { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/emplateDraftVariantUpsertDto.cs",
      "sha256": "8232c54d4ba3e0a1b79831acf95451129befc0371f792773350eaad0d6697710",
      "language": "csharp",
      "size": 576,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateDraftVariantUpsertDto\n{\n    public string Language { get; set; } = \"en_US\";\n    public string BodyText { get; set; } = string.Empty;\n\n    public string HeaderType { get; set; } = \"NONE\";\n    public string? HeaderText { get; set; }\n    public string? HeaderMediaLocalUrl { get; set; }\n\n    public string? FooterText { get; set; }\n    public List<ButtonDto> Buttons { get; set; } = new();\n    public Dictionary<string, string> Examples { get; set; } = new(); // e.g., {\"1\":\"John\",\"2\":\"12345\"}\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/LibraryImportDtos.cs",
      "sha256": "011dad7c69a602c48067fa3864bb4a15f4c8f019ce9da6798215de7530c01f9d",
      "language": "csharp",
      "size": 2570,
      "content": "using System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class LibraryImportRequest\n{\n    [JsonPropertyName(\"items\")]\n    public List<LibraryImportItem> Items { get; set; } = new();\n}\n\npublic sealed class LibraryImportItem\n{\n    [JsonPropertyName(\"industry\")]\n    public string Industry { get; set; } = default!; // required\n\n    [JsonPropertyName(\"key\")]\n    public string Key { get; set; } = default!;      // required (unique per industry)\n\n    [JsonPropertyName(\"category\")]\n    public string Category { get; set; } = default!; // required: UTILITY|MARKETING|AUTHENTICATION\n\n    [JsonPropertyName(\"isFeatured\")]\n    public bool IsFeatured { get; set; }\n\n    [JsonPropertyName(\"variants\")]\n    public List<LibraryImportVariant> Variants { get; set; } = new();\n}\n\npublic sealed class LibraryImportVariant\n{\n    [JsonPropertyName(\"language\")]\n    public string Language { get; set; } = default!;   // required (e.g., en_US)\n\n    [JsonPropertyName(\"headerType\")]\n    public string? HeaderType { get; set; }            // NONE|TEXT|IMAGE|VIDEO|DOCUMENT\n\n    [JsonPropertyName(\"headerText\")]\n    public string? HeaderText { get; set; }\n\n    [JsonPropertyName(\"bodyText\")]\n    public string BodyText { get; set; } = default!;   // required\n\n    [JsonPropertyName(\"footerText\")]\n    public string? FooterText { get; set; }\n\n    // Buttons as simple POCOs (we serialize to JSON string)\n    [JsonPropertyName(\"buttons\")]\n    public List<LibraryImportButton> Buttons { get; set; } = new();\n\n    // Examples map for {{n}} placeholders\n    [JsonPropertyName(\"examples\")]\n    public Dictionary<string, string>? Examples { get; set; }\n}\n\npublic sealed class LibraryImportButton\n{\n    [JsonPropertyName(\"type\")] public string Type { get; set; } = default!; // QUICK_REPLY|URL|PHONE\n    [JsonPropertyName(\"text\")] public string Text { get; set; } = default!;\n    [JsonPropertyName(\"url\")] public string? Url { get; set; }\n    [JsonPropertyName(\"phone\")] public string? Phone { get; set; }\n}\n\npublic sealed class LibraryImportResult\n{\n    public bool Success { get; set; }\n    public int TotalItems { get; set; }\n    public int CreatedItems { get; set; }\n    public int UpdatedItems { get; set; }\n    public int CreatedVariants { get; set; }\n    public int UpdatedVariants { get; set; }\n    public List<LibraryImportError> Errors { get; set; } = new();\n}\n\npublic sealed class LibraryImportError\n{\n    public int ItemIndex { get; set; }\n    public int? VariantIndex { get; set; }\n    public string Message { get; set; } = default!;\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/SubmittedVariantResult.cs",
      "sha256": "43055ef6d4346ffc22ab02159fc72102cee35e2e741ec33258916bc8c2167746",
      "language": "csharp",
      "size": 255,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class SubmittedVariantResult\n{\n    public string Language { get; set; } = \"en_US\";\n    public string Status { get; set; } = \"PENDING\";\n    public string? RejectionReason { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateDraftCreateDto.cs",
      "sha256": "204b1e60b8e3c6810a7ab228ac6465ed2a9153c0c42d756ccbe41466eac38836",
      "language": "csharp",
      "size": 267,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateDraftCreateDto\n{\n    public string Key { get; set; } = string.Empty;\n    public string Category { get; set; } = \"UTILITY\";\n    public string DefaultLanguage { get; set; } = \"en_US\";\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateDraftUpdateDto.cs",
      "sha256": "68c77f5a17358a102683407aefb9f1ea002d004a93173ce6fd9b8d89e4de61cf",
      "language": "csharp",
      "size": 231,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateDraftUpdateDto\n{\n    public string? Key { get; set; }\n    public string? Category { get; set; }\n    public string? DefaultLanguage { get; set; }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateLanguageAddDto.cs",
      "sha256": "04be3b8fe33ecc0777720e37a7c4d36ad2bdb030af6d28cc664c017cfcb6949c",
      "language": "csharp",
      "size": 154,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateLanguageAddDto\n{\n    public string Language { get; set; } = \"en_US\";\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateLibraryListDtos.cs",
      "sha256": "909489a02b0eafb61968b6fb040457bd16df4ff71132e582d998f96b655f82d3",
      "language": "csharp",
      "size": 1026,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateLibraryListItemDto\n{\n    public Guid Id { get; set; }\n    public string Industry { get; set; } = default!;\n    public string Key { get; set; } = default!;\n    public string Category { get; set; } = default!;\n    public bool IsFeatured { get; set; }\n\n    // UI helpers (from first variant or a representative one)\n    public string Language { get; set; } = default!;\n    public string HeaderType { get; set; } = \"NONE\";\n    public int Placeholders { get; set; }       // {{n}} count in body\n    public string BodyPreview { get; set; } = \"\"; // first 120 chars (no examples applied)\n    public string ButtonsSummary { get; set; } = \"\"; // e.g., \"URL, QUICK_REPLY\"\n}\n\npublic sealed class TemplateLibraryListResponse\n{\n    public bool Success { get; set; } = true;\n    public int Page { get; set; }\n    public int PageSize { get; set; }\n    public int Total { get; set; }\n    public List<TemplateLibraryListItemDto> Items { get; set; } = new();\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateLibraryUseRequestDto.cs",
      "sha256": "655070646d57a4f3bd0f28c4d7d01ca3acc6ca55d6fc9e0dfca5e5ef88116978",
      "language": "csharp",
      "size": 209,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateLibraryUseRequestDto\n{\n    public Guid LibraryItemId { get; set; }\n    public List<string> Languages { get; set; } = new();\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateNameCheckDtos.cs",
      "sha256": "ddf6636a72012b50c1578dd1aaec5fee052b0a26239cba1823ca9864382f4f13",
      "language": "csharp",
      "size": 488,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateNameCheckResponse\n{\n    public Guid DraftId { get; set; }\n    public string Language { get; set; } = \"en_US\";\n\n    public string Name { get; set; } = default!;       // computed name we intend to use\n    public bool Available { get; set; }                // true if no collision in WhatsAppTemplates\n    public string? Suggestion { get; set; }            // first available suggestion, if not available\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplatePreviewDto.cs",
      "sha256": "ee8f3feec15359f418b2b6b4dca58978125322fad5da8a3ab4fc30068d7dc4db",
      "language": "csharp",
      "size": 739,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplatePreviewDto\n{\n    // High-level preview for UI\n    public string Language { get; set; } = default!;\n    public string Header { get; set; } = string.Empty;  // resolved header text (or ‚Äú[IMAGE HEADER]‚Äù, etc.)\n    public string Body { get; set; } = string.Empty;  // resolved with example params\n    public string Footer { get; set; } = string.Empty;\n    public List<string> Buttons { get; set; } = new();\n\n    // Raw payload pieces your UI may also want\n    public object ComponentsPayload { get; set; } = default!;  // as built by MetaComponentsBuilder\n    public object ExamplesPayload { get; set; } = default!;  // as built by MetaComponentsBuilder\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateSubmitResponseDto.cs",
      "sha256": "21ac421e71fb4f661527066fed3c5fea94f9cb3809f76e24f7bf0aa0c4bb45e0",
      "language": "csharp",
      "size": 271,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateSubmitResponseDto\n{\n    public bool Success { get; set; }\n    public string Message { get; set; } = string.Empty;\n    public List<SubmittedVariantResult> Variants { get; set; } = new();\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Language/SupportedLanguages.cs",
      "sha256": "783dad349fe10aee1ce978f5b11897424355adc0f90ee91f85c0cb61f18f9c93",
      "language": "csharp",
      "size": 507,
      "content": "namespace xbytechat.api.Features.TemplatesModule.Language;\n\n\npublic static class SupportedLanguages\n{\n    // Seed a small set; we‚Äôll extend when needed.\n    public static readonly HashSet<string> All = new(StringComparer.OrdinalIgnoreCase)\n    {\n        \"en_US\", // English (US)\n        \"hi_IN\", // Hindi (India)\n        // add more later: \"en_GB\", \"mr_IN\", \"bn_IN\", ...\n    };\n\n    public static bool IsSupported(string? code)\n        => !string.IsNullOrWhiteSpace(code) && All.Contains(code.Trim());\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateDraft.cs",
      "sha256": "bce99a7d46b17ecba5152af963c1d6b6df0f283530af9171d8efb1d0d62a78d7",
      "language": "csharp",
      "size": 706,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateDraft\n{\n    public Guid Id { get; set; }\n    public Guid BusinessId { get; set; }\n    public string Key { get; set; } = string.Empty;              // logical name (slug)\n    public string Category { get; set; } = \"UTILITY\";            // MARKETING|UTILITY|AUTHENTICATION\n    public string DefaultLanguage { get; set; } = \"en_US\";\n    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n    public DateTime? SubmittedAt { get; set; }                   // When submitted to Meta (null = not submitted)\n    public string? CreatedByUserId { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateDraftVariant.cs",
      "sha256": "225a2c5d9fc993121caa920349ead738333ea18f8c715dd3d62ec738865142a8",
      "language": "csharp",
      "size": 748,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateDraftVariant\n{\n    public Guid Id { get; set; }\n    public Guid TemplateDraftId { get; set; }\n    public string Language { get; set; } = \"en_US\";\n    public string BodyText { get; set; } = string.Empty;\n\n    public string HeaderType { get; set; } = \"NONE\";             // TEXT|IMAGE|VIDEO|DOCUMENT|NONE\n    public string? HeaderText { get; set; }\n    public string? HeaderMediaLocalUrl { get; set; }\n\n    public string? FooterText { get; set; }\n    public string ButtonsJson { get; set; } = \"[]\";\n    public string ExampleParamsJson { get; set; } = \"{}\";\n\n    public bool IsReadyForSubmission { get; set; }\n    public string? ValidationErrorsJson { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateLibraryItem.cs",
      "sha256": "edd5de348418b1adbb660df10a10ec1ef87346fbac2fdcda58ee091361daa756",
      "language": "csharp",
      "size": 416,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateLibraryItem\n{\n    public Guid Id { get; set; }\n    public string Industry { get; set; } = \"RETAIL\";\n    public string Key { get; set; } = string.Empty;\n    public string Category { get; set; } = \"UTILITY\";\n    public string? TagsJson { get; set; }                 // [\"reminder\",\"promo\"]\n    public bool IsFeatured { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateLibraryVariant.cs",
      "sha256": "eeb3735c5a46f4e5cec3f52f788dd8c201c48fa0d709d5a717f711f028861aa0",
      "language": "csharp",
      "size": 590,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateLibraryVariant\n{\n    public Guid Id { get; set; }\n    public Guid LibraryItemId { get; set; }\n    public string Language { get; set; } = \"en_US\";\n    public string BodyText { get; set; } = string.Empty;\n\n    public string HeaderType { get; set; } = \"NONE\";\n    public string? HeaderText { get; set; }\n    public string? HeaderDemoUrl { get; set; }\n    public string? FooterText { get; set; }\n\n    public string ButtonsJson { get; set; } = \"[]\";\n    public string ExampleParamsJson { get; set; } = \"{}\";\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Payload/MetaComponentsBuilder.cs",
      "sha256": "12244eb68274f08cdf829d0d351563b1c3e24475f5cc1e4d34059b8b2208aa5c",
      "language": "csharp",
      "size": 4061,
      "content": "using System.Text.Json;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Validation;\n\nnamespace xbytechat.api.Features.TemplateModule.Payload;\n\npublic static class MetaComponentsBuilder\n{\n    // Builds a minimal Graph payload compatible structure.\n    // We return \"object\" (anonymous shape) so the Meta client can serialize directly.\n    public static (object components, object examples) Build(\n        string headerType,\n        string? headerText,\n        string? headerMetaMediaId,\n        string bodyText,\n        string? footerText,\n        List<ButtonDto> buttons,\n        Dictionary<string, string> examplesMap)\n    {\n        // Header\n        var components = new List<object>();\n\n        if (!headerType.Equals(\"NONE\", StringComparison.OrdinalIgnoreCase))\n        {\n            if (headerType.Equals(\"TEXT\", StringComparison.OrdinalIgnoreCase))\n            {\n                components.Add(new\n                {\n                    type = \"HEADER\",\n                    format = \"TEXT\",\n                    text = (headerText ?? string.Empty).Trim()\n                });\n            }\n            else\n            {\n                // IMAGE|VIDEO|DOCUMENT\n                components.Add(new\n                {\n                    type = \"HEADER\",\n                    format = headerType.ToUpperInvariant(),\n                    example = new\n                    {\n                        header_handle = new[] { headerMetaMediaId ?? string.Empty }\n                    }\n                });\n            }\n        }\n\n        // Body (include examples for placeholders inside BODY.example as required by Meta)\n        var bodySlots = PlaceholderHelper.ExtractSlots(bodyText);\n        var maxIndex = bodySlots.Count > 0 ? bodySlots.Max() : 0;\n        var bodyExampleRow = new List<string>();\n        for (int i = 1; i <= maxIndex; i++)\n        {\n            examplesMap.TryGetValue(i.ToString(), out var val);\n            bodyExampleRow.Add(val ?? \"\");\n        }\n\n        components.Add(bodyExampleRow.Count > 0\n            ? new\n            {\n                type = \"BODY\",\n                text = bodyText.Trim(),\n                example = new\n                {\n                    body_text = new[] { bodyExampleRow.ToArray() }\n                }\n            }\n            : new\n            {\n                type = \"BODY\",\n                text = bodyText.Trim()\n            });\n\n        // Footer\n        if (!string.IsNullOrWhiteSpace(footerText))\n        {\n            components.Add(new\n            {\n                type = \"FOOTER\",\n                text = footerText.Trim()\n            });\n        }\n\n        // Buttons\n        if (buttons is { Count: > 0 })\n        {\n            var btns = new List<object>();\n            foreach (var b in buttons)\n            {\n                if (b.Type.Equals(\"QUICK_REPLY\", StringComparison.OrdinalIgnoreCase))\n                {\n                    btns.Add(new { type = \"QUICK_REPLY\", text = b.Text.Trim() });\n                }\n                else if (b.Type.Equals(\"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    btns.Add(new { type = \"URL\", text = b.Text.Trim(), url = (b.Url ?? \"\").Trim() });\n                }\n                else if (b.Type.Equals(\"PHONE\", StringComparison.OrdinalIgnoreCase))\n                {\n                    btns.Add(new { type = \"PHONE_NUMBER\", text = b.Text.Trim(), phone_number = (b.Phone ?? \"\").Trim() });\n                }\n            }\n\n            if (btns.Count > 0)\n            {\n                components.Add(new\n                {\n                    type = \"BUTTONS\",\n                    buttons = btns\n                });\n            }\n        }\n\n        // Keep a top-level examples projection for UI/debug (Meta requires it inside BODY.example).\n        var examples = new\n        {\n            body_text = bodyExampleRow.Count > 0\n                ? new[] { bodyExampleRow.ToArray() }\n                : Array.Empty<string[]>()\n        };\n\n\n        return (components, examples);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/IWhatsAppTemplateService.cs",
      "sha256": "2ed5f5891246b4fec02e29892760c3d033e76572488701c525fd801763f742a9",
      "language": "csharp",
      "size": 226,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Services\n{\n    public interface IWhatsAppTemplateService\n    {\n        Task<List<TemplateMetadataDto>> FetchTemplatesAsync();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/MetaCredentialsResolver.cs",
      "sha256": "10d2d61d03e83ff0ff34b8ff2cb06da2bf3de6f1cb716943b660440b52deea9e",
      "language": "csharp",
      "size": 2331,
      "content": "using System.Text.RegularExpressions;\nusing xbytechat_api.WhatsAppSettings.Services; // IWhatsAppSettingsService\nusing xbytechat.api.Features.TemplateModule.Abstractions;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class MetaCredentialsResolver : IMetaCredentialsResolver\n{\n    private readonly IWhatsAppSettingsService _wa;\n\n    // Matches .../vXX or .../vXX.X (optionally with trailing slash)\n    private static readonly Regex VersionSeg = new(@\"/(v\\d+(?:\\.\\d+)?)\\/?$\", RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n    public MetaCredentialsResolver(IWhatsAppSettingsService waSettings)\n    {\n        _wa = waSettings;\n    }\n\n    public async Task<MetaCredentials> ResolveAsync(Guid businessId, CancellationToken ct = default)\n    {\n        // Your existing call; if you have a ct-aware version, wire it here.\n        var s = await _wa.GetSettingsByBusinessIdAsync(businessId);\n        if (s is null) throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n        var apiUrl = (s.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n        var token = (s.ApiKey ?? string.Empty).Trim();\n        var wabaId = (s.WabaId ?? string.Empty).Trim();\n\n        if (string.IsNullOrWhiteSpace(apiUrl)) throw new InvalidOperationException(\"Meta ApiUrl is missing.\");\n        if (string.IsNullOrWhiteSpace(token)) throw new InvalidOperationException(\"Meta access token is missing.\");\n        if (string.IsNullOrWhiteSpace(wabaId)) throw new InvalidOperationException(\"Meta WABA ID is missing.\");\n\n        // If ApiUrl already includes a version (e.g., https://graph.facebook.com/v21.0)\n        // split it into base + version; otherwise leave version empty.\n        string baseUrl = apiUrl;\n        string version = string.Empty;\n\n        var m = VersionSeg.Match(apiUrl);\n        if (m.Success)\n        {\n            version = m.Groups[1].Value;                                // e.g., v21.0\n            baseUrl = apiUrl.Substring(0, m.Index).TrimEnd('/');        // e.g., https://graph.facebook.com\n        }\n\n        return new MetaCredentials(\n            AccessToken: token,\n            GraphBaseUrl: baseUrl,\n            GraphVersion: version,   // can be \"\" if ApiUrl had no version\n            WabaId: wabaId,\n            PhoneNumberId: s.PhoneNumberId\n        );\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/MetaTemplateClient.cs",
      "sha256": "8df9b99c9d09538100c2ecc10c4032123bb26912483e09eddc923dd92107ea03",
      "language": "csharp",
      "size": 11691,
      "content": "using System.Net;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class MetaTemplateClient : IMetaTemplateClient\n{\n    private readonly IHttpClientFactory _httpClientFactory;\n    private readonly IMetaCredentialsResolver _creds;\n    private readonly ILogger<MetaTemplateClient> _log;\n\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web)\n    {\n        WriteIndented = false\n    };\n\n    public MetaTemplateClient(\n        IHttpClientFactory httpClientFactory,\n        IMetaCredentialsResolver creds,\n        ILogger<MetaTemplateClient> log)\n    {\n        _httpClientFactory = httpClientFactory;\n        _creds = creds;\n        _log = log;\n    }\n\n    public async Task<string> UploadMediaAsync(Guid businessId, string localPathOrUrl, string mediaType, CancellationToken ct = default)\n    {\n        // For template headers, Meta requires an \"asset handle\" (aka header_handle).\n        // If the caller passes an already-generated handle, accept it.\n        if (localPathOrUrl.StartsWith(\"handle:\", StringComparison.OrdinalIgnoreCase))\n            return localPathOrUrl.Substring(\"handle:\".Length);\n\n        // Otherwise, we expect the caller to have performed the Resumable Upload flow.\n        throw new NotSupportedException(\n            \"Media headers require a Meta asset handle (header_handle). \" +\n            \"Upload the media via Meta Resumable Upload API first and pass the resulting handle \" +\n            \"(prefix with 'handle:' if you want to bypass this guard).\");\n    }\n\n    public async Task<MetaTemplateCallResult> CreateTemplateAsync(\n        Guid businessId,\n        string name,\n        string category,\n        string language,\n        object componentsPayload,\n        object examplesPayload,\n        CancellationToken ct = default)\n    {\n        try\n        {\n            // Resolve real credentials from your WhatsAppSettings-backed resolver.\n            // Your resolver can return either:\n            //  - GraphBaseUrl + GraphVersion (e.g., https://graph.facebook.com + v21.0), or\n            //  - ApiUrl that already includes a version (e.g., https://graph.facebook.com/v21.0)\n            var c = await _creds.ResolveAsync(businessId, ct);\n\n            // Build base URL robustly whether version is present or not.\n            // If your resolver sets GraphVersion to \"\", pathPart becomes \"\".\n            var baseRoot = (c.GraphBaseUrl ?? \"\").TrimEnd('/');\n            var versionPart = string.IsNullOrWhiteSpace(c.GraphVersion) ? \"\" : \"/\" + c.GraphVersion.Trim('/');\n            var baseWithVersion = $\"{baseRoot}{versionPart}/\";\n\n            var client = _httpClientFactory.CreateClient(\"meta-graph\");\n            client.BaseAddress = new Uri(baseWithVersion);\n            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n            // Per Meta docs: POST /{WABA_ID}/message_templates\n            // Body: name, category, language, components (examples for variables embedded via BODY.example).\n            var payload = new\n            {\n                name,\n                category,\n                // allow_category_change = true, // potentially causing 100/2388299\n                language,\n                components = componentsPayload\n            };\n\n            var jsonPayload = JsonSerializer.Serialize(payload, JsonOpts);\n            _log.LogInformation(\"Meta Create Payload: {Payload}\", jsonPayload);\n\n            using var content = new StringContent(jsonPayload, Encoding.UTF8, \"application/json\");\n            using var resp = await client.PostAsync($\"{c.WabaId}/message_templates\", content, ct);\n\n            var body = await resp.Content.ReadAsStringAsync(ct);\n\n            if (resp.IsSuccessStatusCode)\n            {\n                _log.LogInformation(\"Meta create template OK | WABA {WabaId} | name {Name} | lang {Lang}\", c.WabaId, name, language);\n                return new MetaTemplateCallResult(true, null);\n            }\n\n            // Try to parse Meta error for clearer diagnostics.\n            string friendlyError = ExtractMetaError(body, (int)resp.StatusCode);\n\n            // Common statuses:\n            // 400: invalid payload (components/examples/name)\n            // 401/403: auth/permission\n            // 409: duplicate name+language\n            // 429/5xx: rate limiting / transient errors\n            _log.LogWarning(\"Meta create failed ({StatusCode} {Status}): {Error}\",\n                (int)resp.StatusCode, resp.StatusCode, friendlyError);\n\n            return new MetaTemplateCallResult(false, friendlyError);\n        }\n        catch (Exception ex)\n        {\n            _log.LogWarning(ex, \"Meta create template threw.\");\n            return new MetaTemplateCallResult(false, ex.Message);\n        }\n    }\n\n    public Task<int> SyncTemplatesAsync(Guid businessId, CancellationToken ct = default)\n        => Task.FromResult(0);\n\n    public async Task<(Stream? ValidStream, string? ContentType)> GetMediaStreamAsync(Guid businessId, string mediaId, CancellationToken ct = default)\n    {\n        try\n        {\n            var c = await _creds.ResolveAsync(businessId, ct);\n            var baseRoot = (c.GraphBaseUrl ?? \"\").TrimEnd('/');\n            var versionPart = string.IsNullOrWhiteSpace(c.GraphVersion) ? \"\" : \"/\" + c.GraphVersion.Trim('/');\n            var baseWithVersion = $\"{baseRoot}{versionPart}/\";\n\n            var client = _httpClientFactory.CreateClient(\"meta-graph\");\n            client.BaseAddress = new Uri(baseWithVersion);\n            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n            // 1. Get Media Info to find URL\n            var infoResp = await client.GetAsync(mediaId, ct);\n            if (!infoResp.IsSuccessStatusCode)\n            {\n                var err = await infoResp.Content.ReadAsStringAsync(ct);\n                _log.LogWarning(\"Meta Get Media Info failed: {Code} {Body}\", infoResp.StatusCode, err);\n                return (null, null);\n            }\n\n            var infoJson = await infoResp.Content.ReadAsStringAsync(ct);\n            using var doc = JsonDocument.Parse(infoJson);\n            if (!doc.RootElement.TryGetProperty(\"url\", out var u) || u.ValueKind != JsonValueKind.String)\n            {\n                 _log.LogWarning(\"Meta Media Info response missing 'url' property.\");\n                 return (null, null);\n            }\n\n            var downloadUrl = u.GetString();\n            if (string.IsNullOrEmpty(downloadUrl))\n                return (null, null);\n\n            // 2. Download Media Content\n            using var downloadRequest = new HttpRequestMessage(HttpMethod.Get, downloadUrl);\n            downloadRequest.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n            var downloadResp = await client.SendAsync(downloadRequest, HttpCompletionOption.ResponseHeadersRead, ct);\n            if (!downloadResp.IsSuccessStatusCode)\n            {\n                 _log.LogWarning(\"Meta Download Media failed: {Code}\", downloadResp.StatusCode);\n                 return (null, null);\n            }\n\n            var stream = await downloadResp.Content.ReadAsStreamAsync(ct);\n            var contentType = downloadResp.Content.Headers.ContentType?.MediaType ?? \"application/octet-stream\";\n            \n            return (stream, contentType);\n        }\n        catch (Exception ex)\n        {\n            _log.LogError(ex, \"Exception in GetMediaStreamAsync\");\n            return (null, null);\n        }\n    }\n\n   \n\n    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n    private static string ExtractMetaError(string responseBody, int statusCode)\n    {\n        try\n        {\n            // Meta error shape: { \"error\": { \"message\": \"...\", \"type\": \"...\", \"code\": 0, \"error_subcode\": 0, \"fbtrace_id\": \"...\" } }\n            using var doc = JsonDocument.Parse(responseBody);\n            var root = doc.RootElement;\n\n            if (root.TryGetProperty(\"error\", out var err))\n            {\n                var msg = err.TryGetProperty(\"message\", out var m) ? m.GetString() : null;\n                var type = err.TryGetProperty(\"type\", out var t) ? t.GetString() : null;\n                var code = err.TryGetProperty(\"code\", out var c) ? c.GetInt32() : (int?)null;\n                var sub = err.TryGetProperty(\"error_subcode\", out var s) ? s.GetInt32() : (int?)null;\n                var fb = err.TryGetProperty(\"fbtrace_id\", out var f) ? f.GetString() : null;\n\n                var userTitle = err.TryGetProperty(\"error_user_title\", out var ut) ? ut.GetString() : null;\n                var userMsg = err.TryGetProperty(\"error_user_msg\", out var um) ? um.GetString() : null;\n                var isTransient = err.TryGetProperty(\"is_transient\", out var it) && it.ValueKind == JsonValueKind.True;\n                var errorData = err.TryGetProperty(\"error_data\", out var ed) ? ed.GetRawText() : null;\n\n                var parts = new List<string>\n                {\n                    $\"Meta error: {(type ?? \"N/A\")}\",\n                    $\"code {(code?.ToString() ?? \"N/A\")}{(sub.HasValue ? $\" subcode {sub}\" : \"\")}\",\n                    $\"message: {msg ?? \"N/A\"}\",\n                    $\"fbtrace_id: {fb ?? \"N/A\"}\"\n                };\n\n                if (!string.IsNullOrWhiteSpace(userTitle)) parts.Add($\"user_title: {userTitle}\");\n                if (!string.IsNullOrWhiteSpace(userMsg)) parts.Add($\"user_msg: {userMsg}\");\n                if (!string.IsNullOrWhiteSpace(errorData) && errorData != \"null\") parts.Add($\"error_data: {errorData}\");\n                if (isTransient) parts.Add(\"transient: true\");\n\n                return string.Join(\" | \", parts);\n            }\n        }\n        catch\n        {\n            // ignore JSON parse errors, fall back to raw body\n        }\n\n        // Fallback to raw text if not JSON or unexpected\n        return $\"HTTP {statusCode}: {responseBody}\";\n    }\n\n    public async Task<bool> DeleteTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default)\n    {\n        var c = await _creds.ResolveAsync(businessId, ct);\n        var client = _httpClientFactory.CreateClient(\"meta-graph\");\n        client.BaseAddress = new Uri($\"{c.GraphBaseUrl.TrimEnd('/')}/{c.GraphVersion.Trim('/')}/\");\n        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n        // Graph supports DELETE on /{wabaId}/message_templates with query params name & language\n        var url = $\"{c.WabaId}/message_templates?name={Uri.EscapeDataString(name)}&language={Uri.EscapeDataString(language)}\";\n        using var resp = await client.DeleteAsync(url, ct);\n        var body = await resp.Content.ReadAsStringAsync(ct);\n\n        if (resp.IsSuccessStatusCode)\n        {\n            _log.LogInformation(\"Meta delete template OK | WABA {WabaId} | name {Name} | lang {Lang}\", c.WabaId, name, language);\n            return true;\n        }\n\n        // 404/400 means already gone or not found; treat as success from UX standpoint\n        if ((int)resp.StatusCode == 404 || (int)resp.StatusCode == 400)\n        {\n            _log.LogWarning(\"Meta delete returned {Code} but treating as success. Body: {Body}\", resp.StatusCode, body);\n            return true;\n        }\n\n        _log.LogWarning(\"Meta delete failed ({Code}): {Body}\", resp.StatusCode, body);\n        return false;\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/MetaUploadService.cs",
      "sha256": "63f80cc4e390def4cac1b79204e5bd62e918eb98823098c65a2f76bc25dabcdc",
      "language": "csharp",
      "size": 24941,
      "content": "using System;\nusing System.IO;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Collections.Generic;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.Config;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class MetaUploadService : IMetaUploadService\n{\n    private readonly IHttpClientFactory _httpFactory;\n    private readonly IMetaCredentialsResolver _creds;\n    private readonly UploadLimitsOptions _opts;\n    private readonly ILogger<MetaUploadService> _logger;\n\n    public MetaUploadService(\n        IHttpClientFactory httpFactory,\n        IMetaCredentialsResolver creds,\n        IOptions<UploadLimitsOptions> opts,\n        ILogger<MetaUploadService> logger)\n    {\n        _httpFactory = httpFactory;\n        _creds = creds;\n        _opts = opts.Value;\n        _logger = logger;\n    }\n\n    public async Task<HeaderUploadResult> UploadHeaderAsync(\n        Guid businessId,\n        HeaderMediaType mediaType,\n        Stream? fileStream,\n        string? fileName,\n        string? sourceUrl,\n        CancellationToken ct = default)\n    {\n        if ((fileStream is null && string.IsNullOrWhiteSpace(sourceUrl)) ||\n            (fileStream is not null && !string.IsNullOrWhiteSpace(sourceUrl)))\n            throw new ArgumentException(\"Provide either a file or a sourceUrl, not both.\");\n\n        // If sourceUrl provided, download then proceed\n        if (fileStream is null && sourceUrl is not null)\n        {\n            using var http = new HttpClient();\n            using var resp = await http.GetAsync(sourceUrl, HttpCompletionOption.ResponseHeadersRead, ct);\n            resp.EnsureSuccessStatusCode();\n\n            var tmp = new MemoryStream();\n            await resp.Content.CopyToAsync(tmp, ct);\n            tmp.Position = 0;\n\n            var mime = resp.Content.Headers.ContentType?.MediaType ?? \"application/octet-stream\";\n            var fname = Path.GetFileName(new Uri(sourceUrl).LocalPath);\n            return await UploadCoreAsync(businessId, mediaType, tmp, fname, mime, ct);\n        }\n\n        // File provided\n        if (fileStream is not null)\n        {\n            var mime = GuessMime(fileName, mediaType);\n            return await UploadCoreAsync(businessId, mediaType, fileStream, fileName ?? \"upload.bin\", mime, ct);\n        }\n\n        throw new InvalidOperationException(\"No file or URL provided.\");\n    }\n\n    private async Task<HeaderUploadResult> UploadCoreAsync(\n        Guid businessId,\n        HeaderMediaType mediaType,\n        Stream content,\n        string fileName,\n        string mime,\n        CancellationToken ct)\n    {\n        // Ensure we can read length + seek (so we can retry Path B after Path A)\n        if (!content.CanSeek)\n        {\n            var mem = new MemoryStream();\n            await content.CopyToAsync(mem, ct);\n            mem.Position = 0;\n            content = mem;\n        }\n\n        var size = content.Length;\n\n        // Size/MIME guards\n        switch (mediaType)\n        {\n            case HeaderMediaType.IMAGE:\n                if (size > _opts.ImageMaxBytes) throw new InvalidOperationException(\"Image too large.\");\n                if (!_opts.AllowedImageMime.Contains(mime, StringComparer.OrdinalIgnoreCase))\n                    throw new InvalidOperationException($\"Invalid image MIME: {mime}\");\n                break;\n\n            case HeaderMediaType.VIDEO:\n                if (size > _opts.VideoMaxBytes) throw new InvalidOperationException(\"Video too large.\");\n                if (!_opts.AllowedVideoMime.Contains(mime, StringComparer.OrdinalIgnoreCase))\n                    throw new InvalidOperationException($\"Invalid video MIME: {mime}\");\n                break;\n\n            case HeaderMediaType.DOCUMENT:\n                if (size > _opts.DocumentMaxBytes) throw new InvalidOperationException(\"Document too large.\");\n                if (!_opts.AllowedDocMime.Contains(mime, StringComparer.OrdinalIgnoreCase))\n                    throw new InvalidOperationException($\"Invalid document MIME: {mime}\");\n                break;\n        }\n\n        // ‚îÄ‚îÄ STUB MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n        if (_opts.UseStubHandle)\n        {\n            var handleStub = $\"{(int)mediaType}:{Guid.NewGuid():N}\".Insert(1, \"::\");\n            return new HeaderUploadResult(handleStub, mime, size, IsStub: true);\n        }\n\n        // ‚îÄ‚îÄ REAL MODE: Meta Resumable Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n        var c = await _creds.ResolveAsync(businessId, ct);\n\n        var baseRoot = (c.GraphBaseUrl ?? \"\").TrimEnd('/');\n        var versionPart = string.IsNullOrWhiteSpace(c.GraphVersion) ? \"\" : \"/\" + c.GraphVersion.Trim('/');\n        var baseWithVersion = $\"{baseRoot}{versionPart}\";\n\n        using var client = _httpFactory.CreateClient(\"meta-graph\");\n        client.BaseAddress = new Uri(baseWithVersion + \"/\");\n        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n        // Meta expects IMAGE|VIDEO|DOCUMENT\n        // Meta expects the MIME type (e.g. \"image/jpeg\"), NOT just \"IMAGE\".\n        string fileTypeParam = mime;\n\n        _logger.LogInformation(\"Starting Meta Upload. WABA: {WabaId}, Type: {Type}, Mime: {Mime}, Size: {Size}\", \n             c.WabaId, mediaType, mime, size);\n\n\n        // Path C: Classic (Numeric ID) - PROMOTED to Primary for Template compatibility\n        // Returns a numeric Media ID (e.g. \"12345...\") which is strictly required by the Cloud API for template headers.\n        try \n        {\n             var targetId = !string.IsNullOrWhiteSpace(c.PhoneNumberId) ? c.PhoneNumberId : c.WabaId;\n             _logger.LogInformation(\"MetaUpload: Attempting Path C (Classic) for TargetId={TargetId}...\", targetId);\n             var handleC = await TryPathC_ClassicMediaEndpointAsync(client, targetId!, new NonDisposableStream(content), fileName, mime, size, ct);\n             if (!string.IsNullOrWhiteSpace(handleC))\n             {\n                _logger.LogInformation(\"MetaUpload: Path C Success. MediaId={MediaId}\", handleC);\n                return new HeaderUploadResult(handleC!, mime, size, false);\n             }\n        }\n        catch (Exception ex)\n        {\n             _logger.LogWarning(ex, \"MetaUpload: Path C (Classic) failed. Falling back to Path A/B.\");\n        }\n\n        // Rewind\n        try { content.Position = 0; } catch { }\n\n        // Path A: uploads session (Fallback for larger files)\n        // Returns a handle (4::...) OR a resolved numeric ID if possible.\n        var handleA = await TryPathA_UploadsEndpointAsync(client, c.WabaId, fileTypeParam, new NonDisposableStream(content), fileName, mime, size, ct);\n        if (!string.IsNullOrWhiteSpace(handleA))\n        {\n            _logger.LogInformation(\"MetaUpload: Path A Success. Handle={Handle}. Attempting resolution...\", handleA);\n            var resolvedId = await ResolveMediaIdAsync(client, handleA!, null, ct);\n            _logger.LogInformation(\"MetaUpload: Path A Final Result={Result}\", resolvedId);\n            return new HeaderUploadResult(resolvedId, mime, size, false);\n        }\n\n        // Rewind\n        try { content.Position = 0; } catch { }\n\n        // Path B: Phased (Fallback)\n        var handleB = await TryPathB_PhasedUploadAsync(client, c.WabaId, fileTypeParam, new NonDisposableStream(content), fileName, mime, size, ct);\n        if (!string.IsNullOrWhiteSpace(handleB))\n        {\n             _logger.LogInformation(\"MetaUpload: Path B Success. Handle={Handle}. Attempting resolution...\", handleB);\n             var resolvedId = await ResolveMediaIdAsync(client, handleB!, null, ct);\n             return new HeaderUploadResult(resolvedId, mime, size, false);\n        }\n\n        // Path B Retry (just in case flow falls here unexpectedly)\n        var handleRetry = await TryPathB_PhasedUploadAsync(client, c.WabaId, fileTypeParam, content, fileName, mime, size, ct);\n        if (!string.IsNullOrWhiteSpace(handleRetry))\n        {\n            var resolvedId = await ResolveMediaIdAsync(client, handleRetry!, null, ct);\n            return new HeaderUploadResult(resolvedId, mime, size, false);\n        }\n\n        throw new InvalidOperationException(\"Meta upload did not return an asset handle. Check app permissions and the response logs.\");\n    }\n\n    // ‚îÄ‚îÄ Path A: WABA uploads session (single-shot Content-Range) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private async Task<string?> TryPathA_UploadsEndpointAsync(\n        HttpClient client,\n        string wabaId,\n        string fileTypeParam,\n        Stream content,\n        string fileName,\n        string mime,\n        long size,\n        CancellationToken ct)\n    {\n        // INIT\n        // Params must be in URL query string for app/uploads AND Body to be safe.\n        // We ensure messaging_product=whatsapp is present in both.\n        \n        var safeFileName = (fileName ?? \"upload.bin\").Replace(\" \", \"_\");\n        // Body (FormUrlEncoded)\n        var initPayload = new Dictionary<string, string>\n        {\n            [\"file_name\"] = safeFileName,\n            [\"file_length\"] = size.ToString(),\n            [\"file_type\"] = fileTypeParam,\n            [\"messaging_product\"] = \"whatsapp\"\n        };\n        \n        // Query String (Extra safety for scoping)\n        // Note: app/uploads sometimes ignores body for init, so query string is crucial.\n        var initUrl = $\"{client.BaseAddress}app/uploads?messaging_product=whatsapp\";\n        \n        using var initResp = await client.PostAsync(initUrl, new FormUrlEncodedContent(initPayload), ct);\n        var initText = await initResp.Content.ReadAsStringAsync(ct);\n        \n        if (!initResp.IsSuccessStatusCode)\n        {\n             _logger.LogWarning(\"Meta Upload Path A (Init) Failed. Status: {Status}, Body: {Body}\", initResp.StatusCode, initText);\n             return null;\n        }\n\n        var initJson = SafeParse(initText);\n        var uploadId = initJson.TryGetValue(\"id\", out var idObj) ? idObj?.ToString() : null;\n        if (string.IsNullOrWhiteSpace(uploadId)) return null;\n\n        // TRANSFER (single range)\n        // Use absolute URI to prevent \"scheme not supported\" error on \"upload:xxx\"\n        using (var req = new HttpRequestMessage(HttpMethod.Post, $\"{client.BaseAddress}{uploadId}?messaging_product=whatsapp\"))\n        {\n            req.Content = new StreamContent(content);\n            req.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/octet-stream\");\n            req.Content.Headers.ContentLength = size;\n            req.Headers.TryAddWithoutValidation(\"Content-Range\", $\"bytes 0-{size - 1}/{size}\");\n\n            using var upResp = await client.SendAsync(req, HttpCompletionOption.ResponseHeadersRead, ct);\n            var upText = await upResp.Content.ReadAsStringAsync(ct);\n            if (!upResp.IsSuccessStatusCode)\n            {\n                 _logger.LogWarning(\"Meta Upload Path A (Transfer) Failed. Status: {Status}, Body: {Body}\", upResp.StatusCode, upText);\n                 return null;\n            }\n        }\n\n        // FINISH\n        var finPayload = new Dictionary<string, string> { [\"finish\"] = \"true\" };\n        var finUrl = $\"{client.BaseAddress}{uploadId}?messaging_product=whatsapp\";\n        using var finResp = await client.PostAsync(finUrl, new FormUrlEncodedContent(finPayload), ct);\n        var finText = await finResp.Content.ReadAsStringAsync(ct);\n        \n        if (!finResp.IsSuccessStatusCode)\n        {\n             _logger.LogWarning(\"Meta Upload Path A (Finish) Failed. Status: {Status}, Body: {Body}\", finResp.StatusCode, finText);\n             return null;\n        }\n\n        // Log success body to debug handle extraction\n        _logger.LogInformation(\"Meta Upload Path A (Finish) Success. Body: {Body}\", finText);\n\n        var finJson = SafeParse(finText);\n        if (TryExtractHandle(finJson, out var handle))\n            return handle;\n\n        return null;\n    }\n\n    // ‚îÄ‚îÄ Path B: classic phased upload (start/transfer/finish) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private async Task<string?> TryPathB_PhasedUploadAsync(\n        HttpClient client,\n        string wabaId,\n        string fileTypeParam,\n        Stream content,\n        string fileName,\n        string mime,\n        long size,\n        CancellationToken ct)\n    {\n        // START\n        var startPayload = new Dictionary<string, string>\n        {\n            [\"upload_phase\"] = \"start\",\n            [\"file_type\"] = fileTypeParam,\n            [\"file_length\"] = size.ToString(),\n            [\"messaging_product\"] = \"whatsapp\"\n        };\n        using var startResp = await client.PostAsync(\"app/uploads\", new FormUrlEncodedContent(startPayload), ct);\n        var startText = await startResp.Content.ReadAsStringAsync(ct);\n        \n        if (!startResp.IsSuccessStatusCode)\n        {\n             _logger.LogWarning(\"Meta Upload Path B (Start) Failed. Status: {Status}, Body: {Body}\", startResp.StatusCode, startText);\n             return null;\n        }\n\n        var startJson = SafeParse(startText);\n        var sessionId = startJson.TryGetValue(\"id\", out var idObj) ? idObj?.ToString() : null;\n        if (string.IsNullOrWhiteSpace(sessionId)) return null;\n\n        // TRANSFER\n        var transferSep = sessionId.Contains('?') ? \"&\" : \"?\";\n        using (var req = new HttpRequestMessage(HttpMethod.Post, $\"{client.BaseAddress}{sessionId}{transferSep}upload_phase=transfer&messaging_product=whatsapp\"))\n        {\n            req.Content = new StreamContent(content);\n            req.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/octet-stream\");\n            req.Content.Headers.ContentLength = size;\n            req.Headers.TryAddWithoutValidation(\"Content-Range\", $\"bytes 0-{size - 1}/{size}\");\n\n            using var transferResp = await client.SendAsync(req, HttpCompletionOption.ResponseHeadersRead, ct);\n            var transferText = await transferResp.Content.ReadAsStringAsync(ct);\n            if (!transferResp.IsSuccessStatusCode)\n            {\n                 _logger.LogWarning(\"Meta Upload Path B (Transfer) Failed. Status: {Status}, Body: {Body}\", transferResp.StatusCode, transferText);\n                 return null;\n            }\n        }\n\n        // FINISH\n        var finishSep = sessionId.Contains('?') ? \"&\" : \"?\";\n        var finishUrl = $\"{client.BaseAddress}{sessionId}{finishSep}upload_phase=finish&messaging_product=whatsapp\";\n        using (var req = new HttpRequestMessage(HttpMethod.Post, finishUrl))\n        {\n            req.Content = new FormUrlEncodedContent(new Dictionary<string, string> { [\"confirm\"] = \"true\" });\n            using var finishResp = await client.SendAsync(req, ct);\n            var finishText = await finishResp.Content.ReadAsStringAsync(ct);\n            \n            if (!finishResp.IsSuccessStatusCode)\n            {\n                 _logger.LogWarning(\"Meta Upload Path B (Finish) Failed. Status: {Status}, Body: {Body}\", finishResp.StatusCode, finishText);\n                 return null;\n            }\n\n            // Log success body to debug handle extraction\n            _logger.LogInformation(\"Meta Upload Path B (Finish) Success. Body: {Body}\", finishText);\n\n            var finJson = SafeParse(finishText);\n            if (TryExtractHandle(finJson, out var handle))\n                return handle;\n        }\n\n        return null;\n    }\n\n    // ‚îÄ‚îÄ JSON helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private static Dictionary<string, object?> SafeParse(string json)\n    {\n        try\n        {\n            var root = JsonSerializer.Deserialize<Dictionary<string, object?>>(json);\n            return root ?? new Dictionary<string, object?>();\n        }\n        catch\n        {\n            return new Dictionary<string, object?>();\n        }\n    }\n\n    private static bool TryExtractHandle(Dictionary<string, object?> json, out string? handle)\n    {\n        handle = null;\n        if (json == null) return false;\n\n        // Keys to check in order of preference\n        // Added \"id\" because some Meta regions return the asset handle in the \"id\" field during Finish.\n        var keys = new[] { \"h\", \"handle\", \"asset_handle\", \"id\" };\n\n        foreach (var key in keys)\n        {\n            if (json.TryGetValue(key, out var val) && val is not null)\n            {\n                var s = val.ToString();\n                // If it's a JsonElement, GetString() is safer/cleaner than ToString()\n                if (val is JsonElement el)\n                {\n                    if (el.ValueKind == JsonValueKind.String)\n                        s = el.GetString();\n                    else \n                        s = el.ToString(); \n                }\n\n                if (!string.IsNullOrWhiteSpace(s))\n                {\n                    handle = s;\n                    return true;\n                }\n            }\n        }\n\n        // nested { \"result\": ... }\n        if (json.TryGetValue(\"result\", out var resObj) && resObj is JsonElement resEl && resEl.ValueKind == JsonValueKind.Object)\n        {\n            foreach (var key in keys)\n            {\n                if (resEl.TryGetProperty(key, out var prop))\n                {\n                     var s = prop.ValueKind == JsonValueKind.String ? prop.GetString() : prop.ToString();\n                     if (!string.IsNullOrWhiteSpace(s))\n                     {\n                         handle = s;\n                         return true;\n                     }\n                }\n            }\n        }\n\n        return false;\n    }\n\n    // ‚îÄ‚îÄ Path C: Classic Media Endpoint (POST /<targetId>/media) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private async Task<string?> TryPathC_ClassicMediaEndpointAsync(\n        HttpClient client,\n        string targetId,\n        Stream content,\n        string fileName,\n        string mime,\n        long size,\n        CancellationToken ct)\n    {\n        // 25MB limit hard check (though server might reject earlier)\n        // If > 25MB, skip immediately to fallback to resumable\n        if (size > 25 * 1024 * 1024) return null;\n\n        using var form = new MultipartFormDataContent(); \n        \n        // Correct field: messaging_product=\"whatsapp\"\n        // We need to be careful with MultipartFormDataContent.Add(content, name, fileName)\n        \n        var mp = new MultipartFormDataContent();\n        mp.Add(new StringContent(\"whatsapp\"), \"messaging_product\");\n        \n        var fileContent = new StreamContent(content);\n        fileContent.Headers.ContentType = new MediaTypeHeaderValue(mime);\n        mp.Add(fileContent, \"file\", fileName);\n\n        using var resp = await client.PostAsync($\"{targetId}/media\", mp, ct);\n        var text = await resp.Content.ReadAsStringAsync(ct);\n\n        if (!resp.IsSuccessStatusCode)\n        {\n             _logger.LogWarning(\"Meta Upload Path C (Classic) Failed. Status: {Status}, Body: {Body}\", resp.StatusCode, text);\n             return null;\n        }\n\n        _logger.LogInformation(\"Meta Upload Path C (Classic) Success. Body: {Body}\", text);\n        var json = SafeParse(text);\n\n        // Classic endpoint returns { \"id\": \"1234...\" }\n        if (json.TryGetValue(\"id\", out var val) && val is not null)\n        {\n             return val.ToString();\n        }\n\n        return null;\n    }\n\n    // ‚îÄ‚îÄ Resolve Handle (GET handle -> ID) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    // ‚îÄ‚îÄ Resolve Media ID (Handle or Session -> ID) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private async Task<string> ResolveMediaIdAsync(HttpClient client, string handle, string? sessionId, CancellationToken ct)\n    {\n        // Strategy 1: GET {handle}\n        try\n        {\n            // Handle might contain chars that need encoding for URL path?\n            // \"4:...\" usually safe, but let's be sure.\n            // Actually, HttpClient doesn't like encoded colons in path sometimes.\n            // But 4:: is weird. Let's try direct first.\n            \n            var reqUrl = handle;\n            // If handle contains crazy chars, Uri creation might fail.\n            // Let's try just GET.\n            \n            var resp = await client.GetAsync(reqUrl, ct);\n            if (resp.IsSuccessStatusCode)\n            {\n                var jsonText = await resp.Content.ReadAsStringAsync(ct);\n                _logger.LogInformation(\"Resolve(Handle) Success: {Handle} -> {Body}\", handle, jsonText);\n                var json = SafeParse(jsonText);\n                if (json.TryGetValue(\"id\", out var val) && val is not null) return val.ToString()!;\n            }\n            else\n            {\n                 _logger.LogWarning(\"Resolve(Handle) Failed: {Handle} Status: {Status}\", handle, resp.StatusCode);\n            }\n        }\n        catch (Exception ex)\n        {\n            _logger.LogError(ex, \"Resolve(Handle) Exception: {Handle}\", handle);\n        }\n\n        // Strategy 2: If sessionId provided, GET {sessionId}?fields=id,h\n        if (!string.IsNullOrWhiteSpace(sessionId))\n        {\n            try\n            {\n                var resp = await client.GetAsync($\"{sessionId}?fields=id,handle,status\", ct);\n                if (resp.IsSuccessStatusCode)\n                {\n                    var jsonText = await resp.Content.ReadAsStringAsync(ct);\n                    _logger.LogInformation(\"Resolve(Session) Success: {SessionId} -> {Body}\", sessionId, jsonText);\n                    var json = SafeParse(jsonText);\n                    if (json.TryGetValue(\"id\", out var val) && val is not null) return val.ToString()!;\n                }\n                else\n                {\n                     _logger.LogWarning(\"Resolve(Session) Failed: {SessionId} Status: {Status}\", sessionId, resp.StatusCode);\n                }\n            }\n             catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Resolve(Session) Exception: {SessionId}\", sessionId);\n            }\n        }\n\n        return handle;\n    }\n\n    // ‚îÄ‚îÄ MIME guessing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private static string GuessMime(string? fileName, HeaderMediaType mediaType)\n    {\n        var ext = Path.GetExtension(fileName ?? string.Empty).ToLowerInvariant();\n\n        if (mediaType == HeaderMediaType.IMAGE)\n            return ext switch\n            {\n                \".jpg\" or \".jpeg\" => \"image/jpeg\",\n                \".png\" => \"image/png\",\n                \".webp\" => \"image/webp\",\n                _ => \"image/jpeg\"\n            };\n\n        if (mediaType == HeaderMediaType.VIDEO)\n            return ext switch\n            {\n                \".3gp\" or \".3gpp\" => \"video/3gpp\",\n                _ => \"video/mp4\"\n            };\n\n        if (mediaType == HeaderMediaType.DOCUMENT)\n            return ext switch\n            {\n                \".pdf\" => \"application/pdf\",\n                _ => \"application/pdf\"\n            };\n\n        return \"application/octet-stream\";\n    }\n    // ‚îÄ‚îÄ Stream Wrapper to prevent disposal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n    private class NonDisposableStream : Stream\n    {\n        private readonly Stream _inner;\n        public NonDisposableStream(Stream inner) => _inner = inner;\n        public override bool CanRead => _inner.CanRead;\n        public override bool CanSeek => _inner.CanSeek;\n        public override bool CanWrite => _inner.CanWrite;\n        public override long Length => _inner.Length;\n        public override long Position { get => _inner.Position; set => _inner.Position = value; }\n        public override void Flush() => _inner.Flush();\n        public override int Read(byte[] buffer, int offset, int count) => _inner.Read(buffer, offset, count);\n        public override long Seek(long offset, SeekOrigin origin) => _inner.Seek(offset, origin);\n        public override void SetLength(long value) => _inner.SetLength(value);\n        public override void Write(byte[] buffer, int offset, int count) => _inner.Write(buffer, offset, count);\n        \n        // Key: Do NOT dispose the inner stream\n        protected override void Dispose(bool disposing) { /* no-op */ }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateDraftLifecycleService.cs",
      "sha256": "5bbb3062d47407b41e64e36d1b2cae70d03d21e21979537e2d78c1f48c141766",
      "language": "csharp",
      "size": 6395,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System.Text.RegularExpressions;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing xbytechat.api.Features.TemplateModule.Services;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateDraftLifecycleService : ITemplateDraftLifecycleService\n{\n    private readonly AppDbContext _db;\n    private readonly IMetaTemplateClient _meta;\n    private static readonly Regex MetaNameRx = new(\"^[a-z][a-z0-9_]*$\", RegexOptions.Compiled);\n\n    public TemplateDraftLifecycleService(AppDbContext db, IMetaTemplateClient meta)\n    {\n        _db = db;\n        _meta = meta;\n    }\n\n    public async Task<TemplateDraft> DuplicateDraftAsync(Guid businessId, Guid draftId, string newKey, CancellationToken ct = default)\n    {\n        var src = await _db.TemplateDrafts.AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (src is null) throw new KeyNotFoundException(\"Draft not found.\");\n\n        newKey = (newKey ?? string.Empty).Trim();\n        if (string.IsNullOrWhiteSpace(newKey))\n            throw new ArgumentException(\"Template name is required.\", nameof(newKey));\n\n        if (newKey.Length > 25 || !MetaNameRx.IsMatch(newKey))\n            throw new ArgumentException(\n                \"Invalid template name. Use lowercase letters/numbers/underscores, start with a letter, max 25 characters.\",\n                nameof(newKey));\n\n        var exists = await _db.TemplateDrafts.AnyAsync(\n            x => x.BusinessId == businessId && x.Key == newKey,\n            ct);\n\n        if (exists)\n            throw new InvalidOperationException(\"Template name already exists. Please choose a different name.\");\n\n        var now = DateTime.UtcNow;\n        var dup = new TemplateDraft\n        {\n            Id = Guid.NewGuid(),\n            BusinessId = businessId,\n            Key = newKey,\n            Category = src.Category,\n            DefaultLanguage = src.DefaultLanguage,\n            CreatedAt = now,\n            UpdatedAt = now\n        };\n\n        _db.TemplateDrafts.Add(dup);\n\n        var variants = await _db.TemplateDraftVariants\n            .AsNoTracking()\n            .Where(v => v.TemplateDraftId == src.Id)\n            .ToListAsync(ct);\n\n        foreach (var v in variants)\n        {\n            _db.TemplateDraftVariants.Add(new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = dup.Id,\n                Language = v.Language,\n                HeaderType = v.HeaderType,\n                HeaderText = v.HeaderText,\n                HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n                BodyText = v.BodyText,\n                FooterText = v.FooterText,\n                ButtonsJson = v.ButtonsJson,\n                ExampleParamsJson = v.ExampleParamsJson,\n                IsReadyForSubmission = v.IsReadyForSubmission,\n                ValidationErrorsJson = v.ValidationErrorsJson\n            });\n        }\n\n        await _db.SaveChangesAsync(ct);\n        return dup;\n    }\n\n    public async Task<bool> DeleteDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        // 1) Find the draft scoped to the tenant\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null) return false;\n\n        // 2) Fetch variants to delete from Meta\n        var variants = await _db.TemplateDraftVariants\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n\n        foreach (var v in variants)\n        {\n            // Try to delete from Meta (best effort)\n            try\n            {\n                await _meta.DeleteTemplateAsync(businessId, draft.Key, v.Language, ct);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"[DeleteDraft] Meta delete warning for {draft.Key}/{v.Language}: {ex.Message}\");\n            }\n\n            // Also Soft-delete locally in WhatsAppTemplates (synced table)\n            var syncRows = await _db.WhatsAppTemplates\n                .Where(t => t.BusinessId == businessId && t.Name == draft.Key && t.LanguageCode == v.Language)\n                .ToListAsync(ct);\n\n            if (syncRows.Count > 0)\n            {\n                var now = DateTime.UtcNow;\n                foreach (var t in syncRows)\n                {\n                    t.IsActive = false;\n                    t.Status = \"DELETED\";\n                    t.UpdatedAt = now;\n                    t.LastSyncedAt = now;\n                }\n            }\n        }\n\n        // 3) Hard-delete variants explicitly\n        try\n        {\n            await _db.TemplateDraftVariants\n                .Where(v => v.TemplateDraftId == draft.Id)\n                .ExecuteDeleteAsync(ct);\n        }\n        catch (NotSupportedException)\n        {\n            if (variants.Count > 0)\n                _db.TemplateDraftVariants.RemoveRange(variants);\n        }\n\n        // 4) Delete the parent draft\n        _db.TemplateDrafts.Remove(draft);\n\n        // 5) Commit\n        await _db.SaveChangesAsync(ct);\n        return true;\n    }\n\n    public async Task<bool> DeleteApprovedTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default)\n    {\n        if (string.IsNullOrWhiteSpace(name) || string.IsNullOrWhiteSpace(language))\n            throw new ArgumentException(\"Name and language are required.\");\n\n        // 1) Ask Meta to delete\n        var okMeta = await _meta.DeleteTemplateAsync(businessId, name, language, ct);\n\n        // 2) Soft-delete locally even if Meta already deleted (idempotent UX)\n        var rows = await _db.WhatsAppTemplates\n            .Where(t => t.BusinessId == businessId && t.Name == name && t.LanguageCode == language)\n            .ToListAsync(ct);\n\n        if (rows.Count > 0)\n        {\n            var now = DateTime.UtcNow;\n            foreach (var t in rows)\n            {\n                t.IsActive = false;\n                t.Status = \"DELETED\"; // keep a conventional marker\n                t.UpdatedAt = now;\n                t.LastSyncedAt = now;\n            }\n            await _db.SaveChangesAsync(ct);\n        }\n\n        return okMeta;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateDraftService.cs",
      "sha256": "94a0c4d6175c5fa7f4f9396471fd58a787aee67835740e263f90a69214585817",
      "language": "csharp",
      "size": 17027,
      "content": "using System.Text.Json;\nusing System.Text.RegularExpressions;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing xbytechat.api.Features.TemplateModule.Payload;\nusing xbytechat.api.Features.TemplateModule.Validators;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateDraftService : ITemplateDraftService\n{\n    private readonly AppDbContext _db;\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web);\n    private static readonly Regex KeyAllowed = new(\"^[a-z0-9_]+$\", RegexOptions.Compiled);\n    private static readonly HashSet<string> AllowedCategories =\n        new(StringComparer.OrdinalIgnoreCase) { \"UTILITY\", \"MARKETING\", \"AUTHENTICATION\" };\n\n    public TemplateDraftService(AppDbContext db)\n    {\n        _db = db;\n    }\n\n    public async Task<TemplateDraft> CreateDraftAsync(Guid businessId, TemplateDraftCreateDto dto, CancellationToken ct = default)\n    {\n        if (dto is null) throw new InvalidOperationException(\"Body required.\");\n        if (string.IsNullOrWhiteSpace(dto.Key)) throw new InvalidOperationException(\"Key is required.\");\n        var key = dto.Key.Trim().ToLowerInvariant();\n        if (key.Length > 64) throw new InvalidOperationException(\"Key is too long (max 64 chars).\");\n        if (!KeyAllowed.IsMatch(key))\n            throw new InvalidOperationException(\"Key must contain only lowercase letters, numbers, and underscores.\");\n\n        var category = (dto.Category ?? \"UTILITY\").Trim().ToUpperInvariant();\n        if (!AllowedCategories.Contains(category))\n            throw new InvalidOperationException(\"Category must be UTILITY, MARKETING, or AUTHENTICATION.\");\n\n        var exists = await _db.TemplateDrafts\n            .AnyAsync(x => x.BusinessId == businessId && x.Key == key, ct);\n        if (exists)\n            throw new InvalidOperationException(\"A draft with the same Key already exists for this business.\");\n\n        var draft = new TemplateDraft\n        {\n            Id = Guid.NewGuid(),\n            BusinessId = businessId,\n            Key = key,\n            Category = category,\n            DefaultLanguage = string.IsNullOrWhiteSpace(dto.DefaultLanguage) ? \"en_US\" : dto.DefaultLanguage.Trim(),\n            CreatedAt = DateTime.UtcNow,\n            UpdatedAt = DateTime.UtcNow\n        };\n\n        _db.TemplateDrafts.Add(draft);\n        await _db.SaveChangesAsync(ct);\n        return draft;\n    }\n\n    public async Task<TemplateDraft> UpdateDraftAsync(Guid businessId, Guid draftId, TemplateDraftUpdateDto dto, CancellationToken ct = default)\n    {\n        if (draftId == Guid.Empty) throw new InvalidOperationException(\"Invalid draftId.\");\n        if (dto is null) throw new InvalidOperationException(\"Body required.\");\n\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) throw new KeyNotFoundException(\"Draft not found for this business.\");\n\n        if (dto.Key is not null)\n        {\n            var key = dto.Key.Trim().ToLowerInvariant();\n            if (string.IsNullOrWhiteSpace(key))\n                throw new InvalidOperationException(\"Key is required.\");\n            if (key.Length > 64)\n                throw new InvalidOperationException(\"Key is too long (max 64 chars).\");\n            if (!KeyAllowed.IsMatch(key))\n                throw new InvalidOperationException(\"Key must contain only lowercase letters, numbers, and underscores.\");\n\n            if (!string.Equals(draft.Key, key, StringComparison.Ordinal))\n            {\n                var exists = await _db.TemplateDrafts\n                    .AnyAsync(x => x.BusinessId == businessId && x.Key == key && x.Id != draft.Id, ct);\n                if (exists)\n                    throw new InvalidOperationException(\"A draft with the same Key already exists for this business.\");\n                draft.Key = key;\n            }\n        }\n\n        if (dto.Category is not null)\n        {\n            var category = dto.Category.Trim().ToUpperInvariant();\n            if (!AllowedCategories.Contains(category))\n                throw new InvalidOperationException(\"Category must be UTILITY, MARKETING, or AUTHENTICATION.\");\n            draft.Category = category;\n        }\n\n        if (dto.DefaultLanguage is not null)\n        {\n            var lang = dto.DefaultLanguage.Trim();\n            if (string.IsNullOrWhiteSpace(lang))\n                throw new InvalidOperationException(\"DefaultLanguage is required.\");\n            draft.DefaultLanguage = lang;\n        }\n\n        draft.UpdatedAt = DateTime.UtcNow;\n        await _db.SaveChangesAsync(ct);\n        return draft;\n    }\n\n    public async Task<TemplateDraftVariant> UpsertVariantAsync(Guid businessId, Guid draftId, TemplateDraftVariantUpsertDto dto, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null)\n            throw new KeyNotFoundException(\"Draft not found for this business.\");\n\n        var validation = VariantValidator.Validate(dto);\n        if (!validation.Ok)\n            throw new InvalidOperationException(string.Join(\" | \", validation.Errors));\n\n        var lang = dto.Language.Trim();\n\n        var variant = await _db.TemplateDraftVariants\n            .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == lang, ct);\n\n        var buttonsJson = JsonSerializer.Serialize(dto.Buttons ?? new List<ButtonDto>(), JsonOpts);\n        var examplesJson = JsonSerializer.Serialize(dto.Examples ?? new Dictionary<string, string>(), JsonOpts);\n\n        if (variant is null)\n        {\n            variant = new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = draft.Id,\n                Language = lang,\n                BodyText = dto.BodyText,\n                HeaderType = dto.HeaderType,\n                HeaderText = dto.HeaderText,\n                HeaderMediaLocalUrl = dto.HeaderMediaLocalUrl,\n                FooterText = dto.FooterText,\n                ButtonsJson = buttonsJson,\n                ExampleParamsJson = examplesJson,\n                IsReadyForSubmission = true,\n                ValidationErrorsJson = null\n            };\n            _db.TemplateDraftVariants.Add(variant);\n        }\n        else\n        {\n            variant.BodyText = dto.BodyText;\n            variant.HeaderType = dto.HeaderType;\n            variant.HeaderText = dto.HeaderText;\n            variant.HeaderMediaLocalUrl = dto.HeaderMediaLocalUrl;\n            variant.FooterText = dto.FooterText;\n            variant.ButtonsJson = buttonsJson;\n            variant.ExampleParamsJson = examplesJson;\n            variant.IsReadyForSubmission = true;\n            variant.ValidationErrorsJson = null;\n        }\n\n        draft.UpdatedAt = DateTime.UtcNow;\n\n        await _db.SaveChangesAsync(ct);\n        return variant;\n    }\n\n    public async Task<bool> ValidateAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return false;\n\n        var variants = await _db.TemplateDraftVariants\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n\n        return variants.Any(v => v.IsReadyForSubmission);\n    }\n\n    public async Task<(bool ok, Dictionary<string, List<string>> errors)> ValidateAllAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return (false, new() { { \"global\", new() { \"Draft not found.\" } } });\n\n        var variants = await _db.TemplateDraftVariants\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n\n        if (variants.Count == 0)\n            return (false, new() { { \"global\", new() { \"No language variants found.\" } } });\n\n        // Map DB rows to validator view\n        var views = variants.Select(v => new MultiLanguageValidator.VariantView\n        {\n            Language = v.Language,\n            BodyText = v.BodyText,\n            HeaderType = v.HeaderType,\n            HeaderText = v.HeaderText,\n            HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n            FooterText = v.FooterText,\n            Buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new(),\n            Examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new()\n        }).ToList();\n\n        var (ok, errors) = MultiLanguageValidator.Validate(views);\n\n        // Persist per-variant readiness & last validation errors (optional but helpful)\n        foreach (var v in variants)\n        {\n            v.IsReadyForSubmission = !errors.ContainsKey(v.Language) || errors[v.Language].Count == 0;\n            v.ValidationErrorsJson = errors.ContainsKey(v.Language)\n                ? JsonSerializer.Serialize(errors[v.Language], JsonOpts)\n                : null;\n        }\n        await _db.SaveChangesAsync(ct);\n\n        return (ok, errors);\n    }\n    public Task<TemplateDraft?> GetDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n        => _db.TemplateDrafts.AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n    public async Task<IReadOnlyList<DraftListItemDto>> ListDraftsAsync(Guid businessId, CancellationToken ct = default)\n    {\n        // Exclude drafts that have been submitted (SubmittedAt is not null)\n        // Also exclude drafts that match synced templates (belt-and-suspenders approach)\n        var submittedTemplateNames = await _db.WhatsAppTemplates\n            .Where(t => t.BusinessId == businessId)\n            .Select(t => t.Name.ToLower())\n            .Distinct()\n            .ToListAsync(ct);\n\n        // Join Drafts with their Default Variant to get preview content\n        var query = from d in _db.TemplateDrafts.AsNoTracking()\n                    where d.BusinessId == businessId \n                       && d.SubmittedAt == null \n                       && !submittedTemplateNames.Contains(d.Key)\n                    let v = _db.TemplateDraftVariants.FirstOrDefault(x => x.TemplateDraftId == d.Id && x.Language == d.DefaultLanguage)\n                    // üóëÔ∏è Filter out \"empty\" drafts (Untitled + No Content)\n                    where !d.Key.StartsWith(\"untitled_\") \n                          || (v != null && (!string.IsNullOrWhiteSpace(v.BodyText) || v.HeaderType != \"NONE\"))\n                    orderby d.UpdatedAt descending\n                    select new DraftListItemDto\n                    {\n                        Id = d.Id,\n                        Key = d.Key,\n                        Category = d.Category,\n                        DefaultLanguage = d.DefaultLanguage,\n                        UpdatedAt = d.UpdatedAt,\n                        // Construct simulated components for frontend preview\n                        Components = new List<ComponentItemDto>\n                        {\n                            new ComponentItemDto { Type = \"HEADER\", Format = v != null ? v.HeaderType : \"NONE\" },\n                            new ComponentItemDto { Type = \"BODY\", Text = v != null ? v.BodyText : \"\" }\n                        }\n                    };\n\n        return await query.ToListAsync(ct);\n    }\n\n    private static T? SafeDeserialize<T>(string? json)\n    {\n        if (string.IsNullOrWhiteSpace(json)) return default;\n        try { return JsonSerializer.Deserialize<T>(json!, JsonOpts); } catch { return default; }\n    }\n\n    public async Task<bool> SetHeaderHandleAsync(\n    Guid businessId,\n    Guid draftId,\n    string language,\n    string mediaType,\n    string assetHandle,\n    CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return false;\n\n        var lang = language.Trim();\n        var variant = await _db.TemplateDraftVariants\n            .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == lang, ct);\n\n        if (variant is null)\n        {\n            // create the variant if it doesn't exist yet (handy UX)\n            variant = new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = draft.Id,\n                Language = lang,\n                BodyText = string.Empty,\n                HeaderType = mediaType.ToUpperInvariant(),\n                HeaderText = null,\n                HeaderMediaLocalUrl = $\"handle:{assetHandle}\",\n                FooterText = null,\n                ButtonsJson = \"[]\",\n                ExampleParamsJson = \"{}\",\n                IsReadyForSubmission = false,\n                ValidationErrorsJson = null\n            };\n            _db.TemplateDraftVariants.Add(variant);\n        }\n        else\n        {\n            variant.HeaderType = mediaType.ToUpperInvariant(); // IMAGE|VIDEO|DOCUMENT\n            variant.HeaderMediaLocalUrl = $\"handle:{assetHandle}\";\n            // don't force IsReadyForSubmission here; Validate/Submit will compute it\n        }\n\n        draft.UpdatedAt = DateTime.UtcNow;\n        await _db.SaveChangesAsync(ct);\n        return true;\n    }\n    // xbytechat-api/Features/TemplateModule/Services/TemplateDraftService.cs\n    // (inside the class; no local SafeDeserialize here ‚Äî reuse your existing one)\n\n\n    public async Task<TemplatePreviewDto?> GetPreviewAsync(\n        Guid businessId, Guid draftId, string language, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return null;\n\n        var variant = await _db.TemplateDraftVariants\n            .AsNoTracking()\n            .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == language, ct);\n        if (variant is null) return null;\n\n        // Reuse your existing SafeDeserialize<T>(json, JsonOpts)\n        var buttons = SafeDeserialize<List<ButtonDto>>(variant.ButtonsJson) ?? new();\n        var examples = SafeDeserialize<Dictionary<string, string>>(variant.ExampleParamsJson) ?? new();\n\n        // Preview: no binary fetch; reuse stored header handle so the UI can show that media is already attached.\n        string? headerHandleOrNull = null;\n        if (!string.IsNullOrWhiteSpace(variant.HeaderMediaLocalUrl) &&\n            variant.HeaderMediaLocalUrl.StartsWith(\"handle:\", StringComparison.OrdinalIgnoreCase))\n        {\n            headerHandleOrNull = variant.HeaderMediaLocalUrl.Substring(\"handle:\".Length);\n        }\n\n        var (components, examplesPayload) = MetaComponentsBuilder.Build(\n            variant.HeaderType,\n            variant.HeaderText,\n            headerHandleOrNull,\n            variant.BodyText,\n            variant.FooterText,\n            buttons,\n            examples\n        );\n\n        string ResolveVars(string s)\n        {\n            if (string.IsNullOrEmpty(s)) return string.Empty;\n            var result = s;\n            foreach (var kv in examples)\n                result = result.Replace(\"{{\" + kv.Key + \"}}\", kv.Value ?? string.Empty, StringComparison.Ordinal);\n            return result;\n        }\n\n        string headerPreview = variant.HeaderType?.ToUpperInvariant() switch\n        {\n            \"TEXT\" => ResolveVars(variant.HeaderText ?? string.Empty),\n            \"IMAGE\" => \"[IMAGE HEADER]\",\n            \"VIDEO\" => \"[VIDEO HEADER]\",\n            \"DOCUMENT\" => \"[DOCUMENT HEADER]\",\n            _ => string.Empty\n        };\n\n        var buttonLabels = new List<string>();\n        foreach (var b in buttons)\n        {\n            if (string.Equals(b.Type, \"QUICK_REPLY\", StringComparison.OrdinalIgnoreCase))\n                buttonLabels.Add($\"[Quick Reply] {b.Text}\");\n            else if (string.Equals(b.Type, \"URL\", StringComparison.OrdinalIgnoreCase))\n                buttonLabels.Add($\"[URL] {b.Text}\");\n            else if (string.Equals(b.Type, \"PHONE\", StringComparison.OrdinalIgnoreCase))\n                buttonLabels.Add($\"[Phone] {b.Text}\");\n        }\n\n        return new TemplatePreviewDto\n        {\n            Language = language,\n            Header = headerPreview,\n            Body = ResolveVars(variant.BodyText ?? string.Empty),\n            Footer = ResolveVars(variant.FooterText ?? string.Empty),\n            Buttons = buttonLabels,\n            ComponentsPayload = components,\n            ExamplesPayload = examplesPayload\n        };\n    }\n\n\n    // Keep your SafeDeserialize helper in this class:\n\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateLibrarySeeder.cs",
      "sha256": "eb4dce9cac723c0aba070cfcee2cf19724d67586ac6649f75534cdb71dba1b9d",
      "language": "csharp",
      "size": 10149,
      "content": "using Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic static class TemplateLibrarySeeder\n{\n    public static async Task SeedAsync(IServiceProvider sp)\n    {\n        using var scope = sp.CreateScope();\n        var library = scope.ServiceProvider.GetRequiredService<ITemplateLibraryService>();\n        var logger = scope.ServiceProvider.GetRequiredService<ILogger<TemplateLibraryService>>();\n\n        try\n        {\n            var request = new LibraryImportRequest\n            {\n                Items = new List<LibraryImportItem>\n                {\n                    // ==========================================\n                    // SALON\n                    // ==========================================\n                    CreateItem(\"SALON\", \"Welcome_Gift\", \"MARKETING\", \"Welcome to [Salon Name]! üå∏ Get 15% OFF your first haircut when you book today.\", true),\n                    CreateItem(\"SALON\", \"Booking_Reminder\", \"UTILITY\", \"Hi {{1}}, just a reminder for your appointment tomorrow at {{2}}. See you soon! ‚ú®\"),\n                    CreateItem(\"SALON\", \"Feedback_Request\", \"MARKETING\", \"How was your experience today? {{1}} Tap below to leave a review and get 5 points! ‚≠ê\"),\n                    CreateItem(\"SALON\", \"Seasonal_Offer\", \"MARKETING\", \"Festive Glow! üèÆ Book a Facial & Mani-Pedi combo for just $99. Valid till Sunday.\", true),\n                    CreateItem(\"SALON\", \"New_Service_Alert\", \"MARKETING\", \"Introducing: Keratin Treatment! üíÜ‚Äç‚ôÄÔ∏è Get smoother hair in 2 hours. Tap to view gallery.\"),\n                    CreateItem(\"SALON\", \"Reactivation\", \"MARKETING\", \"We miss you! üíñ It's been a while. Click below to book your next session and get a free head massage.\"),\n\n                    // ==========================================\n                    // GYM\n                    // ==========================================\n                    CreateItem(\"GYM\", \"Member_Welcome\", \"MARKETING\", \"Welcome to the Tribe! üèãÔ∏è‚Äç‚ôÇÔ∏è Hi {{1}}, your membership is active. Ready to crush your goals?\", true),\n                    CreateItem(\"GYM\", \"PT_Session_Confirm\", \"UTILITY\", \"Confirmation: Your Personal Training session with {{1}} is scheduled for {{2}}. Don't forget your towel!\"),\n                    CreateItem(\"GYM\", \"Renewal_Notice\", \"UTILITY\", \"Action Required: Your membership expires in 3 days. Renew now via the link below: {{1}}\"),\n                    CreateItem(\"GYM\", \"New_Class_Schedule\", \"MARKETING\", \"New Yoga & Zumba slots added! üßò‚Äç‚ôÄÔ∏è Check the updated schedule here: {{1}}\", true),\n                    CreateItem(\"GYM\", \"Guest_Pass\", \"MARKETING\", \"Fitness is better with friends! üë¨ Show this message for a 1-day free Guest Pass for your buddy.\"),\n                    CreateItem(\"GYM\", \"Holiday_Hours\", \"UTILITY\", \"Holiday Update: We are open 24/7 during the festive season. Stay fit! üí™\"),\n\n                    // ==========================================\n                    // DOCTOR\n                    // ==========================================\n                    CreateItem(\"DOCTOR\", \"Appt_Confirmation\", \"UTILITY\", \"Your appointment with Dr. {{1}} is confirmed for {{2}}. Please arrive 15 mins early.\", true),\n                    CreateItem(\"DOCTOR\", \"Followup_Reminder\", \"UTILITY\", \"Hi {{1}}, it's time for your follow-up check. Tap to schedule a slot that works for you.\"),\n                    CreateItem(\"DOCTOR\", \"Prescription_Ready\", \"UTILITY\", \"Your prescription is ready for pickup at {{1}}. Ref: {{2}}\", true),\n                    CreateItem(\"DOCTOR\", \"Health_Tip\", \"MARKETING\", \"Health Tip: Drinking 8 glasses of water a day boosts immunity. Stay hydrated! üíß\"),\n                    CreateItem(\"DOCTOR\", \"Clinic_Relocation\", \"UTILITY\", \"Important: We've moved! Our new clinic is at {{1}}. Open from Monday.\"),\n                    CreateItem(\"DOCTOR\", \"Lab_Results\", \"UTILITY\", \"Your lab results are available on our portal. Access here: {{1}}. Login with DOB.\"),\n\n                    // ==========================================\n                    // RETAILER\n                    // ==========================================\n                    CreateItem(\"RETAILER\", \"Order_Confirmed\", \"UTILITY\", \"Success! Your order #{{1}} has been placed. We'll notify you when it ships. üì¶\", true),\n                    CreateItem(\"RETAILER\", \"Shipping_Update\", \"UTILITY\", \"Great news! Your order {{1}} is out for delivery. Track it here: {{2}}\"),\n                    CreateItem(\"RETAILER\", \"Abandoned_Cart\", \"MARKETING\", \"Still thinking about it? ü§î Use code SAVE10 to get 10% OFF the items in your cart!\", true),\n                    CreateItem(\"RETAILER\", \"Exclusive_Sale\", \"MARKETING\", \"VIP Early Access! üõçÔ∏è Our Summer Sale starts now. Tap to shop before everyone else.\"),\n                    CreateItem(\"RETAILER\", \"Delivery_Complete\", \"UTILITY\", \"Delivered! üè† Your package was dropped off at {{1}}. Enjoy your purchase!\"),\n                    CreateItem(\"RETAILER\", \"Product_Review\", \"MARKETING\", \"Your opinion matters! üåü How is your new {{1}}? Rate it and get a $5 voucher.\"),\n\n                    // ==========================================\n                    // MEDICAL\n                    // ==========================================\n                    CreateItem(\"MEDICAL\", \"Test_Appointment\", \"UTILITY\", \"Your {{1}} test is scheduled for tomorrow at {{2}}. Fasting required for 8 hours.\", true),\n                    CreateItem(\"MEDICAL\", \"Billing_Statement\", \"UTILITY\", \"Your monthly statement for {{1}} is ready. Pay securely here: {{2}}\"),\n                    CreateItem(\"MEDICAL\", \"Insurance_Update\", \"UTILITY\", \"Action Required: Please update your insurance details at our desk or via the link: {{1}}\"),\n                    CreateItem(\"MEDICAL\", \"Vaccination_Drive\", \"MARKETING\", \"Flu Season! üíâ Protect yourself and your family. Free vaccinations this Saturday.\", true),\n                    CreateItem(\"MEDICAL\", \"Patient_Portal\", \"UTILITY\", \"Account Created: Welcome to the Patient Portal. Set your password here: {{1}}\"),\n                    CreateItem(\"MEDICAL\", \"Emergency_Contact\", \"UTILITY\", \"Safety First: Update your emergency contact info to stay protected during your visit.\"),\n\n                    // ==========================================\n                    // HOSPITAL\n                    // ==========================================\n                    CreateItem(\"HOSPITAL\", \"Discharge_Notice\", \"UTILITY\", \"Discharge Process: Hi {{1}}, you are cleared for discharge at {{2}}. Safe travels home! üè•\", true),\n                    CreateItem(\"HOSPITAL\", \"Visiting_Hours\", \"UTILITY\", \"Visitor Info: Visiting hours are 10 AM - 8 PM. Max 2 visitors per room at a time.\"),\n                    CreateItem(\"HOSPITAL\", \"Patient_Education\", \"UTILITY\", \"Post-Op Guide: View your recovery instructions here: {{1}}. Call {{2}} for assistance.\"),\n                    CreateItem(\"HOSPITAL\", \"Blood_Donation\", \"MARKETING\", \"Urgent: Blood donors needed for {{1}}. Save a life today at our blood bank.\", true),\n                    CreateItem(\"HOSPITAL\", \"Parking_Info\", \"UTILITY\", \"Free parking is available in the North Wing for patient families. Validation required.\"),\n                    CreateItem(\"HOSPITAL\", \"Health_Webinar\", \"MARKETING\", \"Join our webinar on 'Heart Health' this Friday at 6 PM. Register here: {{1}}\"),\n\n                    // ==========================================\n                    // REAL_ESTATE\n                    // ==========================================\n                    CreateItem(\"REAL_ESTATE\", \"Viewing_Confirmed\", \"UTILITY\", \"Viewing Scheduled: We'll see you at {{1}} tomorrow at {{2}}. See you there! üîë\", true),\n                    CreateItem(\"REAL_ESTATE\", \"New_Listing\", \"MARKETING\", \"New Listing! üè° Stunning 3 BHK at {{1}}. Tap to view 3D tour and pricing.\", true),\n                    CreateItem(\"REAL_ESTATE\", \"Price_Drop\", \"MARKETING\", \"Price Slashed! üìâ The property at {{1}} is now available for just {{2}}. Don't miss out!\"),\n                    CreateItem(\"REAL_ESTATE\", \"Doc_Signature\", \"UTILITY\", \"Action Required: Please sign the property documents for {{1}} here: {{2}}\"),\n                    CreateItem(\"REAL_ESTATE\", \"Closing_Update\", \"UTILITY\", \"Exciting News! üéä The closing for {{1}} is scheduled for {{2}}. We're almost there!\"),\n                    CreateItem(\"REAL_ESTATE\", \"Client_Anniversary\", \"MARKETING\", \"Happy 1 Year in your new home! üè† Time flies. Hope you're making great memories!\"),\n                }\n            };\n\n            var result = await library.ImportAsync(request, false);\n            if (result.Success)\n            {\n                logger.LogInformation(\"‚úÖ Library Seeded: {Count} items added/updated.\", result.TotalItems);\n            }\n            else\n            {\n                logger.LogWarning(\"‚ö†Ô∏è Library Seeding had errors. Check logs.\");\n            }\n        }\n        catch (Exception ex)\n        {\n            logger.LogError(ex, \"‚ùå Failed to seed template library.\");\n        }\n    }\n\n    private static LibraryImportItem CreateItem(string industry, string key, string category, string body, bool featured = false)\n    {\n        return new LibraryImportItem\n        {\n            Industry = industry,\n            Key = key,\n            Category = category,\n            IsFeatured = featured,\n            Variants = new List<LibraryImportVariant>\n            {\n                new LibraryImportVariant\n                {\n                    Language = \"en_US\",\n                    HeaderType = \"NONE\",\n                    BodyText = body,\n                    Buttons = new List<LibraryImportButton>\n                    {\n                        new LibraryImportButton { Type = \"QUICK_REPLY\", Text = \"Interested\" },\n                        new LibraryImportButton { Type = \"QUICK_REPLY\", Text = \"Not now\" }\n                    }\n                }\n            }\n        };\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateLibraryService.cs",
      "sha256": "e528f6b84e4824aaeba3d31169b1d8d952437eb0f79ba908df9eb587acd5fa08",
      "language": "csharp",
      "size": 21737,
      "content": "using System.Text.Json;\nusing System.Text.RegularExpressions;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing System.Text.Json;\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateLibraryService : ITemplateLibraryService\n{\n    private readonly AppDbContext _db;\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web);\n\n    public TemplateLibraryService(AppDbContext db)\n    {\n        _db = db;\n    }\n\n    public async Task<IReadOnlyList<TemplateLibraryItem>> ListAsync(string? industry, CancellationToken ct = default)\n    {\n        var q = _db.TemplateLibraryItems.AsNoTracking();\n        if (!string.IsNullOrWhiteSpace(industry))\n        {\n            var ind = industry.Trim().ToUpperInvariant();\n            q = q.Where(x => x.Industry == ind);\n        }\n\n        return await q\n            .OrderByDescending(x => x.IsFeatured)\n            .ThenBy(x => x.Industry)\n            .ThenBy(x => x.Key)\n            .ToListAsync(ct);\n    }\n\n    public async Task<TemplateDraft> InstantiateDraftAsync(\n      Guid businessId,\n      Guid libraryItemId,\n      IEnumerable<string> languages,\n      CancellationToken ct = default)\n    {\n        var item = await _db.TemplateLibraryItems\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == libraryItemId, ct);\n\n        if (item is null)\n            throw new KeyNotFoundException(\"Library item not found.\");\n\n        // ---- Normalize incoming languages ----\n        var requested = (languages ?? Array.Empty<string>())\n            .Where(l => !string.IsNullOrWhiteSpace(l))\n            .Select(l => l.Trim())\n            .ToArray();\n\n        // Load all variants for this item once\n        var allLibVariants = await _db.TemplateLibraryVariants\n            .AsNoTracking()\n            .Where(v => v.LibraryItemId == item.Id)\n            .ToListAsync(ct);\n\n        if (allLibVariants.Count == 0)\n            throw new InvalidOperationException(\"Selected library item has no language variants.\");\n\n        // If \"ALL\" is requested (case-insensitive), use all languages available\n        bool wantsAll = requested.Any(l => string.Equals(l, \"ALL\", StringComparison.OrdinalIgnoreCase));\n        var targetLangs = wantsAll\n            ? allLibVariants.Select(v => v.Language).Distinct(StringComparer.OrdinalIgnoreCase).ToArray()\n            : requested;\n\n        // Validate: ensure at least one requested language exists\n        var availableLangs = new HashSet<string>(\n            allLibVariants.Select(v => v.Language),\n            StringComparer.OrdinalIgnoreCase);\n\n        var matchedLangs = targetLangs.Where(l => availableLangs.Contains(l)).Distinct(StringComparer.OrdinalIgnoreCase).ToArray();\n\n        if (matchedLangs.Length == 0)\n            throw new InvalidOperationException(\n                $\"None of the requested languages exist for this template. \" +\n                $\"Requested: [{string.Join(\", \", targetLangs)}]; \" +\n                $\"Available: [{string.Join(\", \", availableLangs)}]\");\n\n        // ---- Create an internal unique placeholder key (user must pick their own name in the editor) ----\n        // Note: TemplateDrafts has a unique index on (BusinessId, Key), so we must generate a unique value.\n        // We intentionally do NOT reuse item.Key or append random chars to user-facing names.\n        var baseKey = $\"__lib__{item.Industry}_{item.Key}\";\n        var key = baseKey;\n        var suffix = 1;\n        while (await _db.TemplateDrafts.AnyAsync(x => x.BusinessId == businessId && x.Key == key, ct))\n        {\n            suffix++;\n            key = $\"{baseKey}_{suffix}\";\n        }\n\n        // ---- Create draft ----\n        var defaultLang = matchedLangs[0];\n        var draft = new TemplateDraft\n        {\n            Id = Guid.NewGuid(),\n            BusinessId = businessId,\n            Key = key,\n            Category = item.Category,\n            DefaultLanguage = defaultLang,\n            CreatedAt = DateTime.UtcNow,\n            UpdatedAt = DateTime.UtcNow\n        };\n        _db.TemplateDrafts.Add(draft);\n\n        // ---- Clone only the matched languages ----\n        var libVariants = allLibVariants\n            .Where(v => matchedLangs.Contains(v.Language, StringComparer.OrdinalIgnoreCase))\n            .ToList();\n\n        foreach (var lv in libVariants)\n        {\n            var variant = new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = draft.Id,\n                Language = lv.Language,\n                BodyText = lv.BodyText,\n                HeaderType = lv.HeaderType,\n                HeaderText = lv.HeaderText,\n                HeaderMediaLocalUrl = null,         // Library media is preview-only; users upload their own\n                FooterText = lv.FooterText,\n                ButtonsJson = lv.ButtonsJson ?? \"[]\",\n                // IMPORTANT: examples are a map/object -> \"{}\" by default\n                ExampleParamsJson = lv.ExampleParamsJson ?? \"{}\",\n                IsReadyForSubmission = true,\n                ValidationErrorsJson = null\n            };\n            _db.TemplateDraftVariants.Add(variant);\n        }\n\n        await _db.SaveChangesAsync(ct);\n        return draft;\n    }\n\n    public async Task<(TemplateLibraryItem item, List<TemplateLibraryVariant> variants)> GetItemAsync(\n    Guid libraryItemId,\n    CancellationToken ct = default)\n    {\n        var item = await _db.TemplateLibraryItems\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == libraryItemId, ct);\n\n        if (item is null)\n            throw new KeyNotFoundException(\"Library item not found.\");\n\n        var variants = await _db.TemplateLibraryVariants\n            .AsNoTracking()\n            .Where(v => v.LibraryItemId == item.Id)\n            .OrderBy(v => v.Language)\n            .ToListAsync(ct);\n\n        return (item, variants);\n    }\n    public async Task<IReadOnlyList<string>> ListIndustriesAsync(CancellationToken ct = default)\n    {\n        var raw = await _db.TemplateLibraryItems\n            .AsNoTracking()\n            .Select(x => x.Industry)\n            .Where(x => x != null && x != \"\")\n            .ToListAsync(ct);\n\n        // Normalize to upper (your storage uses UPPER), then distinct & sort for UX\n        var set = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n        foreach (var s in raw)\n        {\n            var v = s!.Trim();\n            if (v.Length == 0) continue;\n            set.Add(v.ToUpperInvariant());\n        }\n        return set.OrderBy(x => x).ToList();\n    }\n    //public async Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, CancellationToken ct = default)\n    public async Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, bool dryRun = false, CancellationToken ct = default)\n    {\n        var res = new LibraryImportResult();\n        if (request?.Items == null || request.Items.Count == 0)\n        {\n            res.Success = true;\n            return res;\n        }\n\n        // reasonable safety cap; adjust if needed\n        if (request.Items.Count > 1000)\n            throw new InvalidOperationException(\"Too many items in one import. Split into smaller batches (‚â§1000).\");\n\n        using var tx = await _db.Database.BeginTransactionAsync(ct);\n\n        var jsonOpts = new JsonSerializerOptions(JsonSerializerDefaults.Web) { WriteIndented = false };\n\n        string NormalizeCategory(string cat)\n        {\n            var c = (cat ?? \"\").Trim().ToUpperInvariant();\n            return c switch\n            {\n                \"UTILITY\" or \"MARKETING\" or \"AUTHENTICATION\" => c,\n                _ => throw new InvalidOperationException(\"category must be one of UTILITY, MARKETING, AUTHENTICATION\")\n            };\n        }\n\n        string NormalizeHeaderType(string? ht)\n        {\n            var t = (ht ?? \"NONE\").Trim().ToUpperInvariant();\n            return t switch\n            {\n                \"NONE\" or \"TEXT\" or \"IMAGE\" or \"VIDEO\" or \"DOCUMENT\" => t,\n                _ => throw new InvalidOperationException(\"headerType must be NONE|TEXT|IMAGE|VIDEO|DOCUMENT\")\n            };\n        }\n\n        string ButtonsToJson(List<LibraryImportButton> buttons)\n        {\n            // light validation: max 3; text required; type-specific fields\n            if (buttons is { Count: > 3 })\n                throw new InvalidOperationException(\"A variant cannot have more than 3 buttons.\");\n\n            foreach (var b in buttons)\n            {\n                if (string.IsNullOrWhiteSpace(b.Type)) throw new InvalidOperationException(\"button.type is required.\");\n                if (string.IsNullOrWhiteSpace(b.Text)) throw new InvalidOperationException(\"button.text is required.\");\n\n                var t = b.Type.Trim().ToUpperInvariant();\n                if (t == \"URL\" && string.IsNullOrWhiteSpace(b.Url))\n                    throw new InvalidOperationException(\"URL button requires url.\");\n                if (t == \"PHONE\" && string.IsNullOrWhiteSpace(b.Phone))\n                    throw new InvalidOperationException(\"PHONE button requires phone.\");\n            }\n\n            return JsonSerializer.Serialize(buttons ?? new(), jsonOpts);\n        }\n\n        string ExamplesToJson(Dictionary<string, string>? map)\n            => JsonSerializer.Serialize(map ?? new Dictionary<string, string>(), jsonOpts); // {} default\n\n        for (int i = 0; i < request.Items.Count; i++)\n        {\n            var raw = request.Items[i];\n            try\n            {\n                // ---- normalize + validate item ----\n                var industry = (raw.Industry ?? \"\").Trim().ToUpperInvariant();\n                if (string.IsNullOrWhiteSpace(industry)) throw new InvalidOperationException(\"industry is required.\");\n\n                var key = (raw.Key ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(key)) throw new InvalidOperationException(\"key is required.\");\n\n                var category = NormalizeCategory(raw.Category);\n\n                if (raw.Variants == null || raw.Variants.Count == 0)\n                    throw new InvalidOperationException(\"at least one variant is required.\");\n\n                // ---- upsert item by (Industry, Key) ----\n                var item = await _db.TemplateLibraryItems\n                    .FirstOrDefaultAsync(x => x.Industry == industry && x.Key == key, ct);\n\n                if (item == null)\n                {\n                    item = new TemplateLibraryItem\n                    {\n                        Id = Guid.NewGuid(),\n                        Industry = industry,\n                        Key = key,\n                        Category = category,\n                        IsFeatured = raw.IsFeatured\n                    };\n                    _db.TemplateLibraryItems.Add(item);\n                    res.CreatedItems++;\n                    await _db.SaveChangesAsync(ct); // ensure item.Id for variants\n                }\n                else\n                {\n                    // update mutable fields\n                    item.Category = category;\n                    item.IsFeatured = raw.IsFeatured;\n                    res.UpdatedItems++;\n                    await _db.SaveChangesAsync(ct);\n                }\n\n                // ---- per-variant upsert by (LibraryItemId, Language) ----\n                for (int v = 0; v < raw.Variants.Count; v++)\n                {\n                    var vv = raw.Variants[v];\n\n                    var lang = (vv.Language ?? \"\").Trim();\n                    if (string.IsNullOrWhiteSpace(lang))\n                        throw new InvalidOperationException(\"variant.language is required.\");\n\n                    var headerType = NormalizeHeaderType(vv.HeaderType);\n                    var bodyText = (vv.BodyText ?? \"\").Trim();\n                    if (string.IsNullOrWhiteSpace(bodyText))\n                        throw new InvalidOperationException(\"variant.bodyText is required.\");\n\n                    if (headerType == \"TEXT\" && string.IsNullOrWhiteSpace(vv.HeaderText))\n                        throw new InvalidOperationException(\"headerText is required when headerType=TEXT.\");\n\n                    var buttonsJson = ButtonsToJson(vv.Buttons ?? new());\n                    var examplesJson = ExamplesToJson(vv.Examples);\n\n                    var existing = await _db.TemplateLibraryVariants\n                        .FirstOrDefaultAsync(x => x.LibraryItemId == item.Id && x.Language == lang, ct);\n\n                    if (existing == null)\n                    {\n                        _db.TemplateLibraryVariants.Add(new TemplateLibraryVariant\n                        {\n                            Id = Guid.NewGuid(),\n                            LibraryItemId = item.Id,\n                            Language = lang,\n                            HeaderType = headerType,\n                            HeaderText = vv.HeaderText,\n                            BodyText = bodyText,\n                            FooterText = vv.FooterText,\n                            ButtonsJson = buttonsJson,\n                            ExampleParamsJson = examplesJson\n                        });\n                        res.CreatedVariants++;\n                    }\n                    else\n                    {\n                        existing.HeaderType = headerType;\n                        existing.HeaderText = vv.HeaderText;\n                        existing.BodyText = bodyText;\n                        existing.FooterText = vv.FooterText;\n                        existing.ButtonsJson = buttonsJson;\n                        existing.ExampleParamsJson = examplesJson;\n                        res.UpdatedVariants++;\n                    }\n                }\n            }\n            catch (Exception ex)\n            {\n                res.Errors.Add(new LibraryImportError\n                {\n                    ItemIndex = i,\n                    Message = ex.Message\n                });\n            }\n        }\n\n        //await _db.SaveChangesAsync(ct);\n        //await tx.CommitAsync(ct);\n        await _db.SaveChangesAsync(ct);\n        if (dryRun)\n        {\n            // Undo all writes made within this transaction\n            await tx.RollbackAsync(ct);\n        }\n        else\n        {\n            await tx.CommitAsync(ct);\n        }\n        res.TotalItems = request.Items.Count;\n        res.Success = res.Errors.Count == 0;\n        return res;\n    }\n\n    public async Task<TemplateLibraryListResponse> SearchAsync(\n    string? industry, string? q, string? sort, int page, int pageSize, CancellationToken ct = default)\n    {\n        page = page <= 0 ? 1 : page;\n        pageSize = pageSize <= 0 ? 20 : Math.Min(pageSize, 100);\n\n        var query = _db.TemplateLibraryItems.AsNoTracking().AsQueryable();\n\n        if (!string.IsNullOrWhiteSpace(industry))\n        {\n            var ind = industry.Trim().ToUpperInvariant();\n            query = query.Where(x => x.Industry == ind);\n        }\n\n        if (!string.IsNullOrWhiteSpace(q))\n        {\n            var tq = q.Trim();\n            query = query.Where(x =>\n                x.Key.Contains(tq) ||\n                x.Category.Contains(tq) ||\n                x.Industry.Contains(tq));\n        }\n\n        // Sorting\n        sort = (sort ?? \"featured\").ToLowerInvariant();\n        query = sort switch\n        {\n            \"name\" => query.OrderBy(x => x.Key).ThenBy(x => x.Industry),\n            \"featured\" => query.OrderByDescending(x => x.IsFeatured).ThenBy(x => x.Key),\n            _ => query.OrderByDescending(x => x.IsFeatured).ThenBy(x => x.Key)\n        };\n\n        var total = await query.CountAsync(ct);\n\n        var pageItems = await query\n            .Skip((page - 1) * pageSize)\n            .Take(pageSize)\n            .Select(x => new\n            {\n                x.Id,\n                x.Industry,\n                x.Key,\n                x.Category,\n                x.IsFeatured,\n                // representative variant: prefer en_US if present; otherwise first by language asc\n                Variant = _db.TemplateLibraryVariants\n                            .AsNoTracking()\n                            .Where(v => v.LibraryItemId == x.Id)\n                            .OrderByDescending(v => v.Language == \"en_US\")\n                            .ThenBy(v => v.Language)\n                            .Select(v => new { v.Language, v.HeaderType, v.BodyText, v.ButtonsJson })\n                            .FirstOrDefault()\n            })\n            .ToListAsync(ct);\n\n        var items = new List<TemplateLibraryListItemDto>(pageItems.Count);\n\n        foreach (var row in pageItems)\n        {\n            var lang = row.Variant?.Language ?? \"en_US\";\n            var headerType = row.Variant?.HeaderType ?? \"NONE\";\n            var body = row.Variant?.BodyText ?? \"\";\n\n            // Placeholder count in body {{n}}\n            var ph = Regex.Matches(body, @\"\\{\\{\\d+\\}\\}\").Count;\n\n            // Body preview (first 120 chars, one-line)\n            var preview = body.Replace(\"\\r\", \" \").Replace(\"\\n\", \" \");\n            if (preview.Length > 120) preview = preview.Substring(0, 120) + \"‚Ä¶\";\n\n            // Buttons summary from JSON (keep simple & resilient)\n            string btnSummary = \"\";\n            try\n            {\n                var rawJson = row.Variant?.ButtonsJson ?? \"[]\";\n                var btns = System.Text.Json.JsonSerializer.Deserialize<List<ButtonDto>>(rawJson)\n                           ?? new List<ButtonDto>();\n\n                if (btns.Count > 0)\n                {\n                    btnSummary = string.Join(\", \",\n                        btns.Select(b => (b.Type ?? \"\").ToUpperInvariant())\n                            .Distinct());\n                }\n            }\n            catch { /* ignore malformed buttons json */ }\n\n            items.Add(new TemplateLibraryListItemDto\n            {\n                Id = row.Id,\n                Industry = row.Industry,\n                Key = row.Key,\n                Category = row.Category,\n                IsFeatured = row.IsFeatured,\n                Language = lang,\n                HeaderType = headerType,\n                Placeholders = ph,\n                BodyPreview = preview,\n                ButtonsSummary = btnSummary\n            });\n        }\n\n        return new TemplateLibraryListResponse\n        {\n            Page = page,\n            PageSize = pageSize,\n            Total = total,\n            Items = items\n        };\n    }\n\n\n\n    public async Task<LibraryImportRequest> ExportAsync(string? industry, CancellationToken ct = default)\n    {\n        var request = new LibraryImportRequest();\n\n        var q = _db.TemplateLibraryItems.AsNoTracking();\n        if (!string.IsNullOrWhiteSpace(industry))\n        {\n            var ind = industry.Trim().ToUpperInvariant();\n            q = q.Where(x => x.Industry == ind);\n        }\n\n        var items = await q\n            .OrderByDescending(x => x.IsFeatured)\n            .ThenBy(x => x.Industry)\n            .ThenBy(x => x.Key)\n            .ToListAsync(ct);\n\n        if (items.Count == 0)\n            return request;\n\n        var variantsLookup = await _db.TemplateLibraryVariants\n            .AsNoTracking()\n            .Where(v => items.Select(i => i.Id).Contains(v.LibraryItemId))\n            .GroupBy(v => v.LibraryItemId)\n            .ToDictionaryAsync(g => g.Key, g => g.ToList(), ct);\n\n        foreach (var it in items)\n        {\n            variantsLookup.TryGetValue(it.Id, out var vs);\n            var dto = new LibraryImportItem\n            {\n                Industry = it.Industry,\n                Key = it.Key,\n                Category = it.Category,\n                IsFeatured = it.IsFeatured,\n                Variants = new List<LibraryImportVariant>()\n            };\n\n            if (vs != null)\n            {\n                foreach (var v in vs.OrderBy(v => v.Language))\n                {\n                    List<LibraryImportButton> buttons;\n                    try\n                    {\n                        buttons = string.IsNullOrWhiteSpace(v.ButtonsJson)\n                            ? new List<LibraryImportButton>()\n                            : System.Text.Json.JsonSerializer.Deserialize<List<LibraryImportButton>>(v.ButtonsJson)\n                              ?? new List<LibraryImportButton>();\n                    }\n                    catch\n                    {\n                        buttons = new List<LibraryImportButton>();\n                    }\n\n                    Dictionary<string, string>? examples;\n                    try\n                    {\n                        examples = string.IsNullOrWhiteSpace(v.ExampleParamsJson)\n                            ? new Dictionary<string, string>()\n                            : System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(v.ExampleParamsJson)\n                              ?? new Dictionary<string, string>();\n                    }\n                    catch\n                    {\n                        examples = new Dictionary<string, string>();\n                    }\n\n                    dto.Variants.Add(new LibraryImportVariant\n                    {\n                        Language = v.Language,\n                        HeaderType = v.HeaderType,\n                        HeaderText = v.HeaderText,\n                        BodyText = v.BodyText ?? string.Empty,\n                        FooterText = v.FooterText,\n                        Buttons = buttons,\n                        Examples = examples\n                    });\n                }\n            }\n\n            request.Items.Add(dto);\n        }\n\n        return request;\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateNameCheckService.cs",
      "sha256": "e1887b7536f13bf3baefdd37b8f2ee38a5696531dfddcdac18cd1d5c4ab8d0e6",
      "language": "csharp",
      "size": 2651,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System.Text.RegularExpressions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic interface ITemplateNameCheckService\n{\n    Task<TemplateNameCheckResponse?> CheckAsync(Guid businessId, Guid draftId, string language, CancellationToken ct = default);\n}\n\npublic sealed class TemplateNameCheckService : ITemplateNameCheckService\n{\n    private readonly AppDbContext _db;\n    private static readonly Regex MetaNameRx = new(\"^[a-z][a-z0-9_]*$\", RegexOptions.Compiled);\n\n    public TemplateNameCheckService(AppDbContext db) => _db = db;\n\n    public async Task<TemplateNameCheckResponse?> CheckAsync(Guid businessId, Guid draftId, string language, CancellationToken ct = default)\n    {\n        language = string.IsNullOrWhiteSpace(language) ? \"en_US\" : language;\n\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null) return null;\n\n        // Use the user-entered draft Key as the Meta template name (no suffixes / random chars).\n        var baseName = (draft.Key ?? string.Empty).Trim();\n\n        // If invalid for Meta, treat as unavailable (no auto-suggestions).\n        if (string.IsNullOrWhiteSpace(baseName) || baseName.Length > 25 || !MetaNameRx.IsMatch(baseName))\n        {\n            return new TemplateNameCheckResponse\n            {\n                DraftId = draft.Id,\n                Language = language,\n                Name = baseName,\n                Available = false,\n                Suggestion = null\n            };\n        }\n\n        var available = !await ExistsAsync(businessId, baseName, language, ct);\n        if (available)\n        {\n            return new TemplateNameCheckResponse\n            {\n                DraftId = draft.Id,\n                Language = language,\n                Name = baseName,\n                Available = true,\n                Suggestion = null\n            };\n        }\n\n        return new TemplateNameCheckResponse\n        {\n            DraftId = draft.Id,\n            Language = language,\n            Name = baseName,\n            Available = false,\n            Suggestion = null\n        };\n    }\n\n    private Task<bool> ExistsAsync(Guid businessId, string name, string language, CancellationToken ct)\n        => _db.WhatsAppTemplates.AsNoTracking()\n            .AnyAsync(t => t.BusinessId == businessId\n                        && t.Name == name\n                        && t.LanguageCode == language, ct);\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateStatusService.cs",
      "sha256": "e7e3e2ad4333865058497b781bd0dca9e37da311166f86391095c5a1d26c22bd",
      "language": "csharp",
      "size": 1510,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateStatusService : ITemplateStatusService\n{\n    private readonly AppDbContext _db;\n\n    public TemplateStatusService(AppDbContext db)\n    {\n        _db = db;\n    }\n\n    public async Task<(string metaName, IReadOnlyList<TemplateStatusItemDto> items)> GetStatusAsync(\n        Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        // Load draft (to get Key for Meta name derivation)\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null)\n            throw new KeyNotFoundException(\"Draft not found.\");\n\n        // Use the user-entered draft Key as the Meta template name (no suffixes / random chars).\n        var name = (draft.Key ?? string.Empty).Trim();\n\n        // Query your SoT table\n        var rows = await _db.WhatsAppTemplates\n            .AsNoTracking()\n            .Where(t => t.BusinessId == businessId && t.Name == name)\n            .OrderBy(t => t.LanguageCode)\n            .Select(t => new TemplateStatusItemDto(\n                t.LanguageCode,\n                t.Status ?? string.Empty,\n                t.TemplateId,\n                t.UpdatedAt,\n                t.LastSyncedAt\n            ))\n            .ToListAsync(ct);\n\n        return (name, rows);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateSubmissionService.cs",
      "sha256": "f20bae95c8879896871df77f4ee2ca39f7a099434301260e08246e94fde44511",
      "language": "csharp",
      "size": 12173,
      "content": "using System.Text.Json;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Payload;\nusing xbytechat.api.Features.TemplateModule.Utils;\nusing xbytechat.api.Features.TemplateModule.Validators;\nusing xbytechat.api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateSubmissionService : ITemplateSubmissionService\n{\n    private readonly AppDbContext _db;\n    private readonly IMetaTemplateClient _meta;\n    private readonly ITemplateSyncService _templateSyncService;\n    public TemplateSubmissionService(AppDbContext db, IMetaTemplateClient meta, ITemplateSyncService templateSyncService)\n    {\n        _db = db;\n        _meta = meta;\n        _templateSyncService = templateSyncService;\n        \n    }\n\n    public async Task<TemplateSubmitResponseDto> SubmitAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        // 1) Load draft + variants\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null)\n            return new TemplateSubmitResponseDto { Success = false, Message = \"Draft not found.\" };\n\n        var variants = await _db.TemplateDraftVariants\n            .AsNoTracking()\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n        if (variants.Count == 0)\n            return new TemplateSubmitResponseDto { Success = false, Message = \"No language variants to submit.\" };\n\n        // 2) Validate cross-language parity\n        var views = variants.Select(v => new MultiLanguageValidator.VariantView\n        {\n            Language = v.Language,\n            BodyText = v.BodyText,\n            HeaderType = v.HeaderType,\n            HeaderText = v.HeaderText,\n            HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n            FooterText = v.FooterText,\n            Buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new(),\n            Examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new()\n        }).ToList();\n\n        var (ok, errors) = MultiLanguageValidator.Validate(views);\n        if (!ok)\n        {\n            var errMsg = string.Join(\" | \", errors.Select(kv => $\"{kv.Key}: {string.Join(\" ; \", kv.Value)}\"));\n            return new TemplateSubmitResponseDto\n            {\n                Success = false,\n                Message = \"Validation failed before submission.\",\n                Variants = variants.Select(v => new SubmittedVariantResult\n                {\n                    Language = v.Language,\n                    Status = errors.ContainsKey(v.Language) ? \"INVALID\" : \"READY\",\n                    RejectionReason = errors.ContainsKey(v.Language) ? string.Join(\" ; \", errors[v.Language]) : null\n                }).ToList()\n            };\n        }\n\n        // 3) Use the user-entered draft Key as the Meta template name (no business suffixes / random chars).\n        var name = (draft.Key ?? string.Empty).Trim();\n        if (string.IsNullOrWhiteSpace(name))\n            return new TemplateSubmitResponseDto { Success = false, Message = \"Template name is required.\" };\n\n        // Meta template name rules: lowercase letters, numbers, underscores, must start with a letter, max 25 chars.\n        if (name.Length > 25 || !System.Text.RegularExpressions.Regex.IsMatch(name, \"^[a-z][a-z0-9_]*$\"))\n        {\n            return new TemplateSubmitResponseDto\n            {\n                Success = false,\n                Message = \"Invalid template name. Use lowercase letters/numbers/underscores, start with a letter, max 25 characters.\"\n            };\n        }\n\n        // 4) Submit per language\n        var results = new List<SubmittedVariantResult>();\n        foreach (var v in variants)\n        {\n            var buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new();\n            var examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new();\n\n            // For media headers, HeaderMediaLocalUrl must be uploaded before CreateTemplate\n            string? headerMetaId = null;\n            if (!v.HeaderType.Equals(\"NONE\", StringComparison.OrdinalIgnoreCase) &&\n                !v.HeaderType.Equals(\"TEXT\", StringComparison.OrdinalIgnoreCase))\n            {\n                if (string.IsNullOrWhiteSpace(v.HeaderMediaLocalUrl))\n                {\n                    results.Add(new SubmittedVariantResult\n                    {\n                        Language = v.Language,\n                        Status = \"FAILED\",\n                        RejectionReason = \"Missing media for header.\"\n                    });\n                    continue;\n                }\n                try\n                {\n                    headerMetaId = await _meta.UploadMediaAsync(businessId, v.HeaderMediaLocalUrl!, v.HeaderType, ct);\n                }\n                catch (Exception ex)\n                {\n                    results.Add(new SubmittedVariantResult\n                    {\n                        Language = v.Language,\n                        Status = \"FAILED\",\n                        RejectionReason = ex.Message\n                    });\n                    continue;\n                }\n            }\n\n            var (components, examplePayload) =\n                MetaComponentsBuilder.Build(v.HeaderType, v.HeaderText, headerMetaId, v.BodyText, v.FooterText, buttons, examples);\n\n            // DEBUG: Log the payload to catch invalid parameter sources\n            Console.WriteLine($\"[Meta Submit] Components: {System.Text.Json.JsonSerializer.Serialize(components)}\");\n            Console.WriteLine($\"[Meta Submit] Examples: {System.Text.Json.JsonSerializer.Serialize(examplePayload)}\");\n\n            var created = await _meta.CreateTemplateAsync(\n                businessId: businessId,\n                name: name,\n                category: draft.Category,\n                language: v.Language,\n                componentsPayload: components,\n                examplesPayload: examplePayload,\n                ct: ct\n            );\n\n            string? friendlyError = null;\n            if (!created.Success)\n            {\n                var err = created.Error ?? \"Meta create call failed.\";\n                if (err.Contains(\"subcode 2388042\"))\n                    friendlyError = \"Meta rejected the template body structure. This category (like Authentication) may not allow custom text or specific formatting.\";\n                else if (err.ToLower().Contains(\"variables can't be at the start or end\") || err.ToLower().Contains(\"leading or trailing params\"))\n                    friendlyError = \"Variables cannot be at the very start or very end of the text.\";\n                else\n                    friendlyError = err;\n            }\n\n            results.Add(new SubmittedVariantResult\n            {\n                Language = v.Language,\n                Status = created.Success ? \"PENDING\" : \"FAILED\",\n                RejectionReason = created.Success ? null : friendlyError\n            });\n        }\n\n        var success = results.All(r => r.Status == \"PENDING\");\n\n        // Mark draft as submitted immediately (don't wait for sync)\n        if (success)\n        {\n            draft.SubmittedAt = DateTime.UtcNow;\n            await _db.SaveChangesAsync(ct);\n        }\n\n        // üîÑ Optimistically Create/Update Local \"Pending\" Records\n        if (success)\n        {\n            var now = DateTime.UtcNow;\n            Console.WriteLine($\"[Submission] Optimistically creating pending records for {variants.Count} variants.\");\n\n            foreach (var v in variants)\n            {\n                var lang = v.Language;\n                var existingTpl = await _db.WhatsAppTemplates\n                    .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.Name == name && x.LanguageCode == lang, ct);\n\n                if (existingTpl == null)\n                {\n                    Console.WriteLine($\"[Submission] Creating NEW pending template: {name} ({lang})\");\n                    // Re-build payload to store in RawJson for preview purposes\n                    var buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new();\n                    var examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new();\n                    // We don't upload media here again; just use local URL as placeholder if needed, or null. \n                    // Preview doesn't use the media ID from RawJson, it uses HeaderMediaUrl if available, \n                    // or falls back to 'header_handle' in 'example'.\n                    \n                    var (comps, _) = MetaComponentsBuilder.Build(\n                        v.HeaderType, \n                        v.HeaderText, \n                        null, // metaId not needed for preview structure\n                        v.BodyText, \n                        v.FooterText, \n                        buttons, \n                        examples);\n\n                    var rawObj = new { components = comps };\n                    var rawJson = JsonSerializer.Serialize(rawObj, JsonOpts);\n\n                    existingTpl = new xbytechat.api.AuthModule.Models.WhatsAppTemplate\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Name = name,\n                        LanguageCode = lang,\n                        Category = draft.Category,\n                        Status = \"PENDING\", \n                        Provider = \"META_CLOUD\", \n                        IsActive = true,\n                        CreatedAt = now,\n                        UpdatedAt = now,\n                        LastSyncedAt = now,\n                        Body = v.BodyText,\n                        HeaderKind = (v.HeaderType ?? \"NONE\").ToLowerInvariant(),\n                        HeaderText = v.HeaderText,\n                        RawJson = rawJson \n                    };\n                    _db.WhatsAppTemplates.Add(existingTpl);\n                }\n                else\n                {\n                    Console.WriteLine($\"[Submission] Updating EXISTING template to PENDING: {name} ({lang})\");\n                    existingTpl.Status = \"PENDING\";\n                    existingTpl.Body = v.BodyText;\n                    existingTpl.UpdatedAt = now;\n                    // Ensure active if it was deleted/inactive\n                    existingTpl.IsActive = true; \n                }\n            }\n            await _db.SaveChangesAsync(ct);\n            Console.WriteLine(\"[Submission] Optimistic records saved.\");\n        }\n\n        // üîÑ Auto-sync only if every language submitted OK\n        if (success)\n        {\n            try\n            {\n                // Force = true (ignore TTL), onlyUpsert = true (don‚Äôt deactivate others)\n                await _templateSyncService.SyncBusinessTemplatesAsync(businessId, force: true, onlyUpsert: true, ct);\n            }\n            catch (Exception ex)\n            {\n                // Non-fatal: submission succeeded; sync can be retried via existing endpoint\n                Console.WriteLine($\"[Template Submit] Sync warning: {ex.Message}\");\n            }\n        }\n\n        return new TemplateSubmitResponseDto\n        {\n            Success = success,\n            Message = success ? \"Submitted to Meta. Awaiting review.\" : \"Submitted with some failures.\",\n            Variants = results\n        };\n    }\n\n    public Task<int> SyncStatusAsync(Guid businessId, CancellationToken ct = default)\n    {\n        // Placeholder: in a later step we‚Äôll call provider ListTemplates and update your WhatsAppTemplates via your existing sync flow.\n        return Task.FromResult(0);\n    }\n\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web);\n\n    private static T? SafeDeserialize<T>(string? json)\n    {\n        if (string.IsNullOrWhiteSpace(json)) return default;\n        try { return JsonSerializer.Deserialize<T>(json!, JsonOpts); } catch { return default; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/WhatsAppTemplateService.cs",
      "sha256": "ee70376834e701f63425a69d50a4ea5d02170321edf828fe7fd2bd5d100bf3a1",
      "language": "csharp",
      "size": 2815,
      "content": "using Microsoft.Extensions.Configuration;\nusing Newtonsoft.Json;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Services\n{\n    public class WhatsAppTemplateService : IWhatsAppTemplateService\n    {\n        private readonly HttpClient _httpClient;\n        private readonly IConfiguration _config;\n        private readonly ILogger<WhatsAppTemplateService> _logger;\n\n        public WhatsAppTemplateService(HttpClient httpClient, IConfiguration config, ILogger<WhatsAppTemplateService> logger)\n        {\n            _httpClient = httpClient;\n            _config = config;\n            _logger = logger;\n        }\n\n        public async Task<List<TemplateMetadataDto>> FetchTemplatesAsync()\n        {\n            var wabaId = _config[\"WhatsApp:WABA_ID\"];\n            var token = _config[\"WhatsApp:apiToken\"];\n            var url = $\"https://graph.facebook.com/v18.0/{wabaId}/message_templates\";\n\n            var templates = new List<TemplateMetadataDto>();\n\n            try\n            {\n                _httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue(\"Bearer\", token);\n                var response = await _httpClient.GetAsync(url);\n                var json = await response.Content.ReadAsStringAsync();\n\n                if (!response.IsSuccessStatusCode)\n                {\n                    _logger.LogError(\"Failed to fetch WhatsApp templates: \" + json);\n                    return templates;\n                }\n\n                var parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n                foreach (var tpl in parsed.data)\n                {\n                    string name = tpl.name;\n                    string language = tpl.language ?? \"en_US\";\n                    string body = \"\";\n\n                    foreach (var component in tpl.components)\n                    {\n                        if (component.type == \"BODY\")\n                        {\n                            body = component.text;\n                            break;\n                        }\n                    }\n\n                    // Count {{placeholders}}\n                    var placeholderCount = System.Text.RegularExpressions.Regex.Matches(body, \"{{(.*?)}}\").Count;\n\n                    templates.Add(new TemplateMetadataDto\n                    {\n                        Name = name,\n                        Language = language,\n                        Body = body,\n                        PlaceholderCount = placeholderCount\n                    });\n                }\n\n                return templates;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\"Error while fetching templates from Meta: \" + ex.Message);\n                return templates;\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Utils/MetaNameHelper.cs",
      "sha256": "49bc1bb7e8945412aae2987bb0f6c7c539131cfa1b3db78cf43132431775b7cf",
      "language": "csharp",
      "size": 1237,
      "content": "using System.Text;\nusing System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.TemplateModule.Utils;\n\npublic static class MetaNameHelper\n{\n    // WhatsApp template name rules: lowercase, underscores, alnum and _ only, <= 25 chars.\n    private static readonly Regex Allowed = new(@\"[^a-z0-9_]+\", RegexOptions.Compiled);\n\n    public static string FromKey(string key, Guid businessId, string? suffix = null)\n    {\n        // 1) lower + underscores\n        var s = key.Trim().ToLowerInvariant()\n            .Replace(' ', '_')\n            .Replace('-', '_');\n\n        // 2) strip invalids\n        s = Allowed.Replace(s, \"\");\n\n        // 3) ensure starts with a letter\n        if (s.Length == 0 || !char.IsLetter(s[0]))\n            s = \"t_\" + s;\n\n        // 4) add optional suffix for uniqueness (e.g., short biz hash)\n        if (!string.IsNullOrWhiteSpace(suffix))\n            s = $\"{s}_{suffix}\".TrimEnd('_');\n\n        // 5) cap length 25 (WA limit)\n        if (s.Length > 25) s = s[..25];\n\n        // fallback safety\n        if (string.IsNullOrWhiteSpace(s)) s = \"t_\" + businessId.ToString(\"N\")[..6];\n        return s;\n    }\n\n    public static string ShortBizSuffix(Guid businessId)\n        => businessId.ToString(\"N\")[..6];\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/MultiLanguageValidator.cs",
      "sha256": "127b69bcf7da20b98dfa5ed636ade2a7858c176a770b5f32827e7d5f94774b76",
      "language": "csharp",
      "size": 3021,
      "content": "using System.Text.Json;\nusing xbytechat.api.Features.TemplateModule.Validation;\nusing xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic static class MultiLanguageValidator\n{\n    public sealed class VariantView\n    {\n        public required string Language { get; init; }\n        public required string BodyText { get; init; }\n        public required string HeaderType { get; init; }\n        public string? HeaderText { get; init; }\n        public string? HeaderMediaLocalUrl { get; init; }\n        public string? FooterText { get; init; }\n        public required List<ButtonDto> Buttons { get; init; }\n        public required Dictionary<string, string> Examples { get; init; }\n    }\n\n    public static (bool ok, Dictionary<string, List<string>> errors) Validate(IReadOnlyList<VariantView> variants)\n    {\n        var errors = new Dictionary<string, List<string>>(StringComparer.OrdinalIgnoreCase);\n        bool OkLang(string lang) => !errors.ContainsKey(lang) || errors[lang].Count == 0;\n        void Add(string lang, string msg)\n        {\n            if (!errors.TryGetValue(lang, out var list)) { list = new(); errors[lang] = list; }\n            list.Add(msg);\n        }\n\n        // 1) Per-variant rules (reuse VariantValidator)\n        foreach (var v in variants)\n        {\n            var dto = new TemplateDraftVariantUpsertDto\n            {\n                Language = v.Language,\n                BodyText = v.BodyText,\n                HeaderType = v.HeaderType,\n                HeaderText = v.HeaderText,\n                HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n                FooterText = v.FooterText,\n                Buttons = v.Buttons,\n                Examples = v.Examples\n            };\n            var r = VariantValidator.Validate(dto);\n            foreach (var e in r.Errors) Add(v.Language, e);\n        }\n\n        // 2) Cross-language placeholder arity/order parity\n        if (variants.Count > 1)\n        {\n            var reference = variants[0];\n            var refSlots = PlaceholderHelper.ExtractSlots(reference.BodyText);\n            var refSet = refSlots.ToHashSet();\n\n            foreach (var v in variants.Skip(1))\n            {\n                var slots = PlaceholderHelper.ExtractSlots(v.BodyText);\n                var set = slots.ToHashSet();\n\n                // arity parity\n                if (set.Count != refSet.Count)\n                    Add(v.Language, $\"Placeholder count mismatch vs {reference.Language}: expected {refSet.Count}, got {set.Count}.\");\n\n                // exact set parity (e.g., {1,2,3})\n                if (!set.SetEquals(refSet))\n                    Add(v.Language, $\"Placeholder indices mismatch vs {reference.Language}: expected {{{string.Join(\",\", refSet.OrderBy(x => x))}}}.\");\n\n                // continuity check already handled per-variant; this ensures cross-lang equality.\n            }\n        }\n\n        var ok = errors.Values.All(l => l.Count == 0);\n        return (ok, errors);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/PlaceholderHelper.cs",
      "sha256": "ed97ab0aeb570642914acf818213226b108002c5a37eff9b71b34f22f073ce08",
      "language": "csharp",
      "size": 1053,
      "content": "using System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.TemplateModule.Validation;\n\npublic static class PlaceholderHelper\n{\n    private static readonly Regex PlaceholderRx = new(@\"\\{\\{(\\d+)\\}\\}\", RegexOptions.Compiled);\n\n    public static List<int> ExtractSlots(string? text)\n    {\n        var list = new List<int>();\n        if (string.IsNullOrEmpty(text)) return list;\n        foreach (Match m in PlaceholderRx.Matches(text))\n        {\n            if (int.TryParse(m.Groups[1].Value, out var n)) list.Add(n);\n        }\n        return list;\n    }\n\n    public static (bool ok, string? error) EnsureContinuousFrom1(IReadOnlyCollection<int> slots)\n    {\n        if (slots.Count == 0) return (true, null);\n        var max = slots.Max();\n        var set = slots.ToHashSet();\n        for (int i = 1; i <= max; i++)\n        {\n            if (!set.Contains(i)) return (false, $\"Missing placeholder {{${i}}} (placeholders must be continuous from {{1}}..{{{max}}}).\".Replace(\"${i}\", i.ToString()));\n        }\n        return (true, null);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/TemplateDraftValidator.cs",
      "sha256": "b4d9c66c1acf1fd12bcfbeee9c84987acfe2a106989552e8bd9b271e3dd4df3a",
      "language": "csharp",
      "size": 170,
      "content": "namespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic sealed class TemplateDraftValidator\n{\n    // TODO: implement FluentValidation rules in a later step\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/TemplateDraftVariantValidator.cs",
      "sha256": "3b3c5e900711fd6a17344242b8f0e296a1e2b6f0fb1f6328718ecdf8752ec42e",
      "language": "csharp",
      "size": 196,
      "content": "namespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic sealed class TemplateDraftVariantValidator\n{\n    // TODO: implement rules: placeholders, buttons, media, language codes, etc.\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/TemplateRules.cs",
      "sha256": "d9236e131fabd0663a6ecf28f3a63527085fdf86ccc19ce2f63f2584586b2308",
      "language": "csharp",
      "size": 1336,
      "content": "namespace xbytechat.api.Features.TemplateModule.Validation;\n\npublic static class TemplateRules\n{\n    public const int MaxTemplateName = 25;              // applies when we later derive Meta name from Key\n    public const int MaxButtons = 3;\n    public const int MaxQuickReplyText = 25;            // conservative; WA may allow ~20-25\n    public const int MaxHeaderText = 60;                // conservative header text length\n    public const int MaxFooterText = 60;                // conservative footer text length\n    public const int MaxBodyLength = 1024;              // safe upper bound for WA template body\n\n    public static readonly HashSet<string> AllowedHeaderTypes = new(StringComparer.OrdinalIgnoreCase)\n    { \"NONE\", \"TEXT\", \"IMAGE\", \"VIDEO\", \"DOCUMENT\" };\n\n    public static readonly HashSet<string> AllowedButtonTypes = new(StringComparer.OrdinalIgnoreCase)\n    { \"QUICK_REPLY\", \"URL\", \"PHONE\" };\n\n    public static bool IsValidPhone(string? phone)\n        => !string.IsNullOrWhiteSpace(phone) && phone!.Trim().Length >= 7 && phone.Trim().Length <= 20;\n\n    public static bool IsValidUrl(string? url)\n    {\n        if (string.IsNullOrWhiteSpace(url)) return false;\n        return Uri.TryCreate(url, UriKind.Absolute, out var u)\n               && (u.Scheme == Uri.UriSchemeHttps || u.Scheme == Uri.UriSchemeHttp);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/VariantValidator.cs",
      "sha256": "7341d68d18242aa69adb7b1b568747716e8957393851b52251e3b2c000b62cbf",
      "language": "csharp",
      "size": 5073,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Validation;\nusing xbytechat.api.Features.TemplatesModule.Language;\n\nnamespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic static class VariantValidator\n{\n    public sealed class Result\n    {\n        public bool Ok => Errors.Count == 0;\n        public List<string> Errors { get; } = new();\n        public void Add(string msg) { if (!string.IsNullOrWhiteSpace(msg)) Errors.Add(msg); }\n    }\n\n    public static Result Validate(TemplateDraftVariantUpsertDto dto)\n    {\n        var r = new Result();\n\n        // language\n        if (!SupportedLanguages.IsSupported(dto.Language))\n            r.Add($\"Unsupported language: {dto.Language}\");\n\n        // body\n        if (string.IsNullOrWhiteSpace(dto.BodyText))\n            r.Add(\"BodyText is required.\");\n        else if (dto.BodyText.Length > TemplateRules.MaxBodyLength)\n            r.Add($\"BodyText too long (>{TemplateRules.MaxBodyLength}).\");\n\n        // placeholders\n        var slots = PlaceholderHelper.ExtractSlots(dto.BodyText);\n        var cont = PlaceholderHelper.EnsureContinuousFrom1(slots);\n        if (!cont.ok) r.Add(cont.error!);\n\n        // header\n        if (!TemplateRules.AllowedHeaderTypes.Contains(dto.HeaderType))\n            r.Add($\"HeaderType must be one of: {string.Join(\", \", TemplateRules.AllowedHeaderTypes)}\");\n\n        if (dto.HeaderType.Equals(\"TEXT\", StringComparison.OrdinalIgnoreCase))\n        {\n            if (string.IsNullOrWhiteSpace(dto.HeaderText))\n                r.Add(\"HeaderText required for TEXT header.\");\n            else if (dto.HeaderText.Length > TemplateRules.MaxHeaderText)\n                r.Add($\"HeaderText too long (>{TemplateRules.MaxHeaderText}).\");\n        }\n        else if (!dto.HeaderType.Equals(\"NONE\", StringComparison.OrdinalIgnoreCase))\n        {\n            // media header types\n            if (string.IsNullOrWhiteSpace(dto.HeaderMediaLocalUrl))\n                r.Add($\"HeaderMediaLocalUrl required for media header type {dto.HeaderType}.\");\n        }\n\n        // footer\n        if (!string.IsNullOrWhiteSpace(dto.FooterText) && dto.FooterText.Length > TemplateRules.MaxFooterText)\n            r.Add($\"FooterText too long (>{TemplateRules.MaxFooterText}).\");\n\n        // buttons\n        if (dto.Buttons is not null)\n        {\n            if (dto.Buttons.Count > TemplateRules.MaxButtons)\n                r.Add($\"At most {TemplateRules.MaxButtons} buttons are allowed.\");\n\n            int phoneCtas = 0;\n            int urlCtas = 0;\n            int quickReplies = 0;\n            var quickReplyTexts = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n\n            foreach (var b in dto.Buttons)\n            {\n                if (!TemplateRules.AllowedButtonTypes.Contains(b.Type))\n                {\n                    r.Add($\"Button type '{b.Type}' is invalid.\");\n                    continue;\n                }\n\n                if (string.IsNullOrWhiteSpace(b.Text))\n                {\n                    r.Add(\"Button text is required.\");\n                }\n                else if (b.Type.Equals(\"QUICK_REPLY\", StringComparison.OrdinalIgnoreCase))\n                {\n                    quickReplies++;\n                    if (b.Text.Length > TemplateRules.MaxQuickReplyText)\n                        r.Add($\"Quick Reply text too long (>{TemplateRules.MaxQuickReplyText}).\");\n                    if (!quickReplyTexts.Add(b.Text))\n                        r.Add(\"Duplicate Quick Reply button text not allowed.\");\n                }\n\n                if (b.Type.Equals(\"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    urlCtas++;\n                    if (!TemplateRules.IsValidUrl(b.Url))\n                        r.Add(\"URL button must have a valid http(s) Url.\");\n                }\n\n                if (b.Type.Equals(\"PHONE\", StringComparison.OrdinalIgnoreCase))\n                {\n                    phoneCtas++;\n                    if (!TemplateRules.IsValidPhone(b.Phone))\n                        r.Add(\"PHONE button must have a valid phone number.\");\n                }\n            }\n\n            if (phoneCtas > 1) r.Add(\"Only one PHONE CTA button is allowed.\");\n\n            var ctaCount = urlCtas + phoneCtas;\n            if (urlCtas > 1)\n                r.Add(\"Only one URL CTA button is allowed.\");\n            if (ctaCount > 2)\n                r.Add(\"Call-to-Action buttons allow a maximum of 2 (URL + PHONE).\");\n        }\n\n        // examples for placeholders\n        if (slots.Count > 0)\n        {\n            var need = slots.Max();\n            var missing = new List<string>();\n            for (int i = 1; i <= need; i++)\n            {\n                if (dto.Examples is null || !dto.Examples.ContainsKey(i.ToString()) || string.IsNullOrWhiteSpace(dto.Examples[i.ToString()]))\n                    missing.Add($\"{{{{{i}}}}}\");\n            }\n            if (missing.Count > 0)\n                r.Add($\"Examples required for placeholders: {string.Join(\", \", missing)}\");\n        }\n\n        return r;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Controllers/MessageLogsReportController.cs",
      "sha256": "57679ca179ec26b011a115fa136660702c25971ea0beb441c8805d2bdc911b49",
      "language": "csharp",
      "size": 10297,
      "content": "using System.Text;\nusing ClosedXML.Excel;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.Tracking.DTOs;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Shared; // for User.GetBusinessId()\n\nnamespace xbytechat.api.Features.Tracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/report/message-logs\")]\n    [Authorize]\n    public sealed class MessageLogsReportController : ControllerBase\n    {\n        private readonly IMessageLogsReportService _service;\n\n        public MessageLogsReportController(IMessageLogsReportService service)\n            => _service = service;\n\n        [HttpPost(\"search\")]\n        [ProducesResponseType(typeof(PaginatedResponse<MessageLogListItemDto>), StatusCodes.Status200OK)]\n        [ProducesResponseType(StatusCodes.Status401Unauthorized)]\n        public async Task<IActionResult> Search([FromBody] MessageLogReportQueryDto q, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            var result = await _service.SearchAsync(businessId, q, ct);\n            return Ok(result);\n        }\n\n        [HttpPost(\"export/csv\")]\n        [Produces(\"text/csv\")]\n        public async Task<IActionResult> ExportCsv([FromBody] MessageLogReportQueryDto q, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            // We‚Äôll walk pages to get the full dataset (service clamps PageSize to <= 200).\n            var sb = new StringBuilder();\n\n            // Header\n            sb.AppendLine(string.Join(\",\", new[]\n            {\n                \"Time\",\"Recipient\",\"SenderId\",\"Channel\",\"Status\",\"Type\",\"Campaign\",\n                \"Body\",\"ProviderId\",\"DeliveredAt\",\"ReadAt\",\"Error\"\n            }.Select(EscapeCsv)));\n\n            var page = 1;\n            const int maxLoops = 10000; // safety\n            var totalWritten = 0;\n\n            while (page <= maxLoops)\n            {\n                var pageQuery = new MessageLogReportQueryDto\n                {\n                    FromUtc = q.FromUtc,\n                    ToUtc = q.ToUtc,\n                    Search = q.Search,\n                    Statuses = q.Statuses,\n                    Channels = q.Channels,\n                    SenderIds = q.SenderIds,\n                    MessageTypes = q.MessageTypes,\n                    CampaignId = q.CampaignId,\n                    SortBy = q.SortBy,\n                    SortDir = q.SortDir,\n                    Page = page,\n                    PageSize = 200 // max page supported by service\n                };\n\n                var res = await _service.SearchAsync(businessId, pageQuery, ct);\n                if (res.Items.Count == 0) break;\n\n                foreach (var r in res.Items)\n                {\n                    var time = r.SentAt ?? r.CreatedAt;\n                    var row = new[]\n                    {\n                        EscapeCsv(time.ToLocalTime().ToString(\"yyyy-MM-dd HH:mm:ss\")),\n                        EscapeCsv(r.RecipientNumber ?? \"\"),\n                        EscapeCsv(r.SenderId ?? \"\"),\n                        EscapeCsv(r.SourceChannel ?? \"\"),\n                        EscapeCsv(r.Status ?? \"\"),\n                        EscapeCsv(r.MessageType ?? \"\"),\n                        EscapeCsv(r.CampaignName ?? r.CampaignId?.ToString() ?? \"\"),\n                        EscapeCsv((r.MessageContent ?? \"\").ReplaceLineEndings(\" \")),\n                        EscapeCsv(r.ProviderMessageId ?? \"\"),\n                        EscapeCsv(r.DeliveredAt?.ToLocalTime().ToString(\"yyyy-MM-dd HH:mm:ss\") ?? \"\"),\n                        EscapeCsv(r.ReadAt?.ToLocalTime().ToString(\"yyyy-MM-dd HH:mm:ss\") ?? \"\"),\n                        EscapeCsv((r.ErrorMessage ?? \"\").ReplaceLineEndings(\" \"))\n                    };\n                    sb.AppendLine(string.Join(\",\", row));\n                }\n\n                totalWritten += res.Items.Count;\n\n                // stop when we‚Äôve written everything\n                var total = res.TotalCount;\n                if (totalWritten >= total) break;\n\n                page++;\n            }\n\n            var bytes = Encoding.UTF8.GetBytes(sb.ToString());\n            var fileName =\n                $\"MessageLogs{(q.CampaignId.HasValue ? \"-\" + q.CampaignId.Value : \"\")}-{DateTime.UtcNow:yyyyMMddHHmmss}.csv\";\n\n            return File(bytes, \"text/csv\", fileName);\n\n            static string EscapeCsv(string s)\n            {\n                // Quote if contains comma, quote, or newline\n                if (s.Contains(',') || s.Contains('\"') || s.Contains('\\n') || s.Contains('\\r'))\n                {\n                    return $\"\\\"{s.Replace(\"\\\"\", \"\\\"\\\"\")}\\\"\";\n                }\n                return s;\n            }\n        }\n\n     \n        [HttpPost(\"export/pdf\")]\n        public IActionResult ExportPdfStub()\n        {\n            return StatusCode(StatusCodes.Status501NotImplemented, new ProblemDetails\n            {\n                Title = \"PDF export is not enabled\",\n                Detail = \"Implement in MessageLogsReportController.ExportPdf using a PDF library.\"\n            });\n        }\n\n        [HttpPost(\"export/xlsx\")]\n        [Produces(\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\")]\n        public async Task<IActionResult> ExportXlsx([FromBody] MessageLogReportQueryDto q, CancellationToken ct)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            // Page through all results using the same service used by the grid.\n            const int pageSize = 200; // service already clamps; keep explicit for clarity\n            var all = new List<MessageLogListItemDto>(capacity: pageSize * 5); // small pre-alloc\n\n            var page = 1;\n            while (true)\n            {\n                var pageQuery = new MessageLogReportQueryDto\n                {\n                    FromUtc = q.FromUtc,\n                    ToUtc = q.ToUtc,\n                    Search = q.Search,\n                    Statuses = q.Statuses,\n                    Channels = q.Channels,\n                    SenderIds = q.SenderIds,\n                    MessageTypes = q.MessageTypes,\n                    CampaignId = q.CampaignId,\n                    SortBy = q.SortBy,\n                    SortDir = q.SortDir,\n                    Page = page,\n                    PageSize = pageSize\n                };\n\n                var res = await _service.SearchAsync(businessId, pageQuery, ct);\n                if (res.Items.Count == 0) break;\n\n                all.AddRange(res.Items);\n\n                if (all.Count >= res.TotalCount) break; // done\n                page++;\n            }\n\n            // Build the workbook in memory\n            using var wb = new XLWorkbook();\n            var ws = wb.Worksheets.Add(\"MessageLogs\");\n\n            // Header\n            var headers = new[]\n            {\n        \"Time\",\"Recipient\",\"SenderId\",\"Channel\",\"Status\",\"Type\",\"Campaign\",\n        \"Body\",\"ProviderId\",\"DeliveredAt\",\"ReadAt\",\"Error\"\n    };\n            for (int c = 0; c < headers.Length; c++)\n                ws.Cell(1, c + 1).Value = headers[c];\n\n            // Simple header style\n            var headerRange = ws.Range(1, 1, 1, headers.Length);\n            headerRange.Style.Font.Bold = true;\n            headerRange.Style.Fill.BackgroundColor = XLColor.FromHtml(\"#F3F4F6\"); // light gray\n            headerRange.Style.Border.BottomBorder = XLBorderStyleValues.Thin;\n\n            // Rows\n            int r = 2;\n            foreach (var it in all)\n            {\n                var time = (it.SentAt ?? it.CreatedAt).ToLocalTime();\n\n                ws.Cell(r, 1).Value = time;\n                ws.Cell(r, 1).Style.DateFormat.Format = \"yyyy-mm-dd hh:mm:ss\";\n\n                ws.Cell(r, 2).Value = it.RecipientNumber ?? \"\";\n                ws.Cell(r, 3).Value = it.SenderId ?? \"\";\n                ws.Cell(r, 4).Value = it.SourceChannel ?? \"\";\n                ws.Cell(r, 5).Value = it.Status ?? \"\";\n                ws.Cell(r, 6).Value = it.MessageType ?? \"\";\n                ws.Cell(r, 7).Value = it.CampaignName ?? (it.CampaignId?.ToString() ?? \"\");\n\n                // Body/Errors as plain text to avoid newlines breaking rows\n                ws.Cell(r, 8).Value = (it.MessageContent ?? \"\").ReplaceLineEndings(\" \");\n                ws.Cell(r, 9).Value = it.ProviderMessageId ?? \"\";\n\n                if (it.DeliveredAt.HasValue)\n                {\n                    ws.Cell(r, 10).Value = it.DeliveredAt.Value.ToLocalTime();\n                    ws.Cell(r, 10).Style.DateFormat.Format = \"yyyy-mm-dd hh:mm:ss\";\n                }\n                else ws.Cell(r, 10).Value = \"\";\n\n                if (it.ReadAt.HasValue)\n                {\n                    ws.Cell(r, 11).Value = it.ReadAt.Value.ToLocalTime();\n                    ws.Cell(r, 11).Style.DateFormat.Format = \"yyyy-mm-dd hh:mm:ss\";\n                }\n                else ws.Cell(r, 11).Value = \"\";\n\n                ws.Cell(r, 12).Value = (it.ErrorMessage ?? \"\").ReplaceLineEndings(\" \");\n                r++;\n            }\n\n            // Fit columns\n            ws.Columns().AdjustToContents();\n\n            // Stream to client\n            using var ms = new MemoryStream();\n            wb.SaveAs(ms);\n            ms.Position = 0;\n\n            var fileName = $\"MessageLogs-{DateTime.UtcNow:yyyyMMddHHmmss}.xlsx\";\n            const string contentType = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n            return File(ms.ToArray(), contentType, fileName);\n        }\n        [HttpGet(\"facets\")]\n        [ProducesResponseType(typeof(MessageLogFacetsDto), StatusCodes.Status200OK)]\n        [ProducesResponseType(StatusCodes.Status401Unauthorized)]\n        public async Task<IActionResult> Facets([FromQuery] int fromDays = 90, CancellationToken ct = default)\n        {\n            var businessId = User.GetBusinessId();\n            if (businessId == Guid.Empty) return Unauthorized();\n\n            var fromUtc = DateTime.UtcNow.AddDays(-Math.Abs(fromDays));\n            var facets = await _service.GetFacetsAsync(businessId, fromUtc, ct);\n            return Ok(facets);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Controllers/TrackingController.cs",
      "sha256": "1b1691c172affbb2a81f1699e25328337f45d1d165e08d0cd5489b168fc9b05d",
      "language": "csharp",
      "size": 7107,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing System;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing xbytechat.api; // Your using for AppDbContext\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Features.Tracking.DTOs;\nusing xbytechat.api.Features.CampaignTracking.Worker; // Your using for DTOs\n\nnamespace xbytechat.api.Features.Tracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/tracking\")]\n    public class TrackingController : ControllerBase\n    {\n        private readonly ITrackingService _tracker;\n        private readonly AppDbContext _context;\n        private readonly IContactJourneyService _journeyService;\n        private readonly IJourneyExportService _journeyExport;\n        public TrackingController(ITrackingService tracker, AppDbContext context, IContactJourneyService journeyService, IJourneyExportService journeyExport)\n        {\n            _tracker = tracker;\n            _context = context;\n            _journeyService = journeyService;\n            _journeyExport = journeyExport;\n        }\n\n        [HttpGet(\"journeys/{campaignSendLogId}\")]\n        public async Task<IActionResult> GetJourney(Guid campaignSendLogId)\n        {\n            var journeyEvents = await _journeyService.GetJourneyEventsAsync(campaignSendLogId);\n            return Ok(journeyEvents);\n        }\n\n\n        //[HttpGet(\"redirect/{campaignSendLogId}\")]\n        //public async Task<IActionResult> TrackCampaignClick(\n        //    Guid campaignSendLogId,\n        //    [FromQuery] string type,\n        //    [FromQuery] string to)\n        //{\n        //    if (string.IsNullOrWhiteSpace(to))\n        //    {\n        //        return BadRequest(\"Missing redirect target URL.\");\n        //    }\n\n        //    var log = await _context.CampaignSendLogs.FindAsync(campaignSendLogId);\n        //    if (log != null)\n        //    {\n        //        log.IsClicked = true;\n        //        log.ClickedAt = DateTime.UtcNow;\n        //        log.ClickType = type;\n        //        log.IpAddress = HttpContext.Connection.RemoteIpAddress?.ToString();\n        //        await _context.SaveChangesAsync();\n        //    }\n\n        //    return Redirect(to);\n        //}\n\n        [HttpGet(\"redirect/{campaignSendLogId}\")]\n        public async Task<IActionResult> TrackCampaignClick(\n    Guid campaignSendLogId,\n    [FromQuery] string type,\n    [FromQuery] string to,\n    [FromQuery] int? idx = null,\n    CancellationToken ct = default)\n        {\n            if (string.IsNullOrWhiteSpace(to))\n                return BadRequest(\"Missing redirect target URL.\");\n\n            if (!Uri.TryCreate(to, UriKind.Absolute, out var destUri))\n                return BadRequest(\"Destination URL is invalid.\");\n\n            var clickType = string.IsNullOrWhiteSpace(type)\n                ? ClassifyClickType(destUri)\n                : type.Trim().ToLowerInvariant();\n\n            // Load parent CSL (tracked so we can update it)\n            var log = await _context.CampaignSendLogs.FindAsync(new object[] { campaignSendLogId }, ct);\n            if (log is not null)\n            {\n                var now = DateTime.UtcNow;\n                var ip = HttpContext.Connection.RemoteIpAddress?.ToString();\n                var ua = Request.Headers.UserAgent.ToString();\n\n                // First-click update on the send (idempotent enough for now)\n                log.IsClicked = true;\n                log.ClickedAt = now;\n                log.ClickType = clickType;\n                log.IpAddress = ip;\n\n                // Persist the click (ties to same run/session)\n                await _context.CampaignClickLogs.AddAsync(new CampaignClickLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignSendLogId = log.Id,\n                    CampaignId = log.CampaignId,// ?? Guid.Empty, // ‚úÖ coalesce; make column Guid? to avoid this\n                    ContactId = log.ContactId,                // Guid? OK\n                    ButtonIndex = (short)(idx ?? 0),\n                    ButtonTitle = string.IsNullOrWhiteSpace(type) ? \"link\" : type,\n                    Destination = destUri.ToString(),\n                    ClickedAt = now,\n                    Ip = ip ?? \"\",\n                    UserAgent = ua ?? \"\",\n                    ClickType = clickType,\n                    RunId = log.RunId                      // remove if your schema doesn‚Äôt have RunId\n                }, ct);\n\n                await _context.SaveChangesAsync(ct);\n            }\n\n            return Redirect(destUri.ToString());\n        }\n\n        // Simple classifier used above\n        private static string ClassifyClickType(Uri u)\n        {\n            if (u == null) return \"web\";\n            var scheme = u.Scheme?.ToLowerInvariant() ?? \"\";\n            if (scheme == \"tel\") return \"call\";\n            if (scheme == \"whatsapp\") return \"whatsapp\";\n            if (scheme is \"http\" or \"https\")\n            {\n                var host = u.Host?.ToLowerInvariant() ?? \"\";\n                if (host.Contains(\"wa.me\") || host.Contains(\"api.whatsapp.com\"))\n                    return \"whatsapp\";\n            }\n            return \"web\";\n        }\n\n        /// <summary>\n        /// Gets detailed information for a specific tracking log entry.\n        /// </summary>\n        [HttpGet(\"logs/{id}/details\")]\n        public async Task<IActionResult> GetLogDetails(Guid id)\n        {\n            var result = await _tracker.GetLogDetailsAsync(id);\n            if (result == null)\n                return NotFound(\"Tracking log not found\");\n\n            return Ok(result);\n        }\n\n        /// <summary>\n        /// Retrieves click logs specifically related to automation flows.\n        /// </summary>\n        [HttpGet(\"flow-clicks\")]\n        public async Task<IActionResult> GetFlowClickLogs()\n        {\n            var businessIdClaim = User.FindFirst(\"businessId\")?.Value;\n            if (!Guid.TryParse(businessIdClaim, out var businessId))\n                return BadRequest(\"‚ùå Invalid or missing business ID\");\n\n            var logs = await _tracker.GetFlowClickLogsAsync(businessId);\n\n            var dtoList = logs.Select(x => new\n            {\n                x.Id,\n                x.StepId,\n                x.ContactPhone,\n                x.ButtonText,\n                x.TemplateId,\n                x.FollowUpSent,\n                x.ClickedAt\n            });\n\n            return Ok(dtoList);\n        }\n        [HttpGet(\"journeys/{campaignSendLogId:guid}/export/csv\")]\n        public async Task<IActionResult> ExportJourneyCsv(Guid campaignSendLogId, CancellationToken ct)\n        {\n            var res = await _journeyExport.ExportJourneyCsvAsync(campaignSendLogId, ct);\n            return File(res.Bytes, res.ContentType, res.FileName);\n        }\n\n        [HttpGet(\"journeys/{campaignSendLogId:guid}/export/xlsx\")]\n        public async Task<IActionResult> ExportJourneyXlsx(Guid campaignSendLogId, CancellationToken ct)\n        {\n            var res = await _journeyExport.ExportJourneyXlsxAsync(campaignSendLogId, ct);\n            return File(res.Bytes, res.ContentType, res.FileName);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Controllers/TrackingViewerController.cs",
      "sha256": "6dfeff85fe69af455c90c7ae2ad1fd0614866359c0eaee39cf101ca67b819507",
      "language": "csharp",
      "size": 1584,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Tracking.Models;\nusing xbytechat.api;\n\nnamespace xbytechat.api.Features.Tracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/tracking/logs\")]\n    public class TrackingViewerController : ControllerBase\n    {\n        private readonly AppDbContext _context;\n\n        public TrackingViewerController(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAll([FromQuery] Guid? campaignId = null)\n        {\n            var query = _context.TrackingLogs\n                .Include(t => t.Campaign) // Optional\n                .Include(t => t.Contact)  // Optional\n                .OrderByDescending(t => t.ClickedAt)\n                .AsQueryable();\n\n            if (campaignId.HasValue)\n                query = query.Where(t => t.CampaignId == campaignId);\n\n            var results = await query\n                .Select(t => new\n                {\n                    t.Id,\n                    t.ContactPhone,\n                    ContactName = t.Contact != null ? t.Contact.Name : \"(N/A)\",\n                    t.ButtonText,\n                    t.CTAType,\n                    t.SourceType,\n                    t.ClickedAt,\n                    t.DeviceType,\n                    t.Country,\n                    CampaignName = t.Campaign != null ? t.Campaign.Name : \"(Unknown)\"\n                })\n                .ToListAsync();\n\n            return Ok(new { success = true, data = results });\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/DTOs/JourneyEventDto.cs",
      "sha256": "34abc81cfaea73e66ebb64431d3723ede8e2ac5cab0fcd6e8f4a1b2bbfe20320",
      "language": "csharp",
      "size": 727,
      "content": "namespace xbytechat.api.Features.Tracking.DTOs\n{\n    public class JourneyEventDto\n    {\n        public DateTime Timestamp { get; set; }\n        public string Source { get; set; } = \"System\"; // System/User/Provider\n        public string EventType { get; set; } = \"\";    // MessageSent/Delivered/Read/ButtonClicked/FlowStep/FlowSend/Redirect/Error\n        public string Title { get; set; } = \"\";\n        public string Details { get; set; } = \"\";\n        public Guid? StepId { get; set; }\n        public string? StepName { get; set; }\n        public int? ButtonIndex { get; set; }\n        public string? ButtonTitle { get; set; }\n        public string? Url { get; set; }\n        public string? TemplateName { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/DTOs/JourneyResponseDto.cs",
      "sha256": "0dd5d4a7faf319e281c5c96d6a7164a6e763aba0de03a617e58165196f48dffa",
      "language": "csharp",
      "size": 549,
      "content": "namespace xbytechat.api.Features.Tracking.DTOs\n{\n    public class JourneyResponseDto\n    {\n        public string CampaignType { get; set; } = \"dynamic_url\"; // or \"flow\"\n        public string? FlowName { get; set; }\n        public Guid? FlowId { get; set; }\n        public Guid CampaignId { get; set; }\n        public Guid ContactId { get; set; }\n        public string ContactPhone { get; set; } = \"\";\n        public List<JourneyEventDto> Events { get; set; } = new();\n        public string? LeftOffAt { get; set; }  // step title or reason\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/DTOs/MessageLogFacetsDto.cs",
      "sha256": "78f9fb1561eb81fa5af81dd2df22164d18841f71475f5d10400f18a702c8fa0f",
      "language": "csharp",
      "size": 516,
      "content": "namespace xbytechat.api.Features.Tracking.DTOs\n{\n    public sealed class MessageLogFacetsDto\n    {\n        public string[] WabaIds { get; init; } = Array.Empty<string>();     // WhatsAppBusinessNumber\n        public string[] SenderIds { get; init; } = Array.Empty<string>();   // Campaign.PhoneNumberId\n        public string[] Channels { get; init; } = Array.Empty<string>();    // provider (e.g., META, PINNACLE)\n        public string[] Statuses { get; init; } = Array.Empty<string>();    // message status\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/DTOs/MessageLogReportQueryDto.cs",
      "sha256": "d92aa8928329edd484bc7c51d8c0be8b7adad6acf6e1996007b37f993214c4aa",
      "language": "csharp",
      "size": 1843,
      "content": "namespace xbytechat.api.Features.Tracking.DTOs\n{\n    public sealed class MessageLogReportQueryDto\n    {\n        public DateTime? FromUtc { get; set; }\n        public DateTime? ToUtc { get; set; }\n        public string? Search { get; set; }                 // phone or text contains\n        public string[]? Statuses { get; set; }             // Sent/Delivered/Read/Failed etc.\n        public string[]? Channels { get; set; }             // meta_cloud/sms/email‚Ä¶\n        public string[]? SenderIds { get; set; }            // phone_number_id\n        public string[]? MessageTypes { get; set; }         // text/image/template‚Ä¶\n        public Guid? CampaignId { get; set; }               // optional scope\n\n        public string? SortBy { get; set; } = \"SentAt\";     // server-whitelisted\n        public string? SortDir { get; set; } = \"desc\";      // asc|desc\n\n        public int Page { get; set; } = 1;\n        public int PageSize { get; set; } = 25;\n    }\n\n    public sealed class MessageLogListItemDto\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid? CampaignId { get; set; }\n        public string? CampaignName { get; set; }\n\n        public string? RecipientNumber { get; set; }\n        public string? SenderId { get; set; }\n        public string? SourceChannel { get; set; }\n        public string? Status { get; set; }\n        public string? MessageType { get; set; }\n\n        public string? MessageContent { get; set; }\n        public string? TemplateName { get; set; }\n        public string? ProviderMessageId { get; set; }\n        public string? ErrorMessage { get; set; }\n\n        public DateTime CreatedAt { get; set; }\n        public DateTime? SentAt { get; set; }\n        public DateTime? DeliveredAt { get; set; }\n        public DateTime? ReadAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/DTOs/TrackingLogDetailsDto.cs",
      "sha256": "d0cfbc11c40d0e6a7494b91c4bdd7676b9dc6d0fe5461634c7638f4a84cca5ac",
      "language": "csharp",
      "size": 462,
      "content": "using xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.MessageManagement.DTOs;\n\nnamespace xbytechat.api.Features.Tracking.DTOs\n{\n    public class TrackingLogDetailsDto\n    {\n        public TrackingLogDto Tracking { get; set; } = new();\n        public ContactDto? Contact { get; set; }\n        public CampaignDto? Campaign { get; set; }\n        public MessageLogDto? MessageLog { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/DTOs/TrackingLogDto.cs",
      "sha256": "bae94801851bba1bbeb94d60e81f2d20efd13b86be1391265098462d82a3c762",
      "language": "csharp",
      "size": 1798,
      "content": "using System;\n\nnamespace xbytechat.api.Features.Tracking.DTOs\n{\n    public class TrackingLogDto\n    {\n        // üß© Multi-Tenant Isolation\n        public Guid BusinessId { get; set; }\n\n        // üë§ CRM Linkage\n        public Guid? ContactId { get; set; }\n        public string? ContactPhone { get; set; }\n\n        // üîó Source Info\n        public string SourceType { get; set; } = string.Empty; // e.g. \"campaign\", \"reminder\", \"bot\"\n        public Guid? SourceId { get; set; }\n\n        // üîò CTA Info\n        public string? ButtonText { get; set; }\n        public string? CTAType { get; set; }\n\n        // üì® Message Context\n        public string? MessageId { get; set; }\n        public string? TemplateId { get; set; }\n        public Guid? MessageLogId { get; set; }\n\n        // üß† Meta / Behaviour\n        public string? ClickedVia { get; set; }\n        public string? Referrer { get; set; }\n        public DateTime? ClickedAt { get; set; } = DateTime.UtcNow;\n        // üì° Tracking\n        public string? IPAddress { get; set; }\n        public string? Browser { get; set; }\n        public string? DeviceType { get; set; }\n        public string? Country { get; set; }\n        public string? City { get; set; }\n\n        // üîñ Session context\n        public string? SessionId { get; set; }\n        public string? ThreadId { get; set; }\n\n        public Guid? CampaignId { get; set; }\n        public Guid? CampaignSendLogId { get; set; }\n\n        public string RawJson { get; set; } = string.Empty; // used in queue method\n        public DateTime EnqueuedAt { get; set; } // used in queue method\n        public string? NextStepMatched { get; set; } // ‚úÖ Add this if not already there\n\n        public string? TemplateName { get; set; } // ‚úÖ Needed for follow-up matcher\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Models/TrackingLog.cs",
      "sha256": "bd0559aca22f0289bf1f445973d52a25d32c68d0a7ed48ada5c7e4408850ca1d",
      "language": "csharp",
      "size": 2261,
      "content": "using xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.Tracking.Models;\nnamespace xbytechat.api.Features.Tracking.Models\n{\n    public class TrackingLog\n    {\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        // üß© Multi-Tenant Isolation\n        public Guid BusinessId { get; set; }\n\n        // üë§ CRM Linkage\n        public Guid? ContactId { get; set; }\n        public string? ContactPhone { get; set; }\n        public Contact? Contact { get; set; } // ‚úÖ NEW\n\n        // üîó Source Info\n        public string SourceType { get; set; } = string.Empty;\n        public Guid? SourceId { get; set; }\n\n        public Guid? CampaignId { get; set; }\n        public Campaign? Campaign { get; set; } // ‚úÖ NEW\n\n        public Guid? CampaignSendLogId { get; set; }\n        public CampaignSendLog? CampaignSendLog { get; set; } // ‚úÖ Optional\n\n        // üîò Button Info\n        public string? ButtonText { get; set; }\n        public string? CTAType { get; set; }\n\n        // üì® Message Context\n        public string? MessageId { get; set; }\n        public string? TemplateId { get; set; }\n        public Guid? MessageLogId { get; set; }\n        public MessageLog? MessageLog { get; set; } // ‚úÖ Optional\n\n        // üß† Meta / Behaviour\n        public string? ClickedVia { get; set; }\n        public string? Referrer { get; set; }\n\n        // üïí Audit Trail\n        public DateTime ClickedAt { get; set; } = DateTime.UtcNow;\n        public string? IPAddress { get; set; }\n        public string? DeviceType { get; set; }\n        public string? Browser { get; set; }\n        public string? Country { get; set; }\n        public string? City { get; set; }\n\n        // üîñ Follow-up & Analytics\n        public bool FollowUpSent { get; set; } = false;\n        public string? LastInteractionType { get; set; }\n\n        // üßµ Journey Tracking\n        public Guid? SessionId { get; set; }\n        public Guid? ThreadId { get; set; }\n        public Guid? StepId { get; set; } // ‚úÖ Link to CTAFlowStep for CTA Flow tracking\n\n       //  public string? NextStepMatched { get; set; } // Logs which template system resolved\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/ContactJourneyService.cs",
      "sha256": "9a1e3dc83415ab3247dd2ab049a9b332cdad294bfcffabd80ed351ca79d8f815",
      "language": "csharp",
      "size": 16419,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing System.Collections.Generic;\n\nusing xbytechat.api.Features.CTAFlowBuilder.Models;\nusing xbytechat.api.Features.Tracking.DTOs;\n\nnamespace xbytechat.api.Features.Tracking.Services\n{\n    public class ContactJourneyService : IContactJourneyService\n    {\n        private readonly AppDbContext _context;\n\n        public ContactJourneyService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        public async Task<JourneyResponseDto> GetJourneyEventsAsync(Guid initialCampaignSendLogId, CancellationToken ct = default)\n        {\n            var resp = new JourneyResponseDto { Events = new List<JourneyEventDto>() };\n            var events = resp.Events;\n\n            // 0) Load the selected send (campaign required; contact optional)\n            var sentLog = await _context.CampaignSendLogs\n                .AsNoTracking()\n                .Include(x => x.Campaign)\n                .Include(x => x.Contact)\n                .FirstOrDefaultAsync(x => x.Id == initialCampaignSendLogId, ct);\n\n            if (sentLog is null || sentLog.Campaign is null)\n                return resp;\n\n            var campaignId = sentLog.CampaignId;\n            resp.CampaignId = campaignId;\n            resp.CampaignType = sentLog.CTAFlowConfigId.HasValue ? \"flow\" : \"dynamic_url\";\n            resp.FlowId = sentLog.CTAFlowConfigId;\n\n            if (sentLog.ContactId.HasValue)\n                resp.ContactId = sentLog.ContactId.Value;\n\n            // ---- Resolve a phone for display/flow fallback --------------------------------------------\n            string? phone = sentLog.Contact?.PhoneNumber;\n\n            // via MessageLog\n            if (string.IsNullOrWhiteSpace(phone) && sentLog.MessageLogId.HasValue)\n            {\n                phone = await _context.MessageLogs.AsNoTracking()\n                    .Where(m => m.Id == sentLog.MessageLogId.Value && m.BusinessId == sentLog.BusinessId)\n                    .Select(m => m.RecipientNumber)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            // via Recipient ‚Üí Contact or AudienceMember\n            if (string.IsNullOrWhiteSpace(phone) && sentLog.RecipientId != Guid.Empty)\n            {\n                var rec = await _context.CampaignRecipients.AsNoTracking()\n                    .Where(r => r.Id == sentLog.RecipientId)\n                    .Select(r => new { r.ContactId, r.AudienceMemberId })\n                    .FirstOrDefaultAsync(ct);\n\n                if (rec is not null)\n                {\n                    if (rec.ContactId.HasValue)\n                        phone = await _context.Contacts.AsNoTracking()\n                            .Where(c => c.Id == rec.ContactId.Value)\n                            .Select(c => c.PhoneNumber)\n                            .FirstOrDefaultAsync(ct);\n                    else if (rec.AudienceMemberId.HasValue)\n                        phone = await _context.AudienceMembers.AsNoTracking()\n                            .Where(a => a.Id == rec.AudienceMemberId.Value)\n                            .Select(a => a.PhoneE164)\n                            .FirstOrDefaultAsync(ct);\n                }\n            }\n\n            resp.ContactPhone = phone ?? \"\";\n\n            // ---- 1) Session window ---------------------------------------------------------------------\n            var sessionStart = sentLog.SentAt ?? sentLog.CreatedAt;\n            DateTime sessionEnd;\n\n            if (sentLog.ContactId.HasValue)\n            {\n                var contactId = sentLog.ContactId.Value;\n\n                var nextSameCampaignAt = await _context.CampaignSendLogs.AsNoTracking()\n                    .Where(x => x.ContactId == contactId &&\n                                x.CampaignId == campaignId &&\n                                x.CreatedAt > sessionStart)\n                    .OrderBy(x => x.CreatedAt)\n                    .Select(x => (DateTime?)x.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n\n                DateTime? nextSameFlowAt = null;\n                if (sentLog.CTAFlowConfigId.HasValue)\n                {\n                    var flowId = sentLog.CTAFlowConfigId.Value;\n                    nextSameFlowAt = await _context.CampaignSendLogs.AsNoTracking()\n                        .Where(x => x.ContactId == contactId &&\n                                    x.CTAFlowConfigId == flowId &&\n                                    x.CreatedAt > sessionStart)\n                        .OrderBy(x => x.CreatedAt)\n                        .Select(x => (DateTime?)x.CreatedAt)\n                        .FirstOrDefaultAsync(ct);\n                }\n\n                sessionEnd = new[] { nextSameCampaignAt, nextSameFlowAt }\n                    .Where(dt => dt.HasValue)\n                    .Select(dt => dt!.Value)\n                    .DefaultIfEmpty(sessionStart.AddHours(24))\n                    .Min();\n            }\n            else\n            {\n                // No ContactId: keep it simple and robust\n                sessionEnd = sessionStart.AddHours(24);\n            }\n\n            // ---- 2) Initial \"sent\" + statuses from CSL -------------------------------------------------\n            events.Add(new JourneyEventDto\n            {\n                Timestamp = sessionStart,\n                Source = \"System\",\n                EventType = \"MessageSent\",\n                Title = $\"Campaign '{sentLog.Campaign?.Name ?? \"Campaign\"}' sent\",\n                Details = string.IsNullOrWhiteSpace(resp.ContactPhone) ? null :\n                               $\"Template '{sentLog.TemplateId}' to {resp.ContactPhone}\",\n                TemplateName = sentLog.TemplateId\n            });\n\n            if (sentLog.DeliveredAt is { } d1 && d1 >= sessionStart && d1 < sessionEnd)\n                events.Add(new JourneyEventDto\n                {\n                    Timestamp = d1,\n                    Source = \"Provider\",\n                    EventType = \"Delivered\",\n                    Title = \"Message delivered\",\n                    Details = string.IsNullOrWhiteSpace(resp.ContactPhone) ? null : $\"Delivered to {resp.ContactPhone}\",\n                    TemplateName = sentLog.TemplateId\n                });\n\n            if (sentLog.ReadAt is { } r1 && r1 >= sessionStart && r1 < sessionEnd)\n                events.Add(new JourneyEventDto\n                {\n                    Timestamp = r1,\n                    Source = \"Provider\",\n                    EventType = \"Read\",\n                    Title = \"Message read\",\n                    Details = string.IsNullOrWhiteSpace(resp.ContactPhone) ? null : $\"Read by {resp.ContactPhone}\",\n                    TemplateName = sentLog.TemplateId\n                });\n\n            // ---- 3) URL clicks for THIS send within the window ----------------------------------------\n            var urlClicksInitial = await _context.CampaignClickLogs\n                .AsNoTracking()\n                .Where(c => c.CampaignSendLogId == sentLog.Id &&\n                            c.ClickedAt >= sessionStart && c.ClickedAt < sessionEnd)\n                .OrderBy(c => c.ClickedAt)\n                .ToListAsync(ct);\n\n            foreach (var c in urlClicksInitial)\n            {\n                events.Add(new JourneyEventDto\n                {\n                    Timestamp = c.ClickedAt,\n                    Source = \"User\",\n                    EventType = \"Redirect\",\n                    Title = $\"Clicked URL: '{c.ButtonTitle}'\",\n                    Details = $\"Redirected to {c.Destination}\",\n                    ButtonIndex = c.ButtonIndex,\n                    ButtonTitle = c.ButtonTitle,\n                    Url = c.Destination\n                });\n            }\n\n            // ---- 4) FLOW chain & clicks ‚Äî robust against EF translation bugs --------------------------\n            var flowEvents = new List<JourneyEventDto>(8);\n            Guid? detectedFlowId = sentLog.CTAFlowConfigId;\n\n            try\n            {\n                // Helper to limit to window and business\n                IQueryable<FlowExecutionLog> Window(IQueryable<FlowExecutionLog> q) =>\n                    q.AsNoTracking()\n                     .Where(f => f.BusinessId == sentLog.BusinessId &&\n                                 f.ExecutedAt >= sessionStart && f.ExecutedAt < sessionEnd);\n\n                // Helper to project only needed columns (keeps SQL simple)\n                IQueryable<FlowExecutionLog> Pick(IQueryable<FlowExecutionLog> q) =>\n                    q.Select(f => new FlowExecutionLog\n                    {\n                        Id = f.Id,\n                        FlowId = f.FlowId,\n                        ExecutedAt = f.ExecutedAt,\n                        CampaignSendLogId = f.CampaignSendLogId,\n                        MessageLogId = f.MessageLogId,\n                        StepId = f.StepId,\n                        StepName = f.StepName,\n                        TemplateName = f.TemplateName,\n                        TriggeredByButton = f.TriggeredByButton,\n                        ButtonIndex = f.ButtonIndex,\n                        BusinessId = f.BusinessId,\n                        ContactPhone = f.ContactPhone,\n                        RunId = f.RunId\n                    });\n\n                // A) Prefer RunId when present\n                var qRun = Window(_context.FlowExecutionLogs);\n                if (sentLog.RunId != null)\n                    qRun = qRun.Where(f => f.RunId == sentLog.RunId);\n\n                // B) Always include direct references to this CSL/MessageLog\n                var qDirect = Window(_context.FlowExecutionLogs)\n                    .Where(f =>\n                        (f.CampaignSendLogId.HasValue && f.CampaignSendLogId.Value == sentLog.Id) ||\n                        (sentLog.MessageLogId.HasValue && f.MessageLogId == sentLog.MessageLogId));\n\n                // C) Fallback: phone forms (+E.164 / digits only)\n                IQueryable<FlowExecutionLog> qPhone = Enumerable.Empty<FlowExecutionLog>().AsQueryable();\n                if (!string.IsNullOrWhiteSpace(phone))\n                {\n                    var digits = new string(phone.Where(char.IsDigit).ToArray());\n                    var alt = phone.StartsWith(\"+\") ? digits : \"+\" + digits;\n                    qPhone = Window(_context.FlowExecutionLogs)\n                        .Where(f => f.ContactPhone == phone ||\n                                    f.ContactPhone == digits ||\n                                    f.ContactPhone == alt);\n                }\n\n                // Materialize each branch separately (avoid EF's problematic GroupBy + Concat translation)\n                var listRun = await Pick(qRun).OrderBy(f => f.ExecutedAt).ToListAsync(ct);\n                var listDirect = await Pick(qDirect).OrderBy(f => f.ExecutedAt).ToListAsync(ct);\n                var listPhone = await Pick(qPhone).OrderBy(f => f.ExecutedAt).ToListAsync(ct);\n\n                // Merge & distinct in-\n                // \n                var felAll = listRun\n                    .Concat(listDirect)\n                    .Concat(listPhone)\n                    .GroupBy(f => f.Id)\n                    .Select(g => g.First())\n                    .OrderBy(f => f.ExecutedAt)\n                    .ToList();\n\n                if (felAll.Count > 0)\n                    detectedFlowId ??= felAll.FirstOrDefault()?.FlowId;\n\n                // If we found any flow events but original send looked Dynamic URL, upgrade the envelope\n                if (felAll.Count > 0 && !sentLog.CTAFlowConfigId.HasValue)\n                {\n                    resp.CampaignType = \"flow\";\n                    resp.FlowId = detectedFlowId;\n                }\n\n                if (resp.FlowId.HasValue && string.IsNullOrWhiteSpace(resp.FlowName))\n                {\n                    resp.FlowName = await _context.CTAFlowConfigs.AsNoTracking()\n                        .Where(f => f.Id == resp.FlowId.Value)\n                        .Select(f => f.FlowName)\n                        .FirstOrDefaultAsync(ct);\n                }\n\n                foreach (var fe in felAll)\n                {\n                    if (!string.IsNullOrWhiteSpace(fe.TriggeredByButton))\n                    {\n                        flowEvents.Add(new JourneyEventDto\n                        {\n                            Timestamp = fe.ExecutedAt,\n                            Source = \"User\",\n                            EventType = \"ButtonClicked\",\n                            Title = $\"Clicked Quick Reply: '{fe.TriggeredByButton}'\",\n                            Details = string.IsNullOrWhiteSpace(fe.TemplateName)\n                                        ? (string.IsNullOrWhiteSpace(fe.StepName) ? null : $\"Advanced in flow at step '{fe.StepName}'\")\n                                        : $\"Triggered next template: '{fe.TemplateName}'\",\n                            StepId = fe.StepId,\n                            StepName = fe.StepName,\n                            ButtonIndex = fe.ButtonIndex,\n                            ButtonTitle = fe.TriggeredByButton,\n                            TemplateName = fe.TemplateName\n                        });\n                    }\n\n                    if (!string.IsNullOrWhiteSpace(fe.TemplateName))\n                    {\n                        flowEvents.Add(new JourneyEventDto\n                        {\n                            Timestamp = fe.ExecutedAt,\n                            Source = \"System\",\n                            EventType = \"FlowSend\",\n                            Title = $\"Flow sent template '{fe.TemplateName}'\",\n                            Details = string.IsNullOrWhiteSpace(fe.StepName) ? null : $\"Step '{fe.StepName}'\",\n                            StepId = fe.StepId,\n                            StepName = fe.StepName,\n                            TemplateName = fe.TemplateName\n                        });\n                    }\n                }\n\n                // Also include URL clicks that happened during the flow window across the chain\n                if (felAll.Count > 0)\n                {\n                    var cslIdsFromFel = felAll\n                        .Where(f => f.CampaignSendLogId.HasValue)\n                        .Select(f => f.CampaignSendLogId!.Value)\n                        .Distinct()\n                        .ToList();\n\n                    if (cslIdsFromFel.Count > 0)\n                    {\n                        var flowClicks = await _context.CampaignClickLogs.AsNoTracking()\n                            .Where(c => c.ClickedAt >= sessionStart &&\n                                        c.ClickedAt < sessionEnd &&\n                                        cslIdsFromFel.Contains(c.CampaignSendLogId))\n                            .OrderBy(c => c.ClickedAt)\n                            .ToListAsync(ct);\n\n                        foreach (var c in flowClicks)\n                        {\n                            flowEvents.Add(new JourneyEventDto\n                            {\n                                Timestamp = c.ClickedAt,\n                                Source = \"User\",\n                                EventType = \"Redirect\",\n                                Title = $\"Clicked URL: '{c.ButtonTitle}'\",\n                                Details = $\"Redirected to {c.Destination}\",\n                                ButtonIndex = c.ButtonIndex,\n                                ButtonTitle = c.ButtonTitle,\n                                Url = c.Destination\n                            });\n                        }\n                    }\n                }\n            }\n            catch (Exception ex) when (ex is InvalidOperationException || ex is KeyNotFoundException)\n            {\n                // Defensive: never bubble the EF translation issue; return what we have.\n                // You can log here if you have a logger: _logger.LogWarning(ex, \"Flow merge failed\");\n            }\n\n            events.AddRange(flowEvents);\n\n            // Left-off marker (last flow action)\n            var lastFlowEvent = flowEvents.OrderBy(e => e.Timestamp).LastOrDefault();\n            resp.LeftOffAt = lastFlowEvent?.StepName ?? lastFlowEvent?.Title;\n\n            // ---- Final ordering ------------------------------------------------------------------------\n            resp.Events = events.OrderBy(e => e.Timestamp).ToList();\n            return resp;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/IContactJourneyService.cs",
      "sha256": "c42d77aa80d0e55d821ab2afa31fdd353c5b3913e217a686b3eb01240d0bbb54",
      "language": "csharp",
      "size": 373,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Tracking.DTOs; // Updated namespace\n\nnamespace xbytechat.api.Features.Tracking.Services\n{\n    public interface IContactJourneyService\n    {\n        Task<JourneyResponseDto> GetJourneyEventsAsync(Guid initialCampaignSendLogId, CancellationToken ct = default);\n    }\n}"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/IJourneyExportService.cs",
      "sha256": "f8442c2d8fbb9a4d40db57b43dd2355025aeee572a6646a5739ecc434411085f",
      "language": "csharp",
      "size": 607,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Tracking.Services\n{\n    public interface IJourneyExportService\n    {\n        Task<ExportResult> ExportJourneyCsvAsync(Guid campaignSendLogId, CancellationToken ct = default);\n        Task<ExportResult> ExportJourneyXlsxAsync(Guid campaignSendLogId, CancellationToken ct = default);\n    }\n\n    public sealed class ExportResult\n    {\n        public required byte[] Bytes { get; init; }\n        public required string ContentType { get; init; }\n        public required string FileName { get; init; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/IMessageLogsReportService.cs",
      "sha256": "c9879941a987b70fa6796fad4ee97fce33c7dddc65835b8a5ec3d5115d9598c0",
      "language": "csharp",
      "size": 595,
      "content": "// üìÑ Features/Tracking/Services/IMessageLogsReportService.cs\nusing xbytechat.api.Shared; // PaginatedResponse<T>\nusing xbytechat.api.Features.Tracking.DTOs;\n\nnamespace xbytechat.api.Features.Tracking.Services\n{\n    public interface IMessageLogsReportService\n    {\n\n        Task<PaginatedResponse<MessageLogListItemDto>> SearchAsync(\n            Guid businessId,\n            MessageLogReportQueryDto q,\n            CancellationToken ct);\n\n        Task<MessageLogFacetsDto> GetFacetsAsync(\n            Guid businessId,\n            DateTime? fromUtc,\n            CancellationToken ct);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/ITrackingService.cs",
      "sha256": "7331e4a2b1fb44932573c4ed055613cc4ae21dcd9ec54bc25210c57cd340737c",
      "language": "csharp",
      "size": 528,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.Features.Tracking.DTOs;\nusing xbytechat.api.Features.Tracking.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.Tracking.Services\n{\n    public interface ITrackingService\n    {\n        Task LogCTAClickAsync(TrackingLogDto dto);\n        Task<TrackingLogDetailsDto?> GetLogDetailsAsync(Guid logId);\n        Task<ResponseResult> LogCTAClickWithEnrichmentAsync(TrackingLogDto dto);\n        Task<List<TrackingLog>> GetFlowClickLogsAsync(Guid businessId);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/IUrlBuilderService.cs",
      "sha256": "2415363e2bcc41b916d5b2836a0c28ac68dabd407d67b63661da9feb8372bd56",
      "language": "csharp",
      "size": 273,
      "content": "namespace xbytechat.api.Features.Tracking.Services\n{\n    public interface IUrlBuilderService\n    {\n\n         string BuildTrackedButtonUrl(\n        Guid campaignSendLogId,\n        int buttonIndex,\n        string? buttonTitle,\n        string destinationUrlAbsolute);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Tracking/Services/JourneyExportService.cs",
      "sha256": "cbdf9d9b8b3d3a1945d8b888c1afea760a932c3d18d28e256cededa9f9853874",
      "language": "csharp",
      "size": 7155,
      "content": "using System;\nusing System.IO;\nusing System.Linq;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing ClosedXML.Excel;\nusing xbytechat.api.Features.Tracking.Services;\n\nnamespace xbytechat.api.Features.Tracking.Services\n{\n    public sealed class JourneyExportService : IJourneyExportService\n    {\n        private readonly IContactJourneyService _journeyService;\n\n        public JourneyExportService(IContactJourneyService journeyService)\n        {\n            _journeyService = journeyService;\n        }\n\n        // ---- formatting helpers ---------------------------------------------------------------\n\n        private static string FormatIso(DateTime dt)\n        {\n            // Normalize to UTC ISO-8601. If Kind is Unspecified, treat as UTC.\n            var utc = dt.Kind == DateTimeKind.Unspecified\n                ? DateTime.SpecifyKind(dt, DateTimeKind.Utc)\n                : dt.ToUniversalTime();\n            return utc.ToString(\"O\");\n        }\n\n        private static string FormatIsoOrEmpty(DateTime dt)\n            => dt == default ? \"\" : FormatIso(dt);\n\n        // CSV escape + guard against Excel formula injection\n        private static string CsvSafe(string? s)\n        {\n            if (string.IsNullOrEmpty(s)) return \"\";\n            s = s.Replace(\"\\\"\", \"\\\"\\\"\"); // escape quotes\n            // Guard against =, +, -, @ at start (Excel formula injection)\n            if (s.Length > 0 && (s[0] == '=' || s[0] == '+' || s[0] == '-' || s[0] == '@'))\n                s = \"'\" + s;\n            var needsQuotes = s.IndexOfAny(new[] { ',', '\"', '\\n', '\\r' }) >= 0;\n            return needsQuotes ? $\"\\\"{s}\\\"\" : s;\n        }\n\n        // Put a clickable link into a cell using the HYPERLINK() formula (works on all ClosedXML versions)\n        private static void SetHyperlinkFormula(IXLCell cell, string? url)\n        {\n            if (string.IsNullOrWhiteSpace(url))\n            {\n                cell.Value = \"\";\n                return;\n            }\n            var safe = url.Replace(\"\\\"\", \"\\\"\\\"\");\n            cell.SetFormulaA1($\"HYPERLINK(\\\"{safe}\\\",\\\"{safe}\\\")\");\n        }\n\n        // ---- CSV ------------------------------------------------------------------------------\n\n        public async Task<ExportResult> ExportJourneyCsvAsync(\n            Guid campaignSendLogId,\n            CancellationToken ct = default)\n        {\n            var dto = await _journeyService.GetJourneyEventsAsync(campaignSendLogId, ct);\n\n            var sb = new StringBuilder(8 * 1024);\n            sb.AppendLine(\"Timestamp,Source,EventType,Title,Details,Url,StepName,ButtonIndex,ButtonTitle,TemplateName,CampaignType,FlowName,FlowId,CampaignId,ContactId,ContactPhone\");\n\n            // ContactId may be non-nullable Guid in your DTO; emit empty when Guid.Empty\n            string contactIdCsv = dto.ContactId == Guid.Empty ? \"\" : dto.ContactId.ToString();\n\n            foreach (var e in dto.Events.OrderBy(x => x.Timestamp))\n            {\n                var line = string.Join(\",\",\n                    CsvSafe(FormatIsoOrEmpty(e.Timestamp)),\n                    CsvSafe(e.Source),\n                    CsvSafe(e.EventType),\n                    CsvSafe(e.Title),\n                    CsvSafe(e.Details),\n                    CsvSafe(e.Url),\n                    CsvSafe(e.StepName),\n                    e.ButtonIndex.HasValue ? e.ButtonIndex.Value.ToString() : \"\",\n                    CsvSafe(e.ButtonTitle),\n                    CsvSafe(e.TemplateName),\n                    CsvSafe(dto.CampaignType),\n                    CsvSafe(dto.FlowName),\n                    dto.FlowId?.ToString() ?? \"\",\n                    dto.CampaignId.ToString(),\n                    contactIdCsv,\n                    CsvSafe(dto.ContactPhone)\n                );\n                sb.AppendLine(line);\n            }\n\n            return new ExportResult\n            {\n                Bytes = Encoding.UTF8.GetBytes(sb.ToString()),\n                ContentType = \"text/csv; charset=utf-8\",\n                FileName = $\"journey-{campaignSendLogId}.csv\"\n            };\n        }\n\n        // ---- XLSX -----------------------------------------------------------------------------\n\n        public async Task<ExportResult> ExportJourneyXlsxAsync(\n            Guid campaignSendLogId,\n            CancellationToken ct = default)\n        {\n            var dto = await _journeyService.GetJourneyEventsAsync(campaignSendLogId, ct);\n\n            using var wb = new XLWorkbook();\n            var ws = wb.Worksheets.Add(\"Journey\");\n\n            var headers = new[]\n            {\n                \"Timestamp\",\"Source\",\"EventType\",\"Title\",\"Details\",\"Url\",\"StepName\",\n                \"ButtonIndex\",\"ButtonTitle\",\"TemplateName\",\"CampaignType\",\"FlowName\",\n                \"FlowId\",\"CampaignId\",\"ContactId\",\"ContactPhone\"\n            };\n\n            // Header row\n            for (int i = 0; i < headers.Length; i++)\n                ws.Cell(1, i + 1).Value = headers[i];\n\n            var headerRange = ws.Range(1, 1, 1, headers.Length);\n            headerRange.Style.Font.Bold = true;\n            headerRange.Style.Fill.BackgroundColor = XLColor.FromHtml(\"#F3F4F6\");\n\n            // Freeze header + auto filter\n            ws.SheetView.FreezeRows(1);\n            ws.Range(1, 1, 1, headers.Length).SetAutoFilter(); // avoid RangeUsed() on empty sheets\n\n            // Data rows\n            int r = 1;\n            foreach (var e in dto.Events.OrderBy(x => x.Timestamp))\n            {\n                r++;\n                int c = 1;\n\n                ws.Cell(r, c++).Value = FormatIsoOrEmpty(e.Timestamp);\n                ws.Cell(r, c++).Value = e.Source ?? \"\";\n                ws.Cell(r, c++).Value = e.EventType ?? \"\";\n                ws.Cell(r, c++).Value = e.Title ?? \"\";\n                ws.Cell(r, c++).Value = e.Details ?? \"\";\n\n                // URL\n                SetHyperlinkFormula(ws.Cell(r, c), e.Url);\n                c++;\n\n                ws.Cell(r, c++).Value = e.StepName ?? \"\";\n                ws.Cell(r, c++).Value = e.ButtonIndex?.ToString() ?? \"\";\n                ws.Cell(r, c++).Value = e.ButtonTitle ?? \"\";\n                ws.Cell(r, c++).Value = e.TemplateName ?? \"\";\n                ws.Cell(r, c++).Value = dto.CampaignType ?? \"\";\n                ws.Cell(r, c++).Value = dto.FlowName ?? \"\";\n                ws.Cell(r, c++).Value = dto.FlowId?.ToString() ?? \"\";\n                ws.Cell(r, c++).Value = dto.CampaignId.ToString();\n                ws.Cell(r, c++).Value = (dto.ContactId == Guid.Empty ? \"\" : dto.ContactId.ToString());\n                ws.Cell(r, c++).Value = dto.ContactPhone ?? \"\";\n            }\n\n            // Column sizing\n            ws.Columns().AdjustToContents();\n            ws.Column(1).Width = Math.Max(ws.Column(1).Width, 28); // timestamp column\n\n            using var ms = new MemoryStream();\n            wb.SaveAs(ms);\n            var bytes = ms.ToArray();\n\n            return new ExportResult\n            {\n                Bytes = bytes,\n                ContentType = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n                FileName = $\"journey-{campaignSendLogId}.xlsx\"\n            };\n        }\n    }\n}\n"
    }
  ]
}
