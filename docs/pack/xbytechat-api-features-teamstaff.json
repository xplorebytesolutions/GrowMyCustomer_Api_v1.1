{
  "name": "xbytechat-api/Features/TeamStaff",
  "generatedAt": "2026-02-11 19:15:17 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/TeamStaff/Controllers/TeamStaffController.cs",
      "sha256": "82b0a88218a8dd1335798aa98d26d68be43883df3c8cfc28aa1f4745c3d32ee7",
      "language": "csharp",
      "size": 4700,
      "content": "using System;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TeamStaff.DTOs;\nusing xbytechat.api.Features.TeamStaff.Services;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.TeamStaff.Controllers\n{\n    \n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    //[Authorize(Policy = Policies.AdminOrOwner)]\n    public sealed class TeamStaffController : ControllerBase\n    {\n        private readonly ITeamStaffService _service;\n\n        public TeamStaffController(ITeamStaffService service)\n        {\n            _service = service;\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetStaff()\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var rows = await _service.GetStaffAsync(businessId.Value);\n            return Ok(ResponseResult.SuccessInfo(\"‚úÖ Staff list fetched.\", rows));\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> CreateStaff([FromBody] CreateStaffUserDto dto)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.CreateStaffAsync(businessId.Value, actorUserId.Value, dto);\n            return Ok(result);\n        }\n\n        [HttpPut(\"{id:guid}\")]\n        public async Task<IActionResult> UpdateStaff([FromRoute] Guid id, [FromBody] UpdateStaffUserDto dto)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.UpdateStaffAsync(businessId.Value, actorUserId.Value, id, dto);\n            return Ok(result);\n        }\n\n        [HttpPost(\"{id:guid}/activate\")]\n        public async Task<IActionResult> Activate([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.SetStatusAsync(businessId.Value, actorUserId.Value, id, \"Active\");\n            return Ok(result);\n        }\n\n        [HttpPost(\"{id:guid}/deactivate\")]\n        public async Task<IActionResult> Deactivate([FromRoute] Guid id)\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var actorUserId = GetUserId();\n            if (!actorUserId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå UserId missing in token.\"));\n\n            var result = await _service.SetStatusAsync(businessId.Value, actorUserId.Value, id, \"Hold\");\n            return Ok(result);\n        }\n\n        // ---- helpers ----\n\n        private Guid? GetBusinessId()\n        {\n            // You store both \"BusinessId\" and \"businessId\" in JWT.\n            var raw = User.FindFirstValue(\"BusinessId\") ?? User.FindFirstValue(\"businessId\");\n            if (Guid.TryParse(raw, out var id)) return id;\n            return null;\n        }\n\n        private Guid? GetUserId()\n        {\n            var raw = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? User.FindFirstValue(\"id\");\n            if (Guid.TryParse(raw, out var id)) return id;\n            return null;\n        }\n        [HttpGet(\"roles\")]\n        public async Task<IActionResult> GetAssignableRoles()\n        {\n            var businessId = GetBusinessId();\n            if (!businessId.HasValue)\n                return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå BusinessId missing in token.\"));\n\n            var rows = await _service.GetAssignableRolesAsync(businessId.Value);\n            return Ok(ResponseResult.SuccessInfo(\"‚úÖ Roles fetched.\", rows));\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/AssignableRoleDto.cs",
      "sha256": "e83c65aae9de7a12d45b7cb6a32fa24164a31849fe654cd2ddc84ea0796a5bf6",
      "language": "csharp",
      "size": 305,
      "content": "using System;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Minimal role payload for dropdowns (TeamStaff).\n    /// </summary>\n    public sealed class AssignableRoleDto\n    {\n        public Guid Id { get; set; }\n        public string Name { get; set; } = \"unknown\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/CreateStaffUserDto.cs",
      "sha256": "dd29d80a5bcba26dd3115e9141dde09804f5d9ecb68d95a92909c0e5db0c35bb",
      "language": "csharp",
      "size": 941,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Create a staff user under the current Business.\n    /// </summary>\n    public sealed class CreateStaffUserDto\n    {\n        [Required]\n        [MinLength(2)]\n        public string Name { get; set; } = string.Empty;\n\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; } = string.Empty;\n\n        /// <summary>\n        /// Raw password (MVP). We will hash it using the same SHA256 strategy as AuthService.\n        /// Future enhancement: switch to BCrypt/Identity.\n        /// </summary>\n        [Required]\n        [MinLength(6)]\n        public string Password { get; set; } = string.Empty;\n\n        /// <summary>\n        /// RoleId for the staff user (e.g., agent/staff/manager role).\n        /// </summary>\n        [Required]\n        public Guid RoleId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/StaffUserDto.cs",
      "sha256": "0b71f0d1eeade902964f6d6820063b1d349d48a7fdfa79faf68b28995ff5d80f",
      "language": "csharp",
      "size": 627,
      "content": "using System;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Staff user list item for UI.\n    /// </summary>\n    public sealed class StaffUserDto\n    {\n        public Guid Id { get; set; }\n        public Guid? BusinessId { get; set; }\n\n        public string Name { get; set; } = string.Empty;\n        public string Email { get; set; } = string.Empty;\n\n        public Guid? RoleId { get; set; }\n        public string RoleName { get; set; } = \"unknown\";\n\n        public string Status { get; set; } = \"Pending\"; // Active/Hold/Rejected/Pending\n        public DateTime CreatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/DTOs/UpdateStaffUserDto.cs",
      "sha256": "00f1dc5e620c16d55d5cb3b57e4ef0625462cda323b71cd8a47db0c439d8e827",
      "language": "csharp",
      "size": 459,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.TeamStaff.DTOs\n{\n    /// <summary>\n    /// Update staff details (name + role). Status toggles are handled by dedicated endpoints.\n    /// </summary>\n    public sealed class UpdateStaffUserDto\n    {\n        [Required]\n        [MinLength(2)]\n        public string Name { get; set; } = string.Empty;\n\n        [Required]\n        public Guid RoleId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/Services/ITeamStaffService.cs",
      "sha256": "4574984d0c1ef8b4e03b07aac1241385fb3be2a205fec8d400d4c1a901142c23",
      "language": "csharp",
      "size": 755,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.TeamStaff.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.TeamStaff.Services\n{\n    public interface ITeamStaffService\n    {\n        Task<List<StaffUserDto>> GetStaffAsync(Guid businessId);\n\n        Task<ResponseResult> CreateStaffAsync(Guid businessId, Guid actorUserId, CreateStaffUserDto dto);\n\n        Task<ResponseResult> UpdateStaffAsync(Guid businessId, Guid actorUserId, Guid staffUserId, UpdateStaffUserDto dto);\n\n        Task<ResponseResult> SetStatusAsync(Guid businessId, Guid actorUserId, Guid staffUserId, string newStatus);\n        Task<List<AssignableRoleDto>> GetAssignableRolesAsync(Guid businessId);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TeamStaff/Services/TeamStaffService.cs",
      "sha256": "579c36903a51301718057899a6dc71411af122ea62b80b06d8bfb70de38e3a83",
      "language": "csharp",
      "size": 8420,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.TeamStaff.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.TeamStaff.Services\n{\n    /// <summary>\n    /// Business-scoped staff management using the existing Users table.\n    /// Staff users = Users with BusinessId set + Role assigned.\n    /// </summary>\n    public sealed class TeamStaffService : ITeamStaffService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<TeamStaffService> _logger;\n\n        public TeamStaffService(AppDbContext db, ILogger<TeamStaffService> logger)\n        {\n            _db = db;\n            _logger = logger;\n        }\n\n        public async Task<List<StaffUserDto>> GetStaffAsync(Guid businessId)\n        {\n            var rows = await _db.Users\n                .AsNoTracking()\n                .Where(u => u.BusinessId == businessId && !u.IsDeleted)\n                .Include(u => u.Role)\n                .OrderByDescending(u => u.CreatedAt)\n                .Select(u => new StaffUserDto\n                {\n                    Id = u.Id,\n                    BusinessId = u.BusinessId,\n                    Name = u.Name,\n                    Email = u.Email,\n                    RoleId = u.RoleId,\n                    RoleName = (u.Role != null && u.Role.Name != null) ? u.Role.Name : \"unknown\",\n                    Status = u.Status ?? \"unknown\",\n                    CreatedAt = u.CreatedAt\n                })\n                .ToListAsync();\n\n            return rows;\n        }\n\n        public async Task<ResponseResult> CreateStaffAsync(Guid businessId, Guid actorUserId, CreateStaffUserDto dto)\n        {\n            // Basic duplicate protection (DB unique index is still recommended)\n            var email = (dto.Email ?? \"\").Trim().ToLowerInvariant();\n\n            var exists = await _db.Users\n                .AnyAsync(u => !u.IsDeleted && ((u.Email ?? \"\").ToLower() == email));\n\n            if (exists)\n                return ResponseResult.ErrorInfo(\"‚ùå A user with this email already exists.\");\n\n            // ‚úÖ Ensure role is assignable INSIDE THIS BUSINESS\n            var (ok, role, err) = await TryGetAssignableRoleAsync(businessId, dto.RoleId);\n            if (!ok)\n                return err!;\n\n            var user = new User\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                Name = dto.Name?.Trim() ?? \"\",\n                Email = email,\n                PasswordHash = HashPassword(dto.Password),\n                RoleId = role!.Id,\n                Status = \"Active\",          // ‚úÖ Staff should be immediately usable\n                CreatedAt = DateTime.UtcNow,\n                IsDeleted = false\n            };\n\n            _db.Users.Add(user);\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"‚úÖ Staff user created. StaffUserId={StaffUserId}, BusinessId={BusinessId}, ActorUserId={ActorUserId}\",\n                user.Id, businessId, actorUserId);\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Staff user created successfully.\", new { user.Id });\n        }\n\n        public async Task<ResponseResult> UpdateStaffAsync(Guid businessId, Guid actorUserId, Guid staffUserId, UpdateStaffUserDto dto)\n        {\n            var user = await _db.Users\n                .Include(u => u.Role)\n                .FirstOrDefaultAsync(u => u.Id == staffUserId && u.BusinessId == businessId && !u.IsDeleted);\n\n            if (user == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Staff user not found.\");\n\n            // Prevent editing yourself via staff screen (avoid self-lockout edge cases)\n            if (staffUserId == actorUserId)\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot edit your own account from TeamStaff.\");\n\n            // Prevent changing a business-owner account (role \"business\") via staff UI\n            var currentRoleName = (user.Role?.Name ?? \"\").Trim().ToLowerInvariant();\n            if (currentRoleName == \"business\")\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot modify the Business Owner from TeamStaff.\");\n\n            // ‚úÖ Ensure new role is assignable INSIDE THIS BUSINESS\n            var (ok, newRole, err) = await TryGetAssignableRoleAsync(businessId, dto.RoleId);\n            if (!ok)\n                return err!;\n\n            user.Name = dto.Name?.Trim() ?? user.Name;\n            user.RoleId = newRole!.Id;\n\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"‚úÖ Staff user updated. StaffUserId={StaffUserId}, BusinessId={BusinessId}, ActorUserId={ActorUserId}\",\n                staffUserId, businessId, actorUserId);\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Staff user updated successfully.\");\n        }\n\n        public async Task<ResponseResult> SetStatusAsync(Guid businessId, Guid actorUserId, Guid staffUserId, string newStatus)\n        {\n            var normalized = (newStatus ?? \"\").Trim();\n            if (normalized is not (\"Active\" or \"Hold\"))\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid status. Allowed: Active, Hold.\");\n\n            var user = await _db.Users\n                .Include(u => u.Role)\n                .FirstOrDefaultAsync(u => u.Id == staffUserId && u.BusinessId == businessId && !u.IsDeleted);\n\n            if (user == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Staff user not found.\");\n\n            if (staffUserId == actorUserId)\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot change your own status.\");\n\n            var roleName = (user.Role?.Name ?? \"\").Trim().ToLowerInvariant();\n            if (roleName == \"business\")\n                return ResponseResult.ErrorInfo(\"‚ùå You cannot deactivate the Business Owner.\");\n\n            user.Status = normalized;\n            await _db.SaveChangesAsync();\n\n            _logger.LogInformation(\"‚úÖ Staff status updated. StaffUserId={StaffUserId}, NewStatus={NewStatus}, BusinessId={BusinessId}, ActorUserId={ActorUserId}\",\n                staffUserId, normalized, businessId, actorUserId);\n\n            return ResponseResult.SuccessInfo($\"‚úÖ Staff user status updated to {normalized}.\");\n        }\n\n        public async Task<List<AssignableRoleDto>> GetAssignableRolesAsync(Guid businessId)\n        {\n            // only business-scoped roles for that business\n            var roles = await _db.Roles\n                .AsNoTracking()\n                .Where(r => r.IsActive && r.BusinessId == businessId)\n                .OrderBy(r => r.Name)\n                .Select(r => new AssignableRoleDto\n                {\n                    Id = r.Id,\n                    Name = r.Name\n                })\n                .ToListAsync();\n\n            return roles;\n        }\n\n        /// <summary>\n        /// ‚úÖ Central guard: role must belong to this business and be active.\n        /// Also blocks admin-type roles from being assigned via TeamStaff.\n        /// </summary>\n        private async Task<(bool Ok, Role? Role, ResponseResult? Error)> TryGetAssignableRoleAsync(Guid businessId, Guid roleId)\n        {\n            // ‚úÖ IMPORTANT: role must be scoped to the same business\n            var role = await _db.Roles\n                .AsNoTracking()\n                .FirstOrDefaultAsync(r => r.Id == roleId && r.IsActive && r.BusinessId == businessId);\n\n            if (role == null)\n                return (false, null, ResponseResult.ErrorInfo(\"‚ùå Invalid role selected.\"));\n\n            var roleName = (role.Name ?? \"\").Trim().ToLowerInvariant();\n            if (roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\")\n                return (false, null, ResponseResult.ErrorInfo(\"‚ùå You cannot assign an admin-type role from TeamStaff.\"));\n\n            return (true, role, null);\n        }\n\n        // üîí MVP hashing (same as AuthService)\n        private static string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password ?? \"\");\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n    }\n}\n"
    }
  ]
}
