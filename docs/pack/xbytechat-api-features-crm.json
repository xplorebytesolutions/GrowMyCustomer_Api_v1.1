{
  "name": "xbytechat-api/Features/CRM",
  "generatedAt": "2026-02-11 19:15:17 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/CRM/Controllers/ContactsController.cs",
      "sha256": "51c470a6310eea101c785831c7904967a477ba77ddaa65392188e685d9eeda86",
      "language": "csharp",
      "size": 17051,
      "content": "// üìÑ File: xbytechat-api/Features/CRM/Controllers/ContactsController.cs\n\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Hosting;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\n\nnamespace xbytechat.api.Features.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize] // CRM should be authenticated\n    public class ContactsController : ControllerBase\n    {\n        private readonly IContactService _contactService;\n        private readonly IContactTagService _contactTagService;\n        private readonly AppDbContext _db;\n        private readonly IHostEnvironment _env;\n        private readonly ILogger<ContactsController> _logger;\n\n        public ContactsController(\n            IContactService contactService,\n            IContactTagService contactTagService,\n            AppDbContext db,\n            IHostEnvironment env,\n            ILogger<ContactsController> logger)\n        {\n            _contactService = contactService;\n            _contactTagService = contactTagService;\n            _db = db;\n            _env = env;\n            _logger = logger;\n        }\n\n        // POST: api/contacts/create\n        [HttpPost(\"create\")]\n        public async Task<IActionResult> AddContact([FromBody] ContactDto dto)\n        {\n            if (!ModelState.IsValid)\n                return BadRequest(ResponseResult.ErrorInfo(\"‚ùå Invalid contact payload.\"));\n\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var result = await _contactService.AddContactAsync(businessId, dto);\n\n                return result.Success\n                    ? Ok(result)\n                    : BadRequest(result);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"üö® Unexpected error in AddContact\");\n                return StatusCode(500, ResponseResult.ErrorInfo(\"üö® Server error while creating contact.\", ex.ToString()));\n            }\n        }\n\n        // GET: api/contacts/{id}\n        [HttpGet(\"{id:guid}\")]\n        public async Task<IActionResult> GetContactById(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var contact = await _contactService.GetContactByIdAsync(businessId, id);\n\n            if (contact == null)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n\n            return Ok(ResponseResult.SuccessInfo(\"Contact loaded.\", contact));\n        }\n\n        // PUT: api/contacts/{id}\n        [HttpPut(\"{id:guid}\")]\n        public async Task<IActionResult> UpdateContact(Guid id, [FromBody] ContactDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            dto.Id = id;\n\n            var success = await _contactService.UpdateContactAsync(businessId, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n\n            return Ok(ResponseResult.SuccessInfo(\"Contact updated.\"));\n        }\n\n        // DELETE: api/contacts/{id}\n        [HttpDelete(\"{id:guid}\")]\n        public async Task<IActionResult> DeleteContact(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var success = await _contactService.DeleteContactAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n\n            return Ok(ResponseResult.SuccessInfo(\"Contact deleted.\"));\n        }\n\n        // POST: api/contacts/parse-csv  (hidden from swagger as you did)\n        [ApiExplorerSettings(IgnoreApi = true)]\n        [HttpPost(\"parse-csv\")]\n        [Consumes(\"multipart/form-data\")]\n        public async Task<IActionResult> ParseCsvToContactsAsync([FromForm] IFormFile file)\n        {\n            if (file == null || file.Length == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV file is required.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n\n            try\n            {\n                using var stream = file.OpenReadStream();\n                var parseResult = await _contactService.ParseCsvToContactsAsync(businessId, stream);\n                return Ok(ResponseResult.SuccessInfo(\"CSV parsed with detailed results.\", parseResult));\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"CSV parsing failed.\");\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV parsing failed: \" + ex.Message));\n            }\n        }\n\n        // PATCH: /api/contacts/{id}/favorite\n        [HttpPatch(\"{id:guid}/favorite\")]\n        public async Task<IActionResult> ToggleFavorite(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var success = await _contactService.ToggleFavoriteAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n\n            return Ok(ResponseResult.SuccessInfo(\"Favorite toggled.\"));\n        }\n\n        // PATCH: /api/contacts/{id}/archive\n        [HttpPatch(\"{id:guid}/archive\")]\n        public async Task<IActionResult> ToggleArchive(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var success = await _contactService.ToggleArchiveAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found.\"));\n\n            return Ok(ResponseResult.SuccessInfo(\"Archive toggled.\"));\n        }\n\n        // POST: api/contacts/bulk-assign-tag\n        [HttpPost(\"bulk-assign-tag\")]\n        public async Task<IActionResult> AssignTagToContacts([FromBody] AssignTagToContactsDto dto)\n        {\n            if (dto.ContactIds == null || !dto.ContactIds.Any())\n                return BadRequest(ResponseResult.ErrorInfo(\"No contact IDs provided.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n\n            await _contactService.AssignTagToContactsAsync(businessId, dto.ContactIds, dto.TagId);\n            return Ok(ResponseResult.SuccessInfo(\"Tag assigned to selected contacts.\"));\n        }\n\n        // DELETE: api/contacts/{contactId}/tags/{tagId}\n        // Used by Inbox ‚Äúremove tag‚Äù on one contact.\n        [HttpDelete(\"{contactId:guid}/tags/{tagId:guid}\")]\n        public async Task<IActionResult> RemoveTagFromContact(Guid contactId, Guid tagId)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var removed = await _contactTagService.RemoveTagFromContactAsync(businessId, contactId, tagId);\n            if (!removed)\n                return NotFound(ResponseResult.ErrorInfo(\"Tag link not found for this contact.\"));\n\n            return Ok(ResponseResult.SuccessInfo(\"Tag removed from contact.\"));\n        }\n\n        // POST: api/contacts/bulk-unassign-tag\n        // Avoid axios DELETE-body edge cases\n        [HttpPost(\"bulk-unassign-tag\")]\n        public async Task<IActionResult> BulkUnassignTag([FromBody] AssignTagToContactsDto dto)\n        {\n            if (dto.ContactIds == null || !dto.ContactIds.Any())\n                return BadRequest(ResponseResult.ErrorInfo(\"No contact IDs provided.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var removedCount = 0;\n            foreach (var contactId in dto.ContactIds)\n            {\n                var removed = await _contactTagService.RemoveTagFromContactAsync(businessId, contactId, dto.TagId);\n                if (removed) removedCount++;\n            }\n\n            return Ok(ResponseResult.SuccessInfo($\"Tag unassigned from {removedCount} contact(s).\", new { removedCount }));\n        }\n\n        // OPTIONAL: keep DELETE too (prevents 405 surprises)\n        [HttpDelete(\"bulk-unassign-tag\")]\n        public Task<IActionResult> BulkUnassignTagDelete([FromBody] AssignTagToContactsDto dto)\n            => BulkUnassignTag(dto);\n\n        // GET: api/contacts?tab=all&search=...&page=1&pageSize=25\n        [HttpGet]\n        public async Task<IActionResult> GetAllContacts(\n            [FromQuery] string? tab = \"all\",\n            [FromQuery] string? search = null,\n            [FromQuery] int page = 1,\n            [FromQuery] int pageSize = 25)\n        {\n            if (page < 1) page = 1;\n            if (pageSize < 1) pageSize = 25;\n            if (pageSize > 200) pageSize = 200; // safety cap\n\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var pagedResult = await _contactService.GetPagedContactsAsync(businessId, tab, page, pageSize, search);\n            return Ok(ResponseResult.SuccessInfo(\"Contacts loaded.\", pagedResult));\n        }\n\n        // GET: api/contacts/all  (flat list, used in dropdowns)\n        [HttpGet(\"all\")]\n        public async Task<IActionResult> GetAllContactsFlat()\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var allContacts = await _contactService.GetAllContactsAsync(businessId);\n\n            // Keep wrapper consistent (helps frontend)\n            return Ok(ResponseResult.SuccessInfo(\"Contacts loaded.\", allContacts));\n        }\n\n        // POST: api/contacts/filter-by-tags  (body = list of tagIds as strings)\n        [HttpPost(\"filter-by-tags\")]\n        public async Task<IActionResult> FilterContactsByTags([FromBody] List<string> tags)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n\n            var tagGuids = (tags ?? new List<string>())\n                .Where(x => Guid.TryParse(x, out _))\n                .Select(Guid.Parse)\n                .ToList();\n\n            var contacts = await _contactService.GetContactsByTagsAsync(businessId, tagGuids);\n\n            return Ok(ResponseResult.SuccessInfo(\"Contacts filtered successfully.\", contacts));\n        }\n\n        // POST: api/contacts/bulk-import\n        [HttpPost(\"bulk-import\")]\n        [Consumes(\"multipart/form-data\")]\n        public async Task<IActionResult> BulkImportContactsAsync( IFormFile file)\n        {\n            if (file == null || file.Length == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"CSV file is required.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n\n            try\n            {\n                using var stream = file.OpenReadStream();\n                var result = await _contactService.BulkImportAsync(businessId, stream);\n                return Ok(ResponseResult.SuccessInfo(\"Contacts imported successfully.\", result));\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Bulk import failed.\");\n                return BadRequest(ResponseResult.ErrorInfo(\"Import failed: \" + ex.Message));\n            }\n        }\n\n        // GET: api/contacts/by-tags?tagIds=...&tagIds=...\n        [HttpGet(\"by-tags\")]\n        public async Task<IActionResult> GetContactsByTagIds([FromQuery] List<Guid> tagIds)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var contacts = await _contactService.GetContactsByTagsAsync(businessId, tagIds);\n\n            return Ok(ResponseResult.SuccessInfo(\"Contacts filtered successfully.\", contacts));\n        }\n\n        // GET: api/contacts/debug/opt-status?phone=9198...\n        [ApiExplorerSettings(IgnoreApi = true)]\n        [HttpGet(\"debug/opt-status\")]\n        public async Task<IActionResult> GetOptStatusDebug([FromQuery] string phone)\n        {\n            if (string.IsNullOrWhiteSpace(phone))\n                return BadRequest(ResponseResult.ErrorInfo(\"Phone is required.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n            var candidates = BuildPhoneLookupCandidates(phone);\n            if (candidates.Count == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"Phone format is invalid.\"));\n\n            var contact = await _db.Contacts\n                .AsNoTracking()\n                .Where(c => c.BusinessId == businessId && candidates.Contains(c.PhoneNumber))\n                .OrderByDescending(c => c.OptStatus == ContactOptStatus.OptedOut)\n                .ThenByDescending(c => c.OptStatusUpdatedAt)\n                .FirstOrDefaultAsync();\n\n            if (contact == null)\n            {\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found for provided phone.\"));\n            }\n\n            return Ok(ResponseResult.SuccessInfo(\"Opt status resolved.\", new\n            {\n                contactId = contact.Id,\n                phoneNumber = contact.PhoneNumber,\n                optStatus = contact.OptStatus.ToString(),\n                channelStatus = contact.ChannelStatus.ToString(),\n                optOutReason = contact.OptOutReason,\n                optStatusUpdatedAt = contact.OptStatusUpdatedAt,\n                channelStatusUpdatedAt = contact.ChannelStatusUpdatedAt\n            }));\n        }\n\n        // POST: api/contacts/debug/force-opt-in?phone=9198...&resetChannel=true\n        [ApiExplorerSettings(IgnoreApi = true)]\n        [HttpPost(\"debug/force-opt-in\")]\n        public async Task<IActionResult> ForceOptInDebug([FromQuery] string phone, [FromQuery] bool resetChannel = false)\n        {\n            if (_env.IsProduction())\n                return StatusCode(403, ResponseResult.ErrorInfo(\"Debug endpoint is disabled in production.\"));\n\n            if (string.IsNullOrWhiteSpace(phone))\n                return BadRequest(ResponseResult.ErrorInfo(\"Phone is required.\"));\n\n            var businessId = HttpContext.User.GetBusinessId();\n            var candidates = BuildPhoneLookupCandidates(phone);\n            if (candidates.Count == 0)\n                return BadRequest(ResponseResult.ErrorInfo(\"Phone format is invalid.\"));\n\n            var contact = await _db.Contacts\n                .Where(c => c.BusinessId == businessId && candidates.Contains(c.PhoneNumber))\n                .OrderByDescending(c => c.OptStatus == ContactOptStatus.OptedOut)\n                .ThenByDescending(c => c.OptStatusUpdatedAt)\n                .FirstOrDefaultAsync();\n\n            if (contact == null)\n                return NotFound(ResponseResult.ErrorInfo(\"Contact not found for provided phone.\"));\n\n            var nowUtc = DateTime.UtcNow;\n            contact.OptStatus = ContactOptStatus.OptedIn;\n            contact.OptStatusUpdatedAt = nowUtc;\n            contact.OptOutReason = null;\n\n            if (resetChannel)\n            {\n                contact.ChannelStatus = ContactChannelStatus.Valid;\n                contact.ChannelStatusUpdatedAt = nowUtc;\n            }\n\n            await _db.SaveChangesAsync();\n\n            _logger.LogWarning(\n                \"Debug force-opt-in applied. businessId={BusinessId} contactId={ContactId} phone={Phone} resetChannel={ResetChannel}\",\n                businessId,\n                contact.Id,\n                contact.PhoneNumber,\n                resetChannel);\n\n            return Ok(ResponseResult.SuccessInfo(\"Contact force opt-in applied.\", new\n            {\n                contactId = contact.Id,\n                phoneNumber = contact.PhoneNumber,\n                optStatus = contact.OptStatus.ToString(),\n                channelStatus = contact.ChannelStatus.ToString(),\n                optOutReason = contact.OptOutReason,\n                optStatusUpdatedAt = contact.OptStatusUpdatedAt,\n                channelStatusUpdatedAt = contact.ChannelStatusUpdatedAt,\n                resetChannel\n            }));\n        }\n\n        private static List<string> BuildPhoneLookupCandidates(string? raw)\n        {\n            var value = (raw ?? string.Empty).Trim();\n            var list = new HashSet<string>(StringComparer.Ordinal);\n\n            var normalized = PhoneNumberNormalizer.NormalizeToE164Digits(value, \"IN\");\n            var digits = new string(value.Where(char.IsDigit).ToArray());\n\n            if (!string.IsNullOrWhiteSpace(normalized))\n            {\n                list.Add(normalized);\n                list.Add(\"+\" + normalized);\n\n                if (normalized.Length == 12 && normalized.StartsWith(\"91\", StringComparison.Ordinal))\n                    list.Add(normalized.Substring(2));\n            }\n\n            if (!string.IsNullOrWhiteSpace(digits))\n            {\n                list.Add(digits);\n                list.Add(\"+\" + digits);\n\n                if (digits.Length == 10)\n                {\n                    list.Add(\"91\" + digits);\n                    list.Add(\"+91\" + digits);\n                }\n                else if (digits.Length == 12 && digits.StartsWith(\"91\", StringComparison.Ordinal))\n                {\n                    list.Add(digits.Substring(2));\n                }\n            }\n\n            if (!string.IsNullOrWhiteSpace(value))\n                list.Add(value);\n\n            return list.Where(x => !string.IsNullOrWhiteSpace(x)).ToList();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Controllers/CrmSummaryController.cs",
      "sha256": "49a9a81d7aeacd60428584f63e0e2315622b2a2a91ea8cff69145a7c452a67e0",
      "language": "csharp",
      "size": 2829,
      "content": "// üìÑ xbytechat-api/Features/CRM/Summary/Controllers/CrmSummaryController.cs\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CRM.Services;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CRM.Controllers\n{\n    /// <summary>\n    /// Thin API surface for CRM summary endpoints used by Chat Inbox\n    /// and future dashboards.\n    /// </summary>\n    [ApiController]\n    [Route(\"api/crm-summary\")]\n    public sealed class CrmSummaryController : ControllerBase\n    {\n        private readonly IContactSummaryService _contactSummaryService;\n        private readonly ILogger<CrmSummaryController> _logger;\n\n        public CrmSummaryController(\n            IContactSummaryService contactSummaryService,\n            ILogger<CrmSummaryController> logger)\n        {\n            _contactSummaryService = contactSummaryService ?? throw new ArgumentNullException(nameof(contactSummaryService));\n            _logger = logger ?? throw new ArgumentNullException(nameof(logger));\n        }\n\n        /// <summary>\n        /// Returns a compact CRM snapshot for a given contact:\n        /// Contact core fields, tags, recent notes, next reminder, recent timeline entries.\n        /// </summary>\n        [HttpGet(\"contact-summary/{contactId:guid}\")]              // ‚úÖ new route: /api/crm-summary/contact-summary/{id}\n        [HttpGet(\"/api/crm/contact-summary/{contactId:guid}\")]     // ‚úÖ backward-compatible route: /api/crm/contact-summary/{id}\n        public async Task<IActionResult> GetContactSummary(Guid contactId, CancellationToken ct)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            if (businessId == Guid.Empty)\n            {\n                return Unauthorized(ResponseResult.ErrorInfo(\"Missing BusinessId in user claims.\"));\n            }\n\n            try\n            {\n                var summary = await _contactSummaryService.GetContactSummaryAsync(businessId, contactId, ct);\n                if (summary == null)\n                {\n                    return NotFound(ResponseResult.ErrorInfo(\"Contact not found for this business.\"));\n                }\n\n                return Ok(ResponseResult.SuccessInfo(\"Contact summary loaded.\", summary));\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\n                    ex,\n                    \"‚ùå Failed to load contact summary. Business={BusinessId}, Contact={ContactId}\",\n                    businessId,\n                    contactId);\n\n                return StatusCode(\n                    500,\n                    ResponseResult.ErrorInfo(\"An error occurred while loading contact summary.\", ex.Message));\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Controllers/NotesController.cs",
      "sha256": "cb225e42566f276e2b69c4112c1a6afb8ea4bb176fabbb5e7a628df83604a799",
      "language": "csharp",
      "size": 3574,
      "content": "// üìÑ xbytechat-api/Features/CRM/Controllers/NotesController.cs\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class NotesController : ControllerBase\n    {\n        private readonly INoteService _noteService;\n\n        public NotesController(INoteService noteService)\n        {\n            _noteService = noteService;\n        }\n\n        // ‚úÖ Clean, REST-y POST: /api/notes\n        [HttpPost]\n        public async Task<IActionResult> AddNote([FromBody] NoteDto dto)\n        {\n            try\n            {\n                if (dto == null)\n                {\n                    return BadRequest(ResponseResult.ErrorInfo(\"Note payload is missing.\"));\n                }\n\n                var businessId = HttpContext.User.GetBusinessId();\n                var result = await _noteService.AddNoteAsync(businessId, dto);\n                return Ok(ResponseResult.SuccessInfo(\"Note created.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(\n                    500,\n                    ResponseResult.ErrorInfo(\"Error creating note\", ex.Message)\n                );\n            }\n        }\n\n        // GET /api/notes/contact/{contactId}\n        [HttpGet(\"contact/{contactId}\")]\n        public async Task<IActionResult> GetNotesByContact(Guid contactId)\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var result = await _noteService.GetNotesByContactAsync(businessId, contactId);\n                return Ok(ResponseResult.SuccessInfo(\"Notes loaded.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(\n                    500,\n                    ResponseResult.ErrorInfo(\"Error fetching notes\", ex.Message)\n                );\n            }\n        }\n\n        // GET /api/notes/{id}\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetNoteById(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var result = await _noteService.GetNoteByIdAsync(businessId, id);\n\n            if (result == null)\n            {\n                return NotFound(ResponseResult.ErrorInfo(\"Note not found.\"));\n            }\n\n            return Ok(ResponseResult.SuccessInfo(\"Note loaded.\", result));\n        }\n\n        // PUT /api/notes/{id}\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateNote(Guid id, [FromBody] NoteDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _noteService.UpdateNoteAsync(businessId, id, dto);\n\n            if (!success)\n            {\n                return NotFound(ResponseResult.ErrorInfo(\"Note not found.\"));\n            }\n\n            return Ok(ResponseResult.SuccessInfo(\"Note updated.\"));\n        }\n\n        // DELETE /api/notes/{id}\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteNote(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _noteService.DeleteNoteAsync(businessId, id);\n\n            if (!success)\n            {\n                return NotFound(ResponseResult.ErrorInfo(\"Note not found.\"));\n            }\n\n            return Ok(ResponseResult.SuccessInfo(\"Note deleted.\"));\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Controllers/RemindersController.cs",
      "sha256": "94768043e5877270f9ca797c084d60b10d081df7b7973bed29466c4b07018405",
      "language": "csharp",
      "size": 3241,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class RemindersController : ControllerBase\n    {\n        private readonly IReminderService _reminderService;\n\n        public RemindersController(IReminderService reminderService)\n        {\n            _reminderService = reminderService;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddReminder(ReminderDto dto)\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                if (dto == null)\n                    return BadRequest(ResponseResult.ErrorInfo(\"Reminder data is missing.\"));\n\n                var result = await _reminderService.AddReminderAsync(businessId, dto);\n                return Ok(ResponseResult.SuccessInfo(\"Reminder created.\", result));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"An error occurred while adding the reminder.\", ex.Message));\n            }\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAllReminders()\n        {\n            try\n            {\n                var businessId = HttpContext.User.GetBusinessId();\n                var reminders = await _reminderService.GetAllRemindersAsync(businessId);\n                return Ok(ResponseResult.SuccessInfo(\"Reminders loaded.\", reminders));\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"An error occurred while fetching reminders.\", ex.Message));\n            }\n        }\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetReminderById(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var reminder = await _reminderService.GetReminderByIdAsync(businessId, id);\n            if (reminder == null)\n                return NotFound(ResponseResult.ErrorInfo(\"Reminder not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Reminder loaded.\", reminder));\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateReminder(Guid id, [FromBody] ReminderDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _reminderService.UpdateReminderAsync(businessId, id, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Reminder not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Reminder updated.\"));\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteReminder(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _reminderService.DeleteReminderAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Reminder not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Reminder deleted.\"));\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Controllers/TagsController.cs",
      "sha256": "63ac6f2a529c4a2363dc42af6e6a6c17792b7aaf572935395352ebd5a8069124",
      "language": "csharp",
      "size": 2397,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CRM.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class TagsController : ControllerBase\n    {\n        private readonly ITagService _tagService;\n\n        public TagsController(ITagService tagService)\n        {\n            _tagService = tagService;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddTag([FromBody] TagDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var result = await _tagService.AddTagAsync(businessId, dto);\n            return Ok(ResponseResult.SuccessInfo(\"Tag created.\", result));\n        }\n\n        [HttpPut(\"{id}\")]\n        public async Task<IActionResult> UpdateTag(Guid id, [FromBody] TagDto dto)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _tagService.UpdateTagAsync(businessId, id, dto);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Tag not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Tag updated.\"));\n        }\n\n        ////[HttpGet(\"get-tags\")]\n        [HttpGet(\"get-tags\")]\n        public async Task<IActionResult> GetAllTagsLegacy()\n        {\n            // Backward compatible alias for older clients\n            var businessId = HttpContext.User.GetBusinessId();\n            var tags = await _tagService.GetAllTagsAsync(businessId);\n            return Ok(ResponseResult.SuccessInfo(\"Tags loaded.\", tags));\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAllTags()\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var tags = await _tagService.GetAllTagsAsync(businessId);\n            return Ok(ResponseResult.SuccessInfo(\"Tags loaded.\", tags));\n        }\n\n        [HttpDelete(\"{id}\")]\n        public async Task<IActionResult> DeleteTag(Guid id)\n        {\n            var businessId = HttpContext.User.GetBusinessId();\n            var success = await _tagService.DeleteTagAsync(businessId, id);\n            if (!success)\n                return NotFound(ResponseResult.ErrorInfo(\"Tag not found.\"));\n            return Ok(ResponseResult.SuccessInfo(\"Tag deleted.\"));\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/AssignTagToContactsDto.cs",
      "sha256": "905dc04f16dd3b6ee269a89e0ea202a6af3dea76b223c9013713e74bb418bb24",
      "language": "csharp",
      "size": 198,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class AssignTagToContactsDto\n    {\n        public List<Guid> ContactIds { get; set; } = new();\n        public Guid TagId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/BulkImportResultDto.cs",
      "sha256": "f552fe1e5d5f1e2a8275aae3baac3882b78b0cae422c4ac8d82db52d3c78bdba",
      "language": "csharp",
      "size": 1145,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class BulkImportResultDto\n    {\n        public int Imported { get; set; }          // brand-new rows inserted\n        public int Restored { get; set; }          // previously IsActive=false -> restored\n        public int SkippedExisting { get; set; }   // already active -> skipped\n        public int DuplicatesInFile { get; set; }  // same phone repeated in CSV -> ignored\n        public List<CsvImportError> Errors { get; set; } = new();\n    }\n\n    // Optional: remove this if unused (CsvImportError already exists elsewhere)\n    public class CsvImportErrorMsg\n    {\n        public int RowNumber { get; set; }\n        public string ErrorMessage { get; set; }\n    }\n}\n\n\n//namespace xbytechat.api.Features.CRM.Dtos\n//{\n//    public class BulkImportResultDto\n//    {\n//        public int Imported { get; set; }\n//        public int SkippedExisting { get; set; }\n//        public List<CsvImportError> Errors { get; set; } = new();\n//    }\n\n//    public class CsvImportErrorMsg\n//    {\n//        public int RowNumber { get; set; }\n//        public string ErrorMessage { get; set; }\n//    }\n//}"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/ContactDto.cs",
      "sha256": "83bef17a1c7bc4901f020261fb9a4d30c7bab7acab03e82fe3182e4eb4a24de3",
      "language": "csharp",
      "size": 1365,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CRM.Dtos\n{\n    public class ContactDto\n    {\n        public Guid? Id { get; set; } // Nullable for Create (used in PUT)\n\n        public string Name { get; set; } // Contact full name\n\n        public string PhoneNumber { get; set; } // WhatsApp-compatible number\n\n        public string? Email { get; set; } // Optional email address\n\n        public string? LeadSource { get; set; } // e.g., \"WhatsApp\", \"Facebook\", \"Landing Page\"\n\n        public DateTime? LastContactedAt { get; set; } // Last WhatsApp or CRM interaction\n\n        public DateTime? NextFollowUpAt { get; set; } // For scheduling reminders\n\n        public string? Notes { get; set; } // Internal notes for the contact\n\n        public DateTime? CreatedAt { get; set; } // Read-only timestamp\n\n        // ‚úÖ NEW: Structured Tags (replaces comma-separated strings)\n        // Example: [{ id: 1, name: \"VIP\" }, { id: 2, name: \"Follow-up\" }]\n        public List<ContactTagDto> Tags { get; set; } = new();\n\n        public bool IsFavorite { get; set; } = false;\n        public bool IsArchived { get; set; } = false;\n        public string? Group { get; set; }\n\n        public bool IsTemporary { get; set; } = false;\n        public Guid? SourceCampaignId { get; set; }\n        public DateTime? ExpiresAt { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/ContactDtoCsvMap.cs",
      "sha256": "1e2f57eea6d6f012d91f094a8f62c352fe93ae763566730af8c530fe0fb271b7",
      "language": "csharp",
      "size": 1744,
      "content": "using CsvHelper.Configuration;\n\nnamespace xbytechat.api.Features.CRM.Dtos\n{\n    /// <summary>\n    /// CSV mapping for ContactDto import.\n    /// Keeps header matching flexible (multiple header aliases).\n    /// Header normalization is applied in CsvConfiguration (not here).\n    /// </summary>\n    public sealed class ContactDtoCsvMap : ClassMap<ContactDto>\n    {\n        public ContactDtoCsvMap()\n        {\n            // Required core columns\n            Map(m => m.Name).Name(\"name\", \"fullname\", \"contactname\", \"customername\");\n            Map(m => m.PhoneNumber).Name(\"phone\", \"phonenumber\", \"mobile\", \"mobilenumber\", \"whatsapp\", \"whatsappnumber\");\n\n            // Optional columns\n            Map(m => m.Email).Name(\"email\", \"emailid\").Optional();\n            Map(m => m.Notes).Name(\"notes\", \"note\", \"remark\", \"remarks\", \"comment\", \"comments\").Optional();\n\n            // Optional but useful for CRM analytics\n            Map(m => m.LeadSource).Name(\"leadsource\", \"lead source\", \"source\", \"lead\", \"leadorigin\").Optional();\n\n            // We are intentionally NOT importing Tags yet because Tags is a List<string>.\n            // If you want later: we can add a converter for a comma-separated \"Tags\" column.\n        }\n    }\n}\n\n\n//using CsvHelper.Configuration;\n\n//namespace xbytechat.api.Features.CRM.Dtos\n//{\n//    public class ContactDtoCsvMap : ClassMap<ContactDto>\n//    {\n//        public ContactDtoCsvMap()\n//        {\n//            Map(m => m.Name).Name(\"name\", \"Name\", \"full name\");\n//            Map(m => m.PhoneNumber).Name(\"phone\", \"Phone\", \"mobile\", \"mobile number\");\n//            Map(m => m.Email).Name(\"email\", \"Email\").Optional();\n//            Map(m => m.Notes).Name(\"notes\", \"Notes\").Optional();\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/ContactSummaryResponseDto.cs",
      "sha256": "9e1ca2d18ba212e71090bdc4633e1e4cf955e8f8ba21663145f60c032f1031e1",
      "language": "csharp",
      "size": 1436,
      "content": "// üìÑ xbytechat-api/Features/CRM/Summary/Dtos/ContactSummaryResponseDto.cs\nusing System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\n\nnamespace xbytechat.api.Features.CRM.Dtos\n{\n    /// <summary>\n    /// Compact CRM snapshot for a contact:\n    /// - Core contact fields\n    /// - Tags\n    /// - Recent notes\n    /// - Next reminder\n    /// - Recent timeline events\n    /// </summary>\n    public sealed class ContactSummaryResponseDto\n    {\n        public Guid BusinessId { get; set; }\n        public Guid ContactId { get; set; }\n\n        // Core contact profile\n        public string Name { get; set; } = string.Empty;\n        public string PhoneNumber { get; set; } = string.Empty;\n        public string? Email { get; set; }\n        public string? LeadSource { get; set; }\n\n        public bool IsFavorite { get; set; }\n        public bool IsArchived { get; set; }\n        public string? Group { get; set; }\n\n        public DateTime? LastContactedAt { get; set; }\n        public DateTime? NextFollowUpAt { get; set; }\n\n        // Structured tags (from ContactDto.ContactTags ‚Üí ContactTagDto)\n        public List<ContactTagDto> Tags { get; set; } = new();\n\n        // Mini timeline section\n        public List<NoteDto> RecentNotes { get; set; } = new();\n\n        public ReminderDto? NextReminder { get; set; }\n\n        public List<LeadTimelineDto> RecentTimeline { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/ContactTagDto.cs",
      "sha256": "69e97156f1e9453485bbaa39803b7c132d5a991e27091eb6cb648b42a148fc7a",
      "language": "csharp",
      "size": 281,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class ContactTagDto\n    {\n        public Guid TagId { get; set; }\n        public string TagName { get; set; } = string.Empty;\n        public string? ColorHex { get; set; }\n        public string? Category { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/CrmContactSummaryDto.cs",
      "sha256": "320c7a1b0dd1223ea9e8a517b258e7235d2c12f71a798317c71483d95d2b0d26",
      "language": "csharp",
      "size": 2012,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CRM.DTOs\n{\n    public sealed class CrmContactSummaryDto\n    {\n        public Guid ContactId { get; set; }\n        public Guid BusinessId { get; set; }\n\n        public string Name { get; set; } = string.Empty;\n        public string PhoneNumber { get; set; } = string.Empty;\n        public string? Email { get; set; }\n        public string? LeadSource { get; set; }\n        public DateTime? CreatedAt { get; set; }\n\n        // üëá These names match ChatInbox.jsx usage\n        public List<CrmTagChipDto> Tags { get; set; } = new();\n        public List<CrmNoteSnippetDto> RecentNotes { get; set; } = new();\n        public CrmReminderSnippetDto? NextReminder { get; set; }\n        public List<CrmTimelineEventDto> RecentTimeline { get; set; } = new();\n    }\n\n    public sealed class CrmTagChipDto\n    {\n        public Guid Id { get; set; }\n        public string TagName { get; set; } = string.Empty;\n        public string? ColorHex { get; set; }\n    }\n\n    public sealed class CrmNoteSnippetDto\n    {\n        public Guid Id { get; set; }\n        public string Title { get; set; } = string.Empty;\n        public string Content { get; set; } = string.Empty;\n        public string? CreatedByName { get; set; }\n        public DateTime CreatedAt { get; set; }\n    }\n\n    public sealed class CrmReminderSnippetDto\n    {\n        public Guid Id { get; set; }\n        public string Title { get; set; } = string.Empty;\n        public string? Description { get; set; }\n        public string? Status { get; set; }\n        public DateTime DueAt { get; set; }\n        public int? Priority { get; set; }\n    }\n\n    public sealed class CrmTimelineEventDto\n    {\n        public int Id { get; set; }\n        public string Title { get; set; } = string.Empty;\n        public string? Source { get; set; }\n        public string? Category { get; set; }\n        public string? EventType { get; set; }\n        public DateTime CreatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/CsvImportResult.cs",
      "sha256": "b960c95f03cdabf593c9264c4a26457bc30278af2e88d77efe9a54ae066dd3c7",
      "language": "csharp",
      "size": 373,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class CsvImportResult<T>\n    {\n        public List<T> SuccessRecords { get; set; } = new();\n        public List<CsvImportError> Errors { get; set; } = new();\n    }\n\n    public class CsvImportError\n    {\n        public int RowNumber { get; set; }\n        public string ErrorMessage { get; set; } = string.Empty;\n    }\n}"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/NoteDto.cs",
      "sha256": "c69bf4f1954478dea6d479494ee03486eaac09f14ac495b0cbde23f17f107568",
      "language": "csharp",
      "size": 525,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class NoteDto\n    {\n        public Guid Id { get; set; }\n        public Guid? ContactId { get; set; }\n        public string? Title { get; set; }\n        public string Content { get; set; }\n        public string Source { get; set; }\n        public string CreatedBy { get; set; }\n        public bool IsPinned { get; set; }\n        public bool IsInternal { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public DateTime? EditedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/PagedResult.cs",
      "sha256": "fecb6fb29ec3bedc245dacd6fb2198d2f2c98335be5a5d93cd5a787d9248faa3",
      "language": "csharp",
      "size": 351,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class PagedResult<T>\n    {\n        public List<T> Items { get; set; } = new();\n        public int TotalCount { get; set; }\n\n        public int Page { get; set; }\n        public int PageSize { get; set; }\n        public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/ReminderDto.cs",
      "sha256": "637c90565af9cbcfe158cca564388b9afdadb2c3cbcacad35242dfe85f9bd395",
      "language": "csharp",
      "size": 1003,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CRM.Dtos\n{\n    public class ReminderDto\n    {\n        public Guid? Id { get; set; }  // Null when creating, present when updating\n\n        public Guid? ContactId { get; set; }\n\n        public string Title { get; set; } = default!;\n\n        public string? Description { get; set; }\n\n        public DateTime DueAt { get; set; }\n\n        public string? Status { get; set; } = \"Pending\";\n\n        public string? ReminderType { get; set; }\n\n        public int? Priority { get; set; }\n\n        public bool IsRecurring { get; set; }\n\n        public string? RecurrencePattern { get; set; }\n\n        public bool SendWhatsappNotification { get; set; }\n\n        public string? LinkedCampaign { get; set; }\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime? CreatedAt { get; set; }\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public DateTime? CompletedAt { get; set; }\n\n        public string? CreatedBy { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Dtos/TagDto.cs",
      "sha256": "cd0010264a2cc4567c59311afd6d637f23f2e070be2d4da68f6be0ab97e46ff4",
      "language": "csharp",
      "size": 521,
      "content": "namespace xbytechat.api.Features.CRM.Dtos\n{\n    public class TagDto\n    {\n        public Guid? Id { get; set; }\n\n        public string Name { get; set; } = default!;\n\n        public string? ColorHex { get; set; }\n\n        public string? Category { get; set; }\n\n        public string? Notes { get; set; }\n\n        public bool IsSystemTag { get; set; } = false;\n\n        public bool IsActive { get; set; } = true;\n\n        public DateTime? CreatedAt { get; set; }\n\n        public DateTime? LastUsedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Interfaces/IContactService.cs",
      "sha256": "b7ca4f37c5420dd9e44b8fd2d03c1c0fff462256304cae410fbd5a135aa261b9",
      "language": "csharp",
      "size": 1862,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CRM.Interfaces\n{\n    /// <summary>\n    /// Defines the contract for all operations related to managing contacts.\n    /// </summary>\n    public interface IContactService\n    {\n\n        Task<ResponseResult> AddContactAsync(Guid businessId, ContactDto dto);\n        Task<ContactDto> GetContactByIdAsync(Guid businessId, Guid contactId);\n        Task<bool> UpdateContactAsync(Guid businessId, ContactDto dto);\n        Task<bool> DeleteContactAsync(Guid businessId, Guid contactId);\n        Task<CsvImportResult<ContactDto>> ParseCsvToContactsAsync(Guid businessId, Stream csvStream);\n        Task<Contact> FindOrCreateAsync(Guid businessId, string phoneNumber);\n        Task<bool> ToggleFavoriteAsync(Guid businessId, Guid contactId);\n        Task<bool> ToggleArchiveAsync(Guid businessId, Guid contactId);\n        Task<IEnumerable<ContactDto>> GetAllContactsAsync(Guid businessId, string? tab = \"all\");\n        Task AssignTagToContactsAsync(Guid businessId, List<Guid> contactIds, Guid tagId);\n        Task<PagedResult<ContactDto>> GetPagedContactsAsync(\n             Guid businessId,\n             string? tab = \"all\",\n             int page = 1,\n             int pageSize = 25,\n             string? searchTerm = null\n            );\n        // ‚úÖ Tag-based filtering support\n        Task<IEnumerable<ContactDto>> GetContactsByTagsAsync(Guid businessId, List<Guid> tags);\n\n        Task<BulkImportResultDto> BulkImportAsync(Guid businessId, Stream csvStream);\n        // üìå New method to support flow node ‚Üí tag assignment\n        Task<bool> AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tags);\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Interfaces/IContactTagService.cs",
      "sha256": "779257e42642346dc94fd82a0d7286bc5fc37e9c884338d039f4849cf222d5e2",
      "language": "csharp",
      "size": 195,
      "content": "namespace xbytechat.api.Features.CRM.Interfaces\n{\n    public interface IContactTagService\n    {\n        Task<bool> RemoveTagFromContactAsync(Guid businessId, Guid contactId, Guid tagId);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Interfaces/INoteService.cs",
      "sha256": "3a55224ed1bd77632f1df5c60e2b9e83f76c595578c5cb47c07bd3965bda4360",
      "language": "csharp",
      "size": 705,
      "content": "using xbytechat.api.Features.CRM.Dtos;\n\nnamespace xbytechat.api.Features.CRM.Interfaces\n{\n    public interface INoteService\n    {\n        // For creating new note\n        Task<NoteDto> AddNoteAsync(Guid businessId, NoteDto dto);\n\n        // List all notes for dashboard view\n        Task<IEnumerable<NoteDto>> GetNotesByContactAsync(Guid businessId, Guid contactId);\n\n        // For loading note in edit mode\n        Task<NoteDto?> GetNoteByIdAsync(Guid businessId, Guid noteId);\n        // Handles editing\n        Task<bool> UpdateNoteAsync(Guid businessId, Guid noteId, NoteDto dto);\n        // Soft delete ‚Üí IsActive = false\n        Task<bool> DeleteNoteAsync(Guid businessId, Guid noteId);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Interfaces/IReminderService.cs",
      "sha256": "ee0bb73d2c3d212a59012abdf1d71ab3ef240b6f785d25dde255e5c7d30f3e16",
      "language": "csharp",
      "size": 824,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CRM.Dtos;\n\nnamespace xbytechat.api.Features.CRM.Interfaces\n{\n    public interface IReminderService\n    {\n        //For creating new reminder\n        Task<ReminderDto> AddReminderAsync(Guid businessId, ReminderDto dto);\n\n        //List all reminders for dashboard view\n        Task<IEnumerable<ReminderDto>> GetAllRemindersAsync(Guid businessId);\n\n        //For loading reminder in edit mode\n        Task<ReminderDto?> GetReminderByIdAsync(Guid businessId, Guid reminderId);\n\n        //Handles editing\n        Task<bool> UpdateReminderAsync(Guid businessId, Guid reminderId, ReminderDto dto);\n        //Soft delete ‚Üí IsActive = false\n        Task<bool> DeleteReminderAsync(Guid businessId, Guid reminderId);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Interfaces/ITagService.cs",
      "sha256": "3e9fdf4fa03f5eb4006b2b264f94a12f5fc20b7b8edc17f06e5ebcbe30d5c379",
      "language": "csharp",
      "size": 733,
      "content": "// üìÑ File: xbytechat-api/Features/CRM/Interfaces/ITagService.cs\n\nusing System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CRM.Dtos;\n\nnamespace xbytechat.api.Features.CRM.Interfaces\n{\n    public interface ITagService\n    {\n        Task<TagDto> AddTagAsync(Guid businessId, TagDto dto);\n\n        Task<IEnumerable<TagDto>> GetAllTagsAsync(Guid businessId);\n\n        Task<bool> UpdateTagAsync(Guid businessId, Guid tagId, TagDto dto);\n\n        Task<bool> DeleteTagAsync(Guid businessId, Guid tagId);\n\n        // ‚úÖ Return bool so callers can know if assignment actually happened\n        Task<bool> AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tagNames);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Mappers/NoteMapper.cs",
      "sha256": "3f51d3d0012825818ae828ab208605ea27dce968d81fbe8c5f213714573d1694",
      "language": "csharp",
      "size": 2363,
      "content": "using xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CRM.Mappers\n{\n    public static class NoteMapper\n    {\n        public static NoteDto MapToDto(Note note)\n        {\n            return new NoteDto\n            {\n                Id = note.Id,\n                ContactId = note.ContactId,\n                Title = note.Title ?? string.Empty,\n                Content = note.Content ?? string.Empty,\n                Source = note.Source ?? string.Empty,\n                CreatedBy = note.CreatedBy ?? string.Empty,\n                IsPinned = note.IsPinned,\n                IsInternal = note.IsInternal,\n                CreatedAt = note.CreatedAt,\n                EditedAt = note.EditedAt\n            };\n        }\n\n        public static Note MapToEntity(NoteDto dto, Guid businessId)\n        {\n            var content = (dto.Content ?? string.Empty).Trim();\n            var title = NormalizeTitle(dto.Title, content);\n\n            return new Note\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                ContactId = dto.ContactId,\n\n                // ‚úÖ Title is optional, derived from content if missing\n                Title = title,\n\n                // ‚úÖ Content is the real payload\n                Content = content,\n\n                // ‚úÖ Defaults to keep DB safe even if frontend sends null/empty\n                Source = string.IsNullOrWhiteSpace(dto.Source) ? \"Manual\" : dto.Source.Trim(),\n                CreatedBy = string.IsNullOrWhiteSpace(dto.CreatedBy) ? \"System\" : dto.CreatedBy.Trim(),\n\n                IsPinned = dto.IsPinned,\n                IsInternal = dto.IsInternal,\n\n                CreatedAt = DateTime.SpecifyKind(DateTime.UtcNow, DateTimeKind.Utc),\n                EditedAt = null\n            };\n        }\n\n        private static string NormalizeTitle(string? title, string content)\n        {\n            var t = (title ?? string.Empty).Trim();\n            if (!string.IsNullOrWhiteSpace(t)) return t;\n\n            // derive title from content\n            var c = (content ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(c)) return \"(Untitled)\"; // service already blocks empty content\n\n            const int max = 60;\n            return c.Length <= max ? c : (c.Substring(0, max) + \"‚Ä¶\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Mappers/ReminderMapper.cs",
      "sha256": "ca8d8fdc52f0d1f3cd2c7bc1de28d88ed5193a5407283690f942f1cb9fe0fbeb",
      "language": "csharp",
      "size": 1009,
      "content": "using xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CRM.Mappers\n{\n    public static class ReminderMapper\n    {\n        public static ReminderDto MapToDto(Reminder r)\n        {\n            return new ReminderDto\n            {\n                Id = r.Id,\n                ContactId = r.ContactId,\n                Title = r.Title,\n                Description = r.Description,\n                DueAt = r.DueAt,\n                Status = r.Status,\n                ReminderType = r.ReminderType,\n                Priority = r.Priority,\n                IsRecurring = r.IsRecurring,\n                RecurrencePattern = r.RecurrencePattern,\n                SendWhatsappNotification = r.SendWhatsappNotification,\n                LinkedCampaign = r.LinkedCampaign,\n                IsActive = r.IsActive,\n                CreatedAt = r.CreatedAt,\n                UpdatedAt = r.UpdatedAt,\n                CompletedAt = r.CompletedAt\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Models/Contact.cs",
      "sha256": "c937e665a05520a22229847b576b0db8d3668b905487f3e28f1adfc1e27c3649",
      "language": "csharp",
      "size": 3559,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.BusinessModule.Models;\n\nnamespace xbytechat.api.Features.CRM.Models\n{\n    public enum ContactOptStatus\n    {\n        Unspecified = 0,\n        OptedIn = 1,\n        OptedOut = 2\n    }\n\n    public enum ContactChannelStatus\n    {\n        Valid = 0,\n        BlockedByUser = 1,\n        InvalidNumber = 2\n    }\n\n    public class Contact\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid BusinessId { get; set; }\n        public Business Business { get; set; } = null!;\n        // üîó FK to Business\n        [Required]\n        [MaxLength(100)]\n        public string Name { get; set; } = null!;\n\n        [Required]\n        [MaxLength(20)]\n        public string PhoneNumber { get; set; } = null!;\n\n        [MaxLength(100)]\n        public string? Email { get; set; }\n\n        [MaxLength(50)]\n        public string? LeadSource { get; set; }\n\n        [MaxLength(200)]\n        public string? Tags { get; set; } // Legacy, will be deprecated after ContactTag rollout\n\n        public DateTime? LastContactedAt { get; set; }\n        public DateTime? NextFollowUpAt { get; set; }\n\n        [MaxLength(500)]\n        public string? Notes { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        // üß© NEW: Link to Tags\n        public ICollection<ContactTag> ContactTags { get; set; } = new List<ContactTag>();\n        // ‚úÖ New: Navigation property for many-to-many tags\n        //public ICollection<ContactTag> TagsLink { get; set; } = new List<ContactTag>();\n\n        public DateTime? LastCTAInteraction { get; set; }\n        public string? LastCTAType { get; set; }\n        public Guid? LastClickedProductId { get; set; }\n\n        // üö¶ If true, skip automation flows (manually or programmatically paused)\n        public bool IsAutomationPaused { get; set; } = false;\n\n        // üë§ If agent assigned, automation should pause (runtime check)\n        public Guid? AssignedAgentId { get; set; }\n\n        // --- Chat Inbox fields ---\n        [MaxLength(20)]\n        public string InboxStatus { get; set; } = \"Open\"; // Open / Pending / Closed\n\n        public DateTime? LastInboundAt { get; set; }   // UTC\n        public DateTime? LastOutboundAt { get; set; }  // UTC\n\n        // Hard consent state used to gate outbound sends.\n        public ContactOptStatus OptStatus { get; set; } = ContactOptStatus.Unspecified;\n\n        // Channel delivery health state for this contact number.\n        public ContactChannelStatus ChannelStatus { get; set; } = ContactChannelStatus.Valid;\n\n        // UTC timestamp for the last change to OptStatus.\n        public DateTime? OptStatusUpdatedAt { get; set; }\n\n        // UTC timestamp for the last change to ChannelStatus.\n        public DateTime? ChannelStatusUpdatedAt { get; set; }\n\n        // Human-readable reason when contact is opted out.\n        public string? OptOutReason { get; set; }\n\n        public bool IsFavorite { get; set; } = false;\n        public bool IsArchived { get; set; } = false;\n        public string? Group { get; set; }\n        public bool IsActive { get; set; } = true;\n\n\n        //public bool IsTemporary { get; set; } = false;\n        //public Guid? SourceCampaignId { get; set; }\n        //public DateTime? ExpiresAt { get; set; }\n\n        public string? ProfileName { get; set; }            // latest WA profile.name we saw inbound\n        public DateTime? ProfileNameUpdatedAt { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Models/ContactTag.cs",
      "sha256": "de88c1bdb0a34e2703e0bb2d9c83c80f2d4af9f2c008e11782fa4949ae0dc782",
      "language": "csharp",
      "size": 510,
      "content": "using System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.CRM.Models;\n\npublic class ContactTag\n{\n    [Key]\n    public Guid Id { get; set; }\n\n    [Required]\n    public Guid ContactId { get; set; }\n\n    public Contact Contact { get; set; }\n\n    [Required]\n    public Guid TagId { get; set; }\n\n    public Tag Tag { get; set; }\n\n    [Required]\n    public Guid BusinessId { get; set; }\n\n    public DateTime AssignedAt { get; set; } = DateTime.UtcNow;\n\n    public string? AssignedBy { get; set; }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Models/Note.cs",
      "sha256": "00b6b2dacb3efff3e8043beb4d763a5e8196378a60d699f59f0253b718c6d65d",
      "language": "csharp",
      "size": 923,
      "content": "namespace xbytechat.api.Features.CRM.Models\n{\n    public class Note\n    {\n        public Guid Id { get; set; }\n\n        // üîó Ownership & Association\n        public Guid? BusinessId { get; set; }\n        public Guid? ContactId { get; set; }\n\n        // üìù Core Content\n        public string Title { get; set; } // Optional short title (for pinning or preview)\n        public string Content { get; set; }\n\n        // üîñ Contextual Intelligence\n        public string Source { get; set; } // e.g., \"Manual\", \"Call Log\", \"WhatsApp\", \"LeadForm\"\n        public string CreatedBy { get; set; } // Store agent/user name or userId\n\n        // üìå UX Flags\n        public bool IsPinned { get; set; } = false;\n        public bool IsInternal { get; set; } = false; // if true, only visible to team\n\n        // üïì Timestamps\n        public DateTime CreatedAt { get; set; }\n        public DateTime? EditedAt { get; set; }\n    }\n}"
    },
    {
      "path": "xbytechat-api/Features/CRM/Models/Reminder.cs",
      "sha256": "fc98f9aad251b376a21b81c2984660a17369d962f22e44a6fdc4b404508542c1",
      "language": "csharp",
      "size": 1728,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CRM.Models\n{\n    public class Reminder\n    {\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }   // For multi-tenant isolation\n\n        public Guid ContactId { get; set; }    // Which contact this reminder is for\n\n        public string Title { get; set; } = default!; // Main reminder title (e.g., \"Call back about invoice\")\n\n        public string? Description { get; set; } // Longer notes, optional (for internal detail)\n\n        public DateTime DueAt { get; set; }    // When reminder should notify\n\n        public string Status { get; set; } = \"Pending\"; // \"Pending\", \"Done\", \"Overdue\"\n\n        public string? ReminderType { get; set; } // e.g., \"Call\", \"Email\", \"Follow-up\", \"Meeting\"\n\n        public int? Priority { get; set; } // e.g., 1 (High), 2 (Medium), 3 (Low)\n\n        public bool IsRecurring { get; set; } = false; // For future ‚Üí repeat reminder\n\n        public string? RecurrencePattern { get; set; } // e.g., \"Weekly\", \"Monthly\" (optional)\n\n        public bool SendWhatsappNotification { get; set; } = false; // Future: auto-WA message trigger\n\n        public string? LinkedCampaign { get; set; } // Optional: which campaign this reminder relates to\n\n        public bool IsActive { get; set; } = true;  // Soft delete support\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public DateTime? CompletedAt { get; set; } // Track when it was marked Done\n\n        public string? LastCTAType { get; set; } // e.g., Confirm, Reschedule\n        public DateTime? LastClickedAt { get; set; }\n        public bool FollowUpSent { get; set; } = false;\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Models/Tag.cs",
      "sha256": "387b3c7cd221661c2ced818b097b3a5cc250067db94531b997e4ed61f1e43e35",
      "language": "csharp",
      "size": 1117,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.CRM.Models\n{\n    public class Tag\n    {\n        public Guid Id { get; set; }\n\n        public Guid BusinessId { get; set; }             // Multi-tenant isolation\n\n        public string Name { get; set; } = default!;     // e.g., \"VIP\", \"Follow-up\"\n\n        public string? ColorHex { get; set; }            // For UI tag styling (e.g., #FF5733)\n\n        public string? Category { get; set; }            // e.g., \"Priority\", \"Campaign\", \"Stage\"\n\n        public string? Notes { get; set; }               // Admin/internal notes about this tag\n\n        public bool IsSystemTag { get; set; } = false;   // Reserved tags like \"New\", \"Subscribed\"\n\n        public bool IsActive { get; set; } = true;       // For soft-deactivation (future bulk ops)\n\n        public DateTime CreatedAt { get; set; }          // For analytics / sorting\n\n        public DateTime? LastUsedAt { get; set; }        // Useful for CRM insights later\n\n        public ICollection<ContactTag> ContactTags { get; set; } = new List<ContactTag>(); // Linked contacts\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/ContactProfileService.cs",
      "sha256": "a4dbe66bed0c345a7d9bca4860023d2ad35be6a378b62ba5affb4f28ee1493b5",
      "language": "csharp",
      "size": 3367,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public sealed class ContactProfileService : IContactProfileService\n    {\n        private readonly AppDbContext _db;\n\n        public ContactProfileService(AppDbContext db) => _db = db;\n\n        public async Task UpsertProfileNameAsync(\n            Guid businessId,\n            string phoneE164,\n            string? profileName,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(phoneE164) || string.IsNullOrWhiteSpace(profileName))\n                return;\n\n            var phoneDigits = PhoneNumberNormalizer.NormalizeToE164Digits(phoneE164, \"IN\");\n            if (string.IsNullOrWhiteSpace(phoneDigits))\n                return;\n\n            var newName = profileName.Trim();\n            var now = DateTime.UtcNow;\n\n            // Canonical lookup: digits-only E.164 (no '+')\n            var contact = await _db.Contacts.FirstOrDefaultAsync(\n                c => c.BusinessId == businessId &&\n                     c.PhoneNumber == phoneDigits,\n                ct);\n\n            if (contact == null)\n            {\n                // Concurrency-safe create\n                try\n                {\n                    _db.Contacts.Add(new Contact\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        PhoneNumber = phoneDigits,          // canonical = digits-only\n                        Name = newName,                     // display fallback\n                        ProfileName = newName,              // WA profile name\n                        ProfileNameUpdatedAt = now,\n                        CreatedAt = now,\n                        LastContactedAt = now\n                    });\n                    await _db.SaveChangesAsync(ct);\n                    return;\n                }\n                catch (DbUpdateException)\n                {\n                    // Someone else created it ‚Äî refetch and continue as update\n                    contact = await _db.Contacts.FirstOrDefaultAsync(\n                        c => c.BusinessId == businessId && c.PhoneNumber == phoneDigits, ct);\n                    if (contact == null) return;\n                }\n            }\n\n            var anyChange = false;\n\n            if (!string.Equals(contact.ProfileName, newName, StringComparison.Ordinal))\n            {\n                contact.ProfileName = newName;\n                contact.ProfileNameUpdatedAt = now;\n                anyChange = true;\n            }\n\n            // Backfill Name if empty/placeholder/phone\n            if (string.IsNullOrWhiteSpace(contact.Name) ||\n                contact.Name == \"WhatsApp User\" ||\n                contact.Name == contact.PhoneNumber)\n            {\n                if (!string.Equals(contact.Name, newName, StringComparison.Ordinal))\n                {\n                    contact.Name = newName;\n                    anyChange = true;\n                }\n            }\n\n            if (anyChange)\n            {\n                contact.ProfileNameUpdatedAt = now;\n                await _db.SaveChangesAsync(ct);\n            }\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/ContactService.cs",
      "sha256": "b0dfcf05efc0ced296125b4695cc30a6e4bb9e6c559f4f4f3c52f933a33ed598",
      "language": "csharp",
      "size": 31340,
      "content": "// üìÑ File: xbytechat-api/Features/CRM/Services/ContactService.cs\n\nusing System.ComponentModel.DataAnnotations;\nusing System.Globalization;\nusing CsvHelper;\nusing CsvHelper.Configuration;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public class ContactService : IContactService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<ContactService> _logger;\n\n        public ContactService(AppDbContext db, ILogger<ContactService> logger)\n        {\n            _db = db;\n            _logger = logger;\n        }\n\n        public async Task<ResponseResult> AddContactAsync(Guid businessId, ContactDto dto)\n        {\n            _logger.LogInformation(\"üì© AddContactAsync called for businessId={BusinessId}, Name={Name}\", businessId, dto.Name);\n\n            try\n            {\n                var normalizedPhone = NormalizePhone(dto.PhoneNumber);\n\n                if (string.IsNullOrWhiteSpace(normalizedPhone))\n                    return ResponseResult.ErrorInfo(\"‚ùå Phone number is invalid. Please enter a valid number.\");\n\n                var existingContact = await FindContactByPhoneAsync(businessId, normalizedPhone);\n\n                if (existingContact != null)\n                {\n                    _logger.LogWarning(\"‚ö†Ô∏è Duplicate contact attempt for phone {Phone}\", dto.PhoneNumber);\n                    return ResponseResult.ErrorInfo($\"‚ùå A contact with the phone number '{dto.PhoneNumber}' already exists.\");\n                }\n\n                var contact = new Contact\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = dto.Name,\n                    PhoneNumber = normalizedPhone, // ‚úÖ canonical digits-only\n                    Email = dto.Email,\n                    LeadSource = dto.LeadSource,\n                    LastContactedAt = dto.LastContactedAt?.ToUniversalTime(),\n                    NextFollowUpAt = dto.NextFollowUpAt?.ToUniversalTime(),\n                    Notes = dto.Notes,\n                    CreatedAt = DateTime.UtcNow,\n                    IsFavorite = dto.IsFavorite,\n                    IsArchived = dto.IsArchived,\n                    Group = dto.Group\n                };\n\n                if (dto.Tags != null && dto.Tags.Any())\n                {\n                    contact.ContactTags = dto.Tags.Select(t => new ContactTag\n                    {\n                        Id = Guid.NewGuid(),\n                        ContactId = contact.Id,\n                        TagId = t.TagId,\n                        BusinessId = businessId,\n                        AssignedAt = DateTime.UtcNow,\n                        AssignedBy = \"system\"\n                    }).ToList();\n                }\n\n                _db.Contacts.Add(contact);\n                await _db.SaveChangesAsync();\n\n                _logger.LogInformation(\"‚úÖ Contact added successfully: {ContactId}\", contact.Id);\n\n                var resultDto = new ContactDto\n                {\n                    Id = contact.Id,\n                    Name = contact.Name,\n                    PhoneNumber = contact.PhoneNumber,\n                    Email = contact.Email,\n                    LeadSource = contact.LeadSource,\n                    CreatedAt = contact.CreatedAt,\n                    Tags = contact.ContactTags?.Select(ct => new ContactTagDto { TagId = ct.TagId }).ToList() ?? new List<ContactTagDto>()\n                };\n\n                return ResponseResult.SuccessInfo(\"‚úÖ Contact created successfully.\", resultDto);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"üö® Unexpected error in AddContactAsync for business {BusinessId}\", businessId);\n                return ResponseResult.ErrorInfo(\"üö® A server error occurred while creating the contact.\", ex.Message);\n            }\n        }\n\n        public async Task<ContactDto> GetContactByIdAsync(Guid businessId, Guid contactId)\n        {\n            _logger.LogInformation(\"GetContactByIdAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, contactId);\n\n            var contact = await _db.Contacts\n                .Where(c => c.BusinessId == businessId && c.Id == contactId && c.IsActive)\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag)\n                .FirstOrDefaultAsync();\n\n            if (contact == null)\n                return null;\n\n            return new ContactDto\n            {\n                Id = contact.Id,\n                Name = contact.Name,\n                PhoneNumber = contact.PhoneNumber,\n                Email = contact.Email,\n                LeadSource = contact.LeadSource,\n                LastContactedAt = contact.LastContactedAt,\n                NextFollowUpAt = contact.NextFollowUpAt,\n                Notes = contact.Notes,\n                CreatedAt = contact.CreatedAt,\n                Tags = contact.ContactTags?\n                    .Where(ct => ct.Tag != null)\n                    .Select(ct => new ContactTagDto\n                    {\n                        TagId = ct.TagId,\n                        TagName = ct.Tag.Name\n                    })\n                    .ToList() ?? new List<ContactTagDto>()\n            };\n        }\n\n        public async Task<bool> UpdateContactAsync(Guid businessId, ContactDto dto)\n        {\n            _logger.LogInformation(\"UpdateContactAsync: businessId={BusinessId}, contactId={ContactId}\", businessId, dto.Id);\n\n            var contact = await _db.Contacts\n                .Include(c => c.ContactTags)\n                .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == dto.Id);\n\n            if (contact == null)\n                return false;\n\n            contact.Name = dto.Name;\n\n            var normalizedPhone = NormalizePhone(dto.PhoneNumber);\n            if (string.IsNullOrWhiteSpace(normalizedPhone))\n                throw new ArgumentException(\"Invalid phone number. Use E.164 digits-only (country code + number).\");\n\n            var lookupCandidates = BuildPhoneLookupCandidates(normalizedPhone);\n            var phoneExists = lookupCandidates.Count > 0 && await _db.Contacts.AnyAsync(c =>\n                c.BusinessId == businessId &&\n                c.Id != dto.Id &&\n                lookupCandidates.Contains(c.PhoneNumber));\n\n            if (phoneExists)\n                throw new ArgumentException(\"A contact with this phone number already exists.\");\n\n            contact.PhoneNumber = normalizedPhone;\n            contact.Email = dto.Email;\n            contact.LeadSource = dto.LeadSource;\n            contact.LastContactedAt = dto.LastContactedAt?.ToUniversalTime();\n            contact.NextFollowUpAt = dto.NextFollowUpAt?.ToUniversalTime();\n            contact.Notes = dto.Notes;\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> DeleteContactAsync(Guid businessId, Guid contactId)\n        {\n            var contact = await _db.Contacts\n                .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId && c.IsActive);\n\n            if (contact == null)\n                return false;\n\n            contact.IsActive = false;\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<CsvImportResult<ContactDto>> ParseCsvToContactsAsync(Guid businessId, Stream csvStream)\n        {\n            _logger.LogInformation(\"ParseCsvToContactsAsync: businessId={BusinessId}\", businessId);\n\n            var result = new CsvImportResult<ContactDto>();\n\n            var config = new CsvConfiguration(CultureInfo.InvariantCulture)\n            {\n                HeaderValidated = null,\n                MissingFieldFound = null,\n                BadDataFound = null,\n                PrepareHeaderForMatch = args =>\n                    (args.Header ?? string.Empty)\n                        .Trim()\n                        .Replace(\" \", \"\")\n                        .Replace(\"_\", \"\")\n                        .ToLowerInvariant()\n            };\n\n            using var reader = new StreamReader(csvStream);\n            using var csv = new CsvReader(reader, config);\n\n            csv.Context.RegisterClassMap<ContactDtoCsvMap>();\n\n            int rowNumber = 1;\n\n            await csv.ReadAsync();\n            csv.ReadHeader();\n\n            while (await csv.ReadAsync())\n            {\n                rowNumber++;\n                try\n                {\n                    var record = csv.GetRecord<ContactDto>();\n\n                    // ‚úÖ Normalize phone even during parse (so user sees what will be saved)\n                    var normalized = NormalizePhone(record.PhoneNumber);\n                    if (string.IsNullOrWhiteSpace(normalized))\n                    {\n                        result.Errors.Add(new CsvImportError\n                        {\n                            RowNumber = rowNumber,\n                            ErrorMessage = \"Invalid phone number (could not normalize to E.164 digits-only).\"\n                        });\n                        continue;\n                    }\n\n                    record.PhoneNumber = normalized;\n                    record.CreatedAt = DateTime.UtcNow;\n\n                    result.SuccessRecords.Add(record);\n                }\n                catch (Exception ex)\n                {\n                    result.Errors.Add(new CsvImportError\n                    {\n                        RowNumber = rowNumber,\n                        ErrorMessage = ex.Message\n                    });\n                }\n            }\n\n            return result;\n        }\n\n        private static string NormalizePhone(string phoneNumber)\n        {\n            var raw = (phoneNumber ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(raw))\n                return string.Empty;\n\n            // First pass: normal parser behavior (local + international supported).\n            var normalized = PhoneNumberNormalizer.NormalizeToE164Digits(raw, \"IN\");\n            if (!string.IsNullOrWhiteSpace(normalized))\n                return normalized;\n\n            // Second pass: webhook and provider payloads often send E.164 digits without '+'.\n            var digits = new string(raw.Where(char.IsDigit).ToArray());\n            if (string.IsNullOrWhiteSpace(digits))\n                return string.Empty;\n\n            normalized = PhoneNumberNormalizer.NormalizeToE164Digits(\"+\" + digits, \"IN\");\n            if (!string.IsNullOrWhiteSpace(normalized))\n                return normalized;\n\n            // Do not store ambiguous values; force parseable canonical format.\n            return string.Empty;\n        }\n\n        private static List<string> BuildPhoneLookupCandidates(string phoneNumber)\n        {\n            var raw = (phoneNumber ?? string.Empty).Trim();\n            var candidates = new HashSet<string>(StringComparer.Ordinal);\n            var normalized = NormalizePhone(raw);\n            var digitsOnly = new string(raw.Where(char.IsDigit).ToArray());\n\n            if (!string.IsNullOrWhiteSpace(normalized))\n            {\n                candidates.Add(normalized);\n                candidates.Add(\"+\" + normalized);\n\n                // Legacy IN rows may have been stored as 10-digit local numbers.\n                if (normalized.Length == 12 && normalized.StartsWith(\"91\", StringComparison.Ordinal))\n                    candidates.Add(normalized.Substring(2));\n            }\n\n            if (!string.IsNullOrWhiteSpace(digitsOnly))\n            {\n                candidates.Add(digitsOnly);\n                candidates.Add(\"+\" + digitsOnly);\n\n                if (digitsOnly.Length == 10)\n                {\n                    candidates.Add(\"91\" + digitsOnly);\n                    candidates.Add(\"+91\" + digitsOnly);\n                }\n                else if (digitsOnly.Length == 12 && digitsOnly.StartsWith(\"91\", StringComparison.Ordinal))\n                {\n                    candidates.Add(digitsOnly.Substring(2));\n                }\n            }\n\n            if (!string.IsNullOrWhiteSpace(raw))\n                candidates.Add(raw);\n\n            return candidates.Where(x => !string.IsNullOrWhiteSpace(x)).ToList();\n        }\n\n        private async Task<Contact?> FindContactByPhoneAsync(Guid businessId, string phoneNumber)\n        {\n            var lookupCandidates = BuildPhoneLookupCandidates(phoneNumber);\n            if (lookupCandidates.Count == 0)\n                return null;\n\n            return await _db.Contacts\n                .Where(c => c.BusinessId == businessId && lookupCandidates.Contains(c.PhoneNumber))\n                .OrderByDescending(c => c.IsActive)\n                .ThenByDescending(c => c.CreatedAt)\n                .FirstOrDefaultAsync();\n        }\n\n        public async Task<Contact> FindOrCreateAsync(Guid businessId, string phoneNumber)\n        {\n            var normalized = NormalizePhone(phoneNumber);\n            if (string.IsNullOrWhiteSpace(normalized))\n                throw new ArgumentException(\"Invalid phone number format.\", nameof(phoneNumber));\n\n            var contact = await FindContactByPhoneAsync(businessId, normalized);\n\n            if (contact != null)\n            {\n                // Opportunistically backfill legacy rows to canonical digits-only storage.\n                if (!string.Equals(contact.PhoneNumber, normalized, StringComparison.Ordinal))\n                {\n                    var canonicalAlreadyExists = await _db.Contacts.AnyAsync(c =>\n                        c.BusinessId == businessId &&\n                        c.Id != contact.Id &&\n                        c.PhoneNumber == normalized);\n\n                    if (!canonicalAlreadyExists)\n                    {\n                        contact.PhoneNumber = normalized;\n                        await _db.SaveChangesAsync();\n                    }\n                }\n\n                return contact;\n            }\n\n            var newContact = new Contact\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                Name = \"WhatsApp User\",\n                PhoneNumber = normalized,\n                CreatedAt = DateTime.UtcNow\n            };\n\n            _db.Contacts.Add(newContact);\n            await _db.SaveChangesAsync();\n            return newContact;\n        }\n\n        public async Task<bool> ToggleFavoriteAsync(Guid businessId, Guid contactId)\n        {\n            var contact = await _db.Contacts.FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId);\n            if (contact == null) return false;\n\n            contact.IsFavorite = !contact.IsFavorite;\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task AssignTagToContactsAsync(Guid businessId, List<Guid> contactIds, Guid tagId)\n        {\n            var contacts = await _db.Contacts\n                .Where(c => c.BusinessId == businessId && contactIds.Contains(c.Id))\n                .Include(c => c.ContactTags)\n                .ToListAsync();\n\n            foreach (var contact in contacts)\n            {\n                bool alreadyAssigned = contact.ContactTags.Any(link => link.TagId == tagId);\n                if (!alreadyAssigned)\n                {\n                    contact.ContactTags.Add(new ContactTag\n                    {\n                        ContactId = contact.Id,\n                        TagId = tagId\n                    });\n                }\n            }\n\n            await _db.SaveChangesAsync();\n        }\n\n        public async Task<bool> ToggleArchiveAsync(Guid businessId, Guid contactId)\n        {\n            var contact = await _db.Contacts.FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId);\n            if (contact == null) return false;\n\n            contact.IsArchived = !contact.IsArchived;\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<IEnumerable<ContactDto>> GetAllContactsAsync(Guid businessId, string? tab = \"all\")\n        {\n            var baseQuery = _db.Contacts\n                .Where(c => c.BusinessId == businessId && c.IsActive);\n\n            if (tab == \"favourites\")\n                baseQuery = baseQuery.Where(c => c.IsFavorite);\n            else if (tab == \"archived\")\n                baseQuery = baseQuery.Where(c => c.IsArchived);\n            else if (tab == \"groups\")\n                baseQuery = baseQuery.Where(c => !string.IsNullOrEmpty(c.Group));\n\n            var contacts = await baseQuery\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag)\n                .ToListAsync();\n\n            return contacts.Select(c => new ContactDto\n            {\n                Id = c.Id,\n                Name = c.Name,\n                PhoneNumber = c.PhoneNumber,\n                Email = c.Email,\n                LeadSource = c.LeadSource,\n                LastContactedAt = c.LastContactedAt,\n                NextFollowUpAt = c.NextFollowUpAt,\n                Notes = c.Notes,\n                CreatedAt = c.CreatedAt,\n                IsFavorite = c.IsFavorite,\n                IsArchived = c.IsArchived,\n                Group = c.Group,\n                Tags = c.ContactTags?\n                    .Where(ct => ct.Tag != null)\n                    .Select(ct => new ContactTagDto\n                    {\n                        TagId = ct.TagId,\n                        TagName = ct.Tag.Name,\n                        ColorHex = ct.Tag.ColorHex,\n                        Category = ct.Tag.Category\n                    })\n                    .ToList() ?? new List<ContactTagDto>()\n            });\n        }\n\n        public async Task<PagedResult<ContactDto>> GetPagedContactsAsync(Guid businessId, string? tab, int page, int pageSize, string? searchTerm)\n        {\n            if (page < 1) page = 1;\n            if (pageSize < 1) pageSize = 25;\n            if (pageSize > 100) pageSize = 100;\n\n            var baseQuery = _db.Contacts\n                .Where(c => c.BusinessId == businessId && c.IsActive);\n\n            if (string.IsNullOrWhiteSpace(tab) || tab == \"all\")\n                baseQuery = baseQuery.Where(c => !c.IsArchived);\n\n            if (tab == \"favourites\")\n                baseQuery = baseQuery.Where(c => c.IsFavorite);\n            else if (tab == \"archived\")\n                baseQuery = baseQuery.Where(c => c.IsArchived);\n            else if (tab == \"groups\")\n                baseQuery = baseQuery.Where(c => !string.IsNullOrEmpty(c.Group));\n\n            if (!string.IsNullOrWhiteSpace(searchTerm))\n            {\n                var term = searchTerm.Trim();\n                baseQuery = baseQuery.Where(c =>\n                    (c.Name != null && EF.Functions.Like(c.Name, $\"%{term}%\")) ||\n                    (c.PhoneNumber != null && EF.Functions.Like(c.PhoneNumber, $\"%{term}%\")) ||\n                    (c.Email != null && EF.Functions.Like(c.Email, $\"%{term}%\"))\n                );\n            }\n\n            var totalCount = await baseQuery.CountAsync();\n\n            var contacts = await baseQuery\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag)\n                .OrderBy(c => c.Name)\n                .Skip((page - 1) * pageSize)\n                .Take(pageSize)\n                .ToListAsync();\n\n            var items = contacts.Select(c => new ContactDto\n            {\n                Id = c.Id,\n                Name = c.Name,\n                PhoneNumber = c.PhoneNumber,\n                Email = c.Email,\n                LeadSource = c.LeadSource,\n                LastContactedAt = c.LastContactedAt,\n                NextFollowUpAt = c.NextFollowUpAt,\n                Notes = c.Notes,\n                CreatedAt = c.CreatedAt,\n                IsFavorite = c.IsFavorite,\n                IsArchived = c.IsArchived,\n                Group = c.Group,\n                Tags = c.ContactTags?\n                    .Where(ct => ct.Tag != null)\n                    .Select(ct => new ContactTagDto\n                    {\n                        TagId = ct.TagId,\n                        TagName = ct.Tag.Name,\n                        ColorHex = ct.Tag.ColorHex,\n                        Category = ct.Tag.Category\n                    })\n                    .ToList() ?? new List<ContactTagDto>()\n            }).ToList();\n\n            return new PagedResult<ContactDto>\n            {\n                Items = items,\n                TotalCount = totalCount,\n                Page = page,\n                PageSize = pageSize\n            };\n        }\n\n        public async Task<IEnumerable<ContactDto>> GetContactsByTagsAsync(Guid businessId, List<Guid> tagIds)\n        {\n            var baseQuery = _db.Contacts\n                .Where(c => c.BusinessId == businessId && !c.IsArchived);\n\n            if (tagIds?.Any() == true)\n            {\n                baseQuery = baseQuery.Where(c => c.ContactTags.Any(ct => tagIds.Contains(ct.TagId)));\n            }\n\n            var contacts = await baseQuery\n                .Include(c => c.ContactTags)\n                    .ThenInclude(ct => ct.Tag)\n                .ToListAsync();\n\n            return contacts.Select(c => new ContactDto\n            {\n                Id = c.Id,\n                Name = c.Name,\n                PhoneNumber = c.PhoneNumber,\n                Tags = c.ContactTags.Select(ct => new ContactTagDto\n                {\n                    TagId = ct.Tag.Id,\n                    TagName = ct.Tag.Name,\n                    ColorHex = ct.Tag.ColorHex,\n                    Category = ct.Tag.Category\n                }).ToList()\n            });\n        }\n\n        public async Task<bool> AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tags)\n        {\n            var normalizedPhone = NormalizePhone(phoneNumber);\n            if (string.IsNullOrWhiteSpace(normalizedPhone)) return false;\n            phoneNumber = normalizedPhone;\n\n            if (tags == null || tags.Count == 0)\n                return false;\n\n            var lookupCandidates = BuildPhoneLookupCandidates(normalizedPhone);\n            if (lookupCandidates.Count == 0)\n                return false;\n\n            var contact = await _db.Contacts\n                .FirstOrDefaultAsync(c =>\n                    c.BusinessId == businessId &&\n                    !c.IsArchived &&\n                    lookupCandidates.Contains(c.PhoneNumber));\n\n            if (contact == null)\n                return false;\n\n            foreach (var tagName in tags)\n            {\n                if (string.IsNullOrWhiteSpace(tagName))\n                    continue;\n\n                var cleanName = tagName.Trim();\n\n                var tag = await _db.Tags\n                    .FirstOrDefaultAsync(t => t.BusinessId == businessId && t.Name == cleanName && t.IsActive);\n\n                if (tag == null)\n                {\n                    tag = new Tag\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Name = cleanName,\n                        ColorHex = \"#8c8c8c\",\n                        IsActive = true,\n                        CreatedAt = DateTime.UtcNow\n                    };\n                    _db.Tags.Add(tag);\n                }\n\n                var alreadyTagged = await _db.ContactTags.AnyAsync(ct =>\n                    ct.ContactId == contact.Id && ct.TagId == tag.Id);\n\n                if (!alreadyTagged)\n                {\n                    _db.ContactTags.Add(new ContactTag\n                    {\n                        Id = Guid.NewGuid(),\n                        ContactId = contact.Id,\n                        TagId = tag.Id\n                    });\n                }\n            }\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n\n\n        public async Task<BulkImportResultDto> BulkImportAsync(Guid businessId, Stream csvStream)\n        {\n            _logger.LogInformation(\"Bulk import started for businessId={BusinessId}\", businessId);\n\n            var result = new BulkImportResultDto();\n\n            var config = new CsvConfiguration(System.Globalization.CultureInfo.InvariantCulture)\n            {\n                HeaderValidated = null,\n                MissingFieldFound = null,\n                BadDataFound = null,\n                PrepareHeaderForMatch = args =>\n                    (args.Header ?? string.Empty)\n                        .Trim()\n                        .Replace(\" \", \"\")\n                        .Replace(\"_\", \"\")\n                        .ToLowerInvariant()\n            };\n\n            using var reader = new StreamReader(csvStream);\n            using var csv = new CsvReader(reader, config);\n\n            csv.Context.RegisterClassMap<ContactDtoCsvMap>();\n\n            await csv.ReadAsync();\n            csv.ReadHeader();\n\n            // Collect rows first so we can query DB only for relevant phones\n            var parsedRows = new List<(int Row, string Phone, string Name, string? Email, string? LeadSource, string? Notes)>();\n            var seenInFile = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n\n            int row = 1;\n\n            while (await csv.ReadAsync())\n            {\n                row++;\n                try\n                {\n                    var dto = csv.GetRecord<ContactDto>();\n\n                    var name = (dto.Name ?? string.Empty).Trim();\n                    if (string.IsNullOrWhiteSpace(name))\n                    {\n                        result.Errors.Add(new CsvImportError { RowNumber = row, ErrorMessage = \"Name is required.\" });\n                        continue;\n                    }\n\n                    // Canonical normalize: digits-only E.164 (no '+')\n                    var normalizedPhone = PhoneNumberNormalizer.NormalizeToE164Digits(dto.PhoneNumber, \"IN\");\n                    if (string.IsNullOrWhiteSpace(normalizedPhone))\n                    {\n                        result.Errors.Add(new CsvImportError { RowNumber = row, ErrorMessage = $\"Invalid phone number: '{dto.PhoneNumber}'\" });\n                        continue;\n                    }\n\n                    // Dedupe within the CSV\n                    if (!seenInFile.Add(normalizedPhone))\n                    {\n                        result.DuplicatesInFile++;\n                        continue;\n                    }\n\n                    var email = string.IsNullOrWhiteSpace(dto.Email) ? null : dto.Email.Trim();\n                    if (!string.IsNullOrWhiteSpace(email) && !IsValidEmail(email))\n                    {\n                        result.Errors.Add(new CsvImportError { RowNumber = row, ErrorMessage = $\"Invalid email: '{dto.Email}'\" });\n                        continue;\n                    }\n\n                    parsedRows.Add((\n                        Row: row,\n                        Phone: normalizedPhone,\n                        Name: name,\n                        Email: email,\n                        LeadSource: string.IsNullOrWhiteSpace(dto.LeadSource) ? null : dto.LeadSource.Trim(),\n                        Notes: string.IsNullOrWhiteSpace(dto.Notes) ? null : dto.Notes.Trim()\n                    ));\n                }\n                catch (Exception ex)\n                {\n                    _logger.LogWarning(ex, \"CSV parsing error at row {Row}\", row);\n                    result.Errors.Add(new CsvImportError { RowNumber = row, ErrorMessage = $\"Parse error: {ex.Message}\" });\n                }\n            }\n\n            if (parsedRows.Count == 0)\n            {\n                _logger.LogInformation(\"Bulk import done. businessId={BusinessId}, nothing to import.\", businessId);\n                return result;\n            }\n\n            var phones = parsedRows.Select(x => x.Phone).Distinct(StringComparer.OrdinalIgnoreCase).ToList();\n\n            // Fetch *all* matching contacts (including soft-deleted) for restore logic\n            var existingContacts = await _db.Contacts\n                .Where(c => c.BusinessId == businessId && phones.Contains(c.PhoneNumber))\n                .ToListAsync();\n\n            var existingByPhone = existingContacts\n                .GroupBy(c => c.PhoneNumber, StringComparer.OrdinalIgnoreCase)\n                .ToDictionary(\n                    g => g.Key,\n                    g => g.OrderByDescending(x => x.IsActive).ThenByDescending(x => x.CreatedAt).First(),\n                    StringComparer.OrdinalIgnoreCase\n                );\n\n            var toInsert = new List<Contact>();\n\n            foreach (var r in parsedRows)\n            {\n                if (existingByPhone.TryGetValue(r.Phone, out var existing))\n                {\n                    // Policy:\n                    // - Active -> skip\n                    // - Soft-deleted (IsActive=false) -> restore\n                    // - Archived -> skip (treat as existing)\n                    if (existing.IsArchived)\n                    {\n                        result.SkippedExisting++;\n                        continue;\n                    }\n\n                    if (existing.IsActive)\n                    {\n                        result.SkippedExisting++;\n                        continue;\n                    }\n\n                    // ‚úÖ Restore soft-deleted\n                    existing.IsActive = true;\n                    existing.IsArchived = false;\n\n                    // Update fields (safe updates: only overwrite when CSV provides data)\n                    existing.Name = r.Name;\n                    if (!string.IsNullOrWhiteSpace(r.Email)) existing.Email = r.Email;\n                    if (!string.IsNullOrWhiteSpace(r.LeadSource)) existing.LeadSource = r.LeadSource;\n                    if (!string.IsNullOrWhiteSpace(r.Notes)) existing.Notes = r.Notes;\n\n                    result.Restored++;\n                    continue;\n                }\n\n                // Brand-new insert\n                toInsert.Add(new Contact\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = r.Name,\n                    PhoneNumber = r.Phone,\n                    Email = r.Email,\n                    LeadSource = r.LeadSource,\n                    Notes = r.Notes,\n                    IsActive = true,\n                    IsArchived = false,\n                    CreatedAt = DateTime.UtcNow\n                });\n            }\n\n            if (toInsert.Count > 0)\n            {\n                _db.Contacts.AddRange(toInsert);\n            }\n\n            await _db.SaveChangesAsync();\n\n            result.Imported = toInsert.Count;\n\n            _logger.LogInformation(\n                \"Bulk import done. businessId={BusinessId}, imported={Imported}, restored={Restored}, skippedExisting={SkippedExisting}, dupInFile={DupInFile}, errors={Errors}\",\n                businessId, result.Imported, result.Restored, result.SkippedExisting, result.DuplicatesInFile, result.Errors.Count\n            );\n\n            return result;\n\n            static bool IsValidEmail(string email)\n            {\n                // EmailAddressAttribute is good enough for MVP validation\n                return new EmailAddressAttribute().IsValid(email);\n            }\n        }\n\n\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/ContactSummaryService.cs",
      "sha256": "9e617711dc057302ba7f05b37bc2c6d11eb2fb1ce8370e2f1fa2ec40c48a9080",
      "language": "csharp",
      "size": 4320,
      "content": "// üìÑ xbytechat-api/Features/CRM/Summary/Services/ContactSummaryService.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Mappers;\nusing xbytechat.api.Features.CRM.Timelines.Services;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    /// <summary>\n    /// Default implementation of IContactSummaryService.\n    /// Orchestrates calls into existing CRM services and returns\n    /// a single response model tailored for UI consumption.\n    /// </summary>\n    public sealed class ContactSummaryService : IContactSummaryService\n    {\n        private readonly IContactService _contactService;\n        private readonly INoteService _noteService;\n        private readonly IReminderService _reminderService;\n        private readonly ILeadTimelineService _leadTimelineService;\n\n        public ContactSummaryService(\n            IContactService contactService,\n            INoteService noteService,\n            IReminderService reminderService,\n            ILeadTimelineService leadTimelineService)\n        {\n            _contactService = contactService ?? throw new ArgumentNullException(nameof(contactService));\n            _noteService = noteService ?? throw new ArgumentNullException(nameof(noteService));\n            _reminderService = reminderService ?? throw new ArgumentNullException(nameof(reminderService));\n            _leadTimelineService = leadTimelineService ?? throw new ArgumentNullException(nameof(leadTimelineService));\n        }\n\n        public async Task<ContactSummaryResponseDto?> GetContactSummaryAsync(\n            Guid businessId,\n            Guid contactId,\n            CancellationToken ct = default)\n        {\n            // 1) Core contact (this already returns ContactDto with tags)\n            var contact = await _contactService.GetContactByIdAsync(businessId, contactId);\n            if (contact == null)\n            {\n                return null;\n            }\n\n            // 2) Notes ‚Äì latest 3 by CreatedAt\n            var notes = await _noteService.GetNotesByContactAsync(businessId, contactId);\n            var recentNotes = notes\n                .OrderByDescending(n => n.CreatedAt)\n                .Take(3)\n                .ToList();\n\n            // 3) Next upcoming reminder for this contact (in-memory filter from service)\n            var allReminders = await _reminderService.GetAllRemindersAsync(businessId);\n            var nowUtc = DateTime.UtcNow;\n\n            var nextReminder = allReminders\n                .Where(r =>\n                    r.ContactId == contactId &&\n                    r.IsActive &&\n                    string.Equals(r.Status, \"Pending\", StringComparison.OrdinalIgnoreCase) &&\n                    r.DueAt >= nowUtc)\n                .OrderBy(r => r.DueAt)\n                .FirstOrDefault();\n\n            // 4) Recent timeline entries (latest 5 by CreatedAt)\n            var timelineEntities = await _leadTimelineService.GetTimelineByContactIdAsync(contactId);\n\n            var recentTimeline = timelineEntities\n                .OrderByDescending(e => e.CreatedAt)\n                .Take(5)\n                .Select(LeadTimelineMapper.ToDto)\n                .Where(dto => dto != null)\n                .ToList()!; // mapper may return null, we filter just in case\n\n            // 5) Assemble response\n            return new ContactSummaryResponseDto\n            {\n                BusinessId = businessId,\n                ContactId = contactId,\n\n                Name = contact.Name,\n                PhoneNumber = contact.PhoneNumber,\n                Email = contact.Email,\n                LeadSource = contact.LeadSource,\n                LastContactedAt = contact.LastContactedAt,\n                NextFollowUpAt = contact.NextFollowUpAt,\n                IsFavorite = contact.IsFavorite,\n                IsArchived = contact.IsArchived,\n                Group = contact.Group,\n\n                Tags = contact.Tags ?? new List<ContactTagDto>(),\n\n                RecentNotes = recentNotes,\n                NextReminder = nextReminder,\n                RecentTimeline = recentTimeline\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/ContactTagService.cs",
      "sha256": "543a9a012a00f3ba3e43254aa3af8e48059f0aa7573ed59f8d7cdf20c4bc3684",
      "language": "csharp",
      "size": 2387,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Services;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public class ContactTagService : IContactTagService\n    {\n        private readonly AppDbContext _db;\n        private readonly ITimelineService _timelineService;\n        private readonly ILogger<ContactTagService> _logger;\n\n        public ContactTagService(AppDbContext db, ITimelineService timelineService, ILogger<ContactTagService> logger)\n        {\n            _db = db;\n            _timelineService = timelineService;\n            _logger = logger;\n        }\n\n        public async Task<bool> RemoveTagFromContactAsync(Guid businessId, Guid contactId, Guid tagId)\n        {\n            // ‚úÖ Find the link row but confirm contact belongs to this business\n            var link = await _db.ContactTags\n                .Join(_db.Contacts,\n                    ct => ct.ContactId,\n                    c => c.Id,\n                    (ct, c) => new { ct, c })\n                .Where(x => x.c.BusinessId == businessId\n                            && x.c.IsActive\n                            && x.ct.ContactId == contactId\n                            && x.ct.TagId == tagId)\n                .Select(x => x.ct)\n                .FirstOrDefaultAsync();\n\n            if (link == null) return false;\n\n            _db.ContactTags.Remove(link);\n            await _db.SaveChangesAsync();\n\n            // ‚úÖ Timeline log (safe, do not fail delete if timeline fails)\n            try\n            {\n                await _timelineService.LogTagRemovedAsync(new CRMTimelineLogDto\n                {\n                    ContactId = contactId,\n                    BusinessId = businessId,\n                    EventType = \"TagRemoved\",\n                    Description = $\"üè∑Ô∏è Tag removed.\",\n                    ReferenceId = tagId,\n                    CreatedBy = \"system\",\n                    Timestamp = DateTime.UtcNow,\n                    Category = \"CRM\"\n                });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogWarning(ex, \"Timeline log failed for TagRemoved. ContactId={ContactId}, TagId={TagId}\", contactId, tagId);\n            }\n\n            return true;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/IContactProfileService.cs",
      "sha256": "2238c717846876f685aeb1424a5812b4673fd589105f31cdfbe116672d1cfd61",
      "language": "csharp",
      "size": 492,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public interface IContactProfileService\n    {\n        /// <summary>\n        /// Update contact's ProfileName if changed. Lookup by (BusinessId, E.164 phone).\n        /// No-op if contact not found or name is empty.\n        /// </summary>\n        Task UpsertProfileNameAsync(Guid businessId, string phoneE164, string? profileName, CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/IContactSummaryService.cs",
      "sha256": "eaee7641520cea5125234a96e58c4e6ee94f241e1a3098f43f36fe5cac76e56f",
      "language": "csharp",
      "size": 773,
      "content": "// üìÑ xbytechat-api/Features/CRM/Summary/Interfaces/IContactSummaryService.cs\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CRM.Dtos;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    /// <summary>\n    /// Aggregates data from CRM modules (Contacts, Notes, Reminders, Timeline)\n    /// into a single contact summary for the Chat Inbox / dashboards.\n    /// </summary>\n    public interface IContactSummaryService\n    {\n        /// <summary>\n        /// Returns a compact CRM snapshot for the given contact and business.\n        /// </summary>\n        Task<ContactSummaryResponseDto?> GetContactSummaryAsync(\n            Guid businessId,\n            Guid contactId,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/NoteService.cs",
      "sha256": "a25f2e5436a4deff6bd3860b2e339dfed6e41678d847ce1e61fc5af3d4da75c0",
      "language": "csharp",
      "size": 5573,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Mappers;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Services;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public class NoteService : INoteService\n    {\n        private readonly AppDbContext _db;\n        private readonly ITimelineService _timelineService;\n\n        public NoteService(AppDbContext db, ITimelineService timelineService)\n        {\n            _db = db;\n            _timelineService = timelineService;\n        }\n\n        // üìù Add a new Note + Log into LeadTimeline\n        public async Task<NoteDto> AddNoteAsync(Guid businessId, NoteDto dto)\n        {\n            if (dto == null) throw new ArgumentNullException(nameof(dto));\n\n            // ‚úÖ Content is the real important field\n            dto.Content = (dto.Content ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(dto.Content))\n                throw new ArgumentException(\"Note content is required.\");\n\n            // ‚úÖ Title is optional ‚Üí derive from Content if missing\n            dto.Title = NormalizeTitle(dto.Title, dto.Content);\n\n            // 1Ô∏è‚É£ Map incoming DTO to Note entity\n            var note = NoteMapper.MapToEntity(dto, businessId);\n\n            // 2Ô∏è‚É£ Save the Note into database\n            _db.Notes.Add(note);\n            await _db.SaveChangesAsync();\n\n            // 3Ô∏è‚É£ Log this Note creation into LeadTimeline (only if ContactId is present)\n            if (dto.ContactId.HasValue)\n            {\n                try\n                {\n                    await _timelineService.LogNoteAddedAsync(new CRMTimelineLogDto\n                    {\n                        ContactId = dto.ContactId.Value,\n                        BusinessId = businessId,\n                        EventType = \"NoteAdded\",\n                        Description = $\"üìù Note added: {dto.Title ?? \"(Untitled)\"}\",\n                        ReferenceId = note.Id,\n                        CreatedBy = dto.CreatedBy, // ‚ö†Ô∏è ideally override from claims in controller\n                        Timestamp = DateTime.UtcNow\n                    });\n                }\n                catch (Exception ex)\n                {\n                    // üõ° Timeline saving failure should not break note creation\n                    Console.WriteLine($\"‚ö†Ô∏è Timeline log failed for NoteId {note.Id}: {ex.Message}\");\n                }\n            }\n\n            // 4Ô∏è‚É£ Return the saved note as DTO\n            return NoteMapper.MapToDto(note);\n        }\n\n        // üìã List all Notes by Contact\n        public async Task<IEnumerable<NoteDto>> GetNotesByContactAsync(Guid businessId, Guid contactId)\n        {\n            return await _db.Notes\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.ContactId == contactId)\n                .OrderByDescending(n => n.CreatedAt)\n                .Select(n => NoteMapper.MapToDto(n))\n                .ToListAsync();\n        }\n\n        // üìã Get a single Note by Id\n        public async Task<NoteDto?> GetNoteByIdAsync(Guid businessId, Guid noteId)\n        {\n            var note = await _db.Notes\n                .AsNoTracking()\n                .FirstOrDefaultAsync(n => n.Id == noteId && n.BusinessId == businessId);\n\n            return note == null ? null : NoteMapper.MapToDto(note);\n        }\n\n        // ‚úèÔ∏è Update an existing Note\n        public async Task<bool> UpdateNoteAsync(Guid businessId, Guid noteId, NoteDto dto)\n        {\n            if (dto == null) throw new ArgumentNullException(nameof(dto));\n\n            var note = await _db.Notes.FirstOrDefaultAsync(n => n.Id == noteId && n.BusinessId == businessId);\n            if (note == null) return false;\n\n            // ‚úÖ Content is required\n            dto.Content = (dto.Content ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(dto.Content))\n                throw new ArgumentException(\"Note content is required.\");\n\n            // ‚úÖ Title optional: only update if provided, else derive from Content\n            var normalizedTitle = NormalizeTitle(dto.Title, dto.Content);\n            note.Title = normalizedTitle;\n\n            note.Content = dto.Content;\n            note.IsPinned = dto.IsPinned;\n            note.IsInternal = dto.IsInternal;\n            note.EditedAt = DateTime.SpecifyKind(DateTime.UtcNow, DateTimeKind.Utc);\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        // üóëÔ∏è HARD delete (actual remove) a Note\n        public async Task<bool> DeleteNoteAsync(Guid businessId, Guid noteId)\n        {\n            var note = await _db.Notes.FirstOrDefaultAsync(n => n.Id == noteId && n.BusinessId == businessId);\n            if (note == null) return false;\n\n            _db.Notes.Remove(note); // ‚úÖ Hard delete\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        // ----------------- helpers -----------------\n\n        private static string? NormalizeTitle(string? title, string content)\n        {\n            var t = (title ?? string.Empty).Trim();\n            if (!string.IsNullOrWhiteSpace(t))\n                return t;\n\n            // derive from content\n            var c = (content ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(c))\n                return null;\n\n            const int max = 60;\n            return c.Length <= max ? c : (c.Substring(0, max) + \"‚Ä¶\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/ReminderService.cs",
      "sha256": "0446270dbb8c52631513ddb887d88c0a3643e1c7f0f9c0821a0d6d74984f0df0",
      "language": "csharp",
      "size": 8345,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Mappers;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Services;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public class ReminderService : IReminderService\n    {\n        private readonly AppDbContext _db;\n        private readonly ITimelineService _timelineService;\n        private readonly ILogger<ReminderService> _logger;\n\n        public ReminderService(AppDbContext db, ITimelineService timelineService, ILogger<ReminderService> logger)\n        {\n            _db = db;\n            _timelineService = timelineService;\n            _logger = logger;\n        }\n\n        public async Task<ReminderDto> AddReminderAsync(Guid businessId, ReminderDto dto)\n        {\n            if (dto == null) throw new ArgumentNullException(nameof(dto));\n\n            var title = string.IsNullOrWhiteSpace(dto.Title) ? \"(No title)\" : dto.Title.Trim();\n            var status = string.IsNullOrWhiteSpace(dto.Status) ? \"Pending\" : dto.Status.Trim();\n\n            // ‚úÖ Your DB model uses Guid (not nullable), so we must choose a value\n            var contactId = dto.ContactId ?? Guid.Empty;\n\n            var reminder = new Reminder\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                ContactId = contactId, // ‚úÖ Guid value (Guid.Empty if none)\n                Title = title,\n                Description = dto.Description?.Trim(),\n                DueAt = EnsureUtc(dto.DueAt),\n                Status = status,\n                ReminderType = dto.ReminderType?.Trim(),\n                Priority = dto.Priority,\n                IsRecurring = dto.IsRecurring,\n                RecurrencePattern = dto.RecurrencePattern,\n                SendWhatsappNotification = dto.SendWhatsappNotification,\n                LinkedCampaign = dto.LinkedCampaign,\n                CreatedAt = DateTime.UtcNow, // ‚úÖ correct\n                UpdatedAt = null,\n                CompletedAt = IsDoneStatus(status) ? DateTime.UtcNow : null,\n                IsActive = true\n            };\n\n            _db.Reminders.Add(reminder);\n            await _db.SaveChangesAsync();\n\n            // ‚úÖ Timeline only if contactId is real\n            if (contactId != Guid.Empty)\n            {\n                try\n                {\n                    await _timelineService.LogReminderSetAsync(new CRMTimelineLogDto\n                    {\n                        ContactId = contactId,\n                        BusinessId = businessId,\n                        EventType = \"ReminderSet\",\n                        Description = $\"‚è∞ Reminder set: {reminder.Title} (Due: {reminder.DueAt:yyyy-MM-dd HH:mm} UTC)\",\n                        ReferenceId = reminder.Id,\n                        CreatedBy = dto.CreatedBy ?? \"system\",\n                        Timestamp = DateTime.UtcNow,\n                        Category = \"CRM\"\n                    });\n                }\n                catch (Exception ex)\n                {\n                    _logger.LogWarning(ex, \"Timeline log failed for ReminderId={ReminderId}\", reminder.Id);\n                }\n            }\n\n            return ReminderMapper.MapToDto(reminder);\n        }\n\n        public async Task<IEnumerable<ReminderDto>> GetAllRemindersAsync(Guid businessId)\n        {\n            return await _db.Reminders\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.IsActive)\n                .OrderBy(r => r.DueAt)\n                .Select(r => ReminderMapper.MapToDto(r))\n                .ToListAsync();\n        }\n\n        public async Task<ReminderDto?> GetReminderByIdAsync(Guid businessId, Guid reminderId)\n        {\n            var reminder = await _db.Reminders\n                .AsNoTracking()\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == reminderId && r.IsActive);\n\n            return reminder == null ? null : ReminderMapper.MapToDto(reminder);\n        }\n\n        public async Task<bool> UpdateReminderAsync(Guid businessId, Guid reminderId, ReminderDto dto)\n        {\n            var reminder = await _db.Reminders\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == reminderId && r.IsActive);\n\n            if (reminder == null) return false;\n\n            if (!string.IsNullOrWhiteSpace(dto.Title))\n                reminder.Title = dto.Title.Trim();\n\n            reminder.Description = dto.Description?.Trim();\n            reminder.DueAt = EnsureUtc(dto.DueAt);\n\n            if (!string.IsNullOrWhiteSpace(dto.Status))\n                reminder.Status = dto.Status.Trim();\n\n            reminder.ReminderType = dto.ReminderType?.Trim();\n            reminder.Priority = dto.Priority;\n            reminder.IsRecurring = dto.IsRecurring;\n            reminder.RecurrencePattern = dto.RecurrencePattern;\n            reminder.SendWhatsappNotification = dto.SendWhatsappNotification;\n            reminder.LinkedCampaign = dto.LinkedCampaign;\n            reminder.UpdatedAt = DateTime.UtcNow;\n\n            if (IsDoneStatus(reminder.Status))\n                reminder.CompletedAt = reminder.CompletedAt ?? DateTime.UtcNow;\n\n            await _db.SaveChangesAsync();\n\n            // (optional) timeline ‚Äúupdated‚Äù\n            if (reminder.ContactId != Guid.Empty)\n            {\n                try\n                {\n                    await _timelineService.LogReminderUpdatedAsync(new CRMTimelineLogDto\n                    {\n                        ContactId = reminder.ContactId,\n                        BusinessId = businessId,\n                        EventType = \"ReminderUpdated\",\n                        Description = $\"‚úèÔ∏è Reminder updated: {reminder.Title}\",\n                        ReferenceId = reminder.Id,\n                        CreatedBy = dto.CreatedBy ?? \"system\",\n                        Timestamp = DateTime.UtcNow,\n                        Category = \"CRM\"\n                    });\n                }\n                catch (Exception ex)\n                {\n                    _logger.LogWarning(ex, \"Timeline log failed for ReminderUpdated ReminderId={ReminderId}\", reminder.Id);\n                }\n            }\n\n            return true;\n        }\n\n        // ‚úÖ HARD DELETE\n        public async Task<bool> DeleteReminderAsync(Guid businessId, Guid reminderId)\n        {\n            var reminder = await _db.Reminders\n                .FirstOrDefaultAsync(r => r.BusinessId == businessId && r.Id == reminderId && r.IsActive);\n\n            if (reminder == null) return false;\n\n            var contactId = reminder.ContactId;\n\n            _db.Reminders.Remove(reminder);\n            await _db.SaveChangesAsync();\n\n            if (contactId != Guid.Empty)\n            {\n                try\n                {\n                    await _timelineService.LogReminderDeletedAsync(new CRMTimelineLogDto\n                    {\n                        ContactId = contactId,\n                        BusinessId = businessId,\n                        EventType = \"ReminderDeleted\",\n                        Description = $\"üóëÔ∏è Reminder deleted: {reminder.Title}\",\n                        ReferenceId = reminder.Id,\n                        CreatedBy = \"system\",\n                        Timestamp = DateTime.UtcNow,\n                        Category = \"CRM\"\n                    });\n                }\n                catch (Exception ex)\n                {\n                    _logger.LogWarning(ex, \"Timeline log failed for ReminderDeleted ReminderId={ReminderId}\", reminder.Id);\n                }\n            }\n\n            return true;\n        }\n\n        private static DateTime EnsureUtc(DateTime value)\n        {\n            if (value.Kind == DateTimeKind.Utc) return value;\n            if (value.Kind == DateTimeKind.Local) return value.ToUniversalTime();\n            return DateTime.SpecifyKind(value, DateTimeKind.Utc);\n        }\n\n        private static bool IsDoneStatus(string? status)\n        {\n            if (string.IsNullOrWhiteSpace(status)) return false;\n            var s = status.Trim().ToLowerInvariant();\n            return s == \"done\" || s == \"completed\" || s == \"complete\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Services/TagService.cs",
      "sha256": "2e701fc3ab31d67208bdc3b4eeea07b3935f7129faac440942e15f3b6ee0a583",
      "language": "csharp",
      "size": 11636,
      "content": "// üìÑ File: xbytechat-api/Features/CRM/Services/TagService.cs\n\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Services;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CRM.Services\n{\n    public class TagService : ITagService\n    {\n        private readonly AppDbContext _db;\n        private readonly ITimelineService _timelineService;\n        private readonly ILogger<TagService> _logger;\n\n        public TagService(AppDbContext db, ITimelineService timelineService, ILogger<TagService> logger)\n        {\n            _db = db;\n            _timelineService = timelineService;\n            _logger = logger;\n        }\n\n        public async Task<TagDto> AddTagAsync(Guid businessId, TagDto dto)\n        {\n            var name = (dto.Name ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(name))\n                throw new ArgumentException(\"Tag name is required.\", nameof(dto.Name));\n\n            // ‚úÖ Avoid duplicates (case-insensitive) within a business\n            // NOTE: This is app-level protection; a DB unique index is still recommended later.\n            var nameLower = name.ToLowerInvariant();\n\n            var existing = await _db.Tags\n                .Where(t => t.BusinessId == businessId && t.IsActive)\n                .FirstOrDefaultAsync(t => (t.Name ?? \"\").ToLower() == nameLower);\n\n            if (existing != null)\n            {\n                return new TagDto\n                {\n                    Id = existing.Id,\n                    Name = existing.Name,\n                    ColorHex = existing.ColorHex,\n                    Category = existing.Category,\n                    Notes = existing.Notes,\n                    IsSystemTag = existing.IsSystemTag,\n                    IsActive = existing.IsActive,\n                    CreatedAt = existing.CreatedAt,\n                    LastUsedAt = existing.LastUsedAt\n                };\n            }\n\n            var tag = new Tag\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                Name = name,\n                ColorHex = string.IsNullOrWhiteSpace(dto.ColorHex) ? \"#8c8c8c\" : dto.ColorHex.Trim(),\n                Category = string.IsNullOrWhiteSpace(dto.Category) ? \"General\" : dto.Category.Trim(),\n                Notes = string.IsNullOrWhiteSpace(dto.Notes) ? null : dto.Notes.Trim(),\n                IsSystemTag = dto.IsSystemTag,\n\n                // ‚úÖ IMPORTANT: do not trust dto.IsActive during create (missing bool => false)\n                IsActive = true,\n\n                CreatedAt = DateTime.UtcNow,\n                LastUsedAt = null\n            };\n\n            _db.Tags.Add(tag);\n            await _db.SaveChangesAsync();\n\n            // ‚úÖ Non-blocking timeline log\n            try\n            {\n                await _timelineService.LogTagAppliedAsync(new CRMTimelineLogDto\n                {\n                    ContactId = Guid.Empty,\n                    BusinessId = businessId,\n                    EventType = \"TagCreated\",\n                    Description = $\"üè∑Ô∏è New tag created: {tag.Name}\",\n                    ReferenceId = tag.Id,\n                    CreatedBy = \"System\",\n                    Timestamp = DateTime.UtcNow,\n                    Category = \"CRM\"\n                });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogWarning(ex, \"‚ö†Ô∏è Timeline log failed for TagId {TagId}\", tag.Id);\n            }\n\n            return new TagDto\n            {\n                Id = tag.Id,\n                Name = tag.Name,\n                ColorHex = tag.ColorHex,\n                Category = tag.Category,\n                Notes = tag.Notes,\n                IsSystemTag = tag.IsSystemTag,\n                IsActive = tag.IsActive,\n                CreatedAt = tag.CreatedAt,\n                LastUsedAt = tag.LastUsedAt\n            };\n        }\n\n        public async Task<IEnumerable<TagDto>> GetAllTagsAsync(Guid businessId)\n        {\n            return await _db.Tags\n                .Where(t => t.BusinessId == businessId && t.IsActive)\n                .OrderByDescending(t => t.CreatedAt)\n                .Select(t => new TagDto\n                {\n                    Id = t.Id,\n                    Name = t.Name,\n                    ColorHex = t.ColorHex,\n                    Category = t.Category,\n                    Notes = t.Notes,\n                    IsSystemTag = t.IsSystemTag,\n                    IsActive = t.IsActive,\n                    CreatedAt = t.CreatedAt,\n                    LastUsedAt = t.LastUsedAt\n                })\n                .ToListAsync();\n        }\n\n        public async Task<bool> UpdateTagAsync(Guid businessId, Guid tagId, TagDto dto)\n        {\n            var tag = await _db.Tags.FirstOrDefaultAsync(t => t.Id == tagId && t.BusinessId == businessId);\n            if (tag == null) return false;\n\n            var name = (dto.Name ?? string.Empty).Trim();\n            if (string.IsNullOrWhiteSpace(name))\n                throw new ArgumentException(\"Tag name is required.\", nameof(dto.Name));\n\n            // ‚úÖ Prevent rename collision (case-insensitive) inside business\n            var nameLower = name.ToLowerInvariant();\n\n            var collision = await _db.Tags\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Id != tagId)\n                .AnyAsync(t => (t.Name ?? \"\").ToLower() == nameLower);\n\n            if (collision)\n                throw new InvalidOperationException($\"A tag with name '{name}' already exists.\");\n\n            tag.Name = name;\n            tag.ColorHex = string.IsNullOrWhiteSpace(dto.ColorHex) ? tag.ColorHex : dto.ColorHex.Trim();\n            tag.Category = string.IsNullOrWhiteSpace(dto.Category) ? tag.Category : dto.Category.Trim();\n            tag.Notes = string.IsNullOrWhiteSpace(dto.Notes) ? null : dto.Notes.Trim();\n            tag.IsSystemTag = dto.IsSystemTag;\n\n            // ‚úÖ Allow activate/deactivate via update\n            tag.IsActive = dto.IsActive;\n            tag.LastUsedAt = DateTime.UtcNow;\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> DeleteTagAsync(Guid businessId, Guid tagId)\n        {\n            var tag = await _db.Tags.FirstOrDefaultAsync(t => t.Id == tagId && t.BusinessId == businessId);\n            if (tag == null) return false;\n\n            tag.IsActive = false; // ‚úÖ soft delete\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        /// <summary>\n        /// Assigns tags (by name) to a contact located via phone number.\n        /// Canonical phone storage: E.164 digits-only (no '+').\n        /// </summary>\n        public async Task<bool> AssignTagsAsync(Guid businessId, string phoneNumber, List<string> tagNames)\n        {\n            // ‚úÖ Normalize phone first (digits-only)\n            var normalizedPhone = PhoneNumberNormalizer.NormalizeToE164Digits(phoneNumber, \"IN\");\n            if (string.IsNullOrWhiteSpace(normalizedPhone))\n            {\n                _logger.LogWarning(\"AssignTagsAsync: invalid phone. businessId={BusinessId}, rawPhone={Phone}\", businessId, phoneNumber);\n                return false;\n            }\n\n            if (tagNames == null || tagNames.Count == 0)\n                return false;\n\n            // ‚úÖ Clean tag list (trim + remove empties + distinct, case-insensitive)\n            var cleanedTagNames = tagNames\n                .Where(t => !string.IsNullOrWhiteSpace(t))\n                .Select(t => t.Trim())\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .ToList();\n\n            if (cleanedTagNames.Count == 0)\n                return false;\n\n            // ‚úÖ Find contact safely (tenant + active + not archived)\n            var contact = await _db.Contacts\n                .Include(c => c.ContactTags)\n                .FirstOrDefaultAsync(c =>\n                    c.BusinessId == businessId &&\n                    c.IsActive &&\n                    !c.IsArchived &&\n                    c.PhoneNumber == normalizedPhone);\n\n            if (contact == null)\n            {\n                _logger.LogWarning(\"AssignTagsAsync: contact not found. businessId={BusinessId}, phone={Phone}\", businessId, normalizedPhone);\n                return false;\n            }\n\n            var existingTagIds = contact.ContactTags?.Select(ct => ct.TagId).ToHashSet() ?? new HashSet<Guid>();\n\n            // ‚úÖ Fetch existing tags (active). Case-insensitive mapping in-memory (safe across DB collations).\n            var existingTags = await _db.Tags\n                .Where(t => t.BusinessId == businessId && t.IsActive)\n                .ToListAsync();\n\n            var existingByName = existingTags\n                .GroupBy(t => t.Name ?? \"\", StringComparer.OrdinalIgnoreCase)\n                .ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);\n\n            var tagsToLink = new List<Tag>();\n\n            foreach (var name in cleanedTagNames)\n            {\n                if (existingByName.TryGetValue(name, out var tag))\n                {\n                    tagsToLink.Add(tag);\n                    continue;\n                }\n\n                // Create missing tag\n                var newTag = new Tag\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = name,\n                    ColorHex = \"#8c8c8c\",\n                    Category = \"General\",\n                    IsActive = true,\n                    CreatedAt = DateTime.UtcNow,\n                    LastUsedAt = DateTime.UtcNow\n                };\n\n                _db.Tags.Add(newTag);\n                tagsToLink.Add(newTag);\n                existingByName[name] = newTag;\n            }\n\n            // Save new tags before linking\n            await _db.SaveChangesAsync();\n\n            contact.ContactTags ??= new List<ContactTag>();\n\n            var anyLinked = false;\n\n            foreach (var tag in tagsToLink)\n            {\n                if (existingTagIds.Contains(tag.Id))\n                    continue;\n\n                contact.ContactTags.Add(new ContactTag\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    ContactId = contact.Id,\n                    TagId = tag.Id,\n                    AssignedAt = DateTime.UtcNow,\n                    AssignedBy = \"automation\"\n                });\n\n                anyLinked = true;\n            }\n\n            if (!anyLinked)\n                return true;\n\n            await _db.SaveChangesAsync();\n\n            // ‚úÖ Non-blocking timeline\n            try\n            {\n                await _timelineService.LogTagAppliedAsync(new CRMTimelineLogDto\n                {\n                    ContactId = contact.Id,\n                    BusinessId = businessId,\n                    EventType = \"TagsAssigned\",\n                    Description = $\"üè∑Ô∏è Tags assigned: {string.Join(\", \", cleanedTagNames)}\",\n                    ReferenceId = contact.Id,\n                    CreatedBy = \"automation\",\n                    Timestamp = DateTime.UtcNow,\n                    Category = \"CRM\"\n                });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogWarning(ex, \"‚ö†Ô∏è Timeline log failed for AssignTagsAsync. contactId={ContactId}\", contact.Id);\n            }\n\n            return true;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Controllers/LeadTimelineController.cs",
      "sha256": "acbf1f3b85665c403e9ba8358653b9dbf039c8881b112af442083b59f7c6d1ee",
      "language": "csharp",
      "size": 2035,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Serilog;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Services;\n\nnamespace xbytechat.api.Features.CRM.Timelines.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class LeadTimelineController : ControllerBase\n    {\n        private readonly ILeadTimelineService _timelineService;\n\n        public LeadTimelineController(ILeadTimelineService timelineService)\n        {\n            _timelineService = timelineService;\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddTimelineEntry([FromBody] LeadTimelineDto dto)\n        {\n            try\n            {\n                if (!ModelState.IsValid)\n                    return BadRequest(ModelState);\n\n                var result = await _timelineService.AddTimelineEntryAsync(dto);\n\n                Log.Information(\"‚úÖ Timeline entry created for ContactId: {ContactId}\", dto.ContactId);\n\n                return Ok(result);\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Failed to add timeline entry for ContactId: {ContactId}\", dto.ContactId);\n                throw;\n            }\n        }\n\n        [HttpGet(\"contact/{contactId}\")]\n        public async Task<IActionResult> GetTimeline(Guid contactId)\n        {\n            try\n            {\n                var timeline = await _timelineService.GetTimelineByContactIdAsync(contactId);\n\n                Log.Information(\"üìÑ Retrieved {Count} entries for ContactId: {ContactId}\", timeline.Count, contactId);\n\n                return Ok(timeline);\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Failed to get timeline for ContactId: {ContactId}\", contactId);\n                throw;\n            }\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetAll()\n        {\n            var timelines = await _timelineService.GetAllTimelinesAsync();\n            return Ok(timelines);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/DTOs/CampaignTimelineLogDto.cs",
      "sha256": "b279e39522b2d36effd77fe29c36653ca83b93c6cc9a1281d1ed6b3e596b96e3",
      "language": "csharp",
      "size": 361,
      "content": "public class CampaignTimelineLogDto\n{\n    public Guid ContactId { get; set; }\n    public Guid BusinessId { get; set; }   // ‚úÖ Needed for timeline insertion\n    public Guid CampaignId { get; set; }\n    public string CampaignName { get; set; } = string.Empty; // ‚úÖ Safe default to avoid null issues\n    public DateTime? Timestamp { get; set; } // optional\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/DTOs/CRMTimelineLogDto.cs",
      "sha256": "523614f609f53bf0e19c490cf47a69ceb3ccc7df61bba97b431fcbcf6c739bdf",
      "language": "csharp",
      "size": 695,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CRM.Timelines.DTOs\n{\n    public class CRMTimelineLogDto\n    {\n        public Guid ContactId { get; set; }\n        public Guid BusinessId { get; set; }\n        public string EventType { get; set; }  // üß© Example: \"NoteAdded\", \"ReminderSet\", \"TagApplied\"\n        public string Description { get; set; }\n        public Guid? ReferenceId { get; set; }  // üÜî Related NoteId, ReminderId, TagId (optional)\n        public string CreatedBy { get; set; }\n        public string? Category { get; set; } = \"CRM\";  // üìÇ Default category: CRM\n        public DateTime? Timestamp { get; set; }  // ‚è∞ Custom time if needed (else CreatedAt = now)\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/DTOs/LeadTimelineDto.cs",
      "sha256": "3b83f102ec5c0ddae6f265b6d33ddbd741f854e83baa0f696a1a05a7d9639104",
      "language": "csharp",
      "size": 687,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CRM.Timelines.DTOs\n{\n    public class LeadTimelineDto\n    {\n        public Guid ContactId { get; set; }\n        public string ContactName { get; set; }\n        public string ContactNumber { get; set; }\n        public string EventType { get; set; }\n        public string Description { get; set; }\n        public string? Data { get; set; }\n        public Guid? ReferenceId { get; set; }\n        public bool IsSystemGenerated { get; set; } = false;\n        public string CreatedBy { get; set; }\n        public string? Source { get; set; }\n        public string? Category { get; set; }\n        public DateTime CreatedAt { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Mappers/LeadTimelineMapper.cs",
      "sha256": "d3a2ed675f44c84af1ce0317d44c4407bf3fc23bf4bfdd91ebf0c52bf63a9296",
      "language": "csharp",
      "size": 1843,
      "content": "using xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Models;\n\nnamespace xbytechat.api.Features.CRM.Timelines.Mappers\n{\n    public static class LeadTimelineMapper\n    {\n        public static LeadTimelineDto ToDto(Models.LeadTimeline entry)\n        {\n            if (entry == null) return null;\n\n            return new LeadTimelineDto\n            {\n                ContactId = entry.ContactId,\n                ContactName = entry.Contact?.Name,                // ‚úÖ Enriched from navigation\n                ContactNumber = entry.Contact?.PhoneNumber,       // ‚úÖ Enriched from navigation\n                EventType = entry.EventType,\n                Description = entry.Description,\n                Data = entry.Data,\n                ReferenceId = entry.ReferenceId,\n                IsSystemGenerated = entry.IsSystemGenerated,\n                CreatedBy = entry.CreatedBy,\n                Source = entry.Source,\n                Category = entry.Category,\n                // ‚úÖ CreatedAt is intentionally excluded from DTO\n            };\n        }\n\n        // Optional for create/update, include only necessary fields\n        public static Models.LeadTimeline ToModel(LeadTimelineDto dto)\n        {\n            if (dto == null) return null;\n\n            return new Models.LeadTimeline\n            {\n                ContactId = dto.ContactId,\n                EventType = dto.EventType,\n                Description = dto.Description,\n                Data = dto.Data,\n                ReferenceId = dto.ReferenceId,\n                IsSystemGenerated = dto.IsSystemGenerated,\n                CreatedBy = dto.CreatedBy,\n                Source = dto.Source,\n                Category = dto.Category,\n                CreatedAt = DateTime.UtcNow // ‚úÖ Always use UTC when creating\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Models/LeadTimeline.cs",
      "sha256": "3f31e8a170176d76713be299c4d314a5d1aaf17514d4903adb3685d41ca42572",
      "language": "csharp",
      "size": 1206,
      "content": "using xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CRM.Timelines.Models\n{\n    public class LeadTimeline\n    {\n        public int Id { get; set; }\n        public Guid ContactId { get; set; }\n        public Guid BusinessId { get; set; }\n        public Business Business { get; set; }  // optional\n\n        public Contact Contact { get; set; } // üÜï Navigation property\n\n        public string EventType { get; set; }\n\n        public string Description { get; set; }\n        public string? Data { get; set; }\n        public Guid? ReferenceId { get; set; }           // ‚úÖ New\n        public bool IsSystemGenerated { get; set; } = false;  // ‚úÖ New\n        public string CreatedBy { get; set; }\n        public string? Source { get; set; }\n        public string? Category { get; set; }\n        public DateTime CreatedAt { get; set; }\n\n        public string? CTAType { get; set; } // e.g., \"BuyNow\", \"PriceCheck\", \"ConfirmReminder\"\n        public string? CTASourceType { get; set; } // e.g., \"catalog\", \"campaign\", \"reminder\"\n        public Guid? CTASourceId { get; set; } // ID of the source object (productId, reminderId)\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Services/ILeadTimelineService.cs",
      "sha256": "50629497a65281bae0ab515aa0b85e6a12eba14d8da57398c82e68cff749f58e",
      "language": "csharp",
      "size": 717,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.Catalog.Models;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CRM.Timelines.Services\n{\n    public interface ILeadTimelineService\n    {\n        Task<LeadTimeline> AddTimelineEntryAsync(LeadTimelineDto dto);\n        Task<List<LeadTimeline>> GetTimelineByContactIdAsync(Guid contactId);\n        Task<List<LeadTimelineDto>> GetAllTimelinesAsync();\n        Task AddFromCatalogClickAsync(CatalogClickLog log);\n        Task<ResponseResult> LogCampaignSendAsync(CampaignTimelineLogDto dto);\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Services/ITimelineService.cs",
      "sha256": "f7018aae9a980787a0554c485915f6e623ed09c4e18b67b1843d17fa52b09b61",
      "language": "csharp",
      "size": 563,
      "content": "using xbytechat.api.Features.CRM.Timelines.DTOs;\n\nnamespace xbytechat.api.Features.CRM.Timelines.Services\n{\n    public interface ITimelineService\n    {\n        Task<bool> LogNoteAddedAsync(CRMTimelineLogDto dto);\n        Task<bool> LogReminderSetAsync(CRMTimelineLogDto dto);\n        Task<bool> LogTagAppliedAsync(CRMTimelineLogDto dto);\n\n        // ‚úÖ NEW\n        Task<bool> LogReminderUpdatedAsync(CRMTimelineLogDto dto);\n        Task<bool> LogReminderDeletedAsync(CRMTimelineLogDto dto);\n\n        Task<bool> LogTagRemovedAsync(CRMTimelineLogDto dto);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Services/LeadTimelineService.cs",
      "sha256": "509c3bc3cf8d36b9acac08b54bf211a5992bb367934df75327f233af36eb9333",
      "language": "csharp",
      "size": 7570,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.Catalog.Models;\nusing static xbytechat.api.Features.BusinessModule.Models.Business;\nusing System.Text.Json;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Models;\n\n\nnamespace xbytechat.api.Features.CRM.Timelines.Services\n{\n    public class LeadTimelineService : ILeadTimelineService\n    {\n        private readonly AppDbContext _context;\n\n\n        public LeadTimelineService(AppDbContext context)\n        {\n            _context = context;\n\n        }\n\n        public async Task<LeadTimeline> AddTimelineEntryAsync(LeadTimelineDto dto)\n        {\n            try\n            {\n                var entry = new LeadTimeline\n                {\n                    ContactId = dto.ContactId,\n                    EventType = dto.EventType,\n                    Description = dto.Description,\n                    Data = dto.Data,\n                    ReferenceId = dto.ReferenceId,\n                    IsSystemGenerated = dto.IsSystemGenerated,\n                    CreatedBy = dto.CreatedBy,\n                    Source = dto.Source,\n                    Category = dto.Category,\n                    CreatedAt = DateTime.UtcNow\n                };\n\n                _context.LeadTimelines.Add(entry);\n                await _context.SaveChangesAsync();\n\n                Log.Information(\"‚úÖ Timeline entry added for ContactId: {ContactId}\", dto.ContactId);\n\n                return entry;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Error adding timeline entry for ContactId: {ContactId}\", dto.ContactId);\n                throw; // Let global middleware handle this\n            }\n        }\n\n        public async Task<List<LeadTimeline>> GetTimelineByContactIdAsync(Guid contactId)\n        {\n            try\n            {\n                var results = await _context.LeadTimelines\n                    .Where(x => x.ContactId == contactId)\n                    .OrderByDescending(x => x.CreatedAt)\n                    .ToListAsync();\n\n                Log.Information(\"üìÑ Fetched {Count} timeline entries for ContactId: {ContactId}\", results.Count, contactId);\n\n                return results;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Failed to fetch timeline for ContactId: {ContactId}\", contactId);\n                throw;\n            }\n        }\n\n        public async Task<List<LeadTimelineDto>> GetAllTimelinesAsync()\n        {\n            try\n            {\n                var entries = await _context.LeadTimelines\n                    .Include(t => t.Contact) // for Contact Name/Phone\n                    .OrderByDescending(e => e.CreatedAt)\n                    .ToListAsync();\n\n                var dtoList = entries.Select(entry => new LeadTimelineDto\n                {\n                    ContactId = entry.ContactId,\n                    EventType = entry.EventType,\n                    Description = entry.Description,\n                    Data = entry.Data,\n                    ReferenceId = entry.ReferenceId,\n                    CreatedAt = entry.CreatedAt,\n                    CreatedBy = entry.CreatedBy,\n                    Source = entry.Source,\n                    Category = entry.Category,\n                    IsSystemGenerated = entry.IsSystemGenerated,\n                    ContactName = entry.Contact?.Name,\n                    ContactNumber = entry.Contact?.PhoneNumber\n                }).ToList();\n\n                Log.Information(\"üìÑ Loaded {Count} total timeline entries\", dtoList.Count);\n                return dtoList;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Failed to fetch all timeline entries\");\n                throw;\n            }\n        }\n        public async Task AddFromCatalogClickAsync(CatalogClickLog log)\n        {\n            if (log == null)\n            {\n                Log.Warning(\"CatalogClickLog is null. Skipping timeline creation.\");\n                return;\n            }\n\n            try\n            {\n                var business = await _context.Businesses\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync(b => b.Id == log.BusinessId);\n\n                if (business == null)\n                {\n                    Log.Warning(\"Business not found for ID: {BusinessId}. Skipping timeline creation.\", log.BusinessId);\n                    return;\n                }\n\n                // if (business.Plan == PlanType.Advanced)\n                if (business?.BusinessPlanInfo?.Plan == PlanType.Advanced)\n                {\n                    Log.Information(\"Timeline skipped for Basic Plan - BusinessId: {BusinessId}\", business.Id);\n                    return;\n                }\n\n\n                var description = $\"{log.ProductBrowsed} | {log.CTAJourney}\";\n\n                var timelineEntry = new LeadTimeline\n                {\n                    BusinessId = log.BusinessId,\n                    ContactId = log.ContactId ?? Guid.Empty,\n                    EventType = \"CatalogCTA\",\n                    Description = description,\n                    Data = JsonSerializer.Serialize(log),\n                    ReferenceId = null,\n                    CreatedBy = \"system\",\n                    IsSystemGenerated = true,\n                    Source = \"Catalog\",\n                    Category = log.CategoryBrowsed,\n                    CreatedAt = DateTime.UtcNow\n                };\n\n                _context.LeadTimelines.Add(timelineEntry);\n                await _context.SaveChangesAsync();\n\n                Log.Information(\"üìà Timeline entry created from CatalogClick for UserId: {UserId}\", log.UserId);\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"‚ùå Error creating timeline entry from CatalogClick for UserId: {UserId}\", log.UserId);\n                // Safe swallow\n            }\n        }\n\n        public async Task<ResponseResult> LogCampaignSendAsync(CampaignTimelineLogDto dto)\n        {\n            try\n            {\n                var timeline = new LeadTimeline\n                {\n                    ContactId = dto.ContactId,\n                    BusinessId = dto.BusinessId,\n                    EventType = \"CampaignSend\",\n                    Description = $\"Campaign '{dto.CampaignName}' was sent.\", // ‚úÖ Timeline me readable text\n                    ReferenceId = dto.CampaignId, // ‚úÖ Linking to campaign record\n                    IsSystemGenerated = false,    // ‚úÖ Default (campaign sending is manual action)\n                    CreatedBy = \"system\",         // ‚úÖ Or actual user email if needed later\n                    Source = \"CampaignModule\",    // ‚úÖ Source field for clarity\n                    Category = \"Messaging\",       // ‚úÖ Logical grouping\n                    CreatedAt = dto.Timestamp ?? DateTime.UtcNow // ‚úÖ Use given Timestamp or fallback to now\n                };\n\n                _context.LeadTimelines.Add(timeline);\n                await _context.SaveChangesAsync();\n\n                return ResponseResult.SuccessInfo(\"‚úÖ Campaign send event logged into timeline.\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to log campaign send event: \" + ex.Message);\n            }\n        }\n\n\n    }\n\n\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CRM/Timelines/Services/TimelineService.cs",
      "sha256": "5f40e44e792c09c3d4559a8a17a1f533efddc038381124a08cbbbd0a0e002ba6",
      "language": "csharp",
      "size": 3044,
      "content": "using xbytechat.api.Features.CRM.Timelines.DTOs;\nusing xbytechat.api.Features.CRM.Timelines.Models;\n\nnamespace xbytechat.api.Features.CRM.Timelines.Services\n{\n    public class TimelineService : ITimelineService\n    {\n        private readonly AppDbContext _context;\n\n        public TimelineService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        public async Task<bool> LogNoteAddedAsync(CRMTimelineLogDto dto)\n            => await InsertAsync(dto, \"NoteAdded\", dto.Description);\n\n        public async Task<bool> LogReminderSetAsync(CRMTimelineLogDto dto)\n            => await InsertAsync(dto, \"ReminderSet\", dto.Description);\n\n        public async Task<bool> LogTagAppliedAsync(CRMTimelineLogDto dto)\n            => await InsertAsync(dto, \"TagApplied\", dto.Description);\n\n        // ‚úÖ NEW\n        public async Task<bool> LogReminderUpdatedAsync(CRMTimelineLogDto dto)\n            => await InsertAsync(dto, \"ReminderUpdated\", dto.Description);\n\n        // ‚úÖ NEW\n        public async Task<bool> LogReminderDeletedAsync(CRMTimelineLogDto dto)\n            => await InsertAsync(dto, \"ReminderDeleted\", dto.Description);\n\n        private async Task<bool> InsertAsync(CRMTimelineLogDto dto, string eventType, string description)\n        {\n            try\n            {\n                var timeline = new LeadTimeline\n                {\n                    ContactId = dto.ContactId,\n                    BusinessId = dto.BusinessId,\n                    EventType = eventType,\n                    Description = description,\n                    ReferenceId = dto.ReferenceId,\n                    CreatedBy = dto.CreatedBy,\n                    Source = \"CRM\",\n                    Category = dto.Category ?? \"CRM\",\n                    CreatedAt = dto.Timestamp ?? DateTime.UtcNow,\n                    IsSystemGenerated = false\n                };\n\n                _context.LeadTimelines.Add(timeline);\n                await _context.SaveChangesAsync();\n                return true;\n            }\n            catch\n            {\n                return false;\n            }\n        }\n\n        public async Task<bool> LogTagRemovedAsync(CRMTimelineLogDto dto)\n        {\n            try\n            {\n                var timeline = new LeadTimeline\n                {\n                    ContactId = dto.ContactId,\n                    BusinessId = dto.BusinessId,\n                    EventType = \"TagRemoved\",\n                    Description = dto.Description,\n                    ReferenceId = dto.ReferenceId,\n                    CreatedBy = dto.CreatedBy,\n                    Source = \"CRM\",\n                    Category = dto.Category ?? \"CRM\",\n                    CreatedAt = dto.Timestamp ?? DateTime.UtcNow,\n                    IsSystemGenerated = false\n                };\n\n                _context.LeadTimelines.Add(timeline);\n                await _context.SaveChangesAsync();\n                return true;\n            }\n            catch\n            {\n                return false;\n            }\n        }\n\n    }\n}\n"
    }
  ]
}
